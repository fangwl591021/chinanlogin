<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Š - å¸æ©Ÿæ ¸éŠ·ç³»çµ± v4.2</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Microsoft JhengHei',sans-serif;}
body{background:#f5f6f7;color:#333;line-height:1.6;width:100vw;overflow-x:hidden;}
.container{width:100%;margin:0;padding:12px;box-sizing:border-box;}
.header{background:#3c8050;color:white;padding:15px;border-radius:12px;margin-bottom:15px;text-align:center;}
.header h1{font-size:22px;margin-bottom:5px;}
.header p{font-size:13px;opacity:0.9;}
.calendar-section,.route-map-section,.checkin-section{background:white;border-radius:12px;padding:15px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.calendar-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;gap:8px;}
.calendar-nav button{background:#3c8050;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;}
.calendar-nav button:hover{background:#2f6842;}
.calendar-title{text-align:center;font-size:16px;font-weight:bold;flex:1;white-space:nowrap;}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.day-header{padding:8px 0;font-weight:bold;background:#27ACB2;color:white;text-align:center;border-radius:4px;font-size:11px;}
.day-cell{padding:8px 0;background:white;border:1px solid #e0e0e0;text-align:center;border-radius:6px;cursor:pointer;transition:all .2s;font-size:12px;aspect-ratio:1;}
.day-cell:hover{background:#eaf5ea;border-color:#3c8050;}
.day-cell.past{background:#f5f5f5;color:#ccc;cursor:not-allowed;}
.day-cell.selected{background:#3c8050;color:white;font-weight:bold;}
.day-cell.other-month{color:#ccc;background:#f8f9fa;}
.checkin-section h2{margin-bottom:12px;color:#333;border-bottom:2px solid #3c8050;padding-bottom:8px;font-size:16px;}
.reservation-table{width:100%;border-collapse:collapse;}
.table-header th{background:#3c8050;color:white;padding:8px;font-size:12px;border:1px solid #2f6842;}
.table-row td{padding:8px;border:1px solid #ddd;font-size:12px;text-align:center;}
.stop-cell{font-size:10px;line-height:1.4;padding:6px 4px !important;}
.stop-cell div:first-child{color:#3c8050;font-weight:600;margin-bottom:2px;}
.stop-cell div:last-child{color:#666;}
.table-row.pending{background:#fffbeb;border-left:3px solid #f59e0b;}
.checkin-btn{background:#3c8050;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:bold;}
.checkin-btn:hover{background:#2f6842;}
.checkin-btn:disabled{background:#ccc;cursor:not-allowed;color:#666;}
.status-checked{color:#16a34a;font-weight:bold;}
.status-cancelled{color:#dc2626;font-weight:bold;}
.status-pending{color:#ca8a04;font-weight:bold;}
.no-data{text-align:center;color:#999;padding:20px;}
.loading{text-align:center;color:#3c8050;padding:20px;}
.hidden{display:none;}
.error-msg{background:#fee;border:1px solid #fcc;color:#c33;padding:10px;border-radius:6px;margin:10px 0;text-align:center;}
.route-map-section{position:relative;}
.route-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.route-header h2{font-size:16px;color:#333;}
.route-header button{background:#3c8050;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;}
#route-content{display:none;animation:fadeIn .25s ease-in-out;}
.route-line{margin:10px 0;padding:10px;background:#f9f9f9;border-left:4px solid #3c8050;border-radius:6px;}
.route-line h3{font-size:14px;margin-bottom:8px;color:#3c8050;}
.stops{font-size:12px;color:#666;line-height:1.8;}
@keyframes fadeIn{from{opacity:0;transform:translateY(-5px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>ğŸšŒ ç©¿å±±ç”²å°ˆè»Šæ ¸éŠ·ç³»çµ±</h1>
    <p>å¸æ©Ÿç°½åˆ°æ ¸éŠ·ä½œæ¥­ v4.2</p>
  </div>

  <div class="calendar-section">
    <div class="calendar-nav">
      <button id="prev-month">â—€</button>
      <h2 id="current-month" class="calendar-title"></h2>
      <button id="next-month">â–¶</button>
      <button id="toggle-calendar">å±•é–‹</button>
      <button id="show-all">å…¨éƒ¨</button>
    </div>
    <div class="calendar-grid" id="calendar-grid" style="display:none;"></div>
  </div>

  <div class="route-map-section">
    <div class="route-header">
      <h2>ğŸš è¡Œè»Šè·¯ç·šç¤ºæ„åœ–</h2>
      <button id="toggle-route">å±•é–‹</button>
    </div>

    <div id="route-content">
      <div class="route-line a-line">
        <h3>ğŸ…°ï¸ Aç·šï¼ˆæš¨å¤§ â†’ åŸ”é‡Œç¸½ç«™ï¼‰</h3>
        <div class="stops">
          è¡Œæ”¿å¤§æ¨“ â” ä¸­é¤å»³ â” ç§‘æŠ€å­¸é™¢ â” å­¸äººæœƒé¤¨ â” ä¸­åŸ â” ä¸‹åŸ â” åªé ‚ â” æ„›è˜­æ©‹ â” å¤§æˆåœ‹å° â” ä¸­å±±å®‰ä¸ƒè¡—å£ â” æ¦®æ°‘è¨ºæ‰€ â” åŸ”é‡Œé…’å»  â” åŸ”é‡Œç¸½ç«™
        </div>
      </div>
      <div class="route-line b-line">
        <h3>ğŸ…±ï¸ Bç·šï¼ˆåŸ”é‡Œç¸½ç«™ â†’ æš¨å¤§ï¼‰</h3>
        <div class="stops">
          åŸ”é‡Œç¸½ç«™ â” åŸ”é‡Œé…’å»  â” æ¦®æ°‘è¨ºæ‰€ â” ä¸­å±±å®‰ä¸ƒè¡—å£ â” å¤§æˆåœ‹å° â” æ„›è˜­æ©‹ â” åªé ‚ â” ä¸‹åŸ â” ä¸­åŸ â” å­¸äººæœƒé¤¨ â” ç§‘æŠ€å­¸é™¢ â” ä¸­é¤å»³ â” è¡Œæ”¿å¤§æ¨“
        </div>
      </div>
    </div>
  </div>

  <div id="checkin-section" class="checkin-section">
    <h2 id="checkin-title">å…¨éƒ¨é ç´„åˆ—è¡¨</h2>
    <div id="loadingMsg" class="loading">ğŸš è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
    <div id="errorMsg" class="error-msg hidden"></div>
    <table class="reservation-table">
      <thead class="table-header">
        <tr>
          <th>æ—¥æœŸ</th>
          <th>ç­æ¬¡</th>
          <th>å§“å</th>
          <th>ä¸Š/ä¸‹è»Š</th>
          <th>ç‹€æ…‹</th>
          <th>æ ¸éŠ·</th>
        </tr>
      </thead>
      <tbody id="reservation-list"></tbody>
    </table>
  </div>
</div>

<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
let allReservations = [];
let currentDate = new Date();
let currentMonth = currentDate.getMonth();
let currentYear = currentDate.getFullYear();
let selectedDate = null;

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('prev-month').onclick = () => changeMonth(-1);
  document.getElementById('next-month').onclick = () => changeMonth(1);
  document.getElementById('toggle-calendar').onclick = toggleCalendar;
  document.getElementById('toggle-route').onclick = toggleRoute;
  document.getElementById('show-all').onclick = showAllReservations;
  initializeSystem();
});

async function initializeSystem() {
  showLoading(true);
  await loadAllReservations();
  showLoading(false);
  renderCalendar();
  showAllReservations();
}

function showLoading(show) {
  document.getElementById('loadingMsg').classList.toggle('hidden', !show);
}
function showError(msg) {
  const e = document.getElementById('errorMsg');
  e.textContent = 'âœ• ' + msg;
  e.classList.remove('hidden');
}
function hideError() {
  document.getElementById('errorMsg').classList.add('hidden');
}

// âœ… æ ¼å¼åŒ–æ—¥æœŸ - åªä¿ç•™å¹´æœˆæ—¥
function formatDateOnly(dateStr) {
  if (!dateStr) return '';
  
  try {
    const str = String(dateStr).trim();
    
    // è™•ç†å®Œæ•´æ—¥æœŸæ™‚é–“æ ¼å¼
    if (str.includes('GMT') || str.includes('æ¨™æº–æ™‚é–“')) {
      const d = new Date(str);
      if (!isNaN(d.getTime())) {
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      }
    }
    
    // è™•ç† ISO æ ¼å¼
    if (str.includes('T')) return str.split('T')[0];
    
    // è™•ç†ç©ºæ ¼æ ¼å¼
    if (str.includes(' ')) return str.split(' ')[0];
    
    // å¦‚æœå·²ç¶“æ˜¯ YYYY-MM-DD æ ¼å¼
    if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
    
    return str.substring(0, 10);
  } catch (e) {
    return String(dateStr).substring(0, 10);
  }
}

// âœ… æ ¼å¼åŒ–è·¯ç·šä»£ç¢¼
function formatRouteCode(routeStr) {
  if (!routeStr) return '-';
  
  const str = String(routeStr).trim();
  
  // æå–ç­æ¬¡ä»£ç¢¼ï¼ˆA1, A2, B1, B2ï¼‰
  const match = str.match(/([AB][12])/);
  if (match) return match[1];
  
  // å¦‚æœåŒ…å« "|"ï¼Œå–å‰é¢éƒ¨åˆ†
  if (str.includes('|')) {
    const parts = str.split('|');
    const code = parts[0].trim();
    const codeMatch = code.match(/([AB][12])/);
    return codeMatch ? codeMatch[1] : code;
  }
  
  return str;
}

async function loadAllReservations() {
  try {
    hideError();
    const fetchUrl = `${WORKER_URL}?mode=allReservations`;
    console.log('ğŸ“¡ è«‹æ±‚ URL:', fetchUrl);
    
    const response = await fetch(fetchUrl);
    const contentType = response.headers.get('content-type') || '';

    if (!response.ok) {
      showError('ä¼ºæœå™¨éŒ¯èª¤: ' + response.status);
      renderEmptyList();
      return;
    }

    if (!contentType.includes('application/json')) {
      const text = await response.text();
      console.warn('âš ï¸ é JSON æ ¼å¼:', text.slice(0,150));
      showError('API å›æ‡‰æ ¼å¼éŒ¯èª¤');
      renderEmptyList();
      return;
    }

    const data = await response.json();
    console.log('ğŸ“Š æ”¶åˆ°è³‡æ–™:', data);
    
    if (data.ok && data.status === 'success' && Array.isArray(data.reservations)) {
      allReservations = data.reservations.map((r,i)=>({
        id: String(r.reservationId || r.id || i+1),
        rowNumber: r.rowNumber || (i+2),
        date: formatDateOnly(r.date || ''),
        route: formatRouteCode(r.route || '-'),
        name: r.name || '-',
        fromStop: r.fromStop || 'æœªæä¾›',
        toStop: r.toStop || 'æœªæä¾›',
        checkin: r.signed || r.checkin || '',
        status: r.status || 'å·²é ç´„'
      }));
      console.log('âœ… æˆåŠŸè¼‰å…¥', allReservations.length, 'ç­†é ç´„');
      
      if (allReservations.length === 0) {
        renderEmptyList();
      }
    } else {
      console.warn('âŒ è³‡æ–™æ ¼å¼ä¸ç¬¦:', data);
      showError(data.message || 'ç„¡æ³•å–å¾—é ç´„è³‡æ–™');
      renderEmptyList();
    }
  } catch (e) {
    console.error('âŒ éŒ¯èª¤:', e);
    showError('è¼‰å…¥å¤±æ•—: ' + e.message);
    renderEmptyList();
  } finally {
    showLoading(false);
  }
}

function renderEmptyList() {
  const tbody = document.getElementById('reservation-list');
  tbody.innerHTML = '<tr><td colspan="6" class="no-data">æš«ç„¡é ç´„ç´€éŒ„</td></tr>';
  document.getElementById('checkin-title').textContent = 'å…¨éƒ¨é ç´„åˆ—è¡¨ (0 ç­†)';
}

function renderCalendar() {
  const grid = document.getElementById('calendar-grid');
  grid.innerHTML = '';
  ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d=>{
    const h=document.createElement('div');
    h.className='day-header';
    h.textContent=d;
    grid.appendChild(h);
  });
  const first=new Date(currentYear,currentMonth,1);
  const last=new Date(currentYear,currentMonth+1,0);
  const offset=first.getDay();
  const today=formatDate(new Date());
  for(let i=0;i<offset;i++){
    const d=document.createElement('div');d.className='day-cell other-month';grid.appendChild(d);
  }
  for(let i=1;i<=last.getDate();i++){
    const d=document.createElement('div');
    const dateStr=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
    d.className='day-cell';
    if(dateStr===selectedDate)d.classList.add('selected');
    if(dateStr<today)d.classList.add('past');
    else d.onclick=()=>selectDate(dateStr);
    d.textContent=i;
    grid.appendChild(d);
  }
  document.getElementById('current-month').textContent=`${currentYear}å¹´${currentMonth+1}æœˆ`;
}

function selectDate(date){selectedDate=date;renderCalendar();showReservationsByDate(date);}

function showReservationsByDate(date){
  const tbody=document.getElementById('reservation-list');
  tbody.innerHTML='';
  const filtered=allReservations.filter(r=>r.date.startsWith(date));
  if(filtered.length===0){
    tbody.innerHTML='<tr><td colspan="6" class="no-data">æ­¤æ—¥æœŸç„¡é ç´„</td></tr>';
    document.getElementById('checkin-title').textContent=`${date} ç„¡é ç´„`;
    return;
  }
  
  // âœ… ç‰¹å®šæ—¥æœŸä¹Ÿä½¿ç”¨ç›¸åŒæ’åºï¼šå·²é ç´„ â†’ å·²æ­ä¹˜ â†’ å·²å–æ¶ˆ
  const sorted = [...filtered].sort((a,b)=>{
    const getPriority = (r) => {
      if (r.status === 'å·²å–æ¶ˆ') return 3;
      if (r.checkin === 'Y' || r.status === 'å·²æ­ä¹˜') return 2;
      return 1;
    };
    const priorityDiff = getPriority(a) - getPriority(b);
    if (priorityDiff !== 0) return priorityDiff;
    
    const routes = ['A1', 'B1', 'A2', 'B2'];
    return routes.indexOf(a.route) - routes.indexOf(b.route);
  });
  
  renderReservationRows(sorted, `${date} é ç´„ (${sorted.length} ç­†)`);
}

function showAllReservations(){
  const tbody=document.getElementById('reservation-list');
  tbody.innerHTML='';
  if(allReservations.length===0){renderEmptyList();return;}
  
  // âœ… æ”¹é€²æ’åºï¼šå·²é ç´„(å¾…æ ¸éŠ·) â†’ å·²æ­ä¹˜ â†’ å·²å–æ¶ˆ
  const sorted=[...allReservations].sort((a,b)=>{
    // 1ï¸âƒ£ é¦–å…ˆæŒ‰ç‹€æ…‹æ’åº
    const getPriority = (r) => {
      if (r.status === 'å·²å–æ¶ˆ') return 3;
      if (r.checkin === 'Y' || r.status === 'å·²æ­ä¹˜') return 2;
      return 1; // å·²é ç´„ï¼ˆå¾…æ ¸éŠ·ï¼‰
    };
    const priorityDiff = getPriority(a) - getPriority(b);
    if (priorityDiff !== 0) return priorityDiff;
    
    // 2ï¸âƒ£ åŒç‹€æ…‹æ™‚ï¼ŒæŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰
    const dateCompare = (b.date || '').localeCompare(a.date || '');
    if (dateCompare !== 0) return dateCompare;
    
    // 3ï¸âƒ£ åŒæ—¥æœŸæ™‚ï¼ŒæŒ‰ç­æ¬¡æ’åº
    const routes = ['A1', 'B1', 'A2', 'B2'];
    return routes.indexOf(a.route) - routes.indexOf(b.route);
  });
  
  renderReservationRows(sorted,`å…¨éƒ¨é ç´„åˆ—è¡¨ (${sorted.length} ç­†)`);
}

function renderReservationRows(list,title){
  const tbody=document.getElementById('reservation-list');
  tbody.innerHTML='';
  list.forEach(r=>{
    const checked=r.checkin==='Y'||r.status==='å·²æ­ä¹˜';
    const cancelled=r.status==='å·²å–æ¶ˆ';
    const pending=!checked&&!cancelled; // å¾…æ ¸éŠ·
    
    let statusText, statusClass, statusIcon;
    if(checked){
      statusText='å·²æ­ä¹˜';
      statusClass='status-checked';
      statusIcon='âœ“';
    }else if(cancelled){
      statusText='å·²å–æ¶ˆ';
      statusClass='status-cancelled';
      statusIcon='âœ•';
    }else{
      statusText='å·²é ç´„';
      statusClass='status-pending';
      statusIcon='â³';
    }
    
    const tr=document.createElement('tr');
    tr.className='table-row' + (pending ? ' pending' : ''); // âœ… å¾…æ ¸éŠ·é …ç›®åŠ ä¸Šç‰¹æ®Šæ¨£å¼
    tr.innerHTML=`
      <td>${r.date}</td>
      <td><strong>${r.route}</strong></td>
      <td>${r.name}</td>
      <td class="stop-cell"><div>ğŸš ${r.fromStop}</div><div>ğŸ ${r.toStop}</div></td>
      <td><span class="${statusClass}">${statusIcon} ${statusText}</span></td>
      <td>${checked||cancelled?'<button class="checkin-btn" disabled>å·²å®Œæˆ</button>':`<button class="checkin-btn" onclick="confirmCheckin('${r.id}', ${r.rowNumber})">æ ¸éŠ·</button>`}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('checkin-title').textContent=title;
}

async function confirmCheckin(id, rowNumber){
  if(!confirm('ç¢ºèªä¹˜å®¢å·²ä¸Šè»Šï¼Ÿ'))return;
  try{
    const url = `${WORKER_URL}`;
    const payload = {
      type: 'checkin',
      reservationId: id,
      rowNumber: rowNumber
    };
    
    console.log('ğŸ“¤ ç™¼é€æ ¸éŠ·è«‹æ±‚:', payload);
    
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const contentType = response.headers.get('content-type') || '';
    if (!contentType.includes('application/json')) {
      throw new Error('ç³»çµ±å›æ‡‰æ ¼å¼éŒ¯èª¤');
    }
    
    const data = await response.json();
    console.log('ğŸ“¨ æ ¸éŠ·å›æ‡‰:', data);
    
    if (data.ok && data.status === 'success') {
      alert('âœ“ æ ¸éŠ·æˆåŠŸ');
      const target = allReservations.find(r => r.id === id);
      if (target) {
        target.checkin = 'Y';
        target.status = 'å·²æ­ä¹˜';
      }
      showAllReservations();
    } else {
      alert('âœ• æ ¸éŠ·å¤±æ•—\n' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (e) {
    console.error('âŒ æ ¸éŠ·éŒ¯èª¤:', e);
    alert('âœ• ç™¼ç”ŸéŒ¯èª¤\n' + e.message);
  }
}

function changeMonth(d){
  currentMonth+=d;
  if(currentMonth<0){currentMonth=11;currentYear--;}
  else if(currentMonth>11){currentMonth=0;currentYear++;}
  renderCalendar();
}
function toggleCalendar(){
  const grid=document.getElementById('calendar-grid');
  const btn=document.getElementById('toggle-calendar');
  const isHidden=grid.style.display==='none'||grid.style.display==='';
  grid.style.display=isHidden?'grid':'none';
  btn.textContent=isHidden?'æ”¶åˆ':'å±•é–‹';
}
function toggleRoute(){
  const content=document.getElementById('route-content');
  const btn=document.getElementById('toggle-route');
  const isHidden=content.style.display==='none'||content.style.display==='';
  content.style.display=isHidden?'block':'none';
  btn.textContent=isHidden?'æ”¶åˆ':'å±•é–‹';
}
function formatDate(date){return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;}
</script>
</body>
</html>
