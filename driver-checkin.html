<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Š - å¸æ©Ÿæ ¸éŠ·ç³»çµ± v3.8.0</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Microsoft JhengHei',sans-serif;}
body{background:#f5f6f7;color:#333;line-height:1.6;width:100vw;overflow-x:hidden;}
.container{width:100%;margin:0;padding:12px;box-sizing:border-box;}
.header{background:#3c8050;color:white;padding:15px;border-radius:12px;margin-bottom:15px;text-align:center;}
.header h1{font-size:22px;margin-bottom:5px;}
.header p{font-size:13px;opacity:0.9;}
.calendar-section,.route-map-section,.checkin-section{background:white;border-radius:12px;padding:15px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.calendar-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;gap:8px;}
.calendar-nav button{background:#3c8050;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;}
.calendar-nav button:hover{background:#2f6842;}
.calendar-title{text-align:center;font-size:16px;font-weight:bold;flex:1;white-space:nowrap;}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.day-header{padding:8px 0;font-weight:bold;background:#27ACB2;color:white;text-align:center;border-radius:4px;font-size:11px;}
.day-cell{padding:8px 0;background:white;border:1px solid #e0e0e0;text-align:center;border-radius:6px;cursor:pointer;transition:all .2s;font-size:12px;aspect-ratio:1;}
.day-cell:hover{background:#eaf5ea;border-color:#3c8050;}
.day-cell.past{background:#f5f5f5;color:#ccc;cursor:not-allowed;}
.day-cell.selected{background:#3c8050;color:white;font-weight:bold;}
.day-cell.other-month{color:#ccc;background:#f8f9fa;}
.checkin-section h2{margin-bottom:12px;color:#333;border-bottom:2px solid #3c8050;padding-bottom:8px;font-size:16px;}
.reservation-table{width:100%;border-collapse:collapse;}
.table-header th{background:#3c8050;color:white;padding:8px;font-size:12px;border:1px solid #2f6842;}
.table-row td{padding:8px;border:1px solid #ddd;font-size:12px;text-align:center;}
.checkin-btn{background:#3c8050;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:11px;}
.checkin-btn:hover{background:#2f6842;}
.checkin-btn:disabled{background:#ccc;cursor:not-allowed;}
.no-data{text-align:center;color:#999;padding:20px;}
.loading{text-align:center;color:#3c8050;padding:20px;}
.hidden{display:none;}
.error-msg{background:#fee;border:1px solid #fcc;color:#c33;padding:10px;border-radius:6px;margin:10px 0;}
.debug-info{background:#f0f0f0;border:1px solid #ddd;padding:10px;border-radius:6px;margin:10px 0;font-size:11px;max-height:200px;overflow-y:auto;}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸšŒ ç©¿å±±ç”²å°ˆè»Šæ ¸éŠ·ç³»çµ±</h1>
    <p>å¸æ©Ÿç°½åˆ°æ ¸éŠ·ä½œæ¥­ v3.8.0</p>
  </div>

  <div class="calendar-section">
    <div class="calendar-nav">
      <button id="prev-month">â—€</button>
      <h2 id="current-month" class="calendar-title"></h2>
      <button id="next-month">â–¶</button>
      <button id="toggle-calendar">å±•é–‹</button>
    </div>
    <div class="calendar-grid" id="calendar-grid" style="display:none;"></div>
  </div>

  <!-- è¡Œè»Šè·¯ç·šåœ– -->
  <div class="route-map-section">
    <div class="route-header">
      <h2>ğŸš è¡Œè»Šè·¯ç·šç¤ºæ„åœ–</h2>
      <button id="toggle-route">å±•é–‹</button>
    </div>

    <div id="route-content" style="display:none;">
      <div class="route-line a-line">
        <h3>ğŸ…°ï¸ Aç·šï¼ˆæš¨å¤§ â†’ åŸ”é‡Œç¸½ç«™ï¼‰</h3>
        <div class="stops">
          <span>è¡Œæ”¿å¤§æ¨“</span><span class="arrow">â”</span>
          <span>ä¸­é¤å»³</span><span class="arrow">â”</span>
          <span>ç§‘æŠ€å­¸é™¢</span><span class="arrow">â”</span>
          <span>å­¸äººæœƒé¤¨</span><span class="arrow">â”</span>
          <span>ä¸­åŸ</span><span class="arrow">â”</span>
          <span>ä¸‹åŸ</span><span class="arrow">â”</span>
          <span>åªé ‚</span><span class="arrow">â”</span>
          <span>æ„›è˜­æ©‹</span><span class="arrow">â”</span>
          <span>å¤§æˆåœ‹å°</span><span class="arrow">â”</span>
          <span>ä¸­å±±å®‰ä¸ƒè¡—å£</span><span class="arrow">â”</span>
          <span>æ¦®æ°‘è¨ºæ‰€</span><span class="arrow">â”</span>
          <strong>åŸ”é‡Œé…’å» </strong><span class="arrow">â”</span>
          <strong>åŸ”é‡Œç¸½ç«™</strong>
        </div>
      </div>

      <div class="route-line b-line">
        <h3>ğŸ…±ï¸ Bç·šï¼ˆåŸ”é‡Œç¸½ç«™ â†’ æš¨å¤§ï¼‰</h3>
        <div class="stops">
          <strong>åŸ”é‡Œç¸½ç«™</strong><span class="arrow">â”</span>
          <strong>åŸ”é‡Œé…’å» </strong><span class="arrow">â”</span>
          <span>æ¦®æ°‘è¨ºæ‰€</span><span class="arrow">â”</span>
          <span>ä¸­å±±å®‰ä¸ƒè¡—å£</span><span class="arrow">â”</span>
          <span>å¤§æˆåœ‹å°</span><span class="arrow">â”</span>
          <span>æ„›è˜­æ©‹</span><span class="arrow">â”</span>
          <span>åªé ‚</span><span class="arrow">â”</span>
          <span>ä¸‹åŸ</span><span class="arrow">â”</span>
          <span>ä¸­åŸ</span><span class="arrow">â”</span>
          <span>å­¸äººæœƒé¤¨</span><span class="arrow">â”</span>
          <span>ç§‘æŠ€å­¸é™¢</span><span class="arrow">â”</span>
          <span>ä¸­é¤å»³</span><span class="arrow">â”</span>
          <strong>è¡Œæ”¿å¤§æ¨“</strong>
        </div>
      </div>
    </div>
  </div>

  <div id="checkin-section" class="checkin-section">
    <h2 id="checkin-title">å…¨éƒ¨é ç´„åˆ—è¡¨</h2>
    <div id="loadingMsg" class="loading">ğŸš è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
    <div id="errorMsg" class="error-msg hidden"></div>
    <table class="reservation-table">
      <thead class="table-header">
        <tr>
          <th>æ—¥æœŸ</th>
          <th>ç­æ¬¡</th>
          <th>å§“å</th>
          <th>ä¸Šè»Š</th>
          <th>ä¸‹è»Š</th>
          <th>ç‹€æ…‹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="reservation-list"></tbody>
    </table>
  </div>
</div>

<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';

let allReservations = [];
let currentDate = new Date();
let currentMonth = currentDate.getMonth();
let currentYear = currentDate.getFullYear();
let selectedDate = null;

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('prev-month').onclick = () => changeMonth(-1);
  document.getElementById('next-month').onclick = () => changeMonth(1);
  document.getElementById('toggle-calendar').onclick = toggleCalendar;
  document.getElementById('toggle-route').onclick = toggleRoute;
  initializeSystem();
});

async function initializeSystem() {
  showLoading(true);
  await loadAllReservations();
  showLoading(false);
  renderCalendar();
  showTodayReservations();
}

function showLoading(show) {
  document.getElementById('loadingMsg').classList.toggle('hidden', !show);
}

function showError(message) {
  const errorDiv = document.getElementById('errorMsg');
  errorDiv.textContent = 'âŒ ' + message;
  errorDiv.classList.remove('hidden');
  console.error('é¡¯ç¤ºéŒ¯èª¤:', message);
}

function hideError() {
  document.getElementById('errorMsg').classList.add('hidden');
}

async function loadAllReservations() {
  try {
    hideError();
    
    // å–å¾— URL åƒæ•¸ä¸­çš„ admin IDï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
    const urlParams = new URLSearchParams(window.location.search);
    const adminId = urlParams.get('admin') || 'all';
    
    console.log('ğŸ” é–‹å§‹æŸ¥è©¢é ç´„è³‡æ–™, userId:', adminId);
    
    const fetchUrl = `${WORKER_URL}?mode=reservations&userId=${adminId}`;
    console.log('ğŸ“¤ è«‹æ±‚ URL:', fetchUrl);
    
    const response = await fetch(fetchUrl);
    console.log('ğŸ“¥ æ”¶åˆ°å›æ‡‰, status:', response.status);
    
    // æª¢æŸ¥å…§å®¹é¡å‹
    const contentType = response.headers.get('content-type');
    console.log('ğŸ“‹ Content-Type:', contentType);
    
    if (!contentType || !contentType.includes('application/json')) {
      const text = await response.text();
      console.error('âŒ æ”¶åˆ°é JSON æ ¼å¼:', text.substring(0, 200));
      showError('API è¿”å›æ ¼å¼éŒ¯èª¤');
      allReservations = [];
      renderEmptyList();
      return;
    }
    
    const data = await response.json();
    console.log('âœ… æˆåŠŸè§£æ JSON:', data);
    
    if (data.status === 'success' && Array.isArray(data.reservations)) {
      console.log('ğŸ“Š æ”¶åˆ°é ç´„æ•¸æ“š:', data.reservations.length, 'ç­†');
      
      // æ˜ å°„æ•¸æ“šåˆ°çµ±ä¸€æ ¼å¼
      allReservations = data.reservations.map((r, i) => {
        const mapped = {
          id: String(r.id || r.reservationId || i + 1),
          date: r.date || r.æ—¥æœŸ || '',
          route: r.route || r.ç­æ¬¡ || r.shift || '-',
          name: r.name || r.å§“å || '-',
          fromStop: r.fromStop || r.pickupLocation || r.ä¸Šè»Šé» || r.E || 'æœªæä¾›',
          toStop: r.toStop || r.dropoffLocation || r.ä¸‹è»Šé» || r.F || 'æœªæä¾›',
          checkin: r.checkin || r.checkinStatus || r.J || '',
          status: r.status || 'å·²é ç´„'
        };
        console.log('æ˜ å°„é ç´„:', mapped);
        return mapped;
      });
      
      console.log('âœ… æˆåŠŸè¼‰å…¥', allReservations.length, 'ç­†é ç´„');
      
    } else {
      console.warn('âš ï¸ API è¿”å›ç•°å¸¸:', data);
      showError(data.message || 'ç„¡æ³•å–å¾—é ç´„è³‡æ–™');
      allReservations = [];
      renderEmptyList();
    }
    
  } catch (error) {
    console.error('âŒ è³‡æ–™è¼‰å…¥å¤±æ•—:', error);
    showError('è¼‰å…¥å¤±æ•—: ' + error.message);
    allReservations = [];
    renderEmptyList();
  }
}

function renderEmptyList() {
  const tbody = document.getElementById('reservation-list');
  tbody.innerHTML = '<tr><td colspan="7" class="no-data">æš«ç„¡é ç´„ç´€éŒ„</td></tr>';
  document.getElementById('checkin-title').textContent = 'å…¨éƒ¨é ç´„åˆ—è¡¨ (0 ç­†)';
}

function renderCalendar() {
  const grid = document.getElementById('calendar-grid');
  grid.innerHTML = '';
  
  ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(d => {
    const h = document.createElement('div');
    h.className = 'day-header';
    h.textContent = d;
    grid.appendChild(h);
  });
  
  const first = new Date(currentYear, currentMonth, 1);
  const last = new Date(currentYear, currentMonth + 1, 0);
  const offset = first.getDay();
  const today = formatDate(new Date());
  
  for (let i = 0; i < offset; i++) {
    const d = document.createElement('div');
    d.className = 'day-cell other-month';
    grid.appendChild(d);
  }
  
  for (let i = 1; i <= last.getDate(); i++) {
    const d = document.createElement('div');
    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
    d.className = 'day-cell';
    if (dateStr === selectedDate) d.classList.add('selected');
    if (dateStr < today) d.classList.add('past');
    else d.onclick = () => selectDate(dateStr);
    d.textContent = i;
    grid.appendChild(d);
  }
  
  document.getElementById('current-month').textContent = `${currentYear}å¹´${currentMonth + 1}æœˆ`;
}

function selectDate(date) {
  selectedDate = date;
  renderCalendar();
  showReservationsByDate(date);
}

function showTodayReservations() {
  const today = formatDate(new Date());
  showReservationsByDate(today);
}

function showAllReservations() {
  const tbody = document.getElementById('reservation-list');
  tbody.innerHTML = '';
  
  if (allReservations.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" class="no-data">æš«ç„¡é ç´„ç´€éŒ„</td></tr>`;
    document.getElementById('checkin-title').textContent = 'å…¨éƒ¨é ç´„åˆ—è¡¨ (0 ç­†)';
    return;
  }
  
  console.log('ğŸ“‹ é¡¯ç¤ºå…¨éƒ¨é ç´„:', allReservations.length, 'ç­†');
  
  const routes = ['A1', 'B1', 'A2', 'B2'];
  const sorted = [...allReservations].sort((a, b) => {
    // å…ˆæŒ‰æ—¥æœŸæ’åº
    if (a.date !== b.date) return a.date.localeCompare(b.date);
    // æ—¥æœŸç›¸åŒæŒ‰ç­æ¬¡æ’åº
    return routes.indexOf(a.route) - routes.indexOf(b.route);
  });
  
  sorted.forEach(r => {
    const checked = r.checkin === 'Y' || r.status === 'å·²æ­ä¹˜';
    const status = checked ? 'å·²æ­ä¹˜' : r.status === 'å·²å–æ¶ˆ' ? 'å·²å–æ¶ˆ' : 'å·²é ç´„';
    const tr = document.createElement('tr');
    tr.className = 'table-row';
    tr.innerHTML = `
      <td>${formatDateDisplay(r.date)}</td>
      <td>${r.route}</td>
      <td>${r.name}</td>
      <td>${r.fromStop}</td>
      <td>${r.toStop}</td>
      <td>${status}</td>
      <td>${checked ? '<button class="checkin-btn" disabled>âœ…</button>' : `<button class="checkin-btn" onclick="confirmCheckin('${r.id}')">æ ¸éŠ·</button>`}</td>
    `;
    tbody.appendChild(tr);
  });
  
  document.getElementById('checkin-title').textContent = `å…¨éƒ¨é ç´„åˆ—è¡¨ (${sorted.length} ç­†)`;
}

function showReservationsByDate(date) {
  const tbody = document.getElementById('reservation-list');
  tbody.innerHTML = '';
  
  console.log('ğŸ” ç¯©é¸æ—¥æœŸ:', date);
  console.log('ğŸ“‹ ç¸½é ç´„æ•¸:', allReservations.length);
  
  const filtered = allReservations.filter(r => {
    const match = r.date.startsWith(date);
    if (match) console.log('âœ… ç¬¦åˆ:', r);
    return match;
  });
  
  console.log('ğŸ“Š ç¯©é¸çµæœ:', filtered.length, 'ç­†');
  
  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" class="no-data">æ­¤æ—¥æœŸç„¡é ç´„</td></tr>`;
    document.getElementById('checkin-title').textContent = `${formatDateDisplay(date)} ç„¡é ç´„`;
    return;
  }
  
  const routes = ['A1', 'B1', 'A2', 'B2'];
  filtered.sort((a, b) => routes.indexOf(a.route) - routes.indexOf(b.route));
  
  filtered.forEach(r => {
    const checked = r.checkin === 'Y' || r.status === 'å·²æ­ä¹˜';
    const status = checked ? 'å·²æ­ä¹˜' : r.status === 'å·²å–æ¶ˆ' ? 'å·²å–æ¶ˆ' : 'å·²é ç´„';
    const tr = document.createElement('tr');
    tr.className = 'table-row';
    tr.innerHTML = `
      <td>${formatDateDisplay(r.date)}</td>
      <td>${r.route}</td>
      <td>${r.name}</td>
      <td>${r.fromStop}</td>
      <td>${r.toStop}</td>
      <td>${status}</td>
      <td>${checked ? '<button class="checkin-btn" disabled>âœ…</button>' : `<button class="checkin-btn" onclick="confirmCheckin('${r.id}')">æ ¸éŠ·</button>`}</td>
    `;
    tbody.appendChild(tr);
  });
  
  document.getElementById('checkin-title').textContent = `${formatDateDisplay(date)} é ç´„ (${filtered.length} ç­†)`;
}

function formatDateDisplay(dateStr) {
  if (!dateStr) return '-';
  try {
    // è™•ç† YYYY-MM-DD æ ¼å¼
    const parts = dateStr.split(/[-\/]/);
    if (parts.length >= 3) {
      return `${parts[1].padStart(2, '0')}/${parts[2].padStart(2, '0')}`;
    }
    return dateStr;
  } catch (e) {
    return dateStr;
  }
}

async function confirmCheckin(id) {
  if (!confirm('ç¢ºèªæ­¤ä¹˜å®¢å·²æ ¸éŠ·ï¼Ÿ')) return;
  
  try {
    console.log('âœ… é–‹å§‹æ ¸éŠ·, id:', id);
    
    // çµ±ä¸€èµ° Workerï¼Œä½¿ç”¨ confirmCheckin mode
    const url = `${WORKER_URL}?mode=confirmCheckin&id=${encodeURIComponent(id)}`;
    console.log('ğŸ“¤ æ ¸éŠ·è«‹æ±‚:', url);
    
    const response = await fetch(url, { method: 'POST' });
    const contentType = response.headers.get('content-type');
    
    if (!contentType || !contentType.includes('application/json')) {
      const text = await response.text();
      console.error('âŒ æ ¸éŠ·è¿”å›é JSON:', text);
      throw new Error('æ ¸éŠ· API æ ¼å¼éŒ¯èª¤');
    }
    
    const data = await response.json();
    console.log('ğŸ“¥ æ ¸éŠ·çµæœ:', data);
    
    if (data.status === 'success') {
      alert('âœ… æ ¸éŠ·æˆåŠŸ');
      
      // æ›´æ–°æœ¬åœ°æ•¸æ“š
      const target = allReservations.find(r => r.id === id);
      if (target) {
        target.checkin = 'Y';
        target.status = 'å·²æ­ä¹˜';
      }
      
      // é‡æ–°é¡¯ç¤ºåˆ—è¡¨
      if (selectedDate) {
        showReservationsByDate(selectedDate);
      } else {
        showUpcomingReservations();
      }
    } else {
      alert('âŒ æ ¸éŠ·å¤±æ•—: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
    }
    
  } catch (error) {
    console.error('âŒ æ ¸éŠ·éŒ¯èª¤:', error);
    alert('âŒ æ ¸éŠ·å¤±æ•—: ' + error.message);
  }
}

function changeMonth(d) {
  currentMonth += d;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  renderCalendar();
}

function toggleCalendar() {
  const grid = document.getElementById('calendar-grid');
  const btn = document.getElementById('toggle-calendar');
  const isHidden = grid.style.display === 'none';
  grid.style.display = isHidden ? 'grid' : 'none';
  btn.textContent = isHidden ? 'æ”¶åˆ' : 'å±•é–‹';
}

function toggleRoute() {
  const content = document.getElementById('route-content');
  const btn = document.getElementById('toggle-route');
  const isHidden = content.style.display === 'none';
  content.style.display = isHidden ? 'block' : 'none';
  btn.textContent = isHidden ? 'æ”¶åˆ' : 'å±•é–‹';
}

function formatDate(date) {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
}
</script>
</body>
</html>
