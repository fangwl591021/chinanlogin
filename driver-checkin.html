<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Š - å¸æ©Ÿæ ¸éŠ·ç³»çµ±</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Microsoft JhengHei',sans-serif;}
body{background:#f5f6f7;color:#333;line-height:1.6;}
.container{max-width:900px;margin:0 auto;padding:20px;}

/* === é ‚éƒ¨è³‡è¨Š === */
.header{background:#3c8050;color:white;padding:15px;border-radius:12px;margin-bottom:20px;text-align:center;}
.header h1{font-size:22px;margin-bottom:5px;}
.header p{font-size:13px;opacity:0.9;}

/* === æœˆæ›† === */
.calendar-section{background:white;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.calendar-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;gap:10px;}
.calendar-nav button{background:#3c8050;color:white;border:none;padding:8px 15px;border-radius:6px;cursor:pointer;font-size:14px;}
.calendar-nav button:hover{background:#2f6842;}
.calendar-title{text-align:center;font-size:18px;font-weight:bold;flex:1;}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;}
.day-header{padding:10px 0;font-weight:bold;background:#27ACB2;color:white;text-align:center;border-radius:4px;font-size:12px;}
.day-cell{padding:12px 0;background:white;border:1px solid #e0e0e0;text-align:center;border-radius:6px;cursor:pointer;transition:all .2s;min-height:50px;display:flex;flex-direction:column;justify-content:center;font-size:14px;}
.day-cell:hover{background:#eaf5ea;border-color:#3c8050;}
.day-cell.disabled{background:#f8f9fa;color:#999;cursor:not-allowed;}
.day-cell.past{background:#f5f5f5;color:#ccc;cursor:not-allowed;}
.day-cell.selected{background:#3c8050;color:white;font-weight:bold;}
.day-cell.other-month{color:#ccc;background:#f8f9fa;}
.day-cell small{font-size:10px;color:#666;margin-top:4px;}

/* === æ ¸éŠ·åˆ—è¡¨ === */
.checkin-section{background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.checkin-section h2{margin-bottom:15px;color:#333;border-bottom:2px solid #3c8050;padding-bottom:10px;}
.reservation-table{width:100%;border-collapse:collapse;}
.table-header{background:#3c8050;color:white;font-weight:bold;text-align:left;}
.table-header th{padding:12px;font-size:14px;border:1px solid #2f6842;}
.table-row{border-bottom:1px solid #e0e0e0;hover-effect:true;}
.table-row:hover{background:#f8faf8;}
.table-row td{padding:12px;border:1px solid #e0e0e0;font-size:13px;}
.passenger-name{color:#0066cc;cursor:pointer;font-weight:600;text-decoration:underline;}
.passenger-name:hover{color:#0052a3;}
.status-booked{color:#3c8050;font-weight:bold;}
.status-checkedin{color:#27ACB2;font-weight:bold;}
.status-cancelled{color:#ccc;text-decoration:line-through;}
.checkin-btn{background:#3c8050;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap;}
.checkin-btn:hover{background:#2f6842;}
.checkin-btn:disabled{background:#ccc;cursor:not-allowed;}
.no-data{text-align:center;color:#999;padding:40px 20px;}

/* === å½ˆå‡ºçª—å£ === */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;}
.modal.active{display:flex;}
.modal-content{background:white;border-radius:12px;padding:30px;max-width:400px;box-shadow:0 4px 20px rgba(0,0,0,0.3);}
.modal-header{font-size:18px;font-weight:bold;margin-bottom:20px;border-bottom:2px solid #3c8050;padding-bottom:10px;}
.modal-body{margin-bottom:20px;line-height:2;}
.modal-body div{margin-bottom:12px;}
.modal-label{color:#666;font-size:13px;}
.modal-value{color:#333;font-weight:600;font-size:15px;}
.phone-link{color:#0066cc;text-decoration:none;font-weight:600;cursor:pointer;}
.modal-close{background:#e0e0e0;color:#333;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;}
.modal-close:hover{background:#ccc;}
</style>
</head>

<body>
<div class="container">
  <!-- é ‚éƒ¨ -->
  <div class="header">
    <h1>ğŸšŒ ç©¿å±±ç”²å°ˆè»Šæ ¸éŠ·ç³»çµ±</h1>
    <p>å¸æ©Ÿç°½åˆ°æ ¸éŠ·ä½œæ¥­</p>
  </div>

  <!-- æœˆæ›† -->
  <div class="calendar-section">
    <div class="calendar-nav">
      <button id="prev-month">â—€ ä¸Šæœˆ</button>
      <h2 class="calendar-title" id="current-month">2025å¹´10æœˆ</h2>
      <button id="next-month">ä¸‹æœˆ â–¶</button>
      <button id="toggle-calendar" style="background:#666;padding:8px 12px;">æ”¶åˆ</button>
    </div>
    <div class="calendar-grid" id="calendar-grid" style="display:none;"></div>
  </div>

  <!-- æ ¸éŠ·åˆ—è¡¨ -->
  <div id="checkin-section" class="checkin-section" style="display:none;">
    <h2 id="checkin-title">æ ¸éŠ·åˆ—è¡¨</h2>
    <table class="reservation-table">
      <thead class="table-header">
        <tr>
          <th>æ—¥æœŸ</th>
          <th>ç­æ¬¡</th>
          <th>å§“å</th>
          <th>é›»è©±</th>
          <th>ä¸Šè»Š</th>
          <th>ä¸‹è»Š</th>
          <th>ç‹€æ…‹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="reservation-list"></tbody>
    </table>
  </div>
</div>

<!-- è©³ç´°è³‡è¨Šå½ˆå‡ºçª— -->
<div id="infoModal" class="modal">
  <div class="modal-content">
    <div class="modal-header" id="modal-name"></div>
    <div class="modal-body">
      <div>
        <div class="modal-label">ç§‘ç³»</div>
        <div class="modal-value" id="modal-department"></div>
      </div>
      <div>
        <div class="modal-label">å­¸è™Ÿ</div>
        <div class="modal-value" id="modal-studentid"></div>
      </div>
      <div>
        <div class="modal-label">é›»è©±</div>
        <div class="modal-value">
          <a id="modal-phone" href="#" class="phone-link"></a>
        </div>
      </div>
    </div>
    <button class="modal-close" onclick="closeModal()">é—œé–‰</button>
  </div>
</div>

<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbza2qFcrQt1PS6Y4p4u2gSXovvFxWecEjjIh5ov1cIk_65zgdFJA0xjVuS3qr7WvlgAzA/exec';

let currentDate = new Date();
let currentMonth = currentDate.getMonth();
let currentYear = currentDate.getFullYear();
let selectedDate = null;
let allReservations = [];

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('prev-month').onclick = () => changeMonth(-1);
  document.getElementById('next-month').onclick = () => changeMonth(1);
  document.getElementById('toggle-calendar').onclick = toggleCalendar;
  initializeSystem();
});

async function initializeSystem() {
  await loadAllReservations();
  renderCalendar();
  showAllReservations();
}

async function loadAllReservations() {
  try {
    const res = await fetch(`${WORKER_URL}?mode=reservations`);
    const result = await res.json();
    allReservations = (result.reservations || []).filter(r => r.status !== 'å·²å–æ¶ˆ');
    console.log('å·²è¼‰å…¥é ç´„:', allReservations.length);
  } catch (e) {
    console.error('è¼‰å…¥å¤±æ•—:', e);
    allReservations = [];
  }
}

function renderCalendar() {
  const grid = document.getElementById('calendar-grid');
  grid.innerHTML = '';
  
  // æ˜ŸæœŸæ¨™é¡Œ
  ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(d => {
    const h = document.createElement('div');
    h.className = 'day-header';
    h.textContent = d;
    grid.appendChild(h);
  });
  
  const first = new Date(currentYear, currentMonth, 1);
  const last = new Date(currentYear, currentMonth + 1, 0);
  const offset = first.getDay();
  const today = formatDate(new Date());
  
  // å‰æœˆæ—¥æœŸ
  for (let i = offset - 1; i >= 0; i--) {
    const d = document.createElement('div');
    d.className = 'day-cell other-month';
    grid.appendChild(d);
  }
  
  // ç•¶æœˆæ—¥æœŸ
  for (let i = 1; i <= last.getDate(); i++) {
    const d = document.createElement('div');
    d.className = 'day-cell';
    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
    
    // æª¢æŸ¥æ—¥æœŸç‹€æ…‹
    const hasReservation = allReservations.some(r => r.date?.startsWith(dateStr));
    const isPast = dateStr < today;
    
    if (isPast) {
      d.classList.add('past');
    } else if (hasReservation) {
      d.onclick = () => selectDate(dateStr);
    } else {
      d.onclick = () => selectDate(dateStr);
    }
    
    if (dateStr === selectedDate) {
      d.classList.add('selected');
    }
    
    d.textContent = i;
    if (hasReservation) {
      d.innerHTML += `<small>æœ‰é ç´„</small>`;
    }
    
    grid.appendChild(d);
  }
  
  // æ¬¡æœˆæ—¥æœŸ
  const totalCells = 42;
  const nextMonthDays = totalCells - (offset + last.getDate());
  for (let i = 1; i <= nextMonthDays; i++) {
    const d = document.createElement('div');
    d.className = 'day-cell other-month';
    grid.appendChild(d);
  }
  
  document.getElementById('current-month').textContent = `${currentYear}å¹´${currentMonth + 1}æœˆ`;
}

async function selectDate(dateStr) {
  selectedDate = dateStr;
  renderCalendar();
  showCheckinList();
}

function showCheckinList() {
  if (!selectedDate) return;
  
  const tbody = document.getElementById('reservation-list');
  tbody.innerHTML = '';
  
  // æŒ‰æ—¥æœŸã€ç­æ¬¡æ’åº
  const routes = ['A1', 'B1', 'A2', 'B2'];
  const filtered = allReservations
    .filter(r => r.date?.startsWith(selectedDate))
    .sort((a, b) => {
      const routeOrder = routes.indexOf(a.route) - routes.indexOf(b.route);
      return routeOrder !== 0 ? routeOrder : (a.name || '').localeCompare(b.name || '');
    });
  
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="no-data">æ­¤æ—¥æœŸç„¡é ç´„</td></tr>';
    document.getElementById('checkin-section').style.display = 'block';
    document.getElementById('checkin-title').textContent = `${selectedDate} æ ¸éŠ·åˆ—è¡¨`;
    return;
  }
  
  renderReservationRows(filtered, `${selectedDate} æ ¸éŠ·åˆ—è¡¨ (å…± ${filtered.length} ç­†)`);
}

function showAllReservations() {
  const tbody = document.getElementById('reservation-list');
  tbody.innerHTML = '';
  
  // æŒ‰æ—¥æœŸã€ç­æ¬¡æ’åº
  const routes = ['A1', 'B1', 'A2', 'B2'];
  const sorted = [...allReservations].sort((a, b) => {
    const dateCompare = (a.date || '').localeCompare(b.date || '');
    if (dateCompare !== 0) return dateCompare;
    const routeOrder = routes.indexOf(a.route) - routes.indexOf(b.route);
    return routeOrder !== 0 ? routeOrder : (a.name || '').localeCompare(b.name || '');
  });
  
  if (sorted.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="no-data">æš«ç„¡é ç´„</td></tr>';
    document.getElementById('checkin-section').style.display = 'block';
    document.getElementById('checkin-title').textContent = 'å…¨éƒ¨é ç´„åˆ—è¡¨';
    return;
  }
  
  renderReservationRows(sorted, `å…¨éƒ¨é ç´„åˆ—è¡¨ (å…± ${sorted.length} ç­†)`);
}

function renderReservationRows(filtered, title) {
  const tbody = document.getElementById('reservation-list');
  tbody.innerHTML = '';
  
  filtered.forEach(r => {
    const tr = document.createElement('tr');
    tr.className = 'table-row';
    
    const isCheckedIn = r.checkinStatus === 'Y';
    const statusClass = isCheckedIn ? 'status-checkedin' : 'status-booked';
    const statusText = isCheckedIn ? 'å·²æ ¸éŠ·' : 'æœªæ ¸éŠ·';
    
    let phoneDisplay = r.phone || 'æœªæä¾›';
    if (phoneDisplay !== 'æœªæä¾›' && phoneDisplay.length < 10) {
      phoneDisplay = '0' + phoneDisplay;
    }
    
    tr.innerHTML = `
      <td>${r.date?.split('T')[0] || ''}</td>
      <td><strong>${r.route}</strong></td>
      <td><span class="passenger-name" onclick="showModal('${r.name}', '${r.department}', '${r.studentId}', '${phoneDisplay}')">${r.name}</span></td>
      <td>${phoneDisplay}</td>
      <td>${r.fromStop}</td>
      <td>${r.toStop}</td>
      <td><span class="${statusClass}">${statusText}</span></td>
      <td>
        ${isCheckedIn 
          ? '<button class="checkin-btn" disabled>âœ… å·²æ ¸éŠ·</button>' 
          : `<button class="checkin-btn" onclick="confirmCheckin('${r.id}')">æ ¸éŠ·</button>`}
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  document.getElementById('checkin-section').style.display = 'block';
  document.getElementById('checkin-title').textContent = title;
}

function showModal(name, department, studentId, phone) {
  document.getElementById('modal-name').textContent = name;
  document.getElementById('modal-department').textContent = department || 'æœªæä¾›';
  document.getElementById('modal-studentid').textContent = studentId || 'æœªæä¾›';
  
  const phoneLink = document.getElementById('modal-phone');
  if (phone && phone !== 'æœªæä¾›') {
    phoneLink.href = `tel:${phone}`;
    phoneLink.textContent = phone;
  } else {
    phoneLink.textContent = 'æœªæä¾›';
    phoneLink.href = '#';
  }
  
  document.getElementById('infoModal').classList.add('active');
}

function closeModal() {
  document.getElementById('infoModal').classList.remove('active');
}

async function confirmCheckin(id) {
  if (!confirm('ç¢ºèªæ­¤ä¹˜å®¢å·²æ ¸éŠ·ï¼Ÿ')) return;
  
  try {
    const res = await fetch(`${GAS_URL}?mode=confirmCheckin&id=${encodeURIComponent(id)}`);
    const result = await res.json();
    
    if (result.status === 'success') {
      alert('âœ… æ ¸éŠ·æˆåŠŸ');
      const target = allReservations.find(r => r.id === id);
      if (target) target.checkinStatus = 'Y';
      showCheckinList();
    } else {
      alert('âŒ æ ¸éŠ·å¤±æ•—ï¼š' + (result.message || 'è«‹ç¨å¾Œå†è©¦'));
    }
  } catch (e) {
    alert('âŒ éŒ¯èª¤ï¼š' + e.message);
  }
}

async function changeMonth(delta) {
  currentMonth += delta;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  selectedDate = null;
  await loadAllReservations();
  renderCalendar();
  showAllReservations();
}

function toggleCalendar() {
  const grid = document.getElementById('calendar-grid');
  const btn = document.getElementById('toggle-calendar');
  const isHidden = grid.style.display === 'none';
  grid.style.display = isHidden ? 'grid' : 'none';
  btn.textContent = isHidden ? 'æ”¶åˆ' : 'å±•é–‹';
}

function formatDate(date) {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
}

// é»æ“Šå½ˆçª—å¤–é—œé–‰
document.getElementById('infoModal').addEventListener('click', (e) => {
  if (e.target.id === 'infoModal') closeModal();
});
</script>
</body>
</html>
