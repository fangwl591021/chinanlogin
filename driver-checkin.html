<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>穿山甲專車 - 司機核銷系統</title>
<style>
/* === 基本樣式 === */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Microsoft JhengHei',sans-serif;}
body{background:#f5f6f7;color:#333;line-height:1.6;}
header{background:#3c8050;color:#fff;text-align:center;padding:15px;font-size:22px;font-weight:bold;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.container{max-width:1200px;margin:0 auto;padding:20px;}

/* === 月曆 === */
.calendar-section{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.calendar-header{display:flex;flex-direction:column;gap:12px;margin-bottom:15px;}
.calendar-header-nav{display:flex;justify-content:space-between;align-items:center;gap:10px;}
.calendar-title{text-align:center;font-size:18px;font-weight:bold;width:100%;}
.calendar-nav{background:#3498db;color:white;border:none;padding:8px 15px;border-radius:6px;cursor:pointer;font-size:14px;min-width:100px;}
.calendar-nav:hover{background:#2980b9;}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;text-align:center;}
.calendar-day-header{padding:10px 0;font-weight:bold;background:#27ACB2;color:white;border-radius:4px;font-size:13px;}
.calendar-day{padding:8px 0;border-radius:6px;background:white;border:1px solid #e0e0e0;cursor:pointer;transition:all .2s;min-height:50px;display:flex;flex-direction:column;justify-content:center;align-items:center;font-size:14px;}
.calendar-day:hover{background:#eaf5ea;border-color:#3c8050;}
.calendar-day.disabled{background:#f8f9fa;color:#999;cursor:not-allowed;min-height:40px;padding:4px 0;}
.calendar-day.past{background:#f5f5f5;color:#ccc;cursor:not-allowed;min-height:35px;padding:3px 0;font-size:12px;}
.calendar-day.selected{background:#3c8050;color:white;font-weight:bold;border-color:#3c8050;}
.calendar-day.other-month{color:#ccc;background:#f8f9fa;}
.calendar-day small{font-size:9px;color:#666;display:block;margin-top:2px;line-height:1.2;}
.calendar-day.past small{color:#999;}

/* === 時段卡片 === */
.time-slots-section{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.time-slots{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:10px 12px;justify-content:center;align-items:start;max-width:420px;margin:10px auto 0;}
.time-slot-btn{background:#fff;border:1.5px solid #d0d7de;border-radius:8px;padding:8px 6px;text-align:left;cursor:pointer;transition:all .25s ease;box-shadow:0 1px 3px rgba(0,0,0,0.08);min-height:70px;}
.time-slot-btn:hover{background:#f2f8f2;border-color:#3c8050;}
.time-slot-btn.selected{background:#3c8050;color:#fff;border-color:#3c8050;}
.route-time{font-weight:700;font-size:14px;margin-bottom:2px;}
.time-slot-info{font-size:12px;color:#555;line-height:1.3;}
.reservation-count{display:inline-block;margin-top:3px;padding:1px 5px;background:#e74c3c;color:white;border-radius:10px;font-size:11px;font-weight:500;}

/* === 乘客卡片 === */
.passenger-card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:10px 12px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;}
.passenger-main{flex:1;min-width:240px;}
.passenger-name{font-weight:700;font-size:15px;margin-bottom:4px;}
.passenger-info{font-size:13px;color:#555;line-height:1.4;}
.passenger-status{font-size:13px;font-weight:600;color:#3c8050;margin-top:6px;}
.card-actions{display:flex;gap:8px;align-items:center;margin-top:6px;}
.checkin-btn{background:#3c8050;color:#fff;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;}
.checkin-btn:hover{background:#2f6842;}
.checked-in{color:#3c8050;font-weight:bold;}
.no-data{text-align:center;color:#777;margin-top:20px;}
</style>
</head>

<body>
<div class="container">
  <div class="calendar-section">
    <div class="calendar-header">
      <div class="calendar-header-nav">
        <button class="calendar-nav" id="prev-month">◀ 上個月</button>
        <button class="calendar-nav" id="next-month">下個月 ▶</button>
      </div>
      <h2 class="calendar-title" id="current-month">2025年10月</h2>
    </div>
    <div class="calendar-grid" id="calendar-days"></div>
  </div>

  <div id="selectedDate" class="notice success" style="display:none;"></div>

  <div id="timeSlotsSection" class="time-slots-section" style="display:none;">
    <h3>請選擇班次時段</h3>
    <div class="time-slots" id="time-slots"></div>
  </div>

  <div id="passengerSection" class="passenger-section" style="display:none;">
    <h2>乘客核銷列表</h2>
    <div id="selected-info" style="margin-bottom:10px;color:#555;"></div>
    <div id="passenger-list"></div>
  </div>
</div>

<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
const routeTimes = {
  'A1': { time: '22:00-22:30', direction: '暨大→埔里總站' },
  'B1': { time: '22:30-23:00', direction: '埔里總站→暨大' },
  'A2': { time: '23:00-23:30', direction: '暨大→埔里總站' },
  'B2': { time: '23:30-24:00', direction: '埔里總站→暨大' }
};
let currentDate = new Date(), selectedDate=null, selectedTimeSlot=null, allReservations=[], currentMonth=currentDate.getMonth(), currentYear=currentDate.getFullYear();

document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('prev-month').onclick=showPreviousMonth;
  document.getElementById('next-month').onclick=showNextMonth;
  initializeSystem();
});

async function initializeSystem(){
  await loadAllReservations();
  renderCalendar();
}

async function loadAllReservations(){
  try{
    const res=await fetch(`${WORKER_URL}?mode=reservations`);
    const result=await res.json();
    allReservations=result.reservations||[];
  }catch{allReservations=[];}
}

function renderCalendar(){
  const y=currentYear, m=currentMonth;
  const el=document.getElementById('calendar-days');
  el.innerHTML='';
  
  // 添加星期標題
  ['日','一','二','三','四','五','六'].forEach(d=>{
    const e=document.createElement('div');
    e.className='calendar-day-header';
    e.textContent=d;
    el.appendChild(e);
  });
  
  const first=new Date(y,m,1), last=new Date(y,m+1,0), offset=first.getDay();
  
  // 添加上月日期
  for(let i=offset-1;i>=0;i--){
    const d=document.createElement('div');
    d.className='calendar-day other-month';
    el.appendChild(d);
  }
  
  // 獲得今天日期
  const today = new Date();
  const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
  
  // 添加當月日期
  for(let i=1;i<=last.getDate();i++){
    const d=document.createElement('div');
    d.className='calendar-day';
    
    const dateStr=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
    
    // 檢查日期狀態
    let isDisabled = false;
    let reason = '';
    let isPast = false;
    
    // 1. 檢查是否過期
    if(dateStr < todayStr){
      d.classList.add('past');
      reason = '已過期';
      isDisabled = true;
      isPast = true;
    }
    // 2. 檢查該日期是否有預約
    else if(allReservations.some(r => r.date?.startsWith(dateStr))){
      reason = '有預約';
      d.onclick=()=>selectDate(dateStr);
    }
    // 3. 其他未來日期可選
    else{
      d.onclick=()=>selectDate(dateStr);
    }
    
    // 設定顯示文字
    if(!isPast){
      d.innerHTML=`${i}${reason ? `<small>${reason}</small>` : ''}`;
    }else{
      d.innerHTML=`${i}<small>${reason}</small>`;
      d.onclick=null;
      d.classList.add('disabled');
    }
    
    // 標記已選擇的日期
    if(dateStr === selectedDate){
      d.classList.add('selected');
    }
    
    el.appendChild(d);
  }
  
  // 添加下月日期
  const totalCells = 42;
  const nextMonthDays = totalCells - (offset + last.getDate());
  for(let i=1;i<=nextMonthDays;i++){
    const d=document.createElement('div');
    d.className='calendar-day other-month';
    el.appendChild(d);
  }
  
  document.getElementById('current-month').textContent=`${y}年${m+1}月`;
}

async function selectDate(dateStr){
  selectedDate=dateStr;
  document.getElementById('selectedDate').style.display='block';
  document.getElementById('selectedDate').textContent=`✅ 已選擇日期：${dateStr}`;
  showTimeSlots();
}

function showTimeSlots(){
  const container=document.getElementById('time-slots');
  let html='';
  for(const [id,info] of Object.entries(routeTimes)){
    const count=allReservations.filter(r=>r.date?.startsWith(selectedDate)&&r.route===id&&r.status!=='已取消').length;
    html+=`<div class="time-slot-btn" onclick="selectTimeSlot('${id}',event)">
      <div class="route-time">${id} | ${info.time}</div>
      <div class="time-slot-info">${info.direction}</div>
      <div class="reservation-count">${count} 人預約</div>
    </div>`;
  }
  container.innerHTML=html;
  document.getElementById('timeSlotsSection').style.display='block';
  document.getElementById('passengerSection').style.display='none';
}

async function selectTimeSlot(id,event){
  selectedTimeSlot=id;
  document.querySelectorAll('.time-slot-btn').forEach(b=>b.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  showPassengerList();
}

function showPassengerList(){
  const list=document.getElementById('passenger-list');
  const info=document.getElementById('selected-info');
  info.textContent=`${selectedDate} ${selectedTimeSlot} | ${routeTimes[selectedTimeSlot].time} ${routeTimes[selectedTimeSlot].direction}`;
  const resList=allReservations.filter(r=>r.date?.startsWith(selectedDate)&&r.route===selectedTimeSlot&&r.status!=='已取消');
  if(resList.length===0){list.innerHTML='<div class="no-data">此時段暫無預約</div>';return;}
  
  const today = new Date();
  const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
  
  let html='';
  resList.forEach(r=>{
    const isCheckedIn=r.checkinStatus==='Y';
    const reservationDate = r.date ? r.date.split('T')[0] : '';
    const isExpired = reservationDate < todayStr;
    
    let actionHtml = '';
    if(isCheckedIn){
      actionHtml = '<div class="checked-in">✅ 已核銷</div>';
    }else if(isExpired){
      actionHtml = `<button class="checkin-btn" style="background:#ccc;cursor:not-allowed;" disabled title="過期預約無法核銷">❌ 已過期</button>`;
    }else{
      actionHtml = `<button class="checkin-btn" onclick="confirmCheckin('${r.id}')">✅ 核銷</button>`;
    }
    
    html+=`
      <div class="passenger-card">
        <div class="passenger-main">
          <div class="passenger-name">${r.name}</div>
          <div class="passenger-info">
            <div>學號：${r.studentId||'未提供'}</div>
            <div>系所：${r.department||'未提供'}</div>
            <div>電話：${r.phone||'未提供'}</div>
            <div>上車：${r.fromStop} → 下車：${r.toStop}</div>
          </div>
        </div>
        <div class="card-actions">
          ${actionHtml}
        </div>
      </div>`;
  });
  list.innerHTML=html;
  document.getElementById('passengerSection').style.display='block';
}

async function confirmCheckin(id){
  if(!confirm('確認乘客已搭乘並核銷？'))return;
  try{
    const res=await fetch('https://script.google.com/macros/s/AKfycbwE2fHEnioUohdNqwVzPxB3fUJmTNAYSYi5u2vvzQzzQUbhV7XVkfZwd1aoBwuADdgj_Q/exec?mode=confirmCheckin&id=' + encodeURIComponent(id));
    const result=await res.json();
    if(result.status==='success'){
      alert('✅ 已完成核銷，J欄已更新為Y');
      const target=allReservations.find(r=>r.id===id);
      if(target){target.checkinStatus='Y';}
      showPassengerList();
    }else{
      alert('❌ 核銷失敗：' + (result.message || '請稍後再試'));
    }
  }catch(e){
    alert('❌ 請求失敗：' + e.message);
  }
}

async function showPreviousMonth(){
  currentMonth--;
  if(currentMonth<0){
    currentMonth=11;
    currentYear--;
  }
  await loadAllReservations();
  renderCalendar();
}

async function showNextMonth(){
  currentMonth++;
  if(currentMonth>11){
    currentMonth=0;
    currentYear++;
  }
  await loadAllReservations();
  renderCalendar();
}
</script>
</body>
</html>
