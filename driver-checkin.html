<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Š - å¸æ©Ÿæ ¸éŠ·ç³»çµ± v3.7.2</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Microsoft JhengHei',sans-serif;}
body{background:#f5f6f7;color:#333;line-height:1.6;width:100vw;overflow-x:hidden;}
.container{width:100%;margin:0;padding:12px;box-sizing:border-box;}
.header{background:#3c8050;color:white;padding:15px;border-radius:12px;margin-bottom:15px;text-align:center;}
.header h1{font-size:22px;margin-bottom:5px;}
.header p{font-size:13px;opacity:0.9;}
.calendar-section,.route-map-section,.checkin-section{background:white;border-radius:12px;padding:15px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.calendar-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;gap:8px;}
.calendar-nav button{background:#3c8050;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;}
.calendar-nav button:hover{background:#2f6842;}
.calendar-title{text-align:center;font-size:16px;font-weight:bold;flex:1;white-space:nowrap;}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.day-header{padding:8px 0;font-weight:bold;background:#27ACB2;color:white;text-align:center;border-radius:4px;font-size:11px;}
.day-cell{padding:8px 0;background:white;border:1px solid #e0e0e0;text-align:center;border-radius:6px;cursor:pointer;transition:all .2s;font-size:12px;aspect-ratio:1;}
.day-cell:hover{background:#eaf5ea;border-color:#3c8050;}
.day-cell.past{background:#f5f5f5;color:#ccc;cursor:not-allowed;}
.day-cell.selected{background:#3c8050;color:white;font-weight:bold;}
.day-cell.other-month{color:#ccc;background:#f8f9fa;}
.checkin-section h2{margin-bottom:12px;color:#333;border-bottom:2px solid #3c8050;padding-bottom:8px;font-size:16px;}
.reservation-table{width:100%;border-collapse:collapse;}
.table-header th{background:#3c8050;color:white;padding:8px;font-size:12px;border:1px solid #2f6842;}
.table-row td{padding:8px;border:1px solid #ddd;font-size:12px;text-align:center;}
.checkin-btn{background:#3c8050;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:11px;}
.checkin-btn:hover{background:#2f6842;}
.checkin-btn:disabled{background:#ccc;cursor:not-allowed;}
.no-data{text-align:center;color:#999;padding:20px;}
.loading{text-align:center;color:#3c8050;padding:20px;}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸšŒ ç©¿å±±ç”²å°ˆè»Šæ ¸éŠ·ç³»çµ±</h1>
    <p>å¸æ©Ÿç°½åˆ°æ ¸éŠ·ä½œæ¥­</p>
  </div>

  <div class="calendar-section">
    <div class="calendar-nav">
      <button id="prev-month">â—€</button>
      <h2 id="current-month" class="calendar-title"></h2>
      <button id="next-month">â–¶</button>
      <button id="toggle-calendar">æ”¶åˆ</button>
    </div>
    <div class="calendar-grid" id="calendar-grid" style="display:none;"></div>
  </div>

  <div id="checkin-section" class="checkin-section">
    <h2 id="checkin-title">å…¨éƒ¨é ç´„åˆ—è¡¨</h2>
    <div id="loadingMsg" class="loading hidden">ğŸš è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
    <table class="reservation-table">
      <thead class="table-header">
        <tr>
          <th>æ—¥æœŸ</th><th>ç­æ¬¡</th><th>å§“å</th><th>ä¸Šè»Š</th><th>ä¸‹è»Š</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="reservation-list"></tbody>
    </table>
  </div>
</div>

<script>
const WORKER_URL='https://delicate-math-7e61.fangwl591021.workers.dev/';
const GAS_URL='https://script.google.com/macros/s/AKfycbza2qFcrQt1PS6Y4p4u2gSXovvFxWecEjjIh5ov1cIk_65zgdFJA0xjVuS3qr7WvlgAzA/exec';

let allReservations=[];
let currentDate=new Date();
let currentMonth=currentDate.getMonth();
let currentYear=currentDate.getFullYear();
let selectedDate=null;

document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('prev-month').onclick=()=>changeMonth(-1);
  document.getElementById('next-month').onclick=()=>changeMonth(1);
  document.getElementById('toggle-calendar').onclick=toggleCalendar;
  initializeSystem();
});

async function initializeSystem(){
  document.getElementById('loadingMsg').classList.remove('hidden');
  await loadAllReservations();
  document.getElementById('loadingMsg').classList.add('hidden');
  renderCalendar();
  showTodayReservations();
}

async function loadAllReservations(){
  try{
    const urlParams=new URLSearchParams(window.location.search);
    const adminId=urlParams.get('admin')||'';
    const res=await fetch(`${WORKER_URL}?mode=reservations&userId=${adminId||'all'}`);
    const data=await res.json();
    if(data.status==='success' && Array.isArray(data.reservations)){
      allReservations=data.reservations.map((r,i)=>({
        id:String(r.id||i+1),
        date:r.date||r.æ—¥æœŸ||'',
        route:r.route||r.ç­æ¬¡||'-',
        name:r.name||r.å§“å||'-',
        fromStop:r.fromStop||r.E||'æœªæä¾›',
        toStop:r.toStop||r.F||'æœªæä¾›',
        checkin:r.checkinStatus||r.J||'',
        status:r.status||'å·²é ç´„'
      }));
    }else{
      allReservations=[];
    }
  }catch(e){
    console.error('è³‡æ–™è¼‰å…¥å¤±æ•—:',e);
    allReservations=[];
  }
}

function renderCalendar(){
  const grid=document.getElementById('calendar-grid');
  grid.innerHTML='';
  ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d=>{
    const h=document.createElement('div');
    h.className='day-header';
    h.textContent=d;
    grid.appendChild(h);
  });
  const first=new Date(currentYear,currentMonth,1);
  const last=new Date(currentYear,currentMonth+1,0);
  const offset=first.getDay();
  const today=formatDate(new Date());
  for(let i=0;i<offset;i++){const d=document.createElement('div');d.className='day-cell other-month';grid.appendChild(d);}
  for(let i=1;i<=last.getDate();i++){
    const d=document.createElement('div');
    const dateStr=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
    d.className='day-cell';
    if(dateStr===selectedDate)d.classList.add('selected');
    if(dateStr<today)d.classList.add('past');else d.onclick=()=>selectDate(dateStr);
    d.textContent=i;
    grid.appendChild(d);
  }
  document.getElementById('current-month').textContent=`${currentYear}å¹´${currentMonth+1}æœˆ`;
}

function selectDate(date){
  selectedDate=date;
  renderCalendar();
  showReservationsByDate(date);
}

function showTodayReservations(){
  const today=formatDate(new Date());
  showReservationsByDate(today);
}

function showReservationsByDate(date){
  const tbody=document.getElementById('reservation-list');
  tbody.innerHTML='';
  const filtered=allReservations.filter(r=>r.date.startsWith(date));
  if(filtered.length===0){
    tbody.innerHTML=`<tr><td colspan="7" class="no-data">æ­¤æ—¥æœŸç„¡é ç´„</td></tr>`;
    document.getElementById('checkin-title').textContent=`${date} ç„¡é ç´„`;
    return;
  }
  const routes=['A1','B1','A2','B2'];
  filtered.sort((a,b)=>routes.indexOf(a.route)-routes.indexOf(b.route));
  filtered.forEach(r=>{
    const checked=r.checkin==='Y';
    const status=checked?'å·²æ­ä¹˜':r.status==='å·²å–æ¶ˆ'?'å·²å–æ¶ˆ':'å·²é ç´„';
    const tr=document.createElement('tr');
    tr.className='table-row';
    tr.innerHTML=`
      <td>${r.date}</td>
      <td>${r.route}</td>
      <td>${r.name}</td>
      <td>${r.fromStop}</td>
      <td>${r.toStop}</td>
      <td>${status}</td>
      <td>${checked?'<button class="checkin-btn" disabled>âœ…</button>':`<button class="checkin-btn" onclick="confirmCheckin('${r.id}')">æ ¸éŠ·</button>`}</td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('checkin-title').textContent=`${date} é ç´„ (${filtered.length} ç­†)`;
}

async function confirmCheckin(id){
  if(!confirm('ç¢ºèªæ­¤ä¹˜å®¢å·²æ ¸éŠ·ï¼Ÿ'))return;
  try{
    const res=await fetch(`${GAS_URL}?mode=confirmCheckin&id=${encodeURIComponent(id)}`);
    const data=await res.json();
    if(data.status==='success'){
      alert('âœ… æ ¸éŠ·æˆåŠŸ');
      const target=allReservations.find(r=>r.id===id);
      if(target)target.checkin='Y';
      selectedDate?showReservationsByDate(selectedDate):showTodayReservations();
    }else{
      alert('âŒ æ ¸éŠ·å¤±æ•—: '+data.message);
    }
  }catch(e){alert('âŒ éŒ¯èª¤:'+e.message);}
}

function changeMonth(d){
  currentMonth+=d;
  if(currentMonth<0){currentMonth=11;currentYear--;}
  else if(currentMonth>11){currentMonth=0;currentYear++;}
  renderCalendar();
}

function toggleCalendar(){
  const grid=document.getElementById('calendar-grid');
  const btn=document.getElementById('toggle-calendar');
  const isHidden=grid.style.display==='none';
  grid.style.display=isHidden?'grid':'none';
  btn.textContent=isHidden?'æ”¶åˆ':'å±•é–‹';
}

function formatDate(date){
  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}
</script>
</body>
</html>
