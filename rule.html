<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>穿山甲專車規則設定 rule.html v2.3</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body {
  font-family: "Noto Sans TC", system-ui, sans-serif;
  background: #f8fafc;
  margin: 0;
  padding: 0;
}
.card {
  background: white;
  border-radius: 16px;
  padding: 24px;
  margin: 24px auto;
  max-width: 480px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
input, select {
  width: 100%;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 16px;
}
button {
  width: 100%;
  background: #3c8050;
  color: white;
  padding: 12px;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}
button:hover { background: #2e6b40; }
#userInfo { text-align:center; margin:16px 0; }
#userPicture { width:60px; height:60px; border-radius:50%; border:2px solid #3c8050; margin-bottom:8px; }
#errorMsg { color:#b91c1c; font-weight:600; text-align:center; margin-top:8px; }
</style>
</head>
<body>

<div class="card">
  <h2 class="text-2xl font-bold text-green-700 mb-4 text-center">⚙️ 穿山甲專車設定管理</h2>
  
  <div id="userInfo">
    <img id="userPicture" src="https://via.placeholder.com/60" alt="">
    <div id="userName" class="font-bold text-lg">登入中...</div>
    <div id="errorMsg"></div>
  </div>

  <div id="formArea" style="display:none;">
    <label>每班次搭載人數上限</label>
    <input type="number" id="seatLimit" min="1" max="20">
    <label>未核銷達幾次後封鎖</label>
    <input type="number" id="maxNoShow" min="1" max="10">
    <label>封鎖週數</label>
    <input type="number" id="banWeeks" min="1" max="12">
    <label>預約模式</label>
    <select id="tripMode">
      <option value="single">單程</option>
      <option value="roundtrip">來回</option>
    </select>
    <p id="lastUpdate" class="text-sm text-gray-500 mb-3"></p>
    <button id="saveBtn">💾 儲存設定</button>
  </div>

  <div id="loadingText" class="text-center text-gray-500 mt-4">⏳ 初始化中，請稍候...</div>
</div>

<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const LIFF_ID = '2006590746-wgL4l54z'; // ←請確認為實際 LIFF ID

document.addEventListener('DOMContentLoaded', () => safeInitLIFF(0));

/* === 🟢 自動重試 LIFF 初始化 === */
async function safeInitLIFF(retry = 0){
  try{
    console.log(`🚀 LIFF 初始化中...（第 ${retry+1} 次）`);
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      console.warn("⚠️ 尚未登入，重新導向登入中...");
      liff.login({ redirectUri: window.location.href });
      return;
    }

    const profile = await liff.getProfile();
    document.getElementById('userName').textContent = profile.displayName;
    document.getElementById('userPicture').src = profile.pictureUrl;
    document.getElementById('loadingText').textContent = '🔄 載入設定中...';
    await loadRules();
    document.getElementById('saveBtn').addEventListener('click', saveRules);

  }catch(err){
    console.error("❌ LIFF 初始化錯誤:", err.message);
    if (retry < 2) {
      document.getElementById('loadingText').textContent = `⚠️ 初始化失敗，5 秒後重試 (${retry+1}/3)...`;
      setTimeout(() => safeInitLIFF(retry + 1), 5000);
    } else {
      enterTestMode(err.message);
    }
  }
}

/* === 🧰 測試模式啟動 === */
function enterTestMode(msg){
  console.warn("🧪 啟用測試模式:", msg);
  document.getElementById('userName').textContent = '測試模式 (LIFF失敗)';
  document.getElementById('userPicture').src = 'https://via.placeholder.com/60?text=Test';
  document.getElementById('errorMsg').textContent = `⚠️ 初始化錯誤：${msg}`;
  document.getElementById('loadingText').style.display = 'none';
  document.getElementById('formArea').style.display = 'block';
  loadRules(); // 即使在測試模式下也可載入設定
}

/* === 📥 載入設定 === */
async function loadRules(){
  try{
    const res = await fetch(WORKER_URL + '?mode=getRules');
    const json = await res.json();
    const r = json.current || {};
    document.getElementById('seatLimit').value = r.seatLimit || 6;
    document.getElementById('maxNoShow').value = r.maxNoShow || 3;
    document.getElementById('banWeeks').value = r.banWeeks || 2;
    document.getElementById('tripMode').value = r.tripMode || 'single';
    document.getElementById('lastUpdate').textContent = '最後更新：' + (r.lastUpdate || '無');
    document.getElementById('loadingText').style.display = 'none';
    document.getElementById('formArea').style.display = 'block';
  }catch(e){
    document.getElementById('loadingText').textContent = '❌ 載入失敗，請稍後再試';
  }
}

/* === 💾 儲存設定 === */
async function saveRules(){
  const body = {
    seatLimit: parseInt(document.getElementById('seatLimit').value),
    maxNoShow: parseInt(document.getElementById('maxNoShow').value),
    banWeeks: parseInt(document.getElementById('banWeeks').value),
    tripMode: document.getElementById('tripMode').value,
    lastUpdate: new Date().toISOString()
  };
  try{
    const res = await fetch(WORKER_URL + '?mode=updateRules',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    const json = await res.json();
    if(json.status==='success'){
      alert('✅ 規則已更新');
    } else {
      alert('❌ 更新失敗：' + json.message);
    }
    loadRules();
  }catch(e){
    alert('❌ 更新錯誤：' + e.message);
  }
}
</script>
</body>
</html>
