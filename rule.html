<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç©¿å±±ç”²å°ˆè»Šè¨­å®šç®¡ç† v2.7</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body {
  font-family: "Noto Sans TC", system-ui, sans-serif;
  background: #f8fafc;
  margin: 0;
  padding: 0;
}
.card {
  background: white;
  border-radius: 16px;
  padding: 24px;
  margin: 24px auto;
  max-width: 560px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
input, select {
  width: 100%;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 16px;
}
button {
  width: 100%;
  background: #3c8050;
  color: white;
  padding: 12px;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}
button:hover { background: #2e6b40; }
#userInfo { text-align:center; margin:16px 0; }
#userPicture { width:60px; height:60px; border-radius:50%; border:2px solid #3c8050; margin-bottom:8px; }
.toast {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: #16a34a; color: white; padding: 12px 24px;
  border-radius: 8px; font-weight: bold; display: none;
  animation: fadeInOut 3s ease forwards;
}
@keyframes fadeInOut {
  0% { opacity: 0; transform: translate(-50%, 20px); }
  10%, 90% { opacity: 1; transform: translate(-50%, 0); }
  100% { opacity: 0; transform: translate(-50%, 20px); }
}
pre {
  background: #f1f5f9;
  color: #1e293b;
  padding: 12px;
  border-radius: 8px;
  font-size: 13px;
  overflow-x: auto;
}
</style>
</head>
<body>

<div class="card">
  <h2 class="text-2xl font-bold text-green-700 mb-4 text-center">âš™ï¸ ç©¿å±±ç”²å°ˆè»Šè¦å‰‡è¨­å®š</h2>

  <div id="status" class="text-center text-sm text-gray-500 mb-2">è¼‰å…¥ä¸­...</div>

  <div id="userInfo">
    <img id="userPicture" src="https://via.placeholder.com/60" alt="User">
    <div id="userName" class="font-bold text-lg">ç™»å…¥ä¸­...</div>
    <div id="userIdDisplay" class="text-xs text-gray-500 mt-1"></div>
  </div>

  <div id="formArea" style="display:none;">
    <label>æ¯ç­æ¬¡æ­è¼‰äººæ•¸ä¸Šé™</label>
    <input type="number" id="seatLimit" min="1" max="20">

    <label>æœªæ ¸éŠ·é”å¹¾æ¬¡å¾Œå°é–</label>
    <input type="number" id="maxNoShow" min="1" max="10">

    <label>å°é–é€±æ•¸</label>
    <input type="number" id="banWeeks" min="1" max="12">

    <label>é ç´„æ¨¡å¼</label>
    <select id="tripMode">
      <option value="single">å–®ç¨‹</option>
      <option value="roundtrip">ä¾†å›</option>
    </select>

    <p id="lastUpdate" class="text-sm text-gray-500 mb-3"></p>

    <button id="saveBtn">ğŸ’¾ å„²å­˜è¨­å®š</button>
    <button id="debugBtn" class="mt-2 bg-gray-600 hover:bg-gray-700">ğŸ§© æª¢è¦–å®Œæ•´è¨­å®š</button>

    <div id="metaArea" class="mt-4 text-sm text-gray-600 hidden">
      <h3 class="font-semibold mb-1 text-green-700">è¨­å®šæ‘˜è¦</h3>
      <pre id="metaText">{}</pre>
    </div>
  </div>

  <div id="loadingText" class="text-center text-gray-500 mt-4">â³ è¼‰å…¥ä¸­...</div>
</div>

<div id="toast" class="toast">âœ… å·²æˆåŠŸæ›´æ–°è¨­å®šï¼</div>

<script>
const CONFIG = {
  WORKER_URL: 'https://delicate-math-7e61.fangwl591021.workers.dev/',
  LIFF_ID: '2006590746-gpLmx9md',
  MASTER_ADMINS: [
    'U84b2e88d818b98575f45fcf14a380517',
    'Ue7a07fe317565389fbf4479172088f87'
  ]
};

let currentUserId = 'test-user';
let isAdmin = false;

document.addEventListener('DOMContentLoaded', init);

async function init(){
  await initLINE();
  await loadRules();
  document.getElementById('saveBtn').addEventListener('click', saveRules);
  document.getElementById('debugBtn').addEventListener('click', debugRules);
}

// === åˆå§‹åŒ– LINE ===
async function initLINE(){
  try{
    await liff.init({ liffId: CONFIG.LIFF_ID });
    if(!liff.isLoggedIn()){ liff.login(); return; }
    const profile = await liff.getProfile();
    currentUserId = profile.userId;
    document.getElementById('userName').textContent = profile.displayName;
    document.getElementById('userPicture').src = profile.pictureUrl;
    document.getElementById('userIdDisplay').textContent = 'ID: ' + currentUserId;
    document.getElementById('status').textContent = "ğŸ”— LINE ç™»å…¥æ¨¡å¼";
    isAdmin = CONFIG.MASTER_ADMINS.includes(currentUserId);
    if(!isAdmin) {
      document.getElementById('saveBtn').disabled = true;
      document.getElementById('saveBtn').style.background = '#999';
      document.getElementById('status').textContent = "ğŸš« éç®¡ç†å“¡ï¼Œåƒ…å¯æª¢è¦–è¨­å®š";
    }
  }catch(e){
    console.warn("âš ï¸ LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œå•Ÿå‹•æ¸¬è©¦æ¨¡å¼", e);
    currentUserId = 'test-user';
    isAdmin = true;
    document.getElementById('status').textContent = "ğŸ§ª æ¸¬è©¦æ¨¡å¼ï¼ˆç®¡ç†å“¡é è¨­é–‹å•Ÿï¼‰";
    document.getElementById('userName').textContent = 'æ¸¬è©¦ç”¨æˆ¶';
    document.getElementById('userIdDisplay').textContent = 'ID: test-user';
  }
}

// === è¼‰å…¥è¨­å®š ===
async function loadRules(){
  try{
    const res = await fetch(CONFIG.WORKER_URL + '?mode=getRules');
    const json = await res.json();
    const r = json.current || {};

    document.getElementById('seatLimit').value = r.seatLimit || 6;
    document.getElementById('maxNoShow').value = r.maxNoShow || 3;
    document.getElementById('banWeeks').value = r.banWeeks || 2;
    document.getElementById('tripMode').value = r.tripMode || 'single';
    document.getElementById('lastUpdate').textContent =
      `æœ€å¾Œæ›´æ–°ï¼š${r.lastUpdate || 'ç„¡'}ã€€æ›´æ–°è€…ï¼š${r.updatedBy || 'æœªçŸ¥'}`;

    document.getElementById('metaText').textContent = JSON.stringify(r.meta || {}, null, 2);
    document.getElementById('metaArea').classList.remove('hidden');

    document.getElementById('loadingText').style.display = 'none';
    document.getElementById('formArea').style.display = 'block';
  }catch(e){
    console.error('âŒ è¼‰å…¥è¦å‰‡å¤±æ•—', e);
    document.getElementById('loadingText').textContent = 'âŒ ç„¡æ³•è¼‰å…¥è¦å‰‡ï¼Œè«‹ç¨å¾Œé‡è©¦';
  }
}

// === å„²å­˜è¨­å®š ===
async function saveRules(){
  if(!isAdmin){
    alert('ğŸš« æ‚¨æ²’æœ‰ä¿®æ”¹æ¬Šé™');
    return;
  }

  const body = {
    seatLimit: parseInt(document.getElementById('seatLimit').value),
    maxNoShow: parseInt(document.getElementById('maxNoShow').value),
    banWeeks: parseInt(document.getElementById('banWeeks').value),
    tripMode: document.getElementById('tripMode').value,
    updatedBy: currentUserId,
    lastUpdate: new Date().toISOString()
  };

  try{
    const res = await fetch(CONFIG.WORKER_URL + '?mode=updateRules', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });
    const json = await res.json();
    if(json.status === 'success'){
      showToast('âœ… å·²æ›´æ–°è¨­å®š');
      await loadRules();
    }else{
      alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + (json.message || 'æœªçŸ¥éŒ¯èª¤'));
    }
  }catch(e){
    alert('âŒ æ›´æ–°éŒ¯èª¤ï¼š' + e.message);
  }
}<script>
async function saveRules(){
  if(!isAdmin){
    alert('ğŸš« æ‚¨æ²’æœ‰ä¿®æ”¹æ¬Šé™');
    return;
  }

  const body = {
    mode: 'updateRules',   // âœ… æ–°å¢ï¼šæ˜ç¢ºæ¨™ç¤ºæ›´æ–°æ¨¡å¼
    seatLimit: parseInt(document.getElementById('seatLimit').value),
    maxNoShow: parseInt(document.getElementById('maxNoShow').value),
    banWeeks: parseInt(document.getElementById('banWeeks').value),
    tripMode: document.getElementById('tripMode').value,
    updatedBy: currentUserId,
    lastUpdate: new Date().toISOString()
  };

  try{
    const res = await fetch(CONFIG.WORKER_URL + '?mode=updateRules', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });
    const json = await res.json();
    if(json.status === 'success'){
      showToast('âœ… å·²æ›´æ–°è¨­å®š');
      await loadRules();
    }else{
      alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + (json.message || 'æœªçŸ¥éŒ¯èª¤'));
      console.log('GASå›å‚³ï¼š', json);
    }
  }catch(e){
    alert('âŒ æ›´æ–°éŒ¯èª¤ï¼š' + e.message);
  }
}
</script>


// === é™¤éŒ¯åŠŸèƒ½ï¼šé¡¯ç¤ºå®Œæ•´ JSON ===
async function debugRules(){
  try{
    const res = await fetch(CONFIG.WORKER_URL + '?mode=getRules');
    const json = await res.json();
    alert('ğŸ” è¦å‰‡å…§å®¹ï¼š\n' + JSON.stringify(json.current || {}, null, 2));
  }catch(e){
    alert('è®€å–è¦å‰‡å¤±æ•—: ' + e.message);
  }
}

// === æµ®å‹•æç¤º ===
function showToast(msg){
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.style.display = 'block';
  setTimeout(()=>toast.style.display='none', 2800);
}
</script>
</body>
</html>
