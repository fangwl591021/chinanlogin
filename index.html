<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æš¨å¤§æ¥é§è»Šé ç´„ç³»çµ± - ç™»å…¥</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
      <!-- Logo å€åŸŸ -->
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
          </svg>
        </div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">æš¨å¤§æ¥é§è»Šé ç´„</h1>
        <p class="text-gray-600">è«‹ä½¿ç”¨ LINE å¸³è™Ÿç™»å…¥</p>
      </div>

      <!-- ç™»å…¥æŒ‰éˆ• -->
      <button 
        onclick="lineLogin()"
        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-xl transition duration-200 flex items-center justify-center gap-3 shadow-lg mb-6"
      >
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
        </svg>
        ä½¿ç”¨ LINE ç™»å…¥
      </button>

      <!-- èªªæ˜æ–‡å­— -->
      <div class="text-center text-sm text-gray-500 space-y-2">
        <p>ğŸšŒ æä¾›åŸ”é‡Œç¸½ç«™ â‡„ æš¨å¤§æ ¡å€æ¥é§æœå‹™</p>
        <p>â° æ¯æ—¥ 22:00-24:00 ç‡Ÿé‹</p>
        <p>ğŸ‘¥ æ¯è»Šé™é¡ 6 äºº</p>
      </div>

      <!-- è»Šæ¬¡è³‡è¨Š -->
      <div class="mt-6 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4">
        <p class="text-xs font-semibold text-gray-700 mb-2">ğŸ“ ç‡Ÿé‹è»Šæ¬¡</p>
        <div class="text-xs text-gray-600 space-y-1">
          <p>A1ï½œ22:00-22:30 æš¨å¤§â†’åŸ”é‡Œç¸½ç«™</p>
          <p>B1ï½œ22:30-23:00 åŸ”é‡Œç¸½ç«™â†’æš¨å¤§</p>
          <p>A2ï½œ23:00-23:30 æš¨å¤§â†’åŸ”é‡Œç¸½ç«™</p>
          <p>B2ï½œ23:30-24:00 åŸ”é‡Œç¸½ç«™â†’æš¨å¤§</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // âš ï¸ é…ç½®
    const CONFIG = {
      LINE_GROUP_ID: 'C596050d1193b9b930ac25469c61ba12a',
      LIFF_ID: '2008231249-yv8294Jp',
      SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwN2PoJQBvmkzo1E5IdsbQSLCTg5y4QxshYfab9o2M-GfMl1YC_hO8RbHeVH8PcpCRI-w/exec'
    };

    // ç­‰å¾… LIFF SDK è¼‰å…¥
    let liffReady = false;

    // LINE Login
    function lineLogin() {
      console.log('é»æ“Šç™»å…¥æŒ‰éˆ•');
      
      // æª¢æŸ¥ LIFF SDK æ˜¯å¦å·²è¼‰å…¥
      if (typeof liff === 'undefined') {
        console.log('LIFF SDK å°šæœªè¼‰å…¥ï¼Œç­‰å¾…ä¸­...');
        alert('æ­£åœ¨è¼‰å…¥ LINE Login SDKï¼Œè«‹ç¨å€™...');
        
        // ç­‰å¾… SDK è¼‰å…¥å¾Œå†è©¦
        setTimeout(() => {
          if (typeof liff !== 'undefined') {
            initializeLIFF();
          } else {
            alert('âŒ LIFF SDK è¼‰å…¥å¤±æ•—\n\nè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š\næˆ–åˆ‡æ›åˆ°æ¸¬è©¦æ¨¡å¼');
            window.location.href = 'main.html?test=true';
          }
        }, 1000);
        return;
      }
      
      initializeLIFF();
    }

    // åˆå§‹åŒ– LIFF
    async function initializeLIFF() {
      try {
        console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ– LIFF...');
        console.log('LIFF ID:', CONFIG.LIFF_ID);
        
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        console.log('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ');
        console.log('ğŸ“± æ˜¯å¦åœ¨ LINE ä¸­é–‹å•Ÿ:', liff.isInClient());
        console.log('ğŸ” æ˜¯å¦å·²ç™»å…¥:', liff.isLoggedIn());
        
        if (!liff.isLoggedIn()) {
          console.log('â¡ï¸ å°å‘ LINE ç™»å…¥é é¢...');
          liff.login({ redirectUri: window.location.href });
        } else {
          console.log('âœ… å·²ç™»å…¥ï¼Œå–å¾—ç”¨æˆ¶è³‡æ–™...');
          
          // å–å¾—ç”¨æˆ¶è³‡æ–™
          const profile = await liff.getProfile();
          console.log('ğŸ‘¤ ç”¨æˆ¶è³‡æ–™:', profile);
          
          // å„²å­˜ç”¨æˆ¶è³‡æ–™
          const userData = {
            userId: profile.userId,
            displayName: profile.displayName,
            pictureUrl: profile.pictureUrl,
            statusMessage: profile.statusMessage || '',
            loginTime: new Date().toISOString()
          };
          
          sessionStorage.setItem('userData', JSON.stringify(userData));
          console.log('ğŸ’¾ ç”¨æˆ¶è³‡æ–™å·²å„²å­˜åˆ° sessionStorage');
          
          // å¯«å…¥ Google Sheets
          await saveUserToSheet(userData);
          
          // è·³è½‰åˆ°é ç´„é é¢
          console.log('â¡ï¸ è·³è½‰åˆ°é ç´„é é¢');
          window.location.href = 'main.html';
        }
      } catch (error) {
        console.error('âŒ LIFF åˆå§‹åŒ–å¤±æ•—:', error);
        
        let errorMsg = 'ç™»å…¥å¤±æ•—\n\n';
        
        if (error.message && error.message.includes('channel not found')) {
          errorMsg += 'âŒ æ‰¾ä¸åˆ° LIFF Channel\n\n';
          errorMsg += 'å¯èƒ½åŸå› ï¼š\n';
          errorMsg += '1. LIFF ID ä¸æ­£ç¢º\n';
          errorMsg += '2. LIFF app å·²è¢«åˆªé™¤\n';
          errorMsg += '3. Channel æœªå•Ÿç”¨\n\n';
          errorMsg += 'ç›®å‰ LIFF ID: ' + CONFIG.LIFF_ID + '\n\n';
        } else if (error.message && error.message.includes('403')) {
          errorMsg += 'âŒ æ¬Šé™éŒ¯èª¤\n\n';
          errorMsg += 'LIFF app çš„ Endpoint URL å¯èƒ½è¨­å®šéŒ¯èª¤\n\n';
          errorMsg += 'è«‹ç¢ºèª Endpoint URL è¨­å®šç‚ºï¼š\n' + window.location.origin + '/\n\n';
        } else {
          errorMsg += 'éŒ¯èª¤è¨Šæ¯ï¼š\n' + (error.message || error) + '\n\n';
        }
        
        errorMsg += 'å°‡åˆ‡æ›åˆ°æ¸¬è©¦æ¨¡å¼...';
        alert(errorMsg);
        window.location.href = 'main.html?test=true';
      }
    }

    // å„²å­˜ç”¨æˆ¶è³‡æ–™åˆ° Google Sheets
    async function saveUserToSheet(userData) {
      try {
        console.log('ğŸ“¤ æ­£åœ¨å„²å­˜ç”¨æˆ¶è³‡æ–™åˆ° Google Sheets...');
        
        const response = await fetch(CONFIG.SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'saveUser',
            data: userData
          })
        });
        
        console.log('âœ… ç”¨æˆ¶è³‡æ–™å·²ç™¼é€');
      } catch (error) {
        console.error('âŒ å„²å­˜ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
      }
    }

    // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
    window.addEventListener('load', function() {
      console.log('ğŸ“„ é é¢è¼‰å…¥å®Œæˆ');
      
      const userData = sessionStorage.getItem('userData');
      if (userData) {
        console.log('âœ… åµæ¸¬åˆ°å·²ç™»å…¥ï¼Œè·³è½‰åˆ°é ç´„é é¢');
        window.location.href = 'main.html';
      } else {
        console.log('â„¹ï¸ å°šæœªç™»å…¥');
      }
    });
  </script>

  <!-- âš ï¸ é‡è¦ï¼šLIFF SDK å¿…é ˆæ”¾åœ¨æœ€å¾Œè¼‰å…¥ -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    // åˆå§‹åŒ– LIFF
    async function initializeLIFF() {
      try {
        console.log('æ­£åœ¨åˆå§‹åŒ– LIFF...', CONFIG.LIFF_ID);
        
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');
        console.log('æ˜¯å¦åœ¨ LINE ä¸­é–‹å•Ÿ:', liff.isInClient());
        console.log('æ˜¯å¦å·²ç™»å…¥:', liff.isLoggedIn());
        
        if (!liff.isLoggedIn()) {
          console.log('å°šæœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢...');
          liff.login({ redirectUri: window.location.href });
        } else {
          // å–å¾—ç”¨æˆ¶è³‡æ–™
          const profile = await liff.getProfile();
          console.log('ç”¨æˆ¶è³‡æ–™:', profile);
          
          // å„²å­˜ç”¨æˆ¶è³‡æ–™
          const userData = {
            userId: profile.userId,
            displayName: profile.displayName,
            pictureUrl: profile.pictureUrl,
            statusMessage: profile.statusMessage || '',
            loginTime: new Date().toISOString()
          };
          
          sessionStorage.setItem('userData', JSON.stringify(userData));
          
          // å¯«å…¥ Google Sheets
          await saveUserToSheet(userData);
          
          // è·³è½‰åˆ°é ç´„é é¢
          console.log('ç™»å…¥æˆåŠŸï¼Œè·³è½‰åˆ°é ç´„é é¢');
          window.location.href = 'main.html';
        }
      } catch (error) {
        console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
        
        let errorMsg = 'LIFF åˆå§‹åŒ–å¤±æ•—\n\n';
        
        if (error.message.includes('channel not found')) {
          errorMsg += 'âŒ LIFF ID ä¸æ­£ç¢º\n\n';
          errorMsg += 'è«‹æª¢æŸ¥ï¼š\n';
          errorMsg += '1. LIFF ID æ ¼å¼æ˜¯å¦æ­£ç¢º\n';
          errorMsg += '   (æ ¼å¼: 1234567890-abcdefgh)\n\n';
          errorMsg += '2. LIFF app æ˜¯å¦å·²å»ºç«‹\n\n';
          errorMsg += '3. LIFF app çš„ Endpoint URL æ˜¯å¦è¨­å®šç‚ºæ­¤ç¶²ç«™ç¶²å€\n\n';
          errorMsg += 'ç›®å‰ LIFF ID: ' + CONFIG.LIFF_ID;
        } else if (error.message.includes('403')) {
          errorMsg += 'âŒ æ¬Šé™éŒ¯èª¤\n\n';
          errorMsg += 'LIFF app çš„ Channel å¯èƒ½æœªå•Ÿç”¨';
        } else {
          errorMsg += 'éŒ¯èª¤è¨Šæ¯: ' + error.message;
        }
        
        alert(errorMsg + '\n\nå°‡åˆ‡æ›åˆ°æ¸¬è©¦æ¨¡å¼...');
        window.location.href = 'main.html?test=true';
      }
    }
          await saveUserToSheet(userData);
          
          // è·³è½‰åˆ°é ç´„é é¢
          window.location.href = 'main.html';
        }
      } catch (error) {
        console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
        alert('ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦');
      }
    }

    // å„²å­˜ç”¨æˆ¶è³‡æ–™åˆ° Google Sheets
    async function saveUserToSheet(userData) {
      const SCRIPT_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL'; // éœ€è¦éƒ¨ç½² Google Apps Script
      
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'saveUser',
            data: userData
          })
        });
        
        console.log('ç”¨æˆ¶è³‡æ–™å·²å„²å­˜');
      } catch (error) {
        console.error('å„²å­˜ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
      }
    }

    // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
    window.addEventListener('load', function() {
      const userData = sessionStorage.getItem('userData');
      if (userData) {
        // å·²ç™»å…¥ï¼Œç›´æ¥è·³è½‰
        window.location.href = 'main.html';
      }
    });
  </script>

  <!-- è¼‰å…¥ LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</body>
</html>
