<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ç©¿å±±ç”²å°ˆè»Šæœƒå“¡è¨»å†Š</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { background:#000; color:#fff; text-align:center; font-family:"Microsoft JhengHei"; margin:0; padding:20px; }
    h1 { color:gold; margin:24px 0; letter-spacing:1px; }
    input,select,button { width:80%; max-width:320px; margin:12px auto; display:block; padding:10px; border:none; border-radius:6px; font-size:1em; }
    input,select { background:#222; color:#fff; }
    button { background:#28a745; color:#fff; cursor:pointer; font-weight:bold; }
    #msg { margin:16px 0; font-size:1.2em; }
    .success { color:#00ff99; }
    .warning { color:#ffcc00; }
    .error { color:#ff4444; }
  </style>
</head>
<body>
  <h1>ğŸšŒ ç©¿å±±ç”²å°ˆè»Šæœƒå“¡è¨»å†Š</h1>
  <div id="msg"></div>

  <div id="form" style="display:none;">
    <input id="name" placeholder="å§“å">
    <input id="phone" placeholder="é›»è©±">
    <input id="schoolId" placeholder="å­¸è™Ÿ">
    <input id="dept" placeholder="ç§‘ç³»">
    <button id="submitBtn">é€å‡ºè¨»å†Š</button>
  </div>

<script>
const CONFIG = {
  API_URL: 'https://script.google.com/macros/s/AKfycbzFMEhToyf21Nx3ptrxcdDfKGBnoT-O8BI1gNAKfxaj7Uln5u9Yg16lzA4a5lLya4eNTw/exec',
  MAIN_URL: 'https://script.google.com/macros/s/AKfycbwfCAzgXUiLIQsVe8L_4cTeeiQT2in3D5uVdQLJKUL6KVFe1EzWeBY37HvXfp36q2j-Fg/exec',
  LIFF_ID: '2008231249-yv8294Jp'
};

let USER_ID = '', USER_NAME = '';

window.onload = async () => {
  try {
    await liff.init({ liffId: CONFIG.LIFF_ID });
    if (!liff.isLoggedIn()) return liff.login();

    const profile = await liff.getProfile();
    USER_ID = profile.userId;
    USER_NAME = profile.displayName;
    checkUser(USER_ID);
  } catch (e) {
    showMsg('âŒ åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
  }
};

// ğŸ” æª¢æŸ¥æ˜¯å¦å·²è¨»å†Š
async function checkUser(uid){
  showMsg('ğŸ” æª¢æŸ¥è¨»å†Šç‹€æ…‹...', 'warning');
  const res = await fetch(`${CONFIG.API_URL}?action=checkUser&lineUserId=${uid}`);
  const data = await res.json();

  if (data.success && data.isRegistered){
    showMsg(`âœ… æ­¡è¿å›ä¾† ${data.userName}<br>å³å°‡å°å‘é ç´„é ...`, 'success');
    setTimeout(()=>location.href = `${CONFIG.MAIN_URL}?uid=${uid}`,1500);
  } else {
    showMsg(`ğŸ‘‹ æ­¡è¿ ${USER_NAME}<br>è«‹å®Œæˆè¨»å†Šè³‡æ–™`, 'warning');
    document.getElementById('form').style.display = 'block';
  }
}

// âœï¸ æäº¤è¨»å†Š
document.getElementById('submitBtn').onclick = async ()=>{
  const name = getVal('name'), phone = getVal('phone'), sid = getVal('schoolId'), dept = getVal('dept');
  if(!name||!phone||!sid||!dept){ alert('è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½'); return; }

  showMsg('â³ è¨»å†Šä¸­...', 'warning');
  const payload = {action:'registerUser', lineUserId:USER_ID, name, phone, schoolId:sid, dept};
  const res = await fetch(CONFIG.API_URL,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  const result = await res.json();

  if(result.success){
    showMsg('âœ… è¨»å†ŠæˆåŠŸï¼Œå‰å¾€é ç´„é ...', 'success');
    setTimeout(()=>location.href = `${CONFIG.MAIN_URL}?uid=${USER_ID}`,1500);
  } else {
    showMsg(`âŒ ${result.message||'è¨»å†Šå¤±æ•—'}`, 'error');
  }
};

function getVal(id){return document.getElementById(id).value.trim();}
function showMsg(text,type){document.getElementById('msg').innerHTML=`<span class="${type}">${text}</span>`;}
</script>
</body>
</html>
