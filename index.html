<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æš¨å¤§ç©¿å±±ç”²å°ˆè»Šé ç´„ç³»çµ± - ç™»å…¥</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .loading-spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #ffffff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
      <!-- Logo å€åŸŸ -->
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 overflow-hidden">
          <img src="https://aiwe.cc/wp-content/uploads/2025/10/5d7b9adcbe1c629ec722529dd12e5129.png" 
               alt="æš¨å¤§æ¥é§è»Š" 
               class="w-full h-full object-cover">
        </div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">æš¨å¤§æ¥é§è»Šé ç´„</h1>
        <p class="text-gray-600">è«‹ä½¿ç”¨ LINE å¸³è™Ÿç™»å…¥</p>
      </div>

      <!-- ç™»å…¥æŒ‰éˆ• -->
      <button 
        id="loginButton"
        onclick="lineLogin()"
        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-xl transition duration-200 flex items-center justify-center gap-3 shadow-lg mb-6"
      >
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.240 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
        </svg>
        <span id="loginText">ä½¿ç”¨ LINE ç™»å…¥</span>
      </button>

      <!-- èªªæ˜æ–‡å­— -->
      <div class="text-center text-sm text-gray-500 space-y-2">
        <p>ğŸšŒ æä¾›åŸ”é‡Œç¸½ç«™ â‡„ æš¨å¤§æ ¡å€æ¥é§æœå‹™</p>
        <p>â° æ¯æ—¥ 22:00-24:00 ç‡Ÿé‹</p>
        <p>ğŸ‘¥ æ¯è»Šé™é¡ 6 äºº</p>
      </div>

      <!-- è»Šæ¬¡è³‡è¨Š -->
      <div class="mt-6 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4">
        <p class="text-xs font-semibold text-gray-700 mb-2">ğŸ“ ç‡Ÿé‹è»Šæ¬¡</p>
        <div class="text-xs text-gray-600 space-y-1">
          <p>A1ï½œ22:00-22:30 æš¨å¤§â†’åŸ”é‡Œç¸½ç«™</p>
          <p>B1ï½œ22:30-23:00 åŸ”é‡Œç¸½ç«™â†’æš¨å¤§</p>
          <p>A2ï½œ23:00-23:30 æš¨å¤§â†’åŸ”é‡Œç¸½ç«™</p>
          <p>B2ï½œ23:30-24:00 åŸ”é‡Œç¸½ç«™â†’æš¨å¤§</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // é…ç½®
    const CONFIG = {
      LIFF_ID: "2008231249-yv8294Jp",
      GITHUB_TOKEN: "hhFVS+V7Fp4zIFZ0sv6vq1WuvKmIKzsK6RlZkAOftxr2Lob218VgP+/PK+wIhwhw8HTlOobneGQhxTllrjt8uAzwaCGgWZ5yokIKZSVID+ccNDJmKxElxNQatB6NUObNTtofnMdDZTOLx12X4QRRdwdB04t89/1O/w1cDnyilFU=",
      GIST_ID: "C596050d1193b9b930ac25469c61ba12a"
    };

    let isLoggingIn = false;

    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    function setLoginLoading(isLoading) {
      const loginButton = document.getElementById('loginButton');
      const loginText = document.getElementById('loginText');
      
      if (isLoading) {
        loginButton.disabled = true;
        loginButton.classList.add('opacity-75', 'cursor-not-allowed');
        loginText.innerHTML = '<div class="loading-spinner"></div>ç™»å…¥ä¸­...';
      } else {
        loginButton.disabled = false;
        loginButton.classList.remove('opacity-75', 'cursor-not-allowed');
        loginText.textContent = 'ä½¿ç”¨ LINE ç™»å…¥';
      }
      
      isLoggingIn = isLoading;
    }

    // LINE Login
    async function lineLogin() {
      if (isLoggingIn) return;
      
      console.log('é–‹å§‹ LINE ç™»å…¥æµç¨‹');
      setLoginLoading(true);

      try {
        // æª¢æŸ¥ LIFF SDK æ˜¯å¦å·²è¼‰å…¥
        if (typeof liff === 'undefined') {
          console.error('LIFF SDK æœªè¼‰å…¥');
          throw new Error('LIFF_SDK_NOT_LOADED');
        }

        console.log('LIFF SDK å·²è¼‰å…¥ï¼Œé–‹å§‹åˆå§‹åŒ–...');
        
        // åˆå§‹åŒ– LIFF
        await liff.init({ liffId: CONFIG.LIFF_ID });
        console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');

        if (!liff.isLoggedIn()) {
          console.log('ç”¨æˆ¶æœªç™»å…¥ï¼Œé–‹å§‹ç™»å…¥æµç¨‹');
          liff.login({ redirectUri: window.location.href });
        } else {
          console.log('ç”¨æˆ¶å·²ç™»å…¥ï¼Œå–å¾—ç”¨æˆ¶è³‡æ–™');
          await handleLoggedInUser();
        }
      } catch (error) {
        console.error('ç™»å…¥æµç¨‹éŒ¯èª¤:', error);
        setLoginLoading(false);
        
        let errorMessage = 'ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        
        if (error.message === 'LIFF_SDK_NOT_LOADED') {
          errorMessage = 'LINE æœå‹™è¼‰å…¥å¤±æ•—\n\nè«‹æª¢æŸ¥ï¼š\nâ€¢ ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸\nâ€¢ æ˜¯å¦åœ¨ LINE å…§é–‹å•Ÿ';
        } else if (error.message.includes('channel not found')) {
          errorMessage = 'LINE æ‡‰ç”¨ç¨‹å¼è¨­å®šéŒ¯èª¤\n\nè«‹ç¢ºèª LIFF ID æ­£ç¢ºç„¡èª¤';
        }
        
        alert(errorMessage);
      }
    }

    // è™•ç†å·²ç™»å…¥ç”¨æˆ¶
    async function handleLoggedInUser() {
      try {
        const profile = await liff.getProfile();
        console.log('ç”¨æˆ¶è³‡æ–™:', profile);
        
        // å„²å­˜ç”¨æˆ¶è³‡æ–™åˆ° sessionStorage
        const userData = {
          userId: profile.userId,
          displayName: profile.displayName,
          pictureUrl: profile.pictureUrl || '',
          statusMessage: profile.statusMessage || '',
          loginTime: new Date().toISOString(),
          isRegistered: false
        };
        
        sessionStorage.setItem('userData', JSON.stringify(userData));
        console.log('ç”¨æˆ¶è³‡æ–™å·²å„²å­˜åˆ° sessionStorage');

        // æª¢æŸ¥æ˜¯å¦å·²è¨»å†Š
        const isRegistered = await checkUserRegistration(profile.userId);
        
        if (isRegistered) {
          // å·²è¨»å†Šï¼Œå°å‘é ç´„é é¢
          console.log('ç”¨æˆ¶å·²è¨»å†Šï¼Œå°å‘é ç´„é é¢');
          window.location.href = 'main.html';
        } else {
          // æœªè¨»å†Šï¼Œå°å‘è¨»å†Šé é¢
          console.log('ç”¨æˆ¶æœªè¨»å†Šï¼Œå°å‘è¨»å†Šé é¢');
          window.location.href = 'register.html';
        }
        
      } catch (error) {
        console.error('è™•ç†ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
        throw error;
      }
    }

    // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²è¨»å†Š
    async function checkUserRegistration(lineUserId) {
      try {
        const data = await getGistData();
        const users = data.users || [];
        
        // æª¢æŸ¥æ˜¯å¦æœ‰è©² LINE UserId çš„è¨»å†Šè¨˜éŒ„
        const existingUser = users.find(user => user.lineUserId === lineUserId);
        return !!existingUser;
        
      } catch (error) {
        console.error('æª¢æŸ¥è¨»å†Šç‹€æ…‹å¤±æ•—:', error);
        return false;
      }
    }

    // å¾ GitHub Gist å–å¾—è³‡æ–™
    async function getGistData() {
      const response = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, {
        headers: {
          'Authorization': `token ${CONFIG.GITHUB_TOKEN}`
        }
      });
      
      const gist = await response.json();
      return JSON.parse(gist.files['data.json'].content);
    }

    // é é¢è¼‰å…¥å®Œæˆå¾Œæª¢æŸ¥
    window.addEventListener('load', function() {
      console.log('é é¢è¼‰å…¥å®Œæˆ');
      
      // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
      const userData = sessionStorage.getItem('userData');
      if (userData) {
        console.log('åµæ¸¬åˆ°å·²ç™»å…¥ç”¨æˆ¶ï¼Œæª¢æŸ¥è¨»å†Šç‹€æ…‹');
        const user = JSON.parse(userData);
        
        if (user.isRegistered) {
          window.location.href = 'main.html';
        } else {
          window.location.href = 'register.html';
        }
        return;
      }

      // æª¢æŸ¥ URL åƒæ•¸ï¼ˆLINE ç™»å…¥å›èª¿ï¼‰
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('liffState')) {
        console.log('åµæ¸¬åˆ° LINE ç™»å…¥å›èª¿');
        // è®“ LINE è™•ç†ç™»å…¥å›èª¿
        return;
      }

      console.log('ç­‰å¾…ç”¨æˆ¶æ“ä½œç™»å…¥');
    });

    // LIFF SDK è¼‰å…¥éŒ¯èª¤è™•ç†
    window.addEventListener('error', function(e) {
      if (e.filename && e.filename.includes('liff')) {
        console.error('LIFF SDK è¼‰å…¥å¤±æ•—:', e.error);
      }
    });

    // è™•ç†é é¢å¯è¦‹æ€§è®ŠåŒ–
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden && isLoggingIn) {
        // é é¢é‡æ–°å¯è¦‹ï¼Œæª¢æŸ¥ç™»å…¥ç‹€æ…‹
        setTimeout(() => {
          if (isLoggingIn) {
            setLoginLoading(false);
            alert('ç™»å…¥æµç¨‹ä¸­æ–·ï¼Œè«‹é‡æ–°å˜—è©¦');
          }
        }, 1000);
      }
    });
  </script>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
</body>
</html>
