<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>穿山甲專車</title>
    <!-- ✅ 改用新版 LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <div id="app" style="text-align: center; padding: 50px 20px;">
        <h1>🚐 穿山甲專車</h1>
        <div id="status">
            <p>系統初始化中...</p>
        </div>
    </div>

    <script>
        const LIFF_ID = '2008231249-yv8294Jp';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxgLRcFkyj9huPKqldaEendFC1YiGkdMSJvWi8qjvUAvbZgEs3OLjz9J5ZZCVvLW03gtw/exec';

        function isInLineApp() {
            return /Line/i.test(navigator.userAgent) || window.self !== window.top;
        }

        async function initializeApp() {
            const statusEl = document.getElementById('status');
            try {
                statusEl.innerHTML = '<p>🔍 檢查執行環境...</p>';
                if (!isInLineApp()) {
                    statusEl.innerHTML = `
                        <p style="color: red;">❌ 請在 LINE App 中開啟此連結</p>
                        <p>請使用 LINE 掃描 QR Code 或點擊連結開啟</p>
                        <button onclick="location.reload()" style="padding: 10px 20px; margin: 10px; background: #06c755; color: white; border: none; border-radius: 5px; cursor: pointer;">重新整理</button>
                    `;
                    return;
                }

                // 初始化 LIFF
                statusEl.innerHTML = '<p>⚙️ 初始化應用程式...</p>';
                await liff.init({ liffId: LIFF_ID });

                if (!liff.isLoggedIn()) {
                    statusEl.innerHTML = '<p>🔑 跳轉至登入頁面...</p>';
                    liff.login();
                    return;
                }

                // 取得使用者資料
                statusEl.innerHTML = '<p>👤 取得使用者資訊...</p>';
                const profile = await liff.getProfile();

                // 檢查註冊狀態
                statusEl.innerHTML = '<p>📋 檢查註冊狀態...</p>';
                const response = await fetch(`${GAS_URL}?action=register&userId=${profile.userId}&name=${encodeURIComponent(profile.displayName)}`);
                const data = await response.json();

                if (data.status === 'existing_user') {
                    window.location.href = 'booking.html';
                } else {
                    window.location.href = 'register.html';
                }

            } catch (error) {
                console.error('初始化失敗:', error);
                showError(error.message || '未知錯誤');
            }
        }

        function showError(message) {
            document.getElementById('status').innerHTML = `
                <p style="color: red;">❌ 系統初始化失敗</p>
                <p>錯誤訊息: ${message}</p>
                <ol style="text-align: left; display: inline-block;">
                    <li>確認在 LINE App 中開啟</li>
                    <li>檢查網路連線</li>
                    <li>重新整理頁面</li>
                </ol>
                <button onclick="location.reload()" style="padding: 10px 20px; margin: 10px; background: #06c755; color: white; border: none; border-radius: 5px; cursor: pointer;">重新整理頁面</button>
                <p style="font-size: 12px; color: #666; margin-top: 20px;">如果持續出現錯誤，請聯繫管理員</p>
            `;
        }

        window.addEventListener('load', () => setTimeout(initializeApp, 200));
    </script>
</body>
</html>
