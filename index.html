<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç©¿å±±ç”²å°ˆè»Š</title>
    <!-- ç›´æ¥å¼•ç”¨ LIFF SDK -->
    <script src="https://d.line-scdn.net/liff/1.0/sdk.js"></script>
</head>
<body>
    <div id="app" style="text-align: center; padding: 50px 20px;">
        <h1>ğŸš ç©¿å±±ç”²å°ˆè»Š</h1>
        <div id="status">
            <p>ç³»çµ±åˆå§‹åŒ–ä¸­...</p>
        </div>
    </div>

    <script>
        const LIFF_ID = '2008231249-yv8294Jp';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxgLRcFkyj9huPKqldaEendFC1YiGkdMSJvWi8qjvUAvbZgEs3OLjz9J5ZZCVvLW03gtw/exec';

        // æª¢æŸ¥æ˜¯å¦åœ¨ LINE ç’°å¢ƒä¸­
        function isInLineApp() {
            return /Line/i.test(navigator.userAgent) || window.self !== window.top;
        }

        async function initializeApp() {
            try {
                const statusEl = document.getElementById('status');
                
                // æ­¥é©Ÿ 1: æª¢æŸ¥ç’°å¢ƒ
                statusEl.innerHTML = '<p>ğŸ” æª¢æŸ¥åŸ·è¡Œç’°å¢ƒ...</p>';
                
                if (!isInLineApp()) {
                    statusEl.innerHTML = `
                        <p style="color: red;">âŒ è«‹åœ¨ LINE App ä¸­é–‹å•Ÿæ­¤é€£çµ</p>
                        <p>è«‹ä½¿ç”¨ LINE æƒæ QR Code æˆ–é»æ“Šé€£çµé–‹å•Ÿ</p>
                        <button onclick="location.reload()" style="padding: 10px 20px; margin: 10px; background: #06c755; color: white; border: none; border-radius: 5px; cursor: pointer;">é‡æ–°æ•´ç†</button>
                    `;
                    return;
                }

                // æ­¥é©Ÿ 2: æª¢æŸ¥ LIFF SDK
                statusEl.innerHTML = '<p>ğŸ“¦ è¼‰å…¥ LIFF SDK...</p>';
                
                if (typeof liff === 'undefined') {
                    throw new Error('LIFF SDK è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†');
                }

                // æ­¥é©Ÿ 3: åˆå§‹åŒ– LIFF
                statusEl.innerHTML = '<p>âš™ï¸ åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...</p>';
                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    statusEl.innerHTML = '<p>ğŸ”‘ è·³è½‰è‡³ç™»å…¥é é¢...</p>';
                    liff.login();
                    return;
                }

                // æ­¥é©Ÿ 4: å–å¾—ä½¿ç”¨è€…è³‡æ–™
                statusEl.innerHTML = '<p>ğŸ‘¤ å–å¾—ä½¿ç”¨è€…è³‡è¨Š...</p>';
                const profile = await liff.getProfile();
                
                // æ­¥é©Ÿ 5: æª¢æŸ¥è¨»å†Šç‹€æ…‹
                statusEl.innerHTML = '<p>ğŸ“‹ æª¢æŸ¥è¨»å†Šç‹€æ…‹...</p>';
                const response = await fetch(`${GAS_URL}?action=register&userId=${profile.userId}&name=${encodeURIComponent(profile.displayName)}`);
                const data = await response.json();
                
                if (data.status === 'existing_user') {
                    window.location.href = 'booking.html';
                } else {
                    window.location.href = 'register.html';
                }
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                showError(error.message);
            }
        }

        function showError(message) {
            document.getElementById('status').innerHTML = `
                <p style="color: red;">âŒ ç³»çµ±åˆå§‹åŒ–å¤±æ•—</p>
                <p>éŒ¯èª¤è¨Šæ¯: ${message}</p>
                <div style="margin: 20px 0;">
                    <p><strong>è«‹å˜—è©¦ä»¥ä¸‹æ­¥é©Ÿï¼š</strong></p>
                    <ol style="text-align: left; display: inline-block;">
                        <li>ç¢ºèªåœ¨ LINE App ä¸­é–‹å•Ÿ</li>
                        <li>æª¢æŸ¥ç¶²è·¯é€£ç·š</li>
                        <li>é‡æ–°æ•´ç†é é¢</li>
                    </ol>
                </div>
                <button onclick="location.reload()" style="padding: 10px 20px; margin: 10px; background: #06c755; color: white; border: none; border-radius: 5px; cursor: pointer;">é‡æ–°æ•´ç†é é¢</button>
                <button onclick="liff.login()" style="padding: 10px 20px; margin: 10px; background: #0066ff; color: white; border: none; border-radius: 5px; cursor: pointer;">é‡æ–°ç™»å…¥</button>
                <p style="font-size: 12px; color: #666; margin-top: 20px;">å¦‚æœæŒçºŒå‡ºç¾éŒ¯èª¤ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡</p>
            `;
        }

        // é é¢è¼‰å…¥å¾Œé–‹å§‹åˆå§‹åŒ–
        window.addEventListener('load', function() {
            // çµ¦ LIFF SDK ä¸€é»æ™‚é–“è¼‰å…¥
            setTimeout(initializeApp, 100);
        });
    </script>
</body>
</html>
