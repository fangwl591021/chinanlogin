<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç©¿å±±ç”²å°ˆè»Š</title>
    <!-- ç§»é™¤åŸæœ¬çš„ liff SDK å¼•ç”¨ -->
</head>
<body>
    <div id="app" style="text-align: center; padding: 50px 20px;">
        <h1>ğŸš ç©¿å±±ç”²å°ˆè»Š</h1>
        <p>è¼‰å…¥ä¸­...</p>
    </div>

    <script>
        const LIFF_ID = '2008231249-yv8294Jp';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzKZNfyLWWIKCEe_yzlZZP8KcWcjREeHAb36-X2HbIflXh0kCTxFJxkO8KIEv4Z6_3Pew/exec';

        // å‹•æ…‹è¼‰å…¥ LIFF SDK
        function loadLiffSDK() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://static.line-scdn.net/liff/edge/versions/2.1/sdk.js';
                script.onload = () => {
                    console.log('LIFF SDK è¼‰å…¥æˆåŠŸ');
                    resolve();
                };
                script.onerror = () => {
                    reject(new Error('LIFF SDK è¼‰å…¥å¤±æ•—'));
                };
                document.head.appendChild(script);
            });
        }

        async function initializeApp() {
            try {
                // å…ˆè¼‰å…¥ LIFF SDK
                await loadLiffSDK();
                
                // åˆå§‹åŒ– LIFF
                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // å–å¾—ä½¿ç”¨è€…è³‡æ–™ä¸¦æª¢æŸ¥è¨»å†Šç‹€æ…‹
                const profile = await liff.getProfile();
                
                const response = await fetch(`${GAS_URL}?action=register&userId=${profile.userId}&name=${encodeURIComponent(profile.displayName)}`);
                const data = await response.json();
                
                if (data.status === 'existing_user') {
                    // å·²è¨»å†Šï¼Œè·³è½‰åˆ°é ç´„é é¢
                    window.location.href = 'booking.html';
                } else {
                    // æœªè¨»å†Šï¼Œè·³è½‰åˆ°è¨»å†Šé é¢
                    window.location.href = 'register.html';
                }
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                document.getElementById('app').innerHTML = `
                    <h1>ğŸš ç©¿å±±ç”²å°ˆè»Š</h1>
                    <p>ç³»çµ±åˆå§‹åŒ–å¤±æ•—: ${error.message}</p>
                    <p>è«‹ç¢ºèªæ‚¨åœ¨ LINE App ä¸­é–‹å•Ÿæ­¤é€£çµ</p>
                    <button onclick="location.reload()" style="padding: 10px 20px; margin: 10px; background: #06c755; color: white; border: none; border-radius: 5px; cursor: pointer;">é‡æ–°æ•´ç†</button>
                    <p style="font-size: 12px; color: #666; margin-top: 20px;">å¦‚æœæŒçºŒå‡ºç¾éŒ¯èª¤ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡</p>
                `;
            }
        }

        // é é¢è¼‰å…¥å¾Œé–‹å§‹åˆå§‹åŒ–
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
