<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æš¨å¤§æ¥é§è»Š - LINE Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        * {
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .hero-pattern {
            background: linear-gradient(135deg, #06C755 0%, #05B04E 100%);
        }
        
        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-purple-50">
    
    <nav class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-green-600 rounded-xl flex items-center justify-center shadow-md">
                        <i class="fas fa-bus text-white"></i>
                    </div>
                    <span class="font-black text-gray-800 text-lg">æš¨å¤§æ¥é§è»Š</span>
                </div>
                <div class="text-sm text-gray-600 font-medium">
                    åœ‹ç«‹æš¨å—åœ‹éš›å¤§å­¸
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-md mx-auto mt-16 px-4">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
            
            <div class="hero-pattern text-white p-12 text-center relative overflow-hidden">
                <div class="absolute inset-0 opacity-10">
                    <div class="absolute top-0 left-0 w-40 h-40 bg-white rounded-full -translate-x-20 -translate-y-20"></div>
                    <div class="absolute bottom-0 right-0 w-40 h-40 bg-white rounded-full translate-x-20 translate-y-20"></div>
                </div>
                <div class="relative z-10">
                    <div class="w-24 h-24 bg-white/20 backdrop-blur-sm rounded-3xl flex items-center justify-center mx-auto mb-6 animate-pulse-slow shadow-xl">
                        <i class="fab fa-line text-5xl"></i>
                    </div>
                    <h1 class="text-3xl font-black mb-3 tracking-tight">æš¨å¤§æ¥é§è»Šæœå‹™</h1>
                    <p class="text-green-100 font-medium">ä½¿ç”¨ LINE å¸³è™Ÿå¿«é€Ÿç™»å…¥</p>
                </div>
            </div>

            <div class="p-8 space-y-6">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-black text-gray-800 mb-2">æ­¡è¿ä½¿ç”¨æ¥é§è»Šç³»çµ±</h2>
                    <p class="text-gray-600">è«‹ä½¿ç”¨ LINE å¸³è™Ÿç™»å…¥ä»¥ç¹¼çºŒä½¿ç”¨æœå‹™</p>
                </div>

                <button id="lineLoginBtn" 
                    class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-black py-5 px-6 rounded-2xl transition duration-200 shadow-xl hover:shadow-2xl transform hover:scale-[1.02] flex items-center justify-center text-lg">
                    <i class="fab fa-line text-2xl mr-3"></i>
                    LINE å¿«é€Ÿç™»å…¥
                </button>

                <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-2xl p-5 mt-6">
                    <div class="flex items-start">
                        <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-info-circle text-white"></i>
                        </div>
                        <div class="ml-4 text-sm text-blue-900">
                            <p class="font-bold mb-2">ä½¿ç”¨æµç¨‹èªªæ˜</p>
                            <div class="space-y-1">
                                <p class="flex items-center gap-2">
                                    <span class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold">1</span>
                                    LINE ç™»å…¥
                                </p>
                                <p class="flex items-center gap-2">
                                    <span class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold">2</span>
                                    æœƒå“¡è¨»å†Š
                                </p>
                                <p class="flex items-center gap-2">
                                    <span class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold">3</span>
                                    é ç´„æ¥é§è»Š
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-8 mb-8">
            <div class="bg-white rounded-2xl p-5 text-center shadow-lg hover:shadow-xl transition transform hover:scale-105">
                <div class="w-14 h-14 bg-gradient-to-br from-green-400 to-green-600 rounded-2xl flex items-center justify-center mx-auto mb-3 shadow-md">
                    <i class="fab fa-line text-white text-xl"></i>
                </div>
                <p class="text-sm font-bold text-gray-700">LINE æ•´åˆ</p>
            </div>
            <div class="bg-white rounded-2xl p-5 text-center shadow-lg hover:shadow-xl transition transform hover:scale-105">
                <div class="w-14 h-14 bg-gradient-to-br from-blue-400 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-3 shadow-md">
                    <i class="fas fa-calendar-check text-white text-xl"></i>
                </div>
                <p class="text-sm font-bold text-gray-700">ç·šä¸Šé ç´„</p>
            </div>
            <div class="bg-white rounded-2xl p-5 text-center shadow-lg hover:shadow-xl transition transform hover:scale-105">
                <div class="w-14 h-14 bg-gradient-to-br from-purple-400 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-3 shadow-md">
                    <i class="fas fa-bell text-white text-xl"></i>
                </div>
                <p class="text-sm font-bold text-gray-700">å³æ™‚é€šçŸ¥</p>
            </div>
            <div class="bg-white rounded-2xl p-5 text-center shadow-lg hover:shadow-xl transition transform hover:scale-105">
                <div class="w-14 h-14 bg-gradient-to-br from-orange-400 to-orange-600 rounded-2xl flex items-center justify-center mx-auto mb-3 shadow-md">
                    <i class="fas fa-map-marker-alt text-white text-xl"></i>
                </div>
                <p class="text-sm font-bold text-gray-700">å¤šç«™é»æœå‹™</p>
            </div>
        </div>
    </main>

    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-3xl p-8 text-center shadow-2xl">
            <div class="flex justify-center items-center gap-2 mb-6">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                <div class="w-3 h-3 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                <div class="w-3 h-3 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
            </div>
            <p class="text-gray-700 font-bold text-lg">LINE ç™»å…¥è™•ç†ä¸­...</p>
            <p class="text-gray-500 text-sm mt-2">è«‹ç¨å€™</p>
        </div>
    </div>

    <script>
        // çµ±ä¸€é…ç½®
        const CONFIG = {
            LIFF_ID: "2006590746-VKy0Gk0l",
            // ğŸš¨ å·²ç§»é™¤ GitHub Tokenï¼Œæ”¹ç”¨ GAS Proxy ç¶²å€
            PROXY_API_URL: "https://script.google.com/macros/s/AKfycbztIkoPisJ0W5CHEWPQI8lfNp20iz2UGRliUYDPDs1u46jsmq5yL28H_REhcRQ3IeEsWw/exec", 
        };

        // å¾ GAS Proxy è®€å–ç”¨æˆ¶è³‡æ–™ (å·²æ›´æ–°ç‚ºå‘¼å« GAS)
        async function getUsersFromGist() {
            try {
                // ä½¿ç”¨ GET è«‹æ±‚å‘¼å« GAS Proxyï¼Œç”± GAS è² è²¬ä½¿ç”¨ Token è®€å– Gist
                const res = await fetch(CONFIG.PROXY_API_URL, { method: 'GET' });

                if (!res.ok) {
                    throw new Error(`Proxy API å‘¼å«å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${res.status}`);
                }
                
                const result = await res.json();
                
                // æª¢æŸ¥ GAS å›å‚³çš„ JSON çµæ§‹ä¸­çš„ status å±¬æ€§
                if (result.status === 'error') {
                    throw new Error(result.message);
                }

                return result.users || []; // å¾ GAS å›å‚³çš„ JSON ä¸­å–å¾— users é™£åˆ—
                
            } catch (error) {
                console.error('è®€å– Gist (é€é GAS) å¤±æ•—:', error);
                // è®€å–å¤±æ•—æ™‚ï¼Œè¿”å›ç©ºé™£åˆ—ï¼Œè®“ç¨‹å¼ç¹¼çºŒåŸ·è¡Œè¨»å†Šé‚è¼¯
                return []; 
            }
        }

        // åˆå§‹åŒ– LIFF (å·²å„ªåŒ–ç™»å…¥æª¢æŸ¥é‚è¼¯)
        async function initializeLiff() {
            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                
                console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');
                
                // æª¢æŸ¥æ˜¯å¦æœ‰å„²å­˜çš„è¨»å†Šç‹€æ…‹
                const userData = JSON.parse(sessionStorage.getItem('userData') || '{}');
                
                if (userData.lineUserId) {
                    if (userData.isRegistered) {
                        console.log('å·²ç™»å…¥ä¸”å·²è¨»å†Šï¼Œå°å‘ä¸»é é¢');
                        window.location.href = 'main.html';
                        return;
                    } else {
                        console.log('å·²ç™»å…¥ä½†æœªè¨»å†Šï¼Œå°å‘è¨»å†Šé é¢');
                        window.location.href = 'register.html';
                        return;
                    }
                }
                
                // å¦‚æœå·²ç¶“ç™»å…¥ä½†ç„¡ sessionStorageï¼Œè‡ªå‹•è™•ç†
                if (liff.isLoggedIn()) {
                    await handleLineLogin();
                }
                
            } catch (error) {
                console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                alert('LINE ç™»å…¥åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¢ºèª LIFF ID æˆ–ç¶²è·¯é€£ç·šæ˜¯å¦æ­£ç¢º');
            }
        }

        // è™•ç† LINE ç™»å…¥
        async function handleLineLogin() {
            showLoading();
            
            try {
                // ç²å–ç”¨æˆ¶è³‡æ–™
                const profile = await liff.getProfile();
                
                console.log('LINE ç”¨æˆ¶è³‡æ–™:', profile);
                
                // å„²å­˜ LINE ç”¨æˆ¶è³‡æ–™åˆ° sessionStorage (åŸå§‹ç¢¼ä¿ç•™çš„ lineUserData)
                const lineUserData = {
                    lineUserId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl || '',
                    statusMessage: profile.statusMessage || ''
                };
                
                sessionStorage.setItem('lineUserData', JSON.stringify(lineUserData));
                
                // å¾ Gist æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²è¨»å†Š
                await checkUserRegistration(profile.userId, lineUserData.displayName);
                
            } catch (error) {
                console.error('LINE ç™»å…¥å¤±æ•—:', error);
                hideLoading();
                alert('LINE ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦\néŒ¯èª¤: ' + error.message);
            }
        }

        // LINE Login æŒ‰éˆ•é»æ“Šäº‹ä»¶
        document.getElementById('lineLoginBtn').addEventListener('click', async function() {
            console.log('é»æ“Šç™»å…¥æŒ‰éˆ•');
            
            if (!liff.isLoggedIn()) {
                console.log('æœªç™»å…¥ï¼Œè§¸ç™¼ LINE ç™»å…¥');
                liff.login({ redirectUri: window.location.href });
            } else {
                console.log('å·²ç™»å…¥ï¼Œç²å–ç”¨æˆ¶è³‡æ–™');
                await handleLineLogin();
            }
        });

        // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²è¨»å†Šï¼ˆå¾ Gistï¼‰
        async function checkUserRegistration(lineUserId, displayName) {
            try {
                const users = await getUsersFromGist();
                const userExists = users.find(user => user.lineUserId === lineUserId);
                
                if (userExists) {
                    console.log('ç”¨æˆ¶å·²è¨»å†Š:', userExists);
                    
                    // ç”¨æˆ¶å·²è¨»å†Šï¼Œå»ºç«‹ session è³‡æ–™ä¸¦å°å‘ä¸»é é¢
                    const userData = {
                        lineUserId: lineUserId,
                        displayName: userExists.displayName,
                        phone: userExists.phone,
                        studentId: userExists.studentId,
                        department: userExists.department,
                        isRegistered: true
                    };
                    sessionStorage.setItem('userData', JSON.stringify(userData));
                    
                    hideLoading();
                    alert('âœ… ç™»å…¥æˆåŠŸï¼\næ­¡è¿å›ä¾†ï¼Œ' + userExists.displayName);
                    window.location.href = 'main.html';
                } else {
                    console.log('ç”¨æˆ¶æœªè¨»å†Šï¼Œå°å‘è¨»å†Šé é¢');
                    
                    // ç”¨æˆ¶æœªè¨»å†Šï¼Œå»ºç«‹ session è³‡æ–™ä¸¦å°å‘è¨»å†Šé é¢
                    const userData = {
                        lineUserId: lineUserId,
                        displayName: displayName || '', // ä½¿ç”¨ LINE æä¾›çš„åç¨±
                        isRegistered: false
                    };
                    sessionStorage.setItem('userData', JSON.stringify(userData));
                    
                    hideLoading();
                    alert('â„¹ï¸ é¦–æ¬¡ä½¿ç”¨\nè«‹å…ˆå®Œæˆæœƒå“¡è¨»å†Š');
                    window.location.href = 'register.html';
                }
            } catch (error) {
                console.error('æª¢æŸ¥è¨»å†Šç‹€æ…‹å¤±æ•—:', error);
                hideLoading();
                alert('æª¢æŸ¥è¨»å†Šç‹€æ…‹å¤±æ•—ï¼Œè«‹é‡è©¦ (' + error.message + ')');
            }
        }

        // é¡¯ç¤ºè¼‰å…¥ä¸­
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        // éš±è—è¼‰å…¥ä¸­
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        window.addEventListener('load', async function() {
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ– LIFF');
            await initializeLiff();
        });
    </script>
</body>
</html>
