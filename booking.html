<!DOCTYPE html><html lang="zh-Hant"><head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>預約/取消</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body{font-family:system-ui,"Noto Sans TC",sans-serif;background:#f6f7f9;margin:0}
main{max-width:620px;margin:24px auto;background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
h1{font-size:22px;margin:0 0 12px}label{display:block;margin:6px 0 4px}
input,select,button{font-size:16px;padding:10px;border-radius:10px;border:1px solid #d3d7de;width:100%;box-sizing:border-box}
.btn{background:#3c8050;color:#fff;border:none;margin-top:10px;cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.card{border:1px solid #e5e8ee;border-radius:12px;padding:10px}
.badge{display:inline-block;padding:4px 8px;border-radius:8px;background:#eef2f7;font-size:12px;margin-left:8px}
.ok{color:#0a7f2e}.err{color:#b8062e}
</style></head><body>
<main>
  <h1>預約 / 取消 <span id="role" class="badge"></span></h1>
  <p id="status">初始化中…</p>
  <div class="grid">
    <div class="card">
      <h3>建立預約</h3>
      <label>日期</label><input id="date" type="date"/>
      <label>班次</label>
      <select id="slot">
        <option value="A1">A1</option><option value="A2">A2</option>
        <option value="B1">B1</option><option value="B2">B2</option>
      </select>
      <button id="btnReserve" class="btn">預約</button>
      <p id="cap"></p>
    </div>
    <div class="card">
      <h3>取消預約</h3>
      <label>日期</label><input id="cdate" type="date"/>
      <label>班次</label>
      <select id="cslot">
        <option value="A1">A1</option><option value="A2">A2</option>
        <option value="B1">B1</option><option value="B2">B2</option>
      </select>
      <button id="btnCancel" class="btn" style="background:#8a1f2c">取消</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>我的預約</h3>
    <div id="mine"></div>
  </div>

  <p><a href="./login.html">← 回登入/註冊</a> | <a href="./admin.html">Admin</a></p>
</main>
<script>
/* === 你的設定 === */
const LIFF_ID  = '2006590746-gA7QALQX';
const API_BASE = 'https://delicate-math-7e61.fangwl591021.workers.dev/';

const $=id=>document.getElementById(id);
let user=null;

/* 共用 fetch */
function mustJson(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function callGet(q){ return fetch(API_BASE + '?' + new URLSearchParams(q)).then(mustJson); }
async function callPost(p){ return fetch(API_BASE, {method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(p)}).then(mustJson); }

/* 首頁守門：未登入→導回；未註冊→導回 */
async function guardAndBoot(){
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) { location.href='./login.html'; return; }

  user = await liff.getProfile();

  // 顯示角色（admin/user）
  try {
    const roleRes = await callGet({ mode:'getRole', userId: user.userId });
    if (roleRes.ok && roleRes.data && roleRes.data.role) $('role').textContent = roleRes.data.role;
  } catch(_) {}

  // 未註冊就導回 login
  const chk = await callGet({ mode:'check', userId: user.userId });
  if (!chk.ok || !chk.data || !chk.data.registered) { location.href='./login.html'; return; }

  $('status').innerHTML = '已登入：<b>'+user.displayName+'</b>';
  const today = new Date().toISOString().slice(0,10);
  $('date').value = today; $('cdate').value = today;
  await refreshCap(); await loadMine();
}

/* UI functions */
async function refreshCap(){
  const d = $('date').value || new Date().toISOString().slice(0,10);
  try{
    const r = await callGet({ mode:'capacity', date:d });
    if (!r.ok) throw new Error(r.error);
    const s = r.data.slots;
    $('cap').innerHTML = `A1 ${s.A1.used}/${s.A1.cap}、A2 ${s.A2.used}/${s.A2.cap}、B1 ${s.B1.used}/${s.B1.cap}、B2 ${s.B2.used}/${s.B2.cap}`;
  }catch(e){
    $('cap').innerHTML = '<span class="err">讀取名額失敗：'+(e.message||e)+'</span>';
  }
}

async function loadMine(){
  try{
    const r = await callGet({ mode:'listMy', userId: user.userId });
    if (!r.ok) throw new Error(r.error);
    if (!r.data || r.data.length===0) { $('mine').textContent = '（無預約）'; return; }
    $('mine').innerHTML = '<ul>'+ r.data.map(x=>`<li>${x.date} - ${x.slot} ${x.driverChecked?'✅':''}</li>`).join('') + '</ul>';
  }catch(e){
    $('mine').textContent = '❌ '+(e.message||e);
  }
}

/* 事件綁定 */
$('date').addEventListener('change', refreshCap);
$('btnReserve').onclick = async ()=>{
  const d = $('date').value, s = $('slot').value;
  try{
    const r = await callPost({ mode:'reserve', userId:user.userId, date:d, slot:s, name:user.displayName });
    if (!r.ok) throw new Error(r.error);
    alert(`✅ 已預約 ${d} ${s}，剩餘 ${r.data.left}`);
    await refreshCap(); await loadMine();
  }catch(e){ alert('❌ '+(e.message||e)); }
};
$('btnCancel').onclick = async ()=>{
  const d = $('cdate').value, s = $('cslot').value;
  try{
    const r = await callPost({ mode:'cancel', userId:user.userId, date:d, slot:s });
    if (!r.ok) throw new Error(r.error);
    alert('✅ 已取消');
    await refreshCap(); await loadMine();
  }catch(e){ alert('❌ '+(e.message||e)); }
};

/* 啟動 */
guardAndBoot();
</script>
</body></html>
