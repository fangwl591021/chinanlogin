<!DOCTYPE html><html lang="zh-Hant"><head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>學生接駁車註冊</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
:root{
  --bg:#f3f7f5; --card:#ffffff; --border:#e8eef0; --shadow:0 10px 30px rgba(0,0,0,.08);
  --title:#0f172a; --muted:#64748b; --ok:#2e7d32; --btn:#35a853; --btnH:#2e9448;
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,"Noto Sans TC",sans-serif;color:var(--title)}
.wrap{min-height:100dvh;display:grid;place-items:center;padding:18px}
.card{
  width: 380px; max-width:92vw; background:var(--card); border:1px solid var(--border);
  border-radius:18px; box-shadow:var(--shadow); padding:22px 22px 18px;
}
.h1{margin:0 0 6px; text-align:center; font-size:22px; font-weight:700}
.p{margin:0; text-align:center; color:var(--muted); font-size:14px}
.uid{margin:6px 0 10px; text-align:center; color:#94a3b8; font-size:12px}
label{display:block; font-size:14px; color:#111827; margin:12px 0 6px}
input,select{
  width:100%; font-size:16px; padding:12px 12px; border:1px solid #dbe3e7; border-radius:12px; outline:none;
  background:#fbfdff;
}
input:focus,select:focus{border-color:#9cc5b3; box-shadow:0 0 0 3px rgba(53,168,83,.12)}
.btn{
  width:100%; margin-top:16px; padding:12px 14px; font-size:16px; font-weight:700;
  color:#fff; background:var(--btn); border:none; border-radius:12px; cursor:pointer;
}
.btn:hover{background:var(--btnH)} .btn[disabled]{opacity:.6; cursor:not-allowed}
.status{text-align:center; font-size:14px; color:var(--muted); margin-top:8px}
.err{color:#b8062e} .ok{color:var(--ok)}
.footer{margin-top:10px; text-align:center; font-size:12px; color:#94a3b8}
.linkbar{margin-top:8px; text-align:center}
.linkbar a{color:#2563eb; text-decoration:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1 class="h1">學生接駁車註冊</h1>
    <p class="p">請填寫資訊完成註冊</p>
    <div id="uid" class="uid">(ID: …)</div>

    <div id="formBox" style="display:none">
      <label>姓名</label>
      <input id="name" placeholder="請輸入姓名"/>
      <label>電話</label>
      <input id="phone" placeholder="09xx-xxx-xxx" inputmode="tel"/>
      <label>學號</label>
      <input id="studentId" placeholder="S1234567"/>
      <label>科系</label>
      <select id="department">
        <option value="">請選擇科系</option>
        <option>資工系</option>
        <option>電機系</option>
        <option>企管系</option>
        <option>新興產業策略與發展</option>
        <option>商管學院</option>
        <option>其他</option>
      </select>
      <button id="btnSubmit" class="btn">立即註冊</button>
    </div>

    <div id="status" class="status">初始化中…</div>
    <div class="linkbar"><a href="./booking.html">→ 直接前往預約</a></div>
    <div class="footer">本系統僅用於接駁車服務，不對外公開個資。</div>
  </div>
</div>

<script>
/* === 連線設定（如需更換只改這兩行） === */
const LIFF_ID  = '2006590746-gA7QALQX';
const API_BASE = 'https://delicate-math-7e61.fangwl591021.workers.dev/';

/* === 小工具 === */
const $=id=>document.getElementById(id);
const maskUid = (u)=> u ? (u.slice(0,8)+'…'+u.slice(-3)) : '';
function mustJson(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
function setBusy(b){ $('btnSubmit') && ($('btnSubmit').disabled=b); }

/* === 開始流程 === */
let current = { userId:'', displayName:'' };

(async function init(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { $('status').innerHTML = '尚未登入，請於 LINE 中開啟或按 <b>登入</b> 後再試。'; return; }

    const prof = await liff.getProfile();
    current.userId = prof.userId;
    current.displayName = prof.displayName;

    $('uid').textContent = `(ID: ${maskUid(current.userId)})`;
    $('status').textContent = '檢查註冊資料…';

    // 1) 檢查是否已註冊（只看 UID 是否存在於〈註冊人資料〉）
    const chk = await fetch(API_BASE + '?mode=check&userId=' + encodeURIComponent(current.userId)).then(mustJson);

    if (chk.ok && chk.data && chk.data.registered) {
      // 有 UID 就視為已註冊，直接前往預約
      $('status').innerHTML = '<span class="ok">已註冊，導向預約頁…</span>';
      location.href = './booking.html';
      return;
    }

    // 2) 未註冊 → 顯示表單，姓名預填為 LINE 暱稱
    $('name').value = current.displayName || '';
    $('phone').value = '';
    $('studentId').value = '';
    $('department').value = '';
    $('status').textContent = '請完成下列表單後送出。';
    $('formBox').style.display = 'block';

  } catch (e) {
    $('status').innerHTML = '<span class="err">失敗：</span>' + (e.message||e);
  }
})();

/* === 送出註冊 === */
$('btnSubmit').onclick = async ()=>{
  try{
    // 簡單驗證
    const name = $('name').value.trim();
    const phone = $('phone').value.trim();
    const sid = $('studentId').value.trim();
    const dept = $('department').value.trim();

    if (!name) { alert('請輸入姓名'); return; }
    if (!phone) { alert('請輸入電話'); return; }
    if (!dept)  { alert('請選擇科系'); return; }

    setBusy(true);
    $('status').textContent = '送出中…';

    const payload = {
      mode:'registerUser',
      userId: current.userId,
      displayName: name,        // 寫入姓名（可不同於 LINE 暱稱）
      phone, studentId: sid, department: dept
    };

    const res = await fetch(API_BASE, {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify(payload)
    }).then(mustJson);

    if (!res.ok) throw new Error(res.error || '註冊失敗');
    $('status').innerHTML = '<span class="ok">註冊成功，前往預約頁…</span>';
    location.href = './booking.html';

  } catch(e){
    $('status').innerHTML = '<span class="err">註冊失敗：</span>' + (e.message||e);
    setBusy(false);
  }
};
</script>
</body></html>
