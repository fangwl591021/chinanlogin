<!DOCTYPE html><html lang="zh-Hant"><head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>登入健檢＋註冊</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>body{font-family:system-ui,"Noto Sans TC",sans-serif;background:#f6f7f9;margin:0}
main{max-width:560px;margin:24px auto;background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
h1{font-size:22px;margin:0 0 12px}label{display:block;margin:6px 0 4px}input,select,button{font-size:16px;padding:10px;border-radius:10px;border:1px solid #d3d7de;width:100%;box-sizing:border-box}
.btn{background:#3c8050;color:#fff;border:none;margin-top:10px;cursor:pointer}
pre{background:#0b1020;color:#e8f0ff;padding:12px;border-radius:10px;overflow:auto;font-size:14px}
.row{display:flex;gap:8px;align-items:center}
</style></head><body>
<main>
  <h1>LINE 登入健檢 & 註冊</h1>
  <div class="row"><button id="btnLogin" class="btn">登入 / 重新授權</button><button id="btnLogout">登出</button></div>
  <p id="status">初始化中…</p>
  <pre id="profile"></pre>
  <h3>註冊資料</h3>
  <label>手機</label><input id="phone" placeholder="09xx-xxx-xxx"/>
  <label>學號（可留空）</label><input id="studentId" placeholder="S1234567"/>
  <label>科系（可留空）</label><input id="department" placeholder="資工系"/>
  <button id="btnRegister" class="btn">送出註冊</button>
  <p><a href="./booking.html">→ 前往預約頁</a></p>
</main>
<script>
const LIFF_ID  = '2006590746-gA7QALQX';
const API_BASE = 'https://delicate-math-7e61.fangwl591021.workers.dev/';

const $=id=>document.getElementById(id);
const J=v=>JSON.stringify(v,null,2);
function log(p, obj){ $(p).textContent = typeof obj==='string'?obj:J(obj); }

async function init(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){ $('status').textContent='未登入'; return; }
    const prof = await liff.getProfile();
    $('status').textContent = '已登入';
    log('profile', prof);
  }catch(e){
    $('status').textContent = '失敗：'+(e.message||e);
  }
}
$('btnLogin').onclick = ()=> liff.login({ redirectUri: location.href });
$('btnLogout').onclick = ()=>{ if(liff.isLoggedIn()) liff.logout(); location.reload(); };

$('btnRegister').onclick = async ()=>{
  try{
    const prof = await liff.getProfile();
    const r = await fetch(API_BASE, {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({
        mode:'registerUser',
        userId: prof.userId, displayName: prof.displayName,
        phone: $('phone').value, studentId: $('studentId').value, department: $('department').value
      })
    }).then(r=>r.json());
    alert(r.ok ? '✅ 註冊/更新完成' : '❌ '+r.error);
  }catch(e){ alert('❌ '+e.message); }
};
init();
</script>
</body></html>
