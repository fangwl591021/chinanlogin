<!DOCTYPE html><html lang="zh-Hant"><head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>登入健檢＋註冊（自動跳轉）</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body{font-family:system-ui,"Noto Sans TC",sans-serif;background:#f6f7f9;margin:0}
main{max-width:560px;margin:24px auto;background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
h1{font-size:22px;margin:0 0 12px}
label{display:block;margin:6px 0 4px}
input,button{font-size:16px;padding:10px;border-radius:10px;border:1px solid #d3d7de;width:100%;box-sizing:border-box}
.btn{background:#3c8050;color:#fff;border:none;margin-top:10px;cursor:pointer}
.row{display:flex;gap:8px;align-items:center}
#registerBox{display:none}
.badge{display:inline-block;padding:4px 8px;border-radius:8px;background:#eef2f7;font-size:12px;margin-left:8px}
.err{color:#b8062e}
</style></head><body>
<main>
  <h1>LINE 登入健檢 & 註冊 <span id="role" class="badge"></span></h1>
  <div class="row">
    <button id="btnLogin" class="btn">登入 / 重新授權</button>
    <button id="btnLogout">登出</button>
  </div>
  <p id="status">初始化中…</p>

  <section id="registerBox">
    <h3>註冊資料（首次或補資料）</h3>
    <label>手機</label><input id="phone" placeholder="09xx-xxx-xxx"/>
    <label>學號（可留空）</label><input id="studentId" placeholder="S1234567"/>
    <label>科系（可留空）</label><input id="department" placeholder="資工系"/>
    <button id="btnRegister" class="btn">送出註冊</button>
  </section>

  <p style="margin-top:14px;"><a href="./booking.html">→ 直接前往預約</a></p>
</main>
<script>
const LIFF_ID  = '2006590746-gA7QALQX';
const API_BASE = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const $=id=>document.getElementById(id);
function mustJson(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

(async function init(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { $('status').textContent='未登入'; return; }

    $('status').textContent='已登入，檢查註冊…';
    const prof = await liff.getProfile();
    const chk  = await fetch(API_BASE + '?mode=check&userId=' + encodeURIComponent(prof.userId)).then(mustJson);

    if (chk.ok && chk.data && chk.data.registered) {
      // ✅ 已註冊 → 直接去預約
      location.href = './booking.html';
      return;
    }
    // 未註冊 → 顯示表單（送出後即會寫入 A=ID，I=role='user'）
    document.getElementById('registerBox').style.display = 'block';
    $('status').textContent='尚未註冊，請補資料後送出';
  } catch(e){
    $('status').textContent='失敗：'+(e.message||e);
  }
})();
</script>

</body></html>
