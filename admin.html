<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šç®¡ç†å¾Œå° v6.6.0 (Stable)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body{font-family:"Noto Sans TC",system-ui,sans-serif;background:#f8fafc;margin:0}
.section{display:none}
.section.active{display:block}
.card{background:#fff;border-radius:12px;padding:16px;margin:16px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.section-title{font-weight:800;font-size:18px;color:#14532d;margin-bottom:16px}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:8px;color:#fff;font-weight:600;opacity:0;transition:.3s}
.toast.show{opacity:1}
.toast.success{background:#22c55e}
.toast.error{background:#ef4444}
</style>
</head>

<body>

<div id="loading" class="fixed inset-0 flex items-center justify-center">
  <div class="text-xl">ğŸšŒ å¾Œå°è¼‰å…¥ä¸­...</div>
</div>

<div id="app" style="display:none">
  <section id="config" class="section active">
    <div class="card">
      <h2 class="section-title">âš™ï¸ ç³»çµ±è¨­å®š</h2>

      <label class="font-semibold">é ç´„é–‹æ”¾å¤©æ•¸</label>
      <input id="bookingDaysLimit" type="number" class="border p-2 w-full mb-3 rounded" />

      <label class="font-semibold">æœ€æ™šé ç´„æ™‚é–“ï¼ˆç•¶æ—¥ï¼‰</label>
      <input id="bookingDeadline" type="time" class="border p-2 w-full mb-3 rounded" />

      <label class="font-semibold">æœ€æ™šå–æ¶ˆæ™‚é–“ï¼ˆç•¶æ—¥ï¼‰</label>
      <input id="cancelDeadline" type="time" class="border p-2 w-full mb-3 rounded" />

      <label class="font-semibold">æ¸¬è©¦æ¨¡å¼</label>
      <input id="testMode" type="checkbox" class="mb-4" />

      <button id="saveRules" class="bg-green-600 text-white py-2 rounded w-full">
        ğŸ’¾ å„²å­˜è¨­å®š
      </button>

      <p id="ruleMeta" class="text-sm text-gray-500 mt-2"></p>
    </div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
/* ========= åŸºæœ¬è¨­å®š ========= */
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const LIFF_ID = '2006590746-wgL4l54z';

/* ========= å·¥å…· ========= */
function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className=`toast show ${type}`;
  setTimeout(()=>t.classList.remove('show'),3000);
}

/* ========= è¼‰å…¥è¨­å®šï¼ˆå”¯ä¸€ä¾†æºï¼‰ ========= */
async function loadRules(){
  const res = await fetch(`${WORKER_URL}?mode=getRules&_t=${Date.now()}`);
  const json = await res.json();
  const r = json.current || {};

  bookingDaysLimit.value = r.advanceBookingDays ?? '';
  bookingDeadline.value  = r.bookingDeadline ?? '';
  cancelDeadline.value   = r.cancelDeadline ?? '';
  testMode.checked       = Boolean(r.testMode);

  ruleMeta.textContent = `æœ€å¾Œæ›´æ–°ï¼š${r.lastUpdate || 'æœªçŸ¥'}`;
}

/* ========= å„²å­˜ + é©—è­‰ ========= */
saveRules.onclick = async () => {
  const body = {
    advanceBookingDays: Number(bookingDaysLimit.value),
    bookingDeadline: bookingDeadline.value,
    cancelDeadline: cancelDeadline.value,
    testMode: testMode.checked
  };

  try{
    /* å¯«å…¥ */
    const saveRes = await fetch(`${WORKER_URL}?mode=updateRules`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    const saveJson = await saveRes.json();
    if(saveJson.status!=='success') throw new Error('å„²å­˜å¤±æ•—');

    /* é‡æ–°è®€å–é©—è­‰ */
    const verifyRes = await fetch(`${WORKER_URL}?mode=getRules&_t=${Date.now()}`);
    const verify = (await verifyRes.json()).current || {};

    const ok =
      String(verify.bookingDeadline) === String(body.bookingDeadline) &&
      String(verify.cancelDeadline)  === String(body.cancelDeadline) &&
      Number(verify.advanceBookingDays) === Number(body.advanceBookingDays) &&
      Boolean(verify.testMode) === Boolean(body.testMode);

    if(!ok){
      console.error('âŒ é©—è­‰å¤±æ•—', {body, verify});
      showToast('âŒ è¨­å®šæœªæˆåŠŸå¯«å…¥','error');
      return;
    }

    showToast('âœ… è¨­å®šå·²æˆåŠŸå„²å­˜ä¸¦é©—è­‰');
    await loadRules();

  }catch(e){
    console.error(e);
    showToast('âŒ å„²å­˜å¤±æ•—','error');
  }
};

/* ========= åˆå§‹åŒ– ========= */
(async ()=>{
  await liff.init({liffId:LIFF_ID});
  if(!liff.isLoggedIn()) return liff.login();

  document.getElementById('loading').style.display='none';
  document.getElementById('app').style.display='block';
  await loadRules();
})();
</script>

</body>
</html>
