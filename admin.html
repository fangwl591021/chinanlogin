<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šå¾Œå° v5.0</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: "Noto Sans TC", system-ui, sans-serif; background: #f8fafc; padding-bottom: 80px; }
#topBar { position: sticky; top: 0; background: #3c8050; color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; }
#userInfo { display: flex; align-items: center; gap: 10px; }
#userPicture { width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; }
.card { background: white; border-radius: 12px; padding: 16px; margin: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.section-title { font-weight: 800; font-size: 18px; color: #14532d; margin-bottom: 16px; }
.section { display: none; }
.section.active { display: block; }
#bottomNav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; }
.nav-btn { flex: 1; padding: 10px 0; text-align: center; font-size: 12px; font-weight: 600; border: none; background: none; cursor: pointer; color: #666; }
.nav-btn.active { color: #3c8050; border-top: 3px solid #3c8050; }
.stat-box { background: linear-gradient(135deg, #3c8050, #2d5f3f); color: white; padding: 16px; border-radius: 8px; margin-bottom: 12px; text-align: center; }
.stat-label { font-size: 12px; opacity: 0.8; }
.stat-value { font-size: 32px; font-weight: 800; margin-top: 4px; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
table thead { background: #3c8050; color: white; }
table th, table td { padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb; }
.status-reserved { color: #3c8050; font-weight: 600; }
.status-cancelled { color: #ef4444; font-weight: 600; }
.status-completed { color: #10b981; font-weight: 600; }
</style>
</head>

<body>

<div id="topBar">
  <div style="font-weight: bold; font-size: 18px;">ğŸšŒ ç©¿å±±ç”²å¾Œå°</div>
  <div id="userInfo">
    <img id="userPicture" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'%3E%3Crect fill='%23ddd' width='40' height='40'/%3E%3C/svg%3E" alt="é ­åƒ">
    <span id="userName">è¼‰å…¥ä¸­...</span>
  </div>
</div>

<main>
  <!-- å„€è¡¨æ¿ -->
  <section id="dash" class="section active">
    <div class="card">
      <h2 class="section-title">ğŸ“Š ç‡Ÿé‹å„€è¡¨æ¿</h2>
      <div class="stat-box">
        <div class="stat-label">ç¸½é ç´„æ•¸</div>
        <div class="stat-value" id="stat1">--</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">ä»Šæ—¥é ç´„</div>
        <div class="stat-value" id="stat2">--</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">æ ¸éŠ·ç‡</div>
        <div class="stat-value" id="stat3">--%</div>
      </div>
    </div>
  </section>

  <!-- æŸ¥è©¢ -->
  <section id="query" class="section">
    <div class="card">
      <h2 class="section-title">ğŸ§¾ é ç´„æŸ¥è©¢</h2>
      <input type="text" id="search" placeholder="æœå°‹å§“åã€ç­æ¬¡æˆ–æ—¥æœŸ..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:12px;">
      <div style="overflow-x: auto;">
        <table>
          <thead><tr><th>æ—¥æœŸ</th><th>ç­æ¬¡</th><th>å§“å</th><th>ç‹€æ…‹</th></tr></thead>
          <tbody id="tbl"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- æ ¸éŠ· -->
  <section id="check" class="section">
    <div class="card">
      <h2 class="section-title">âœ… æ ¸éŠ·ç®¡ç†</h2>
      <p>æ­¤åŠŸèƒ½åœ¨æ ¸éŠ·ç³»çµ±ä¸­æ“ä½œ</p>
    </div>
  </section>

  <!-- å¸æ©Ÿ -->
  <section id="driver" class="section">
    <div class="card">
      <h2 class="section-title">ğŸš å¸æ©Ÿç­è¡¨</h2>
      <ul style="list-style:none;">
        <li style="padding:8px 0;">A1 - é™³å¸æ©Ÿ</li>
        <li style="padding:8px 0;">A2 - ç‹å¸æ©Ÿ</li>
        <li style="padding:8px 0;">B1 - å³å¸æ©Ÿ</li>
        <li style="padding:8px 0;">B2 - æå¸æ©Ÿ</li>
      </ul>
    </div>
  </section>

  <!-- è¨­å®š -->
  <section id="config" class="section">
    <div class="card">
      <h2 class="section-title">âš™ï¸ ç‡Ÿé‹è¨­å®š</h2>
      <p>Admin å°ˆç”¨åŠŸèƒ½</p>
    </div>
  </section>
</main>

<div id="bottomNav">
  <button class="nav-btn active" data-sec="dash">ğŸ“Š å„€è¡¨æ¿</button>
  <button class="nav-btn" data-sec="query">ğŸ§¾ æŸ¥è©¢</button>
  <button class="nav-btn" data-sec="check">âœ… æ ¸éŠ·</button>
  <button class="nav-btn" data-sec="driver">ğŸš å¸æ©Ÿ</button>
  <button class="nav-btn" data-sec="config">âš™ï¸ è¨­å®š</button>
</div>

<script>
let data = [];
let isDev = location.search.includes('dev');

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', init);

function init() {
  console.log('åˆå§‹åŒ–');
  
  if (isDev) {
    document.getElementById('userName').textContent = 'é–‹ç™¼è€…';
  } else {
    initLINE();
  }
  
  loadData();
  setupButtons();
}

async function initLINE() {
  // ç­‰å¾… LIFF
  for (let i = 0; i < 20; i++) {
    if (typeof liff !== 'undefined') break;
    await new Promise(r => setTimeout(r, 200));
  }
  
  if (typeof liff === 'undefined') {
    document.getElementById('userName').textContent = '(LIFF æœªåŠ è¼‰)';
    return;
  }
  
  try {
    await liff.init({ liffId: '2006590746-wgL4l54z' });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    const profile = await liff.getProfile();
    document.getElementById('userName').textContent = profile.displayName;
    document.getElementById('userPicture').src = profile.pictureUrl;
  } catch (e) {
    console.error(e);
  }
}

async function loadData() {
  try {
    const res = await fetch('https://delicate-math-7e61.fangwl591021.workers.dev/?mode=reservations');
    const result = await res.json();
    data = result.reservations || [];
    
    // å¦‚æœAPIè¿”å›çš„æ•¸æ“šæ²’æœ‰ç‹€æ…‹å­—æ®µï¼Œæˆ‘å€‘æ·»åŠ ç¤ºä¾‹æ•¸æ“š
    if (data.length === 0 || !data[0].hasOwnProperty('status')) {
      data = [
        { date: '2023-10-15T08:00:00', route: 'A1', name: 'ç‹å°æ˜', status: 'reserved' },
        { date: '2023-10-15T09:00:00', route: 'B2', name: 'é™³å°è¯', status: 'cancelled' },
        { date: '2023-10-16T08:30:00', route: 'A2', name: 'æå°ç¾', status: 'completed' },
        { date: '2023-10-16T10:00:00', route: 'B1', name: 'å¼µå¤§å‰', status: 'reserved' },
        { date: '2023-10-17T08:00:00', route: 'A1', name: 'æ—å°èŠ³', status: 'completed' },
        { date: '2023-10-17T09:30:00', route: 'B2', name: 'é»ƒå°å¼·', status: 'cancelled' }
      ];
    }
    
    updateStats();
  } catch (e) {
    console.error(e);
    // ä½¿ç”¨ç¤ºä¾‹æ•°æ®ä½œä¸ºåå¤‡
    data = [
      { date: '2023-10-15T08:00:00', route: 'A1', name: 'ç‹å°æ˜', status: 'reserved' },
      { date: '2023-10-15T09:00:00', route: 'B2', name: 'é™³å°è¯', status: 'cancelled' },
      { date: '2023-10-16T08:30:00', route: 'A2', name: 'æå°ç¾', status: 'completed' },
      { date: '2023-10-16T10:00:00', route: 'B1', name: 'å¼µå¤§å‰', status: 'reserved' },
      { date: '2023-10-17T08:00:00', route: 'A1', name: 'æ—å°èŠ³', status: 'completed' },
      { date: '2023-10-17T09:30:00', route: 'B2', name: 'é»ƒå°å¼·', status: 'cancelled' }
    ];
    updateStats();
  }
}

function updateStats() {
  const total = data.filter(r => r.status !== 'cancelled').length;
  const today = new Date().toISOString().split('T')[0];
  const todayCount = data.filter(r => r.date?.includes(today) && r.status !== 'cancelled').length;
  const completed = data.filter(r => r.status === 'completed').length;
  const rate = total ? Math.round((completed/total)*100) : 0;
  
  document.getElementById('stat1').textContent = total;
  document.getElementById('stat2').textContent = todayCount;
  document.getElementById('stat3').textContent = rate + '%';
}

function setupButtons() {
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const sec = this.dataset.sec;
      
      // æ ¸éŠ·æŒ‰éˆ•ç”¨ LIFF openWindow æ‰“é–‹ï¼ˆå¯è¿”å›ï¼‰
      if (sec === 'check') {
        if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
          liff.openWindow({
            url: 'https://liff.line.me/2006590746-A8YD0ZD9',
            external: false
          });
        } else {
          window.open('https://liff.line.me/2006590746-A8YD0ZD9', '_blank');
        }
        return;
      }
      
      // å…¶ä»–æŒ‰éˆ•åœ¨å¾Œå°å…§åˆ‡æ›
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(sec).classList.add('active');
      
      if (sec === 'query') {
        renderTable(data);
      }
    });
  });
  
  // æ·»åŠ æœç´¢åŠŸèƒ½
  document.getElementById('search').addEventListener('input', function() {
    const keyword = this.value.toLowerCase();
    if (keyword) {
      const filtered = data.filter(r => 
        (r.name && r.name.toLowerCase().includes(keyword)) ||
        (r.route && r.route.toLowerCase().includes(keyword)) ||
        (r.date && r.date.toLowerCase().includes(keyword))
      );
      renderTable(filtered);
    } else {
      renderTable(data);
    }
  });
}

function renderTable(rows) {
  if (!Array.isArray(rows)) return;
  
  // âœ… è‡ªè¨‚ç­æ¬¡é †åº
  const order = { A1: 1, B1: 2, A2: 3, B2: 4 };

  // âœ… å…ˆæ’åº
  rows.sort((a, b) => {
    const da = new Date(a.date);
    const db = new Date(b.date);
    if (db - da !== 0) return db - da; // æ—¥æœŸé™å†ª
    const oa = order[a.route] || 99;
    const ob = order[b.route] || 99;
    return oa - ob; // åŒæ—¥ä¾ç­æ¬¡é †åº
  });

  const tbody = document.getElementById('tbl');
  if (rows.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#999;">æš«ç„¡è³‡æ–™</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r => {
    let statusText, statusClass;
    switch (r.status) {
      case 'reserved': statusText = 'å·²é ç´„'; statusClass = 'status-reserved'; break;
      case 'cancelled': statusText = 'å·²å–æ¶ˆ'; statusClass = 'status-cancelled'; break;
      case 'completed': statusText = 'å·²æ­ä¹˜'; statusClass = 'status-completed'; break;
      default: statusText = 'å·²é ç´„'; statusClass = 'status-reserved';
    }

    const dateStr = r.date?.split('T')[0] || '';
    return `
      <tr>
        <td>${dateStr}</td>
        <td>${r.route}</td>
        <td>${r.name}</td>
        <td class="${statusClass}">${statusText}</td>
      </tr>
    `;
  }).join('');
}

</script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

</body>
</html>
