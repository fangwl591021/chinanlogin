<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>穿山甲專車後台 v4.1 (Mobile)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: "Noto Sans TC", system-ui, sans-serif; background: #f0fdf4; color: #334155; }
.card { background:white; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,0.08); margin:16px; padding:20px; }
.tab-btn { flex-1 text-center py-2 text-sm font-semibold text-gray-500; }
.tab-btn.active { color:#3c8050; font-weight:700; }
footer { position:fixed; bottom:0; left:0; right:0; background:white; border-top:1px solid #e5e7eb; display:flex; }
button { border-radius:10px; padding:10px 14px; font-weight:600; }
</style>
</head>
<body class="pb-16">

<!-- 🏷️ 首頁 -->
<section id="tab-home" class="card">
  <h2 class="text-xl font-bold text-green-700 mb-2">🚌 穿山甲專車後台</h2>
  <p class="text-gray-600 mb-2">歡迎使用後台系統</p>
  <p>帳號角色：<span id="userRole" class="font-semibold text-green-700">載入中...</span></p>
  <p>ID：<span id="userIdText" class="text-sm text-gray-500"></span></p>
  <div id="homeNotice" class="mt-4 text-gray-700"></div>
</section>

<!-- ⚙️ 系統設定 -->
<section id="tab-config" class="card hidden">
  <h2 class="text-lg font-bold text-green-700 mb-3">⚙️ 系統設定</h2>
  <div class="space-y-3">
    <label><input type="checkbox" id="testMode" class="mr-1"> 啟用測試模式</label><br>
    <label><input type="radio" name="bookingMode" value="single" checked> 單程制</label>
    <label class="ml-4"><input type="radio" name="bookingMode" value="roundtrip"> 來回制</label>
  </div>
  <textarea id="announcement" class="border rounded w-full p-2 mt-4" rows="3">歡迎使用穿山甲專車預約系統！</textarea>
  <div class="grid grid-cols-3 gap-2 mt-4">
    <button id="saveConfig" class="bg-green-600 text-white">💾 儲存</button>
    <button id="publishConfig" class="bg-blue-600 text-white">🚀 發佈</button>
    <button id="testPush" class="bg-yellow-500 text-white">📢 測試推播</button>
  </div>
</section>

<!-- 📊 儀表板 -->
<section id="tab-dashboard" class="card hidden">
  <h2 class="text-lg font-bold text-green-700 mb-2">📊 營運儀表板</h2>
  <p>此功能即將上線。</p>
</section>

<!-- 🚐 核銷作業 -->
<section id="tab-checkin" class="card hidden">
  <h2 class="text-lg font-bold text-green-700 mb-3">🚐 今日核銷作業</h2>
  <div id="checkinList" class="space-y-2 text-gray-700">載入中...</div>
</section>

<!-- ⚠️ 無權限畫面 -->
<section id="tab-deny" class="card hidden text-center">
  <h2 class="text-xl font-bold text-red-600 mb-2">⚠️ 無後台權限</h2>
  <p>您目前為一般乘客身分，無法使用後台功能。</p>
</section>

<!-- 📱 底部導覽列 -->
<footer id="footerNav">
  <button class="tab-btn active" data-target="home">🏠 首頁</button>
  <button class="tab-btn" data-target="config">🧭 設定</button>
  <button class="tab-btn" data-target="dashboard">📊 儀表</button>
  <button class="tab-btn" data-target="checkin">🚐 核銷</button>
</footer>

<script>
const WORKER_URL = "https://delicate-math-7e61.fangwl591021.workers.dev/";
let role = "user";
let userId = "";

/* ========= 初始化 LIFF ========= */
document.addEventListener('DOMContentLoaded', async () => {
  await liff.init({ liffId: "2006590746-E8P6Yg3v" }).catch(console.error);
  const profile = await liff.getProfile();
  userId = profile.userId;
  document.getElementById('userIdText').textContent = userId;
  await checkUserRole(userId);
  setupNav();
});

/* ========= 角色檢查 ========= */
async function checkUserRole(userId) {
  try {
    const res = await fetch(`${WORKER_URL}?mode=checkRole&userId=${userId}`);
    const data = await res.json();
    role = data.role || "user";
    document.getElementById('userRole').textContent = role;
    renderUIByRole(role);
  } catch {
    document.getElementById('userRole').textContent = "查詢失敗";
  }
}

/* ========= 根據角色顯示頁面 ========= */
function renderUIByRole(r) {
  const adminTabs = ["home","config","dashboard","checkin"];
  const driverTabs = ["home","checkin"];
  const userTabs = ["home","deny"];
  let visibleTabs = userTabs;
  if (r === "admin") visibleTabs = adminTabs;
  else if (r === "driver") visibleTabs = driverTabs;

  // 顯示可用 tab
  document.querySelectorAll('section[id^="tab-"]').forEach(sec => sec.classList.add('hidden'));
  document.getElementById('tab-home').classList.remove('hidden');
  if (r === "user") document.getElementById('tab-deny').classList.remove('hidden');

  // 底部導覽列按鈕可見性
  document.querySelectorAll('footer .tab-btn').forEach(btn => {
    const show = visibleTabs.includes(btn.dataset.target);
    btn.style.display = show ? 'block' : 'none';
  });
}

/* ========= 導覽切換 ========= */
function setupNav() {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset.target;
      document.querySelectorAll('section[id^="tab-"]').forEach(sec => {
        sec.id === 'tab-' + target ? sec.classList.remove('hidden') : sec.classList.add('hidden');
      });
    };
  });

  document.getElementById('saveConfig').onclick = saveConfig;
  document.getElementById('publishConfig').onclick = publishConfig;
  document.getElementById('testPush').onclick = sendTestPush;
}

/* ========= 設定操作 ========= */
let config = { testMode:false, bookingMode:'single', announcement:'' };
function saveConfig() {
  config.testMode = document.getElementById('testMode').checked;
  config.bookingMode = document.querySelector('input[name="bookingMode"]:checked').value;
  config.announcement = document.getElementById('announcement').value;
  localStorage.setItem('pangolinAdminConfig', JSON.stringify(config));
  showMsg('✅ 設定已儲存');
}
async function publishConfig() {
  saveConfig();
  await fetch(WORKER_URL + '?mode=updateRules', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(config) });
  showMsg('🚀 已發佈設定');
}
async function sendTestPush() {
  await fetch(WORKER_URL + '?mode=testPush');
  showMsg('📢 測試推播已發送');
}

/* ========= 通用提示 ========= */
function showMsg(msg) {
  const div = document.createElement('div');
  div.textContent = msg;
  div.className = "fixed bottom-20 left-1/2 -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded-xl shadow";
  document.body.appendChild(div);
  setTimeout(()=>div.remove(),2000);
}
</script>
</body>
</html>
