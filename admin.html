<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šå¾Œå° v6.4</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family:"Noto Sans TC",system-ui,sans-serif;background:#f8fafc;margin:0; }
#loadingScreen,#loginScreen,#noAuthScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#f8fafc;flex-direction:column;text-align:center;}
#loginScreen,#noAuthScreen{display:none;}
#app{display:none;}
#topBar{position:sticky;top:0;background:#3c8050;color:white;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;z-index:100;}
#userInfo{display:flex;align-items:center;gap:10px;}
#userPicture{width:40px;height:40px;border-radius:50%;border:2px solid white;}
.nav-btn{flex:1;padding:10px 0;text-align:center;font-size:12px;font-weight:600;cursor:pointer;color:#666;}
.nav-btn.active{color:#3c8050;border-top:3px solid #3c8050;}
.section{display:none;}
.section.active{display:block;}
.card{background:white;border-radius:12px;padding:16px;margin:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.section-title{font-weight:800;font-size:18px;color:#14532d;margin-bottom:16px;}
#bottomNav{position:fixed;bottom:0;left:0;width:100%;background:white;border-top:1px solid #ddd;display:flex;justify-content:space-around;z-index:50;}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:8px;color:white;font-weight:600;box-shadow:0 2px 6px rgba(0,0,0,0.2);opacity:0;transition:opacity .3s ease;z-index:999;}
.toast.show{opacity:1;}
.toast.success{background:#22c55e;}
.toast.error{background:#ef4444;}
.status-ok{color:#16a34a;font-weight:bold;}
.status-cancel{color:#dc2626;font-weight:bold;}
.status-wait{color:#ca8a04;font-weight:bold;}
/* å„ªåŒ–è¡¨æ ¼æ¨£å¼ */
.data-table{width:100%;font-size:13px;border-collapse:collapse;}
.data-table th{background:#3c8050;color:white;padding:8px 6px;text-align:left;font-weight:600;position:sticky;top:0;}
.data-table td{padding:8px 6px;border-bottom:1px solid #e5e7eb;}
.data-table tr:hover{background:#f0fdf4;}
/* è®“æ—¥æœŸæ¬„ä½çª„ä¸€é» */
.col-date{width:80px;white-space:nowrap;}
.col-route{width:130px;}
.col-name{width:auto;min-width:80px;}
.col-status{width:60px;text-align:center;}
</style>
</head>

<body>
<!-- ğŸŒ€ è¼‰å…¥ç•«é¢ -->
<div id="loadingScreen">
  <div class="animate-pulse text-center">
    <div class="text-3xl mb-3">ğŸšŒ ç©¿å±±ç”²å¾Œå°è¼‰å…¥ä¸­...</div>
    <div>è«‹ç¨å€™é©—è­‰æ‚¨çš„èº«åˆ†</div>
  </div>
</div>

<!-- ğŸ” ç™»å…¥æç¤º -->
<div id="loginScreen">
  <div class="text-5xl mb-4">ğŸ”</div>
  <div class="text-2xl font-bold text-green-800 mb-2">å°šæœªç™»å…¥</div>
  <p class="text-gray-600 mb-4">è«‹å…ˆç™»å…¥æ‚¨çš„ LINE å¸³è™Ÿä»¥ä½¿ç”¨å¾Œå°ç³»çµ±ã€‚</p>
  <button id="loginButton" class="bg-green-700 text-white px-6 py-3 rounded-lg text-lg font-bold">ğŸ“± é»æ­¤ç™»å…¥</button>
  <p class="text-sm text-gray-500 mt-4">è«‹åœ¨ LINE App ä¸­é–‹å•Ÿæ­¤é é¢</p>
</div>

<!-- ğŸš« ç„¡æ¬Šé™ç•«é¢ -->
<div id="noAuthScreen">
  <div class="text-5xl mb-4">ğŸš«</div>
  <div class="text-2xl font-bold text-red-800 mb-2">ç„¡æ¬Šé™ä½¿ç”¨æ­¤é é¢</div>
  <p class="text-gray-600 mb-4">è«‹ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥æˆ–è¯çµ¡ç³»çµ±ç®¡ç†å“¡ã€‚</p>
  <div id="debugInfo" class="text-sm text-left bg-gray-100 p-4 rounded mb-4 max-w-md"></div>
  <button id="reLogin" class="bg-gray-600 text-white px-6 py-3 rounded-lg">é‡æ–°ç™»å…¥</button>
</div>

<!-- ğŸ› ä¸»ç•«é¢ -->
<div id="app">
  <div id="topBar">
    <div id="userInfo">
      <img id="userPicture" src="" alt="é ­åƒ"/>
      <span id="userName">è¼‰å…¥ä¸­...</span>
    </div>
    <button id="logoutBtn" class="bg-red-600 px-3 py-1 rounded text-sm">ç™»å‡º</button>
  </div>

  <main style="padding-bottom:80px;">
    <!-- ğŸ“Š å„€è¡¨æ¿ -->
    <section id="dashboard" class="section active">
      <div class="card">
        <h2 class="section-title">ğŸ“Š ä»Šæ—¥çµ±è¨ˆ</h2>
        <div class="grid grid-cols-3 gap-3 text-center">
          <div class="bg-green-50 p-3 rounded">
            <div class="text-2xl font-bold text-green-700" id="todayCount">-</div>
            <div class="text-xs text-gray-600">ä»Šæ—¥é ç´„</div>
          </div>
          <div class="bg-red-50 p-3 rounded">
            <div class="text-2xl font-bold text-red-700" id="cancelCount">-</div>
            <div class="text-xs text-gray-600">å·²å–æ¶ˆ</div>
          </div>
          <div class="bg-blue-50 p-3 rounded">
            <div class="text-2xl font-bold text-blue-700" id="checkinCount">-</div>
            <div class="text-xs text-gray-600">å·²æ ¸éŠ·</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ğŸ§¾ æŸ¥è©¢ -->
    <section id="query" class="section">
      <div class="card">
        <div class="flex justify-between items-center mb-3">
          <h2 class="section-title mb-0">ğŸ§¾ é ç´„æŸ¥è©¢</h2>
          <button id="refreshBtn" class="bg-green-600 text-white px-3 py-1 rounded text-sm font-bold hover:bg-green-700 transition flex items-center gap-1">
            <span id="refreshIcon">ğŸ”„</span>
            <span>é‡æ–°æ•´ç†</span>
          </button>
        </div>
        <input
          id="search"
          type="text"
          placeholder="æœå°‹å§“åã€ç­æ¬¡æˆ–æ—¥æœŸ..."
          class="border border-gray-300 rounded px-3 py-2 w-full mb-3 focus:outline-none focus:ring-2 focus:ring-green-600"
        />
        <div style="overflow-x:auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th class="col-date">æ—¥æœŸ</th>
                <th class="col-route">ç­æ¬¡</th>
                <th class="col-name">å§“å</th>
                <th class="col-status">ç‹€æ…‹</th>
              </tr>
            </thead>
            <tbody id="tbl"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ğŸ“‹ æ ¸éŠ· -->
    <section id="checkin" class="section">
      <div class="card text-center">
        <h2 class="section-title">ğŸ“‹ æ ¸éŠ·ç®¡ç†</h2>
        <button id="goCheckin" class="bg-green-600 text-white px-4 py-3 rounded w-full text-lg">å‰å¾€æ ¸éŠ·ç³»çµ±</button>
        <p class="text-gray-500 mt-2 text-sm">é–‹å•Ÿ LIFFï¼š2006590746-G7B12a1K</p>
      </div>
    </section>

    <!-- ğŸš å¸æ©Ÿ -->
    <section id="driver" class="section">
      <div class="card">
        <h2 class="section-title">ğŸš å¸æ©Ÿç­è¡¨</h2>
        <ul class="list-disc ml-6 text-gray-700">
          <li>A1ï¼šé™³å¸æ©Ÿ</li><li>B1ï¼šæ—å¸æ©Ÿ</li><li>A2ï¼šç‹å¸æ©Ÿ</li><li>B2ï¼šå³å¸æ©Ÿ</li>
        </ul>
      </div>
    </section>

    <!-- âš™ï¸ è¨­å®š -->
    <section id="config" class="section">
      <div class="card">
        <h2 class="section-title">âš™ï¸ ç³»çµ±è¨­å®š</h2>
        <label class="block mb-2">æ¯ç­æ¬¡æ­è¼‰äººæ•¸ä¸Šé™</label>
        <input id="seatLimit" type="number" class="border p-2 w-full mb-3 rounded" />
        <label class="block mb-2">æœªæ ¸éŠ·é”å¹¾æ¬¡å¾Œç¦ç”¨</label>
        <input id="maxNoShow" type="number" class="border p-2 w-full mb-3 rounded" />
        <label class="block mb-2">ç¦ç”¨é€±æ•¸</label>
        <input id="banWeeks" type="number" class="border p-2 w-full mb-3 rounded" />
        <label class="block mb-2">é ç´„æ¨¡å¼</label>
        <select id="tripMode" class="border p-2 w-full mb-3 rounded">
          <option value="single">å–®ç¨‹</option>
          <option value="round">å¯ä¾†å›</option>
        </select>
        <button id="saveRules" class="bg-green-600 text-white font-bold py-2 px-4 rounded w-full">ğŸ’¾ å„²å­˜è¨­å®š</button>
        <p id="ruleMeta" class="text-gray-500 text-sm mt-3"></p>
      </div>
    </section>
  </main>

  <div id="bottomNav">
    <div class="nav-btn active" data-sec="dashboard">ğŸ“Š å„€è¡¨æ¿</div>
    <div class="nav-btn" data-sec="query">ğŸ§¾ æŸ¥è©¢</div>
    <div class="nav-btn" data-sec="checkin">ğŸ“‹ æ ¸éŠ·</div>
    <div class="nav-btn" data-sec="driver">ğŸš å¸æ©Ÿ</div>
    <div class="nav-btn" data-sec="config">âš™ï¸ è¨­å®š</div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const WORKER_URL='https://delicate-math-7e61.fangwl591021.workers.dev/';
const LIFF_ID = '2006590746-wgL4l54z';
let allData=[];

// âœ… æ–°å¢ï¼šæ ¼å¼åŒ–æ—¥æœŸå‡½æ•¸
function formatDate(dateStr) {
  if (!dateStr) return '-';
  
  // è™•ç†å„ç¨®å¯èƒ½çš„æ—¥æœŸæ ¼å¼
  try {
    // å¦‚æœæ˜¯ ISO æ ¼å¼æˆ–åŒ…å«æ™‚é–“çš„æ ¼å¼
    if (dateStr.includes('T') || dateStr.includes(' ')) {
      const d = new Date(dateStr);
      if (!isNaN(d.getTime())) {
        // åªå›å‚³å¹´æœˆæ—¥
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }
    }
    
    // å¦‚æœå·²ç¶“æ˜¯ YYYY-MM-DD æ ¼å¼
    if (/^\d{4}-\d{2}-\d{2}/.test(dateStr)) {
      return dateStr.substring(0, 10);
    }
    
    // å›å‚³åŸå§‹å­—ä¸²çš„å‰10å€‹å­—å…ƒ
    return dateStr.substring(0, 10);
  } catch (e) {
    console.warn('æ—¥æœŸæ ¼å¼åŒ–å¤±æ•—:', dateStr, e);
    return dateStr;
  }
}

// âœ… æ–°å¢ï¼šç°¡åŒ–è·¯ç·šé¡¯ç¤º
function formatRoute(routeStr) {
  if (!routeStr) return '-';
  
  // å¦‚æœåŒ…å« "|"ï¼Œåªå–å‰é¢çš„ç­æ¬¡ä»£ç¢¼
  if (routeStr.includes('|')) {
    const parts = routeStr.split('|');
    return parts[0].trim(); // ä¾‹å¦‚ "A1" æˆ– "B2"
  }
  
  return routeStr;
}

async function init(){
  try{
    console.log('ğŸ” é–‹å§‹åˆå§‹åŒ– LIFF...');
    await liff.init({liffId:LIFF_ID});
    console.log('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ');
    
    if(!liff.isLoggedIn()){
      console.log('ğŸ” ç”¨æˆ¶æœªç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥ç•«é¢');
      document.getElementById('loadingScreen').style.display='none';
      document.getElementById('loginScreen').style.display='flex';
      return;
    }

    const profile=await liff.getProfile();
    console.log('ğŸ‘¤ ç”¨æˆ¶è³‡æ–™:', profile);
    
    console.log('ğŸ”‘ æ­£åœ¨æª¢æŸ¥ç”¨æˆ¶æ¬Šé™...');
    let checkUrl = `${WORKER_URL}?mode=check&userId=${profile.userId}`;
    console.log('ğŸ“¡ è«‹æ±‚ URL:', checkUrl);
    
    let checkRes = await fetch(checkUrl);
    console.log('ğŸ“¡ check å›æ‡‰ç‹€æ…‹:', checkRes.status);
    
    let userData = await checkRes.json();
    console.log('ğŸ¯ check çµæœ:', userData);

    let isAdmin = false;
    let debugMsg = '';
    
    if (userData.registered && userData.user) {
      console.log('âœ“ ç”¨æˆ¶å·²è¨»å†Š');
      console.log('- userId:', userData.user.userId);
      console.log('- name:', userData.user.name);
      console.log('- isAdmin:', userData.user.isAdmin);
      
      const adminValue = userData.user.isAdmin;
      if (adminValue === true || 
          adminValue === 'TRUE' || 
          adminValue === 'true' ||
          adminValue === 1 || 
          adminValue === '1' ||
          adminValue === 'admin') {
        isAdmin = true;
        console.log('âœ… ç”¨æˆ¶æ˜¯ç®¡ç†å“¡');
      } else {
        console.log('âŒ ç”¨æˆ¶ä¸æ˜¯ç®¡ç†å“¡');
        debugMsg = `isAdmin æ¬„ä½å€¼: ${JSON.stringify(adminValue)}`;
      }
    } else {
      console.log('âŒ ç”¨æˆ¶æœªè¨»å†Šæˆ–è³‡æ–™ä¸å®Œæ•´');
      debugMsg = `ç”¨æˆ¶ç‹€æ…‹ï¼š${userData.registered ? 'å·²è¨»å†Šä½†è³‡æ–™ä¸å®Œæ•´' : 'æœªè¨»å†Š'}`;
    }

    if (!isAdmin) {
      console.log('ğŸš« ç”¨æˆ¶ç„¡ç®¡ç†å“¡æ¬Šé™');
      document.getElementById('loadingScreen').style.display='none';
      document.getElementById('noAuthScreen').style.display='flex';
      document.getElementById('debugInfo').innerHTML = `
        <strong>é™¤éŒ¯è³‡è¨Šï¼š</strong><br>
        ç”¨æˆ¶åç¨±ï¼š${profile.displayName}<br>
        ç”¨æˆ¶ IDï¼š${profile.userId}<br>
        ç”¨æˆ¶ç‹€æ…‹ï¼š${userData.registered ? 'æœªè¨»å†Š' : 'æœªè¨»å†Š'}<br>
        ${debugMsg}
      `;
      return;
    }

    console.log('âœ… æ¬Šé™é©—è­‰é€šé');
    document.getElementById('loadingScreen').style.display='none';
    document.getElementById('app').style.display='block';
    document.getElementById('userName').textContent = profile.displayName + ' (ç®¡ç†å“¡)';
    document.getElementById('userPicture').src = profile.pictureUrl;

    setupNav();

    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById('dashboard').classList.add('active');

    setTimeout(async()=>{
      await loadReservations();
      await loadRules();
      await loadDashboardStats();
    },500);

  }catch(e){
    console.error('âŒ åˆå§‹åŒ–éŒ¯èª¤:', e);
    showToast('âš ï¸ åˆå§‹åŒ–éŒ¯èª¤','error');
  }
}

document.getElementById('loginButton').addEventListener('click',()=>liff.login());
document.getElementById('reLogin').addEventListener('click',()=>liff.login());
document.getElementById('logoutBtn').addEventListener('click',()=>{liff.logout();location.reload();});

function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className=`toast show ${type}`;
  setTimeout(()=>t.classList.remove('show'),3000);
}

async function loadDashboardStats(){
  try{
    const res=await fetch(`${WORKER_URL}?mode=dashboard`);
    const data=await res.json();
    document.getElementById('todayCount').textContent=data.dashboard?.todayCount||'-';
    document.getElementById('cancelCount').textContent=data.dashboard?.cancelCount||'-';
    document.getElementById('checkinCount').textContent=data.dashboard?.checkinCount||'-';
  }catch(e){console.warn('çµ±è¨ˆè³‡æ–™è¼‰å…¥å¤±æ•—');}
}

async function loadReservations() {
  const tbody = document.getElementById('tbl');
  // âœ… åŠ å…¥æ›´æ˜é¡¯çš„ loading å‹•ç•«
  tbody.innerHTML = `
    <tr>
      <td colspan="4" class="p-6 text-center">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mb-2"></div>
        <div class="text-gray-600 font-medium">ğŸ”„ æ­£åœ¨é‡æ–°è¼‰å…¥è³‡æ–™...</div>
      </td>
    </tr>
  `;

  try {
    console.log('ğŸš€ é–‹å§‹è¼‰å…¥é ç´„è³‡æ–™...');
    const res = await fetch(`${WORKER_URL}?mode=allReservations`);
    console.log('âœ… è«‹æ±‚å®Œæˆï¼Œç‹€æ…‹:', res.status);
    
    const json = await res.json();
    console.log('ğŸ“Š æ”¶åˆ°å›æ‡‰:', json);

    if (!res.ok || json.status === 'error' || !json.ok) {
      throw new Error(json.message || json.error || 'Worker å›æ‡‰éŒ¯èª¤');
    }

    const list = json.reservations || [];

    if (!Array.isArray(list)) {
      throw new Error('è³‡æ–™æ ¼å¼éŒ¯èª¤');
    }

    if (list.length === 0) {
      tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-400">ç›®å‰æ²’æœ‰é ç´„è³‡æ–™</td></tr>`;
      return;
    }

    // âœ… å„ªåŒ–ï¼šæ ¼å¼åŒ–æ—¥æœŸå’Œè·¯ç·š
    const data = list.map(r => ({
      date: formatDate(r.date),           // åªé¡¯ç¤ºå¹´æœˆæ—¥
      route: formatRoute(r.route),        // åªé¡¯ç¤ºç­æ¬¡ä»£ç¢¼
      name: r.name || '',
      status: r.status || ''
    }));

    const validData = data.filter(r => r.date || r.route || r.name || r.status);

    if (validData.length === 0) {
      tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-400">ç›®å‰æ²’æœ‰æœ‰æ•ˆçš„é ç´„è³‡æ–™</td></tr>`;
      return;
    }

    const order = { A1: 1, A2: 2, B1: 3, B2: 4 };
    validData.sort((a, b) => {
      if (a.date < b.date) return 1;
      if (a.date > b.date) return -1;
      const routeA = a.route.split(' ')[0]; // æå– "A1" ç­‰
      const routeB = b.route.split(' ')[0];
      return (order[routeA] || 99) - (order[routeB] || 99);
    });

    renderTable(validData);
    allData = validData;
    showToast(`âœ… è¼‰å…¥ ${validData.length} ç­†é ç´„è³‡æ–™`);
    
  } catch (e) {
    console.error('âŒ å¾Œå°æŸ¥è©¢éŒ¯èª¤', e);
    tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">âŒ æŸ¥è©¢å¤±æ•—ï¼š${e.message}</td></tr>`;
    showToast('âŒ è¼‰å…¥é ç´„è³‡æ–™å¤±æ•—', 'error');
  }
}

function renderTable(data) {
  const tbody = document.getElementById('tbl');

  if (!data || !Array.isArray(data) || data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-400">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„</td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(r => {
    const cls = r.status && r.status.includes('å–æ¶ˆ')
      ? 'status-cancel'
      : r.status && r.status.includes('æ­ä¹˜')
      ? 'status-ok'
      : 'status-wait';
    
    return `
      <tr>
        <td class="col-date">${r.date || '-'}</td>
        <td class="col-route">${r.route || '-'}</td>
        <td class="col-name">${r.name || '-'}</td>
        <td class="col-status ${cls}">${r.status || '-'}</td>
      </tr>`;
  }).join('');
}

document.getElementById('search').addEventListener('input', e => {
  const k = e.target.value.trim().toLowerCase();
  
  if (!allData || !Array.isArray(allData)) {
    renderTable([]);
    return;
  }
  
  const filtered = allData.filter(r =>
    (r.name && r.name.toLowerCase().includes(k)) ||
    (r.route && r.route.toLowerCase().includes(k)) ||
    (r.date && r.date.includes(k))
  );
  renderTable(filtered);
});

async function loadRules(){
  try {
    const res = await fetch(`${WORKER_URL}?mode=getRules`);
    if (!res.ok) throw new Error('ç„¡æ³•å–å¾—è¦å‰‡');
    const data = await res.json();
    if (data.ok && data.rules) {
      document.getElementById('seatLimit').value = data.rules.seatLimit || 15;
      document.getElementById('maxNoShow').value = data.rules.maxNoShow || 3;
      document.getElementById('banWeeks').value = data.rules.banWeeks || 2;
      document.getElementById('tripMode').value = data.rules.tripMode || 'single';
    }
  } catch (e) {
    console.warn('è¦å‰‡è¼‰å…¥å¤±æ•—:', e);
  }
}

document.getElementById('saveRules').addEventListener('click', async () => {
  try {
    const rules = {
      seatLimit: parseInt(document.getElementById('seatLimit').value),
      maxNoShow: parseInt(document.getElementById('maxNoShow').value),
      banWeeks: parseInt(document.getElementById('banWeeks').value),
      tripMode: document.getElementById('tripMode').value
    };
    
    const res = await fetch(`${WORKER_URL}?mode=updateRules`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(rules)
    });
    
    if (!res.ok) throw new Error('æ›´æ–°å¤±æ•—');
    showToast('âœ… è¨­å®šå·²å„²å­˜', 'success');
  } catch (e) {
    console.error('å„²å­˜å¤±æ•—:', e);
    showToast('âŒ å„²å­˜å¤±æ•—', 'error');
  }
});

document.getElementById('goCheckin').addEventListener('click', () => {
  liff.openWindow({
    url: 'https://liff.line.me/2006590746-G7B12a1K',
    external: false
  });
});

// âœ… é‡æ–°æ•´ç†æŒ‰éˆ•
document.getElementById('refreshBtn').addEventListener('click', async () => {
  const icon = document.getElementById('refreshIcon');
  const btn = document.getElementById('refreshBtn');
  
  // æŒ‰éˆ•ç¦ç”¨ä¸¦é¡¯ç¤ºè¼‰å…¥ä¸­
  btn.disabled = true;
  btn.classList.add('opacity-50', 'cursor-not-allowed');
  icon.classList.add('inline-block', 'animate-spin');
  
  try {
    await loadReservations();
  } finally {
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    btn.disabled = false;
    btn.classList.remove('opacity-50', 'cursor-not-allowed');
    icon.classList.remove('inline-block', 'animate-spin');
  }
});

function setupNav() {
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const target = btn.getAttribute('data-sec');
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(target).classList.add('active');
      
      // âœ… ç•¶åˆ‡æ›åˆ°æŸ¥è©¢åˆ†é æ™‚ï¼Œé‡æ–°è¼‰å…¥è³‡æ–™
      if (target === 'query') {
        console.log('ğŸ”„ åˆ‡æ›åˆ°æŸ¥è©¢åˆ†é ï¼Œé‡æ–°è¼‰å…¥è³‡æ–™');
        await loadReservations();
      }
      
      // âœ… ç•¶åˆ‡æ›åˆ°å„€è¡¨æ¿æ™‚ï¼Œé‡æ–°è¼‰å…¥çµ±è¨ˆ
      if (target === 'dashboard') {
        console.log('ğŸ”„ åˆ‡æ›åˆ°å„€è¡¨æ¿ï¼Œé‡æ–°è¼‰å…¥çµ±è¨ˆ');
        await loadDashboardStats();
      }
    });
  });
}

liff.ready.then(() => init());
</script>
</body>
</html>
