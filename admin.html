<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šå¾Œå° v6.3.4</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family:"Noto Sans TC",system-ui,sans-serif;background:#f8fafc;margin:0; }
#loadingScreen,#loginScreen,#noAuthScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#f8fafc;flex-direction:column;text-align:center;}
#loginScreen,#noAuthScreen{display:none;}
#app{display:none;}
#topBar{position:sticky;top:0;background:#3c8050;color:white;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;}
#userInfo{display:flex;align-items:center;gap:10px;}
#userPicture{width:40px;height:40px;border-radius:50%;border:2px solid white;}
.nav-btn{flex:1;padding:10px 0;text-align:center;font-size:12px;font-weight:600;cursor:pointer;color:#666;}
.nav-btn.active{color:#3c8050;border-top:3px solid #3c8050;}
.section{display:none;}
.section.active{display:block;}
.card{background:white;border-radius:12px;padding:16px;margin:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.section-title{font-weight:800;font-size:18px;color:#14532d;margin-bottom:16px;}
#bottomNav{position:fixed;bottom:0;left:0;width:100%;background:white;border-top:1px solid #ddd;display:flex;justify-content:space-around;z-index:50;}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:8px;color:white;font-weight:600;box-shadow:0 2px 6px rgba(0,0,0,0.2);opacity:0;transition:opacity .3s ease;z-index:999;}
.toast.show{opacity:1;}
.toast.success{background:#22c55e;}
.toast.error{background:#ef4444;}
.status-ok{color:#16a34a;font-weight:bold;}
.status-cancel{color:#dc2626;font-weight:bold;}
.status-wait{color:#ca8a04;font-weight:bold;}
</style>
</head>

<body>
<!-- ğŸŒ€ è¼‰å…¥ç•«é¢ -->
<div id="loadingScreen">
  <div class="animate-pulse text-center">
    <div class="text-3xl mb-3">ğŸšŒ ç©¿å±±ç”²å¾Œå°è¼‰å…¥ä¸­...</div>
    <div>è«‹ç¨å€™é©—è­‰æ‚¨çš„èº«åˆ†</div>
  </div>
</div>

<!-- ğŸ” ç™»å…¥æç¤º -->
<div id="loginScreen">
  <div class="text-5xl mb-4">ğŸ”</div>
  <div class="text-2xl font-bold text-green-800 mb-2">å°šæœªç™»å…¥</div>
  <p class="text-gray-600 mb-4">è«‹å…ˆç™»å…¥æ‚¨çš„ LINE å¸³è™Ÿä»¥ä½¿ç”¨å¾Œå°ç³»çµ±ã€‚</p>
  <button id="loginButton" class="bg-green-700 text-white px-6 py-3 rounded-lg text-lg font-bold">ğŸ“± é»æ­¤ç™»å…¥</button>
  <p class="text-sm text-gray-500 mt-4">è«‹åœ¨ LINE App ä¸­é–‹å•Ÿæ­¤é é¢</p>
</div>

<!-- ğŸš« ç„¡æ¬Šé™æç¤º -->
<div id="noAuthScreen">
  <div class="text-5xl mb-4">ğŸš«</div>
  <div class="text-2xl font-bold text-red-800 mb-2">ç„¡æ¬Šé™ä½¿ç”¨æ­¤é é¢</div>
  <p class="text-gray-600 mb-4">è«‹ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥æˆ–è¯çµ¡ç³»çµ±ç®¡ç†å“¡ã€‚</p>
  <button id="reLogin" class="bg-gray-600 hover:bg-gray-700 text-white px-5 py-2 rounded">é‡æ–°ç™»å…¥</button>
</div>

<!-- âœ… ä¸»ç•«é¢ -->
<div id="app">
  <div id="topBar">
    <div class="font-bold text-lg">ğŸšŒ ç©¿å±±ç”²å¾Œå°ç³»çµ±</div>
    <div id="userInfo">
      <img id="userPicture" src="">
      <span id="userName">è¼‰å…¥ä¸­...</span>
      <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm ml-2">ç™»å‡º</button>
    </div>
  </div>

  <main>
    <!-- ğŸ“Š å„€è¡¨æ¿ -->
    <section id="dashboard" class="section active">
      <div class="card text-center">
        <h2 class="section-title">ğŸ“Š ç‡Ÿé‹å„€è¡¨æ¿</h2>
        <p class="text-gray-600 mb-4">æ­¡è¿ä½¿ç”¨ç©¿å±±ç”²å¾Œå°ç³»çµ±</p>
        <div id="statsArea" class="grid grid-cols-3 gap-4">
          <div class="bg-green-100 p-4 rounded-lg"><p>ä»Šæ—¥é ç´„</p><p id="todayCount" class="text-2xl font-bold text-green-700">-</p></div>
          <div class="bg-red-100 p-4 rounded-lg"><p>å·²å–æ¶ˆ</p><p id="cancelCount" class="text-2xl font-bold text-red-700">-</p></div>
          <div class="bg-blue-100 p-4 rounded-lg"><p>å·²æ­ä¹˜</p><p id="checkinCount" class="text-2xl font-bold text-blue-700">-</p></div>
        </div>
      </div>
    </section>

    <!-- ğŸ§¾ æŸ¥è©¢ -->
    <section id="query" class="section">
      <div class="card">
        <h2 class="section-title">ğŸ§¾ é ç´„æŸ¥è©¢</h2>
        <input type="text" id="search" placeholder="æœå°‹å§“åã€ç­æ¬¡æˆ–æ—¥æœŸ..." 
               class="border border-gray-300 rounded-md p-2 w-full mb-3">
        <div id="tableContainer" style="overflow-x:auto;">
          <table class="min-w-full text-sm">
            <thead class="bg-green-700 text-white sticky top-0">
              <tr>
                <th class="p-2">æ—¥æœŸ</th>
                <th class="p-2">ç­æ¬¡</th>
                <th class="p-2">å§“å</th>
                <th class="p-2">ç‹€æ…‹</th>
              </tr>
            </thead>
            <tbody id="tbl"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ğŸ“‹ æ ¸éŠ· -->
    <section id="checkin" class="section">
      <div class="card text-center">
        <h2 class="section-title">ğŸ“‹ æ ¸éŠ·ç®¡ç†</h2>
        <button id="goCheckin" class="bg-green-600 text-white px-4 py-3 rounded w-full text-lg">å‰å¾€æ ¸éŠ·ç³»çµ±</button>
        <p class="text-gray-500 mt-2 text-sm">é–‹å•Ÿ LIFFï¼š2006590746-G7B12a1K</p>
      </div>
    </section>

    <!-- ğŸš å¸æ©Ÿ -->
    <section id="driver" class="section">
      <div class="card">
        <h2 class="section-title">ğŸš å¸æ©Ÿç­è¡¨</h2>
        <ul class="list-disc ml-6 text-gray-700">
          <li>A1ï¼šé™³å¸æ©Ÿ</li><li>B1ï¼šæ—å¸æ©Ÿ</li><li>A2ï¼šç‹å¸æ©Ÿ</li><li>B2ï¼šå³å¸æ©Ÿ</li>
        </ul>
      </div>
    </section>

    <!-- âš™ï¸ è¨­å®š -->
    <section id="config" class="section">
      <div class="card">
        <h2 class="section-title">âš™ï¸ ç³»çµ±è¨­å®š</h2>
        <label class="block mb-2">æ¯ç­æ¬¡æ­è¼‰äººæ•¸ä¸Šé™</label>
        <input id="seatLimit" type="number" class="border p-2 w-full mb-3 rounded" />
        <label class="block mb-2">æœªæ ¸éŠ·é”å¹¾æ¬¡å¾Œç¦ç”¨</label>
        <input id="maxNoShow" type="number" class="border p-2 w-full mb-3 rounded" />
        <label class="block mb-2">ç¦ç”¨é€±æ•¸</label>
        <input id="banWeeks" type="number" class="border p-2 w-full mb-3 rounded" />
        <label class="block mb-2">é ç´„æ¨¡å¼</label>
        <select id="tripMode" class="border p-2 w-full mb-3 rounded">
          <option value="single">å–®ç¨‹</option>
          <option value="round">å¯ä¾†å›</option>
        </select>
        <button id="saveRules" class="bg-green-600 text-white font-bold py-2 px-4 rounded w-full">ğŸ’¾ å„²å­˜è¨­å®š</button>
        <p id="ruleMeta" class="text-gray-500 text-sm mt-3"></p>
      </div>
    </section>
  </main>

  <div id="bottomNav">
    <div class="nav-btn active" data-sec="dashboard">ğŸ“Š å„€è¡¨æ¿</div>
    <div class="nav-btn" data-sec="query">ğŸ§¾ æŸ¥è©¢</div>
    <div class="nav-btn" data-sec="checkin">ğŸ“‹ æ ¸éŠ·</div>
    <div class="nav-btn" data-sec="driver">ğŸš å¸æ©Ÿ</div>
    <div class="nav-btn" data-sec="config">âš™ï¸ è¨­å®š</div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const WORKER_URL='https://delicate-math-7e61.fangwl591021.workers.dev/';
const LIFF_ID='2006590746-wgL4l54z';
let allData=[];

async function init(){
  try{
    await liff.init({liffId:LIFF_ID});
    if(!liff.isLoggedIn()){
      document.getElementById('loadingScreen').style.display='none';
      document.getElementById('loginScreen').style.display='flex';
      return;
    }

    const profile=await liff.getProfile();
    const roleRes=await fetch(`${WORKER_URL}?mode=getRole&userId=${profile.userId}`);
    const roleData=await roleRes.json();

    if(roleData.role!=='admin'){
      document.getElementById('loadingScreen').style.display='none';
      document.getElementById('noAuthScreen').style.display='flex';
      return;
    }

    document.getElementById('loadingScreen').style.display='none';
    document.getElementById('app').style.display='block';
    document.getElementById('userName').textContent=profile.displayName+' (ç®¡ç†å“¡)';
    document.getElementById('userPicture').src=profile.pictureUrl;

    setupNav();

    // åœç•™åœ¨å„€è¡¨æ¿
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById('dashboard').classList.add('active');

    // å»¶é²è¼‰å…¥å…¶ä»–è³‡æ–™
    setTimeout(async()=>{
      await loadReservations();
      await loadRules();
      await loadDashboardStats();
    },1500);
  }catch(e){
    console.error(e);
    showToast('âš ï¸ åˆå§‹åŒ–éŒ¯èª¤','error');
  }
}

// ç™»å…¥ç™»å‡º
document.getElementById('loginButton').addEventListener('click',()=>liff.login());
document.getElementById('reLogin').addEventListener('click',()=>liff.login());
document.getElementById('logoutBtn').addEventListener('click',()=>{liff.logout();location.reload();});

// Toast
function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className=`toast show ${type}`;
  setTimeout(()=>t.classList.remove('show'),3000);
}

// Dashboard çµ±è¨ˆ
async function loadDashboardStats(){
  try{
    const res=await fetch(`${WORKER_URL}?mode=dashboard`);
    const data=await res.json();
    document.getElementById('todayCount').textContent=data.dashboard?.todayCount||'-';
    document.getElementById('cancelCount').textContent=data.dashboard?.cancelCount||'-';
    document.getElementById('checkinCount').textContent=data.dashboard?.checkinCount||'-';
  }catch(e){console.warn('çµ±è¨ˆè³‡æ–™è¼‰å…¥å¤±æ•—');}
}

/* ğŸ“Š è¼‰å…¥é ç´„è³‡æ–™ - è©³ç´°é™¤éŒ¯ç‰ˆæœ¬ */
async function loadReservations() {
  const tbody = document.getElementById('tbl');
  tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">ğŸ”„ æŸ¥è©¢ä¸­...</td></tr>`;

  try {
    console.log('ğŸš€ é–‹å§‹è¼‰å…¥é ç´„è³‡æ–™...');
    console.log('ğŸ“¡ è«‹æ±‚ URL:', `${WORKER_URL}?mode=allReservations`);
    
    const startTime = Date.now();
    const res = await fetch(`${WORKER_URL}?mode=allReservations`);

    const endTime = Date.now();
    
    console.log('âœ… è«‹æ±‚å®Œæˆï¼Œç‹€æ…‹:', res.status, 'è€—æ™‚:', endTime - startTime + 'ms');
    console.log('ğŸ“‹ Response headers:', [...res.headers.entries()]);
    
    const text = await res.text();
    console.log('ğŸ“„ åŸå§‹å›æ‡‰æ–‡å­—:', text);
    
    let json;
    try {
      json = JSON.parse(text);
      console.log('ğŸ“Š è§£æå¾Œçš„ JSON:', json);
    } catch (parseError) {
      console.error('âŒ JSON è§£æéŒ¯èª¤:', parseError);
      throw new Error('å›æ‡‰æ ¼å¼éŒ¯èª¤: ' + parseError.message);
    }

    // è©³ç´°æª¢æŸ¥å›æ‡‰çµæ§‹
    console.log('ğŸ” æª¢æŸ¥å›æ‡‰çµæ§‹:');
    console.log('- json.ok:', json.ok);
    console.log('- json.status:', json.status);
    console.log('- json.reservations:', json.reservations);
    console.log('- Array.isArray(reservations):', Array.isArray(json.reservations));
    
    if (json.reservations) {
      console.log('- reservations.length:', json.reservations.length);
      if (json.reservations.length > 0) {
        console.log('- ç¬¬ä¸€ç­†è³‡æ–™ç¯„ä¾‹:', json.reservations[0]);
      }
    }

    // æª¢æŸ¥å›æ‡‰ç‹€æ…‹
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }

    if (json.status === 'error') {
      throw new Error(json.message || 'å¾Œå°æŸ¥è©¢å¤±æ•—');
    }

    if (!json.ok) {
      throw new Error(json.error || 'Worker å›æ‡‰éŒ¯èª¤');
    }

    const list = json.reservations || [];

    if (!Array.isArray(list)) {
      console.error('âŒ reservations ä¸æ˜¯é™£åˆ—:', typeof list, list);
      throw new Error('è³‡æ–™æ ¼å¼éŒ¯èª¤: reservations æ‡‰è©²æ˜¯é™£åˆ—');
    }

    if (list.length === 0) {
      console.log('â„¹ï¸ æ²’æœ‰é ç´„è³‡æ–™ï¼Œåˆ—è¡¨ç‚ºç©ºé™£åˆ—');
      tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-400">ç›®å‰æ²’æœ‰é ç´„è³‡æ–™</td></tr>`;
      return;
    }

    console.log(`ğŸ“Š æ”¶åˆ° ${list.length} ç­†åŸå§‹è³‡æ–™:`, list);

    // è™•ç†è³‡æ–™æ ¼å¼è½‰æ›
    const data = list.map((r, index) => {
      const processed = {
        date: r.date || '',
        route: r.route || '',
        name: r.name || '',
        status: r.status || '',
        _index: index,
        _raw: r
      };
      
      // æª¢æŸ¥æ¯å€‹æ¬„ä½æ˜¯å¦ç‚ºç©º
      if (!processed.date || !processed.route || !processed.name || !processed.status) {
        console.warn(`âš ï¸ ç¬¬ ${index} ç­†è³‡æ–™æœ‰ç©ºç™½æ¬„ä½:`, processed);
      }
      
      return processed;
    });

    console.log(`ğŸ“Š è™•ç†å¾Œè³‡æ–™ï¼šå…± ${data.length} ç­†`, data);

    // éæ¿¾æ‰å®Œå…¨ç©ºç™½çš„è³‡æ–™
    const validData = data.filter(r => r.date || r.route || r.name || r.status);
    console.log(`âœ… æœ‰æ•ˆè³‡æ–™ï¼šå…± ${validData.length} ç­†`, validData);

    if (validData.length === 0) {
      console.log('â„¹ï¸ æ‰€æœ‰è³‡æ–™éƒ½æ˜¯ç©ºç™½çš„');
      tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-400">ç›®å‰æ²’æœ‰æœ‰æ•ˆçš„é ç´„è³‡æ–™</td></tr>`;
      return;
    }

    // æ’åºï¼šæ—¥æœŸå€’åºï¼Œç­æ¬¡é †åº
    const order = { A1: 1, A2: 2, B1: 3, B2: 4 };
    validData.sort((a, b) => {
      if (a.date < b.date) return 1;
      if (a.date > b.date) return -1;
      return (order[a.route] || 99) - (order[b.route] || 99);
    });

    renderTable(validData);
    allData = validData;
    
    showToast(`âœ… è¼‰å…¥ ${validData.length} ç­†é ç´„è³‡æ–™`);
    
  } catch (e) {
    console.error('âŒ å¾Œå°æŸ¥è©¢éŒ¯èª¤', e);
    console.error('éŒ¯èª¤å †æ ˆ:', e.stack);
    
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="p-4 text-center text-red-500">
          âŒ æŸ¥è©¢å¤±æ•—ï¼š${e.message}<br>
          <small>è«‹æŸ¥çœ‹æ§åˆ¶å°ç²å–è©³ç´°éŒ¯èª¤è³‡è¨Š</small>
        </td>
      </tr>`;
      
    showToast('âŒ è¼‰å…¥é ç´„è³‡æ–™å¤±æ•—', 'error');
  }
}

/* ğŸ§¾ æ¸²æŸ“æŸ¥è©¢çµæœ - çµ±ä¸€å®šç¾© */
function renderTable(data) {
  const tbody = document.getElementById('tbl');

  if (!data || !Array.isArray(data) || data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-400">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„</td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(r => {
    const cls = r.status && r.status.includes('å–æ¶ˆ')
      ? 'status-cancel'
      : r.status && r.status.includes('æ­ä¹˜')
      ? 'status-ok'
      : 'status-wait';
    
    return `
      <tr class="border-b hover:bg-green-50 transition">
        <td class="p-2">${r.date || '-'}</td>
        <td class="p-2">${r.route || '-'}</td>
        <td class="p-2">${r.name || '-'}</td>
        <td class="p-2 ${cls}">${r.status || '-'}</td>
      </tr>`;
  }).join('');
}

/* ğŸ” å³æ™‚æœå°‹ */
document.getElementById('search').addEventListener('input', e => {
  const k = e.target.value.trim().toLowerCase();
  
  if (!allData || !Array.isArray(allData)) {
    renderTable([]);
    return;
  }
  
  const filtered = allData.filter(r =>
    (r.name && r.name.toLowerCase().includes(k)) ||
    (r.route && r.route.toLowerCase().includes(k)) ||
    (r.date && r.date.includes(k))
  );
  renderTable(filtered);
});

// ç³»çµ±è¨­å®š
async function loadRules(){
  try {
    const res = await fetch(`${WORKER_URL}?mode=getRules`);
    const json = await res.json();
    const r = json.current || {};
    
    document.getElementById('seatLimit').value = r.seatLimit || '';
    document.getElementById('maxNoShow').value = r.maxNoShow || '';
    document.getElementById('banWeeks').value = r.banWeeks || '';
    document.getElementById('tripMode').value = r.tripMode || 'single';
    document.getElementById('ruleMeta').textContent = `æœ€å¾Œæ›´æ–°ï¼š${r.lastUpdate || 'æœªçŸ¥'}`;
  } catch (e) {
    console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', e);
    showToast('âŒ è¼‰å…¥è¨­å®šå¤±æ•—', 'error');
  }
}

document.getElementById('saveRules').addEventListener('click', async () => {
  const body = {
    seatLimit: +document.getElementById('seatLimit').value,
    maxNoShow: +document.getElementById('maxNoShow').value,
    banWeeks: +document.getElementById('banWeeks').value,
    tripMode: document.getElementById('tripMode').value
  };
  
  try {
    const res = await fetch(`${WORKER_URL}?mode=updateRules`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });
    const json = await res.json();
    
    if(json.status === 'success') {
      showToast('âœ… å·²æˆåŠŸæ›´æ–°è¨­å®š');
      await loadRules();
    } else {
      showToast('âŒ æ›´æ–°å¤±æ•—', 'error');
    }
  } catch(e) {
    console.error('æ›´æ–°è¨­å®šå¤±æ•—:', e);
    showToast('âŒ é€£ç·šéŒ¯èª¤', 'error');
  }
});

// å°è¦½
function setupNav(){
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      document.getElementById(btn.dataset.sec).classList.add('active');
    });
  });
  
  document.getElementById('goCheckin').addEventListener('click',()=>{
    liff.openWindow({url:'https://liff.line.me/2006590746-G7B12a1K',external:false});
  });
}

init();
</script>
</body>
</html>
