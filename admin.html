<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>穿山甲專車 - 管理後台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body class="bg-gray-50">
  <nav class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <i class="fas fa-bus text-2xl"></i>
        <div>
          <h1 class="text-xl font-bold">暨大接駁車管理後台</h1>
          <p class="text-sm text-purple-200">穿山甲專車預約系統</p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <span id="currentTime" class="text-sm"></span>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto p-6">
    <!-- 統計卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow-md p-6 flex justify-between items-center">
        <div>
          <p class="text-gray-500 text-sm">註冊會員</p>
          <p id="totalUsers" class="text-3xl font-bold text-gray-800">0</p>
        </div>
        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
          <i class="fas fa-users text-blue-600 text-xl"></i>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md p-6 flex justify-between items-center">
        <div>
          <p class="text-gray-500 text-sm">今日預約</p>
          <p id="todayBookings" class="text-3xl font-bold text-gray-800">0</p>
        </div>
        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
          <i class="fas fa-calendar-check text-green-600 text-xl"></i>
        </div>
      </div>
    </div>

    <!-- 即時班次 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-blue-50 rounded-lg p-4 text-center"><p>A1</p><p id="a1Count" class="text-2xl font-bold">0/6</p></div>
      <div class="bg-green-50 rounded-lg p-4 text-center"><p>B1</p><p id="b1Count" class="text-2xl font-bold">0/6</p></div>
      <div class="bg-purple-50 rounded-lg p-4 text-center"><p>A2</p><p id="a2Count" class="text-2xl font-bold">0/6</p></div>
      <div class="bg-orange-50 rounded-lg p-4 text-center"><p>B2</p><p id="b2Count" class="text-2xl font-bold">0/6</p></div>
    </div>

    <!-- 最新預約 -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8">
      <h2 class="text-xl font-bold mb-3">最新預約紀錄</h2>
      <div id="realtimeBookings" class="divide-y"></div>
    </div>

    <!-- 會員管理 -->
    <div class="bg-white rounded-xl shadow-md p-6">
      <h2 class="text-xl font-bold mb-3">會員管理</h2>
      <div class="border rounded-lg overflow-hidden">
        <div class="bg-gray-50 px-4 py-3 border-b grid grid-cols-12 gap-4 text-sm font-semibold">
          <div class="col-span-3">姓名</div>
          <div class="col-span-2">學號</div>
          <div class="col-span-3">科系</div>
          <div class="col-span-2">電話</div>
          <div class="col-span-2">註冊時間</div>
        </div>
        <div id="membersTable" class="divide-y max-h-96 overflow-y-auto"></div>
      </div>
    </div>
  </div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxZVsRBh71_GoN-JLCDgodODbRUObcPC1ZDzvXwvwEIpXiZOnZWTPl45ZYvhWe2BIvnOQ/exec';

async function getMembersData() {
  const res = await fetch(`${GAS_URL}?mode=members`);
  const data = await res.json();
  return data.members || [];
}

async function getBookingsData() {
  const res = await fetch(`${GAS_URL}?mode=bookings`);
  const data = await res.json();
  return data.bookings || [];
}

async function loadRealtimeData() {
  const bookings = await getBookingsData();
  const members = await getMembersData();
  const today = new Date().toISOString().split('T')[0];

  // 統計
  const todayBookings = bookings.filter(b => b.date === today);
  document.getElementById('todayBookings').textContent = todayBookings.length;
  document.getElementById('totalUsers').textContent = members.length;

  // 班次
  document.getElementById('a1Count').textContent = `${todayBookings.filter(b => b.route === 'A1').length}/6`;
  document.getElementById('b1Count').textContent = `${todayBookings.filter(b => b.route === 'B1').length}/6`;
  document.getElementById('a2Count').textContent = `${todayBookings.filter(b => b.route === 'A2').length}/6`;
  document.getElementById('b2Count').textContent = `${todayBookings.filter(b => b.route === 'B2').length}/6`;

  // 最新 10 筆預約
  const recent = todayBookings.slice(-10).reverse();
  const container = document.getElementById('realtimeBookings');
  container.innerHTML = recent.map(b => `
    <div class="px-4 py-3 flex justify-between">
      <div>
        <p class="font-medium">${b.name}</p>
        <p class="text-sm text-gray-500">${b.route} • ${b.date}</p>
      </div>
      <div>
        <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">已預約</span>
      </div>
    </div>
  `).join('');
}

async function loadMembersData() {
  const members = await getMembersData();
  const container = document.getElementById('membersTable');
  container.innerHTML = members.map(m => `
    <div class="px-4 py-3 grid grid-cols-12 gap-4 text-sm">
      <div class="col-span-3">${m.name}</div>
      <div class="col-span-2">${m.studentId}</div>
      <div class="col-span-3">${m.department}</div>
      <div class="col-span-2">${m.phone}</div>
      <div class="col-span-2">${m.registerTime}</div>
    </div>
  `).join('');
}

function updateCurrentTime() {
  const now = new Date();
  document.getElementById('currentTime').textContent = now.toLocaleString('zh-TW', { hour12: false });
}

window.addEventListener('load', () => {
  updateCurrentTime();
  setInterval(updateCurrentTime, 1000);
  loadRealtimeData();
  loadMembersData();
  setInterval(loadRealtimeData, 30000);
});
</script>
  <script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxZVsRBh71_GoN-JLCDgodODbRUObcPC1ZDzvXwvwEIpXiZOnZWTPl45ZYvhWe2BIvnOQ/exec';

// 抓會員資料
async function getMembersData() {
  const res = await fetch(`${GAS_URL}?mode=members`, { mode: 'cors' });
  const data = await res.json();
  return data.members || [];
}

// 抓預約資料
async function getBookingsData() {
  const res = await fetch(`${GAS_URL}?mode=bookings`, { mode: 'cors' });
  const data = await res.json();
  return data.bookings || [];
}

// 載入即時資料（統計 & 最新預約）
async function loadRealtimeData() {
  const bookings = await getBookingsData();
  const members = await getMembersData();
  const today = new Date().toISOString().split('T')[0];

  // ✅ 修正日期比對（使用 startsWith）
  const todayBookings = bookings.filter(b => b.date.startsWith(today));
  document.getElementById('todayBookings').textContent = todayBookings.length;
  document.getElementById('totalUsers').textContent = members.length;

  // ✅ 統計班次
  document.getElementById('a1Count').textContent = `${todayBookings.filter(b => b.route === 'A1').length}/6`;
  document.getElementById('b1Count').textContent = `${todayBookings.filter(b => b.route === 'B1').length}/6`;
  document.getElementById('a2Count').textContent = `${todayBookings.filter(b => b.route === 'A2').length}/6`;
  document.getElementById('b2Count').textContent = `${todayBookings.filter(b => b.route === 'B2').length}/6`;

  // ✅ 最新 10 筆預約
  const recent = todayBookings.slice(-10).reverse();
  const container = document.getElementById('realtimeBookings');
  container.innerHTML = recent.map(b => `
    <div class="px-4 py-3 flex justify-between">
      <div>
        <p class="font-medium">${b.name}</p>
        <p class="text-sm text-gray-500">${b.route} • ${b.date}</p>
      </div>
      <div>
        <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">已預約</span>
      </div>
    </div>
  `).join('');
}

// 載入會員資料（會員管理區塊）
async function loadMembersData() {
  const members = await getMembersData();
  const container = document.getElementById('membersTable');
  container.innerHTML = members.map(m => `
    <div class="px-4 py-3 grid grid-cols-12 gap-4 text-sm">
      <div class="col-span-3">${m.name}</div>
      <div class="col-span-2">${m.studentId}</div>
      <div class="col-span-3">${m.department}</div>
      <div class="col-span-2">${m.phone}</div>
      <div class="col-span-2">${m.registerTime}</div>
    </div>
  `).join('');
}

// 即時時鐘
function updateCurrentTime() {
  const now = new Date();
  document.getElementById('currentTime').textContent = now.toLocaleString('zh-TW', { hour12: false });
}

// 初始化
window.addEventListener('load', () => {
  updateCurrentTime();
  setInterval(updateCurrentTime, 1000);
  loadRealtimeData();
  loadMembersData();
  setInterval(loadRealtimeData, 30000);
});
</script>

</body>
</html>
