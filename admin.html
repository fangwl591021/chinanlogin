<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šå¾Œå° v6.3.1</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: "Noto Sans TC", system-ui, sans-serif; background:#f8fafc; padding-bottom:80px; }
#topBar { position:sticky; top:0; background:#3c8050; color:white; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; }
#userInfo { display:flex; align-items:center; gap:10px; }
#userPicture { width:40px; height:40px; border-radius:50%; border:2px solid white; }
.nav-btn { flex:1; padding:10px 0; text-align:center; font-size:12px; font-weight:600; cursor:pointer; color:#666; }
.nav-btn.active { color:#3c8050; border-top:3px solid #3c8050; }
.section { display:none; }
.section.active { display:block; }
.card { background:white; border-radius:12px; padding:16px; margin:16px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.section-title { font-weight:800; font-size:18px; color:#14532d; margin-bottom:16px; }
#bottomNav { position:fixed; bottom:0; left:0; width:100%; background:white; border-top:1px solid #ddd; display:flex; justify-content:space-around; z-index:50; }
.toast { position:fixed; bottom:100px; left:50%; transform:translateX(-50%); padding:10px 20px; border-radius:8px; color:white; font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,0.2); opacity:0; transition:opacity .3s ease; z-index:999; }
.toast.show { opacity:1; }
.toast.success { background:#22c55e; }
.toast.error { background:#ef4444; }
</style>
</head>

<body>
<!-- ğŸ” é ‚éƒ¨ -->
<div id="topBar">
  <div class="font-bold text-lg">ğŸšŒ ç©¿å±±ç”²å¾Œå°ç³»çµ±</div>
  <div id="userInfo">
    <img id="userPicture" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'%3E%3Crect fill='%23ddd' width='40' height='40'/%3E%3C/svg%3E">
    <span id="userName">è¼‰å…¥ä¸­...</span>
  </div>
</div>

<main>
  <!-- ğŸ“Š å„€è¡¨æ¿ -->
  <section id="dashboard" class="section active">
    <div class="card">
      <h2 class="section-title">ğŸ“Š ç‡Ÿé‹å„€è¡¨æ¿</h2>
      <div id="statsArea">è¼‰å…¥çµ±è¨ˆä¸­...</div>
    </div>
  </section>

  <!-- ğŸ§¾ æŸ¥è©¢ -->
  <section id="query" class="section">
    <div class="card">
      <h2 class="section-title">ğŸ§¾ é ç´„æŸ¥è©¢</h2>
      <input type="text" id="search" placeholder="æœå°‹å§“åã€ç­æ¬¡æˆ–æ—¥æœŸ..." class="border border-gray-300 rounded-md p-2 w-full mb-3">
      <div id="tableContainer" style="overflow-x:auto;">
        <table class="min-w-full text-sm">
          <thead class="bg-green-700 text-white">
            <tr><th class="p-2">æ—¥æœŸ</th><th class="p-2">ç­æ¬¡</th><th class="p-2">å§“å</th><th class="p-2">ç‹€æ…‹</th></tr>
          </thead>
          <tbody id="tbl"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ğŸ“‹ æ ¸éŠ· -->
  <section id="checkin" class="section">
    <div class="card text-center">
      <h2 class="section-title">ğŸ“‹ æ ¸éŠ·ç®¡ç†</h2>
      <button id="goCheckin" class="bg-green-600 text-white px-4 py-3 rounded w-full text-lg">å‰å¾€æ ¸éŠ·ç³»çµ±</button>
      <p class="text-gray-500 mt-2 text-sm">é–‹å•Ÿ LIFFï¼š2006590746-G7B12a1K</p>
    </div>
  </section>

  <!-- ğŸš å¸æ©Ÿ -->
  <section id="driver" class="section">
    <div class="card">
      <h2 class="section-title">ğŸš å¸æ©Ÿç­è¡¨</h2>
      <ul class="list-disc ml-6 text-gray-700">
        <li>A1ï¼šé™³å¸æ©Ÿ</li><li>B1ï¼šæ—å¸æ©Ÿ</li><li>A2ï¼šç‹å¸æ©Ÿ</li><li>B2ï¼šå³å¸æ©Ÿ</li>
      </ul>
    </div>
  </section>

  <!-- âš™ï¸ ç³»çµ±è¨­å®š -->
  <section id="config" class="section">
    <div class="card">
      <h2 class="section-title">âš™ï¸ ç³»çµ±è¨­å®š</h2>
      <div id="ruleForm">
        <label class="block mb-2">æ¯ç­æ¬¡æ­è¼‰äººæ•¸ä¸Šé™</label>
        <input id="seatLimit" type="number" class="border p-2 w-full mb-3 rounded" />

        <label class="block mb-2">æœªæ ¸éŠ·é”å¹¾æ¬¡å¾Œç¦ç”¨</label>
        <input id="maxNoShow" type="number" class="border p-2 w-full mb-3 rounded" />

        <label class="block mb-2">ç¦ç”¨é€±æ•¸</label>
        <input id="banWeeks" type="number" class="border p-2 w-full mb-3 rounded" />

        <label class="block mb-2">é ç´„æ¨¡å¼</label>
        <select id="tripMode" class="border p-2 w-full mb-3 rounded">
          <option value="single">å–®ç¨‹</option>
          <option value="round">å¯ä¾†å›</option>
        </select>

        <button id="saveRules" class="bg-green-600 text-white font-bold py-2 px-4 rounded w-full">ğŸ’¾ å„²å­˜è¨­å®š</button>
        <p id="ruleMeta" class="text-gray-500 text-sm mt-3"></p>
      </div>
    </div>
  </section>
</main>

<!-- ğŸ“± åº•éƒ¨å°è¦½ -->
<div id="bottomNav">
  <div class="nav-btn active" data-sec="dashboard">ğŸ“Š å„€è¡¨æ¿</div>
  <div class="nav-btn" data-sec="query">ğŸ§¾ æŸ¥è©¢</div>
  <div class="nav-btn" data-sec="checkin">ğŸ“‹ æ ¸éŠ·</div>
  <div class="nav-btn" data-sec="driver">ğŸš å¸æ©Ÿ</div>
  <div class="nav-btn" data-sec="config">âš™ï¸ è¨­å®š</div>
</div>

<!-- ğŸ’¬ Toast -->
<div id="toast" class="toast"></div>

<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const LIFF_ID = '2006590746-wgL4l54z';
let allData = [];

/* ğŸ§© æ¬Šé™é©—è­‰æ¨¡çµ„ */
document.addEventListener('DOMContentLoaded', async () => {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) return liff.login();
  const profile = await liff.getProfile();
  document.getElementById('userName').textContent = profile.displayName;
  document.getElementById('userPicture').src = profile.pictureUrl;
  const res = await fetch(`${WORKER_URL}?mode=getRole&userId=${profile.userId}`);
  const data = await res.json();
  if (data.role !== 'admin') {
    showToast('ğŸš« ç„¡æ¬Šé™é€²å…¥å¾Œå°', 'error');
    setTimeout(()=>liff.closeWindow(),2500);
    return;
  } else {
    document.getElementById('userName').textContent = profile.displayName + ' (ç®¡ç†å“¡)';
  }
  setupNav();
  loadReservations();
  loadRules();
});

/* ğŸ’¬ Toast æ¨¡çµ„ */
function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast show ${type}`;
  setTimeout(()=>t.classList.remove('show'),3000);
}

/* ğŸ“Š è³‡æ–™è¼‰å…¥ */
async function loadReservations() {
  try {
    const res = await fetch(`${WORKER_URL}?mode=reservations`);
    const json = await res.json();
    allData = json.reservations || [];
    renderTable(allData);
  } catch {
    showToast('è³‡æ–™è¼‰å…¥å¤±æ•—', 'error');
  }
}

/* ğŸ” æŸ¥è©¢ */
function renderTable(data){
  const tbody = document.getElementById('tbl');
  tbody.innerHTML = data.map(r=>`
    <tr>
      <td class="p-2">${r.date}</td>
      <td class="p-2">${r.route}</td>
      <td class="p-2">${r.name}</td>
      <td class="p-2">${r.status}</td>
    </tr>`).join('');
}
document.getElementById('search').addEventListener('input',e=>{
  const k = e.target.value.toLowerCase();
  renderTable(allData.filter(r=>
    r.name?.toLowerCase().includes(k) || r.route?.toLowerCase().includes(k) || r.date?.includes(k)
  ));
});

/* âš™ï¸ ç³»çµ±è¨­å®šæ¨¡çµ„ */
async function loadRules(){
  const res = await fetch(`${WORKER_URL}?mode=getRules`);
  const json = await res.json();
  const r = json.current;
  document.getElementById('seatLimit').value = r.seatLimit;
  document.getElementById('maxNoShow').value = r.maxNoShow;
  document.getElementById('banWeeks').value = r.banWeeks;
  document.getElementById('tripMode').value = r.tripMode;
  document.getElementById('ruleMeta').textContent = `æœ€å¾Œæ›´æ–°ï¼š${r.lastUpdate}`;
}
document.getElementById('saveRules').addEventListener('click', async ()=>{
  const body = {
    seatLimit:+seatLimit.value,
    maxNoShow:+maxNoShow.value,
    banWeeks:+banWeeks.value,
    tripMode:tripMode.value
  };
  try {
    const res = await fetch(`${WORKER_URL}?mode=updateRules`,{
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
    });
    const json = await res.json();
    if(json.status==='success'){ showToast('âœ… å·²æˆåŠŸæ›´æ–°è¨­å®š','success'); loadRules(); }
    else showToast('âŒ æ›´æ–°å¤±æ•—','error');
  } catch { showToast('âŒ é€£ç·šéŒ¯èª¤','error'); }
});

/* å°è¦½ */
function setupNav(){
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      document.getElementById(btn.dataset.sec).classList.add('active');
    });
  });
  document.getElementById('goCheckin').addEventListener('click',()=>{
    liff.openWindow({ url: 'https://liff.line.me/2006590746-G7B12a1K', external:false });
  });
}
</script>
</body>
</html>
