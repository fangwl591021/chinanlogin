<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šç®¡ç†å¾Œå° v6.5.1 (so4bj/6 ä¿®æ­£ç‰ˆ)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{font-family:"Noto Sans TC",system-ui,sans-serif;background:#f8fafc;margin:0;}
#loadingScreen,#loginScreen,#noAuthScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;}
#loginScreen,#noAuthScreen,#app{display:none;}
#topBar{position:sticky;top:0;background:#3c8050;color:white;padding:12px 16px;display:flex;justify-content:space-between;z-index:50;}
.nav-btn{flex:1;text-align:center;font-size:12px;padding:10px 0;font-weight:600;color:#666;cursor:pointer;}
.nav-btn.active{color:#3c8050;border-top:3px solid #3c8050;}
.section{display:none;}
.section.active{display:block;}
.card{background:white;border-radius:12px;padding:16px;margin:16px;box-shadow:0 2px 8px rgba(0,0,0,.1);}
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:8px;color:white;font-weight:bold;opacity:0;transition:.3s;}
.toast.show{opacity:1;}
.toast.success{background:#22c55e;}
.toast.error{background:#ef4444;}
#bottomNav{position:fixed;bottom:0;width:100%;background:white;border-top:1px solid #ddd;display:flex;}
.info-badge{background:#dbeafe;color:#1e40af;padding:4px 10px;border-radius:6px;font-size:12px;}
</style>
</head>

<body>

<div id="loadingScreen">ğŸšŒ è¼‰å…¥ä¸­â€¦</div>

<div id="loginScreen">
  <button id="loginButton">ç™»å…¥ LINE</button>
</div>

<div id="noAuthScreen">
  <p>ğŸš« ç„¡æ¬Šé™</p>
  <pre id="debugInfo"></pre>
  <button id="reLogin">é‡æ–°ç™»å…¥</button>
</div>

<div id="app">
  <div id="topBar">
    <span>ğŸšŒ ç©¿å±±ç”²å¾Œå°</span>
    <span id="userName"></span>
  </div>

  <main>
    <section id="dashboard" class="section active">
      <div class="card">ğŸ“Š å„€è¡¨æ¿</div>
    </section>

    <section id="query" class="section">
      <div class="card">
        <button id="refreshBtn">é‡æ–°æ•´ç†</button>
        <table>
          <tbody id="tbl"></tbody>
        </table>
      </div>
    </section>

    <section id="checkin" class="section">
      <div class="card">ğŸ“‹ æ ¸éŠ·</div>
    </section>

    <section id="driver" class="section">
      <div class="card">ğŸš å¸æ©Ÿ</div>
    </section>

    <!-- âš™ï¸ è¨­å®š -->
    <section id="config" class="section">
      <div class="card">
        <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>

        <label>é ç´„é–‹æ”¾å¤©æ•¸</label>
        <input id="bookingDaysLimit" type="number" />
        <div class="info-badge">ç›®å‰ï¼š<span id="daysDisplay"></span> å¤©</div>

        <label>æœ€æ™šé ç´„æ™‚é–“</label>
        <input id="bookingDeadline" type="time" />

        <label>æœ€æ™šå–æ¶ˆæ™‚é–“</label>
        <input id="cancelDeadline" type="time" />

        <button id="saveRules">ğŸ’¾ å„²å­˜è¨­å®š</button>
        <p id="ruleMeta"></p>
      </div>
    </section>
  </main>

  <div id="bottomNav">
    <div class="nav-btn active" data-sec="dashboard">å„€è¡¨æ¿</div>
    <div class="nav-btn" data-sec="query">æŸ¥è©¢</div>
    <div class="nav-btn" data-sec="checkin">æ ¸éŠ·</div>
    <div class="nav-btn" data-sec="driver">å¸æ©Ÿ</div>
    <div class="nav-btn" data-sec="config">è¨­å®š</div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const LIFF_ID = '2006590746-wgL4l54z';

function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className=`toast show ${type}`;
  setTimeout(()=>t.classList.remove('show'),2500);
}

/* ===== LIFF INIT ===== */
async function init(){
  await liff.init({liffId:LIFF_ID});

  if(!liff.isLoggedIn()){
    loadingScreen.style.display='none';
    loginScreen.style.display='flex';
    return;
  }

  const profile = await liff.getProfile();
  const res = await fetch(`${WORKER_URL}?mode=check&userId=${profile.userId}`);
  const data = await res.json();

  if(!data.user?.isAdmin){
    loadingScreen.style.display='none';
    noAuthScreen.style.display='flex';
    debugInfo.textContent = JSON.stringify(data,null,2);
    return;
  }

  loadingScreen.style.display='none';
  app.style.display='block';
  userName.textContent = profile.displayName + ' (ç®¡ç†å“¡)';
  setupNav();
  loadRules();
}

loginButton.onclick=()=>liff.login();
reLogin.onclick=()=>liff.login();

/* ===== NAV ===== */
function setupNav(){
  document.querySelectorAll('.nav-btn').forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.getElementById(b.dataset.sec).classList.add('active');
    };
  });
}

/* ===== RULES ===== */
async function loadRules(){
  const res = await fetch(`${WORKER_URL}?mode=getRules`);
  const json = await res.json();
  const r = json.current||{};

  bookingDaysLimit.value = r.advanceBookingDays ?? '';
  daysDisplay.textContent = r.advanceBookingDays ?? '-';
  bookingDeadline.value = normalizeTime(r.bookingDeadline);
  cancelDeadline.value = normalizeTime(r.cancelDeadline);
  ruleMeta.textContent = 'æœ€å¾Œæ›´æ–°ï¼š'+(r.lastUpdate||'');
}

/* âœ… ä¿®æ­£å¾Œç‰ˆæœ¬ï¼ˆä¸å†ç”¨ defaultTimeï¼‰ */
function normalizeTime(time){
  if(!time) return '';
  if(/^\d{2}:\d{2}$/.test(time)) return time;
  const m = time.match(/(\d{1,2}):(\d{2})/);
  return m ? m[1].padStart(2,'0')+':'+m[2] : '';
}

/* ===== SAVE ===== */
saveRules.onclick = async ()=>{
  const body = {
    advanceBookingDays:+bookingDaysLimit.value,
    bookingDeadline:bookingDeadline.value,
    cancelDeadline:cancelDeadline.value
  };

  const res = await fetch(`${WORKER_URL}?mode=updateRules`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });

  const json = await res.json();

  if(json.status==='success'){
    await loadRules();

    if(!bookingDeadline.value && !cancelDeadline.value){
      showToast('âš ï¸ è¨­å®šæœªæˆåŠŸå¯«å…¥','error');
      return;
    }

    showToast('âœ… è¨­å®šå·²æˆåŠŸå„²å­˜');
  }else{
    showToast('âŒ æ›´æ–°å¤±æ•—','error');
  }
};

init();
</script>
</body>
</html>
