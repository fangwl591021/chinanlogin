<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šå¾Œå° v5.5</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: "Noto Sans TC", system-ui, sans-serif; background: #f8fafc; padding-bottom: 80px; }
#topBar { position: sticky; top: 0; background: #3c8050; color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; }
#userInfo { display: flex; align-items: center; gap: 10px; }
#userPicture { width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; }
.card { background: white; border-radius: 12px; padding: 16px; margin: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.section-title { font-weight: 800; font-size: 18px; color: #14532d; margin-bottom: 16px; }
.section { display: none; }
.section.active { display: block; }
#bottomNav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; }
.nav-btn { flex: 1; padding: 10px 0; text-align: center; font-size: 12px; font-weight: 600; cursor: pointer; color: #666; }
.nav-btn.active { color: #3c8050; border-top: 3px solid #3c8050; }
.status-reserved { color: #3c8050; font-weight: 600; cursor: pointer; }
.status-cancelled { color: #ef4444; font-weight: 600; cursor: pointer; }
.status-completed { color: #10b981; font-weight: 600; cursor: pointer; }
.loading { text-align: center; color: #888; padding: 20px; font-size: 16px; }
</style>
</head>

<body>
<!-- é ‚éƒ¨ -->
<div id="topBar">
  <div class="font-bold text-lg">ğŸšŒ ç©¿å±±ç”²å¾Œå°</div>
  <div id="userInfo">
    <img id="userPicture" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'%3E%3Crect fill='%23ddd' width='40' height='40'/%3E%3C/svg%3E" alt="é ­åƒ">
    <span id="userName">è¼‰å…¥ä¸­...</span>
  </div>
</div>

<main>
  <!-- æŸ¥è©¢ -->
  <section id="query" class="section active">
    <div class="card">
      <h2 class="section-title">ğŸ§¾ é ç´„æŸ¥è©¢</h2>
      <input type="text" id="search" placeholder="æœå°‹å§“åã€ç­æ¬¡æˆ–æ—¥æœŸ..." class="border border-gray-300 rounded-md p-2 w-full mb-3">
      <div id="loadingText" class="loading">â³ æŸ¥è©¢ä¸­...</div>
      <div id="tableContainer" style="overflow-x:auto; display:none;">
        <table class="min-w-full text-sm">
          <thead class="bg-green-700 text-white">
            <tr>
              <th class="p-2">æ—¥æœŸ</th>
              <th class="p-2">ç­æ¬¡</th>
              <th class="p-2">å§“å</th>
              <th class="p-2">ç‹€æ…‹</th>
            </tr>
          </thead>
          <tbody id="tbl"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- å„€è¡¨æ¿ -->
  <section id="dash" class="section">
    <div class="card">
      <h2 class="section-title">ğŸ“Š ç‡Ÿé‹å„€è¡¨æ¿</h2>
      <p>ç¸½é ç´„ï¼š<span id="statTotal">--</span>ï¼Œå·²æ­ä¹˜ï¼š<span id="statCompleted">--</span>ï¼Œå–æ¶ˆï¼š<span id="statCancelled">--</span></p>
    </div>
  </section>

  <!-- å¸æ©Ÿ -->
  <section id="driver" class="section">
    <div class="card">
      <h2 class="section-title">ğŸš å¸æ©Ÿå°ˆå€</h2>
      <button id="goCheck" class="bg-green-600 text-white px-4 py-2 rounded w-full text-lg">å‰å¾€æ ¸éŠ·ç³»çµ±</button>
    </div>
  </section>

  <!-- è¨­å®š -->
  <section id="config" class="section">
    <div class="card">
      <h2 class="section-title">âš™ï¸ ç³»çµ±è¨­å®š</h2>
      <p>æ­¤å€åŸŸç‚º Admin å°ˆç”¨ã€‚</p>
    </div>
  </section>
</main>

<!-- åº•éƒ¨å°è¦½ -->
<div id="bottomNav">
  <div class="nav-btn active" data-sec="query">ğŸ§¾ æŸ¥è©¢</div>
  <div class="nav-btn" data-sec="dash">ğŸ“Š å„€è¡¨æ¿</div>
  <div class="nav-btn" data-sec="driver">ğŸš å¸æ©Ÿ</div>
  <div class="nav-btn" data-sec="config">âš™ï¸ è¨­å®š</div>
</div>

<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const LIFF_ID = '2006590746-wgL4l54z';
let allData = [];
let userRole = 'user';
let userId = '';

document.addEventListener('DOMContentLoaded', init);

async function init() {
  await initLINE();
  setupNav();
  loadReservations();
}

// === åˆå§‹åŒ– LINE ç™»å…¥ ===
async function initLINE() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    const profile = await liff.getProfile();
    document.getElementById('userName').textContent = profile.displayName;
    document.getElementById('userPicture').src = profile.pictureUrl;
    userId = profile.userId;

    // æŸ¥è©¢è§’è‰²ï¼ˆå¾ GASï¼‰
    const res = await fetch(`${WORKER_URL}?mode=check&userId=${userId}`);
    const info = await res.json();
    userRole = info.user?.role || 'user';
  } catch {
    document.getElementById('userName').textContent = 'æ¸¬è©¦æ¨¡å¼';
    userRole = 'admin';
  }
}

// === è¼‰å…¥é ç´„è³‡æ–™ ===
async function loadReservations() {
  document.getElementById('loadingText').style.display = 'block';
  document.getElementById('tableContainer').style.display = 'none';

  try {
    const res = await fetch(WORKER_URL + '?mode=reservations');
    const json = await res.json();
    allData = json.reservations || [];
    renderTable(allData);
    updateStats();
  } catch (e) {
    document.getElementById('loadingText').textContent = 'âŒ ç„¡æ³•å–å¾—è³‡æ–™';
  }
}

// === æ¸²æŸ“è¡¨æ ¼ ===
function renderTable(data) {
  const order = { A1:1, B1:2, A2:3, B2:4 };
  data.sort((a,b)=>{
    const da = new Date(a.date), db = new Date(b.date);
    if (db - da !== 0) return db - da;
    return (order[a.route]||99)-(order[b.route]||99);
  });

  const tbody = document.getElementById('tbl');
  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-400 p-3">æš«ç„¡è³‡æ–™</td></tr>`;
  } else {
    tbody.innerHTML = data.map(r=>{
      const dateStr = r.date ? new Date(r.date).toISOString().slice(5,10) : '';
      let statusText='å·²é ç´„', statusClass='status-reserved';
      if (r.status==='å·²å–æ¶ˆ'||r.status==='cancelled'){ statusText='å·²å–æ¶ˆ'; statusClass='status-cancelled'; }
      else if (r.status==='å·²æ­ä¹˜'||r.status==='completed'){ statusText='å·²æ­ä¹˜'; statusClass='status-completed'; }
      return `
        <tr>
          <td class="p-2">${dateStr}</td>
          <td class="p-2">${r.route||''}</td>
          <td class="p-2">${r.name||''}</td>
          <td class="p-2 ${statusClass}" onclick="changeStatus('${r.id}','${r.status||'å·²é ç´„'}')">${statusText}</td>
        </tr>`;
    }).join('');
  }

  document.getElementById('loadingText').style.display='none';
  document.getElementById('tableContainer').style.display='block';
}

// === é»æ“Šç‹€æ…‹ä¿®æ”¹ï¼ˆAdminï¼‰ ===
async function changeStatus(id, current) {
  if (userRole !== 'admin') return;
  const next = current === 'å·²å–æ¶ˆ' ? 'å·²æ­ä¹˜' :
               current === 'å·²æ­ä¹˜' ? 'å·²é ç´„' : 'å·²å–æ¶ˆ';
  if (!confirm(`ç¢ºå®šå°‡ç‹€æ…‹æ”¹ç‚ºã€Œ${next}ã€ï¼Ÿ`)) return;
  try {
    await fetch(WORKER_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ type:'updateStatus', id, status:next })
    });
    alert(`âœ… å·²æ›´æ–°ç‹€æ…‹ç‚ºã€Œ${next}ã€`);
    loadReservations();
  } catch (e) {
    alert('âŒ æ›´æ–°å¤±æ•—');
  }
}

// === æœå°‹ ===
document.getElementById('search').addEventListener('input', e=>{
  const key = e.target.value.toLowerCase();
  const filtered = allData.filter(r =>
    (r.name && r.name.toLowerCase().includes(key)) ||
    (r.route && r.route.toLowerCase().includes(key)) ||
    (r.date && r.date.includes(key))
  );
  renderTable(filtered);
});

// === çµ±è¨ˆ ===
function updateStats() {
  const total = allData.length;
  const cancelled = allData.filter(x=>x.status==='å·²å–æ¶ˆ'||x.status==='cancelled').length;
  const completed = allData.filter(x=>x.status==='å·²æ­ä¹˜'||x.status==='completed').length;
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statCancelled').textContent = cancelled;
  document.getElementById('statCompleted').textContent = completed;
}

// === å°è¦½ ===
function setupNav() {
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.section').forEach(sec=>sec.classList.remove('active'));
      document.getElementById(btn.dataset.sec).classList.add('active');
    });
  });
  document.getElementById('goCheck').addEventListener('click',()=>{
    liff.openWindow({ url:'https://liff.line.me/2006590746-A8YD0ZD9', external:false });
  });
}
</script>
</body>
</html>
