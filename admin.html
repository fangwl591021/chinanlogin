<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç©¿å±±ç”²å°ˆè»Šç®¡ç†å¾Œå° v2.0</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { background:#f3f4f6; font-family: "Noto Sans TC", system-ui, sans-serif; }
.card { background:white; border-radius:14px; padding:22px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
.section-title { font-weight:700; font-size:20px; color:#2d3748; margin-bottom:12px; display:flex; align-items:center; }
.section-title::before { content:""; display:inline-block; width:6px; height:20px; background:#3c8050; border-radius:3px; margin-right:8px; }
label, th, td, button, input, textarea { font-size:16px !important; }
button { transition:background .2s; }
</style>
</head>
<body class="p-6">

<header class="bg-green-700 text-white text-center py-5 rounded-lg shadow-md mb-8">
  <h1 class="text-3xl font-bold">ğŸšŒ ç©¿å±±ç”²å°ˆè»Šå¾Œå°ç®¡ç†ç³»çµ±</h1>
  <p class="text-lg opacity-90">ç‡Ÿé‹è¨­å®š Â· æ•¸æ“šå„€è¡¨ Â· é ç´„æŸ¥è©¢ Â· å¸æ©Ÿç­è¡¨</p>
</header>

<div class="grid gap-8 md:grid-cols-3">

  <!-- ğŸ”§ A. ç‡Ÿé‹è¨­å®šä¸­å¿ƒ -->
  <div class="card md:col-span-1">
    <div class="section-title">ğŸ”§ ç‡Ÿé‹è¨­å®šä¸­å¿ƒ</div>

    <label class="block font-semibold mb-2">é‹ç‡Ÿæ¨¡å¼ï¼š</label>
    <div class="flex gap-4 mb-4">
      <label class="font-medium"><input type="radio" name="mode" value="S3" class="mr-1"> å–®è¶Ÿåˆ¶ï¼ˆS3ï¼‰</label>
      <label class="font-medium"><input type="radio" name="mode" value="S4" class="mr-1"> ä¾†å›åˆ¶ï¼ˆS4ï¼‰</label>
    </div>

    <label class="block font-semibold mb-2">åé¡è¨­å®šï¼š</label>
    <div class="grid grid-cols-2 gap-3 mb-5">
      <div>A1ï¼š<input id="capA1" type="number" value="6" class="border rounded px-2 w-24 text-center"></div>
      <div>A2ï¼š<input id="capA2" type="number" value="6" class="border rounded px-2 w-24 text-center"></div>
      <div>B1ï¼š<input id="capB1" type="number" value="6" class="border rounded px-2 w-24 text-center"></div>
      <div>B2ï¼š<input id="capB2" type="number" value="6" class="border rounded px-2 w-24 text-center"></div>
    </div>

    <label class="block font-semibold mb-2">åŠŸèƒ½é–‹é—œï¼š</label>
    <div class="space-y-2 mb-5">
      <label><input type="checkbox" id="enableBooking" class="mr-1"> é–‹æ”¾é ç´„</label><br>
      <label><input type="checkbox" id="enableCancel" class="mr-1"> å…è¨±å–æ¶ˆ</label>
    </div>

    <label class="block font-semibold mb-2">å…¬å‘Šæ–‡å­—ï¼š</label>
    <textarea id="announcement" rows="3" class="w-full border rounded px-2 py-1 mb-4 text-lg"></textarea>

    <button id="saveConfig" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded w-full text-lg">
      ğŸ’¾ å„²å­˜è¨­å®š
    </button>
  </div>

  <!-- ğŸ“Š B. ç‡Ÿé‹å„€è¡¨æ¿ -->
  <div class="card md:col-span-2">
    <div class="section-title">ğŸ“Š ç‡Ÿé‹æ•¸æ“šå„€è¡¨æ¿</div>

    <div class="grid grid-cols-2 gap-6 mb-6">
      <div>
        <p class="font-semibold text-lg">ä»Šæ—¥ç¸½é ç´„æ•¸ï¼š</p>
        <p id="todayTotal" class="text-3xl font-bold text-green-700 mt-1">--</p>
      </div>
      <div>
        <p class="font-semibold text-lg">å‰©é¤˜åé¡ï¼š</p>
        <p id="remainingSeats" class="text-3xl font-bold text-blue-700 mt-1">--</p>
      </div>
    </div>

    <canvas id="chartTrips" height="120"></canvas>
  </div>
</div>

<!-- ğŸ§¾ C. é ç´„æŸ¥è©¢èˆ‡ç®¡ç† -->
<div class="card mt-8">
  <div class="section-title">ğŸ§¾ é ç´„æŸ¥è©¢èˆ‡ç®¡ç†</div>
  <div class="flex items-center gap-3 mb-4">
    <input id="searchInput" placeholder="è¼¸å…¥å§“å / æ—¥æœŸ / ç­æ¬¡æœå°‹..." class="border rounded px-3 py-2 w-full text-lg">
    <button id="exportCsv" class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800 text-lg">ğŸ“¤ åŒ¯å‡ºCSV</button>
  </div>
  <div id="reservationTable" class="overflow-x-auto text-base">
    <table class="min-w-full border">
      <thead class="bg-green-700 text-white">
        <tr>
          <th class="p-3 border">æ—¥æœŸ</th>
          <th class="p-3 border">ç­æ¬¡</th>
          <th class="p-3 border">å§“å</th>
          <th class="p-3 border">ç³»æ‰€</th>
          <th class="p-3 border">é›»è©±</th>
          <th class="p-3 border">ç‹€æ…‹</th>
          <th class="p-3 border">å‹•ä½œ</th>
        </tr>
      </thead>
      <tbody id="reservationBody"></tbody>
    </table>
  </div>
</div>

<!-- ğŸ§â€â™‚ï¸ D. å¸æ©Ÿç­è¡¨ -->
<div class="card mt-8">
  <div class="section-title">ğŸš å¸æ©Ÿç­è¡¨ï¼ˆæ¯æ—¥é‹è¡Œï¼‰</div>
  <div class="overflow-x-auto">
    <table class="min-w-full border text-base">
      <thead class="bg-blue-700 text-white">
        <tr>
          <th class="p-3 border">æ—¥æœŸ</th>
          <th class="p-3 border">A1ï¼ˆ22:00â†’22:30ï¼‰</th>
          <th class="p-3 border">A2ï¼ˆ23:00â†’23:30ï¼‰</th>
          <th class="p-3 border">B1ï¼ˆ22:30â†’23:00ï¼‰</th>
          <th class="p-3 border">B2ï¼ˆ23:30â†’24:00ï¼‰</th>
        </tr>
      </thead>
      <tbody id="driverTable">
        <tr class="text-center">
          <td class="p-2 border">2025-10-13</td>
          <td class="p-2 border">ç‹å¤§æ˜</td>
          <td class="p-2 border">æå°ç¾</td>
          <td class="p-2 border">å¼µå¿—å¼·</td>
          <td class="p-2 border">æ—ä½©èŠ¬</td>
        </tr>
        <tr class="text-center">
          <td class="p-2 border">2025-10-14</td>
          <td class="p-2 border">ç‹å¤§æ˜</td>
          <td class="p-2 border">ç‹å¤§æ˜</td>
          <td class="p-2 border">é™³æƒ å©·</td>
          <td class="p-2 border">é™³æƒ å©·</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ğŸš€ JS æ§åˆ¶ -->
<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';

async function loadConfig(){
  try{
    const res = await fetch(`${WORKER_URL}?mode=config`);
    const cfg = await res.json();
    document.querySelector(`input[value="${cfg.operationMode}"]`).checked = true;
    ['A1','A2','B1','B2'].forEach(k=>{
      document.getElementById('cap'+k).value = cfg['capacity'+k] || 6;
    });
    document.getElementById('enableBooking').checked = cfg.enableBooking;
    document.getElementById('enableCancel').checked = cfg.enableCancel;
    document.getElementById('announcement').value = cfg.announcement || '';
  }catch(e){ console.warn('è®€å–è¨­å®šå¤±æ•—',e); }
}

document.getElementById('saveConfig').onclick = async ()=>{
  const data = {
    operationMode: document.querySelector('input[name="mode"]:checked').value,
    capacityA1: +document.getElementById('capA1').value,
    capacityA2: +document.getElementById('capA2').value,
    capacityB1: +document.getElementById('capB1').value,
    capacityB2: +document.getElementById('capB2').value,
    enableBooking: document.getElementById('enableBooking').checked,
    enableCancel: document.getElementById('enableCancel').checked,
    announcement: document.getElementById('announcement').value
  };
  const res = await fetch(WORKER_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({type:'updateConfig',data})
  });
  const result = await res.json();
  alert(result.status==='success'?'âœ… è¨­å®šå·²å„²å­˜':'âŒ å„²å­˜å¤±æ•—');
};

async function loadDashboard(){
  const res = await fetch(`${WORKER_URL}?mode=dashboard`);
  const data = await res.json();
  document.getElementById('todayTotal').textContent = data.todayTotal || 0;
  document.getElementById('remainingSeats').textContent = data.remainingSeats || 0;
  renderChart(data.chartData || {});
}

function renderChart(dataset){
  const ctx = document.getElementById('chartTrips');
  new Chart(ctx,{
    type:'bar',
    data:{
      labels:dataset.labels || ['A1','A2','B1','B2'],
      datasets:[{
        label:'é ç´„æ•¸',
        data:dataset.values || [0,0,0,0],
        backgroundColor:['#4caf50','#81c784','#64b5f6','#2196f3']
      }]
    },
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}

async function loadReservations(){
  const res = await fetch(`${WORKER_URL}?mode=reservationsAll`);
  const list = await res.json();
  const tbody = document.getElementById('reservationBody');
  tbody.innerHTML='';
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="border p-2">${r.date}</td>
      <td class="border p-2">${r.route}</td>
      <td class="border p-2">${r.name}</td>
      <td class="border p-2">${r.department}</td>
      <td class="border p-2">${r.phone}</td>
      <td class="border p-2">${r.status}</td>
      <td class="border p-2 text-center"><button class="text-red-600" onclick="cancelReservation('${r.id}')">å–æ¶ˆ</button></td>`;
    tbody.appendChild(tr);
  });
}

document.getElementById('exportCsv').onclick=()=>{
  const rows=[...document.querySelectorAll('#reservationBody tr')].map(tr=>[...tr.children].map(td=>td.innerText));
  const csv='æ—¥æœŸ,ç­æ¬¡,å§“å,ç³»æ‰€,é›»è©±,ç‹€æ…‹\n'+rows.map(r=>r.join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='reservations.csv';a.click();
};

async function cancelReservation(id){
  if(!confirm('ç¢ºå®šå–æ¶ˆé€™ç­†é ç´„å—ï¼Ÿ'))return;
  const res=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'cancelAdmin',id})});
  const result=await res.json();
  alert(result.status==='success'?'âœ… å·²å–æ¶ˆ':'âŒ å–æ¶ˆå¤±æ•—');
  loadReservations();
}

// åˆå§‹åŒ–
window.addEventListener('load',()=>{
  loadConfig();
  loadDashboard();
  loadReservations();
});
</script>
</body>
</html>
