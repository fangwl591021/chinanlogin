<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šå¾Œå°ç³»çµ± v6.6.0</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: "Noto Sans TC", sans-serif; background: #f8fafc; color: #334155; }
.nav-btn { flex: 1; text-align: center; padding: 10px 0; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.active-tab { background: #14532d; color: white; border-radius: 12px; }
.status-reserved { color: #16a34a; font-weight: 700; }
.status-cancelled { color: #dc2626; font-weight: 700; }
.status-completed { color: #2563eb; font-weight: 700; }
.card { background:white; border-radius:16px; padding:24px; box-shadow:0 2px 10px rgba(0,0,0,0.08); margin:16px auto; max-width:900px; margin-bottom: 100px; }
.toast { position: fixed; bottom: 80px; right: 20px; background: #16a34a; color: white; padding: 10px 20px; border-radius: 8px; opacity: 0; transition: opacity .3s ease-in-out; }
.toast.show { opacity: 1; }
.reservation-table-container { overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px; }
.reservation-table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 360px; }
.reservation-table th, .reservation-table td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
.reservation-table thead { background: #14532d; color: white; position: sticky; top: 0; z-index: 10; }
.reservation-table th { font-weight: 600; }
.reservation-table tbody tr:hover { background-color: #f8fafc; }
.error-message { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 16px; border-radius: 8px; margin: 16px; text-align: center; }
.login-prompt { background: #fffbeb; border: 1px solid #fef3c7; color: #92400e; padding: 20px; border-radius: 8px; margin: 16px; text-align: center; }
</style>
</head>

<body>
<div id="loading" class="flex flex-col items-center justify-center h-screen text-center text-gray-600">
  <div class="text-3xl mb-3">ğŸšŒ ç©¿å±±ç”²å¾Œå°è¼‰å…¥ä¸­â€¦</div>
  <p>è«‹ç¨å€™é©—è­‰æ‚¨çš„èº«åˆ†</p>
  <div id="loadingDetails" class="mt-4 text-sm text-gray-500"></div>
</div>

<div id="loginPrompt" class="hidden flex-col items-center justify-center h-screen text-center p-6">
  <div class="text-4xl mb-4">ğŸ”</div>
  <h2 class="text-2xl font-bold text-amber-600 mb-2">éœ€è¦ç™»å…¥</h2>
  <p class="text-gray-700 mb-4">è«‹å…ˆç™»å…¥ LINE å¸³è™Ÿä»¥ä½¿ç”¨å¾Œå°ç³»çµ±</p>
  <button id="loginButton" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg text-lg font-bold">ğŸ“± é»æ­¤ç™»å…¥ LINE</button>
  <p class="text-sm text-gray-500 mt-4">è«‹åœ¨ LINE App ä¸­é–‹å•Ÿæ­¤é é¢</p>
</div>

<div id="error" class="hidden flex-col items-center justify-center h-screen text-center p-6">
  <div class="text-4xl mb-4">âŒ</div>
  <h2 class="text-2xl font-bold text-red-600 mb-2">ç³»çµ±åˆå§‹åŒ–å¤±æ•—</h2>
  <p id="errorMessage" class="text-gray-700 mb-4"></p>
  <div class="space-x-4">
    <button onclick="location.reload()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">é‡æ–°è¼‰å…¥é é¢</button>
    <button onclick="showDebugInfo()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">é¡¯ç¤ºé™¤éŒ¯è³‡è¨Š</button>
  </div>
  <div id="debugInfo" class="hidden mt-6 p-4 bg-gray-100 rounded-lg text-left text-sm max-w-md overflow-auto"></div>
</div>

<div id="main" class="hidden">
  <header class="bg-green-800 text-white flex justify-between items-center px-6 py-4 sticky top-0 z-10">
    <h1 class="text-xl font-bold">ğŸšŒ ç©¿å±±ç”²å¾Œå°ç³»çµ±</h1>
    <div class="flex items-center space-x-2">
      <img id="userPicture" class="w-10 h-10 rounded-full" alt="ç”¨æˆ¶é ­åƒ" />
      <span id="userName"></span>
      <button onclick="location.reload()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm ml-4">ğŸ”„ é‡æ–°è¼‰å…¥</button>
    </div>
  </header>
  <section id="dashboard" class="card">
    <h2 class="font-bold text-xl mb-4 text-green-900">ğŸ“Š å³æ™‚å„€è¡¨æ¿</h2>
    <div id="statsArea" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-green-100 p-4 rounded-xl text-center"><p class="text-gray-700 font-semibold">ä»Šæ—¥é ç´„</p><p id="todayCount" class="text-3xl font-bold text-green-700">-</p></div>
      <div class="bg-red-100 p-4 rounded-xl text-center"><p class="text-gray-700 font-semibold">å·²å–æ¶ˆ</p><p id="cancelCount" class="text-3xl font-bold text-red-700">-</p></div>
      <div class="bg-blue-100 p-4 rounded-xl text-center"><p class="text-gray-700 font-semibold">å·²æ­ä¹˜</p><p id="checkinCount" class="text-3xl font-bold text-blue-700">-</p></div>
    </div>
  </section>
</div>

<div id="toast" class="toast">âœ… å·²æˆåŠŸæ›´æ–°</div>

<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const LIFF_ID = '2006590746-wgL4l54z';
const MASTER_ADMINS = ['U84b2e88d818b98575f45fcf14a380517','Ue7a07fe317565389fbf4479172088f87'];

function updateLoadingStatus(msg){document.getElementById('loadingDetails').textContent = msg; console.log('ğŸªª',msg);}

document.getElementById('loginButton').addEventListener('click',()=>liff.login());

async function init(){
  try{
    updateLoadingStatus('ğŸ”§ åˆå§‹åŒ– LIFF SDK...');
    await liff.init({liffId:LIFF_ID});
    if(!liff.isLoggedIn()){updateLoadingStatus('æœªç™»å…¥');showLoginPrompt();return;}
    const profile=await liff.getProfile();
    updateLoadingStatus('ç™»å…¥æˆåŠŸï¼Œé©—è­‰ä¸­...');
    if(!MASTER_ADMINS.includes(profile.userId)){
      showError('ğŸš« ç„¡æ¬Šé™ä½¿ç”¨æ­¤ç³»çµ±',`ä½¿ç”¨è€…ï¼š${profile.displayName}<br>IDï¼š${profile.userId}`);
      return;
    }
    document.getElementById('userPicture').src=profile.pictureUrl;
    document.getElementById('userName').textContent=profile.displayName;
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('main').classList.remove('hidden');
    await loadDashboard();
  }catch(e){
    showError('åˆå§‹åŒ–éŒ¯èª¤ï¼š'+e.message,'è‹¥éŒ¯èª¤ç‚º contextTokenï¼Œè«‹ç¢ºèª LIFF Endpoint è¨­å®šèˆ‡å¯¦éš›ç¶²å€ç›¸åŒ');
  }
}

async function loadDashboard(){
  try{
    const res=await fetch(`${WORKER_URL}?mode=dashboard`);
    const data=await res.json();
    if(data.status==='success'){
      document.getElementById('todayCount').textContent=data.dashboard.todayCount;
      document.getElementById('cancelCount').textContent=data.dashboard.cancelCount;
      document.getElementById('checkinCount').textContent=data.dashboard.checkinCount;
    }else{console.warn('Dashboard è³‡æ–™éŒ¯èª¤',data);}
  }catch(err){console.error('Dashboard è¼‰å…¥éŒ¯èª¤',err);}
}

function showError(msg,detail=''){
  document.getElementById('loading').classList.add('hidden');
  document.getElementById('main').classList.add('hidden');
  document.getElementById('error').classList.remove('hidden');
  document.getElementById('errorMessage').innerHTML=msg+(detail?`<br><small>${detail}</small>`:'');
}
function showLoginPrompt(){
  document.getElementById('loading').classList.add('hidden');
  document.getElementById('loginPrompt').classList.remove('hidden');
}
function showDebugInfo(){
  const info={time:new Date().toLocaleString(),liffId:LIFF_ID,url:location.href,isLogged:liff.isLoggedIn(),ua:navigator.userAgent};
  document.getElementById('debugInfo').innerHTML=`<pre>${JSON.stringify(info,null,2)}</pre>`;
  document.getElementById('debugInfo').classList.remove('hidden');
}

window.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
