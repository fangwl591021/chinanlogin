<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šå¾Œå° v3.8</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
  font-family: "Noto Sans TC", system-ui, sans-serif;
  background: #f8fafc;
  color: #334155;
  margin: 0;
  padding-bottom: 70px;
}
.card {
  background:white;
  border-radius:16px;
  padding:16px;
  box-shadow:0 2px 10px rgba(0,0,0,0.08);
  margin:16px auto;
  max-width:100%;
}
.section-title {
  font-weight:800;
  font-size:20px;
  color:#14532d;
  margin-bottom:16px;
  display:flex;
  align-items:center;
}
.section-title::before {
  content:"";
  display:inline-block;
  width:8px;
  height:24px;
  background:#22c55e;
  border-radius:3px;
  margin-right:10px;
}

#topBar {
  position: sticky;
  top: 0;
  background: #3c8050;
  color: white;
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 50;
}
#userProfile {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor:pointer;
}
#userProfile img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 2px solid #fff;
  background: #ccc;
}
#userName {
  font-weight: 600;
  font-size: 14px;
}

#bottomNav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: white;
  border-top: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-around;
  padding: 8px 0;
  z-index: 50;
}
.nav-btn {
  flex: 1;
  text-align: center;
  color: #475569;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  padding: 8px 0;
}
.nav-btn.active {
  color: #3c8050;
  font-weight: 800;
}

.search-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
  margin-bottom: 15px;
  box-sizing: border-box;
}

.table-wrapper {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.reservation-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}
.table-header {
  background: #3c8050;
  color: white;
  font-weight: bold;
}
.table-header th {
  padding: 10px 6px;
  text-align: left;
  font-size: 12px;
  border: 1px solid #2f6842;
  word-break: break-word;
}
.table-row {
  border-bottom: 1px solid #e5e7eb;
}
.table-row:hover {
  background: #f8faf8;
}
.table-row td {
  padding: 10px 6px;
  font-size: 12px;
  border: 1px solid #e5e7eb;
  word-break: break-word;
}
.passenger-name {
  color: #0066cc;
  cursor: pointer;
  font-weight: 600;
  text-decoration: underline;
}
.passenger-name:hover {
  color: #0052a3;
}
.status-booked {
  color: #3c8050;
  font-weight: 600;
}
.status-cancelled {
  color: #ccc;
  text-decoration: line-through;
}
.status-checkedin {
  color: #27ACB2;
  font-weight: 600;
}
.status-notcheckedin {
  color: #f44336;
  font-weight: 600;
}
.no-data {
  text-align: center;
  color: #999;
  padding: 40px 20px;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}
.modal.active {
  display: flex;
}
.modal-content {
  background: white;
  border-radius: 12px;
  padding: 24px;
  max-width: 90%;
  width: 100%;
  max-width: 380px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}
.modal-header {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 20px;
  border-bottom: 2px solid #3c8050;
  padding-bottom: 10px;
}
.modal-body {
  margin-bottom: 20px;
  line-height: 2;
}
.modal-body div {
  margin-bottom: 12px;
}
.modal-label {
  color: #666;
  font-size: 12px;
}
.modal-value {
  color: #333;
  font-weight: 600;
  font-size: 14px;
}
.phone-link {
  color: #0066cc;
  text-decoration: none;
  font-weight: 600;
  cursor: pointer;
}
.modal-close {
  background: #e0e0e0;
  color: #333;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  width: 100%;
}
.modal-close:hover {
  background: #ccc;
}

.checkin-btn {
  background: #3c8050;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
}
.checkin-btn:hover {
  background: #2f6842;
}
.checkin-btn:disabled {
  background: #ccc;
  cursor: not-allowed;
}

/* ç„¡æ¬Šé™ / è¼‰å…¥ä¸­ */
.auth-screen {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: white;
  z-index: 9999;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 20px;
}
.auth-screen.active {
  display: flex;
}
.auth-screen h2 {
  font-size: 24px;
  color: #333;
  margin: 0;
}
.auth-screen p {
  color: #666;
  font-size: 16px;
  text-align: center;
  max-width: 300px;
}
.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #f0f0f0;
  border-top-color: #3c8050;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
.error-box {
  text-align: center;
  color: #b91c1c;
}
.error-box h2 {
  color: #b91c1c;
  font-size: 32px;
}
</style>
</head>

<body>

<div id="authScreen" class="auth-screen active">
  <div class="spinner"></div>
  <h2>ç³»çµ±åˆå§‹åŒ–ä¸­...</h2>
  <p>æ­£åœ¨é©—è­‰èº«ä»½ï¼Œè«‹ç¨å€™</p>
</div>

<div id="topBar">
  <div style="font-weight: bold; font-size: 18px;">ğŸšŒ ç©¿å±±ç”²å¾Œå°ç³»çµ±</div>
  <div id="userProfile">
    <img id="userPicture" src="" alt="é ­åƒ" style="display:none;">
    <span id="userName">-</span>
  </div>
</div>

<main id="mainContent" style="padding-bottom: 100px; display:none;">

  <!-- å„€è¡¨æ¿ -->
  <section id="dashboard" class="card hidden">
    <h2 class="section-title">ğŸ“Š ç‡Ÿé‹å„€è¡¨æ¿</h2>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
      <div style="background:#f0fdf4; padding:16px; border-radius:8px; border-left:4px solid #3c8050;">
        <div style="color:#666; font-size:13px;">ç¸½é ç´„æ•¸</div>
        <div style="font-size:28px; font-weight:800; color:#3c8050;" id="stat-total">--</div>
      </div>
      <div style="background:#f0fdf4; padding:16px; border-radius:8px; border-left:4px solid #3c8050;">
        <div style="color:#666; font-size:13px;">ä»Šæ—¥é ç´„</div>
        <div style="font-size:28px; font-weight:800; color:#3c8050;" id="stat-today">--</div>
      </div>
      <div style="background:#f0fdf4; padding:16px; border-radius:8px; border-left:4px solid #3c8050; grid-column:1/3;">
        <div style="color:#666; font-size:13px;">æ ¸éŠ·ç‡</div>
        <div style="font-size:28px; font-weight:800; color:#3c8050;" id="stat-rate">--%</div>
      </div>
    </div>
  </section>

  <!-- æŸ¥è©¢ -->
  <section id="reservations" class="card hidden">
    <h2 class="section-title">ğŸ§¾ é ç´„æŸ¥è©¢èˆ‡ç®¡ç†</h2>
    <input type="text" id="searchInput" class="search-input" placeholder="è¼¸å…¥å§“å / æ—¥æœŸ / ç­æ¬¡æœå°‹...">
    <div class="table-wrapper">
      <table class="reservation-table">
        <thead class="table-header">
          <tr>
            <th style="width:15%;">æ—¥æœŸ</th>
            <th style="width:8%;">ç­æ¬¡</th>
            <th style="width:15%;">å§“å</th>
            <th style="width:13%;">é ç´„ç‹€æ…‹</th>
            <th style="width:13%;">æ­ä¹˜ç‹€æ…‹</th>
          </tr>
        </thead>
        <tbody id="reservation-list"></tbody>
      </table>
    </div>
  </section>

  <!-- æ ¸éŠ·å€ -->
  <section id="checkin" class="card hidden">
    <h2 class="section-title">âœ… æ ¸éŠ·ç®¡ç†</h2>
    <p style="color: #999; font-size: 14px; margin-bottom:16px;">é€²å…¥å¸æ©Ÿæ ¸éŠ·ç³»çµ±é€²è¡Œæ ¸éŠ·ä½œæ¥­...</p>
    <a href="https://liff.line.me/2006590746-A8YD0ZD9" style="display:inline-block; background:#3c8050; color:white; padding:10px 16px; border-radius:6px; text-decoration:none; font-weight:600;">å‰å¾€æ ¸éŠ·ç³»çµ± ğŸš</a>
  </section>

  <!-- å¸æ©Ÿ -->
  <section id="drivers" class="card hidden">
    <h2 class="section-title">ğŸš å¸æ©Ÿç­è¡¨</h2>
    <p>æ­¤å€é¡¯ç¤ºå„ç­æ¬¡å¸æ©Ÿé…ç½®ï¼Œæœªä¾†å¯ä¸²æ¥ Google Calendarã€‚</p>
    <ul style="list-style:none; padding:0; margin-top:12px;">
      <li style="padding:8px 0; border-bottom:1px solid #eee;">A1 - é™³å¸æ©Ÿ</li>
      <li style="padding:8px 0; border-bottom:1px solid #eee;">A2 - ç‹å¸æ©Ÿ</li>
      <li style="padding:8px 0; border-bottom:1px solid #eee;">B1 - å³å¸æ©Ÿ</li>
      <li style="padding:8px 0; border-bottom:1px solid #eee;">B2 - æå¸æ©Ÿ</li>
    </ul>
  </section>

  <!-- è¨­å®š -->
  <section id="config" class="card hidden">
    <h2 class="section-title">âš™ï¸ ç‡Ÿé‹è¨­å®šä¸­å¿ƒ</h2>
    <p>ï¼ˆAdmin å°ˆç”¨åŠŸèƒ½ï¼‰</p>
    <button style="background:#3c8050;color:white;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;font-weight:600;margin-top:10px;">ğŸ’¾ å„²å­˜è¨­å®š</button>
  </section>

</main>

<div id="bottomNav">
  <div class="nav-btn" data-target="dashboard">ğŸ“Š å„€è¡¨æ¿</div>
  <div class="nav-btn" data-target="reservations">ğŸ§¾ æŸ¥è©¢</div>
  <div class="nav-btn" data-target="checkin">âœ… æ ¸éŠ·</div>
  <div class="nav-btn" data-target="drivers">ğŸš å¸æ©Ÿ</div>
  <div class="nav-btn" data-target="config">âš™ï¸ è¨­å®š</div>
</div>

<!-- è©³ç´°è³‡è¨Šå½ˆå‡ºçª— -->
<div id="infoModal" class="modal">
  <div class="modal-content">
    <div class="modal-header" id="modal-name"></div>
    <div class="modal-body">
      <div>
        <div class="modal-label">ç§‘ç³»</div>
        <div class="modal-value" id="modal-department"></div>
      </div>
      <div>
        <div class="modal-label">å­¸è™Ÿ</div>
        <div class="modal-value" id="modal-studentid"></div>
      </div>
      <div>
        <div class="modal-label">é›»è©±</div>
        <div class="modal-value">
          <a id="modal-phone" href="#" class="phone-link"></a>
        </div>
      </div>
    </div>
    <button class="modal-close" onclick="closeModal()">é—œé–‰</button>
  </div>
</div>

<script>
const LIFF_ID = '2006590746-A8YD0ZD9';
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbza2qFcrQt1PS6Y4p4u2gSXovvFxWecEjjIh5ov1cIk_65zgdFJA0xjVuS3qr7WvlgAzA/exec';
const DEV_MODE = new URLSearchParams(window.location.search).has('dev');

let allReservations = [];
let userProfile = { name: '', picture: '', role: 'user', userId: '' };

async function waitForLIFF() {
  let attempts = 0;
  while (typeof liff === 'undefined' && attempts < 50) {
    await new Promise(r => setTimeout(r, 100));
    attempts++;
  }
  if (typeof liff === 'undefined') {
    throw new Error('LIFF SDK åŠ è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  try {
    if (DEV_MODE) {
      console.log('ğŸ”§ é€²å…¥é–‹ç™¼æ¨¡å¼');
      await initDevMode();
    } else {
      await waitForLIFF();
      await initLIFF();
    }
  } catch (e) {
    console.error('åˆå§‹åŒ–å¤±æ•—:', e);
    showAuthScreen('âŒ ç³»çµ±éŒ¯èª¤', e.message || 'ç„¡æ³•åˆå§‹åŒ–ç³»çµ±\n\næç¤ºï¼šæœ¬åœ°æ¸¬è©¦å¯åŠ ä¸Š ?dev åƒæ•¸');
  }
});

async function initLIFF() {
  try {
    await liff.init({ liffId: LIFF_ID });
  } catch (e) {
    throw new Error('LIFF åˆå§‹åŒ–å¤±æ•—: ' + e.message);
  }
  
  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }
  
  const profile = await liff.getProfile();
  userProfile.userId = profile.userId;
  userProfile.name = profile.displayName;
  userProfile.picture = profile.pictureUrl;
  
  document.getElementById('userName').textContent = profile.displayName;
  document.getElementById('userPicture').src = profile.pictureUrl;
  document.getElementById('userPicture').style.display = 'block';
  
  await verifyAdmin(profile.userId);
}

async function initDevMode() {
  // æœ¬åœ°é–‹ç™¼æ¨¡å¼ (è¨ªå• ?dev åƒæ•¸)
  userProfile.userId = 'dev-user-123';
  userProfile.name = 'é–‹ç™¼è€…';
  userProfile.picture = 'https://via.placeholder.com/40?text=DEV';
  
  document.getElementById('userName').textContent = 'é–‹ç™¼è€… (DEV)';
  document.getElementById('userPicture').src = userProfile.picture;
  document.getElementById('userPicture').style.display = 'block';
  
  userProfile.role = 'admin';
  await loadReservations();
  showMainContent();
}

async function verifyAdmin(userId) {
  try {
    const res = await fetch(`${GAS_URL}?mode=check&userId=${encodeURIComponent(userId)}`);
    const data = await res.json();
    
    if (data.user && data.user.role === 'admin') {
      userProfile.role = 'admin';
      await loadReservations();
      showMainContent();
    } else {
      showAuthScreen('ğŸš« ç„¡æ¬Šé™', 'æ‚¨æ²’æœ‰æ¬Šé™ä½¿ç”¨æ­¤ç³»çµ±\nå¦‚éœ€é–‹é€šï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚');
      if (liff.isInClient()) {
        setTimeout(() => liff.closeWindow(), 3000);
      }
    }
  } catch (e) {
    console.error('é©—è­‰å¤±æ•—:', e);
    showAuthScreen('âŒ é©—è­‰éŒ¯èª¤', e.message);
  }
}

async function loadReservations() {
  try {
    const res = await fetch(`${WORKER_URL}?mode=reservations`);
    const result = await res.json();
    allReservations = result.reservations || [];
    
    const routes = ['A1', 'B1', 'A2', 'B2'];
    allReservations.sort((a, b) => {
      const dateCompare = (a.date || '').localeCompare(b.date || '');
      if (dateCompare !== 0) return dateCompare;
      const routeOrder = routes.indexOf(a.route) - routes.indexOf(b.route);
      return routeOrder !== 0 ? routeOrder : (a.name || '').localeCompare(b.name || '');
    });
    
    updateStats();
  } catch (e) {
    console.error('è¼‰å…¥é ç´„å¤±æ•—:', e);
    allReservations = [];
  }
}

function updateStats() {
  const total = allReservations.length;
  const today = new Date().toISOString().split('T')[0];
  const todayCount = allReservations.filter(r => r.date?.includes(today)).length;
  const checked = allReservations.filter(r => r.checkinStatus === 'Y').length;
  const rate = total ? Math.round((checked / total) * 100) : 0;
  
  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-today').textContent = todayCount;
  document.getElementById('stat-rate').textContent = rate + '%';
}

function showMainContent() {
  document.getElementById('authScreen').classList.remove('active');
  document.getElementById('mainContent').style.display = 'block';
  setupNavigation();
  showSection('dashboard');
}

function showAuthScreen(title, message) {
  const screen = document.getElementById('authScreen');
  screen.innerHTML = `
    <div class="error-box">
      <h2>${title}</h2>
      <p>${message}</p>
    </div>
  `;
  screen.classList.add('active');
  document.getElementById('mainContent').style.display = 'none';
}

function setupNavigation() {
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      showSection(target);
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });
  
  document.getElementById('searchInput').addEventListener('input', filterReservations);
  document.getElementById('infoModal').addEventListener('click', (e) => {
    if (e.target.id === 'infoModal') closeModal();
  });
}

function showSection(sectionId) {
  document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
  const section = document.getElementById(sectionId);
  if (section) {
    section.classList.remove('hidden');
    if (sectionId === 'reservations') renderReservations(allReservations);
  }
}

function renderReservations(data) {
  const tbody = document.getElementById('reservation-list');
  tbody.innerHTML = '';
  
  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="no-data">æš«ç„¡é ç´„è³‡æ–™</td></tr>';
    return;
  }
  
  data.forEach(r => {
    const tr = document.createElement('tr');
    tr.className = 'table-row';
    
    let phoneDisplay = r.phone || 'æœªæä¾›';
    if (phoneDisplay !== 'æœªæä¾›' && phoneDisplay.length < 10) {
      phoneDisplay = '0' + phoneDisplay;
    }
    
    const reservationStatus = r.status === 'å·²å–æ¶ˆ' ? 'å·²å–æ¶ˆ' : 'å·²é ç´„';
    const reservationStatusClass = r.status === 'å·²å–æ¶ˆ' ? 'status-cancelled' : 'status-booked';
    
    const checkinStatus = r.checkinStatus === 'Y' ? 'å·²æ­ä¹˜' : 'æœªæ­ä¹˜';
    const checkinStatusClass = r.checkinStatus === 'Y' ? 'status-checkedin' : 'status-notcheckedin';
    
    tr.innerHTML = `
      <td>${r.date?.split('T')[0] || ''}</td>
      <td><strong>${r.route}</strong></td>
      <td><span class="passenger-name" onclick="showModal('${r.name}', '${r.department}', '${r.studentId}', '${phoneDisplay}')">${r.name}</span></td>
      <td><span class="${reservationStatusClass}">${reservationStatus}</span></td>
      <td><span class="${checkinStatusClass}">${checkinStatus}</span></td>
    `;
    tbody.appendChild(tr);
  });
}

function filterReservations() {
  const query = document.getElementById('searchInput').value.toLowerCase();
  
  if (!query) {
    renderReservations(allReservations);
    return;
  }
  
  const filtered = allReservations.filter(r => {
    return (r.name || '').toLowerCase().includes(query) ||
           (r.date || '').includes(query) ||
           (r.route || '').includes(query);
  });
  
  renderReservations(filtered);
}

function showModal(name, department, studentId, phone) {
  document.getElementById('modal-name').textContent = name;
  document.getElementById('modal-department').textContent = department || 'æœªæä¾›';
  document.getElementById('modal-studentid').textContent = studentId || 'æœªæä¾›';
  
  const phoneLink = document.getElementById('modal-phone');
  if (phone && phone !== 'æœªæä¾›') {
    phoneLink.href = `tel:${phone}`;
    phoneLink.textContent = phone;
  } else {
    phoneLink.textContent = 'æœªæä¾›';
    phoneLink.href = '#';
  }
  
  document.getElementById('infoModal').classList.add('active');
}

function closeModal() {
  document.getElementById('infoModal').classList.remove('active');
}
</script>
</body>
</html>
