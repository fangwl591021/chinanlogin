<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šå¾Œå° v3.9</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: "Noto Sans TC", system-ui, sans-serif;
  background: #f8fafc;
  color: #334155;
  padding-bottom: 80px;
}

#topBar {
  position: sticky;
  top: 0;
  background: #3c8050;
  color: white;
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 50;
}

#userProfile {
  display: flex;
  align-items: center;
  gap: 10px;
}

#userProfile img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 2px solid white;
  background: #ddd;
}

#userName {
  font-weight: 600;
  font-size: 14px;
}

.card {
  background: white;
  border-radius: 12px;
  padding: 16px;
  margin: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.section-title {
  font-weight: 800;
  font-size: 18px;
  color: #14532d;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-title::before {
  content: "";
  display: inline-block;
  width: 6px;
  height: 20px;
  background: #22c55e;
  border-radius: 2px;
}

#bottomNav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: white;
  border-top: 1px solid #e5e7eb;
  display: flex;
  z-index: 50;
}

.nav-btn {
  flex: 1;
  padding: 12px 0;
  text-align: center;
  color: #666;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  background: none;
}

.nav-btn.active {
  color: #3c8050;
  border-top: 3px solid #3c8050;
  padding-top: 9px;
}

.section {
  display: none;
}

.section.active {
  display: block;
}

.search-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
  margin-bottom: 12px;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

table thead {
  background: #3c8050;
  color: white;
}

table th, table td {
  padding: 8px;
  text-align: left;
  border-bottom: 1px solid #e5e7eb;
}

table tbody tr:hover {
  background: #f0f9ff;
}

.stat-card {
  background: linear-gradient(135deg, #3c8050 0%, #2d5f3f 100%);
  color: white;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 12px;
}

.stat-label {
  font-size: 12px;
  opacity: 0.9;
}

.stat-value {
  font-size: 28px;
  font-weight: 800;
  margin-top: 4px;
}

.loading {
  text-align: center;
  padding: 40px 20px;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #e5e7eb;
  border-top-color: #3c8050;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.error-msg {
  background: #fee2e2;
  color: #b91c1c;
  padding: 16px;
  border-radius: 8px;
  margin: 16px;
  text-align: center;
}

.link-btn {
  display: inline-block;
  background: #3c8050;
  color: white;
  padding: 10px 16px;
  border-radius: 6px;
  text-decoration: none;
  font-weight: 600;
  margin-top: 12px;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  max-width: 300px;
  width: 90%;
}

.modal-content h3 {
  margin-bottom: 12px;
  border-bottom: 2px solid #3c8050;
  padding-bottom: 8px;
}

.modal-item {
  margin-bottom: 12px;
  font-size: 14px;
}

.modal-label {
  color: #666;
  font-size: 12px;
}

.modal-value {
  font-weight: 600;
  color: #333;
}

.close-btn {
  width: 100%;
  padding: 10px;
  background: #e5e7eb;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  margin-top: 12px;
}
</style>
</head>

<body>

<div id="topBar">
  <div style="font-weight: bold; font-size: 18px;">ğŸšŒ ç©¿å±±ç”²å¾Œå°</div>
  <div id="userProfile">
    <img id="userPicture" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'%3E%3Crect fill='%23ddd' width='40' height='40'/%3E%3C/svg%3E" alt="é ­åƒ">
    <span id="userName">-</span>
  </div>
</div>

<main id="mainContent">

  <!-- å„€è¡¨æ¿ -->
  <section id="dashboard" class="section active">
    <div class="card">
      <h2 class="section-title">ğŸ“Š ç‡Ÿé‹å„€è¡¨æ¿</h2>
      <div id="statsContainer">
        <div class="loading">
          <div class="spinner"></div>
          <p>è¼‰å…¥ä¸­...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- æŸ¥è©¢ -->
  <section id="reservations" class="section">
    <div class="card">
      <h2 class="section-title">ğŸ§¾ é ç´„æŸ¥è©¢</h2>
      <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹å§“å / æ—¥æœŸ / ç­æ¬¡...">
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>æ—¥æœŸ</th>
              <th>ç­æ¬¡</th>
              <th>å§“å</th>
              <th>é ç´„ç‹€æ…‹</th>
              <th>æ­ä¹˜ç‹€æ…‹</th>
            </tr>
          </thead>
          <tbody id="reservationList"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- æ ¸éŠ· -->
  <section id="checkin" class="section">
    <div class="card">
      <h2 class="section-title">âœ… æ ¸éŠ·ç®¡ç†</h2>
      <p>é€²å…¥å¸æ©Ÿæ ¸éŠ·ç³»çµ±é€²è¡Œæ ¸éŠ·ä½œæ¥­</p>
      <a href="https://liff.line.me/2006590746-A8YD0ZD9" class="link-btn">å‰å¾€æ ¸éŠ·ç³»çµ± ğŸš</a>
    </div>
  </section>

  <!-- å¸æ©Ÿ -->
  <section id="drivers" class="section">
    <div class="card">
      <h2 class="section-title">ğŸš å¸æ©Ÿç­è¡¨</h2>
      <ul style="list-style: none;">
        <li style="padding: 8px 0; border-bottom: 1px solid #eee;">âœˆï¸ A1 - é™³å¸æ©Ÿ</li>
        <li style="padding: 8px 0; border-bottom: 1px solid #eee;">âœˆï¸ A2 - ç‹å¸æ©Ÿ</li>
        <li style="padding: 8px 0; border-bottom: 1px solid #eee;">âœˆï¸ B1 - å³å¸æ©Ÿ</li>
        <li style="padding: 8px 0; border-bottom: 1px solid #eee;">âœˆï¸ B2 - æå¸æ©Ÿ</li>
      </ul>
    </div>
  </section>

  <!-- è¨­å®š -->
  <section id="config" class="section">
    <div class="card">
      <h2 class="section-title">âš™ï¸ ç‡Ÿé‹è¨­å®š</h2>
      <p>ï¼ˆAdmin å°ˆç”¨åŠŸèƒ½ï¼‰</p>
      <button style="background: #3c8050; color: white; padding: 10px 16px; border: none; border-radius: 6px; font-weight: 600; margin-top: 12px; cursor: pointer;">ğŸ’¾ å„²å­˜è¨­å®š</button>
    </div>
  </section>

</main>

<!-- ä¸‹æ–¹å°èˆª -->
<div id="bottomNav">
  <button class="nav-btn active" data-section="dashboard" style="color:#3c8050;border-top:3px solid #3c8050;">ğŸ“Š å„€è¡¨æ¿</button>
  <button class="nav-btn" data-section="reservations">ğŸ§¾ æŸ¥è©¢</button>
  <button class="nav-btn" data-section="checkin">âœ… æ ¸éŠ·</button>
  <button class="nav-btn" data-section="drivers">ğŸš å¸æ©Ÿ</button>
  <button class="nav-btn" data-section="config">âš™ï¸ è¨­å®š</button>
</div>

<!-- è©³ç´°è³‡è¨Š Modal -->
<div id="infoModal" class="modal">
  <div class="modal-content">
    <h3 id="modalName"></h3>
    <div class="modal-item">
      <div class="modal-label">ç§‘ç³»</div>
      <div class="modal-value" id="modalDept"></div>
    </div>
    <div class="modal-item">
      <div class="modal-label">å­¸è™Ÿ</div>
      <div class="modal-value" id="modalStuId"></div>
    </div>
    <div class="modal-item">
      <div class="modal-label">é›»è©±</div>
      <div class="modal-value"><a id="modalPhone" href="#"></a></div>
    </div>
    <button class="close-btn" onclick="closeModal()">é—œé–‰</button>
  </div>
</div>

<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbza2qFcrQt1PS6Y4p4u2gSXovvFxWecEjjIh5ov1cIk_65zgdFJA0xjVuS3qr7WvlgAzA/exec';

let allReservations = [];
let isDev = new URLSearchParams(window.location.search).has('dev');

// åˆå§‹åŒ–
window.addEventListener('load', async () => {
  if (isDev) {
    initDevMode();
  } else {
    await initLineMode();
  }
});

async function initLineMode() {
  console.log('ç­‰å¾… LINE LIFF...');
  
  // ç­‰å¾… LIFF SDK
  let attempts = 0;
  while (typeof liff === 'undefined' && attempts < 30) {
    await new Promise(r => setTimeout(r, 200));
    attempts++;
  }
  
  if (typeof liff === 'undefined') {
    showError('LIFF SDK æœªåŠ è¼‰ï¼Œè«‹å˜—è©¦ ?dev æ¨¡å¼');
    return;
  }
  
  try {
    await liff.init({ liffId: '2006590746-A8YD0ZD9' });
    
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    
    const profile = await liff.getProfile();
    document.getElementById('userName').textContent = profile.displayName;
    document.getElementById('userPicture').src = profile.pictureUrl;
    
    await loadData();
    setupUI();
  } catch (e) {
    console.error(e);
    showError('LINE é©—è­‰å¤±æ•—ï¼š' + e.message);
  }
}

function initDevMode() {
  console.log('é–‹ç™¼æ¨¡å¼');
  document.getElementById('userName').textContent = 'é–‹ç™¼è€… (DEV)';
  loadData();
  setupUI();
}

async function loadData() {
  try {
    const res = await fetch(`${WORKER_URL}?mode=reservations`);
    const data = await res.json();
    allReservations = data.reservations || [];
    console.log('è¼‰å…¥é ç´„ï¼š', allReservations.length);
  } catch (e) {
    console.error('è¼‰å…¥å¤±æ•—:', e);
  }
  
  updateStats();
}

function updateStats() {
  const total = allReservations.length;
  const today = new Date().toISOString().split('T')[0];
  const todayCount = allReservations.filter(r => r.date?.includes(today)).length;
  const checked = allReservations.filter(r => r.checkinStatus === 'Y').length;
  const rate = total ? Math.round((checked / total) * 100) : 0;
  
  document.getElementById('statsContainer').innerHTML = `
    <div class="stat-card">
      <div class="stat-label">ç¸½é ç´„æ•¸</div>
      <div class="stat-value">${total}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ä»Šæ—¥é ç´„</div>
      <div class="stat-value">${todayCount}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">æ ¸éŠ·ç‡</div>
      <div class="stat-value">${rate}%</div>
    </div>
  `;
}

function setupUI() {
  // ç¢ºä¿å„€è¡¨æ¿æ˜¯ç¬¬ä¸€å€‹é¡¯ç¤ºçš„
  showSection('dashboard');
  document.querySelector('[data-section="dashboard"]').classList.add('active');
  
  // å°èˆª
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const section = this.dataset.section;
      showSection(section);
      
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      if (section === 'reservations') {
        renderReservations(allReservations);
      }
    });
  });
  
  // æœå°‹
  document.getElementById('searchInput').addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    const filtered = allReservations.filter(r =>
      (r.name || '').toLowerCase().includes(query) ||
      (r.date || '').includes(query) ||
      (r.route || '').includes(query)
    );
    renderReservations(filtered);
  });
  
  // Modal é—œé–‰
  document.getElementById('infoModal').addEventListener('click', (e) => {
    if (e.target.id === 'infoModal') closeModal();
  });
}

function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function renderReservations(data) {
  const tbody = document.getElementById('reservationList');
  tbody.innerHTML = '';
  
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;">æš«ç„¡è³‡æ–™</td></tr>';
    return;
  }
  
  data.forEach(r => {
    const status = r.status === 'å·²å–æ¶ˆ' ? 'âŒ å·²å–æ¶ˆ' : 'âœ… å·²é ç´„';
    const checkin = r.checkinStatus === 'Y' ? 'ğŸŸ¢ å·²æ­ä¹˜' : 'âšª æœªæ­ä¹˜';
    
    tbody.innerHTML += `
      <tr>
        <td>${r.date?.split('T')[0] || ''}</td>
        <td><strong>${r.route}</strong></td>
        <td style="color:#0066cc;cursor:pointer;font-weight:600;" onclick="showInfo('${r.name}','${r.department}','${r.studentId}','${r.phone}')">${r.name}</td>
        <td>${status}</td>
        <td>${checkin}</td>
      </tr>
    `;
  });
}

function showInfo(name, dept, stuId, phone) {
  document.getElementById('modalName').textContent = name;
  document.getElementById('modalDept').textContent = dept || 'æœªæä¾›';
  document.getElementById('modalStuId').textContent = stuId || 'æœªæä¾›';
  
  const phoneLink = document.getElementById('modalPhone');
  if (phone) {
    phoneLink.href = `tel:${phone}`;
    phoneLink.textContent = phone;
  } else {
    phoneLink.textContent = 'æœªæä¾›';
  }
  
  document.getElementById('infoModal').classList.add('active');
}

function closeModal() {
  document.getElementById('infoModal').classList.remove('active');
}

function showError(msg) {
  document.getElementById('mainContent').innerHTML = `
    <div class="error-msg">
      âŒ ${msg}<br>
      <small>æç¤ºï¼šè¨ªå• ?dev é€²å…¥é–‹ç™¼æ¨¡å¼</small>
    </div>
  `;
}
</script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

</body>
</html>
