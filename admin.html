<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin ç®¡ç†å“¡é¢æ¿</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body {
  font-family: system-ui, "Noto Sans TC", sans-serif;
  background: #f6f7f9;
  margin: 0;
}
main {
  max-width: 760px;
  margin: 24px auto;
  background: #fff;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 6px 18px rgba(0,0,0,.06);
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  border-bottom: 1px solid #eef2f7;
  padding: 8px;
  text-align: left;
}
th {
  background: #fafbfc;
}
.badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 8px;
  background: #eef2f7;
  font-size: 12px;
  margin-left: 8px;
}
.btn {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid #d3d7de;
  background: #fff;
  cursor: pointer;
}
.notice {
  padding: 12px;
  background: #fdecea;
  color: #b71c1c;
  border: 1px solid #f5c2c7;
  border-radius: 8px;
  margin: 20px;
  text-align: center;
  font-weight: bold;
}
</style>
</head>
<body>
<main>
  <h1>Admin / ç•¶æ—¥åå–®èˆ‡çµ±è¨ˆ</h1>
  <label>æ—¥æœŸ</label>
  <input id="date" type="date"/>
  <button id="btnLoad" class="btn">è¼‰å…¥</button>
  <div id="stat"></div>
  <table>
    <thead>
      <tr>
        <th>ç­æ¬¡</th>
        <th>å§“å</th>
        <th>é›»è©±</th>
        <th>userId</th>
        <th>æ ¸éŠ·</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</main>

<div id="noPermission" class="notice" style="display:none">
  âŒ æ‚¨æ²’æœ‰æ¬Šé™é€²å…¥æ­¤é é¢ã€‚<br>è«‹ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥ã€‚
</div>

<script>
/* === è¨­å®šå€ === */
const LIFF_ID  = '2006590746-wgL4l54z';
const API_BASE = 'https://delicate-math-7e61.fangwl591021.workers.dev/';

// ğŸ” ç®¡ç†å“¡åå–®
const MASTER_ADMINS = [
  'U84b2e88d818b98575f45fcf14a380517',
  'Ue7a07fe317565389fbf4479172088f87'
];

let admin = null;
const $ = id => document.getElementById(id);
const tr = (r)=> `
<tr>
  <td>${r.slot}</td>
  <td>${r.name||''}</td>
  <td>${r.phone||''}</td>
  <td style="font-size:12px">${r.uid}</td>
  <td><button data-uid="${r.uid}" data-slot="${r.slot}" class="btn btnCheck">æ ¸éŠ·</button></td>
</tr>`;

/* === API å‡½æ•¸ === */
async function callGet(q){
  return fetch(API_BASE + '?' + new URLSearchParams(q)).then(r=>r.json());
}
async function callPost(p){
  return fetch(API_BASE, {
    method:'POST',
    headers:{'content-type':'application/json'},
    body:JSON.stringify(p)
  }).then(r=>r.json());
}

/* === è¼‰å…¥åå–® === */
async function load(){
  const d = $('date').value;
  const r = await callGet({ mode:'adminList', userId: admin.userId, date: d });
  if (!r.ok) { alert('âŒ '+r.error); return; }
  const s = r.data.stat;
  $('stat').innerHTML = `A1 ${s.A1}/${r.data.cap}ã€A2 ${s.A2}/${r.data.cap}ã€B1 ${s.B1}/${r.data.cap}ã€B2 ${s.B2}/${r.data.cap}`;
  $('rows').innerHTML = r.data.rows.map(tr).join('');

  document.querySelectorAll('.btnCheck').forEach(b=>{
    b.onclick = async ()=>{
      const rw = b.dataset;
      const res = await callPost({
        mode:'driverCheckin',
        adminId: admin.userId,
        userId: rw.uid,
        date: d,
        slot: rw.slot
      });
      alert(res.ok ? 'âœ… å·²æ ¸éŠ·' : 'âŒ '+res.error);
      await load();
    };
  });
}

/* === åˆå§‹åŒ– === */
async function init(){
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      alert('è«‹å…ˆç™»å…¥ LINE å¸³è™Ÿ');
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    admin = profile;
    console.log('ğŸ‘¤ ç®¡ç†å“¡ç™»å…¥:', admin.userId);

    // ğŸ”’ æ¬Šé™æª¢æŸ¥
    if (!MASTER_ADMINS.includes(admin.userId)) {
      document.querySelector('main').style.display = 'none';
      $('noPermission').style.display = 'block';
      console.warn('âŒ ç„¡æ¬Šé™ç”¨æˆ¶:', admin.userId);
      return;
    }

    // âœ… é€šéé©—è­‰
    const t = new Date();
    $('date').value = t.toISOString().slice(0,10);
    await load();

  } catch (err) {
    console.error('åˆå§‹åŒ–éŒ¯èª¤:', err);
    alert('ç³»çµ±éŒ¯èª¤: ' + err.message);
  }
}

$('btnLoad').onclick = load;
window.addEventListener('load', init);
</script>
</body>
</html>
