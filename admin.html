<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>暨大接駁車 - 管理後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- 導航列 -->
    <nav class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="fas fa-bus text-2xl"></i>
                    <div>
                        <h1 class="text-xl font-bold">暨大接駁車管理後台</h1>
                        <p class="text-sm text-purple-200">穿山甲專車預約系統</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span id="currentTime" class="text-sm"></span>
                    <button onclick="exportAllData()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition">
                        <i class="fas fa-download mr-2"></i>匯出資料
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6">
        <!-- 統計卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">註冊會員</p>
                        <p id="totalUsers" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-users text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">今日預約</p>
                        <p id="todayBookings" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-calendar-check text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">本月預約</p>
                        <p id="monthBookings" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">營運狀態</p>
                        <p id="systemStatus" class="text-3xl font-bold text-green-600">正常</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 功能選單 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition cursor-pointer" onclick="showSection('realtime')">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-tachometer-alt text-red-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800">即時預約看板</h3>
                        <p class="text-sm text-gray-600">監控即時預約狀況</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition cursor-pointer" onclick="showSection('members')">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-user-friends text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800">會員管理</h3>
                        <p class="text-sm text-gray-600">查看註冊會員資料</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition cursor-pointer" onclick="showSection('bookings')">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-list-alt text-green-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800">預約查詢</h3>
                        <p class="text-sm text-gray-600">歷史預約記錄查詢</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition cursor-pointer" onclick="showSection('routes')">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-route text-purple-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800">路線管理</h3>
                        <p class="text-sm text-gray-600">停靠站與路線設定</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition cursor-pointer" onclick="showSection('system')">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-cog text-orange-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800">系統設定</h3>
                        <p class="text-sm text-gray-600">公休日與推播設定</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition cursor-pointer" onclick="showSection('backup')">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-database text-gray-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800">資料備份</h3>
                        <p class="text-sm text-gray-600">匯入匯出系統資料</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 內容區域 -->
        <div id="contentArea">
            <!-- 預設顯示即時看板 -->
            <div id="realtimeSection" class="section">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">即時預約看板</h2>
                    
                    <!-- 今日預約統計 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <p class="text-sm text-blue-600">A1 班次</p>
                            <p class="text-2xl font-bold">3/6</p>
                            <p class="text-xs text-gray-500">22:00-22:30</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 text-center">
                            <p class="text-sm text-green-600">B1 班次</p>
                            <p class="text-2xl font-bold">2/6</p>
                            <p class="text-xs text-gray-500">22:30-23:00</p>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4 text-center">
                            <p class="text-sm text-purple-600">A2 班次</p>
                            <p class="text-2xl font-bold">4/6</p>
                            <p class="text-xs text-gray-500">23:00-23:30</p>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-4 text-center">
                            <p class="text-sm text-orange-600">B2 班次</p>
                            <p class="text-2xl font-bold">1/6</p>
                            <p class="text-xs text-gray-500">23:30-24:00</p>
                        </div>
                    </div>

                    <!-- 即時預約列表 -->
                    <div class="border rounded-lg">
                        <div class="bg-gray-50 px-4 py-3 border-b">
                            <h3 class="font-semibold">最新預約記錄</h3>
                        </div>
                        <div id="realtimeBookings" class="divide-y">
                            <!-- 動態載入 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 其他區塊預留 -->
            <div id="membersSection" class="section hidden"></div>
            <div id="bookingsSection" class="section hidden"></div>
            <div id="routesSection" class="section hidden"></div>
            <div id="systemSection" class="section hidden"></div>
            <div id="backupSection" class="section hidden"></div>
        </div>
    </div>

    <script>
        // 系統配置
        const CONFIG = {
            GITHUB_TOKEN: "ghp_您的Token",
            GIST_ID: "您的GistID",
            STOPS: {
                outbound: ["行政大樓", "中餐廳", "科技學院", "學人會館", "中城", "下城", "坪頂", "愛蘭橋", "大成國小", "中山安七街口", "榮民診所", "埔里酒廠", "埔里總站"],
                return: ["埔里總站", "埔里酒廠", "榮民診所", "中山安七街口", "大成國小", "愛蘭橋", "坪頂", "下城", "中城", "學人會館", "科技學院", "中餐廳", "行政大樓"]
            }
        };

        // 顯示指定區塊
        function showSection(sectionName) {
            // 隱藏所有區塊
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // 顯示目標區塊
            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.classList.remove('hidden');
                
                // 載入區塊內容
                loadSectionContent(sectionName);
            }
        }

        // 載入區塊內容
        async function loadSectionContent(sectionName) {
            switch(sectionName) {
                case 'realtime':
                    await loadRealtimeData();
                    break;
                case 'members':
                    await loadMembersData();
                    break;
                case 'bookings':
                    await loadBookingsData();
                    break;
                case 'routes':
                    await loadRoutesData();
                    break;
                case 'system':
                    await loadSystemData();
                    break;
                case 'backup':
                    await loadBackupData();
                    break;
            }
        }

        // 載入即時資料
        async function loadRealtimeData() {
            try {
                const data = await getGistData();
                
                // 更新統計數字
                document.getElementById('totalUsers').textContent = data.users?.length || 0;
                document.getElementById('todayBookings').textContent = data.todayBookings || 0;
                document.getElementById('monthBookings').textContent = data.monthBookings || 0;
                
                // 更新即時預約列表
                updateRealtimeBookings(data.bookings || []);
                
            } catch (error) {
                console.error('載入即時資料失敗:', error);
            }
        }

        // 更新即時預約列表
        function updateRealtimeBookings(bookings) {
            const container = document.getElementById('realtimeBookings');
            const recentBookings = bookings.slice(-10).reverse(); // 最新10筆
            
            container.innerHTML = recentBookings.map(booking => `
                <div class="px-4 py-3 flex items-center justify-between">
                    <div>
                        <p class="font-medium">${booking.userName || '未知用戶'}</p>
                        <p class="text-sm text-gray-500">${booking.routeName} • ${booking.date}</p>
                    </div>
                    <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                        已預約
                    </span>
                </div>
            `).join('');
        }

        // 從 GitHub Gist 取得資料
        async function getGistData() {
            const response = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, {
                headers: {
                    'Authorization': `token ${CONFIG.GITHUB_TOKEN}`
                }
            });
            
            const gist = await response.json();
            return JSON.parse(gist.files['data.json'].content);
        }

        // 匯出所有資料
        async function exportAllData() {
            try {
                const data = await getGistData();
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `bus_system_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                alert('資料匯出成功！');
            } catch (error) {
                alert('匯出失敗：' + error.message);
            }
        }

        // 更新當前時間
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.toLocaleString('zh-TW', { 
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false 
                });
        }

        // 初始化
        window.addEventListener('load', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            loadRealtimeData(); // 載入初始資料
            
            // 每30秒更新一次即時資料
            setInterval(loadRealtimeData, 30000);
        });

        // 預先載入其他區塊的函數（待實作）
        async function loadMembersData() {
            document.getElementById('membersSection').innerHTML = `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">會員管理</h2>
                    <p class="text-gray-500">會員管理功能開發中...</p>
                </div>
            `;
        }

        async function loadBookingsData() {
            document.getElementById('bookingsSection').innerHTML = `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">預約查詢</h2>
                    <p class="text-gray-500">預約查詢功能開發中...</p>
                </div>
            `;
        }

        async function loadRoutesData() {
            document.getElementById('routesSection').innerHTML = `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">路線管理</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold mb-3">去程停靠站（暨大→埔里）</h3>
                            <div class="space-y-2">
                                ${CONFIG.STOPS.outbound.map((stop, index) => `
                                    <div class="flex items-center gap-3 p-2 border rounded">
                                        <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full text-sm flex items-center justify-center">${index + 1}</span>
                                        <span>${stop}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold mb-3">回程停靠站（埔里→暨大）</h3>
                            <div class="space-y-2">
                                ${CONFIG.STOPS.return.map((stop, index) => `
                                    <div class="flex items-center gap-3 p-2 border rounded">
                                        <span class="w-6 h-6 bg-green-100 text-green-600 rounded-full text-sm flex items-center justify-center">${index + 1}</span>
                                        <span>${stop}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadSystemData() {
            document.getElementById('systemSection').innerHTML = `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">系統設定</h2>
                    <p class="text-gray-500">系統設定功能開發中...</p>
                </div>
            `;
        }

        async function loadBackupData() {
            document.getElementById('backupSection').innerHTML = `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">資料備份</h2>
                    <p class="text-gray-500">資料備份功能開發中...</p>
                </div>
            `;
        }
    </script>
</body>
</html>
