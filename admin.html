<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šå¾Œå° v7.0</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:"Noto Sans TC",system-ui,sans-serif;background:#f8fafc;padding-bottom:80px;}
#topBar{position:sticky;top:0;background:#3c8050;color:white;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;}
#userInfo{display:flex;align-items:center;gap:10px;}
#userPicture{width:40px;height:40px;border-radius:50%;border:2px solid white;}
.card{background:white;border-radius:12px;padding:16px;margin:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.section-title{font-weight:800;font-size:18px;color:#14532d;margin-bottom:16px;}
.section{display:none;}
.section.active{display:block;}
#bottomNav{position:fixed;bottom:0;left:0;width:100%;background:white;border-top:1px solid #ddd;display:flex;justify-content:space-around;z-index:50;}
.nav-btn{flex:1;padding:10px 0;text-align:center;font-size:12px;font-weight:600;cursor:pointer;color:#666;}
.nav-btn.active{color:#3c8050;border-top:3px solid #3c8050;}
.status-reserved{color:#3c8050;font-weight:600;}
.status-cancelled{color:#ef4444;font-weight:600;}
.status-completed{color:#10b981;font-weight:600;}
.loading{text-align:center;color:#888;padding:20px;font-size:16px;}
.stat-box{background:linear-gradient(135deg,#3c8050,#256f4f);color:white;padding:16px;border-radius:10px;margin-bottom:12px;text-align:center;}
.stat-label{font-size:12px;opacity:0.8;}
.stat-value{font-size:28px;font-weight:800;margin-top:4px;}
input,select{border:1px solid #ddd;border-radius:6px;padding:8px;width:100%;}
button.save-btn{background:#3c8050;color:white;padding:10px;border:none;border-radius:6px;cursor:pointer;font-weight:600;}
button.save-btn:hover{background:#2e6b40;}
</style>
</head>

<body>
<!-- ğŸ” é ‚éƒ¨ -->
<div id="topBar">
  <div class="font-bold text-lg">ğŸšŒ ç©¿å±±ç”²å¾Œå°ç³»çµ±</div>
  <div id="userInfo">
    <img id="userPicture" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'%3E%3Crect fill='%23ddd' width='40' height='40'/%3E%3C/svg%3E">
    <span id="userName">è¼‰å…¥ä¸­...</span>
  </div>
</div>

<main>
  <!-- ğŸ§¾ æŸ¥è©¢ -->
  <section id="query" class="section active">
    <div class="card">
      <h2 class="section-title">ğŸ§¾ é ç´„æŸ¥è©¢</h2>
      <input type="text" id="search" placeholder="æœå°‹å§“åã€ç­æ¬¡æˆ–æ—¥æœŸ..." class="border border-gray-300 rounded-md p-2 w-full mb-3">
      <div id="loadingText" class="loading">â³ æŸ¥è©¢ä¸­...</div>
      <div id="tableContainer" style="overflow-x:auto; display:none;">
        <table class="min-w-full text-sm">
          <thead class="bg-green-700 text-white">
            <tr><th class="p-2">æ—¥æœŸ</th><th class="p-2">ç­æ¬¡</th><th class="p-2">å§“å</th><th class="p-2">ç‹€æ…‹</th></tr>
          </thead>
          <tbody id="tbl"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ğŸ“Š å„€è¡¨æ¿ -->
  <section id="dashboard" class="section">
    <div class="card">
      <h2 class="section-title">ğŸ“Š ç‡Ÿé‹å„€è¡¨æ¿</h2>
      <div id="statsArea">
        <div class="stat-box"><div class="stat-label">å·²é ç´„</div><div id="countReserved" class="stat-value">--</div></div>
        <div class="stat-box"><div class="stat-label">å·²æ­ä¹˜</div><div id="countCompleted" class="stat-value">--</div></div>
        <div class="stat-box"><div class="stat-label">å·²å–æ¶ˆ</div><div id="countCancelled" class="stat-value">--</div></div>
      </div>
    </div>
  </section>

  <!-- ğŸ“‹ æ ¸éŠ· -->
  <section id="checkin" class="section">
    <div class="card text-center">
      <h2 class="section-title">ğŸ“‹ æ ¸éŠ·ç®¡ç†</h2>
      <button id="goCheckin" class="bg-green-600 text-white px-4 py-3 rounded w-full text-lg">å‰å¾€æ ¸éŠ·ç³»çµ±</button>
      <p class="text-gray-500 mt-2 text-sm">é–‹å•Ÿ LIFFï¼š2006590746-G7B12a1K</p>
    </div>
  </section>

  <!-- ğŸš å¸æ©Ÿ -->
  <section id="driver" class="section">
    <div class="card">
      <h2 class="section-title">ğŸš å¸æ©Ÿç­è¡¨</h2>
      <ul class="list-disc ml-6 text-gray-700">
        <li>A1ï¼šé™³å¸æ©Ÿ</li><li>B1ï¼šæ—å¸æ©Ÿ</li><li>A2ï¼šç‹å¸æ©Ÿ</li><li>B2ï¼šå³å¸æ©Ÿ</li>
      </ul>
    </div>
  </section>

  <!-- âš™ï¸ ç³»çµ±è¨­å®š -->
  <section id="config" class="section">
    <div class="card">
      <h2 class="section-title">âš™ï¸ ç³»çµ±è¨­å®š</h2>
      <p class="text-sm text-gray-600 mb-4">ä¿®æ”¹å¾Œå°‡ç«‹å³ç”Ÿæ•ˆ</p>
      <label>æ¯ç­æ¬¡æ­è¼‰äººæ•¸ä¸Šé™</label>
      <input type="number" id="seatLimit" class="mb-3" min="1" max="20">
      <label>æœªæ ¸éŠ·é”å¹¾æ¬¡å¾Œå°é–</label>
      <input type="number" id="maxNoShow" class="mb-3" min="1" max="10">
      <label>å°é–é€±æ•¸</label>
      <input type="number" id="banWeeks" class="mb-3" min="1" max="12">
      <label>é ç´„æ¨¡å¼</label>
      <select id="tripMode" class="mb-3">
        <option value="single">å–®ç¨‹</option>
        <option value="roundtrip">ä¾†å›</option>
      </select>
      <p id="lastUpdate" class="text-xs text-gray-500 mb-3"></p>
      <button class="save-btn w-full" onclick="saveRules()">ğŸ’¾ å„²å­˜è¨­å®š</button>
    </div>
  </section>
</main>

<!-- ğŸ“± åº•éƒ¨å°è¦½ -->
<div id="bottomNav">
  <div class="nav-btn" data-sec="query">ğŸ§¾ æŸ¥è©¢</div>
  <div class="nav-btn active" data-sec="dashboard">ğŸ“Š å„€è¡¨æ¿</div>
  <div class="nav-btn" data-sec="checkin">ğŸ“‹ æ ¸éŠ·</div>
  <div class="nav-btn" data-sec="driver">ğŸš å¸æ©Ÿ</div>
  <div class="nav-btn" data-sec="config">âš™ï¸ è¨­å®š</div>
</div>

<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const LIFF_ID = '2006590746-wgL4l54z';
const CHECKIN_LIFF_URL = 'https://liff.line.me/2006590746-G7B12a1K';
let allData = [];

document.addEventListener('DOMContentLoaded', init);
async function init() {
  await initLINE();
  setupNav();
  loadReservations();
  loadRules(); // â† æ–°å¢ï¼šè‡ªå‹•è¼‰å…¥è¨­å®š
  showSection('dashboard');
}

// === åˆå§‹åŒ– LINE ===
async function initLINE() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    const profile = await liff.getProfile();
    document.getElementById('userName').textContent = profile.displayName;
    document.getElementById('userPicture').src = profile.pictureUrl;
  } catch {
    document.getElementById('userName').textContent = 'æ¸¬è©¦æ¨¡å¼';
  }
}

// === é ç´„æŸ¥è©¢ ===
async function loadReservations() {
  document.getElementById('loadingText').style.display = 'block';
  document.getElementById('tableContainer').style.display = 'none';
  try {
    const res = await fetch(WORKER_URL + '?mode=reservations');
    const json = await res.json();
    allData = json.reservations || [];
    renderTable(allData);
    updateStats(allData);
  } catch (e) {
    document.getElementById('loadingText').textContent = 'âŒ ç„¡æ³•å–å¾—è³‡æ–™';
  }
}

function getStatusText(r){
  if(r.checkinStatus==='Y')return'å·²æ­ä¹˜';
  if(r.status==='å·²å–æ¶ˆ')return'å·²å–æ¶ˆ';
  return'å·²é ç´„';
}

function renderTable(data){
  const order={A1:1,B1:2,A2:3,B2:4};
  data.sort((a,b)=>{
    const da=new Date(a.date),db=new Date(b.date);
    if(db-da!==0)return db-da;
    return (order[a.route]||99)-(order[b.route]||99);
  });
  const tbody=document.getElementById('tbl');
  tbody.innerHTML=data.map(r=>{
    const cls=r.status==='å·²å–æ¶ˆ'?'status-cancelled':(r.checkinStatus==='Y'?'status-completed':'status-reserved');
    return `<tr><td class="p-2">${r.date}</td><td class="p-2">${r.route}</td><td class="p-2">${r.name}</td><td class="p-2 ${cls}">${getStatusText(r)}</td></tr>`;
  }).join('');
  document.getElementById('loadingText').style.display='none';
  document.getElementById('tableContainer').style.display='block';
}

function updateStats(data){
  const reserved=data.filter(r=>r.status==='å·²é ç´„').length;
  const completed=data.filter(r=>r.checkinStatus==='Y').length;
  const cancelled=data.filter(r=>r.status==='å·²å–æ¶ˆ').length;
  document.getElementById('countReserved').textContent=reserved;
  document.getElementById('countCompleted').textContent=completed;
  document.getElementById('countCancelled').textContent=cancelled;
}

document.getElementById('search').addEventListener('input',e=>{
  const key=e.target.value.toLowerCase();
  const filtered=allData.filter(r=>(r.name||'').toLowerCase().includes(key)||(r.route||'').toLowerCase().includes(key)||(r.date||'').includes(key));
  renderTable(filtered);
});

// === å°è¦½ ===
function setupNav(){
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.addEventListener('click',()=>showSection(btn.dataset.sec));
  });
  document.getElementById('goCheckin').addEventListener('click',()=>{
    if(typeof liff!=='undefined'&&liff.isLoggedIn())liff.openWindow({url:CHECKIN_LIFF_URL,external:false});
    else window.open(CHECKIN_LIFF_URL,'_blank');
  });
}

function showSection(id){
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector(`[data-sec="${id}"]`).classList.add('active');
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// === ç³»çµ±è¨­å®š ===
async function loadRules(){
  try{
    const res=await fetch(WORKER_URL+'?mode=getRules');
    const json=await res.json();
    const r=json.current||{};
    document.getElementById('seatLimit').value=r.seatLimit||6;
    document.getElementById('maxNoShow').value=r.maxNoShow||3;
    document.getElementById('banWeeks').value=r.banWeeks||2;
    document.getElementById('tripMode').value=r.tripMode||'single';
    document.getElementById('lastUpdate').textContent='æœ€å¾Œæ›´æ–°ï¼š'+(r.lastUpdate||'ç„¡');
  }catch(e){
    console.error('è¼‰å…¥è¨­å®šå¤±æ•—',e);
  }
}

async function saveRules(){
  const body={
    seatLimit:parseInt(document.getElementById('seatLimit').value),
    maxNoShow:parseInt(document.getElementById('maxNoShow').value),
    banWeeks:parseInt(document.getElementById('banWeeks').value),
    tripMode:document.getElementById('tripMode').value,
    lastUpdate:new Date().toISOString()
  };
  try{
    const res=await fetch(WORKER_URL+'?mode=updateRules',{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)
    });
    const json=await res.json();
    if(json.status==='success')alert('âœ… è¦å‰‡å·²æ›´æ–°');
    else alert('âŒ æ›´æ–°å¤±æ•—ï¼š'+json.message);
    loadRules();
  }catch(e){
    alert('âŒ ç„¡æ³•æ›´æ–°è¨­å®š');
  }
}
</script>
</body>
</html>
