<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ç©¿å±±ç”²å°ˆè»Šå¾Œå°ç®¡ç† v4.3</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body {
  font-family: system-ui, "Noto Sans TC", sans-serif;
  background: #f6f7f9;
  margin: 0;
}
main {
  max-width: 760px;
  margin: 24px auto;
  background: #fff;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 6px 18px rgba(0,0,0,.06);
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  border-bottom: 1px solid #eef2f7;
  padding: 8px;
  text-align: left;
}
th {
  background: #fafbfc;
}
.badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 8px;
  background: #eef2f7;
  font-size: 12px;
  margin-left: 8px;
}
.btn {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid #d3d7de;
  background: #fff;
  cursor: pointer;
}
.notice {
  padding: 12px;
  background: #fdecea;
  color: #b71c1c;
  border: 1px solid #f5c2c7;
  border-radius: 8px;
  margin: 40px auto;
  max-width: 600px;
  text-align: center;
  font-weight: bold;
}
.loading {
  text-align: center;
  color: #666;
  padding: 50px;
  font-size: 18px;
}
</style>
</head>

<body>
<main id="adminPanel" style="display:none">
  <h1>ğŸšŒ Admin / ç•¶æ—¥åå–®èˆ‡çµ±è¨ˆ</h1>
  <label>æ—¥æœŸï¼š</label><input id="date" type="date"/>
  <button id="btnLoad" class="btn">è¼‰å…¥</button>
  <div id="stat" style="margin:10px 0;font-weight:bold"></div>
  <table>
    <thead>
      <tr><th>ç­æ¬¡</th><th>å§“å</th><th>é›»è©±</th><th>userId</th><th>æ ¸éŠ·</th></tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</main>

<!-- ç„¡æ¬Šé™ -->
<div id="noPermission" class="notice" style="display:none">
  âŒ æ‚¨æ²’æœ‰æ¬Šé™é€²å…¥æ­¤é é¢ã€‚<br>è«‹ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥ã€‚
</div>

<!-- è¼‰å…¥æç¤º -->
<div id="loading" class="loading">
  ğŸ”„ ç³»çµ±åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å€™...
</div>

<script>
/* === è¨­å®šå€ === */
const LIFF_ID  = '2006590746-wgL4l54z';
const API_BASE = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const MASTER_ADMINS = [
  'U84b2e88d818b98575f45fcf14a380517',
  'Ue7a07fe317565389fbf4479172088f87'
];

let admin = null;
const $ = id => document.getElementById(id);

/* === API å‡½æ•¸ === */
async function callGet(q){
  try {
    const res = await fetch(API_BASE + '?' + new URLSearchParams(q));
    return await res.json();
  } catch (e) {
    console.error('GET éŒ¯èª¤:', e);
    return { ok:false, error: e.message };
  }
}

async function callPost(p){
  try {
    const res = await fetch(API_BASE, {
      method:'POST',
      headers:{'content-type':'application/json'},
      body:JSON.stringify(p)
    });
    return await res.json();
  } catch (e) {
    console.error('POST éŒ¯èª¤:', e);
    return { ok:false, error: e.message };
  }
}

/* === è¼‰å…¥åå–® === */
async function load(){
  const d = $('date').value;
  $('rows').innerHTML = `<tr><td colspan="5">â³ è³‡æ–™è¼‰å…¥ä¸­...</td></tr>`;
  const r = await callGet({ mode:'adminList', userId: admin.userId, date: d });

  if (!r.ok) {
    alert('âŒ '+(r.error || 'è®€å–å¤±æ•—'));
    $('rows').innerHTML = '';
    return;
  }

  const s = r.data.stat;
  $('stat').innerHTML = `A1 ${s.A1}/${r.data.cap}ã€A2 ${s.A2}/${r.data.cap}ã€B1 ${s.B1}/${r.data.cap}ã€B2 ${s.B2}/${r.data.cap}`;
  
  $('rows').innerHTML = r.data.rows.map(rw => `
    <tr>
      <td>${rw.slot}</td>
      <td>${rw.name||''}</td>
      <td>${rw.phone||''}</td>
      <td style="font-size:12px">${rw.uid}</td>
      <td><button data-uid="${rw.uid}" data-slot="${rw.slot}" class="btn btnCheck">æ ¸éŠ·</button></td>
    </tr>
  `).join('');

  document.querySelectorAll('.btnCheck').forEach(b=>{
    b.onclick = async ()=>{
      const rw = b.dataset;
      const res = await callPost({
        mode:'driverCheckin',
        adminId: admin.userId,
        userId: rw.uid,
        date: d,
        slot: rw.slot
      });
      alert(res.ok ? 'âœ… å·²æ ¸éŠ·' : 'âŒ '+res.error);
      await load();
    };
  });
}

/* === åˆå§‹åŒ– === */
async function init(){
  try {
    console.log('ğŸš€ åˆå§‹åŒ– LIFF...');
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      console.warn('æœªç™»å…¥ï¼Œå°å‘ç™»å…¥...');
      $('loading').innerText = 'è«‹ç™»å…¥ LINE å¸³è™Ÿ...';
      return liff.login();
    }

    const profile = await liff.getProfile();
    admin = profile;
    console.log('ğŸ‘¤ ç®¡ç†å“¡ç™»å…¥:', admin.userId, admin.displayName);

    if (!MASTER_ADMINS.includes(admin.userId)) {
      console.warn('â›” ç„¡æ¬Šé™ç”¨æˆ¶:', admin.userId);
      $('loading').style.display = 'none';
      $('noPermission').style.display = 'block';
      return;
    }

    // âœ… é€šéæ¬Šé™é©—è­‰
    $('loading').style.display = 'none';
    $('adminPanel').style.display = 'block';

    const today = new Date();
    $('date').value = today.toISOString().slice(0,10);
    await load();

  } catch (err) {
    console.error('ğŸ’¥ LIFF åˆå§‹åŒ–éŒ¯èª¤:', err);
    $('loading').innerHTML = `
      âŒ LIFF åˆå§‹åŒ–å¤±æ•—<br>
      <small>${err.message}</small><br><br>
      è«‹æª¢æŸ¥ï¼š<br>
      1ï¸âƒ£ LIFF ID æ˜¯å¦æ­£ç¢º<br>
      2ï¸âƒ£ Endpoint æ˜¯å¦ç‚º <b>https://fangwl591021.github.io/chinanlogin/</b><br>
      3ï¸âƒ£ æ˜¯å¦åœ¨ LINE App é–‹å•Ÿæ­¤é é¢
    `;
  }
}

$('btnLoad').onclick = load;
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
