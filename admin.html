<!DOCTYPE html><html lang="zh-Hant"><head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>body{font-family:system-ui,"Noto Sans TC",sans-serif;background:#f6f7f9;margin:0}
main{max-width:760px;margin:24px auto;background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
table{width:100%;border-collapse:collapse}th,td{border-bottom:1px solid #eef2f7;padding:8px;text-align:left}th{background:#fafbfc}
.badge{display:inline-block;padding:4px 8px;border-radius:8px;background:#eef2f7;font-size:12px;margin-left:8px}
.btn{padding:6px 10px;border-radius:8px;border:1px solid #d3d7de;background:#fff;cursor:pointer}
</style></head><body>
<main>
  <h1>Admin / 當日名單與統計</h1>
  <label>日期</label><input id="date" type="date"/>
  <button id="btnLoad" class="btn">載入</button>
  <div id="stat"></div>
  <table><thead><tr><th>班次</th><th>姓名</th><th>電話</th><th>userId</th><th>核銷</th></tr></thead>
    <tbody id="rows"></tbody>
  </table>
</main>
<script>
const LIFF_ID  = 'YOUR_LIFF_ID';
const API_BASE = 'https://YOUR_WORKER_SUBDOMAIN.workers.dev/api';
let admin = null;
const $=id=>document.getElementById(id);
const tr = (r)=> `<tr><td>${r.slot}</td><td>${r.name||''}</td><td>${r.phone||''}</td><td style="font-size:12px">${r.uid}</td>
<td><button data-uid="${r.uid}" data-slot="${r.slot}" class="btn btnCheck">核銷</button></td></tr>`;

async function callGet(q){ return fetch(API_BASE + '?' + new URLSearchParams(q)).then(r=>r.json()); }
async function callPost(p){ return fetch(API_BASE, {method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(p)}).then(r=>r.json()); }

async function load(){
  const d = $('date').value;
  const r = await callGet({ mode:'adminList', userId: admin.userId, date: d });
  if (!r.ok) { alert('❌ '+r.error); return; }
  const s = r.data.stat;
  $('stat').innerHTML = `A1 ${s.A1}/${r.data.cap}、A2 ${s.A2}/${r.data.cap}、B1 ${s.B1}/${r.data.cap}、B2 ${s.B2}/${r.data.cap}`;
  $('rows').innerHTML = r.data.rows.map(tr).join('');
  document.querySelectorAll('.btnCheck').forEach(b=>{
    b.onclick = async ()=>{
      const rw = b.dataset;
      const res = await callPost({ mode:'driverCheckin', adminId: admin.userId, userId: rw.uid, date: d, slot: rw.slot });
      alert(res.ok ? '✅ 已核銷' : '❌ '+res.error);
      await load();
    };
  });
}

async function init(){
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) return alert('請先登入 LIFF');
  admin = await liff.getProfile();
  const t = new Date(); $('date').value = t.toISOString().slice(0,10);
  await load();
}
$('btnLoad').onclick = load;
init();
</script>
</body></html>
