<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æš¨å¤§æ¥é§è»Š - ç®¡ç†å¾Œå°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
  <!-- å°èˆªåˆ— -->
  <nav class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <i class="fas fa-bus text-2xl"></i>
        <div>
          <h1 class="text-xl font-bold">æš¨å¤§æ¥é§è»Šç®¡ç†å¾Œå°</h1>
          <p class="text-sm text-purple-200">ç©¿å±±ç”²å°ˆè»Šé ç´„ç³»çµ±</p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <span id="currentTime" class="text-sm"></span>
        <button onclick="exportAllData()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition">
          <i class="fas fa-download mr-2"></i>åŒ¯å‡ºè³‡æ–™
        </button>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto p-6">
    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">è¨»å†Šæœƒå“¡</p>
            <p id="totalUsers" class="text-3xl font-bold text-gray-800">0</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
            <i class="fas fa-users text-blue-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">ä»Šæ—¥é ç´„</p>
            <p id="todayBookings" class="text-3xl font-bold text-gray-800">0</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
            <i class="fas fa-calendar-check text-green-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">æœ¬æœˆé ç´„</p>
            <p id="monthBookings" class="text-3xl font-bold text-gray-800">0</p>
          </div>
          <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
            <i class="fas fa-chart-line text-purple-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">ç‡Ÿé‹ç‹€æ…‹</p>
            <p id="systemStatus" class="text-3xl font-bold text-green-600">æ­£å¸¸</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
            <i class="fas fa-check-circle text-green-600 text-xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- åŠŸèƒ½é¸å–® -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition cursor-pointer" onclick="showSection('realtime')">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
            <i class="fas fa-tachometer-alt text-red-600 text-xl"></i>
          </div>
          <div>
            <h3 class="font-bold text-gray-800">å³æ™‚é ç´„çœ‹æ¿</h3>
            <p class="text-sm text-gray-600">ç›£æ§å³æ™‚é ç´„ç‹€æ³</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition cursor-pointer" onclick="showSection('members')">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
            <i class="fas fa-user-friends text-blue-600 text-xl"></i>
          </div>
          <div>
            <h3 class="font-bold text-gray-800">æœƒå“¡ç®¡ç†</h3>
            <p class="text-sm text-gray-600">æŸ¥çœ‹è¨»å†Šæœƒå“¡è³‡æ–™</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition cursor-pointer" onclick="showSection('bookings')">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
            <i class="fas fa-list-alt text-green-600 text-xl"></i>
          </div>
          <div>
            <h3 class="font-bold text-gray-800">é ç´„æŸ¥è©¢</h3>
            <p class="text-sm text-gray-600">æ­·å²é ç´„è¨˜éŒ„æŸ¥è©¢</p>
          </div>
        </div>
      </div>

      <!-- ğŸ†• ç­æ¬¡ç®¡ç†æŒ‰éˆ• -->
      <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition cursor-pointer" onclick="showSection('routesManage')">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-teal-100 rounded-full flex items-center justify-center">
            <i class="fas fa-clock text-teal-600 text-xl"></i>
          </div>
          <div>
            <h3 class="font-bold text-gray-800">ç­æ¬¡ç®¡ç†</h3>
            <p class="text-sm text-gray-600">è¨­å®šç­æ¬¡æ™‚é–“èˆ‡åé¡</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Section: ç­æ¬¡ç®¡ç† -->
    <div id="routesManageSection" class="section hidden">
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">ç­æ¬¡ç®¡ç†</h2>

        <div class="overflow-x-auto">
          <table class="min-w-full border border-gray-200 text-sm text-gray-700">
            <thead class="bg-gray-50 text-gray-800">
              <tr>
                <th class="py-2 px-4 text-left">ç­æ¬¡åç¨±</th>
                <th class="py-2 px-4 text-left">æ–¹å‘</th>
                <th class="py-2 px-4 text-left">æ™‚é–“</th>
                <th class="py-2 px-4 text-center">å®¹é‡</th>
                <th class="py-2 px-4 text-center">ä»Šæ—¥é ç´„</th>
                <th class="py-2 px-4 text-center">è¨­å®š</th>
              </tr>
            </thead>
            <tbody id="routesManageTable" class="divide-y"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
/*********************************************
 * ç³»çµ±è¨­å®š
 *********************************************/
const CONFIG = {
  GITHUB_TOKEN: "ghp_XXXXXX", // æ”¹æˆä½ çš„ Token
  GIST_ID: "802416482763775c3c17680ffea14e7e",
};

let routeConfigs = [
  { id: 'A1', name: 'A1', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™', time: '22:00-22:30', capacity: 6 },
  { id: 'B1', name: 'B1', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§', time: '22:30-23:00', capacity: 6 },
  { id: 'A2', name: 'A2', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™', time: '23:00-23:30', capacity: 6 },
  { id: 'B2', name: 'B2', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§', time: '23:30-24:00', capacity: 6 }
];

let editingRouteId = null;

/*********************************************
 * åŠŸèƒ½åˆ‡æ›
 *********************************************/
function showSection(sectionName) {
  document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
  const section = document.getElementById(sectionName + 'Section');
  if (section) {
    section.classList.remove('hidden');
    loadSectionContent(sectionName);
  }
}

async function loadSectionContent(sectionName) {
  switch(sectionName){
    case 'routesManage': await loadRoutesManageData(); break;
    case 'realtime': await loadRealtimeData(); break;
    case 'members': await loadMembersData(); break;
    case 'bookings': await loadBookingsData(); break;
  }
}

/*********************************************
 * ç­æ¬¡ç®¡ç†é‚è¼¯
 *********************************************/
async function loadRoutesManageData(){
  const data = await getGistData();
  const bookings = data.bookings || [];
  const today = new Date().toISOString().split('T')[0];
  const tbody = document.getElementById('routesManageTable');
  tbody.innerHTML = '';

  routeConfigs.forEach(route => {
    const count = bookings.filter(b => b.routeName && b.routeName.includes(route.name) && b.date === today).length;
    tbody.innerHTML += `
      <tr>
        <td class="py-2 px-4">${route.name}</td>
        <td class="py-2 px-4">${route.direction}</td>
        <td class="py-2 px-4">${route.time}</td>
        <td class="py-2 px-4 text-center">${route.capacity}</td>
        <td class="py-2 px-4 text-center">${count}</td>
        <td class="py-2 px-4 text-center">
          <button onclick="openEditModal('${route.id}')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs">
            <i class="fas fa-pen mr-1"></i> ç·¨è¼¯
          </button>
        </td>
      </tr>
    `;
  });
}

function openEditModal(id){
  const route = routeConfigs.find(r => r.id === id);
  if(!route) return;
  editingRouteId = id;
  const modal = document.createElement('div');
  modal.id = 'editModal';
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm">
      <h3 class="text-lg font-bold mb-4">ä¿®æ”¹ç­æ¬¡è¨­å®š</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">ç­æ¬¡åç¨±</label>
          <input type="text" id="editName" readonly value="${route.name}" class="w-full border rounded px-3 py-2 bg-gray-100">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">æ™‚é–“</label>
          <input type="text" id="editTime" value="${route.time}" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">å®¹é‡</label>
          <input type="number" id="editCapacity" value="${route.capacity}" class="w-full border rounded px-3 py-2">
        </div>
        <div class="flex justify-end gap-2 pt-4">
          <button onclick="closeEditModal()" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">å–æ¶ˆ</button>
          <button onclick="saveRouteConfig()" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">å„²å­˜</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function closeEditModal(){
  const modal = document.getElementById('editModal');
  if(modal) modal.remove();
}

function saveRouteConfig(){
  const route = routeConfigs.find(r => r.id === editingRouteId);
  if(!route) return;
  route.time = document.getElementById('editTime').value;
  route.capacity = parseInt(document.getElementById('editCapacity').value);
  closeEditModal();
  loadRoutesManageData();
  alert('âœ… ç­æ¬¡è¨­å®šå·²æ›´æ–°');
}

/*********************************************
 * Gistè³‡æ–™å­˜å–
 *********************************************/
async function getGistData(){
  const res = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, {
    headers:{'Authorization':`token ${CONFIG.GITHUB_TOKEN}`}
  });
  const gist = await res.json();
  return JSON.parse(gist.files['data.json'].content);
}

/*********************************************
 * å…¶ä»–åŠŸèƒ½ï¼ˆæ™‚é–“ã€è‡ªå‹•æ›´æ–°ï¼‰
 *********************************************/
function updateCurrentTime(){
  const now = new Date();
  document.getElementById('currentTime').textContent = now.toLocaleString('zh-TW', {
    year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'
  });
}
window.addEventListener('load',()=>{
  updateCurrentTime();
  setInterval(updateCurrentTime,1000);
  loadRoutesManageData();
});
</script>
</body>
</html>
