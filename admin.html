<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>穿山甲專車後台系統 - 調試版</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-green-800 mb-6">🔧 穿山甲後台系統 - 權限調試</h1>
    
    <div id="debugInfo" class="bg-white p-6 rounded-lg shadow-md space-y-4"></div>
    
    <div class="mt-6">
      <button onclick="runDebug()" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-bold">
        🚀 開始調試
      </button>
    </div>
  </div>

<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';

function log(message, type = 'info') {
  const debugInfo = document.getElementById('debugInfo');
  const color = {
    info: 'text-blue-600',
    success: 'text-green-600', 
    error: 'text-red-600',
    warning: 'text-yellow-600'
  }[type];
  
  const emoji = {
    info: 'ℹ️',
    success: '✅',
    error: '❌',
    warning: '⚠️'
  }[type];
  
  debugInfo.innerHTML += `
    <div class="border-l-4 ${color.replace('text', 'border')} pl-4 py-1">
      <span class="font-mono">${emoji} ${new Date().toLocaleTimeString()}</span>
      <span class="${color}">${message}</span>
    </div>
  `;
}

async function runDebug() {
  try {
    log('1. 正在初始化 LIFF...');
    await liff.init({ liffId: '2006590746-wgL4l54z' });
    log('✅ LIFF 初始化成功');
    
    log('2. 正在獲取用戶資料...');
    const profile = await liff.getProfile();
    const userId = profile.userId;
    log(`✅ 獲取用戶資料成功: ${profile.displayName}`);
    log(`🔍 LINE User ID: ${userId}`);
    log(`📸 頭像 URL: ${profile.pictureUrl}`);
    
    log('3. 正在檢查管理員權限...');
    const roleUrl = `${WORKER_URL}?mode=getRole&userId=${userId}`;
    log(`🔗 請求 URL: ${roleUrl}`);
    
    const response = await fetch(roleUrl);
    const responseText = await response.text();
    log(`📥 原始回應: ${responseText}`);
    
    const roleData = JSON.parse(responseText);
    log(`🔐 權限檢查結果:`, 'info');
    log(`   - 狀態: ${roleData.status}`);
    log(`   - 角色: ${roleData.role}`);
    log(`   - 來源: ${roleData.source}`);
    log(`   - 用戶ID: ${roleData.userId}`);
    log(`   - 訊息: ${roleData.message}`);
    
    if (roleData.status === 'success' && roleData.role === 'admin') {
      log('🎉 恭喜！您有管理員權限，可以訪問後台系統', 'success');
      log('📍 後台網址: https://fangwl591021.github.io/chinanlogin/admin.html', 'success');
      
      // 自動跳轉到後台
      setTimeout(() => {
        window.location.href = 'https://fangwl591021.github.io/chinanlogin/admin.html';
      }, 3000);
    } else {
      log('❌ 權限不足，無法訪問後台系統', 'error');
      log('💡 解決方案:', 'warning');
      log('   1. 將上面的 User ID 複製到 GAS 的 MASTER_ADMINS 陣列中');
      log('   2. 重新部署 GAS 項目');
      log('   3. 更新 Cloudflare Worker 中的 MASTER_ADMINS');
      log('   4. 重新載入此頁面測試');
    }
    
  } catch (error) {
    log(`❌ 調試過程中發生錯誤: ${error.message}`, 'error');
    console.error('調試錯誤:', error);
  }
}

// 頁面載入後自動開始調試
document.addEventListener('DOMContentLoaded', runDebug);
</script>
</body>
</html>
