<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šå¾Œå° v4.1 (Mobile)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: "Noto Sans TC", system-ui, sans-serif; background: #f0fdf4; color: #334155; }
.card { background:white; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,0.08); margin:16px; padding:20px; }
.tab-btn { flex-1 text-center py-2 text-sm font-semibold text-gray-500; }
.tab-btn.active { color:#3c8050; font-weight:700; }
footer { position:fixed; bottom:0; left:0; right:0; background:white; border-top:1px solid #e5e7eb; display:flex; }
button { border-radius:10px; padding:10px 14px; font-weight:600; }
</style>
</head>
<body class="pb-16">

<!-- ğŸ·ï¸ é¦–é  -->
<section id="tab-home" class="card">
  <h2 class="text-xl font-bold text-green-700 mb-2">ğŸšŒ ç©¿å±±ç”²å°ˆè»Šå¾Œå°</h2>
  <p class="text-gray-600 mb-2">æ­¡è¿ä½¿ç”¨å¾Œå°ç³»çµ±</p>
  <p>å¸³è™Ÿè§’è‰²ï¼š<span id="userRole" class="font-semibold text-green-700">è¼‰å…¥ä¸­...</span></p>
  <p>IDï¼š<span id="userIdText" class="text-sm text-gray-500"></span></p>
  <div id="homeNotice" class="mt-4 text-gray-700"></div>
</section>

<!-- âš™ï¸ ç³»çµ±è¨­å®š -->
<section id="tab-config" class="card hidden">
  <h2 class="text-lg font-bold text-green-700 mb-3">âš™ï¸ ç³»çµ±è¨­å®š</h2>
  <div class="space-y-3">
    <label><input type="checkbox" id="testMode" class="mr-1"> å•Ÿç”¨æ¸¬è©¦æ¨¡å¼</label><br>
    <label><input type="radio" name="bookingMode" value="single" checked> å–®ç¨‹åˆ¶</label>
    <label class="ml-4"><input type="radio" name="bookingMode" value="roundtrip"> ä¾†å›åˆ¶</label>
  </div>
  <textarea id="announcement" class="border rounded w-full p-2 mt-4" rows="3">æ­¡è¿ä½¿ç”¨ç©¿å±±ç”²å°ˆè»Šé ç´„ç³»çµ±ï¼</textarea>
  <div class="grid grid-cols-3 gap-2 mt-4">
    <button id="saveConfig" class="bg-green-600 text-white">ğŸ’¾ å„²å­˜</button>
    <button id="publishConfig" class="bg-blue-600 text-white">ğŸš€ ç™¼ä½ˆ</button>
    <button id="testPush" class="bg-yellow-500 text-white">ğŸ“¢ æ¸¬è©¦æ¨æ’­</button>
  </div>
</section>

<!-- ğŸ“Š å„€è¡¨æ¿ -->
<section id="tab-dashboard" class="card hidden">
  <h2 class="text-lg font-bold text-green-700 mb-2">ğŸ“Š ç‡Ÿé‹å„€è¡¨æ¿</h2>
  <p>æ­¤åŠŸèƒ½å³å°‡ä¸Šç·šã€‚</p>
</section>

<!-- ğŸš æ ¸éŠ·ä½œæ¥­ -->
<section id="tab-checkin" class="card hidden">
  <h2 class="text-lg font-bold text-green-700 mb-3">ğŸš ä»Šæ—¥æ ¸éŠ·ä½œæ¥­</h2>
  <div id="checkinList" class="space-y-2 text-gray-700">è¼‰å…¥ä¸­...</div>
</section>

<!-- âš ï¸ ç„¡æ¬Šé™ç•«é¢ -->
<section id="tab-deny" class="card hidden text-center">
  <h2 class="text-xl font-bold text-red-600 mb-2">âš ï¸ ç„¡å¾Œå°æ¬Šé™</h2>
  <p>æ‚¨ç›®å‰ç‚ºä¸€èˆ¬ä¹˜å®¢èº«åˆ†ï¼Œç„¡æ³•ä½¿ç”¨å¾Œå°åŠŸèƒ½ã€‚</p>
</section>

<!-- ğŸ“± åº•éƒ¨å°è¦½åˆ— -->
<footer id="footerNav">
  <button class="tab-btn active" data-target="home">ğŸ  é¦–é </button>
  <button class="tab-btn" data-target="config">ğŸ§­ è¨­å®š</button>
  <button class="tab-btn" data-target="dashboard">ğŸ“Š å„€è¡¨</button>
  <button class="tab-btn" data-target="checkin">ğŸš æ ¸éŠ·</button>
</footer>

<script>
const WORKER_URL = "https://delicate-math-7e61.fangwl591021.workers.dev/";
let role = "user";
let userId = "";

/* ========= åˆå§‹åŒ– LIFF ========= */
document.addEventListener('DOMContentLoaded', async () => {
  await liff.init({ liffId: "2006590746-E8P6Yg3v" }).catch(console.error);
  const profile = await liff.getProfile();
  userId = profile.userId;
  document.getElementById('userIdText').textContent = userId;
  await checkUserRole(userId);
  setupNav();
});

/* ========= è§’è‰²æª¢æŸ¥ ========= */
async function checkUserRole(userId) {
  try {
    const res = await fetch(`${WORKER_URL}?mode=checkRole&userId=${userId}`);
    const data = await res.json();
    role = data.role || "user";
    document.getElementById('userRole').textContent = role;
    renderUIByRole(role);
  } catch {
    document.getElementById('userRole').textContent = "æŸ¥è©¢å¤±æ•—";
  }
}

/* ========= æ ¹æ“šè§’è‰²é¡¯ç¤ºé é¢ ========= */
function renderUIByRole(r) {
  const adminTabs = ["home","config","dashboard","checkin"];
  const driverTabs = ["home","checkin"];
  const userTabs = ["home","deny"];
  let visibleTabs = userTabs;
  if (r === "admin") visibleTabs = adminTabs;
  else if (r === "driver") visibleTabs = driverTabs;

  // é¡¯ç¤ºå¯ç”¨ tab
  document.querySelectorAll('section[id^="tab-"]').forEach(sec => sec.classList.add('hidden'));
  document.getElementById('tab-home').classList.remove('hidden');
  if (r === "user") document.getElementById('tab-deny').classList.remove('hidden');

  // åº•éƒ¨å°è¦½åˆ—æŒ‰éˆ•å¯è¦‹æ€§
  document.querySelectorAll('footer .tab-btn').forEach(btn => {
    const show = visibleTabs.includes(btn.dataset.target);
    btn.style.display = show ? 'block' : 'none';
  });
}

/* ========= å°è¦½åˆ‡æ› ========= */
function setupNav() {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset.target;
      document.querySelectorAll('section[id^="tab-"]').forEach(sec => {
        sec.id === 'tab-' + target ? sec.classList.remove('hidden') : sec.classList.add('hidden');
      });
    };
  });

  document.getElementById('saveConfig').onclick = saveConfig;
  document.getElementById('publishConfig').onclick = publishConfig;
  document.getElementById('testPush').onclick = sendTestPush;
}

/* ========= è¨­å®šæ“ä½œ ========= */
let config = { testMode:false, bookingMode:'single', announcement:'' };
function saveConfig() {
  config.testMode = document.getElementById('testMode').checked;
  config.bookingMode = document.querySelector('input[name="bookingMode"]:checked').value;
  config.announcement = document.getElementById('announcement').value;
  localStorage.setItem('pangolinAdminConfig', JSON.stringify(config));
  showMsg('âœ… è¨­å®šå·²å„²å­˜');
}
async function publishConfig() {
  saveConfig();
  await fetch(WORKER_URL + '?mode=updateRules', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(config) });
  showMsg('ğŸš€ å·²ç™¼ä½ˆè¨­å®š');
}
async function sendTestPush() {
  await fetch(WORKER_URL + '?mode=testPush');
  showMsg('ğŸ“¢ æ¸¬è©¦æ¨æ’­å·²ç™¼é€');
}

/* ========= é€šç”¨æç¤º ========= */
function showMsg(msg) {
  const div = document.createElement('div');
  div.textContent = msg;
  div.className = "fixed bottom-20 left-1/2 -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded-xl shadow";
  document.body.appendChild(div);
  setTimeout(()=>div.remove(),2000);
}
</script>
</body>
</html>
