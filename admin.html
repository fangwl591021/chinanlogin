<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šç®¡ç†å¾Œå° v6.5.1 (ä¿®æ­£ç‰ˆ)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family:"Noto Sans TC",system-ui,sans-serif;background:#f8fafc;margin:0; }
#loadingScreen,#loginScreen,#noAuthScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#f8fafc;flex-direction:column;text-align:center;}
#loginScreen,#noAuthScreen{display:none;}
#app{display:none;}
#topBar{position:sticky;top:0;background:#3c8050;color:white;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;z-index:100;}
#userInfo{display:flex;align-items:center;gap:10px;}
#userPicture{width:40px;height:40px;border-radius:50%;border:2px solid white;}
.nav-btn{flex:1;padding:10px 0;text-align:center;font-size:12px;font-weight:600;cursor:pointer;color:#666;}
.nav-btn.active{color:#3c8050;border-top:3px solid #3c8050;}
.section{display:none;}
.section.active{display:block;}
.card{background:white;border-radius:12px;padding:16px;margin:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.section-title{font-weight:800;font-size:18px;color:14532d;margin-bottom:16px;}
#bottomNav{position:fixed;bottom:0;left:0;width:100%;background:white;border-top:1px solid #ddd;display:flex;justify-content:space-around;z-index:50;}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:8px;color:white;font-weight:600;box-shadow:0 2px 6px rgba(0,0,0,0.2);opacity:0;transition:opacity .3s ease;z-index:999;}
.toast.show{opacity:1;}
.toast.success{background:#22c55e;}
.toast.error{background:#ef4444;}
.status-ok{color:#16a34a;font-weight:bold;}
.status-cancel{color:#dc2626;font-weight:bold;}
.status-wait{color:#ca8a04;font-weight:bold;}
.info-badge{background:#dbeafe;color:#1e40af;padding:4px 12px;border-radius:6px;font-size:12px;display:inline-block;margin-top:8px;}
/* âœ… æ–°å¢ï¼šé‡æ–°æ•´ç†æŒ‰éˆ•æ¨£å¼ */
.refresh-btn{background:#3c8050;color:white;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;border:none;transition:all 0.2s;}
.refresh-btn:hover{background:#2d6040;transform:scale(1.05);}
.refresh-btn:active{transform:scale(0.95);}
.refresh-btn.loading{opacity:0.6;pointer-events:none;}
</style>
</head>

<body>
<!-- ğŸŒ€ è¼‰å…¥ç•«é¢ -->
<div id="loadingScreen">
  <div class="animate-pulse text-center">
    <div class="text-3xl mb-3">ğŸšŒ ç©¿å±±ç”²å¾Œå°è¼‰å…¥ä¸­...</div>
    <div>è«‹ç¨å€™é©—è­‰æ‚¨çš„èº«åˆ†</div>
  </div>
</div>

<!-- ğŸ” ç™»å…¥æç¤º -->
<div id="loginScreen">
  <div class="text-5xl mb-4">ğŸ”</div>
  <div class="text-2xl font-bold text-green-800 mb-2">å°šæœªç™»å…¥</div>
  <p class="text-gray-600 mb-4">è«‹å…ˆç™»å…¥æ‚¨çš„ LINE å¸³è™Ÿä»¥ä½¿ç”¨å¾Œå°ç³»çµ±ã€‚</p>
  <button id="loginButton" class="bg-green-700 text-white px-6 py-3 rounded-lg text-lg font-bold">ğŸ“± é»æ­¤ç™»å…¥</button>
  <p class="text-sm text-gray-500 mt-4">è«‹åœ¨ LINE App ä¸­é–‹å•Ÿæ­¤é é¢</p>
</div>

<!-- ğŸš« ç„¡æ¬Šé™æç¤º -->
<div id="noAuthScreen">
  <div class="text-5xl mb-4">ğŸš«</div>
  <div class="text-2xl font-bold text-red-800 mb-2">ç„¡æ¬Šé™ä½¿ç”¨æ­¤é é¢</div>
  <p class="text-gray-600 mb-4">è«‹ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥æˆ–è¯çµ¡ç³»çµ±ç®¡ç†å“¡ã€‚</p>
  <div id="debugInfo" class="text-xs text-gray-500 bg-gray-100 p-3 rounded mt-4 text-left max-w-md"></div>
  <button id="reLogin" class="bg-gray-600 hover:bg-gray-700 text-white px-5 py-2 rounded mt-4">é‡æ–°ç™»å…¥</button>
</div>

<!-- âœ… ä¸»ç•«é¢ -->
<div id="app">
  <div id="topBar">
    <div class="font-bold text-lg">ğŸšŒ ç©¿å±±ç”²å¾Œå°ç³»çµ±</div>
    <div id="userInfo">
      <img id="userPicture" src="">
      <span id="userName">è¼‰å…¥ä¸­...</span>
      <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm ml-2">ç™»å‡º</button>
    </div>
  </div>

  <main>
    <!-- ğŸ“Š å„€è¡¨æ¿ -->
    <section id="dashboard" class="section active">
      <div class="card text-center">
        <h2 class="section-title">ğŸ“Š ç‡Ÿé‹å„€è¡¨æ¿</h2>
        <p class="text-gray-600 mb-4">æ­¡è¿ä½¿ç”¨ç©¿å±±ç”²å¾Œå°ç³»çµ±</p>
        <div id="statsArea" class="grid grid-cols-3 gap-4">
          <div class="bg-green-100 p-4 rounded-lg"><p>ä»Šæ—¥é ç´„</p><p id="todayCount" class="text-2xl font-bold text-green-700">-</p></div>
          <div class="bg-red-100 p-4 rounded-lg"><p>å·²å–æ¶ˆ</p><p id="cancelCount" class="text-2xl font-bold text-red-700">-</p></div>
          <div class="bg-blue-100 p-4 rounded-lg"><p>å·²æ­ä¹˜</p><p id="checkinCount" class="text-2xl font-bold text-blue-700">-</p></div>
        </div>
      </div>
    </section>

    <!-- ğŸ§¾ æŸ¥è©¢ -->
    <section id="query" class="section">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h2 class="section-title" style="margin-bottom:0;">ğŸ§¾ é ç´„æŸ¥è©¢</h2>
          <!-- âœ… æ–°å¢ï¼šé‡æ–°æ•´ç†æŒ‰éˆ• -->
          <button id="refreshBtn" class="refresh-btn">
            <span id="refreshIcon">ğŸ”„</span>
            <span id="refreshText">é‡æ–°æ•´ç†</span>
          </button>
        </div>
        <input type="text" id="search" placeholder="æœå°‹å§“åã€ç­æ¬¡æˆ–æ—¥æœŸ..." 
               class="border border-gray-300 rounded-md p-2 w-full mb-3">
        <div id="lastUpdateTime" class="text-xs text-gray-500 mb-2"></div>
        <div id="tableContainer" style="overflow-x:auto;">
          <table class="min-w-full text-sm">
            <thead class="bg-green-700 text-white sticky top-0">
              <tr>
                <th class="p-2">æ—¥æœŸ</th>
                <th class="p-2">ç­æ¬¡</th>
                <th class="p-2">å§“å</th>
                <th class="p-2">ç‹€æ…‹</th>
              </tr>
            </thead>
            <tbody id="tbl"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ğŸ“‹ æ ¸éŠ· -->
    <section id="checkin" class="section">
      <div class="card text-center">
        <h2 class="section-title">ğŸ“‹ æ ¸éŠ·ç®¡ç†</h2>
        <button id="goCheckin" class="bg-green-600 text-white px-4 py-3 rounded w-full text-lg">å‰å¾€æ ¸éŠ·ç³»çµ±</button>
        <p class="text-gray-500 mt-2 text-sm">é–‹å•Ÿ LIFFï¼š2006590746-G7B12a1K</p>
      </div>
    </section>

    <!-- ğŸš å¸æ©Ÿ -->
    <section id="driver" class="section">
      <div class="card">
        <h2 class="section-title">ğŸš å¸æ©Ÿç­è¡¨</h2>
        <ul class="list-disc ml-6 text-gray-700">
          <li>A1ï¼šé™³å¸æ©Ÿ</li><li>B1ï¼šæ—å¸æ©Ÿ</li><li>A2ï¼šç‹å¸æ©Ÿ</li><li>B2ï¼šå³å¸æ©Ÿ</li>
        </ul>
      </div>
    </section>

    <!-- âš™ï¸ è¨­å®š -->
    <section id="config" class="section">
      <div class="card">
        <h2 class="section-title">âš™ï¸ ç³»çµ±è¨­å®š</h2>
        
        <label class="block mb-2 font-semibold text-gray-700">æ¯ç­æ¬¡æ­è¼‰äººæ•¸ä¸Šé™</label>
        <input id="seatLimit" type="number" class="border p-2 w-full mb-3 rounded" />
        
        <label class="block mb-2 font-semibold text-gray-700">æœªæ ¸éŠ·é”å¹¾æ¬¡å¾Œç¦ç”¨</label>
        <input id="maxNoShow" type="number" class="border p-2 w-full mb-3 rounded" />
        
        <label class="block mb-2 font-semibold text-gray-700">ç¦ç”¨é€±æ•¸</label>
        <input id="banWeeks" type="number" class="border p-2 w-full mb-3 rounded" />
        
        <!-- é ç´„é–‹æ”¾å¤©æ•¸ -->
        <label class="block mb-2 font-semibold text-gray-700">ğŸ“… é ç´„é–‹æ”¾å¤©æ•¸</label>
        <input id="bookingDaysLimit" type="number" min="1" max="90" class="border p-2 w-full mb-2 rounded" placeholder="ä¾‹å¦‚ï¼š5" />
        <p class="text-sm text-gray-500 mb-3">
          è¨­å®šç”¨æˆ¶æœ€å¤šå¯é ç´„æœªä¾†å¹¾å¤©å…§çš„ç­æ¬¡ï¼ˆä¾‹å¦‚å¡« 5 è¡¨ç¤ºåªèƒ½é ç´„ä»Šå¤©èµ· 5 å¤©å…§çš„ç­æ¬¡ï¼‰
        </p>
        <div id="bookingDaysInfo" class="info-badge">
          ğŸ“Œ ç›®å‰é–‹æ”¾ï¼šä»Šæ—¥èµ· <span id="daysDisplay">-</span> å¤©å…§å¯é ç´„
        </div>
        
        <div class="border-t mt-4 pt-4">
          <label class="block mb-2 font-semibold text-gray-700">é ç´„æ¨¡å¼</label>
          <select id="tripMode" class="border p-2 w-full mb-3 rounded">
            <option value="single">å–®ç¨‹</option>
            <option value="round">å¯ä¾†å›</option>
          </select>
        </div>
        
        <!-- ğŸ§ª æ¸¬è©¦æ¨¡å¼èˆ‡æ™‚é–“é™åˆ¶ -->
        <div class="border-t mt-4 pt-4">
          <div class="flex items-center justify-between mb-3">
            <div>
              <label class="block font-semibold text-gray-700">ğŸ§ª æ¸¬è©¦æ¨¡å¼</label>
              <p class="text-xs text-gray-500 mt-1">é–‹å•Ÿå¾Œç„¡ä»»ä½•æ™‚é–“é™åˆ¶ï¼Œ24å°æ™‚éƒ½å¯é ç´„/å–æ¶ˆ</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="testMode" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
            </label>
          </div>
          <div id="testModeStatus" class="info-badge mb-3">
            ğŸ“Œ ç›®å‰ç‹€æ…‹ï¼š<span id="testModeText" class="font-bold">æ­£å¼æ¨¡å¼</span>
          </div>
          
          <!-- æ™‚é–“é™åˆ¶è¨­å®šï¼ˆåƒ…åœ¨æ­£å¼æ¨¡å¼æ™‚ç”Ÿæ•ˆï¼‰ -->
          <div id="timeRestrictions" class="mt-4">
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4">
              <p class="text-sm text-yellow-800">
                â° <strong>ä»¥ä¸‹æ™‚é–“é™åˆ¶åƒ…åœ¨ã€Œæ­£å¼æ¨¡å¼ã€ç”Ÿæ•ˆ</strong><br>
                <span class="text-xs">æ¸¬è©¦æ¨¡å¼ä¸‹ç„¡ä»»ä½•é™åˆ¶</span>
              </p>
            </div>
            
            <label class="block mb-2 font-semibold text-gray-700">â° æœ€æ™šé ç´„æ™‚é–“ï¼ˆç•¶æ—¥ç­æ¬¡ï¼‰</label>
            <input id="bookingDeadline" type="time" value="19:00" class="border p-2 w-full mb-2 rounded" />
            <p class="text-xs text-gray-500 mb-3">
              ä¾‹å¦‚è¨­å®š 19:00ï¼Œè¡¨ç¤ºæ¯å¤© 19:00 å¾Œç„¡æ³•é ç´„ã€Œç•¶å¤©ã€ç­æ¬¡<br>
              ä½†ä»å¯é ç´„ã€Œæ˜å¤©æˆ–æœªä¾†ã€çš„ç­æ¬¡
            </p>
            
            <label class="block mb-2 font-semibold text-gray-700">â° æœ€æ™šå–æ¶ˆæ™‚é–“ï¼ˆç•¶æ—¥é ç´„ï¼‰</label>
            <input id="cancelDeadline" type="time" value="18:00" class="border p-2 w-full mb-2 rounded" />
            <p class="text-xs text-gray-500 mb-3">
              ä¾‹å¦‚è¨­å®š 18:00ï¼Œè¡¨ç¤ºæ¯å¤© 18:00 å¾Œç„¡æ³•å–æ¶ˆã€Œç•¶å¤©ã€é ç´„<br>
              ä½†ä»å¯å–æ¶ˆã€Œæ˜å¤©æˆ–æœªä¾†ã€çš„é ç´„
            </p>
            
            <div class="bg-blue-50 border border-blue-200 rounded p-3 text-sm text-blue-800">
              <strong>ğŸ“Œ æ™‚é–“åˆ¤æ–·è¦å‰‡ï¼š</strong>
              <ul class="list-disc ml-5 mt-1 space-y-1">
                <li>ä½¿ç”¨å°ç£æ™‚é–“ï¼ˆUTC+8ï¼‰</li>
                <li>é™åˆ¶åƒ…é‡å°ã€Œç•¶å¤©ã€çš„ç­æ¬¡/é ç´„</li>
                <li>ã€Œæœªä¾†æ—¥æœŸã€çš„é ç´„/å–æ¶ˆä¸å—å½±éŸ¿</li>
              </ul>
            </div>
          </div>
        </div>
        
        <button id="saveRules" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full mt-4">ğŸ’¾ å„²å­˜è¨­å®š</button>
        <p id="ruleMeta" class="text-gray-500 text-sm mt-3"></p>
      </div>
    </section>
  </main>

  <div id="bottomNav">
    <div class="nav-btn active" data-sec="dashboard">ğŸ“Š å„€è¡¨æ¿</div>
    <div class="nav-btn" data-sec="query">ğŸ§¾ æŸ¥è©¢</div>
    <div class="nav-btn" data-sec="checkin">ğŸ“‹ æ ¸éŠ·</div>
    <div class="nav-btn" data-sec="driver">ğŸš å¸æ©Ÿ</div>
    <div class="nav-btn" data-sec="config">âš™ï¸ è¨­å®š</div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const WORKER_URL='https://delicate-math-7e61.fangwl591021.workers.dev/';
const LIFF_ID = '2006590746-wgL4l54z'; // ADMIN å¾Œå°å°ˆç”¨ LIFF ID
let allData=[];
let lastLoadTime = null; // âœ… è¨˜éŒ„æœ€å¾Œè¼‰å…¥æ™‚é–“

async function init(){
  try{
    console.log('ğŸ” é–‹å§‹åˆå§‹åŒ– LIFF...');
    await liff.init({liffId:LIFF_ID});
    console.log('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ');
    
    if(!liff.isLoggedIn()){
      console.log('ğŸ” ç”¨æˆ¶æœªç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥ç•«é¢');
      document.getElementById('loadingScreen').style.display='none';
      document.getElementById('loginScreen').style.display='flex';
      return;
    }

    const profile=await liff.getProfile();
    console.log('ğŸ‘¤ ç”¨æˆ¶è³‡æ–™:', profile);
    
    console.log('ğŸ”‘ æ­£åœ¨æª¢æŸ¥ç”¨æˆ¶æ¬Šé™...');
    let checkUrl = `${WORKER_URL}?mode=check&userId=${profile.userId}`;
    console.log('ğŸ“¡ è«‹æ±‚ URL:', checkUrl);
    
    let checkRes = await fetch(checkUrl, {
      cache: 'no-store',  // âœ… é˜²æ­¢å¿«å–
      headers: {'Cache-Control': 'no-cache'}
    });
    console.log('ğŸ“¡ check å›æ‡‰ç‹€æ…‹:', checkRes.status);
    
    const text = await checkRes.text();
    console.log('ğŸ“„ check åŸå§‹å›æ‡‰ï¼ˆå‰ 500 å­—å…ƒï¼‰:', text.substring(0, 500));
    
    let userData;
    try {
      userData = JSON.parse(text);
    } catch (parseErr) {
      console.error('âŒ JSON è§£æå¤±æ•—:', parseErr);
      console.error('ğŸ“„ å®Œæ•´å›æ‡‰:', text);
      throw new Error(`API è¿”å›æ ¼å¼éŒ¯èª¤ï¼š${text.substring(0, 200)}`);
    }
    
    console.log('ğŸ¯ check çµæœ:', userData);

    let isAdmin = false;
    let debugMsg = '';
    
    if (userData.registered && userData.user) {
      console.log('âœ“ ç”¨æˆ¶å·²è¨»å†Š');
      console.log('- userId:', userData.user.userId);
      console.log('- name:', userData.user.name);
      console.log('- isAdmin:', userData.user.isAdmin);
      console.log('- isAdmin type:', typeof userData.user.isAdmin);
      
      const adminValue = userData.user.isAdmin;
      if (adminValue === true || 
          adminValue === 'TRUE' || 
          adminValue === 'true' ||
          adminValue === 1 || 
          adminValue === '1' ||
          adminValue === 'admin') {
        isAdmin = true;
        console.log('âœ… ç”¨æˆ¶æ˜¯ç®¡ç†å“¡ (isAdmin æ¬„ä½æª¢æŸ¥é€šé)');
      } else {
        console.log('âŒ ç”¨æˆ¶ä¸æ˜¯ç®¡ç†å“¡');
        debugMsg = `isAdmin æ¬„ä½å€¼: ${JSON.stringify(adminValue)}\néœ€è¦: true/TRUE/1/admin`;
      }
    } else {
      console.log('âŒ ç”¨æˆ¶æœªè¨»å†Šæˆ–è³‡æ–™ä¸å®Œæ•´');
      debugMsg = `registered: ${userData.registered}\nuser ç‰©ä»¶: ${JSON.stringify(userData.user)}`;
    }

    if (!isAdmin) {
      console.log('âŒ ç„¡æ¬Šé™ï¼Œé¡¯ç¤ºç„¡æ¬Šé™ç•«é¢');
      document.getElementById('loadingScreen').style.display='none';
      document.getElementById('noAuthScreen').style.display='flex';
      document.getElementById('debugInfo').innerHTML = `
        <strong>é™¤éŒ¯è³‡è¨Šï¼š</strong><br>
        ç”¨æˆ¶åç¨±ï¼š${profile.displayName}<br>
        ç”¨æˆ¶ IDï¼š${profile.userId}<br>
        ${debugMsg}
      `;
      return;
    }

    console.log('âœ… æ¬Šé™é©—è­‰é€šéï¼Œé¡¯ç¤ºä¸»ç•«é¢');
    document.getElementById('loadingScreen').style.display='none';
    document.getElementById('app').style.display='block';
    document.getElementById('userName').textContent = profile.displayName + ' (ç®¡ç†å“¡)';
    document.getElementById('userPicture').src = profile.pictureUrl;

    setupNav();

    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById('dashboard').classList.add('active');

    // âœ… ç«‹å³è¼‰å…¥è³‡æ–™ï¼Œä¸å»¶é²
    await loadDashboardStats();
    await loadRules();
    // æ³¨æ„ï¼šä¸åœ¨é€™è£¡è¼‰å…¥é ç´„è³‡æ–™ï¼Œç­‰ç”¨æˆ¶åˆ‡æ›åˆ°æŸ¥è©¢é é¢æ™‚æ‰è¼‰å…¥

  }catch(e){
    console.error('âŒ åˆå§‹åŒ–éŒ¯èª¤:', e);
    showToast('âš ï¸ åˆå§‹åŒ–éŒ¯èª¤','error');
  }
}

document.getElementById('loginButton').addEventListener('click',()=>liff.login());
document.getElementById('reLogin').addEventListener('click',()=>liff.login());
document.getElementById('logoutBtn').addEventListener('click',()=>{liff.logout();location.reload();});

function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className=`toast show ${type}`;
  setTimeout(()=>t.classList.remove('show'),3000);
}

async function loadDashboardStats(){
  try{
    const timestamp = new Date().getTime();
    const res=await fetch(`${WORKER_URL}?mode=dashboard&_t=${timestamp}`, {
      cache: 'no-store',
      headers: {'Cache-Control': 'no-cache'}
    });
    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch (parseErr) {
      console.error('âŒ Dashboard JSON è§£æå¤±æ•—:', parseErr);
      console.error('ğŸ“„ åŸå§‹å›æ‡‰:', text.substring(0, 200));
      throw parseErr;
    }
    document.getElementById('todayCount').textContent=data.dashboard?.todayCount||'-';
    document.getElementById('cancelCount').textContent=data.dashboard?.cancelCount||'-';
    document.getElementById('checkinCount').textContent=data.dashboard?.checkinCount||'-';
  }catch(e){console.warn('çµ±è¨ˆè³‡æ–™è¼‰å…¥å¤±æ•—:', e);}
}

// âœ… ä¿®æ­£ç‰ˆï¼šå¼·åˆ¶ä¸ä½¿ç”¨å¿«å–
async function loadReservations(showLoading = true) {
  const tbody = document.getElementById('tbl');
  const refreshBtn = document.getElementById('refreshBtn');
  const refreshIcon = document.getElementById('refreshIcon');
  const refreshText = document.getElementById('refreshText');
  
  if (showLoading) {
    tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">ğŸ”„ æŸ¥è©¢ä¸­...</td></tr>`;
    if (refreshBtn) {
      refreshBtn.classList.add('loading');
      refreshIcon.style.animation = 'spin 1s linear infinite';
      refreshText.textContent = 'è¼‰å…¥ä¸­...';
    }
  }

  try {
    console.log('ğŸš€ é–‹å§‹è¼‰å…¥é ç´„è³‡æ–™...');
    
    // âœ… åŠ å…¥æ™‚é–“æˆ³é˜²æ­¢å¿«å–
    const timestamp = new Date().getTime();
    const res = await fetch(`${WORKER_URL}?mode=allReservations&_t=${timestamp}`, {
      method: 'GET',
      cache: 'no-store',  // å¼·åˆ¶ä¸ä½¿ç”¨å¿«å–
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      }
    });
    
    console.log('âœ… è«‹æ±‚å®Œæˆï¼Œç‹€æ…‹:', res.status);
    console.log('ğŸ“‹ Content-Type:', res.headers.get('content-type'));
    
    const text = await res.text();
    console.log('ğŸ“„ åŸå§‹å›æ‡‰ï¼ˆå‰ 500 å­—å…ƒï¼‰:', text.substring(0, 500));
    
    let json;
    try {
      json = JSON.parse(text);
    } catch (parseErr) {
      console.error('âŒ JSON è§£æå¤±æ•—:', parseErr);
      console.error('ğŸ“„ å®Œæ•´å›æ‡‰:', text);
      throw new Error(`API è¿”å›æ ¼å¼éŒ¯èª¤ï¼š${text.substring(0, 200)}`);
    }
    
    console.log('ğŸ“Š æ”¶åˆ°å›æ‡‰:', json);

    if (!res.ok || json.status === 'error' || !json.ok) {
      throw new Error(json.message || json.error || 'Worker å›æ‡‰éŒ¯èª¤');
    }

    const list = json.reservations || [];

    if (!Array.isArray(list)) {
      throw new Error('è³‡æ–™æ ¼å¼éŒ¯èª¤');
    }

    // âœ… æ›´æ–°æœ€å¾Œè¼‰å…¥æ™‚é–“
    lastLoadTime = new Date();
    updateLastLoadTime();

    if (list.length === 0) {
      tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-400">ç›®å‰æ²’æœ‰é ç´„è³‡æ–™</td></tr>`;
      showToast('âœ… å·²æ›´æ–°ï¼ˆç„¡è³‡æ–™ï¼‰');
      return;
    }

    const data = list.map(r => ({
      date: r.date || '',
      route: r.route || '',
      name: r.name || '',
      status: r.status || ''
    }));

    const validData = data.filter(r => r.date || r.route || r.name || r.status);

    if (validData.length === 0) {
      tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-400">ç›®å‰æ²’æœ‰æœ‰æ•ˆçš„é ç´„è³‡æ–™</td></tr>`;
      showToast('âœ… å·²æ›´æ–°ï¼ˆç„¡æœ‰æ•ˆè³‡æ–™ï¼‰');
      return;
    }

    // æ’åºè¦å‰‡
    const routeOrder = { A1: 1, A2: 2, B1: 3, B2: 4 };
    
    const getStatusPriority = (status) => {
      if (!status) return 1;
      if (status.includes('æ­ä¹˜')) return 2;
      if (status.includes('å–æ¶ˆ')) return 0;
      return 1;
    };
    
    validData.sort((a, b) => {
      if (a.date < b.date) return 1;
      if (a.date > b.date) return -1;
      
      const statusDiff = getStatusPriority(b.status) - getStatusPriority(a.status);
      if (statusDiff !== 0) return statusDiff;
      
      return (routeOrder[a.route] || 99) - (routeOrder[b.route] || 99);
    });

    renderTable(validData);
    allData = validData;
    showToast(`âœ… å·²æ›´æ–° ${validData.length} ç­†é ç´„è³‡æ–™`);
    
  } catch (e) {
    console.error('âŒ å¾Œå°æŸ¥è©¢éŒ¯èª¤', e);
    tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">âŒ æŸ¥è©¢å¤±æ•—ï¼š${e.message}</td></tr>`;
    showToast('âŒ è¼‰å…¥é ç´„è³‡æ–™å¤±æ•—', 'error');
  } finally {
    // âœ… æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    if (refreshBtn) {
      refreshBtn.classList.remove('loading');
      refreshIcon.style.animation = '';
      refreshText.textContent = 'é‡æ–°æ•´ç†';
    }
  }
}

// âœ… æ–°å¢ï¼šæ›´æ–°æœ€å¾Œè¼‰å…¥æ™‚é–“é¡¯ç¤º
function updateLastLoadTime() {
  const timeDisplay = document.getElementById('lastUpdateTime');
  if (lastLoadTime) {
    const now = new Date();
    const diff = Math.floor((now - lastLoadTime) / 1000); // ç§’æ•¸
    
    let timeText;
    if (diff < 60) {
      timeText = `${diff} ç§’å‰æ›´æ–°`;
    } else if (diff < 3600) {
      timeText = `${Math.floor(diff / 60)} åˆ†é˜å‰æ›´æ–°`;
    } else {
      timeText = lastLoadTime.toLocaleTimeString('zh-TW');
    }
    
    timeDisplay.textContent = `ğŸ“¡ ${timeText}`;
    timeDisplay.style.color = diff < 120 ? '#16a34a' : '#6b7280';
  }
}

// âœ… æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
function formatDate(dateStr) {
  if (!dateStr) return '-';
  
  try {
    let date;
    
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
      date = new Date(dateStr + 'T00:00:00');
    }
    else if (dateStr.includes('GMT') || dateStr.includes('T')) {
      date = new Date(dateStr);
    }
    else {
      date = new Date(dateStr);
    }
    
    if (isNaN(date.getTime())) {
      console.warn('ç„¡æ³•è§£ææ—¥æœŸ:', dateStr);
      return dateStr;
    }
    
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    
    const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
    const weekday = weekdays[date.getDay()];
    
    return `${year}-${month}-${day} (${weekday})`;
  } catch (e) {
    console.warn('æ—¥æœŸæ ¼å¼åŒ–å¤±æ•—:', dateStr, e);
    if (dateStr.includes('GMT')) {
      return dateStr.split(' GMT')[0].substring(0, 15);
    }
    return dateStr;
  }
}

function renderTable(data) {
  const tbody = document.getElementById('tbl');

  if (!data || !Array.isArray(data) || data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-400">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„</td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(r => {
    const cls = r.status && r.status.includes('å–æ¶ˆ')
      ? 'status-cancel'
      : r.status && r.status.includes('æ­ä¹˜')
      ? 'status-ok'
      : 'status-wait';
    
    return `
      <tr class="border-b hover:bg-green-50 transition">
        <td class="p-2">${formatDate(r.date)}</td>
        <td class="p-2">${r.route || '-'}</td>
        <td class="p-2">${r.name || '-'}</td>
        <td class="p-2 ${cls}">${r.status || '-'}</td>
      </tr>`;
  }).join('');
}

document.getElementById('search').addEventListener('input', e => {
  const k = e.target.value.trim().toLowerCase();
  
  if (!allData || !Array.isArray(allData)) {
    renderTable([]);
    return;
  }
  
  const filtered = allData.filter(r =>
    (r.name && r.name.toLowerCase().includes(k)) ||
    (r.route && r.route.toLowerCase().includes(k)) ||
    (r.date && r.date.includes(k))
  );
  renderTable(filtered);
});

async function loadRules(){
  try {
    const timestamp = new Date().getTime();
    const res = await fetch(`${WORKER_URL}?mode=getRules&_t=${timestamp}`, {
      cache: 'no-store',
      headers: {'Cache-Control': 'no-cache'}
    });
    
    const text = await res.text();
    console.log('ğŸ“„ getRules åŸå§‹å›æ‡‰ï¼ˆå‰ 500 å­—å…ƒï¼‰:', text.substring(0, 500));
    
    let json;
    try {
      json = JSON.parse(text);
    } catch (parseErr) {
      console.error('âŒ JSON è§£æå¤±æ•—:', parseErr);
      throw new Error(`API è¿”å›æ ¼å¼éŒ¯èª¤ï¼š${text.substring(0, 200)}`);
    }
    
    const r = json.current || {};
    
    document.getElementById('seatLimit').value = r.seatLimit || '';
    document.getElementById('maxNoShow').value = r.maxNoShow || '';
    document.getElementById('banWeeks').value = r.banWeeks || '';
    document.getElementById('tripMode').value = r.tripMode || 'single';
    
    const bookingDaysLimit = r.advanceBookingDays || r.bookingDaysLimit || 7;
    document.getElementById('bookingDaysLimit').value = bookingDaysLimit;
    document.getElementById('daysDisplay').textContent = bookingDaysLimit;
    
    const testMode = r.testMode === true || r.testMode === 'true' || r.testMode === 1;
    document.getElementById('testMode').checked = testMode;
    updateTestModeUI(testMode);
    
    const bookingDeadline = r.bookingDeadline || '19:00';
    const cancelDeadline = r.cancelDeadline || '18:00';
    
    const formatTime = (time, defaultTime = '19:00') => {
      if (!time) return defaultTime;
      const timeStr = String(time).trim();
      
      if (/^\d{2}:\d{2}$/.test(timeStr)) return timeStr;
      if (/^\d:\d{2}$/.test(timeStr)) return '0' + timeStr;
      
      if (timeStr.includes('T')) {
        try {
          const date = new Date(timeStr);
          if (!isNaN(date.getTime())) {
            const hours = String(date.getUTCHours()).padStart(2, '0');
            const minutes = String(date.getUTCMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
          }
        } catch (e) {
          console.warn('âš ï¸ ISO æ ¼å¼è§£æå¤±æ•—:', e);
        }
      }
      
      if (timeStr.match(/T?(\d{1,2}):(\d{2})/)) {
        const match = timeStr.match(/T?(\d{1,2}):(\d{2})/);
        const hours = match[1].padStart(2, '0');
        const minutes = match[2];
        return `${hours}:${minutes}`;
      }
      
      return defaultTime;
    };
    
    const formattedBooking = formatTime(bookingDeadline);
    const formattedCancel = formatTime(cancelDeadline);
    
    document.getElementById('bookingDeadline').value = formattedBooking;
    document.getElementById('cancelDeadline').value = formattedCancel;
    
    document.getElementById('ruleMeta').textContent = `æœ€å¾Œæ›´æ–°ï¼š${r.lastUpdate || 'æœªçŸ¥'}`;
  } catch (e) {
    console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', e);
    showToast('âŒ è¼‰å…¥è¨­å®šå¤±æ•—', 'error');
  }
}

function updateTestModeUI(isTestMode) {
  const statusText = document.getElementById('testModeText');
  const statusBadge = document.getElementById('testModeStatus');
  const timeRestrictions = document.getElementById('timeRestrictions');
  
  if (isTestMode) {
    statusText.textContent = 'æ¸¬è©¦æ¨¡å¼ï¼ˆç„¡é™åˆ¶ï¼‰';
    statusText.style.color = '#16a34a';
    statusBadge.style.background = '#dcfce7';
    statusBadge.style.color = '#166534';
    timeRestrictions.style.opacity = '0.5';
    timeRestrictions.style.pointerEvents = 'none';
  } else {
    statusText.textContent = 'æ­£å¼æ¨¡å¼ï¼ˆå·²å•Ÿç”¨é™åˆ¶ï¼‰';
    statusText.style.color = '#dc2626';
    statusBadge.style.background = '#fee2e2';
    statusBadge.style.color = '#991b1b';
    timeRestrictions.style.opacity = '1';
    timeRestrictions.style.pointerEvents = 'auto';
  }
}

document.getElementById('testMode').addEventListener('change', function(e) {
  updateTestModeUI(e.target.checked);
});

document.getElementById('bookingDaysLimit').addEventListener('input', function(e) {
  const days = parseInt(e.target.value) || 0;
  document.getElementById('daysDisplay').textContent = days;
  
  if (days < 1) {
    e.target.style.borderColor = '#ef4444';
  } else if (days > 90) {
    e.target.style.borderColor = '#f59e0b';
  } else {
    e.target.style.borderColor = '#d1d5db';
  }
});

document.getElementById('saveRules').addEventListener('click', async () => {
  const bookingDaysLimit = parseInt(document.getElementById('bookingDaysLimit').value);
  
  if (!bookingDaysLimit || bookingDaysLimit < 1) {
    showToast('âš ï¸ é ç´„é–‹æ”¾å¤©æ•¸å¿…é ˆè‡³å°‘ç‚º 1 å¤©', 'error');
    document.getElementById('bookingDaysLimit').focus();
    return;
  }
  
  if (bookingDaysLimit > 90) {
    showToast('âš ï¸ é ç´„é–‹æ”¾å¤©æ•¸å»ºè­°ä¸è¶…é 90 å¤©', 'error');
    document.getElementById('bookingDaysLimit').focus();
    return;
  }
  
  const body = {
    seatLimit: +document.getElementById('seatLimit').value,
    maxNoShow: +document.getElementById('maxNoShow').value,
    banWeeks: +document.getElementById('banWeeks').value,
    tripMode: document.getElementById('tripMode').value,
    advanceBookingDays: bookingDaysLimit,
    testMode: document.getElementById('testMode').checked,
    bookingDeadline: document.getElementById('bookingDeadline').value,
    cancelDeadline: document.getElementById('cancelDeadline').value
  };
  
  try {
    const res = await fetch(`${WORKER_URL}?mode=updateRules`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });
    
    const text = await res.text();
    
    let json;
    try {
      json = JSON.parse(text);
    } catch (parseErr) {
      console.error('âŒ JSON è§£æå¤±æ•—:', parseErr);
      throw new Error(`API è¿”å›æ ¼å¼éŒ¯èª¤ï¼š${text.substring(0, 200)}`);
    }
    
    if(json.status === 'success') {
      const modeText = body.testMode ? 'æ¸¬è©¦æ¨¡å¼ï¼ˆç„¡é™åˆ¶ï¼‰' : 'æ­£å¼æ¨¡å¼ï¼ˆå·²å•Ÿç”¨æ™‚é–“é™åˆ¶ï¼‰';
      showToast(`âœ… è¨­å®šå·²æ›´æ–°ï¼${modeText}`);
      await loadRules();
    } else {
      showToast('âŒ æ›´æ–°å¤±æ•—: ' + (json.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
    }
  } catch(e) {
    console.error('æ›´æ–°è¨­å®šå¤±æ•—:', e);
    showToast('âŒ é€£ç·šéŒ¯èª¤', 'error');
  }
});

// âœ… æ–°å¢ï¼šé‡æ–°æ•´ç†æŒ‰éˆ•äº‹ä»¶
document.getElementById('refreshBtn').addEventListener('click', async () => {
  console.log('ğŸ”„ æ‰‹å‹•é‡æ–°æ•´ç†è³‡æ–™');
  await loadReservations(true);
});

function setupNav(){
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      document.getElementById(btn.dataset.sec).classList.add('active');
      
      // âœ… ç•¶åˆ‡æ›åˆ°æŸ¥è©¢é é¢æ™‚ï¼Œè‡ªå‹•è¼‰å…¥æœ€æ–°è³‡æ–™
      if(btn.dataset.sec === 'query') {
        console.log('ğŸ“Š åˆ‡æ›åˆ°æŸ¥è©¢é é¢ï¼Œè¼‰å…¥æœ€æ–°è³‡æ–™');
        await loadReservations(true);
      }
    });
  });
  
  document.getElementById('goCheckin').addEventListener('click',()=>{
    liff.openWindow({url:'https://liff.line.me/2006590746-G7B12a1K',external:false});
  });
}

// âœ… æ–°å¢ï¼šæ¯éš” 60 ç§’è‡ªå‹•æ›´æ–°æ™‚é–“é¡¯ç¤º
setInterval(() => {
  if (lastLoadTime) {
    updateLastLoadTime();
  }
}, 60000); // æ¯ 60 ç§’æ›´æ–°ä¸€æ¬¡

// æ–°å¢ CSS animation for refresh icon
const style = document.createElement('style');
style.textContent = `
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
`;
document.head.appendChild(style);

init();
</script>
</body>
</html>
