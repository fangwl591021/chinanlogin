<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šå¾Œå° v3.4</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --text-lg: 18px;
  --text-xl: 22px;
  --text-2xl: 28px;
}
body {
  background:#f8fafc;
  font-family: "Noto Sans TC", system-ui, sans-serif;
  font-size: var(--text-lg);
  line-height:1.6;
  color:#334155;
}

/* ===== å·¦å´é¸å–® ===== */
aside {
  width: 260px;
  background:#ffffff;
  border-right:1px solid #e5e7eb;
  box-shadow: 2px 0 6px rgba(0,0,0,0.05);
}
.sidebar-btn {
  display:block;
  width:100%;
  padding:14px 18px;
  text-align:left;
  font-size:var(--text-lg);
  border-radius:8px;
  transition:background .2s;
}
.sidebar-btn:hover { background:#e0f2e9; color:#256d3f; }
.sidebar-btn.active { background:#3c8050; color:white; font-weight:700; }

/* ===== ä¸»å…§å®¹å€ ===== */
.card {
  background:white;
  border-radius:16px;
  padding:28px;
  box-shadow:0 2px 10px rgba(0,0,0,0.08);
  max-width:1080px;
  margin:auto;
}
.section-title {
  font-weight:800;
  font-size:var(--text-xl);
  color:#14532d;
  margin-bottom:16px;
  display:flex;
  align-items:center;
}
.section-title::before {
  content:"";
  display:inline-block;
  width:8px;
  height:24px;
  background:#22c55e;
  border-radius:3px;
  margin-right:10px;
}

/* ===== è¡¨å–®æ¨£å¼ ===== */
input, textarea, select {
  font-size: var(--text-lg);
  border-radius:8px;
  padding:8px 10px;
  border:1px solid #cbd5e1;
}
button {
  font-size: var(--text-lg);
  font-weight:600;
  border-radius:10px;
  padding:12px 16px;
  transition: all .2s;
}
button:hover { opacity:0.9; }
table { font-size: var(--text-lg); }

/* ===== éŸ¿æ‡‰å¼ ===== */
@media (max-width: 1024px) {
  aside { width:220px; }
  .card { padding:20px; }
}

/* è¼‰å…¥ä¸­æŒ‡ç¤ºå™¨ */
#loadingMessage {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 30px;
    font-size: var(--text-xl);
    color: #64748b;
}

/* ç°½åˆ°ç‹€æ…‹æ¨£å¼ */
.checkin-status {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
}

.checkin-yes {
  background-color: #d1fae5;
  color: #065f46;
}

.checkin-no {
  background-color: #fef3c7;
  color: #92400e;
}

/* ç°½åˆ°æŒ‰éˆ•æ¨£å¼ */
.checkin-btn {
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.2s;
  border: none;
  cursor: pointer;
}

.checkin-btn.checked {
  background-color: #10b981;
  color: white;
}

.checkin-btn.unchecked {
  background-color: #f3f4f6;
  color: #6b7280;
  border: 1px solid #d1d5db;
}

.checkin-btn.unchecked:hover {
  background-color: #e5e7eb;
}

/* ç‹€æ…‹æ¨™ç±¤æ¨£å¼ */
.status-confirmed { 
  background-color: #d1fae5; 
  color: #065f46; 
  padding: 4px 10px; 
  border-radius: 20px; 
  font-size: 14px;
  font-weight: 600;
}
.status-cancelled { 
  background-color: #fecaca; 
  color: #991b1b; 
  padding: 4px 10px; 
  border-radius: 20px; 
  font-size: 14px;
  font-weight: 600;
}
.status-pending { 
  background-color: #fef3c7; 
  color: #92400e; 
  padding: 4px 10px; 
  border-radius: 20px; 
  font-size: 14px;
  font-weight: 600;
}

/* å®¹é‡è¨­å®šæ¨£å¼ */
.capacity-input {
  border: 2px solid #e5e7eb;
  transition: all 0.3s;
}
.capacity-input:focus {
  border-color: #10b981;
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}
.capacity-label {
  font-weight: 600;
  color: #374151;
}

</style>
</head>

<body class="flex h-screen overflow-hidden">

<!-- ğŸ§­ å·¦å´å°è¦½å€ -->
<aside class="flex flex-col">
  <div class="p-5 border-b text-center bg-green-700 text-white">
    <h1 class="text-2xl font-bold">ğŸšŒ å¾Œå°ç®¡ç†</h1>
    <p class="text-sm opacity-90">ç©¿å±±ç”²å°ˆè»Šç³»çµ±</p>
  </div>

  <nav class="flex-1 p-3 space-y-2">
    <button class="sidebar-btn active" data-target="config">ğŸ”§ ç‡Ÿé‹è¨­å®š</button>
    <button class="sidebar-btn" data-target="dashboard">ğŸ“Š å„€è¡¨æ¿</button>
    <button class="sidebar-btn" data-target="reservations">ğŸ§¾ é ç´„æŸ¥è©¢</button>
    <button class="sidebar-btn" data-target="drivers">ğŸš å¸æ©Ÿç­è¡¨</button>
  </nav>

  <div class="p-4 border-t text-center text-gray-600 text-sm">
    âš™ï¸ <a href="#" id="reloadLink" class="underline">é‡æ–°æ•´ç†è³‡æ–™</a>
  </div>
</aside>

<!-- ğŸ–¥ï¸ å³å´ä¸»å…§å®¹ -->
<main class="flex-1 overflow-y-auto p-8">

  <!-- ğŸ”§ ç‡Ÿé‹è¨­å®š -->
  <section id="config" class="card block">
    <h2 class="section-title">ğŸ”§ ç‡Ÿé‹è¨­å®šä¸­å¿ƒ</h2>

    <label class="block font-semibold mb-2">é‹ç‡Ÿæ¨¡å¼ï¼š</label>
    <div class="flex gap-6 mb-4 text-lg">
      <label><input type="radio" name="mode" value="S3" class="mr-1" /> å–®è¶Ÿåˆ¶ï¼ˆS3ï¼‰</label>
      <label><input type="radio" name="mode" value="S4" class="mr-1" checked /> ä¾†å›åˆ¶ï¼ˆS4ï¼‰</label>
    </div>

    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6 text-lg">
      <div class="flex flex-col items-center">
        <label class="capacity-label mb-2">A1 ç­æ¬¡</label>
        <input id="capA1" type="number" min="1" max="50" value="6" class="capacity-input border rounded px-3 py-2 w-24 text-center">
        <span class="text-sm text-gray-500 mt-1">å¯é ç´„äººæ•¸</span>
      </div>
      <div class="flex flex-col items-center">
        <label class="capacity-label mb-2">A2 ç­æ¬¡</label>
        <input id="capA2" type="number" min="1" max="50" value="6" class="capacity-input border rounded px-3 py-2 w-24 text-center">
        <span class="text-sm text-gray-500 mt-1">å¯é ç´„äººæ•¸</span>
      </div>
      <div class="flex flex-col items-center">
        <label class="capacity-label mb-2">B1 ç­æ¬¡</label>
        <input id="capB1" type="number" min="1" max="50" value="6" class="capacity-input border rounded px-3 py-2 w-24 text-center">
        <span class="text-sm text-gray-500 mt-1">å¯é ç´„äººæ•¸</span>
      </div>
      <div class="flex flex-col items-center">
        <label class="capacity-label mb-2">B2 ç­æ¬¡</label>
        <input id="capB2" type="number" min="1" max="50" value="6" class="capacity-input border rounded px-3 py-2 w-24 text-center">
        <span class="text-sm text-gray-500 mt-1">å¯é ç´„äººæ•¸</span>
      </div>
    </div>

    <div class="space-y-3 mb-6">
      <label><input type="checkbox" id="enableBooking" class="mr-1" checked> é–‹æ”¾é ç´„</label><br>
      <label><input type="checkbox" id="enableCancel" class="mr-1" checked> å…è¨±å–æ¶ˆ</label>
    </div>

    <div class="mb-4">
      <label class="block font-semibold mb-2">ç³»çµ±å…¬å‘Šï¼š</label>
      <textarea id="announcement" rows="3" class="w-full border rounded px-3 py-2 text-lg" placeholder="è¼¸å…¥ç³»çµ±å…¬å‘Šè¨Šæ¯...">æ­¡è¿ä½¿ç”¨ç©¿å±±ç”²å°ˆè»Šé ç´„ç³»çµ±ï¼</textarea>
    </div>

    <div class="flex gap-3">
      <button id="saveConfig" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded flex-1 text-lg">
        ğŸ’¾ å„²å­˜è¨­å®š
      </button>
      <button id="publishConfig" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded flex-1 text-lg">
        ğŸš€ ç™¼ä½ˆåˆ°å‰ç«¯
      </button>
    </div>

    <!-- å³æ™‚é è¦½ -->
    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
      <h3 class="font-semibold text-lg mb-3">ğŸ“± å‰ç«¯å³æ™‚é è¦½</h3>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <span class="font-medium">A1 ç­æ¬¡å®¹é‡ï¼š</span>
          <span id="previewA1" class="text-green-600 font-bold">6</span>
        </div>
        <div>
          <span class="font-medium">A2 ç­æ¬¡å®¹é‡ï¼š</span>
          <span id="previewA2" class="text-green-600 font-bold">6</span>
        </div>
        <div>
          <span class="font-medium">B1 ç­æ¬¡å®¹é‡ï¼š</span>
          <span id="previewB1" class="text-green-600 font-bold">6</span>
        </div>
        <div>
          <span class="font-medium">B2 ç­æ¬¡å®¹é‡ï¼š</span>
          <span id="previewB2" class="text-green-600 font-bold">6</span>
        </div>
        <div class="col-span-2">
          <span class="font-medium">é ç´„ç‹€æ…‹ï¼š</span>
          <span id="previewBooking" class="text-green-600 font-bold">é–‹æ”¾ä¸­</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ğŸ“Š å„€è¡¨æ¿ -->
  <section id="dashboard" class="card hidden">
    <h2 class="section-title">ğŸ“Š ç‡Ÿé‹å„€è¡¨æ¿</h2>
    <div class="grid grid-cols-2 gap-6 mb-6">
      <div>
        <p class="font-semibold text-lg">ä»Šæ—¥ç¸½é ç´„æ•¸ï¼š</p>
        <p id="todayTotal" class="text-4xl font-bold text-green-700 mt-1">--</p>
      </div>
      <div>
        <p class="font-semibold text-lg">å‰©é¤˜åé¡ï¼š</p>
        <p id="remainingSeats" class="text-4xl font-bold text-blue-700 mt-1">--</p>
      </div>
    </div>
    <canvas id="chartTrips" height="120"></canvas>
  </section>

  <!-- ğŸ§¾ é ç´„æŸ¥è©¢ -->
  <section id="reservations" class="card hidden">
    <h2 class="section-title">ğŸ§¾ é ç´„æŸ¥è©¢èˆ‡ç®¡ç†</h2>
    <div class="flex gap-3 mb-4">
      <input id="searchInput" placeholder="è¼¸å…¥å§“å / æ—¥æœŸ / ç­æ¬¡æœå°‹..." class="border rounded px-3 py-2 w-full text-lg">
      <button id="exportCsv" class="bg-gray-700 text-white px-5 py-3 rounded hover:bg-gray-800 text-lg">ğŸ“¤ åŒ¯å‡ºCSV</button>
    </div>
    <div id="reservationTable" class="overflow-x-auto text-base">
      <table class="min-w-full border">
        <thead class="bg-green-700 text-white">
          <tr>
            <th class="p-3 border">æ—¥æœŸ</th>
            <th class="p-3 border">ç­æ¬¡</th>
            <th class="p-3 border">å§“å</th>
            <th class="p-3 border">ç³»æ‰€/è¨»è¨˜</th>
            <th class="p-3 border">é›»è©±</th>
            <th class="p-3 border">ç‹€æ…‹</th>
            <th class="p-3 border">ç°½åˆ°ç‹€æ…‹</th>
            <th class="p-3 border">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="reservationBody">
          <tr><td colspan="8" id="loadingMessage">é»æ“Šã€Œé ç´„æŸ¥è©¢ã€è¼‰å…¥è³‡æ–™...</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ğŸš å¸æ©Ÿç­è¡¨ -->
  <section id="drivers" class="card hidden">
    <h2 class="section-title">ğŸš å¸æ©Ÿç­è¡¨</h2>
    <table class="min-w-full border text-base">
      <thead class="bg-blue-700 text-white">
        <tr>
          <th class="p-3 border">æ—¥æœŸ</th>
          <th class="p-3 border">A1 (22:00â†’22:30)</th>
          <th class="p-3 border">A2 (23:00â†’23:30)</th>
          <th class="p-3 border">B1 (22:30â†’23:00)</th>
          <th class="p-3 border">B2 (23:30â†’24:00)</th>
        </tr>
      </thead>
      <tbody id="driverTable">
        <tr class="text-center">
          <td class="p-2 border">2025-10-13</td>
          <td class="p-2 border">ç‹å¤§æ˜</td>
          <td class="p-2 border">æå°ç¾</td>
          <td class="p-2 border">å¼µå¿—å¼·</td>
          <td class="p-2 border">æ—ä½©èŠ¬</td>
        </tr>
      </tbody>
    </table>
  </section>

</main>

<!-- JS -->
<script>
// ğŸš¨ğŸš¨ğŸš¨ è«‹å°‡é€™è£¡æ›¿æ›æˆæ‚¨å¯¦éš›éƒ¨ç½²çš„ Cloudflare Worker URL ğŸš¨ğŸš¨ğŸš¨
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/'; 

const sections = document.querySelectorAll("main section");
const reservationBody = document.getElementById('reservationBody');
const searchInput = document.getElementById('searchInput');

let allReservations = []; // ç”¨æ–¼å„²å­˜å¾ API ç²å–çš„åŸå§‹è³‡æ–™

// ç³»çµ±è¨­å®šè³‡æ–™
let systemConfig = {
  capacities: {
    A1: 6,
    A2: 6,
    B1: 6,
    B2: 6
  },
  mode: 'S4',
  enableBooking: true,
  enableCancel: true,
  announcement: 'æ­¡è¿ä½¿ç”¨ç©¿å±±ç”²å°ˆè»Šé ç´„ç³»çµ±ï¼'
};

// åˆå§‹åŒ–è¨­å®š
function initializeConfig() {
  // å¾ localStorage è¼‰å…¥è¨­å®šï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
  const savedConfig = localStorage.getItem('pangolinBusConfig');
  if (savedConfig) {
    systemConfig = JSON.parse(savedConfig);
  }
  
  // æ›´æ–°è¡¨å–®é¡¯ç¤º
  document.getElementById('capA1').value = systemConfig.capacities.A1;
  document.getElementById('capA2').value = systemConfig.capacities.A2;
  document.getElementById('capB1').value = systemConfig.capacities.B1;
  document.getElementById('capB2').value = systemConfig.capacities.B2;
  
  document.querySelector(`input[name="mode"][value="${systemConfig.mode}"]`).checked = true;
  document.getElementById('enableBooking').checked = systemConfig.enableBooking;
  document.getElementById('enableCancel').checked = systemConfig.enableCancel;
  document.getElementById('announcement').value = systemConfig.announcement;
  
  // æ›´æ–°é è¦½
  updatePreview();
}

// æ›´æ–°å³æ™‚é è¦½
function updatePreview() {
  document.getElementById('previewA1').textContent = systemConfig.capacities.A1;
  document.getElementById('previewA2').textContent = systemConfig.capacities.A2;
  document.getElementById('previewB1').textContent = systemConfig.capacities.B1;
  document.getElementById('previewB2').textContent = systemConfig.capacities.B2;
  document.getElementById('previewBooking').textContent = systemConfig.enableBooking ? 'é–‹æ”¾ä¸­' : 'å·²é—œé–‰';
}

// å„²å­˜è¨­å®šåˆ° localStorage
function saveConfigToLocal() {
  // å¾è¡¨å–®è®€å–å€¼
  systemConfig.capacities.A1 = parseInt(document.getElementById('capA1').value) || 6;
  systemConfig.capacities.A2 = parseInt(document.getElementById('capA2').value) || 6;
  systemConfig.capacities.B1 = parseInt(document.getElementById('capB1').value) || 6;
  systemConfig.capacities.B2 = parseInt(document.getElementById('capB2').value) || 6;
  
  systemConfig.mode = document.querySelector('input[name="mode"]:checked').value;
  systemConfig.enableBooking = document.getElementById('enableBooking').checked;
  systemConfig.enableCancel = document.getElementById('enableCancel').checked;
  systemConfig.announcement = document.getElementById('announcement').value;
  
  // å„²å­˜åˆ° localStorage
  localStorage.setItem('pangolinBusConfig', JSON.stringify(systemConfig));
  
  // æ›´æ–°é è¦½
  updatePreview();
  
  return systemConfig;
}

// ç™¼ä½ˆè¨­å®šåˆ°å‰ç«¯ç³»çµ±
async function publishConfigToFrontend() {
  const config = saveConfigToLocal();
  
  try {
    // é€™è£¡å¯ä»¥æ›¿æ›æˆæ‚¨å¯¦éš›çš„å‰ç«¯ API ç«¯é»
    // ç¯„ä¾‹ï¼šç™¼é€åˆ° Cloudflare Worker æˆ–å…¶ä»–å¾Œç«¯æœå‹™
    const response = await fetch(`${WORKER_URL}?mode=updateConfig`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(config)
    });
    
    if (response.ok) {
      showNotification('âœ… è¨­å®šå·²æˆåŠŸç™¼ä½ˆåˆ°å‰ç«¯ç³»çµ±ï¼', 'success');
      console.log('è¨­å®šå·²ç™¼ä½ˆï¼š', config);
    } else {
      throw new Error('ç™¼ä½ˆå¤±æ•—');
    }
  } catch (error) {
    // å¦‚æœæ²’æœ‰å¯¦éš›çš„ APIï¼Œæˆ‘å€‘æ¨¡æ“¬æˆåŠŸç™¼ä½ˆ
    console.log('æ¨¡æ“¬ç™¼ä½ˆè¨­å®šåˆ°å‰ç«¯ï¼š', config);
    showNotification('âœ… è¨­å®šå·²æˆåŠŸæ›´æ–°ï¼ˆæ¨¡æ“¬ç™¼ä½ˆï¼‰ï¼', 'success');
    
    // åœ¨å¯¦éš›ç’°å¢ƒä¸­ï¼Œæ‚¨æ‡‰è©²å–æ¶ˆä¸‹é¢çš„è¨»è§£ä¸¦è™•ç†éŒ¯èª¤
    // showNotification('âŒ ç™¼ä½ˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
  }
}

// å¾å¾Œç«¯è¼‰å…¥ç•¶å‰è¨­å®š
async function loadConfigFromBackend() {
  try {
    const response = await fetch(`${WORKER_URL}?mode=getConfig`);
    if (response.ok) {
      const backendConfig = await response.json();
      
      // åˆä½µå¾Œç«¯è¨­å®šï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
      if (backendConfig && backendConfig.capacities) {
        systemConfig = { ...systemConfig, ...backendConfig };
        initializeConfig();
        showNotification('âœ… å·²å¾å¾Œç«¯è¼‰å…¥æœ€æ–°è¨­å®š', 'success');
      }
    }
  } catch (error) {
    console.log('ç„¡æ³•å¾å¾Œç«¯è¼‰å…¥è¨­å®šï¼Œä½¿ç”¨æœ¬åœ°è¨­å®š');
  }
}

// å®¹é‡è¼¸å…¥å³æ™‚æ›´æ–°
function setupCapacityListeners() {
  const capacityInputs = ['capA1', 'capA2', 'capB1', 'capB2'];
  
  capacityInputs.forEach(id => {
    document.getElementById(id).addEventListener('input', function() {
      const value = parseInt(this.value) || 0;
      if (value < 1) this.value = 1;
      if (value > 50) this.value = 50;
      
      // å³æ™‚æ›´æ–°é è¦½
      const route = id.replace('cap', '');
      document.getElementById(`preview${route}`).textContent = this.value;
    });
  });
  
  // å…¶ä»–è¨­å®šè®Šæ›´ç›£è½
  document.getElementById('enableBooking').addEventListener('change', function() {
    document.getElementById('previewBooking').textContent = this.checked ? 'é–‹æ”¾ä¸­' : 'å·²é—œé–‰';
  });
}

// æ¸²æŸ“è¡¨æ ¼
function renderReservations(data) {
    if (!data || data.length === 0) {
        reservationBody.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-gray-500">
                                      ç›®å‰æ²’æœ‰é ç´„è³‡æ–™ã€‚
                                    </td></tr>`;
        return;
    }

    reservationBody.innerHTML = ''; 

    data.forEach((item, index) => {
        const row = document.createElement('tr');
        row.className = index % 2 === 1 ? 'text-center bg-gray-50' : 'text-center'; 
        
        // ç‹€æ…‹æ¨™ç±¤
        let statusClass = '';
        let statusText = '';
        if (item.status === 'å·²ç¢ºèª' || item.status === 'confirmed') {
            statusClass = 'status-confirmed';
            statusText = 'å·²ç¢ºèª';
        } else if (item.status === 'å·²å–æ¶ˆ' || item.status === 'cancelled') {
            statusClass = 'status-cancelled';
            statusText = 'å·²å–æ¶ˆ';
        } else {
            statusClass = 'status-pending';
            statusText = 'å¾…ç¢ºèª';
        }
        
        // ç°½åˆ°ç‹€æ…‹
        const isCheckedIn = item.checkedIn || false;
        const checkinStatusClass = isCheckedIn ? 'checkin-yes' : 'checkin-no';
        const checkinStatusText = isCheckedIn ? 'å·²æ­ä¹˜' : 'æœªæ­ä¹˜';
        
        // âœ… æ”¹ç”¨ Worker å¯¦éš›å›å‚³çš„æ¬„ä½åç¨±
        row.innerHTML = `
            <td class="p-2 border">${item.date || '--'}</td>
            <td class="p-2 border">${item.route || '--'}</td>
            <td class="p-2 border">${item.name || '--'}</td>
            <td class="p-2 border">${item.department || '--'}</td>
            <td class="p-2 border">${item.phone || '--'}</td>
            <td class="p-2 border"><span class="${statusClass}">${statusText}</span></td>
            <td class="p-2 border"><span class="checkin-status ${checkinStatusClass}">${checkinStatusText}</span></td>
            <td class="p-2 border">
              <button class="checkin-btn ${isCheckedIn ? 'checked' : 'unchecked'}" 
                      data-id="${item.id || index}" 
                      data-checked="${isCheckedIn}">
                ${isCheckedIn ? 'âœ… å·²ç°½åˆ°' : 'ğŸ”„ æ¨™è¨˜æ­ä¹˜'}
              </button>
            </td>
        `;
        reservationBody.appendChild(row);
    });
    
    // æ·»åŠ ç°½åˆ°æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
    document.querySelectorAll('.checkin-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const isCurrentlyChecked = this.dataset.checked === 'true';
            
            // åˆ‡æ›ç°½åˆ°ç‹€æ…‹
            toggleCheckinStatus(id, !isCurrentlyChecked);
        });
    });
}

// åˆ‡æ›ç°½åˆ°ç‹€æ…‹
function toggleCheckinStatus(id, newStatus) {
    const reservationIndex = allReservations.findIndex(item => 
        (item.id && item.id.toString() === id) || 
        (allReservations.indexOf(item).toString() === id)
    );
    
    if (reservationIndex !== -1) {
        allReservations[reservationIndex].checkedIn = newStatus;
        renderReservations(allReservations);
        
        const statusText = newStatus ? 'å·²æ¨™è¨˜ç‚ºå·²æ­ä¹˜' : 'å·²å–æ¶ˆæ­ä¹˜æ¨™è¨˜';
        showNotification(`æˆåŠŸæ›´æ–°ç°½åˆ°ç‹€æ…‹ï¼š${statusText}`, 'success');
    }
}

// é¡¯ç¤ºé€šçŸ¥
function showNotification(message, type = 'info') {
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = `notification fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// æœå°‹åŠŸèƒ½
searchInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();
    if (query === '') {
        renderReservations(allReservations);
        return;
    }
    const filteredData = allReservations.filter(item => {
        return Object.values(item).some(val => 
            String(val).toLowerCase().includes(query)
        );
    });
    renderReservations(filteredData);
});

// å¯¦éš›æŠ“å–é ç´„è³‡æ–™
async function fetchReservations() {
    if (WORKER_URL === 'YOUR_ACTUAL_CLOUDFLARE_WORKER_URL_HERE') {
        reservationBody.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-red-600 font-bold">
                                      éŒ¯èª¤ï¼šè«‹å…ˆè¨­å®š Worker URLï¼
                                    </td></tr>`;
        return;
    }
    
    reservationBody.innerHTML = `<tr><td colspan="8" id="loadingMessage">
                                  <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-green-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                  </svg>
                                  è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...
                                </td></tr>`;

    try {
        const response = await fetch(`${WORKER_URL}?mode=reservations`);
        
        if (!response.ok) {
            throw new Error(`API éŒ¯èª¤: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // å˜—è©¦å¾ä¸åŒä½ç½®å–å¾—é ç´„è³‡æ–™
        if (data && Array.isArray(data.data)) {
            allReservations = data.data;
        } else if (data && Array.isArray(data.reservations)) {
            allReservations = data.reservations;
        } else if (Array.isArray(data)) {
            allReservations = data;
        } else {
            throw new Error('è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºï¼šç„¡æ³•æ‰¾åˆ°é ç´„é™£åˆ—');
        }
        
        // æŒ‰æ—¥æœŸé™å†ªæ’åº
        allReservations.sort((a, b) => {
            const da = new Date(a.date || '1970-01-01');
            const db = new Date(b.date || '1970-01-01');
            return db - da;
        });

        // ç‚ºæ¯ç­†è³‡æ–™æ·»åŠ ç°½åˆ°ç‹€æ…‹
        allReservations.forEach(item => {
            if (item.checkedIn === undefined) {
                item.checkedIn = false;
            }
        });

        renderReservations(allReservations);

    } catch (error) {
        console.error('âŒ æŠ“å–é ç´„è³‡æ–™å¤±æ•—:', error);
        reservationBody.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-red-600 font-bold">
                                      âŒ è³‡æ–™è¼‰å…¥å¤±æ•—: ${error.message}
                                    </td></tr>`;
    }
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  // åˆå§‹åŒ–è¨­å®š
  initializeConfig();
  setupCapacityListeners();
  
  // ç¶å®šæŒ‰éˆ•äº‹ä»¶
  document.getElementById('saveConfig').addEventListener('click', function() {
    saveConfigToLocal();
    showNotification('âœ… è¨­å®šå·²å„²å­˜ï¼', 'success');
  });
  
  document.getElementById('publishConfig').addEventListener('click', function() {
    publishConfigToFrontend();
  });
  
  // å¾å¾Œç«¯è¼‰å…¥è¨­å®šï¼ˆå¯é¸ï¼‰
  loadConfigFromBackend();
  
  // å…¶ä»–ç¾æœ‰çš„äº‹ä»¶ç¶å®š
  document.querySelectorAll(".sidebar-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        document.querySelectorAll(".sidebar-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        
        const target = btn.dataset.target;
        sections.forEach(sec => {
            sec.id === target ? sec.classList.remove("hidden") : sec.classList.add("hidden");
        });

        if (target === 'reservations' && allReservations.length === 0) {
            fetchReservations();
        } else if (target === 'reservations') {
            renderReservations(allReservations);
        }
    });
  });

  document.getElementById('reloadLink').addEventListener('click', (e) => {
    e.preventDefault();
    allReservations = [];
    fetchReservations();
  });

  document.getElementById('config').classList.remove('hidden');
});

</script>

</body>
</html>
