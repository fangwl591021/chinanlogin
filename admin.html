<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šå¾Œå°ç³»çµ± - èª¿è©¦ç‰ˆ</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-green-800 mb-6">ğŸ”§ ç©¿å±±ç”²å¾Œå°ç³»çµ± - æ¬Šé™èª¿è©¦</h1>
    
    <div id="debugInfo" class="bg-white p-6 rounded-lg shadow-md space-y-4"></div>
    
    <div class="mt-6">
      <button onclick="runDebug()" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-bold">
        ğŸš€ é–‹å§‹èª¿è©¦
      </button>
    </div>
  </div>

<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';

function log(message, type = 'info') {
  const debugInfo = document.getElementById('debugInfo');
  const color = {
    info: 'text-blue-600',
    success: 'text-green-600', 
    error: 'text-red-600',
    warning: 'text-yellow-600'
  }[type];
  
  const emoji = {
    info: 'â„¹ï¸',
    success: 'âœ…',
    error: 'âŒ',
    warning: 'âš ï¸'
  }[type];
  
  debugInfo.innerHTML += `
    <div class="border-l-4 ${color.replace('text', 'border')} pl-4 py-1">
      <span class="font-mono">${emoji} ${new Date().toLocaleTimeString()}</span>
      <span class="${color}">${message}</span>
    </div>
  `;
}

async function runDebug() {
  try {
    log('1. æ­£åœ¨åˆå§‹åŒ– LIFF...');
    await liff.init({ liffId: '2006590746-wgL4l54z' });
    log('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ');
    
    log('2. æ­£åœ¨ç²å–ç”¨æˆ¶è³‡æ–™...');
    const profile = await liff.getProfile();
    const userId = profile.userId;
    log(`âœ… ç²å–ç”¨æˆ¶è³‡æ–™æˆåŠŸ: ${profile.displayName}`);
    log(`ğŸ” LINE User ID: ${userId}`);
    log(`ğŸ“¸ é ­åƒ URL: ${profile.pictureUrl}`);
    
    log('3. æ­£åœ¨æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™...');
    const roleUrl = `${WORKER_URL}?mode=getRole&userId=${userId}`;
    log(`ğŸ”— è«‹æ±‚ URL: ${roleUrl}`);
    
    const response = await fetch(roleUrl);
    const responseText = await response.text();
    log(`ğŸ“¥ åŸå§‹å›æ‡‰: ${responseText}`);
    
    const roleData = JSON.parse(responseText);
    log(`ğŸ” æ¬Šé™æª¢æŸ¥çµæœ:`, 'info');
    log(`   - ç‹€æ…‹: ${roleData.status}`);
    log(`   - è§’è‰²: ${roleData.role}`);
    log(`   - ä¾†æº: ${roleData.source}`);
    log(`   - ç”¨æˆ¶ID: ${roleData.userId}`);
    log(`   - è¨Šæ¯: ${roleData.message}`);
    
    if (roleData.status === 'success' && roleData.role === 'admin') {
      log('ğŸ‰ æ­å–œï¼æ‚¨æœ‰ç®¡ç†å“¡æ¬Šé™ï¼Œå¯ä»¥è¨ªå•å¾Œå°ç³»çµ±', 'success');
      log('ğŸ“ å¾Œå°ç¶²å€: https://fangwl591021.github.io/chinanlogin/admin.html', 'success');
      
      // è‡ªå‹•è·³è½‰åˆ°å¾Œå°
      setTimeout(() => {
        window.location.href = 'https://fangwl591021.github.io/chinanlogin/admin.html';
      }, 3000);
    } else {
      log('âŒ æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•è¨ªå•å¾Œå°ç³»çµ±', 'error');
      log('ğŸ’¡ è§£æ±ºæ–¹æ¡ˆ:', 'warning');
      log('   1. å°‡ä¸Šé¢çš„ User ID è¤‡è£½åˆ° GAS çš„ MASTER_ADMINS é™£åˆ—ä¸­');
      log('   2. é‡æ–°éƒ¨ç½² GAS é …ç›®');
      log('   3. æ›´æ–° Cloudflare Worker ä¸­çš„ MASTER_ADMINS');
      log('   4. é‡æ–°è¼‰å…¥æ­¤é é¢æ¸¬è©¦');
    }
    
  } catch (error) {
    log(`âŒ èª¿è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
    console.error('èª¿è©¦éŒ¯èª¤:', error);
  }
}

// é é¢è¼‰å…¥å¾Œè‡ªå‹•é–‹å§‹èª¿è©¦
document.addEventListener('DOMContentLoaded', runDebug);
</script>
</body>
</html>
