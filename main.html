<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç©¿å±±ç”²å°ˆè»Šé ç´„</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
    header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; }
    .card { background:#fff; margin:16px; border-radius:8px; padding:16px; box-shadow:0 0 5px rgba(0,0,0,0.1); }

    input, select { width:100%; padding:10px; margin-top:8px; border-radius:6px; border:1px solid #ccc; font-size:16px; }
    button { width:100%; background:#3c8050; color:#fff; border:none; padding:12px; border-radius:6px; font-size:18px; font-weight:bold; margin-top:12px; cursor:pointer; position: relative; }
    button:disabled { background:#aaa; cursor:not-allowed; }
    button.loading { background:#2d6140; color: transparent; }
    button.loading::after {
      content: ''; position: absolute; width: 20px; height: 20px; top: 50%; left: 50%;
      margin: -10px 0 0 -10px; border: 2px solid #ffffff; border-radius: 50%;
      border-top-color: transparent; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .notice { padding:10px; margin-top:10px; border-radius:6px; }
    .notice.error { background:#fdecea; color:#b71c1c; border:1px solid #f5c2c7; }
    .notice.success { background:#e8f5e9; color:#2e7d32; border:1px solid #81c784; }

    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap:3px; text-align:center; font-size:13px; }
    .calendar-header { padding:6px 0; font-weight:bold; background:#f0f0f0; border-radius:3px; font-size:12px; }
    .calendar-day { padding:4px 0; border-radius:4px; background:#fff; border:1px solid #e0e0e0; cursor:pointer; min-height:30px; display:flex; flex-direction:column; justify-content:center; }
    .calendar-day:hover { background:#e8f5e9; }
    .calendar-day.no-service { background:#ffe6e6; color:#999; cursor:not-allowed; }
    .calendar-day.selected { background:#3c8050; color:#fff; font-weight:bold; }
    .calendar-day.other-month { color:#ccc; }
    .calendar-day.today { border:2px solid #3c8050; }
    .calendar-day small { font-size:9px; }

    #routeButtons { display:flex; flex-wrap:wrap; gap:4px; justify-content:space-between; margin: 0 -2px; }
    .route-btn { flex: 0 0 calc(45% - 4px); margin: 0 1px; padding: 4px 2px; border-radius:6px; text-align:left; border:1px solid #ddd; font-size:12px; cursor:pointer; transition:0.2s; min-height:80px; display:flex; align-items:center; background:#fff; color:#000; box-sizing: border-box; }
    .route-btn.A1, .route-btn.B1 { border-color:#4caf50; }
    .route-btn.A2, .route-btn.B2 { border-color:#4285f4; }
    .route-btn.full { background:#f5f5f5; color:#999; border-color:#ccc; cursor:not-allowed; }
    .route-btn.selected { color:#fff !important; }
    .route-btn.selected.A1, .route-btn.selected.B1 { background:#2e7d32; border-color:#2e7d32; }
    .route-btn.selected.A2, .route-btn.selected.B2 { background:#1a73e8; border-color:#1a73e8; }
    .route-content { display: flex; flex-direction: column; gap: 2px; width: 90%; padding: 0 2px; }
    .route-time { font-weight: bold; font-size: 14px; line-height: 1.2; }
    .route-direction { font-size: 14px; line-height: 1.2; margin: 1px 0; }
    .route-seats { font-size: 14px; color: #666; line-height: 1.2; }

    .reservation-card { background: #fff; border-radius: 8px; padding: 0; margin: 16px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; overflow: hidden; }
    .reservation-header { background: #3c8050; color: white; padding: 12px 15px; font-weight: bold; font-size: 16px; }
    .reservation-body { padding: 15px; }
    .reservation-detail { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #555555; }
    .reservation-detail-label { font-weight: bold; min-width: 60px; }
    .reservation-detail-value { flex: 1; text-align: right; }
    .reservation-footer { padding: 10px 15px 15px; text-align: center; }
    .cancel-btn { background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 14px; cursor: pointer; width: auto; min-width: 100px; }
    .cancel-btn:hover { background: #d32f2f; }
    .cancel-btn:disabled { background: #ccc; cursor: not-allowed; }
    .status-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 8px; }
    .status-active { background: #e8f5e9; color: #2e7d32; }
    .status-cancelled { background: #ffebee; color: #c62828; }

    .divider { height: 1px; background: #e0e0e0; margin: 20px 0; }
  </style>
</head>
<body>
  <header>ğŸšŒ ç©¿å±±ç”²å°ˆè»Šé ç´„</header>
  <div class="card">
    <div id="userInfo"></div>
    <div id="existingReservations" style="margin-bottom:20px; display:none;">
      <h3 style="margin:0 0 10px 0; color:#2e7d32;">ğŸ“‹ æˆ‘çš„é ç´„è¨˜éŒ„</h3>
      <div id="reservationsList"></div>
    </div>

    <label><center>é¸æ“‡æ­ä¹˜æ—¥æœŸ</center></label>
    <button id="calendarBtn" onclick="toggleCalendar()" disabled>ğŸ“… è¼‰å…¥ä¸­...</button>
    <div id="result" style="margin-top:10px;"></div>

    <!-- ç•¶å‰é ç´„å¡ç‰‡ -->
    <div id="currentReservationCard" style="display:none;">
      <div class="divider"></div>
      <h3 style="margin:0 0 15px 0; color:#2e7d32;">ğŸšŒ ç•¶å‰é ç´„</h3>
      <div id="reservationCardContent"></div>
    </div>

    <!-- æœˆæ›† -->
    <div id="calendarContainer" style="display:none;margin-top:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <button onclick="changeMonth(-1)" style="width:auto; padding:5px 10px;">â—€ ä¸Šå€‹æœˆ</button>
        <h3 id="calendarTitle" style="margin:0; font-size:16px;"></h3>
        <button onclick="changeMonth(1)" style="width:auto; padding:5px 10px;">ä¸‹å€‹æœˆ â–¶</button>
      </div>
      <div id="calendar" class="calendar"></div>
    </div>
    <div id="selectedDate" class="notice success" style="display:none;"></div>
    <div id="holidayNotice" class="notice error" style="display:none;"></div>

    <div id="routeSection" class="route-section">
      <label>è«‹é¸æ“‡æ­ä¹˜ç­æ¬¡ *</label>
      <div id="routeButtons"></div>
      <label>ä¸‹è»Šç«™ *</label>
      <select id="toStop"><option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option></select>
      <button id="submitBtn" onclick="submitForm()">é€å‡ºé ç´„</button>
    </div>
  </div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
// ------------------ ğŸ”¹ å…¨åŸŸè®Šæ•¸ ------------------
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let selectedDate = null;
let selectedRoute = null;
let userData = null;
let existingReservations = [];
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let noServiceDates = {};

// ------------------ ğŸ§­ Flex å¡æ¨æ’­ ------------------
function buildReservationFlexCard(res) {
  return {
    type: "flex",
    altText: "ğŸšŒ ç©¿å±±ç”²å°ˆè»Šæ–°é ç´„",
    contents: {
      type: "bubble",
      size: "mega",
      body: {
        type: "box",
        layout: "vertical",
        contents: [
          { type: "text", text: "ğŸšŒ ç©¿å±±ç”²å°ˆè»Šæ–°é ç´„", weight: "bold", size: "lg", color: "#2E7D32" },
          { type: "separator", margin: "md" },
          { type: "box", layout: "vertical", margin: "md", spacing: "sm", contents: [
              { type: "text", text: `ğŸ‘¤ ${res.name}`, size: "sm" },
              { type: "text", text: `ğŸ“… ${res.date}`, size: "sm" },
              { type: "text", text: `ğŸš ${res.route} ${res.routeName.split('|')[1]}`, size: "sm" },
              { type: "text", text: `ğŸ†™ ä¸Šè»Šï¼š${res.fromStop}`, size: "sm" },
              { type: "text", text: `â¬‡ï¸ ä¸‹è»Šï¼š${res.toStop}`, size: "sm" },
              { type: "text", text: `ğŸ“ ${res.phone || ''}`, size: "sm" }
          ]}
        ]
      }
    }
  };
}

function buildCancelFlexCard(res) {
  return {
    type: "flex",
    altText: "ğŸ›‘ ç©¿å±±ç”²å°ˆè»Šå–æ¶ˆé ç´„",
    contents: {
      type: "bubble",
      size: "mega",
      body: {
        type: "box",
        layout: "vertical",
        contents: [
          { type: "text", text: "ğŸ›‘ ç©¿å±±ç”²å°ˆè»Šå–æ¶ˆé ç´„", weight: "bold", size: "lg", color: "#C62828" },
          { type: "separator", margin: "md" },
          { type: "box", layout: "vertical", margin: "md", spacing: "sm", contents: [
              { type: "text", text: `ğŸ‘¤ ${res.name}`, size: "sm" },
              { type: "text", text: `ğŸ“… ${res.date}`, size: "sm" },
              { type: "text", text: `ğŸš ${res.route} ${res.routeName.split('|')[1]}`, size: "sm" },
              { type: "text", text: `ğŸ†™ ${res.fromStop}`, size: "sm" },
              { type: "text", text: `â¬‡ï¸ ${res.toStop}`, size: "sm" }
          ]}
        ]
      }
    }
  };
}

async function pushFlexToLine(flex) {
  try {
    await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ type:'pushLine', flex })
    });
  } catch (err) {
    console.error('âŒ æ¨æ’­ Flex å¡å¤±æ•—', err);
  }
}

// ------------------ ğŸ“… è¼‰å…¥åœé§›æ—¥ ------------------
async function loadNoServiceDates() {
  try {
    const startDate = formatDateToLocal(new Date(currentYear, currentMonth - 1, 1));
    const endDate = formatDateToLocal(new Date(currentYear, currentMonth + 2, 0));
    const res = await fetch(`${WORKER_URL}?mode=calendar&start=${startDate}&end=${endDate}&calendarId=${encodeURIComponent(CALENDAR_ID)}`);
    const result = await res.json();
    noServiceDates = {};
    if (result.holidays && Array.isArray(result.holidays)) {
      result.holidays.forEach(date => {
        if (typeof date === 'string' && date.length >= 10) {
          noServiceDates[date.substring(0, 10)] = true;
        }
      });
    }
  } catch (error) {
    console.error('è¼‰å…¥åœé§›æ—¥æœŸå¤±æ•—:', error);
    noServiceDates = {};
  }
}

// ------------------ ğŸ“… æœˆæ›† ------------------
async function toggleCalendar() {
  const container = document.getElementById('calendarContainer');
  if (container.style.display === 'none') {
    await renderCalendar();
    container.style.display = 'block';
  } else {
    container.style.display = 'none';
  }
}

async function changeMonth(direction) {
  currentMonth += direction;
  if (currentMonth < 0) { currentMonth = 11; currentYear--; }
  else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  await loadNoServiceDates();
  await renderCalendar();
}

async function renderCalendar() {
  const cal = document.getElementById('calendar');
  const title = document.getElementById('calendarTitle');
  cal.innerHTML = '';

  const monthNames = ['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
  title.textContent = `${currentYear}å¹´ ${monthNames[currentMonth]}`;

  ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => {
    const el = document.createElement('div');
    el.className = 'calendar-header';
    el.textContent = d;
    cal.appendChild(el);
  });

  const today = new Date();
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const startWeekday = firstDay.getDay();
  const totalDays = lastDay.getDate();
  const prevMonthLast = new Date(currentYear, currentMonth, 0).getDate();

  for (let i = startWeekday - 1; i >= 0; i--) {
    const el = document.createElement('div');
    el.className = 'calendar-day other-month';
    el.textContent = prevMonthLast - i;
    cal.appendChild(el);
  }

  for (let d = 1; d <= totalDays; d++) {
    const date = new Date(currentYear, currentMonth, d);
    const formatted = formatDateToLocal(date);
    const el = document.createElement('div');
    el.className = 'calendar-day';

    if (formatted === formatDateToLocal(today)) el.classList.add('today');
    const isPast = date < today && formatted !== formatDateToLocal(today);
    const isNoService = noServiceDates[formatted];

    if (isNoService || isPast) {
      el.classList.add('no-service');
      if (isNoService) el.innerHTML = `${d}<br><small>åœé§›</small>`;
      else el.innerHTML = `${d}<br><small>å·²éæœŸ</small>`;
    } else {
      el.textContent = d;
      el.onclick = () => selectDate(formatted);
    }

    if (selectedDate === formatted) el.classList.add('selected');
    cal.appendChild(el);
  }

  const remainingCells = 42 - (startWeekday + totalDays);
  for (let d = 1; d <= remainingCells; d++) {
    const el = document.createElement('div');
    el.className = 'calendar-day other-month';
    el.textContent = d;
    cal.appendChild(el);
  }
}

