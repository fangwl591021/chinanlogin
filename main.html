<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>穿山甲專車預約</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
    header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; }
    .card { background:#fff; margin:16px; border-radius:8px; padding:16px; box-shadow:0 0 5px rgba(0,0,0,0.1); }

    /* 月曆按鈕 */
    #calendarBtn { width:100%; background:#3c8050; color:#fff; border:none; padding:12px; border-radius:6px; font-size:16px; font-weight:bold; margin:10px 0; cursor:pointer; }

    /* 預約卡片 */
    .reservation-card {
      background: #fff;
      border-radius: 8px;
      padding: 0;
      margin: 20px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
      overflow: hidden;
    }
    .reservation-header {
      background: #3c8050;
      color: white;
      padding: 12px 15px;
      font-weight: bold;
      font-size: 18px;
      text-align: center;
    }
    .reservation-body {
      padding: 15px;
    }
    .reservation-line {
      margin-bottom: 8px;
      font-size: 14px;
      line-height: 1.4;
    }
    .reservation-label {
      font-weight: bold;
      color: #333;
      display: inline-block;
      min-width: 60px;
    }
    .reservation-value {
      color: #000;
      margin-left: 5px;
    }

    /* 取消按鈕 */
    .cancel-btn {
      background: #d9534f;
      color: #fff;
      border: none;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }
    .cancel-btn:hover {
      background: #c9302c;
    }
  </style>
</head>
<body>
  <header>穿山甲專車預約</header>

  <div class="card">
    <!-- 使用者資訊 -->
    <div id="userInfo" class="user-section">
      <div class="loading-state">⏳ 系統初始化中...</div>
    </div>

    <!-- 📅 月曆按鈕 -->
    <button id="calendarBtn" onclick="toggleCalendar()">📅 打開月曆</button>

    <!-- 預約卡片區 -->
    <div id="currentReservationCard" style="display:none;"></div>

    <!-- 📅 月曆容器 -->
    <div id="calendarContainer" style="display:none;margin-top:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <button onclick="changeMonth(-1)" style="width:auto; padding:5px 10px;">◀ 上個月</button>
        <h3 id="calendarTitle" style="margin:0; font-size:16px;"></h3>
        <button onclick="changeMonth(1)" style="width:auto; padding:5px 10px;">下個月 ▶</button>
      </div>
      <div id="calendar" class="calendar"></div>
    </div>
    <div id="selectedDate" class="notice success" style="display:none;"></div>
    <div id="holidayNotice" class="notice error" style="display:none;"></div>
  </div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
let selectedDate = null;
let userData = null;
let existingReservations = [];
const routeTimes = {
  'A1': { time: '22:00-22:30', direction: '暨大→埔里總站' },
  'B1': { time: '22:30-23:00', direction: '埔里總站→暨大' },
  'A2': { time: '23:00-23:30', direction: '暨大→埔里總站' },
  'B2': { time: '23:30-24:00', direction: '埔里總站→暨大' }
};

// === 顯示預約卡片（有取消功能） ===
function renderCurrentReservationCard() {
  const section = document.getElementById('currentReservationCard');
  section.innerHTML = '';

  const today = formatDateToLocal(new Date());
  const activeReservations = existingReservations
    .filter(res => res.date >= today && res.status !== '已取消')
    .sort((a, b) => a.date.localeCompare(b.date));

  if (activeReservations.length === 0) {
    section.innerHTML = '<p style="text-align:center;color:#666;">目前沒有預約紀錄</p>';
    section.style.display = 'block';
    return;
  }

  activeReservations.forEach(res => {
    const dateOnly = res.date.split('T')[0];
    const routeInfo = routeTimes[res.route] || { time: '', direction: '' };
    const routeDisplay = `${res.route} | ${routeInfo.time} ${routeInfo.direction}`;

    const card = document.createElement('div');
    card.className = 'reservation-card';
    card.innerHTML = `
      <div class="reservation-header">穿山甲專車預約</div>
      <div class="reservation-body">
        <div class="reservation-line">
          <span class="reservation-label">日期：</span>
          <span class="reservation-value">${dateOnly}</span>
        </div>
        <div class="reservation-line">
          <span class="reservation-label">班次：</span>
          <span class="reservation-value">${routeDisplay}</span>
        </div>
        <div class="reservation-line">
          <span class="reservation-label">姓名：</span>
          <span class="reservation-value">${res.name}</span>
        </div>
        <div class="reservation-line">
          <span class="reservation-label">電話：</span>
          <span class="reservation-value">${res.phone || ''}</span>
        </div>
        <div class="reservation-line">
          <span class="reservation-label">上車：</span>
          <span class="reservation-value">${res.fromStop}</span>
          <span style="margin-left:20px;"></span>
          <span class="reservation-label">下車：</span>
          <span class="reservation-value">${res.toStop}</span>
        </div>
        <button class="cancel-btn" onclick="cancelReservation('${res.id}')">❌ 取消預約</button>
      </div>
    `;
    section.appendChild(card);
  });

  section.style.display = 'block';
}

// === 取消預約 ===
async function cancelReservation(reservationId) {
  if (!confirm('確定要取消這筆預約嗎？')) return;

  try {
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'cancel',
        id: reservationId,
        userId: userData.userId
      })
    });

    const result = await res.json();
    if (result.status === 'success') {
      alert('✅ 已取消預約');
      await loadExistingReservations(); // 重新載入
    } else {
      alert('❌ 取消失敗：' + (result.message || '請稍後再試'));
    }
  } catch (e) {
    console.error('取消預約錯誤', e);
    alert('❌ 取消預約時發生錯誤');
  }
}

// === 載入預約資料 ===
async function loadExistingReservations() {
  try {
    const res = await fetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`);
    const result = await res.json();
    existingReservations = result.reservations || [];
    renderCurrentReservationCard();
  } catch (e) {
    console.error('載入預約失敗', e);
    existingReservations = [];
    renderCurrentReservationCard();
  }
}

// === LIFF 初始化 ===
async function init() {
  await liff.init({ liffId: "2006590746-KJodGOda" });
  if (!liff.isLoggedIn()) return liff.login();
  const profile = await liff.getProfile();
  const res = await fetch(`${WORKER_URL}?check=${profile.userId}`);
  const result = await res.json();
  if (!result.registered) return location.href = 'register.html';
  userData = result.user;

  document.getElementById('userInfo').innerHTML = `
    <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">穿山甲專車預約</div>
    <div class="user-name">${userData.name}</div>
    <div class="user-info"><strong>${userData.department} | ${userData.studentId}</strong></div>
  `;

  await loadExistingReservations();
}
window.addEventListener('load', init);

// === 📅 月曆功能 ===
function toggleCalendar() {
  const c = document.getElementById('calendarContainer');
  if (c.style.display === 'none') {
    c.style.display = 'block';
    document.getElementById('calendarBtn').textContent = '📅 關閉月曆';
  } else {
    c.style.display = 'none';
    document.getElementById('calendarBtn').textContent = '📅 打開月曆';
  }
}

function formatDateToLocal(date){
  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}
</script>
</body>
</html>
