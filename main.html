<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let selectedDate = null;
let selectedRoute = null;
let userData = null;
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let noServiceDates = {}; // 儲存真正停駛的日期
let existingReservations = []; // 儲存現有預約

const stopsOutbound = ["行政大樓","中餐廳","科技學院","學人會館","中城","下城","坪頂","愛蘭橋","大成國小","中山安七街口","榮民診所","埔里酒廠","埔里總站"];
const stopsReturn = ["埔里總站","埔里酒廠","榮民診所","中山安七街口","大成國小","愛蘭橋","坪頂","下城","中城","學人會館","科技學院","中餐廳","行政大樓"];

// 班次時間設定
const routeTimes = {
  'A1': { time: '22:00-22:30', direction: '暨大→埔里總站' },
  'B1': { time: '22:30-23:00', direction: '埔里總站→暨大' },
  'A2': { time: '23:00-23:30', direction: '暨大→埔里總站' },
  'B2': { time: '23:30-24:00', direction: '埔里總站→暨大' }
};

// === 日期工具函數 - 修正時區問題 ===
function formatDateToLocal(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function createLocalDate(year, month, day) {
  return new Date(year, month, day);
}

// === 初始化 ===
async function init() {
  try {
    console.log('開始初始化 LIFF...');
    
    await liff.init({ 
      liffId: "2006590746-KJodGOda" 
    });
    console.log('LIFF 初始化成功');

    if (!liff.isLoggedIn()) {
      console.log('使用者未登入，開始登入...');
      liff.login();
      return;
    }

    console.log('使用者已登入，取得使用者資料...');
    const profile = await liff.getProfile();
    console.log('取得使用者 Profile:', profile);

    // 檢查使用者是否已註冊
    console.log('檢查使用者註冊狀態...');
    const res = await fetch(`${WORKER_URL}?check=${profile.userId}`);
    const result = await res.json();
    console.log('註冊檢查結果:', result);
    
    if (!result.registered) {
      console.log('使用者未註冊，導向註冊頁面');
      window.location.href = 'register.html';
      return;
    }
    
    userData = result.user;
    console.log('使用者資料:', userData);
    
    // 顯示完整的使用者資訊
    document.getElementById('userInfo').innerHTML = `👤 ${userData.name}<br>🏫 ${userData.department}｜${userData.studentId}`;
    
    // 啟用月曆按鈕
    document.getElementById('calendarBtn').disabled = false;
    document.getElementById('calendarBtn').textContent = '📅 打開月曆';
    
    // 先載入月曆，不需要等待停駛日期
    await renderCalendar();
    
    // 非同步載入停駛日期和預約
    loadNoServiceDates().then(() => {
      console.log('停駛日期載入完成');
      // 重新渲染月曆以顯示停駛狀態
      renderCalendar();
    });
    
    loadExistingReservations();
    
    console.log('系統初始化完成');
    
  } catch (error) {
    console.error('初始化失敗:', error);
    
    document.getElementById('userInfo').innerHTML = 
      '<div class="notice error">❌ 系統發生錯誤，請重新整理頁面或稍後再試<br><small>錯誤: ' + error.message + '</small></div>';
    
    document.getElementById('calendarBtn').disabled = false;
    document.getElementById('calendarBtn').textContent = '📅 打開月曆（離線模式）';
    
    userData = {
      userId: 'offline-user',
      name: '測試使用者',
      department: '測試學系',
      studentId: '00000000',
      phone: '0900000000'
    };
    
    document.getElementById('userInfo').innerHTML = `👤 ${userData.name}<br>🏫 ${userData.department}｜${userData.studentId}<br><small style="color: #666;">離線模式</small>`;
    
    // 離線模式下直接渲染月曆
    renderCalendar();
  }
}

// 啟動初始化
init();

// === 載入現有預約 ===
async function loadExistingReservations() {
  try {
    console.log('載入現有預約...');
    const res = await fetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`);
    const result = await res.json();
    
    if (result.success && result.reservations) {
      existingReservations = result.reservations;
      console.log('現有預約:', existingReservations);
      renderExistingReservations();
    } else {
      console.log('沒有現有預約');
    }
  } catch (error) {
    console.error('載入預約失敗:', error);
  }
}

// === 顯示現有預約 ===
function renderExistingReservations() {
  const container = document.getElementById('reservationsList');
  const section = document.getElementById('existingReservations');
  
  if (existingReservations.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  container.innerHTML = '';
  
  // 過濾並排序預約，只顯示今天及未來的預約
  const today = formatDateToLocal(new Date());
  const futureReservations = existingReservations
    .filter(reservation => reservation.date >= today)
    .sort((a, b) => a.date.localeCompare(b.date));
  
  if (futureReservations.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  futureReservations.forEach(reservation => {
    const card = document.createElement('div');
    card.className = 'reservation-card';
    
    const routeInfo = routeTimes[reservation.route] || { 
      time: reservation.routeName || '', 
      direction: reservation.routeName ? reservation.routeName.split(' ')[1] || '' : '' 
    };
    
    // 修正：確保取消按鈕正確綁定
    const reservationId = reservation.id || reservation.reservationId;
    
    card.innerHTML = `
      <div class="reservation-header">
        <div class="reservation-date">${reservation.date}</div>
        <div class="reservation-route">${reservation.route}｜${routeInfo.direction}</div>
      </div>
      <div class="reservation-details">
        <div>⏰ ${routeInfo.time}</div>
        <div>📍 ${reservation.fromStop} → ${reservation.toStop}</div>
        <div>👤 ${reservation.name}｜${reservation.studentId}</div>
      </div>
      <button class="cancel-btn" onclick="cancelReservation('${reservationId}')">取消預約</button>
    `;
    
    container.appendChild(card);
  });
}

// === 取消預約 ===
async function cancelReservation(reservationId) {
  if (!confirm('確定要取消這個預約嗎？')) {
    return;
  }
  
  // 找到對應的取消按鈕
  const buttons = document.querySelectorAll('.cancel-btn');
  let btn = null;
  buttons.forEach(button => {
    if (button.getAttribute('onclick')?.includes(reservationId)) {
      btn = button;
    }
  });
  
  if (btn) {
    btn.disabled = true;
    btn.textContent = '取消中...';
  }
  
  try {
    const data = {
      type: 'cancel',
      reservationId: reservationId,
      userId: userData.userId
    };

    console.log('發送取消預約資料:', data);

    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    console.log('取消預約結果:', result);
    
    if(result.status === 'success'){
      // 重新載入預約列表
      await loadExistingReservations();
      document.getElementById('result').innerHTML = 
        `<div class="notice success">✅ 已成功取消預約</div>`;
        
      // 3秒後清除成功訊息
      setTimeout(() => {
        document.getElementById('result').innerHTML = '';
      }, 3000);
    } else {
      document.getElementById('result').innerHTML =
        `<div class="notice error">❌ 取消預約失敗：${result.message || '請稍後再試'}</div>`;
        
      if (btn) {
        btn.disabled = false;
        btn.textContent = '取消預約';
      }
    }
  } catch (error) {
    console.error('取消預約錯誤:', error);
    document.getElementById('result').innerHTML =
      `<div class="notice error">❌ 取消預約失敗，請檢查網路連線</div>`;
      
    if (btn) {
      btn.disabled = false;
      btn.textContent = '取消預約';
    }
  }
}

// === 載入真正停駛的日期 ===
async function loadNoServiceDates() {
  try {
    console.log('正在載入停駛日期，日曆ID:', CALENDAR_ID);
    
    const startDate = formatDateToLocal(new Date(currentYear, currentMonth - 1, 1));
    const endDate = formatDateToLocal(new Date(currentYear, currentMonth + 2, 0));
    
    console.log('查詢日期範圍:', startDate, '到', endDate);
    
    const requestData = {
      mode: 'calendar',
      start: startDate,
      end: endDate,
      calendarId: CALENDAR_ID
    };
    
    console.log('發送請求資料:', requestData);
    
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestData)
    });
    
    const result = await res.json();
    
    console.log('日曆API回傳完整結果:', JSON.stringify(result, null, 2));
    
    noServiceDates = {};
    
    if (result.success && result.holidays && Array.isArray(result.holidays)) {
      console.log('找到停駛日期數量:', result.holidays.length);
      result.holidays.forEach((dateObj, index) => {
        let dateStr = null;
        
        if (typeof dateObj === 'string') {
          dateStr = dateObj;
        } else if (dateObj && dateObj.date) {
          dateStr = dateObj.date;
        } else if (dateObj && dateObj.start) {
          dateStr = dateObj.start.split('T')[0];
        }
        
        if (dateStr && dateStr.length >= 10) {
          const formattedDate = dateStr.substring(0, 10);
          noServiceDates[formattedDate] = true;
          console.log(`停駛日期 ${index + 1}:`, formattedDate);
        }
      });
      console.log('已載入停駛日期:', Object.keys(noServiceDates));
    } else {
      console.warn('⚠️ 沒有找到停駛日期資料或API回傳失敗');
      noServiceDates = {};
    }
  } catch (error) {
    console.error('❌ 載入停駛日期失敗:', error);
    noServiceDates = {};
  }
}

// === 月曆功能 ===
async function toggleCalendar() {
  const c = document.getElementById('calendarContainer');
  if (c.style.display === 'none') {
    // 確保月曆已經渲染
    if (document.getElementById('calendar').innerHTML === '') {
      await renderCalendar();
    }
    c.style.display = 'block';
    document.getElementById('calendarBtn').textContent = '📅 關閉月曆';
  } else {
    c.style.display = 'none';
    document.getElementById('calendarBtn').textContent = '📅 打開月曆';
  }
}

async function changeMonth(direction) {
  currentMonth += direction;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  
  // 載入新月份的停駛日期
  await loadNoServiceDates();
  await renderCalendar();
}

async function renderCalendar() {
  console.log('開始渲染月曆:', currentYear, '年', currentMonth + 1, '月');
  
  const cal = document.getElementById('calendar');
  const title = document.getElementById('calendarTitle');
  
  const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
  title.textContent = `${currentYear}年 ${monthNames[currentMonth]}`;
  
  // 顯示載中狀態
  cal.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;">載入中...</div>';
  
  // 給一點時間顯示載入狀態
  await new Promise(resolve => setTimeout(resolve, 10));
  
  cal.innerHTML = '';
  
  const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
  weekdays.forEach(day => {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-header';
    dayElement.textContent = day;
    cal.appendChild(dayElement);
  });

  const today = new Date();
  const firstDay = createLocalDate(currentYear, currentMonth, 1);
  const lastDay = createLocalDate(currentYear, currentMonth + 1, 0);
  const startWeekday = firstDay.getDay();
  const totalDays = lastDay.getDate();

  console.log('月曆資訊:', {
    firstDay,
    lastDay,
    startWeekday,
    totalDays,
    noServiceDates
  });

  // 上個月的日期
  const prevMonthLastDay = createLocalDate(currentYear, currentMonth, 0).getDate();
  for (let i = startWeekday - 1; i >= 0; i--) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day other-month';
    dayElement.textContent = prevMonthLastDay - i;
    cal.appendChild(dayElement);
  }

  // 這個月的日期
  for (let d = 1; d <= totalDays; d++) {
    const date = createLocalDate(currentYear, currentMonth, d);
    const formatted = formatDateToLocal(date);
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    
    const todayFormatted = formatDateToLocal(today);
    if (formatted === todayFormatted) {
      dayElement.classList.add('today');
    }
    
    const isPast = date < today && formatted !== todayFormatted;
    const isNoService = noServiceDates[formatted];
    
    console.log(`日期 ${formatted}:`, { isPast, isNoService });
    
    if (isNoService || isPast) {
      dayElement.classList.add('no-service');
      if (isNoService) {
        dayElement.innerHTML = `${d}<br><small>停駛</small>`;
      } else if (isPast) {
        dayElement.innerHTML = `${d}<br><small>已過期</small>`;
      }
    } else {
      dayElement.textContent = d;
      dayElement.onclick = () => selectDate(formatted, d);
    }
    
    if (selectedDate === formatted) {
      dayElement.classList.add('selected');
    }
    
    cal.appendChild(dayElement);
  }

  // 下個月的日期
  const remainingCells = 42 - (startWeekday + totalDays);
  for (let d = 1; d <= remainingCells; d++) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day other-month';
    dayElement.textContent = d;
    cal.appendChild(dayElement);
  }
  
  console.log('月曆渲染完成');
}

async function selectDate(date, dayNumber) {
  console.log('選擇日期:', date, '對應的日曆數字:', dayNumber);
  
  const isNoService = noServiceDates[date];
  
  if (isNoService) {
    document.getElementById('holidayNotice').style.display = 'block';
    document.getElementById('holidayNotice').innerText = `🚫 ${date} 為停駛日，請選擇其他日期`;
    document.getElementById('selectedDate').style.display = 'none';
    selectedDate = null;
    
    document.getElementById('routeSection').style.display = 'none';
    return;
  }
  
  selectedDate = date;
  document.getElementById('calendarContainer').style.display = 'none';
  document.getElementById('selectedDate').innerHTML = `✅ 已選擇日期：${date} (${currentYear}年${currentMonth + 1}月${dayNumber}日)`;
  document.getElementById('selectedDate').style.display = 'block';
  document.getElementById('holidayNotice').style.display = 'none';
  document.getElementById('calendarBtn').textContent = '📅 打開月曆';
  
  document.getElementById('routeSection').style.display = 'block';
  loadSeatStatus();
}

// === 載入班次狀況 ===
function loadSeatStatus() {
  const container = document.getElementById('routeButtons');
  container.innerHTML = '';
  
  const routeData = {
    A1: { remain: 6, full: false },
    B1: { remain: 6, full: false },
    A2: { remain: 6, full: false },
    B2: { remain: 6, full: false }
  };
  
  ['A1', 'B1', 'A2', 'B2'].forEach(rid => {
    const r = routeData[rid];
    const routeInfo = routeTimes[rid];
    
    const div = document.createElement('div');
    div.className = `route-btn ${rid}`;
    if (r.full) div.classList.add('full');
    
    div.innerHTML = `
      <div class="route-content">
        <div class="route-time">${rid} ${routeInfo.time}</div>
        <div class="route-direction">${routeInfo.direction}</div>
        <div class="route-seats">剩餘:${r.remain}位</div>
      </div>
    `;
    
    if (!r.full) {
      div.onclick = () => selectRoute(div, rid, routeInfo.direction);
    }
    
    container.appendChild(div);
  });
}

function selectRoute(btn, id, direction) {
  selectedRoute = id;
  document.querySelectorAll('.route-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  updateStops(direction);
}

function updateStops(routeDirection) {
  const toStop = document.getElementById('toStop');
  toStop.innerHTML = '<option value="">請選擇下車站</option>';
  
  const isOutbound = routeDirection.includes('暨大→');
  const stops = isOutbound ? stopsOutbound : stopsReturn;
  const fromStop = isOutbound ? '行政大樓' : '埔里總站';
  
  stops.filter(s => s !== fromStop).forEach(s => {
    const o = document.createElement('option');
    o.value = s;
    o.textContent = s;
    toStop.appendChild(o);
  });
}

// === 預約功能 ===
async function submitForm() {
  const toStop = document.getElementById('toStop').value;
  const btn = document.getElementById('submitBtn');
  
  if (!selectedDate || !selectedRoute || !toStop) {
    alert('請完整選擇日期、班次與下車站');
    return;
  }
  
  btn.disabled = true;
  btn.classList.add('loading');

  try {
    const routeInfo = routeTimes[selectedRoute];
    // 修正：確保格式為 (A1|22:00-22:30 暨大->埔里總站)
    const routeName = `(${selectedRoute}|${routeInfo.time} ${routeInfo.direction.replace('→', '->')})`;
    
    const data = {
      type: 'reserve',
      userId: userData.userId,
      name: userData.name,
      studentId: userData.studentId,
      department: userData.department,
      phone: userData.phone,
      route: selectedRoute,
      routeName: routeName, // 使用修正後的格式
      fromStop: selectedRoute.includes('A') ? '行政大樓' : '埔里總站',
      toStop: toStop,
      date: selectedDate
    };

    console.log('發送預約資料:', data);

    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    
    if(result.status === 'success'){
      document.getElementById('result').innerHTML = 
        `<div class="notice success">
          ✅ 預約成功<br>
          ${selectedDate}｜${selectedRoute} ${routeInfo.time}<br>
          ${routeInfo.direction.split('→')[0]} → ${toStop}
        </div>`;
      
      // 清空選擇
      selectedDate = null;
      selectedRoute = null;
      document.getElementById('selectedDate').style.display = 'none';
      document.getElementById('routeSection').style.display = 'none';
      document.getElementById('toStop').innerHTML = '<option value="">請先選擇班次</option>';
      
      // 重新載入預約列表
      await loadExistingReservations();
      
    } else {
      document.getElementById('result').innerHTML =
        `<div class="notice error">❌ 預約失敗：${result.message || '請稍後再試'}</div>`;
    }
  } catch (error) {
    document.getElementById('result').innerHTML =
      `<div class="notice error">❌ 預約失敗，請檢查網路連線</div>`;
  } finally {
    btn.disabled = false;
    btn.classList.remove('loading');
  }
}
</script>
