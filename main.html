<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>穿山甲專車預約</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
    header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; }
    .card { background:#fff; margin:16px; border-radius:8px; padding:16px; box-shadow:0 0 5px rgba(0,0,0,0.1); }

    /* 按鈕 */
    input, select { width:100%; padding:10px; margin-top:8px; border-radius:6px; border:1px solid #ccc; font-size:16px; }
    button { width:100%; background:#3c8050; color:#fff; border:none; padding:12px; border-radius:6px; font-size:18px; font-weight:bold; margin-top:12px; cursor:pointer; position: relative; }
    button:disabled { background:#aaa; cursor:not-allowed; }
    button.loading { background:#2d6140; color: transparent; }
    button.loading::after {
      content: ''; position: absolute; width: 20px; height: 20px; top: 50%; left: 50%;
      margin: -10px 0 0 -10px; border: 2px solid #ffffff; border-radius: 50%;
      border-top-color: transparent; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* 提示 */
    .notice { padding:10px; margin-top:10px; border-radius:6px; }
    .notice.error { background:#fdecea; color:#b71c1c; border:1px solid #f5c2c7; }
    .notice.success { background:#e8f5e9; color:#2e7d32; border:1px solid #81c784; }

    /* 月曆 */
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap:4px; text-align:center; font-size:14px; }
    .calendar-header { padding:8px 0; font-weight:bold; background:#f0f0f0; border-radius:4px; }
    .calendar-day { padding:8px 0; border-radius:6px; background:#fff; border:1px solid #e0e0e0; cursor:pointer; min-height:40px; display:flex; flex-direction:column; justify-content:center; }
    .calendar-day:hover { background:#e8f5e9; }
    .calendar-day.holiday { background:#ffe6e6; color:#999; cursor:not-allowed; }
    .calendar-day.selected { background:#3c8050; color:#fff; font-weight:bold; }
    .calendar-day.other-month { color:#ccc; }
    .calendar-day.today { border:2px solid #3c8050; }

    /* 班次按鈕 - 修正版 */
    #routeButtons { display:flex; flex-wrap:wrap; gap:6px; justify-content:space-between; }
    .route-btn {
      flex:0 0 calc(40% - 6px); 
      padding:6px 4px; 
      border-radius:6px; 
      text-align:left;
      border:1px solid #ddd; 
      font-size:12px; 
      cursor:pointer; 
      transition:0.2s;
      min-height:70px; 
      display:flex; 
      align-items:center;
      background:#fff;
      color:#000; /* 預設黑色文字 */
    }
    
    /* 未選中時的邊框顏色 */
    .route-btn.A1, .route-btn.B1 { border-color:#4caf50; }
    .route-btn.A2, .route-btn.B2 { border-color:#4285f4; }
    
    /* 已滿的樣式 */
    .route-btn.full { 
      background:#f5f5f5; 
      color:#999; 
      border-color:#ccc; 
      cursor:not-allowed; 
    }
    
    /* 選中時的樣式 - 全部變白色文字 */
    .route-btn.selected { 
      color:#fff !important; /* 強制白色文字 */
    }
    .route-btn.selected.A1, .route-btn.selected.B1 { 
      background:#2e7d32; 
      border-color:#2e7d32;
    }
    .route-btn.selected.A2, .route-btn.selected.B2 { 
      background:#1a73e8; 
      border-color:#1a73e8;
    }

    /* 班次內容排版 */
    .route-content { 
      display: flex; 
      flex-direction: column; 
      gap: 2px; 
      width: 100%;
      padding: 0 4px;
    }
    .route-time { 
      font-weight: bold; 
      font-size: 12px; 
      line-height: 1.2;
    }
    .route-direction { 
      font-size: 11px; 
      line-height: 1.2;
      margin: 2px 0;
    }
    .route-seats { 
      font-size: 11px; 
      color: #666;
      line-height: 1.2;
    }

    /* 選中時所有文字變白色 */
    .route-btn.selected .route-time,
    .route-btn.selected .route-direction,
    .route-btn.selected .route-seats {
      color: #fff !important;
    }

    @media (max-width:480px){
      .route-btn {
        flex:0 0 calc(40% - 6px);
        min-height:65px;
        padding:4px 3px;
      }
      .route-content {
        padding: 0 3px;
      }
      .route-time { font-size: 16px; }
      .route-direction { font-size: 16px; }
      .route-seats { font-size: 16px; }
    }

    @media (max-width:360px){
      .route-btn {
        min-height:60px;
      }
      .route-time { font-size: 10px; }
      .route-direction { font-size: 9px; }
      .route-seats { font-size: 9px; }
    }
  </style>
</head>
<body>
  <header>🚌 穿山甲專車預約</header>

  <div class="card">
    <div id="userInfo" style="margin-bottom:15px;line-height:1.5;color:#2e7d32;font-weight:bold;">
      👤 觀光休閒與餐旅管理學系 | 114320553
    </div>

    <label><center>選擇搭乘日期</center></label>
    <button onclick="toggleCalendar()">📅 打開月曆</button>
    <div id="calendarContainer" style="display:none;margin-top:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <button onclick="changeMonth(-1)" style="width:auto; padding:5px 10px;">◀ 上個月</button>
        <h3 id="calendarTitle" style="margin:0;"></h3>
        <button onclick="changeMonth(1)" style="width:auto; padding:5px 10px;">下個月 ▶</button>
      </div>
      <div id="calendar" class="calendar"></div>
    </div>
    <div id="selectedDate" class="notice success" style="display:none;"></div>
    <div id="holidayNotice" class="notice error" style="display:none;"></div>

    <label>請選擇搭乘班次 *</label>
    <div id="routeButtons"></div>

    <label>下車站 *</label>
    <select id="toStop"><option value="">請先選擇班次</option></select>

    <button id="submitBtn" onclick="submitForm()">送出預約</button>
    <div id="result"></div>
  </div>

<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
let selectedDate = null;
let selectedRoute = null;
let userData = null;
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();

const stopsOutbound = ["行政大樓","中餐廳","科技學院","學人會館","中城","下城","坪頂","愛蘭橋","大成國小","中山安七街口","榮民診所","埔里酒廠","埔里總站"];
const stopsReturn = ["埔里總站","埔里酒廠","榮民診所","中山安七街口","大成國小","愛蘭橋","坪頂","下城","中城","學人會館","科技學院","中餐廳","行政大樓"];

// 班次時間設定
const routeTimes = {
  'A1': { time: '22:00-22:30', direction: '暨大→埔里總站' },
  'B1': { time: '22:30-23:00', direction: '埔里總站→暨大' },
  'A2': { time: '23:00-23:30', direction: '暨大→埔里總站' },
  'B2': { time: '23:30-24:00', direction: '埔里總站→暨大' }
};


// === 初始化 ===
(async function init(){
  // 模擬使用者資料
  userData = {
    name: '觀光休閒與餐旅管理學系',
    studentId: '114320553',
    userId: 'test123'
  };
  
  // 初始化班次顯示
  loadSeatStatus();
})();

// === 月曆功能 ===
async function toggleCalendar() {
  const c = document.getElementById('calendarContainer');
  if (c.style.display === 'none') {
    await renderCalendar();
    c.style.display = 'block';
  } else {
    c.style.display = 'none';
  }
}

async function changeMonth(direction) {
  currentMonth += direction;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  await renderCalendar();
}

async function renderCalendar() {
  const cal = document.getElementById('calendar');
  const title = document.getElementById('calendarTitle');
  
  // 設定標題
  const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
  title.textContent = `${currentYear}年 ${monthNames[currentMonth]}`;
  
  cal.innerHTML = '';
  
  // 加入星期標題
  const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
  weekdays.forEach(day => {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-header';
    dayElement.textContent = day;
    cal.appendChild(dayElement);
  });

  const today = new Date();
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const startWeekday = firstDay.getDay();
  const totalDays = lastDay.getDate();

  // 上個月的日期
  const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
  for (let i = startWeekday - 1; i >= 0; i--) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day other-month';
    dayElement.textContent = prevMonthLastDay - i;
    cal.appendChild(dayElement);
  }

  // 這個月的日期
  for (let d = 1; d <= totalDays; d++) {
    const date = new Date(currentYear, currentMonth, d);
    const formatted = date.toISOString().split('T')[0];
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    
    // 檢查是否為今天
    if (date.toDateString() === today.toDateString()) {
      dayElement.classList.add('today');
    }
    
    // 檢查是否為停駛日 (週六、週日)
    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
    
    // 檢查是否為過去日期
    const isPast = date < today && date.toDateString() !== today.toDateString();
    
    if (isWeekend || isPast) {
      dayElement.classList.add('holiday');
      if (isWeekend) {
        dayElement.innerHTML = `${d}<br><small>停駛</small>`;
      }
    } else {
      dayElement.textContent = d;
      dayElement.onclick = () => selectDate(formatted);
    }
    
    // 標記已選擇的日期
    if (selectedDate === formatted) {
      dayElement.classList.add('selected');
    }
    
    cal.appendChild(dayElement);
  }

  // 下個月的日期
  const remainingCells = 42 - (startWeekday + totalDays); // 6行x7列
  for (let d = 1; d <= remainingCells; d++) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day other-month';
    dayElement.textContent = d;
    cal.appendChild(dayElement);
  }
}

async function selectDate(date) {
  selectedDate = date;
  document.getElementById('calendarContainer').style.display = 'none';
  document.getElementById('selectedDate').innerHTML = '✅ 已選擇日期：' + date;
  document.getElementById('selectedDate').style.display = 'block';
  document.getElementById('holidayNotice').style.display = 'none';
  
  // 重新載入班次狀態
  loadSeatStatus();
}

// === 載入班次狀況 ===
function loadSeatStatus() {
  const container = document.getElementById('routeButtons');
  container.innerHTML = '';
  
  const routeData = {
    A1: { remain: 6, full: false },
    B1: { remain: 6, full: false },
    A2: { remain: 6, full: false },
    B2: { remain: 6, full: false }
  };
  
  ['A1', 'B1', 'A2', 'B2'].forEach(rid => {
    const r = routeData[rid];
    const routeInfo = routeTimes[rid];
    
    const div = document.createElement('div');
    div.className = `route-btn ${rid}`;
    if (r.full) div.classList.add('full');
    
    div.innerHTML = `
      <div class="route-content">
        <div class="route-time">${rid} ${routeInfo.time}</div>
        <div class="route-direction">${routeInfo.direction}</div>
        <div class="route-seats">剩餘:${r.remain}位</div>
      </div>
    `;
    
    if (!r.full) {
      div.onclick = () => selectRoute(div, rid, routeInfo.direction);
    }
    
    container.appendChild(div);
  });
}

function selectRoute(btn, id, direction) {
  selectedRoute = id;
  document.querySelectorAll('.route-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  updateStops(direction);
}

function updateStops(routeDirection) {
  const toStop = document.getElementById('toStop');
  toStop.innerHTML = '<option value="">請選擇下車站</option>';
  
  const isOutbound = routeDirection.includes('暨大→');
  const stops = isOutbound ? stopsOutbound : stopsReturn;
  const fromStop = isOutbound ? '行政大樓' : '埔里總站';
  
  stops.filter(s => s !== fromStop).forEach(s => {
    const o = document.createElement('option');
    o.value = s;
    o.textContent = s;
    toStop.appendChild(o);
  });
}

// === 預約功能 ===
async function submitForm() {
  const toStop = document.getElementById('toStop').value;
  const btn = document.getElementById('submitBtn');
  
  if (!selectedDate || !selectedRoute || !toStop) {
    alert('請完整選擇日期、班次與下車站');
    return;
  }
  
  btn.disabled = true;
  btn.classList.add('loading');

  // 模擬預約過程
  setTimeout(() => {
    btn.disabled = false;
    btn.classList.remove('loading');
    
    const routeInfo = routeTimes[selectedRoute];
    document.getElementById('result').innerHTML = 
      `<div class="notice success">
        ✅ 預約成功<br>
        ${selectedDate}｜${selectedRoute} ${routeInfo.time}<br>
        ${routeInfo.direction.split('→')[0]} → ${toStop}
      </div>`;
  }, 1000);
}
</script>
</body>
</html>
