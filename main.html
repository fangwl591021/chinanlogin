<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç©¿å±±ç”²å°ˆè»Šé ç´„</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
    header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; }
    .card { background:#fff; margin:16px; border-radius:8px; padding:16px; box-shadow:0 0 5px rgba(0,0,0,0.1); }

    /* æŒ‰éˆ• */
    input, select { width:100%; padding:10px; margin-top:8px; border-radius:6px; border:1px solid #ccc; font-size:16px; }
    button { width:100%; background:#3c8050; color:#fff; border:none; padding:12px; border-radius:6px; font-size:18px; font-weight:bold; margin-top:12px; cursor:pointer; position: relative; }
    button:disabled { background:#aaa; cursor:not-allowed; }
    button.loading { background:#2d6140; color: transparent; }
    button.loading::after {
      content: ''; position: absolute; width: 20px; height: 20px; top: 50%; left: 50%;
      margin: -10px 0 0 -10px; border: 2px solid #ffffff; border-radius:50%;
      border-top-color: transparent; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* æç¤º */
    .notice { padding:10px; margin-top:10px; border-radius:6px; }
    .notice.error { background:#fdecea; color:#b71c1c; border:1px solid #f5c2c7; }
    .notice.success { background:#e8f5e9; color:#2e7d32; border:1px solid #81c784; }

    /* æœˆæ›† */
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap:3px; text-align:center; font-size:13px; }
    .calendar-header { padding:6px 0; font-weight:bold; background:#f0f0f0; border-radius:3px; font-size:12px; }
    .calendar-day { padding:4px 0; border-radius:4px; background:#fff; border:1px solid #e0e0e0; cursor:pointer; min-height:30px; display:flex; flex-direction:column; justify-content:center; }
    .calendar-day:hover { background:#e8f5e9; }
    .calendar-day.no-service { background:#ffe6e6; color:#999; cursor:not-allowed; }
    .calendar-day.selected { background:#3c8050; color:#fff; font-weight:bold; }
    .calendar-day.other-month { color:#ccc; }
    .calendar-day.today { border:2px solid #3c8050; }
    .calendar-day small { font-size:9px; }

    /* ç­æ¬¡æŒ‰éˆ• */
    #routeButtons { display:flex; flex-wrap:wrap; gap:4px; justify-content:space-between; margin: 0 -2px; }
    .route-btn { flex: 0 0 calc(45% - 4px); margin: 0 1px; padding: 4px 2px; border-radius:6px; text-align:left; border:1px solid #ddd; font-size:12px; cursor:pointer; transition:0.2s; min-height:80px; display:flex; align-items:center; background:#fff; color:#000; box-sizing: border-box; }
    .route-btn.A1, .route-btn.B1 { border-color:#4caf50; }
    .route-btn.A2, .route-btn.B2 { border-color:#4285f4; }
    .route-btn.full { background:#f5f5f5; color:#999; border-color:#ccc; cursor:not-allowed; }
    .route-btn.selected { color:#fff !important; }
    .route-btn.selected.A1, .route-btn.selected.B1 { background:#2e7d32; border-color:#2e7d32; }
    .route-btn.selected.A2, .route-btn.selected.B2 { background:#1a73e8; border-color:#1a73e8; }
    .route-content { display: flex; flex-direction: column; gap: 2px; width: 90%; padding: 0 2px; }
    .route-time { font-weight: bold; font-size: 14px; line-height: 1.2; }
    .route-direction { font-size: 14px; line-height: 1.2; margin: 1px 0; }
    .route-seats { font-size: 14px; color: #666; line-height: 1.2; }
    .route-btn.selected .route-time, .route-btn.selected .route-direction, .route-btn.selected .route-seats { color: #fff !important; }

    .route-section { display: none; }
    .loading-state { text-align: center; padding: 20px; color: #666; }

    /* æ–°çš„é ç´„å¡ç‰‡æ¨£å¼ - ç°¡åŒ–ç‰ˆ */
    .reservation-card-simple { 
      background: #fff; 
      border-radius: 8px; 
      padding: 0; 
      margin: 16px 0; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
      border: 1px solid #e0e0e0; 
      overflow: hidden; 
    }
    .reservation-header-simple { 
      background: #3c8050; 
      color: white; 
      padding: 12px 15px; 
      font-weight: bold; 
      font-size: 18px; 
      text-align: center;
    }
    .reservation-body-simple { 
      padding: 20px 15px; 
      line-height: 1.6;
    }
    .reservation-detail-simple { 
      display: flex; 
      justify-content: space-between; 
      margin-bottom: 12px; 
      font-size: 16px; 
      color: #333;
      border-bottom: 1px solid #f0f0f0;
      padding-bottom: 8px;
    }
    .reservation-detail-simple:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .reservation-detail-label-simple { 
      font-weight: bold; 
      min-width: 80px; 
      color: #555;
    }
    .reservation-detail-value-simple { 
      flex: 1; 
      text-align: right; 
      color: #000;
    }
    .user-info-section {
      background: #e8f5e9;
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-weight: bold;
      color: #2e7d32;
    }
  </style>
</head>
<body>
  <header>ğŸšŒ ç©¿å±±ç”²å°ˆè»Šé ç´„</header>

  <div class="card">
    <!-- ä½¿ç”¨è€…è³‡è¨Š -->
    <div id="userInfo" class="user-info-section">
      <div class="loading-state">â³ ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
    </div>

    <!-- ç•¶å‰é ç´„å¡ç‰‡ - ç°¡åŒ–ç‰ˆ -->
    <div id="currentReservationCard" class="reservation-card-simple" style="display:none;">
      <div class="reservation-header-simple">ç©¿å±±ç”²å°ˆè»Šæ–°é ç´„</div>
      <div class="reservation-body-simple">
        <div class="reservation-detail-simple">
          <span class="reservation-detail-label-simple">æ—¥æœŸï¼š</span>
          <span class="reservation-detail-value-simple">2025/10/13 08:00:00</span>
        </div>
        <div class="reservation-detail-simple">
          <span class="reservation-detail-label-simple">ç­æ¬¡ï¼š</span>
          <span class="reservation-detail-value-simple">A1 | 22:00â€“22:30 æš¨å¤§ä¸€åŸ”é‡Œç¸½ç«™</span>
        </div>
        <div class="reservation-detail-simple">
          <span class="reservation-detail-label-simple">å§“åï¼š</span>
          <span class="reservation-detail-value-simple">åŠ‰å°å§</span>
        </div>
        <div class="reservation-detail-simple">
          <span class="reservation-detail-label-simple">é›»è©±ï¼š</span>
          <span class="reservation-detail-value-simple">0912345678</span>
        </div>
        <div class="reservation-detail-simple">
          <span class="reservation-detail-label-simple">ä¸Šè»Šï¼š</span>
          <span class="reservation-detail-value-simple">è¡Œæ”¿å¤§æ¨“</span>
        </div>
        <div class="reservation-detail-simple">
          <span class="reservation-detail-label-simple">ä¸‹è»Šï¼š</span>
          <span class="reservation-detail-value-simple">ä¸­å±±å®‰ä¸ƒè¡—å£</span>
        </div>
      </div>
    </div>

    <!-- é ç´„è¡¨å–®å€åŸŸ -->
    <div id="reservationFormSection">
      <label><center>é¸æ“‡æ­ä¹˜æ—¥æœŸ</center></label>
      <button id="calendarBtn" onclick="toggleCalendar()" disabled>ğŸ“… è¼‰å…¥ä¸­...</button>

      <div id="result" style="margin-top:10px;"></div>

      <div id="calendarContainer" style="display:none;margin-top:10px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <button onclick="changeMonth(-1)" style="width:auto; padding:5px 10px;">â—€ ä¸Šå€‹æœˆ</button>
          <h3 id="calendarTitle" style="margin:0; font-size:16px;"></h3>
          <button onclick="changeMonth(1)" style="width:auto; padding:5px 10px;">ä¸‹å€‹æœˆ â–¶</button>
        </div>
        <div id="calendar" class="calendar"></div>
      </div>
      <div id="selectedDate" class="notice success" style="display:none;"></div>
      <div id="holidayNotice" class="notice error" style="display:none;"></div>

      <div id="routeSection" class="route-section">
        <label>è«‹é¸æ“‡æ­ä¹˜ç­æ¬¡ *</label>
        <div id="routeButtons"></div>
        <label>ä¸‹è»Šç«™ *</label>
        <select id="toStop"><option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option></select>
        <button id="submitBtn" onclick="submitForm()">é€å‡ºé ç´„</button>
      </div>
    </div>
  </div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let selectedDate = null, selectedRoute = null;
let userData = null, noServiceDates = {};
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();

const stopsOutbound = ["è¡Œæ”¿å¤§æ¨“","ä¸­é¤å»³","ç§‘æŠ€å­¸é™¢","å­¸äººæœƒé¤¨","ä¸­åŸ","ä¸‹åŸ","åªé ‚","æ„›è˜­æ©‹","å¤§æˆåœ‹å°","ä¸­å±±å®‰ä¸ƒè¡—å£","æ¦®æ°‘è¨ºæ‰€","åŸ”é‡Œé…’å» ","åŸ”é‡Œç¸½ç«™"];
const stopsReturn = [...stopsOutbound].reverse();

const routeTimes = {
  'A1': { time: '22:00-22:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™' },
  'B1': { time: '22:30-23:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§' },
  'A2': { time: '23:00-23:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™' },
  'B2': { time: '23:30-24:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§' }
};

// ğŸ§­ åˆå§‹åŒ–
async function init() {
  try {
    await liff.init({ liffId: "2006590746-KJodGOda" });
    if (!liff.isLoggedIn()) return liff.login();
    const profile = await liff.getProfile();
    const res = await fetch(`${WORKER_URL}?check=${profile.userId}`);
    const result = await res.json();
    if (!result.registered) return window.location.href = 'register.html';
    userData = result.user;
    document.getElementById('userInfo').innerHTML = `ğŸ‘¤ ${userData.name}<br>ğŸ« ${userData.department}ï½œ${userData.studentId}`;
    
    // é¡¯ç¤ºç¤ºä¾‹é ç´„å¡ç‰‡
    showExampleReservationCard();
    
  } catch (e) {
    console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', e);
    userData = { userId: 'offline', name: 'æ¸¬è©¦ä½¿ç”¨è€…', department: 'æ¸¬è©¦å­¸ç³»', studentId: '00000000', phone: '0900000000' };
    document.getElementById('userInfo').innerHTML = `ğŸ‘¤ ${userData.name}<br>ğŸ« ${userData.department}ï½œ${userData.studentId}<br><small>é›¢ç·šæ¨¡å¼</small>`;
    showExampleReservationCard();
  } finally {
    await loadNoServiceDates();
    document.getElementById('calendarBtn').disabled = false;
    document.getElementById('calendarBtn').textContent = 'ğŸ“… æ‰“é–‹æœˆæ›†';
  }
}

// é¡¯ç¤ºç¤ºä¾‹é ç´„å¡ç‰‡
function showExampleReservationCard() {
  const card = document.getElementById('currentReservationCard');
  const userInfo = document.getElementById('userInfo');
  
  // æ›´æ–°ä½¿ç”¨è€…è³‡è¨Šç‚ºç¤ºä¾‹ä¸­çš„æ ¼å¼
  userInfo.innerHTML = `è§€å…‰ä¼‘é–’èˆ‡é¤æ—…ç®¡ç†å­¸ç³» | 114320553`;
  
  // é¡¯ç¤ºé ç´„å¡ç‰‡
  card.style.display = 'block';
}

window.addEventListener('load', init);

// ğŸ—“ è¼‰å…¥åœé§›
async function loadNoServiceDates() {
  try {
    const start = formatDateToLocal(new Date(currentYear, currentMonth - 1, 1));
    const end = formatDateToLocal(new Date(currentYear, currentMonth + 2, 0));
    const res = await fetch(`${WORKER_URL}?mode=calendar&start=${start}&end=${end}&calendarId=${encodeURIComponent(CALENDAR_ID)}`);
    const result = await res.json();
    noServiceDates = {};
    if (Array.isArray(result.holidays)) result.holidays.forEach(d => noServiceDates[d.substring(0,10)] = true);
  } catch (e) {
    console.error('ğŸš¨ è¼‰å…¥åœé§›æ—¥æœŸå¤±æ•—:', e);
    noServiceDates = {};
  }
}

// ğŸ“… æœˆæ›†
async function toggleCalendar() {
  const c = document.getElementById('calendarContainer');
  if (c.style.display === 'none') { 
    await renderCalendar(); 
    c.style.display = 'block'; 
    document.getElementById('calendarBtn').textContent = 'ğŸ“… é—œé–‰æœˆæ›†';
  } else { 
    c.style.display = 'none';
    document.getElementById('calendarBtn').textContent = 'ğŸ“… æ‰“é–‹æœˆæ›†';
  }
}

async function changeMonth(d) {
  currentMonth += d;
  if (currentMonth < 0) { currentMonth = 11; currentYear--; }
  else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  await loadNoServiceDates(); 
  await renderCalendar();
}

async function renderCalendar() {
  const cal = document.getElementById('calendar');
  const title = document.getElementById('calendarTitle');
  const monthNames = ['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
  title.textContent = `${currentYear}å¹´ ${monthNames[currentMonth]}`;
  
  cal.innerHTML = '';

  ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d=>{
    const h=document.createElement('div');h.className='calendar-header';h.textContent=d;cal.appendChild(h);
  });

  const today = new Date();
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const startWeekday = firstDay.getDay();
  const totalDays = lastDay.getDate();

  const prevLast = new Date(currentYear, currentMonth, 0).getDate();
  for (let i=startWeekday-1;i>=0;i--){
    const e=document.createElement('div');
    e.className='calendar-day other-month';
    e.textContent=prevLast - i;
    cal.appendChild(e);
  }

  for (let d=1; d<=totalDays; d++){
    const date = new Date(currentYear, currentMonth, d);
    const f = formatDateToLocal(date);
    const e=document.createElement('div');
    e.className='calendar-day';
    const todayStr=formatDateToLocal(today);
    if(f===todayStr) e.classList.add('today');
    const isPast=date<today && f!==todayStr;
    const isNo=noServiceDates[f];
    if(isNo||isPast){
      e.classList.add('no-service');
      e.innerHTML=`${d}<br><small>${isNo?'åœé§›':'å·²éæœŸ'}</small>`;
    } else {
      e.textContent=d;
      e.onclick=()=>selectDate(f);
    }
    if(selectedDate===f) e.classList.add('selected');
    cal.appendChild(e);
  }

  const remain=42-(startWeekday+totalDays);
  for(let d=1;d<=remain;d++){
    const e=document.createElement('div');
    e.className='calendar-day other-month';
    e.textContent=d;
    cal.appendChild(e);
  }
}

function formatDateToLocal(date){
  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

async function selectDate(date){
  if(noServiceDates[date]){
    document.getElementById('holidayNotice').style.display='block';
    document.getElementById('holidayNotice').innerText=`ğŸš« ${date} ç‚ºåœé§›æ—¥`;
    document.getElementById('selectedDate').style.display='none';
    selectedDate=null;
    document.getElementById('routeSection').style.display='none';
    return;
  }
  selectedDate=date;
  document.getElementById('calendarContainer').style.display='none';
  document.getElementById('selectedDate').innerHTML=`âœ… å·²é¸æ“‡æ—¥æœŸï¼š${date}`;
  document.getElementById('selectedDate').style.display='block';
  document.getElementById('holidayNotice').style.display='none';
  document.getElementById('routeSection').style.display='block';
  document.getElementById('calendarBtn').textContent = 'ğŸ“… æ‰“é–‹æœˆæ›†';
  loadSeatStatus();
}

// ğŸš ç­æ¬¡é¸æ“‡
function loadSeatStatus(){
  const c=document.getElementById('routeButtons'); c.innerHTML='';
  ['A1','B1','A2','B2'].forEach(rid=>{
    const info=routeTimes[rid];
    const div=document.createElement('div');
    div.className=`route-btn ${rid}`;
    div.innerHTML=`<div class="route-content">
      <div class="route-time">${rid} ${info.time}</div>
      <div class="route-direction">${info.direction}</div>
      <div class="route-seats">å‰©é¤˜:6ä½</div>
    </div>`;
    div.onclick=()=>selectRoute(div,rid,info.direction);
    c.appendChild(div);
  });
}

function selectRoute(btn,id,direction){
  selectedRoute=id;
  document.querySelectorAll('.route-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  updateStops(direction);
}

function updateStops(direction){
  const toStop=document.getElementById('toStop');
  toStop.innerHTML='<option value="">è«‹é¸æ“‡ä¸‹è»Šç«™</option>';
  const isOut=direction.includes('æš¨å¤§â†’');
  const stops=isOut?stopsOutbound:stopsReturn;
  const from=isOut?'è¡Œæ”¿å¤§æ¨“':'åŸ”é‡Œç¸½ç«™';
  stops.filter(s=>s!==from).forEach(s=>{
    const o=document.createElement('option');o.value=s;o.textContent=s;toStop.appendChild(o);
  });
}

// ğŸ“ é€å‡ºé ç´„
async function submitForm(){
  const toStop=document.getElementById('toStop').value;
  const btn=document.getElementById('submitBtn');
  if(!selectedDate||!selectedRoute||!toStop){alert('è«‹å®Œæ•´é¸æ“‡æ—¥æœŸã€ç­æ¬¡èˆ‡ä¸‹è»Šç«™');return;}
  btn.disabled=true;btn.classList.add('loading');
  try{
    const info=routeTimes[selectedRoute];
    const data={
      type:'reserve',userId:userData.userId,name:userData.name,studentId:userData.studentId,
      department:userData.department,phone:userData.phone||'',
      route:selectedRoute,routeName:`${selectedRoute}|${info.time} ${info.direction}`,
      fromStop:selectedRoute.includes('A')?'è¡Œæ”¿å¤§æ¨“':'åŸ”é‡Œç¸½ç«™',toStop:toStop,date:selectedDate
    };
    const res=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    const result=await res.json();
    if(result.status==='success'){
      document.getElementById('result').innerHTML=`<div class="notice success">âœ… é ç´„æˆåŠŸ<br>${selectedDate}ï½œ${selectedRoute} ${info.time}<br>${info.direction}</div>`;
      selectedDate=null;selectedRoute=null;
      document.getElementById('selectedDate').style.display='none';
      document.getElementById('routeSection').style.display='none';
      document.getElementById('toStop').innerHTML='<option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option>';
    }else{
      document.getElementById('result').innerHTML=`<div class="notice error">âŒ é ç´„å¤±æ•—ï¼š${result.message||'è«‹ç¨å¾Œå†è©¦'}</div>`;
    }
  }catch(e){
    console.error('é ç´„éŒ¯èª¤:',e);
    document.getElementById('result').innerHTML=`<div class="notice error">âŒ é ç´„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯</div>`;
  }finally{
    btn.disabled=false;btn.classList.remove('loading');
  }
}
</script>
</body>
</html>
