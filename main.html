<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç©¿å±±ç”²å°ˆè»Šé ç´„</title>
  <style>
    body { 
      font-family: system-ui, sans-serif; 
      background:#f5f6f7; 
      margin:0; 
      padding:0; 
    }
    header { 
      background:#3c8050; 
      color:#fff; 
      text-align:center; 
      padding:15px; 
      font-size:22px; 
      font-weight:bold; 
    }
    .card { 
      background:#fff; 
      margin:16px; 
      border-radius:8px; 
      padding:16px; 
      box-shadow:0 0 5px rgba(0,0,0,0.1); 
    }
    .user-section {
      text-align: center;
      margin-bottom: 20px;
    }
    .user-name {
      font-size: 18px;
      font-weight: bold;
      margin: 10px 0 5px 0;
    }
    .user-info {
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
    }
    .calendar-btn {
      width: 100%;
      background: #3c8050;
      color: white;
      border: none;
      padding: 15px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 20px 0;
    }
    .divider {
      height: 1px;
      background: #e0e0e0;
      margin: 20px 0;
    }
    .loading-state {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .error-state {
      text-align: center;
      padding: 20px;
      color: #d32f2f;
      background: #ffebee;
      border-radius: 8px;
      margin: 10px 0;
    }
    .retry-btn {
      background: #3c8050;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }

    /* æœˆæ›†æ¨£å¼ */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px;
      text-align: center;
      font-size: 13px;
      margin-bottom: 20px;
    }
    .calendar-header {
      padding: 8px 0;
      font-weight: bold;
      background: #f0f0f0;
      border-radius: 3px;
      font-size: 12px;
    }
    .calendar-day {
      padding: 8px 0;
      min-height: 45px;
      border-radius: 4px;
      background: #fff;
      border: 1px solid #e0e0e0;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: background 0.2s;
    }
    .calendar-day:hover { background:#eaf5ea; }
    .calendar-day.disabled { 
      background:#ffe6e6; 
      color:#999; 
      cursor:not-allowed; 
    }
    .calendar-day.past { 
      background:#f5f5f5; 
      color:#ccc; 
      cursor:not-allowed; 
    }
    .calendar-day.selected { background:#3c8050; color:#fff; font-weight:bold; }
    .calendar-day.other-month { color:#ccc; }

    /* é ç´„å¡ç‰‡æ¨£å¼ */
    .carousel-container {
      padding: 16px;
      margin: 20px 0;
    }
    .carousel-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
      text-align: center;
    }
    .carousel {
      display: flex;
      overflow-x: auto;
      gap: 15px;
      padding: 10px 0;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .carousel::-webkit-scrollbar {
      display: none;
    }
    .reservation-bubble {
      min-width: 240px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
      overflow: hidden;
      flex-shrink: 0;
    }
    .bubble-header {
      background: #27ACB2;
      color: white;
      padding: 12px 15px;
      font-weight: bold;
      font-size: 14px;
    }
    .bubble-body {
      padding: 12px;
    }
    .bubble-line {
      margin-bottom: 6px;
      font-size: 12px;
      line-height: 1.3;
    }
    .bubble-line:last-child {
      margin-bottom: 0;
    }
    .route-time {
      font-weight: bold;
      color: #333;
    }
    .bubble-footer {
      padding: 8px;
      border-top: 1px solid #f0f0f0;
      text-align: center;
    }
    .cancel-btn-small {
      background: none;
      border: none;
      color: #FF0000;
      font-size: 12px;
      cursor: pointer;
      padding: 5px 10px;
    }
    .cancel-btn-small:hover {
      background: #ffe6e6;
      border-radius: 4px;
    }

    /* ç­æ¬¡é¸æ“‡å€åŸŸ */
    .route-section {
      padding: 0 16px;
      margin: 20px 0;
      display: none;
    }
    .route-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 10px 0;
    }
    .route-btn {
      padding: 12px;
      border: 2px solid #3c8050;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    .route-btn:hover {
      background: #eaf5ea;
    }
    .route-btn.selected {
      background: #3c8050;
      color: white;
    }
    .stop-selector {
      padding: 0 16px;
      margin: 20px 0;
      display: none;
    }
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      margin-top: 8px;
    }
    .submit-btn {
      background: #3c8050;
      color: white;
      border: none;
      padding: 15px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 20px 16px;
      width: calc(100% - 32px);
      display: none;
    }
  </style>
</head>
<body>
  <header>ç©¿å±±ç”²å°ˆè»Šé ç´„</header>

  <div class="card">
    <!-- ä½¿ç”¨è€…è³‡è¨Š -->
    <div id="userInfo" class="user-section">
      <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">ç©¿å±±ç”²å°ˆè»Šé ç´„</div>
      <div id="userContent" class="loading-state">â³ ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
    </div>

    <div class="divider"></div>

    <!-- éŒ¯èª¤ç‹€æ…‹é¡¯ç¤º -->
    <div id="errorState" class="error-state" style="display: none;">
      <div>ç³»çµ±è¼‰å…¥å¤±æ•—</div>
      <button class="retry-btn" onclick="retryInitialization()">é‡æ–°è¼‰å…¥</button>
    </div>

    <!-- æœˆæ›†æŒ‰éˆ• -->
    <button id="calendarBtn" class="calendar-btn" onclick="toggleCalendar()">ğŸ“… æ‰“é–‹æœˆæ›†</button>

    <!-- æœˆæ›†å®¹å™¨ -->
    <div id="calendarContainer" style="display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <button onclick="changeMonth(-1)" style="width:auto; padding:5px 10px;">â—€ ä¸Šå€‹æœˆ</button>
        <h3 id="calendarTitle" style="margin:0; font-size:16px;"></h3>
        <button onclick="changeMonth(1)" style="width:auto; padding:5px 10px;">ä¸‹å€‹æœˆ â–¶</button>
      </div>
      <div id="calendar" class="calendar"></div>
    </div>

    <!-- ç­æ¬¡é¸æ“‡å€åŸŸ -->
    <div id="routeSection" class="route-section">
      <h3>è«‹é¸æ“‡æ­ä¹˜ç­æ¬¡</h3>
      <div id="routeButtons" class="route-buttons"></div>
    </div>

    <!-- è»Šç«™é¸æ“‡å€åŸŸ -->
    <div id="stopSection" class="stop-selector">
      <h3>è«‹é¸æ“‡ä¸‹è»Šç«™</h3>
      <select id="toStop">
        <option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option>
      </select>
    </div>

    <!-- é€å‡ºæŒ‰éˆ• -->
    <button id="submitBtn" class="submit-btn" onclick="submitReservation()">é€å‡ºé ç´„</button>

    <!-- é ç´„å¡ç‰‡ -->
    <div id="currentReservationCard"></div>
  </div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
// åŸºæœ¬é…ç½®
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';

// å…¨åŸŸè®Šæ•¸
let selectedDate = null;
let selectedRoute = null;
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let userData = null;
let existingReservations = [];
let noServiceDates = {};

// è·¯ç·šè³‡æ–™
const routeTimes = {
  'A1': { time: '22:00-22:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™' },
  'B1': { time: '22:30-23:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§' },
  'A2': { time: '23:00-23:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™' },
  'B2': { time: '23:30-24:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§' }
};

const stopsOutbound = ["è¡Œæ”¿å¤§æ¨“","ä¸­é¤å»³","ç§‘æŠ€å­¸é™¢","å­¸äººæœƒé¤¨","ä¸­åŸ","ä¸‹åŸ","åªé ‚","æ„›è˜­æ©‹","å¤§æˆåœ‹å°","ä¸­å±±å®‰ä¸ƒè¡—å£","æ¦®æ°‘è¨ºæ‰€","åŸ”é‡Œé…’å» ","åŸ”é‡Œç¸½ç«™"];
const stopsReturn = [...stopsOutbound].reverse();

// åˆå§‹åŒ–å‡½æ•¸
async function initializeApp() {
  try {
    console.log('é–‹å§‹åˆå§‹åŒ–æ‡‰ç”¨...');
    
    // å…ˆé¡¯ç¤ºåŸºæœ¬ä½¿ç”¨è€…ä»‹é¢
    showBasicUI();
    
    // å˜—è©¦åˆå§‹åŒ– LIFF
    await initializeLiff();
    
    console.log('æ‡‰ç”¨åˆå§‹åŒ–å®Œæˆ');
    
  } catch (error) {
    console.error('åˆå§‹åŒ–å¤±æ•—:', error);
    showErrorState('ç³»çµ±åˆå§‹åŒ–å¤±æ•—: ' + error.message);
  }
}

// é¡¯ç¤ºåŸºæœ¬UI
function showBasicUI() {
  const userContent = document.getElementById('userContent');
  userContent.innerHTML = `
    <div class="user-name">æ–¹è¬éš†</div>
    <div class="user-info"><strong>è§€å…‰ä¼‘é–’èˆ‡é¤æ—…ç®¡ç†å­¸ç³» | 114320553</strong></div>
  `;
  
  // å•Ÿç”¨æœˆæ›†æŒ‰éˆ•
  document.getElementById('calendarBtn').disabled = false;
}

// é¡¯ç¤ºéŒ¯èª¤ç‹€æ…‹
function showErrorState(message) {
  document.getElementById('errorState').style.display = 'block';
  document.getElementById('errorState').innerHTML = `
    <div>${message}</div>
    <button class="retry-btn" onclick="retryInitialization()">é‡æ–°è¼‰å…¥</button>
  `;
}

// é‡æ–°åˆå§‹åŒ–
function retryInitialization() {
  document.getElementById('errorState').style.display = 'none';
  initializeApp();
}

// LIFF åˆå§‹åŒ–
async function initializeLiff() {
  try {
    await liff.init({ liffId: "2006590746-KJodGOda" });
    
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    
    const profile = await liff.getProfile();
    await checkUserRegistration(profile.userId);
    
  } catch (error) {
    console.warn('LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œä½¿ç”¨é›¢ç·šæ¨¡å¼:', error);
    // ä½¿ç”¨é›¢ç·šæ¨¡å¼
    userData = {
      userId: 'offline',
      name: 'æ–¹è¬éš†',
      department: 'è§€å…‰ä¼‘é–’èˆ‡é¤æ—…ç®¡ç†å­¸ç³»',
      studentId: '114320553',
      phone: '927136847'
    };
    await loadExistingReservations();
  }
}

// æª¢æŸ¥ç”¨æˆ¶è¨»å†Š
async function checkUserRegistration(userId) {
  try {
    const response = await fetch(`${WORKER_URL}?check=${userId}`);
    const result = await response.json();
    
    if (!result.registered) {
      window.location.href = 'register.html';
      return;
    }
    
    userData = result.user;
    await loadExistingReservations();
    
  } catch (error) {
    console.warn('æª¢æŸ¥ç”¨æˆ¶è¨»å†Šå¤±æ•—:', error);
    throw new Error('ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨');
  }
}

// è¼‰å…¥é ç´„è¨˜éŒ„
async function loadExistingReservations() {
  try {
    if (!userData?.userId) return;
    
    const response = await fetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`);
    const result = await response.json();
    
    existingReservations = result.reservations || [];
    renderCurrentReservationCard();
    
  } catch (error) {
    console.warn('è¼‰å…¥é ç´„è¨˜éŒ„å¤±æ•—:', error);
    existingReservations = [];
    renderCurrentReservationCard();
  }
}

// æœˆæ›†ç›¸é—œå‡½æ•¸
async function toggleCalendar() {
  const container = document.getElementById('calendarContainer');
  const btn = document.getElementById('calendarBtn');

  if (container.style.display === 'none') {
    await loadNoServiceDates();
    renderCalendar();
    container.style.display = 'block';
    btn.textContent = 'ğŸ“… é—œé–‰æœˆæ›†';
  } else {
    container.style.display = 'none';
    btn.textContent = 'ğŸ“… æ‰“é–‹æœˆæ›†';
  }
}

async function loadNoServiceDates() {
  try {
    const start = formatDateToLocal(new Date(currentYear, currentMonth - 1, 1));
    const end = formatDateToLocal(new Date(currentYear, currentMonth + 2, 0));
    const res = await fetch(`${WORKER_URL}?mode=calendar&start=${start}&end=${end}&calendarId=${encodeURIComponent(CALENDAR_ID)}`);
    const result = await res.json();
    noServiceDates = {};
    if (Array.isArray(result.holidays)) {
      result.holidays.forEach(d => noServiceDates[d.substring(0,10)] = true);
    }
  } catch (e) {
    console.error('è¼‰å…¥åœé§›æ—¥æœŸå¤±æ•—:', e);
    noServiceDates = {};
  }
}

function renderCalendar() {
  const calendar = document.getElementById('calendar');
  calendar.innerHTML = '';
  
  // æ·»åŠ æ˜ŸæœŸæ¨™é¡Œ
  const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  weekdays.forEach(day => {
    const header = document.createElement('div');
    header.className = 'calendar-header';
    header.textContent = day;
    calendar.appendChild(header);
  });

  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
  document.getElementById('calendarTitle').textContent = `${currentYear}å¹´ ${monthNames[currentMonth]}`;

  const startDay = firstDay.getDay();
  const daysInMonth = lastDay.getDate();
  const today = new Date();
  const todayStr = formatDateToLocal(today);

  // ä¸Šå€‹æœˆçš„æ—¥æœŸ
  const prevLastDay = new Date(currentYear, currentMonth, 0).getDate();
  for (let i = startDay - 1; i >= 0; i--) {
    const empty = document.createElement('div');
    empty.className = 'calendar-day other-month';
    empty.textContent = prevLastDay - i;
    calendar.appendChild(empty);
  }

  // é€™å€‹æœˆçš„æ—¥æœŸ
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(currentYear, currentMonth, day);
    const dateStr = formatDateToLocal(date);
    const div = document.createElement('div');
    div.className = 'calendar-day';
    
    const isPast = date < today && dateStr !== todayStr;
    const isNoService = noServiceDates[dateStr];
    
    if (isPast) {
      div.classList.add('past');
      div.innerHTML = `${day}<br><small>å·²éæœŸ</small>`;
    } else if (isNoService) {
      div.classList.add('disabled');
      div.innerHTML = `${day}<br><small>åœé§›</small>`;
    } else {
      div.textContent = day;
      div.onclick = () => selectDate(dateStr);
    }
    
    if (dateStr === todayStr) {
      div.style.border = '2px solid #3c8050';
    }
    
    if (selectedDate === dateStr) {
      div.classList.add('selected');
    }
    
    calendar.appendChild(div);
  }

  // ä¸‹å€‹æœˆçš„æ—¥æœŸ
  const totalCells = 42;
  const remaining = totalCells - (startDay + daysInMonth);
  for (let day = 1; day <= remaining; day++) {
    const empty = document.createElement('div');
    empty.className = 'calendar-day other-month';
    empty.textContent = day;
    calendar.appendChild(empty);
  }
}

function changeMonth(delta) {
  currentMonth += delta;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  renderCalendar();
}

function selectDate(dateStr) {
  if (noServiceDates[dateStr]) {
    alert(`ğŸš« ${dateStr} ç‚ºåœé§›æ—¥ï¼Œç„¡æ³•é ç´„`);
    return;
  }
  
  const selected = new Date(dateStr);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  if (selected < today) {
    alert(`ğŸš« ${dateStr} ç‚ºéå»æ—¥æœŸï¼Œç„¡æ³•é ç´„`);
    return;
  }
  
  selectedDate = dateStr;
  renderCalendar(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é¸ä¸­ç‹€æ…‹
  
  document.getElementById('calendarContainer').style.display = 'none';
  document.getElementById('calendarBtn').textContent = 'ğŸ“… æ‰“é–‹æœˆæ›†';
  
  showRouteSelection();
}

function showRouteSelection() {
  const routeSection = document.getElementById('routeSection');
  const routeButtons = document.getElementById('routeButtons');
  
  routeButtons.innerHTML = '';
  
  Object.entries(routeTimes).forEach(([routeId, info]) => {
    const button = document.createElement('div');
    button.className = 'route-btn';
    button.innerHTML = `
      <div class="route-time">${routeId} ${info.time}</div>
      <div class="route-direction">${info.direction}</div>
    `;
    button.onclick = () => selectRoute(routeId, info.direction);
    routeButtons.appendChild(button);
  });
  
  routeSection.style.display = 'block';
}

function selectRoute(routeId, direction) {
  selectedRoute = routeId;
  document.querySelectorAll('.route-btn').forEach(btn => btn.classList.remove('selected'));
  event.target.classList.add('selected');
  showStopSelection(direction);
}

function showStopSelection(direction) {
  const stopSection = document.getElementById('stopSection');
  const toStopSelect = document.getElementById('toStop');
  
  toStopSelect.innerHTML = '<option value="">è«‹é¸æ“‡ä¸‹è»Šç«™</option>';
  
  const isOutbound = direction.includes('æš¨å¤§â†’');
  const stops = isOutbound ? stopsOutbound : stopsReturn;
  const fromStop = isOutbound ? 'è¡Œæ”¿å¤§æ¨“' : 'åŸ”é‡Œç¸½ç«™';
  
  stops.filter(stop => stop !== fromStop).forEach(stop => {
    const option = document.createElement('option');
    option.value = stop;
    option.textContent = stop;
    toStopSelect.appendChild(option);
  });
  
  stopSection.style.display = 'block';
  document.getElementById('submitBtn').style.display = 'block';
}

async function submitReservation() {
  const toStop = document.getElementById('toStop').value;
  const submitBtn = document.getElementById('submitBtn');
  
  if (!selectedDate || !selectedRoute || !toStop) {
    alert('è«‹å®Œæ•´é¸æ“‡æ—¥æœŸã€ç­æ¬¡èˆ‡ä¸‹è»Šç«™');
    return;
  }
  
  try {
    submitBtn.disabled = true;
    submitBtn.textContent = 'é ç´„ä¸­...';
    
    const info = routeTimes[selectedRoute];
    const fromStop = selectedRoute.includes('A') ? 'è¡Œæ”¿å¤§æ¨“' : 'åŸ”é‡Œç¸½ç«™';
    
    const data = {
      type: 'reserve',
      userId: userData.userId,
      name: userData.name,
      studentId: userData.studentId,
      department: userData.department,
      phone: userData.phone || '',
      route: selectedRoute,
      routeName: `${selectedRoute} | ${info.time} ${info.direction}`,
      fromStop: fromStop,
      toStop: toStop,
      date: selectedDate
    };
    
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await res.json();

    if (result.status === 'success') {
      alert('âœ… é ç´„æˆåŠŸï¼');

      // âœ… æ–°å¢é€™æ®µ â†’ Flex Bubble ç¾¤çµ„é€šçŸ¥
      await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'pushLine',
          title: 'âœ… é ç´„æˆåŠŸé€šçŸ¥',
          name: userData.name,
          date: selectedDate,
          route: `${selectedRoute} | ${routeTimes[selectedRoute].time} ${routeTimes[selectedRoute].direction}`,
          fromStop: selectedRoute.includes('A') ? 'è¡Œæ”¿å¤§æ¨“' : 'åŸ”é‡Œç¸½ç«™',
          toStop: toStop
        })
      });

      resetReservationForm();
      await loadExistingReservations();
    } else {
      alert('âŒ é ç´„å¤±æ•—ï¼š' + (result.message || 'è«‹ç¨å¾Œå†è©¦'));
    }
    
  } catch (error) {
    console.error('é ç´„éŒ¯èª¤:', error);
    alert('âŒ é ç´„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'é€å‡ºé ç´„';
  }
}

function resetReservationForm() {
  document.getElementById('routeSection').style.display = 'none';
  document.getElementById('stopSection').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
  selectedDate = null;
  selectedRoute = null;
  document.getElementById('toStop').innerHTML = '<option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option>';
  document.querySelectorAll('.route-btn').forEach(btn => btn.classList.remove('selected'));
  document.querySelectorAll('.calendar-day').forEach(day => day.classList.remove('selected'));
}

function renderCurrentReservationCard() {
  const section = document.getElementById('currentReservationCard');
  section.innerHTML = '';

  const today = formatDateToLocal(new Date());
  const activeReservations = existingReservations
    .filter(res => res.date >= today && res.status !== 'å·²å–æ¶ˆ')
    .sort((a, b) => a.date.localeCompare(b.date));

  if (activeReservations.length === 0) {
    section.innerHTML = `
      <div class="no-reservation">
        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“­</div>
        <div style="font-size: 16px; color: #666;">ç›®å‰æ²’æœ‰é ç´„ç´€éŒ„</div>
      </div>
    `;
    return;
  }

  const carouselContainer = document.createElement('div');
  carouselContainer.className = 'carousel-container';
  
  const carouselTitle = document.createElement('div');
  carouselTitle.className = 'carousel-title';
  carouselTitle.textContent = `æˆ‘çš„é ç´„ (${activeReservations.length} ç­†)`;
  carouselContainer.appendChild(carouselTitle);
  
  const carousel = document.createElement('div');
  carousel.className = 'carousel';
  
  activeReservations.forEach(reservation => {
    const dateOnly = reservation.date.split('T')[0];
    const routeInfo = routeTimes[reservation.route] || { time: '', direction: '' };
    
    const bubble = document.createElement('div');
    bubble.className = 'reservation-bubble';
    bubble.innerHTML = `
      <div class="bubble-header">æ—¥æœŸ: ${dateOnly}</div>
      <div class="bubble-body">
        <div class="bubble-line route-time">${reservation.route} | ${routeInfo.time}</div>
        <div class="bubble-line">${routeInfo.direction}</div>
        <div class="bubble-line">å§“å: ${reservation.name}</div>
        <div class="bubble-line">ä¸Šè»Š: ${reservation.fromStop}</div>
        <div class="bubble-line">ä¸‹è»Š: ${reservation.toStop}</div>
      </div>
      <div class="bubble-footer">
        <button class="cancel-btn-small" onclick="cancelReservation('${reservation.id}')">âŒ å–æ¶ˆé ç´„</button>
      </div>
    `;
    carousel.appendChild(bubble);
  });
  
  carouselContainer.appendChild(carousel);
  section.appendChild(carouselContainer);
}

async function cancelReservation(reservationId) {
  if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†é ç´„å—ï¼Ÿ')) return;

  try {
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type: 'cancel', id: reservationId, userId: userData.userId })
    });

    const result = await res.json();
    if (result.status === 'success') {
      alert('âœ… å·²å–æ¶ˆé ç´„');
      await loadExistingReservations();
    } else {
      alert('âŒ å–æ¶ˆå¤±æ•—ï¼š' + (result.message || 'è«‹ç¨å¾Œå†è©¦'));
    }
  } catch (e) {
    console.error('å–æ¶ˆé ç´„éŒ¯èª¤', e);
    alert('âŒ å–æ¶ˆé ç´„æ™‚ç™¼ç”ŸéŒ¯èª¤');
  }
}

function formatDateToLocal(date){
  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

// å•Ÿå‹•æ‡‰ç”¨
window.addEventListener('load', initializeApp);
</script>
</body>
</html>
