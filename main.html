<script>
const WORKER_URL='https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID='86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
const CACHE_DURATION=5*60*1000;
let selectedDate=null,selectedRoute=null,currentMonth=new Date().getMonth(),currentYear=new Date().getFullYear();
let userData=null,existingReservations=[],noServiceDates={};
const stopsOutbound=["行政大樓","中餐廳","科技學院","學人會館","中城","下城","坪頂","愛蘭橋","大成國小","中山安七街口","榮民診所","埔里酒廠","埔里總站"];
const stopsReturn=[...stopsOutbound].reverse();
const routeTimes={'A1':{time:'22:00-22:30',direction:'暨大→埔里總站'},'B1':{time:'22:30-23:00',direction:'埔里總站→暨大'},'A2':{time:'23:00-23:30',direction:'暨大→埔里總站'},'B2':{time:'23:30-24:00',direction:'埔里總站→暨大'}};

// 快取管理
const cache={
  get(key){
    const item=localStorage.getItem(key);
    if(!item)return null;
    try{
      const data=JSON.parse(item);
      if(Date.now()-data.timestamp>CACHE_DURATION)return null;
      return data.value;
    }catch{return null;}
  },
  set(key,value){
    localStorage.setItem(key,JSON.stringify({value,timestamp:Date.now()}));
  }
};

// 初始化 - 優化版
async function init(){
  try{
    const cachedUser=cache.get('pangolinUser');
    if(cachedUser){
      userData=cachedUser;
      renderUser(userData);
      loadExistingReservations();
    }
    
    await liff.init({liffId:"2006590746-KJodGOda"});
    if(!liff.isLoggedIn())return liff.login();
    
    const profile=await liff.getProfile();
    
    // 並行請求優化
    const [userCheck,reservations]=await Promise.allSettled([
      fetch(`${WORKER_URL}?check=${profile.userId}`).then(r=>r.json()),
      cachedUser?fetch(`${WORKER_URL}?mode=reservations&userId=${profile.userId}`).then(r=>r.json()):null
    ]);
    
    if(userCheck.status==='fulfilled'){
      const result=userCheck.value;

      // ✅【新增：兼容 result.data 格式】
      const payload = result.data || result;

      if(!payload.registered)return location.href='register.html';
      userData=payload.user;
      cache.set('pangolinUser',userData);
      renderUser(userData);
    }
    
    if(reservations.status==='fulfilled'&&reservations.value){
      existingReservations=reservations.value.reservations||[];
      cache.set('pangolinReservations',existingReservations);
      renderCurrentReservationCard();
    }else if(!cachedUser){
      await loadExistingReservations();
    }
  }catch(e){
    console.error("登入錯誤",e);
    document.getElementById('userInfo').innerHTML=`<div class='notice error'>登入失敗，請重新載入</div>`;
  }
}
</script>
