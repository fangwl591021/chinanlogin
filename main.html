<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>穿山甲專車預約 Pangolin Shuttle Reservation</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
    header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; line-height:1.3; }
    .en-text { display:block; font-size:14px; color:#ffffff; margin-top:2px; }
    .en-text-dark { display:block; font-size:14px; color:#666666; margin-top:2px; }
    button { cursor:pointer; }
  </style>
</head>
<body>
  <header>
    穿山甲專車預約
    <span class="en-text">Pangolin Shuttle Reservation</span>
  </header>

  <div id="userInfo" style="padding:20px; text-align:center;">
    ⏳ 系統初始化中...<br><span class="en-text-dark">System initializing...</span>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
  const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';

  let RESERVATION_RULES = {
    seatLimit: 7,
    maxPerDay: 1,
    dailyDeadline: '19:00',
    maxDaysAhead: 7
  };

  // ✅ 安全強化版 fetch
  async function robustFetch(url, options = {}, retries = 3) {
    for (let i = 0; i < retries; i++) {
      try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const contentType = res.headers.get('content-type') || '';
        if (contentType.includes('application/json')) return await res.json();
        console.warn('⚠️ 非 JSON 回應');
        return { status: 'error', message: '非 JSON 回應' };
      } catch (err) {
        console.warn(`第 ${i + 1} 次請求失敗: ${err.message}`);
        if (i === retries - 1) return { status: 'error', message: err.message };
        await new Promise(r => setTimeout(r, 1000 * (i + 1)));
      }
    }
  }

  // ✅ 規則載入（404 不中斷）
  async function loadRules() {
    try {
      const response = await fetch('rules.json');
      if (!response.ok) throw new Error('規則檔案載入失敗');
      const json = await response.json();
      RESERVATION_RULES = { ...RESERVATION_RULES, ...json };
      console.log('✅ 規則載入成功');
    } catch (err) {
      console.warn('⚠️ 規則載入失敗，使用預設值:', err.message);
    }
  }

  // ✅ 初始化主流程（加強容錯）
  async function init() {
    const userDiv = document.getElementById('userInfo');
    try {
      console.log('🚀 系統初始化開始');

      await loadRules();

      if (typeof liff === 'undefined') throw new Error('LIFF SDK 未加載');
      await liff.init({ liffId: "2006590746-KJodGOda" });

      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      console.log('👤 LIFF 用戶:', profile);

      const checkRes = await robustFetch(`${WORKER_URL}?mode=check&userId=${profile.userId}`);
      console.log('🔍 Worker 回應:', checkRes);

      let userData;
      if (!checkRes || checkRes.status === 'error' || !checkRes.user) {
        console.warn('⚠️ Worker 無法回傳用戶資料，使用預設');
        userData = {
          userId: profile.userId || 'local-test-user',
          name: profile.displayName || '測試用戶',
          studentId: '000000',
          department: '資訊管理學系',
          phone: '0912345678'
        };
      } else {
        userData = checkRes.user;
      }

      userDiv.innerHTML = `
        <div style="font-size:18px; font-weight:bold;">${userData.name}</div>
        <div style="font-size:14px; color:#666;">
          ${userData.department || '未知科系'}｜${userData.studentId || '未知學號'}
        </div>
        <div style="margin-top:8px; color:#3c8050;">✅ 系統初始化完成</div>
      `;
      console.log('✅ 初始化完成');
    } catch (error) {
      console.error('💥 初始化錯誤:', error);
      userDiv.innerHTML = `
        <div style="color:red;">
          <p>❌ 系統初始化失敗（可重試）</p>
          <p>${error.message}</p>
          <button onclick="init()" style="background:#3c8050;color:white;padding:10px 16px;border:none;border-radius:6px;">重新嘗試初始化</button>
          <br><br>
          <button onclick="location.href='register.html'" style="background:#ff9800;color:white;padding:10px 16px;border:none;border-radius:6px;">重新註冊</button>
        </div>
      `;
    }
  }

  window.addEventListener('load', init);
  </script>
</body>
</html>
