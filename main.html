<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ç©¿å±±ç”²å°ˆè»Šé ç´„ ğŸš</title>
<style>
body{font-family:system-ui,sans-serif;background:#f5f6f7;margin:0;padding:0;-webkit-font-smoothing:antialiased}
header{background:#3c8050;color:#fff;text-align:center;padding:15px;font-size:22px;font-weight:bold}
.notice{padding:10px 16px;margin:10px 0;border-radius:6px}
.notice.success{background:#e8f5e9;color:#2e7d32;border:1px solid #81c784}
.notice.error{background:#fdecea;color:#b71c1c;border:1px solid #f5c2c7}
.fade-in{animation:fadeIn .3s ease-in}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
</style>
</head>
<body>
<header>ç©¿å±±ç”²å°ˆè»Šé ç´„</header>
<div id="userInfo" style="padding:16px"><div class="loading-state">â³ ç³»çµ±åˆå§‹åŒ–ä¸­...</div></div>
<div id="currentReservationCard" style="display:none"></div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL='https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID='86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
const CACHE_DURATION=5*60*1000;
let selectedDate=null,selectedRoute=null,currentMonth=new Date().getMonth(),currentYear=new Date().getFullYear();
let userData=null,existingReservations=[],noServiceDates={};

// å¿«å–ç®¡ç†
const cache={
  get(key){
    const item=localStorage.getItem(key);
    if(!item)return null;
    try{
      const data=JSON.parse(item);
      if(Date.now()-data.timestamp>CACHE_DURATION)return null;
      return data.value;
    }catch{return null;}
  },
  set(key,value){
    localStorage.setItem(key,JSON.stringify({value,timestamp:Date.now()}));
  }
};

// åˆå§‹åŒ–
async function init(){
  try{
    const cachedUser=cache.get('pangolinUser');
    if(cachedUser){
      userData=cachedUser;
      renderUser(userData);
    }
    
    await liff.init({liffId:"2006590746-KJodGOda"});
    if(!liff.isLoggedIn())return liff.login();
    
    const profile=await liff.getProfile();
    
    // ä¸¦è¡Œè«‹æ±‚
    const [userCheck,reservations]=await Promise.allSettled([
      fetch(`${WORKER_URL}?check=${profile.userId}`).then(r=>r.json()),
      cachedUser?fetch(`${WORKER_URL}?mode=reservations&userId=${profile.userId}`).then(r=>r.json()):null
    ]);
    
    if(userCheck.status==='fulfilled'){
      const result=userCheck.value;

      // âœ…ã€æ–°å¢ï¼šå…¼å®¹ result.data æ ¼å¼ã€‘
      const payload=result.data||result;

      if(!payload.registered)return location.href='register.html';
      userData=payload.user;
      cache.set('pangolinUser',userData);
      renderUser(userData);
    }
    
    if(reservations.status==='fulfilled'&&reservations.value){
      existingReservations=reservations.value.reservations||[];
      cache.set('pangolinReservations',existingReservations);
      renderCurrentReservationCard();
    }
  }catch(e){
    console.error("ç™»å…¥éŒ¯èª¤",e);
    document.getElementById('userInfo').innerHTML=`<div class='notice error'>ç™»å…¥å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥</div>`;
  }
}

// é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
function renderUser(u){
  document.getElementById('userInfo').innerHTML=`
    <div style="font-size:18px;font-weight:bold">${u.name||'æœªå‘½å'}</div>
    <div>${u.department||''} | ${u.studentId||''}</div>`;
}

// æ¨¡æ“¬é ç´„å¡ï¼ˆå°šæœªæ¥ä¸Šé ç´„è³‡æ–™ï¼‰
function renderCurrentReservationCard(){
  const box=document.getElementById('currentReservationCard');
  if(!existingReservations.length){
    box.style.display='block';
    box.innerHTML=`<div class='notice'>å°šç„¡é ç´„ç´€éŒ„</div>`;
  }else{
    const r=existingReservations[0];
    box.style.display='block';
    box.innerHTML=`<div class='notice success'>âœ… æ‚¨å·²é ç´„ ${r.route||''} ç­æ¬¡</div>`;
  }
}

// âœ… å•Ÿå‹•
window.addEventListener('load',init);
</script>
</body>
</html>
