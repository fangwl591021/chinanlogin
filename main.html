<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ç©¿å±±ç”²å°ˆè»Šé ç´„ ğŸš | Pangolin Shuttle Reservation</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
/* ä¿æŒåŸæœ‰çš„ CSS æ¨£å¼ä¸è®Š */
body {
  font-family: system-ui, "Noto Sans TC", sans-serif;
  background: #f5f6f7;
  margin: 0;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}
header {
  background: #3c8050;
  color: #fff;
  text-align: center;
  padding: 15px;
  font-size: 22px;
  font-weight: bold;
  line-height: 1.4;
}
main { flex: 1; padding-bottom: 40px; }

.notice { padding: 10px 16px; margin: 10px 16px; border-radius: 6px; }
.notice.success { background: #e8f5e9; color: #2e7d32; border: 1px solid #81c784; }

.calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 3px;
  text-align: center;
  font-size: 13px;
  margin-bottom: 20px;
}
.calendar-day {
  padding: 8px 0;
  min-height: 45px;
  border-radius: 4px;
  background: #fff;
  border: 1px solid #e0e0e0;
  cursor: pointer;
  position: relative;
}
.calendar-day:hover { background: #eaf5ea; }
.calendar-day.past { background: #f5f5f5; color: #ccc; cursor:not-allowed; }
.calendar-day.disabled { 
  background: #ffe6e6; 
  color: #999; 
  cursor: not-allowed;
  position: relative;
}
.calendar-day.disabled::after {
  content: "åœé§›/No Service";
  position: absolute;
  bottom: 2px;
  left: 0;
  right: 0;
  font-size: 9px;
  color: #ff6b6b;
  font-weight: bold;
}
.calendar-day.selected { background: #3c8050; color: #fff; font-weight:bold; }

.route-section, .stop-selector { padding: 0 16px; margin: 20px 0; }
.route-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.route-btn {
  padding: 12px;
  border: 2px solid #3c8050;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  text-align: center;
}
.route-btn:hover { background: #eaf5ea; }
.route-btn.selected { background: #3c8050; color:white; }

select {
  width:100%; padding:12px; border:1px solid #ccc;
  border-radius:6px; margin-top:8px;
}
.submit-btn {
  background:#3c8050; color:white; border:none; padding:15px;
  border-radius:8px; font-size:16px; font-weight:bold;
  cursor:pointer; width:calc(100% - 32px); margin:20px 16px;
}
.submit-btn:hover { background:#2d6140; }

.cancel-btn {
  background:#c62828; color:white; border:none;
  padding:12px 20px; border-radius:6px; font-weight:bold;
  cursor:pointer; margin-top:12px; width:100%;
  font-size: 16px; /* å–æ¶ˆé ç´„æ–‡å­—æ›´å¤§ */
}
.cancel-btn:hover { background:#b71c1c; }

.resv-card {
  background:#f0fdf4; border:1px solid #a5d6a7;
  padding:12px 16px; border-radius:8px; margin:10px 16px;
}
#reservationPanel {
  margin-top:40px; padding:10px 0 20px 0; background:#fff;
  border-top:3px solid #3c8050; box-shadow:0 -3px 5px rgba(0,0,0,0.1);
}

/* ==================== æŒ‰éˆ•æ¨£å¼ ==================== */
.btn-group {
  display:flex;
  justify-content:center;
  gap:12px;
  margin:15px;
}
.btn-large {
  font-size:18px;
  padding:12px 20px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}
/* âœ… ç¶ è‰²æŒ‰éˆ•ç™½è‰²æ–‡å­— */
.btn-calendar, .btn-rule { 
  background:#3c8050;
}
.btn-calendar:hover, .btn-rule:hover { 
  background:#2d6140;
}

/* ==================== æ–‡å­—é¡è‰²æ§åˆ¶ ==================== */
.bilingual-text {
  line-height: 1.4;
}

/* âœ… æŒ‰éˆ•å…§æ–‡å­— = ç™½è‰² */
.btn-large .chinese-text,
.btn-large .english-text,
.submit-btn .chinese-text,
.submit-btn .english-text,
.cancel-btn .chinese-text,
.cancel-btn .english-text {
  color: white;
}

.btn-large .chinese-text,
.submit-btn .chinese-text,
.cancel-btn .chinese-text {
  font-weight: bold;
  margin-bottom: 2px;
}

.btn-large .english-text,
.submit-btn .english-text,
.cancel-btn .english-text {
  font-size: 0.85em;
  opacity: 0.95;
}

/* âœ… Header æ–‡å­— = ç™½è‰² */
header .chinese-text {
  color: white;
  font-weight: bold;
  margin-bottom: 2px;
}
header .english-text {
  color: white;
  font-size: 0.85em;
  opacity: 0.9;
}

/* âœ… é é¢æ¨™é¡Œï¼ˆh3ç­‰ï¼‰= é»‘è‰² */
h3 .chinese-text,
.route-section h3 .chinese-text,
.stop-selector h3 .chinese-text {
  color: #333;
  font-weight: bold;
  margin-bottom: 2px;
}
h3 .english-text,
.route-section h3 .english-text,
.stop-selector h3 .english-text {
  color: #666;
  font-size: 0.85em;
  opacity: 0.9;
}

/* âœ… é ç´„ç´€éŒ„é¢æ¿æ¨™é¡Œ = æ·±ç¶ è‰² */
#reservationPanel > div:first-child .chinese-text {
  color: #2d6140;
  font-weight: bold;
}
#reservationPanel > div:first-child .english-text {
  color: #666;
  font-size: 0.85em;
}

/* âœ… é ç´„å¡ç‰‡å…§å®¹ = é»‘è‰² */
.resv-card .reservation-item .chinese-text {
  color: #333;
  font-weight: normal;
}
.resv-card .reservation-item .english-text {
  color: #666;
  opacity: 0.8;
  font-size: 0.85em;
}

/* âœ… æœˆæ›†æ§åˆ¶æŒ‰éˆ• = ç¶ è‰²ç™½å­— */
.month-nav-btn {
  background: #3c8050;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}
.month-nav-btn:hover {
  background: #2d6140;
}

.reservation-item {
  margin-bottom: 8px;
}
</head>

<body>
<header>
  <div class="bilingual-text">
    <div class="chinese-text">ç©¿å±±ç”²å°ˆè»Šé ç´„</div>
    <div class="english-text">Pangolin Shuttle Reservation</div>
  </div>
</header>

<main>
  <div id="userInfo" style="padding:16px">
    <div class="bilingual-text">
      <div class="chinese-text">â³ ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
      <div class="english-text">â³ System Initializing...</div>
    </div>
  </div>

  <div class="btn-group">
    <button id="calendarBtn" class="btn-large btn-calendar" onclick="toggleCalendar()">
      <div class="bilingual-text">
        <div class="chinese-text">æ‰“é–‹æœˆæ›†</div>
        <div class="english-text">Open Calendar</div>
      </div>
    </button>
    <button id="ruleBtn" class="btn-large btn-rule" onclick="showRules()">
      <div class="bilingual-text">
        <div class="chinese-text">é ç´„è¦å‰‡</div>
        <div class="english-text">Reservation Rules</div>
      </div>
    </button>
  </div>

  <div id="calendarContainer" style="display:none;margin-top:10px;padding:0 16px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <button class="month-nav-btn" onclick="changeMonth(-1)">â—€ ä¸Šå€‹æœˆ / Prev</button>
      <h3 id="calendarTitle" class="bilingual-text"></h3>
      <button class="month-nav-btn" onclick="changeMonth(1)">ä¸‹å€‹æœˆ / Next â–¶</button>
    </div>
    <div id="calendar" class="calendar"></div>
  </div>

  <div id="selectedDate" class="notice success" style="display:none"></div>

  <div id="routeSection" class="route-section" style="display:none">
    <h3 class="bilingual-text">
      <div class="chinese-text">è«‹é¸æ“‡æ­ä¹˜ç­æ¬¡</div>
      <div class="english-text">Please Select Shuttle Route</div>
    </h3>
    <div id="routeButtons" class="route-buttons"></div>
  </div>

  <div id="fromStopSection" class="stop-selector" style="display:none">
    <h3 class="bilingual-text">
      <div class="chinese-text">è«‹é¸æ“‡ä¸Šè»Šç«™</div>
      <div class="english-text">Please Select Boarding Stop</div>
    </h3>
    <select id="fromStop">
      <option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡ / Please select route first</option>
    </select>
  </div>

  <div id="toStopSection" class="stop-selector" style="display:none">
    <h3 class="bilingual-text">
      <div class="chinese-text">è«‹é¸æ“‡ä¸‹è»Šç«™</div>
      <div class="english-text">Please Select Drop-off Stop</div>
    </h3>
    <select id="toStop">
      <option value="">è«‹é¸æ“‡ä¸Šè»Šç«™ / Please select boarding stop</option>
    </select>
  </div>

  <button id="submitBtn" class="submit-btn" onclick="submitReservation()" style="display:none">
    <div class="bilingual-text">
      <div class="chinese-text">é€å‡ºé ç´„</div>
      <div class="english-text">Submit Reservation</div>
    </div>
  </button>

  <div id="reservationPanel" style="display:none">
    <div style="text-align:center;font-weight:bold;color:#2d6140;margin-bottom:5px;" class="bilingual-text">
      <div class="chinese-text">æˆ‘çš„é ç´„ç´€éŒ„</div>
      <div class="english-text">My Reservations</div>
    </div>
    <div id="reservationInfo"></div>
  </div>
</main>

<script>
// ============================ ç³»çµ±é…ç½® ============================
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxL3jt2nWNTeBdyVW47kA8ywzzRMeK0iJySule8uxNZIK3MqVMp_K81I9qE3h6m4bNf_w/exec';

// ============================ è·¯ç·šèˆ‡ç«™é»è³‡æ–™ ============================
const ROUTES = {
  'A1': { name: 'A1 æ™šé–“22:00', nameEn: 'A1 10:00 PM', time: '22:00-22:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™', directionEn: 'NCNU â†’ Puli Bus Terminal' },
  'B1': { name: 'B1 æ™šé–“22:30', nameEn: 'B1 10:30 PM', time: '22:30-23:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§', directionEn: 'Puli Bus Terminal â†’ NCNU' },
  'A2': { name: 'A2 æ™šé–“23:00', nameEn: 'A2 11:00 PM', time: '23:00-23:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™', directionEn: 'NCNU â†’ Puli Bus Terminal' },
  'B2': { name: 'B2 æ™šé–“23:30', nameEn: 'B2 11:30 PM', time: '23:30-24:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§', directionEn: 'Puli Bus Terminal â†’ NCNU' }
};

// ç«™é»è³‡æ–™æ”¹ç‚ºä¸­è‹±åˆ†é–‹çš„æ ¼å¼
const STOPS = {
  'A1': [
    { chinese: 'è¡Œæ”¿å¤§æ¨“', english: 'NCNU Administrative Building' },
    { chinese: 'ä¸­é¤å»³', english: 'Zhong Can Ting (Chinese Restaurant)' },
    { chinese: 'ç§‘æŠ€å­¸é™¢', english: 'College of Science and Technology' },
    { chinese: 'å­¸äººæœƒé¤¨', english: 'Scholars\' Residence' },
    { chinese: 'ä¸­åŸ', english: 'Zhongcheng' },
    { chinese: 'ä¸‹åŸ', english: 'Xiacheng' },
    { chinese: 'åªé ‚', english: 'Pingding' },
    { chinese: 'æ„›è˜­æ©‹', english: 'Ailan Bridge' },
    { chinese: 'å¤§æˆåœ‹å°', english: 'Dacheng Elementary School' },
    { chinese: 'ä¸­å±±å®‰ä¸ƒè¡—å£', english: 'Zhongshan Anqi St. Intersection' },
    { chinese: 'æ¦®æ°‘è¨ºæ‰€', english: 'Veterans Clinic' },
    { chinese: 'åŸ”é‡Œé…’å» ', english: 'Puli Distillery' },
    { chinese: 'åŸ”é‡Œç¸½ç«™', english: 'Puli Bus Terminal' }
  ],
  'B1': [
    { chinese: 'åŸ”é‡Œç¸½ç«™', english: 'Puli Bus Terminal' },
    { chinese: 'åŸ”é‡Œé…’å» ', english: 'Puli Distillery' },
    { chinese: 'æ¦®æ°‘è¨ºæ‰€', english: 'Veterans Clinic' },
    { chinese: 'ä¸­å±±å®‰ä¸ƒè¡—å£', english: 'Zhongshan Anqi St. Intersection' },
    { chinese: 'å¤§æˆåœ‹å°', english: 'Dacheng Elementary School' },
    { chinese: 'æ„›è˜­æ©‹', english: 'Ailan Bridge' },
    { chinese: 'åªé ‚', english: 'Pingding' },
    { chinese: 'ä¸‹åŸ', english: 'Xiacheng' },
    { chinese: 'ä¸­åŸ', english: 'Zhongcheng' },
    { chinese: 'å­¸äººæœƒé¤¨', english: 'Scholars\' Residence' },
    { chinese: 'ç§‘æŠ€å­¸é™¢', english: 'College of Science and Technology' },
    { chinese: 'ä¸­é¤å»³', english: 'Zhong Can Ting (Chinese Restaurant)' },
    { chinese: 'è¡Œæ”¿å¤§æ¨“', english: 'NCNU Administrative Building' }
  ],
  'A2': [
    { chinese: 'è¡Œæ”¿å¤§æ¨“', english: 'NCNU Administrative Building' },
    { chinese: 'ä¸­é¤å»³', english: 'Zhong Can Ting (Chinese Restaurant)' },
    { chinese: 'ç§‘æŠ€å­¸é™¢', english: 'College of Science and Technology' },
    { chinese: 'å­¸äººæœƒé¤¨', english: 'Scholars\' Residence' },
    { chinese: 'ä¸­åŸ', english: 'Zhongcheng' },
    { chinese: 'ä¸‹åŸ', english: 'Xiacheng' },
    { chinese: 'åªé ‚', english: 'Pingding' },
    { chinese: 'æ„›è˜­æ©‹', english: 'Ailan Bridge' },
    { chinese: 'å¤§æˆåœ‹å°', english: 'Dacheng Elementary School' },
    { chinese: 'ä¸­å±±å®‰ä¸ƒè¡—å£', english: 'Zhongshan Anqi St. Intersection' },
    { chinese: 'æ¦®æ°‘è¨ºæ‰€', english: 'Veterans Clinic' },
    { chinese: 'åŸ”é‡Œé…’å» ', english: 'Puli Distillery' },
    { chinese: 'åŸ”é‡Œç¸½ç«™', english: 'Puli Bus Terminal' }
  ],
  'B2': [
    { chinese: 'åŸ”é‡Œç¸½ç«™', english: 'Puli Bus Terminal' },
    { chinese: 'åŸ”é‡Œé…’å» ', english: 'Puli Distillery' },
    { chinese: 'æ¦®æ°‘è¨ºæ‰€', english: 'Veterans Clinic' },
    { chinese: 'ä¸­å±±å®‰ä¸ƒè¡—å£', english: 'Zhongshan Anqi St. Intersection' },
    { chinese: 'å¤§æˆåœ‹å°', english: 'Dacheng Elementary School' },
    { chinese: 'æ„›è˜­æ©‹', english: 'Ailan Bridge' },
    { chinese: 'åªé ‚', english: 'Pingding' },
    { chinese: 'ä¸‹åŸ', english: 'Xiacheng' },
    { chinese: 'ä¸­åŸ', english: 'Zhongcheng' },
    { chinese: 'å­¸äººæœƒé¤¨', english: 'Scholars\' Residence' },
    { chinese: 'ç§‘æŠ€å­¸é™¢', english: 'College of Science and Technology' },
    { chinese: 'ä¸­é¤å»³', english: 'Zhong Can Ting (Chinese Restaurant)' },
    { chinese: 'è¡Œæ”¿å¤§æ¨“', english: 'NCNU Administrative Building' }
  ]
};

// ============================ å…¨åŸŸè®Šæ•¸ ============================
let userData = null, existingReservations = [], selectedDate = null, selectedRoute = null;
let currentYear = new Date().getFullYear(), currentMonth = new Date().getMonth();
let disabledDates = [];

// ============================ åˆå§‹åŒ– ============================
async function init(){
  try {
    await liff.init({liffId:"2006590746-KJodGOda"});
    if(!liff.isLoggedIn()) return liff.login();

    const profile = await liff.getProfile();
    console.log('ğŸ‘¤ LINE ç”¨æˆ¶è³‡æ–™:', profile);

    const checkRes = await fetch(`${WORKER_URL}?mode=check&userId=${profile.userId}`).then(r=>r.json());
    
    if(!checkRes.registered) {
      console.log('âŒ ç”¨æˆ¶æœªè¨»å†Šï¼Œè·³è½‰åˆ°è¨»å†Šé é¢');
      return location.href='register.html';
    }
    
    userData = checkRes.user || {};
    userData.userId = profile.userId;
    userData.lineDisplayName = profile.displayName;
    userData.linePictureUrl = profile.pictureUrl;

    renderUser(userData);
    await fetchReservations();
    await fetchDisabledDates();
    
  } catch (err) {
    console.error('âŒ åˆå§‹åŒ–éŒ¯èª¤:', err);
    alert('ç³»çµ±éŒ¯èª¤ / System Error: ' + err.message);
  }
}

// ============================ ç”¨æˆ¶è³‡æ–™é¡¯ç¤º ============================
function renderUser(u){
  document.getElementById('userInfo').innerHTML=
    `<div style="display:flex;align-items:center;gap:12px">
       <img src="${u.linePictureUrl}" style="width:50px;height:50px;border-radius:50%;border:2px solid #3c8050">
       <div>
         <div style="font-size:18px;font-weight:bold">${u.lineDisplayName}</div>
         <div style="font-size:14px;color:#666">${u.department||''} | ${u.phone||''}</div>
       </div>
     </div>`;
}

// ============================ æœ¬åœ°å„²å­˜ç®¡ç† ============================
function saveLocalReservations() {
  try {
    localStorage.setItem(`pangolin_reservations_${userData.userId}`, JSON.stringify(existingReservations));
    console.log('ğŸ’¾ é ç´„è³‡æ–™å·²å„²å­˜åˆ°æœ¬åœ°:', existingReservations.length, 'ç­†é ç´„');
  } catch (e) {
    console.error('âŒ å„²å­˜é ç´„åˆ°æœ¬åœ°å¤±æ•—:', e);
  }
}

function loadLocalReservations() {
  try {
    const saved = localStorage.getItem(`pangolin_reservations_${userData.userId}`);
    const reservations = saved ? JSON.parse(saved) : [];
    console.log('ğŸ“‚ å¾æœ¬åœ°è¼‰å…¥é ç´„:', reservations.length, 'ç­†');
    return reservations;
  } catch (e) {
    console.error('âŒ å¾æœ¬åœ°è¼‰å…¥é ç´„å¤±æ•—:', e);
    return [];
  }
}

// ============================ é ç´„è³‡æ–™ç®¡ç† - çœŸå¯¦è³‡æ–™æŸ¥è©¢ ============================
async function fetchReservations(){
  try {
    console.log('ğŸ“¥ é–‹å§‹è¼‰å…¥çœŸå¯¦é ç´„è³‡æ–™...');
    console.log('ğŸ‘¤ ç•¶å‰ç”¨æˆ¶è³‡æ–™:', userData);
    
    const res = await fetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`);
    const data = await res.json();
    
    console.log('ğŸ“¥ å¾ä¼ºæœå™¨å–å¾—çš„çœŸå¯¦è³‡æ–™:', data);
    
    existingReservations = [];
    
    if (data.status === 'success' && Array.isArray(data.reservations)) {
      existingReservations = data.reservations.map(resv => {
        const reservation = {
          reservationId: resv.reservationId || resv[11] || `resv-${Date.now()}`,
          userId: resv.userId || resv[10] || userData.userId,
          name: resv.name || resv[1] || userData.lineDisplayName,
          phone: resv.phone || resv[2] || userData.phone || '',
          date: resv.date || resv[0],
          route: resv.route || resv[3] || '',
          fromStop: resv.fromStop || resv[4] || '',
          toStop: resv.toStop || resv[5] || '',
          timestamp: resv.timestamp || resv[6] || new Date().toISOString(),
          status: resv.status || resv[7] || 'å·²é ç´„'
        };
        
        console.log('ğŸ“ è™•ç†é ç´„è³‡æ–™:', reservation);
        return reservation;
      }).filter(resv => resv.status === 'å·²é ç´„');
      
      console.log('âœ… å¾ä¼ºæœå™¨æˆåŠŸè¼‰å…¥çœŸå¯¦é ç´„:', existingReservations.length, 'ç­†');
    } else {
      console.log('â„¹ï¸ ä¼ºæœå™¨å›å‚³æˆåŠŸä½†æ²’æœ‰é ç´„è³‡æ–™æˆ–æ ¼å¼ä¸æ­£ç¢º');
      existingReservations = [];
    }
    
    saveLocalReservations();
    console.log('ğŸ“‹ æœ€çµ‚é ç´„åˆ—è¡¨:', existingReservations.length, 'ç­†');
    renderReservationInfo();
    
  } catch (error) { 
    console.error('âŒ è¼‰å…¥é ç´„éŒ¯èª¤:', error);
    existingReservations = loadLocalReservations();
    console.log('ğŸ”„ ä½¿ç”¨æœ¬åœ°é ç´„å‚™ä»½:', existingReservations.length, 'ç­†');
    renderReservationInfo();
  }
}

function addLocalReservation(reservation) {
  console.log('â• é–‹å§‹æ–°å¢æœ¬åœ°é ç´„:', reservation);
  
  if (!Array.isArray(existingReservations)) {
    console.log('ğŸ”„ åˆå§‹åŒ– existingReservations ç‚ºç©ºé™£åˆ—');
    existingReservations = [];
  }
  
  if (!reservation.reservationId) {
    reservation.reservationId = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    console.log('ğŸ†” ç”Ÿæˆæ–°çš„ reservationId:', reservation.reservationId);
  }
  
  const exists = existingReservations.some(r => 
    r.reservationId === reservation.reservationId
  );
  
  if (!exists) {
    existingReservations.push(reservation);
    console.log('âœ… é ç´„å·²æ–°å¢åˆ°é™£åˆ—ï¼Œç¾åœ¨æœ‰:', existingReservations.length, 'ç­†é ç´„');
    saveLocalReservations();
    
    setTimeout(() => {
      console.log('ğŸ”„ é‡æ–°æ¸²æŸ“é ç´„è³‡è¨Š');
      renderReservationInfo();
    }, 100);
  } else {
    console.log('âš  é ç´„å·²å­˜åœ¨ï¼Œä¸é‡è¤‡æ–°å¢');
  }
}

function removeLocalReservation(reservationId) {
  const initialLength = existingReservations.length;
  existingReservations = existingReservations.filter(r => r.reservationId !== reservationId);
  
  if (existingReservations.length < initialLength) {
    saveLocalReservations();
    renderReservationInfo();
    console.log('ğŸ—‘ï¸ å·²ç§»é™¤é ç´„:', reservationId);
  } else {
    console.log('âš  æœªæ‰¾åˆ°è¦ç§»é™¤çš„é ç´„:', reservationId);
  }
}

// ============================ åœé§›æ—¥ç®¡ç† ============================
async function fetchDisabledDates(){
  try {
    const res = await fetch(`${WORKER_URL}?mode=calendar`);
    const data = await res.json();
    if (data.status === 'success' && Array.isArray(data.disabledDates)) {
      disabledDates = data.disabledDates;
      console.log('ğŸˆ² çœŸå¯¦åœé§›æ—¥:', disabledDates);
    } else {
      console.warn('âš  ç„¡æ³•å–å¾—åœé§›æ—¥:', data);
      disabledDates = [];
    }
  } catch (e) {
    console.warn('âš  åœé§›æ—¥è®€å–å¤±æ•—', e);
    disabledDates = [];
  }
}

// ============================ æœˆæ›†åŠŸèƒ½ ============================
function loadCalendar(){
  const cal=document.getElementById('calendar');
  cal.innerHTML='';
  document.getElementById('calendarContainer').style.display='block';
  
  const monthTitle = document.getElementById('calendarTitle');
  monthTitle.innerHTML = `
    <div class="chinese-text">${currentYear}å¹´${currentMonth+1}æœˆ</div>
    <div class="english-text">${currentYear}-${currentMonth+1}</div>
  `;

  const today=new Date(); today.setHours(0,0,0,0);
  const lastDay=new Date(currentYear,currentMonth+1,0).getDate();

  for(let d=1;d<=lastDay;d++){
    const dateStr=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dateObj=new Date(dateStr);
    const div=document.createElement('div');
    div.className='calendar-day'; 
    div.textContent=d;

    if(dateObj<today) {
      div.classList.add('past');
    } else if(disabledDates.includes(dateStr)) {
      div.classList.add('disabled');
    } else {
      div.onclick=()=>selectDate(dateStr);
    }

    cal.appendChild(div);
  }
}

function changeMonth(delta){
  currentMonth+=delta;
  if(currentMonth<0){currentMonth=11;currentYear--;}
  if(currentMonth>11){currentMonth=0;currentYear++;}
  loadCalendar();
}

function toggleCalendar(){
  const c=document.getElementById('calendarContainer');
  c.style.display=(c.style.display==='none')?'block':'none';
  if(c.style.display==='block') loadCalendar();
}

// ============================ é ç´„æµç¨‹æ§åˆ¶ ============================
function selectDate(dateStr){
  selectedDate = dateStr;
  selectedRoute = null;
  
  console.log('ğŸ“… é¸æ“‡æ—¥æœŸ:', dateStr);
  
  document.getElementById('selectedDate').style.display = 'block';
  document.getElementById('selectedDate').innerHTML = 
    `<div class="bilingual-text">
       <div class="chinese-text">âœ… å·²é¸æ“‡ï¼š${dateStr}</div>
       <div class="english-text">âœ… Selected: ${dateStr}</div>
     </div>`;
  
  showRoutes();
  
  document.getElementById('fromStopSection').style.display = 'none';
  document.getElementById('toStopSection').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
}

function showRoutes(){
  const section = document.getElementById('routeSection');
  const container = document.getElementById('routeButtons');
  
  section.style.display = 'block';
  
  container.innerHTML = Object.keys(ROUTES).map(code => `
    <div class="route-btn" onclick="selectRoute('${code}')">
      <div style="font-weight:bold;font-size:16px">${ROUTES[code].name}</div>
      <div class="bilingual-text">
        <div style="font-size:13px;color:#666;margin-top:4px">${ROUTES[code].direction}</div>
        <div style="font-size:12px;color:#999;margin-top:2px">${ROUTES[code].directionEn}</div>
      </div>
    </div>
  `).join('');
  
  console.log('ğŸšŒ é¡¯ç¤ºè·¯ç·šé¸æ“‡');
}

function selectRoute(routeCode){
  selectedRoute = routeCode;
  
  console.log('ğŸ¯ é¸æ“‡è·¯ç·š:', routeCode);
  
  document.querySelectorAll('.route-btn').forEach(btn => btn.classList.remove('selected'));
  event.target.closest('.route-btn').classList.add('selected');
  
  loadStops(routeCode);
  
  document.getElementById('fromStopSection').style.display = 'block';
  document.getElementById('toStopSection').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
}

function loadStops(routeCode){
  const fromSelect = document.getElementById('fromStop');
  const stops = STOPS[routeCode] || [];
  
  console.log('ğŸ“ è¼‰å…¥ç«™é»:', stops);
  
  fromSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡ / Please select route first</option>' +
    stops.map(stop => `<option value="${stop.chinese}">${stop.chinese} ${stop.english}</option>`).join('');
  
  fromSelect.onchange = function(){
    console.log('â¬† é¸æ“‡ä¸Šè»Šç«™:', this.value);
    if(this.value){
      loadToStops(routeCode, this.value);
    } else {
      document.getElementById('toStopSection').style.display = 'none';
      document.getElementById('submitBtn').style.display = 'none';
    }
  };
}

function loadToStops(routeCode, fromStop){
  const toSelect = document.getElementById('toStop');
  const stops = STOPS[routeCode] || [];
  const fromIndex = stops.findIndex(stop => stop.chinese === fromStop);
  
  const availableStops = stops.slice(fromIndex + 1);
  
  console.log('â¬‡ å¯é¸ä¸‹è»Šç«™:', availableStops);
  
  if(availableStops.length === 0){
    toSelect.innerHTML = '<option value="">æ­¤ç«™ç‚ºçµ‚é»ç«™ / This is the final stop</option>';
    document.getElementById('toStopSection').style.display = 'block';
    document.getElementById('submitBtn').style.display = 'none';
    return;
  }
  
  toSelect.innerHTML = '<option value="">è«‹é¸æ“‡ä¸‹è»Šç«™ / Please select drop-off stop</option>' +
    availableStops.map(stop => `<option value="${stop.chinese}">${stop.chinese} ${stop.english}</option>`).join('');
  
  document.getElementById('toStopSection').style.display = 'block';
  
  toSelect.onchange = function(){
    console.log('â¬‡ é¸æ“‡ä¸‹è»Šç«™:', this.value);
    if(this.value){
      document.getElementById('submitBtn').style.display = 'block';
    } else {
      document.getElementById('submitBtn').style.display = 'none';
    }
  };
}

// ============================ é ç´„æäº¤ - çœŸå¯¦è³‡æ–™å¯«å…¥ ============================
async function submitReservation(){
  const fromStop = document.getElementById('fromStop').value;
  const toStop = document.getElementById('toStop').value;
  
  if(!selectedDate || !selectedRoute || !fromStop || !toStop){
    alert('è«‹å®Œæˆæ‰€æœ‰é¸æ“‡ / Please complete all selections');
    return;
  }
  
  const routeInfo = ROUTES[selectedRoute];
  const confirmMessage = `ç¢ºå®šé ç´„å—ï¼Ÿ\n\næ—¥æœŸ / Dateï¼š${selectedDate}\nç­æ¬¡ / Routeï¼š${routeInfo.name}\nä¸Šè»Š / Boardingï¼š${fromStop}\nä¸‹è»Š / Drop-offï¼š${toStop}\n\nConfirm reservation?`;
  
  if(!confirm(confirmMessage)){
    return;
  }
  
  const reservationData = {
    type: 'reserve',
    userId: userData.userId,
    name: userData.name || userData.lineDisplayName,
    phone: userData.phone || '',
    department: userData.department || '',
    date: selectedDate,
    route: selectedRoute,
    fromStop: fromStop,
    toStop: toStop,
    timestamp: new Date().toISOString()
  };
  
  console.log('ğŸ“¤ é€å‡ºçœŸå¯¦é ç´„è³‡æ–™:', reservationData);
  
  try {
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(reservationData)
    });
    
    const result = await res.json();
    console.log('ğŸ“¥ é ç´„çµæœ:', result);
    
    if(result.status === 'success'){
      alert('âœ… é ç´„æˆåŠŸï¼ / Reservation Successful!');
      
      const newReservation = {
        reservationId: result.reservationId,
        userId: userData.userId,
        name: userData.name || userData.lineDisplayName,
        phone: userData.phone || '',
        date: selectedDate,
        route: ROUTES[selectedRoute].name,
        routeCode: selectedRoute,
        fromStop: fromStop,
        toStop: toStop,
        timestamp: new Date().toISOString(),
        status: 'å·²é ç´„'
      };
      
      console.log('ğŸ†• æ–°é ç´„ç‰©ä»¶:', newReservation);
      addLocalReservation(newReservation);
      resetForm();
      
      setTimeout(() => {
        fetchReservations();
      }, 500);
      
    } else {
      alert('âŒ é ç´„å¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤ / Unknown Error'));
    }
  } catch(error){
    console.error('âŒ é ç´„éŒ¯èª¤:', error);
    alert('âŒ ç¶²è·¯éŒ¯èª¤ï¼Œå·²å„²å­˜åˆ°æœ¬åœ°å‚™ä»½ / Network error, saved locally');
    
    const localReservation = {
      reservationId: 'local_' + Date.now(),
      userId: userData.userId,
      name: userData.name || userData.lineDisplayName,
      phone: userData.phone || '',
      date: selectedDate,
      route: ROUTES[selectedRoute].name,
      routeCode: selectedRoute,
      fromStop: fromStop,
      toStop: toStop,
      timestamp: new Date().toISOString(),
      localOnly: true
    };
    
    addLocalReservation(localReservation);
    resetForm();
  }
}

// ============================ è¡¨å–®é‡ç½® ============================
function resetForm() {
  document.getElementById('routeSection').style.display = 'none';
  document.getElementById('fromStopSection').style.display = 'none';
  document.getElementById('toStopSection').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
  document.getElementById('selectedDate').style.display = 'none';
  document.getElementById('calendarContainer').style.display = 'none';
  
  selectedDate = null;
  selectedRoute = null;
  
  document.getElementById('fromStop').selectedIndex = 0;
  document.getElementById('toStop').selectedIndex = 0;
  
  document.querySelectorAll('.route-btn').forEach(btn => btn.classList.remove('selected'));
}

// ============================ é ç´„é¡¯ç¤º ============================
function renderReservationInfo(){
  const panel = document.getElementById('reservationPanel');
  const box = document.getElementById('reservationInfo');
  
  console.log('ğŸ¯ æ¸²æŸ“çœŸå¯¦é ç´„è³‡è¨Šï¼Œç¾æœ‰é ç´„æ•¸:', existingReservations?.length || 0);
  console.log('ğŸ“‹ çœŸå¯¦é ç´„è³‡æ–™å…§å®¹:', existingReservations);
  
  if(!existingReservations || !Array.isArray(existingReservations) || existingReservations.length === 0){
    console.log('â„¹ï¸ æ²’æœ‰é ç´„è³‡æ–™ï¼Œéš±è—é¢æ¿');
    panel.style.display = 'none';
    box.innerHTML = '';
    return;
  }
  
  console.log('âœ… æœ‰çœŸå¯¦é ç´„è³‡æ–™ï¼Œé¡¯ç¤ºé¢æ¿');
  panel.style.display = 'block';
  
  const sortedReservations = [...existingReservations].sort((a, b) => {
    try {
      const dateA = new Date(a.date);
      const dateB = new Date(b.date);
      return dateB - dateA;
    } catch (e) {
      console.error('æ—¥æœŸæ’åºéŒ¯èª¤:', e);
      return 0;
    }
  });
  
  console.log('ğŸ“Š æ’åºå¾Œçš„é ç´„:', sortedReservations);
  
  const reservationsHTML = sortedReservations.map((r, index) => {
    console.log(`è™•ç†ç¬¬ ${index} ç­†é ç´„:`, r);
    
    let displayDate = r.date;
    if (typeof displayDate === 'string' && displayDate.includes('T')) {
      displayDate = displayDate.split('T')[0];
    }
    
    let routeDisplay = r.route;
    if (typeof r.route === 'string' && r.route.length <= 3) {
      routeDisplay = ROUTES[r.route] ? ROUTES[r.route].name : r.route;
    }
    
    // ç²å–ç«™é»çš„è‹±æ–‡åç¨±
    const getStopEnglishName = (stopChinese, routeCode) => {
      const stops = STOPS[routeCode] || [];
      const stop = stops.find(s => s.chinese === stopChinese);
      return stop ? stop.english : stopChinese;
    };
    
    const fromStopEnglish = getStopEnglishName(r.fromStop, r.routeCode || r.route);
    const toStopEnglish = getStopEnglishName(r.toStop, r.routeCode || r.route);
    
    const reservationId = r.reservationId || `unknown-${index}`;
    
    return `
    <div class="resv-card" id="resv-${reservationId}">
      <div class="bilingual-text reservation-item">
        <div class="chinese-text"><strong>æ—¥æœŸ / Date:</strong> ${displayDate}</div>
      </div>
      <div class="bilingual-text reservation-item">
        <div class="chinese-text"><strong>ç­æ¬¡ / Route:</strong> ${routeDisplay}</div>
      </div>
      <div class="bilingual-text reservation-item">
        <div class="chinese-text"><strong>ä¸Šè»Š / Boarding:</strong> ${r.fromStop}</div>
        <div class="english-text">${fromStopEnglish}</div>
      </div>
      <div class="bilingual-text reservation-item">
        <div class="chinese-text"><strong>ä¸‹è»Š / Drop-off:</strong> ${r.toStop}</div>
        <div class="english-text">${toStopEnglish}</div>
      </div>
      <div class="bilingual-text reservation-item">
        <div class="chinese-text"><strong>ç‹€æ…‹ / Status:</strong> ${r.status || 'å·²é ç´„ / Reserved'}</div>
      </div>
      <button class="cancel-btn" onclick="cancelReservation('${reservationId}')">
        <div class="bilingual-text">
          <div class="chinese-text">å–æ¶ˆé ç´„</div>
          <div class="english-text">Cancel Reservation</div>
        </div>
      </button>
    </div>`;
  }).join('');
  
  console.log('ç”Ÿæˆçš„HTML:', reservationsHTML);
  box.innerHTML = reservationsHTML;
  panel.style.display = 'block';
  console.log('âœ… é ç´„é¢æ¿å·²æ›´æ–°ï¼Œé¡¯ç¤ºçœŸå¯¦è³‡æ–™');
}

// ============================ å–æ¶ˆé ç´„ - çœŸå¯¦è³‡æ–™æ“ä½œ ============================
async function cancelReservation(reservationId) {
  const confirmMessage = 'ç¢ºå®šå–æ¶ˆæ­¤é ç´„å—ï¼Ÿ\n\nConfirm to cancel this reservation?';
  if (!confirm(confirmMessage)) return;
  
  const payload = {
    type: 'cancel',
    userId: userData.userId,
    reservationId: reservationId
  };
  
  try {
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const result = await res.json();
    if(result.status === 'success'){
      alert('âœ… å·²å–æ¶ˆé ç´„ / Reservation Cancelled');
      removeLocalReservation(reservationId);
      setTimeout(() => {
        fetchReservations();
      }, 500);
    } else {
      alert('âŒ å–æ¶ˆå¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤ / Unknown Error'));
    }
  } catch (error) {
    console.error('âŒ å–æ¶ˆéŒ¯èª¤:', error);
    alert('âŒ ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ / Network error, please try again later');
  }
}

// ============================ å…¶ä»–åŠŸèƒ½ ============================
function showRules(){
  const rulesContent = `ğŸ“˜ é ç´„è¦å‰‡ / Reservation Rules

1. æ¯äººæ¯æ—¥é™é ç´„ä¸€å€‹ç­æ¬¡
   Each person can reserve one shuttle per day

2. è«‹æ–¼æ­ä¹˜æ—¥å‰ä¸€å¤©é ç´„
   Please reserve at least one day before the ride

3. å¦‚éœ€å–æ¶ˆè«‹æå‰é€šçŸ¥
   Please notify in advance if cancellation is needed

4. ä¸Šè»Šæ™‚è«‹ä¸»å‹•å‡ºç¤ºé ç´„ç´€éŒ„
   Please show your reservation record when boarding`;
  
  alert(rulesContent);
}

window.addEventListener('load', init);
</script>
</body>
</html>
