<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>穿山甲專車預約</title>
  <style>
    body { 
      font-family: system-ui, sans-serif; 
      background:#f5f6f7; 
      margin:0; 
      padding:0; 
    }
    header { 
      background:#3c8050; 
      color:#fff; 
      text-align:center; 
      padding:15px; 
      font-size:22px; 
      font-weight:bold; 
    }

    /* 用户信息区域 */
    .user-section {
      padding: 16px;
      background: white;
      margin: 10px 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .user-name {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    .user-info {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    .loading-state {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    /* 月曆按鈕 */
    #calendarBtn { 
      width: calc(100% - 32px);
      background:#3c8050; 
      color:#fff; 
      border:none; 
      padding:12px; 
      border-radius:6px; 
      font-size:16px; 
      font-weight:bold; 
      margin:10px 16px; 
      cursor:pointer; 
      display: block;
    }

    /* 📅 月曆 */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px;
      text-align: center;
      font-size: 13px;
      margin-bottom: 20px;
    }
    .calendar-header {
      padding: 8px 0;
      font-weight: bold;
      background: #f0f0f0;
      border-radius: 3px;
      font-size: 12px;
    }
    .calendar-day {
      padding: 8px 0;
      min-height: 45px;
      border-radius: 4px;
      background: #fff;
      border: 1px solid #e0e0e0;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: background 0.2s;
    }
    .calendar-day:hover { background:#eaf5ea; }
    .calendar-day.disabled { 
      background:#f8f9fa; 
      color:#999; 
      cursor:not-allowed; 
    }
    .calendar-day.past { 
      background:#f5f5f5; 
      color:#ccc; 
      cursor:not-allowed; 
    }
    .calendar-day.selected { background:#3c8050; color:#fff; font-weight:bold; }
    .calendar-day.other-month { color:#ccc; }

    /* 橫向輪播式預約卡片 */
    .carousel-container {
      padding: 16px;
      margin: 20px 0;
    }
    .carousel-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
      text-align: center;
    }
    .carousel {
      display: flex;
      overflow-x: auto;
      gap: 15px;
      padding: 10px 0;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .carousel::-webkit-scrollbar {
      display: none;
    }
    .reservation-bubble {
      min-width: 240px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
      overflow: hidden;
      flex-shrink: 0;
    }
    .bubble-header {
      background: #27ACB2;
      color: white;
      padding: 12px 15px;
      font-weight: bold;
      font-size: 14px;
    }
    .bubble-body {
      padding: 12px;
    }
    .bubble-line {
      margin-bottom: 6px;
      font-size: 12px;
      line-height: 1.3;
    }
    .bubble-line:last-child {
      margin-bottom: 0;
    }
    .route-time {
      font-weight: bold;
      color: #333;
    }
    .bubble-footer {
      padding: 8px;
      border-top: 1px solid #f0f0f0;
      text-align: center;
    }
    .cancel-btn-small {
      background: none;
      border: none;
      color: #FF0000;
      font-size: 12px;
      cursor: pointer;
      padding: 5px 10px;
    }
    .cancel-btn-small:hover {
      background: #ffe6e6;
      border-radius: 4px;
    }

    /* 沒有預約的提示 */
    .no-reservation {
      text-align: center;
      color: #666;
      padding: 40px 20px;
      background: white;
      border-radius: 8px;
      margin: 20px 16px;
    }

    /* 班次選擇區域 */
    .route-section {
      padding: 0 16px;
      margin: 20px 0;
    }
    .route-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 10px 0;
    }
    .route-btn {
      padding: 12px;
      border: 2px solid #3c8050;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    .route-btn:hover {
      background: #eaf5ea;
    }
    .route-btn.selected {
      background: #3c8050;
      color: white;
    }
    .route-time {
      font-weight: bold;
      font-size: 14px;
    }
    .route-direction {
  font-size: 12px;
  margin-top: 4px;
  line-height: 1.3;  /* 確保行高一致 */
}
    /* 在現有CSS的 .route-btn 樣式後添加 */
.route-btn.disabled {
  background: #f5f5f5 !important;
  border-color: #ccc !important;
  color: #999 !important;
  cursor: not-allowed !important;
}

.route-btn.disabled:hover {
  background: #f5f5f5 !important;
}
    /* 車站選擇 */
    .stop-selector {
      padding: 0 16px;
      margin: 20px 0;
    }
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      margin-top: 8px;
    }

    /* 送出按鈕 */
    .submit-btn {
      background: #3c8050;
      color: white;
      border: none;
      padding: 15px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 20px 16px;
      width: calc(100% - 32px);
    }
    .submit-btn:hover {
      background: #2d6140;
    }
    .submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* 提示訊息 */
    .notice {
      padding: 10px 16px;
      margin: 10px 16px;
      border-radius: 6px;
    }
    .notice.success {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #81c784;
    }
    .notice.error {
      background: #fdecea;
      color: #b71c1c;
      border: 1px solid #f5c2c7;
    }
  </style>
</head>
<body>
  <header>穿山甲專車預約</header>

  <!-- 使用者資訊 -->
  <div id="userInfo" class="user-section">
    <div class="loading-state">⏳ 系統初始化中...</div>
  </div>

  <!-- 📅 月曆按鈕 -->
  <button id="calendarBtn" onclick="toggleCalendar()">📅 打開月曆</button>

  <!-- 📅 月曆容器 -->
  <div id="calendarContainer" style="display:none;margin-top:10px; padding:0 16px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <button onclick="changeMonth(-1)" style="width:auto; padding:5px 10px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">◀ 上個月</button>
      <h3 id="calendarTitle" style="margin:0; font-size:16px;"></h3>
      <button onclick="changeMonth(1)" style="width:auto; padding:5px 10px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">下個月 ▶</button>
    </div>
    <div id="calendar" class="calendar"></div>
  </div>

  <div id="selectedDate" class="notice success" style="display:none;"></div>
  <div id="holidayNotice" class="notice error" style="display:none;"></div>

  <!-- 🚌 班次選擇區域 -->
  <div id="routeSection" class="route-section" style="display:none;">
    <h3>請選擇搭乘班次</h3>
    <div id="routeButtons" class="route-buttons"></div>
  </div>

  <!-- 🚏 車站選擇區域 -->
  <div id="stopSection" class="stop-selector" style="display:none;">
    <h3>請選擇下車站</h3>
    <select id="toStop">
      <option value="">請先選擇班次</option>
    </select>
  </div>

  <!-- 📝 送出按鈕 -->
  <button id="submitBtn" class="submit-btn" onclick="submitReservation()" style="display:none;">送出預約</button>

  <!-- 🧾 橫向輪播式預約卡片 -->
  <div id="currentReservationCard"></div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let selectedDate = null;
let selectedRoute = null;
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let userData = null;
let existingReservations = [];
let noServiceDates = {};

const stopsOutbound = ["行政大樓","中餐廳","科技學院","學人會館","中城","下城","坪頂","愛蘭橋","大成國小","中山安七街口","榮民診所","埔里酒廠","埔里總站"];
const stopsReturn = [...stopsOutbound].reverse();

const routeTimes = {
  'A1': { time: '22:00-22:30', direction: '暨大→埔里總站' },
  'B1': { time: '22:30-23:00', direction: '埔里總站→暨大' },
  'A2': { time: '23:00-23:30', direction: '暨大→埔里總站' },
  'B2': { time: '23:30-24:00', direction: '埔里總站→暨大' }
};
// ↓↓↓ 在這裡加入 ↓↓↓
const RESERVATION_RULES = {
  MAX_DAYS_AHEAD: 7,
  MAX_CAPACITY_PER_ROUTE: 6,
  DAILY_DEADLINE: '19:00',
  MAX_RESERVATIONS_PER_DAY: 1
};
// === 初始化 LIFF ===
async function init() {
  try {
    console.log('開始初始化 LIFF...');
    
    // 初始化 LIFF
    await liff.init({ liffId: "2006590746-KJodGOda" });
    console.log('LIFF 初始化成功');
    
    // 檢查登入狀態
    if (!liff.isLoggedIn()) {
      console.log('用戶未登入，執行登入...');
      liff.login();
      return;
    }
    
    // 獲取用戶資料
    const profile = await liff.getProfile();
    console.log('用戶資料:', profile);
    
    // 檢查用戶是否已註冊
    const res = await fetch(`${WORKER_URL}?check=${profile.userId}`);
    const result = await res.json();
    console.log('註冊檢查結果:', result);
    
    if (!result.registered) {
      console.log('用戶未註冊，跳轉到註冊頁面');
      window.location.href = 'register.html';
      return;
    }
    
    userData = result.user;
    console.log('用戶數據:', userData);

    // 更新用戶信息顯示
    document.getElementById('userInfo').innerHTML = `
      <div class="user-name">${userData.name}</div>
      <div class="user-info"><strong>${userData.department} | ${userData.studentId}</strong></div>
    `;

    // 載入現有預約
    await loadExistingReservations();
    
    console.log('系統初始化完成');
    
  } catch (error) {
    console.error('初始化失敗:', error);
    document.getElementById('userInfo').innerHTML = `
      <div class="loading-state">❌ 系統初始化失敗，請重新整理頁面</div>
    `;
  }
}

// === 載入停駛日期 ===
async function loadNoServiceDates() {
  try {
    const start = formatDateToLocal(new Date(currentYear, currentMonth - 1, 1));
    const end = formatDateToLocal(new Date(currentYear, currentMonth + 2, 0));
    const res = await fetch(`${WORKER_URL}?mode=calendar&start=${start}&end=${end}&calendarId=${encodeURIComponent(CALENDAR_ID)}`);
    const result = await res.json();
    noServiceDates = {};
    if (Array.isArray(result.holidays)) {
      result.holidays.forEach(d => noServiceDates[d.substring(0,10)] = true);
    }
    console.log('停駛日期:', noServiceDates);
  } catch (e) {
    console.error('🚨 載入停駛日期失敗:', e);
    noServiceDates = {};
  }
}

// === 📅 月曆開關 ===
async function toggleCalendar() {
  const container = document.getElementById('calendarContainer');
  const btn = document.getElementById('calendarBtn');

  if (container.style.display === 'none') {
    await loadNoServiceDates();
    renderCalendar();
    container.style.display = 'block';
    btn.textContent = '📅 關閉月曆';
    container.scrollIntoView({ behavior: 'smooth' });
  } else {
    container.style.display = 'none';
    btn.textContent = '📅 打開月曆';
  }
}

// === 📅 月曆產生 ===
function renderCalendar() {
  const calendar = document.getElementById('calendar');
  calendar.innerHTML = '';
  
  // 添加星期標題
  const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
  weekdays.forEach(day => {
    const header = document.createElement('div');
    header.className = 'calendar-header';
    header.textContent = day;
    calendar.appendChild(header);
  });

  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
  document.getElementById('calendarTitle').textContent = `${currentYear}年 ${monthNames[currentMonth]}`;

  const startDay = firstDay.getDay();
  const daysInMonth = lastDay.getDate();
  const today = new Date();
  const todayStr = formatDateToLocal(today);

  // 上個月的日期
  const prevLastDay = new Date(currentYear, currentMonth, 0).getDate();
  for (let i = startDay - 1; i >= 0; i--) {
    const empty = document.createElement('div');
    empty.className = 'calendar-day other-month';
    empty.textContent = prevLastDay - i;
    calendar.appendChild(empty);
  }

  // 這個月的日期
for (let day = 1; day <= daysInMonth; day++) {
  const date = new Date(currentYear, currentMonth, day);
  const dateStr = formatDateToLocal(date);
  const div = document.createElement('div');
  div.className = 'calendar-day';
  
  // 使用新的驗證規則檢查日期狀態
  const isPast = ReservationValidator.isPastDate(dateStr);
  const isNoService = ReservationValidator.isNoServiceDate(dateStr);
  const isAfterDeadline = ReservationValidator.isAfterDeadline(dateStr);
  const isWithinWindow = ReservationValidator.isWithinBookingWindow(dateStr);
  const hasReservation = userData ? ReservationValidator.hasExistingReservation(userData.userId, dateStr) : false;
  
  let disabled = false;
  let disabledReason = '';

  if (isPast) {
    disabled = true;
    disabledReason = '已過期';
  } else if (isNoService) {
    disabled = true;
    disabledReason = '停駛';
  } else if (!isWithinWindow) {
    disabled = true;
    disabledReason = '未開放';
  } else if (isAfterDeadline && ReservationValidator.isToday(dateStr)) {
    disabled = true;
    disabledReason = '已截止';
  } else if (hasReservation) {
    disabled = true;
    disabledReason = '已預約';
  }
  
  if (disabled) {
    div.classList.add('disabled');
    div.innerHTML = `${day}<br><small>${disabledReason}</small>`;
  } else {
    div.textContent = day;
    div.onclick = () => selectDate(dateStr);
  }
  
  // 標記今天
  if (dateStr === todayStr) {
    div.style.border = '2px solid #3c8050';
  }
  
  // 特別標記已有預約的日期
  if (hasReservation) {
    div.style.background = '#f8f9fa';
    div.style.border = '2px solid #4caf50';
  }
  
  // 標記已選擇的日期
  if (selectedDate === dateStr) {
    div.classList.add('selected');
  }
  
  calendar.appendChild(div);
}

  // 下個月的日期
  const totalCells = 42; // 6行 x 7列
  const remaining = totalCells - (startDay + daysInMonth);
  for (let day = 1; day <= remaining; day++) {
    const empty = document.createElement('div');
    empty.className = 'calendar-day other-month';
    empty.textContent = day;
    calendar.appendChild(empty);
  }
}

function changeMonth(delta) {
  currentMonth += delta;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  renderCalendar();
}

function selectDate(dateStr) {
  // 使用新的驗證規則檢查日期
  const dateValidation = {
    past: ReservationValidator.isPastDate(dateStr),
    noService: ReservationValidator.isNoServiceDate(dateStr),
    withinWindow: ReservationValidator.isWithinBookingWindow(dateStr),
    afterDeadline: ReservationValidator.isAfterDeadline(dateStr),
    hasReservation: ReservationValidator.hasExistingReservation(userData.userId, dateStr)
  };

  // 檢查日期有效性
  if (dateValidation.past) {
    showError('🚫 無法預約過去日期');
    return;
  }

  if (dateValidation.noService) {
    showError('🚫 該日期為停駛日，無法預約');
    return;
  }

  if (!dateValidation.withinWindow) {
    showError(`🚫 只能預約未來 ${RESERVATION_RULES.MAX_DAYS_AHEAD} 天內的班次`);
    return;
  }

  if (dateValidation.afterDeadline) {
    showError(`🚫 今日預約已截止（${RESERVATION_RULES.DAILY_DEADLINE}）`);
    return;
  }

  // 檢查是否已有預約
  if (dateValidation.hasReservation) {
    const existingReservation = existingReservations.find(
      res => res.userId === userData.userId && 
             res.date.split('T')[0] === dateStr && 
             res.status !== '已取消'
    );
    
    showError(`您已在 ${dateStr} 預約了 ${existingReservation?.route || ''} 班次，每天只能預約一個班次`);
    return;
  }

  selectedDate = dateStr;
  
  // 重置選擇狀態
  document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
  event.target.classList.add('selected');
  
  // 顯示選擇的日期
  document.getElementById('selectedDate').style.display = 'block';
  document.getElementById('selectedDate').textContent = `✅ 已選擇日期：${dateStr}`;
  document.getElementById('holidayNotice').style.display = 'none';
  
  // 關閉月曆
  document.getElementById('calendarContainer').style.display = 'none';
  document.getElementById('calendarBtn').textContent = '📅 打開月曆';
  
  // 顯示班次選擇
  showRouteSelection();
}

// === 🚌 顯示班次選擇 ===
async function showRouteSelection() {
  const routeSection = document.getElementById('routeSection');
  const routeButtons = document.getElementById('routeButtons');
  
  routeButtons.innerHTML = '';
  
  // 建立所有班次按鈕，並顯示剩餘名額
  for (const [routeId, info] of Object.entries(routeTimes)) {
    const button = document.createElement('div');
    button.className = 'route-btn';
    
    // 取得該班次的預約人數
    const currentCount = await getRouteReservationCount(selectedDate, routeId);
    const remainingSeats = RESERVATION_RULES.MAX_CAPACITY_PER_ROUTE - currentCount;
    
    button.innerHTML = `
      <div class="route-time">${routeId} ${info.time}</div>
      <div class="route-direction">${info.direction}</div>
      <div style="font-size: 11px; margin-top: 4px; color: ${remainingSeats > 2 ? '#4caf50' : remainingSeats > 0 ? '#ff9800' : '#f44336'}">
        ${remainingSeats > 0 ? `剩餘 ${remainingSeats} 席` : '已額滿'}
      </div>
    `;
    
    // 如果已額滿，禁用按鈕
    if (remainingSeats <= 0) {
      button.classList.add('disabled');
      button.style.background = '#f5f5f5';
      button.style.borderColor = '#ccc';
      button.style.cursor = 'not-allowed';
    } else {
      button.onclick = () => selectRoute(routeId, info.direction);
    }
    
    routeButtons.appendChild(button);
  }
  
  routeSection.style.display = 'block';
  routeSection.scrollIntoView({ behavior: 'smooth' });
}

// 取得班次預約人數的函數
async function getRouteReservationCount(dateStr, route) {
  try {
    const res = await fetch(`${WORKER_URL}?mode=routeCapacity&date=${dateStr}&route=${route}`);
    const result = await res.json();
    return result.count || 0;
  } catch (error) {
    console.error('取得班次人數失敗:', error);
    return 0;
  }
}

// === 📝 送出預約 ===
async function submitReservation() {
  const toStop = document.getElementById('toStop').value;
  const submitBtn = document.getElementById('submitBtn');
  
  if (!selectedDate || !selectedRoute || !toStop) {
    alert('請完整選擇日期、班次與下車站');
    return;
  }
  
  try {
    submitBtn.disabled = true;
    submitBtn.textContent = '預約中...';
    
    const info = routeTimes[selectedRoute];
    const fromStop = selectedRoute.includes('A') ? '行政大樓' : '埔里總站';
    
    const data = {
      type: 'reserve',
      userId: userData.userId,
      name: userData.name,
      studentId: userData.studentId,
      department: userData.department,
      phone: userData.phone || '',
      route: selectedRoute,
      routeName: `${selectedRoute} | ${info.time} ${info.direction}`,
      fromStop: fromStop,
      toStop: toStop,
      date: selectedDate
    };
    
    // ✅ 寫入 GAS
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    
    if (result.status === 'success') {
      alert('✅ 預約成功！');

      // 重置畫面
      resetReservationForm();
      await loadExistingReservations();
      
    } else {
      alert('❌ 預約失敗：' + (result.message || '請稍後再試'));
    }
    
  } catch (error) {
    console.error('預約錯誤:', error);
    alert('❌ 預約失敗，請檢查網路連線');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = '送出預約';
  }
}

// === 🔄 重置預約表單 ===
function resetReservationForm() {
  // 隱藏所有預約相關區塊
  document.getElementById('routeSection').style.display = 'none';
  document.getElementById('stopSection').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
  document.getElementById('selectedDate').style.display = 'none';
  document.getElementById('holidayNotice').style.display = 'none';
  
  // 重置選擇
  selectedDate = null;
  selectedRoute = null;
  document.getElementById('toStop').innerHTML = '<option value="">請先選擇班次</option>';
  document.querySelectorAll('.route-btn').forEach(btn => btn.classList.remove('selected'));
  document.querySelectorAll('.calendar-day').forEach(day => day.classList.remove('selected'));
}

// === 📅 橫向輪播式預約卡片 ===
function renderCurrentReservationCard() {
  const section = document.getElementById('currentReservationCard');
  section.innerHTML = '';

  const today = formatDateToLocal(new Date());
  const activeReservations = existingReservations
    .filter(res => res.date >= today && res.status !== '已取消')
    .sort((a, b) => a.date.localeCompare(b.date));

  if (activeReservations.length === 0) {
    section.innerHTML = `
      <div class="no-reservation">
        <div style="font-size: 48px; margin-bottom: 10px;">📭</div>
        <div style="font-size: 16px; color: #666;">目前沒有預約紀錄</div>
      </div>
    `;
    return;
  }

  // 建立輪播容器
  const carouselContainer = document.createElement('div');
  carouselContainer.className = 'carousel-container';
  
  const carouselTitle = document.createElement('div');
  carouselTitle.className = 'carousel-title';
  carouselTitle.textContent = `我的預約 (${activeReservations.length} 筆)`;
  carouselContainer.appendChild(carouselTitle);
  
  const carousel = document.createElement('div');
  carousel.className = 'carousel';
  
  // 為每個預約建立泡泡卡片
  activeReservations.forEach(reservation => {
    const dateOnly = reservation.date.split('T')[0];
    const routeInfo = routeTimes[reservation.route] || { time: '', direction: '' };
    
    const bubble = document.createElement('div');
    bubble.className = 'reservation-bubble';
    bubble.innerHTML = `
      <div class="bubble-header">
        日期: ${dateOnly}
      </div>
      <div class="bubble-body">
        <div class="bubble-line route-time">${reservation.route} | ${routeInfo.time}</div>
        <div class="bubble-line">${routeInfo.direction}</div>
        <div class="bubble-line">姓名: ${reservation.name}</div>
        <div class="bubble-line">上車: ${reservation.fromStop}</div>
        <div class="bubble-line">下車: ${reservation.toStop}</div>
      </div>
      <div class="bubble-footer">
        <button class="cancel-btn-small" onclick="cancelReservation('${reservation.id}')">
          ❌ 取消預約
        </button>
      </div>
    `;
    carousel.appendChild(bubble);
  });
  
  carouselContainer.appendChild(carousel);
  section.appendChild(carouselContainer);
}

// === 取消預約 ===
async function cancelReservation(reservationId) {
  if (!confirm('確定要取消這筆預約嗎？')) return;

  try {
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type: 'cancel', id: reservationId, userId: userData.userId })
    });

    const result = await res.json();
    if (result.status === 'success') {
      alert('✅ 已取消預約');
      await loadExistingReservations();
    } else {
      alert('❌ 取消失敗：' + (result.message || '請稍後再試'));
    }
  } catch (e) {
    console.error('取消預約錯誤', e);
    alert('❌ 取消預約時發生錯誤');
  }
}

// === 載入預約 ===
async function loadExistingReservations() {
  try {
    const res = await fetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`);
    const result = await res.json();
    existingReservations = result.reservations || [];
    renderCurrentReservationCard();
  } catch (e) {
    console.error('載入預約失敗', e);
    existingReservations = [];
    renderCurrentReservationCard();
  }
}

function formatDateToLocal(date){
  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

// === 預約規則驗證函數 ===
class ReservationValidator {
  // R4: 過去日期檢查
  static isPastDate(dateStr) {
    const selected = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return selected < today;
  }

  // R5: 停駛日檢查
  static isNoServiceDate(dateStr) {
    return noServiceDates[dateStr] === true;
  }

  // R7: 預約截止時間檢查
  static isAfterDeadline(dateStr) {
    const today = new Date();
    const selected = new Date(dateStr);
    
    // 如果是今天，檢查是否超過19:00
    if (this.isToday(dateStr)) {
      const now = new Date();
      const [deadlineHour, deadlineMinute] = RESERVATION_RULES.DAILY_DEADLINE.split(':');
      const deadline = new Date();
      deadline.setHours(parseInt(deadlineHour), parseInt(deadlineMinute), 0, 0);
      return now > deadline;
    }
    return false;
  }

  // R13: 未來天數限制
  static isWithinBookingWindow(dateStr) {
    const selected = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const maxDate = new Date();
    maxDate.setDate(today.getDate() + RESERVATION_RULES.MAX_DAYS_AHEAD);
    maxDate.setHours(23, 59, 59, 999);
    
    return selected >= today && selected <= maxDate;
  }

  // 輔助函數：檢查是否為今天
  static isToday(dateStr) {
    const today = formatDateToLocal(new Date());
    return dateStr === today;
  }

  // 方案B核心：重複預約檢查 - 每天只能有1筆預約
  static hasExistingReservation(userId, dateStr) {
    const userReservations = existingReservations.filter(
      res => res.userId === userId && 
             res.date.split('T')[0] === dateStr && 
             res.status !== '已取消'
    );
    return userReservations.length >= RESERVATION_RULES.MAX_RESERVATIONS_PER_DAY;
  }

  // R8: 班次容量檢查
  static async isRouteFull(dateStr, route) {
    try {
      const res = await fetch(`${WORKER_URL}?mode=routeCapacity&date=${dateStr}&route=${route}`);
      const result = await res.json();
      return result.count >= RESERVATION_RULES.MAX_CAPACITY_PER_ROUTE;
    } catch (error) {
      console.error('容量檢查失敗:', error);
      return false;
    }
  }

  // R11, R12: 站點驗證
  static validateStops(route, fromStop, toStop) {
    const isValidFromStop = route.includes('A') ? 
      fromStop === '行政大樓' : fromStop === '埔里總站';
    
    const stops = route.includes('A') ? stopsOutbound : stopsReturn;
    const isValidToStop = stops.includes(toStop) && toStop !== fromStop;
    
    return isValidFromStop && isValidToStop;
  }

  // 綜合驗證函數
  static async validateReservation(userId, dateStr, route, fromStop, toStop) {
    const errors = [];

    if (this.isPastDate(dateStr)) {
      errors.push('無法預約過去日期');
    }

    if (this.isNoServiceDate(dateStr)) {
      errors.push('該日期為停駛日，無法預約');
    }

    if (!this.isWithinBookingWindow(dateStr)) {
      errors.push(`只能預約未來 ${RESERVATION_RULES.MAX_DAYS_AHEAD} 天內的班次`);
    }

    if (this.isAfterDeadline(dateStr)) {
      errors.push(`今日預約已截止（${RESERVATION_RULES.DAILY_DEADLINE}）`);
    }

    // 方案B核心規則：每天只能預約1個班次
    if (this.hasExistingReservation(userId, dateStr)) {
      errors.push('每天只能預約一個班次，您當天已有預約');
    }

    // 檢查容量
    const isFull = await this.isRouteFull(dateStr, route);
    if (isFull) {
      errors.push('該班次已額滿');
    }

    // 檢查站點
    if (!this.validateStops(route, fromStop, toStop)) {
      errors.push('站點選擇無效');
    }

    return {
      isValid: errors.length === 0,
      errors: errors
    };
  }
}

// 錯誤顯示輔助函數
function showError(message) {
  document.getElementById('holidayNotice').style.display = 'block';
  document.getElementById('holidayNotice').textContent = message;
  document.getElementById('selectedDate').style.display = 'none';
  resetSelection();
}

function resetSelection() {
  selectedDate = null;
  selectedRoute = null;
  document.getElementById('routeSection').style.display = 'none';
  document.getElementById('stopSection').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
}

// 頁面載入時初始化
window.addEventListener('load', init);
</script>
</body>
</html>
