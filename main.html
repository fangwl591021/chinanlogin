/*****************************************************
 * 🚌 穿山甲專車 後端 API v4.0
 * 支援功能：
 * - 註冊檢查（check）
 * - 查詢預約紀錄（reservations）
 * - 查詢停駛／公休日（calendar）
 * - 預約寫入（reserve）
 * - 取消預約（cancel）
 * --------------------------------------------------
 * 🔧 欄位順序對應 A~K：
 * A:預約搭車日期 | B:姓名 | C:手機 | D:路線方向
 * E:上車站 | F:下車站 | G:時間戳記
 * H:狀態 | I:取消時間 | J:簽到(Y/N) | K:LINE用戶ID
 *****************************************************/

const SHEET_ID = '19zDueZCpq-qJsZsMVq4hSZh2BZrZv7pfQxMk5PTy4s4';
const USER_SHEET = '註冊人資料';
const RESERVE_SHEET = '預約資料';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';

const MASTER_ADMINS = [
  'U84b2e88d818b98575f45fcf14a380517',
  'Ue7a07fe317565389fbf4479172088f87'
];

/* =======================================================
   主入口
======================================================= */
function doGet(e) {
  try {
    const mode = e.parameter.mode || 'ping';
    switch (mode) {
      case 'check': return checkUser(e);
      case 'reservations': return getReservations(e);
      case 'calendar': return getCalendarEvents(e);
      case 'ping': default:
        return output({ status: 'ok', message: '穿山甲專車 API 運作中', time: new Date().toISOString() });
    }
  } catch (err) {
    return output({ status: 'error', message: err.message });
  }
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    switch (data.type) {
      case 'register': return registerUser(data);
      case 'reserve': return reserveTrip(data);
      case 'cancel': return cancelReservation(data);
      default:
        return output({ status: 'error', message: '未知的 POST 請求類型: ' + data.type });
    }
  } catch (err) {
    return output({ status: 'error', message: 'POST 錯誤: ' + err.message });
  }
}

/* =======================================================
   檢查註冊狀態
======================================================= */
function checkUser(e) {
  const userId = e.parameter.userId;
  if (!userId) return output({ status: 'error', message: '缺少 userId' });

  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(USER_SHEET);
  const rows = sheet.getDataRange().getValues();
  const row = rows.find(r => r[0] === userId);

  if (row) {
    const user = {
      userId: row[0],
      name: row[1],
      studentId: row[2],
      department: row[3],
      phone: row[4] || '',
    };
    const isAdmin = MASTER_ADMINS.includes(userId);
    return output({ status: 'success', registered: true, isAdmin, user });
  } else {
    return output({ status: 'success', registered: false });
  }
}

/* =======================================================
   查詢預約紀錄
======================================================= */
function getReservations(e) {
  const userId = e.parameter.userId;
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(RESERVE_SHEET);
  const values = sheet.getDataRange().getValues();

  const list = values
    .filter(r => r[10] === userId && r[7] !== '已取消') // 過濾取消紀錄
    .map(r => ({
      date: r[0],
      name: r[1],
      phone: r[2],
      route: r[3],
      fromStop: r[4],
      toStop: r[5],
      timestamp: r[6],
      status: r[7],
      cancelTime: r[8],
      signed: r[9],
      userId: r[10]
    }));

  return output({ status: 'success', reservations: list });
}

/* =======================================================
   查詢 Google Calendar 停駛／公休
======================================================= */
function getCalendarEvents(e) {
  try {
    const calendarId = e.parameter.calendarId || CALENDAR_ID;
    const start = new Date(e.parameter.start);
    const end = new Date(e.parameter.end);
    const cal = CalendarApp.getCalendarById(calendarId);
    const events = cal.getEvents(start, end);

    const list = events.map(ev => ({
      date: Utilities.formatDate(ev.getStartTime(), 'Asia/Taipei', 'yyyy-MM-dd'),
      title: ev.getTitle(),
      allDay: ev.isAllDayEvent(),
    })).filter(e => e.title.includes('停駛') || e.title.includes('公休'));

    return output({ status: 'success', events: list });
  } catch (err) {
    return output({ status: 'error', message: '讀取行事曆錯誤: ' + err.message });
  }
}

/* =======================================================
   寫入預約
======================================================= */
function reserveTrip(data) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheetByName(RESERVE_SHEET);

    const newRow = [
      data.date,
      data.name,
      data.phone || '',
      `${data.route} | ${getRouteTime(data.route)}`,
      data.fromStop,
      data.toStop,
      Utilities.formatDate(new Date(), 'Asia/Taipei', 'yyyy-MM-dd HH:mm:ss'),
      '已預約',
      '',
      'N',
      data.userId
    ];

    sheet.appendRow(newRow);
    return output({ status: 'success', message: '預約成功', data: newRow });
  } catch (err) {
    return output({ status: 'error', message: '寫入失敗: ' + err.message });
  }
}

/* =======================================================
   取消預約（🔴 新增）
======================================================= */
function cancelReservation(data) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheetByName(RESERVE_SHEET);
    const values = sheet.getDataRange().getValues();

    const idx = values.findIndex(r => 
      r[10] === data.userId && r[0] === data.date && r[3].startsWith(data.route)
    );

    if (idx === -1) {
      return output({ status: 'error', message: '找不到符合的預約資料' });
    }

    const cancelTime = Utilities.formatDate(new Date(), 'Asia/Taipei', 'yyyy-MM-dd HH:mm:ss');
    sheet.getRange(idx + 1, 8).setValue('已取消'); // H 欄 狀態
    sheet.getRange(idx + 1, 9).setValue(cancelTime); // I 欄 取消時間

    return output({ status: 'success', message: '已成功取消預約', date: data.date, route: data.route });

  } catch (err) {
    return output({ status: 'error', message: '取消失敗: ' + err.message });
  }
}

/* =======================================================
   工具函式
======================================================= */
function getRouteTime(route) {
  const routeTimes = {
    'A1': '22:00-22:30 暨大→埔里總站',
    'B1': '22:30-23:00 埔里總站→暨大',
    'A2': '23:00-23:30 暨大→埔里總站',
    'B2': '23:30-24:00 埔里總站→暨大'
  };
  return routeTimes[route] || '';
}

function output(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
