<!DOCTYPE html>
<html lang="zh-Hant">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>ç©¿å±±ç”²å°ˆè»Šé ç´„</title>
Â  <style>
Â  Â  body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
Â  Â  header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; }
Â  Â  .card { background:#fff; margin:16px; border-radius:8px; padding:16px; box-shadow:0 0 5px rgba(0,0,0,0.1); }

Â  Â  /* æŒ‰éˆ• */
Â  Â  input, select { width:100%; padding:10px; margin-top:8px; border-radius:6px; border:1px solid #ccc; font-size:16px; }
Â  Â  button { width:100%; background:#3c8050; color:#fff; border:none; padding:12px; border-radius:6px; font-size:18px; font-weight:bold; margin-top:12px; cursor:pointer; position: relative; }
Â  Â  button:disabled { background:#aaa; cursor:not-allowed; }
Â  Â  button.loading { background:#2d6140; color: transparent; }
Â  Â  button.loading::after {
Â  Â  Â  content: ''; position: absolute; width: 20px; height: 20px; top: 50%; left: 50%;
Â  Â  Â  margin: -10px 0 0 -10px; border: 2px solid #ffffff; border-radius:50%;
Â  Â  Â  border-top-color: transparent; animation: spin 1s linear infinite;
Â  Â  }
Â  Â  @keyframes spin { to { transform: rotate(360deg); } }

Â  Â  /* æç¤º */
Â  Â  .notice { padding:10px; margin-top:10px; border-radius:6px; }
Â  Â  .notice.error { background:#fdecea; color:#b71c1c; border:1px solid #f5c2c7; }
Â  Â  .notice.success { background:#e8f5e9; color:#2e7d32; border:1px solid #81c784; }

Â  Â  /* æœˆæ›† */
Â  Â  .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap:3px; text-align:center; font-size:13px; }
Â  Â  .calendar-header { padding:6px 0; font-weight:bold; background:#f0f0f0; border-radius:3px; font-size:12px; }
Â  Â  .calendar-day { padding:4px 0; border-radius:4px; background:#fff; border:1px solid #e0e0e0; cursor:pointer; min-height:30px; display:flex; flex-direction:column; justify-content:center; }
Â  Â  .calendar-day:hover { background:#e8f5e9; }
Â  Â  .calendar-day.no-service { background:#ffe6e6; color:#999; cursor:not-allowed; }
Â  Â  .calendar-day.selected { background:#3c8050; color:#fff; font-weight:bold; }
Â  Â  .calendar-day.other-month { color:#ccc; }
Â  Â  .calendar-day.today { border:2px solid #3c8050; }
Â  Â  .calendar-day small { font-size:9px; }

Â  Â  /* ç­æ¬¡æŒ‰éˆ• */
Â  Â  #routeButtons { display:flex; flex-wrap:wrap; gap:4px; justify-content:space-between; margin: 0 -2px; }
Â  Â  .route-btn { flex: 0 0 calc(45% - 4px); margin: 0 1px; padding: 4px 2px; border-radius:6px; text-align:left; border:1px solid #ddd; font-size:12px; cursor:pointer; transition:0.2s; min-height:80px; display:flex; align-items:center; background:#fff; color:#000; box-sizing: border-box; }
Â  Â  .route-btn.A1, .route-btn.B1 { border-color:#4caf50; }
Â  Â  .route-btn.A2, .route-btn.B2 { border-color:#4285f4; }
Â  Â  .route-btn.full { background:#f5f5f5; color:#999; border-color:#ccc; cursor:not-allowed; }
Â  Â  .route-btn.selected { color:#fff !important; }
Â  Â  .route-btn.selected.A1, .route-btn.selected.B1 { background:#2e7d32; border-color:#2e7d32; }
Â  Â  .route-btn.selected.A2, .route-btn.selected.B2 { background:#1a73e8; border-color:#1a73e8; }
Â  Â  .route-content { display: flex; flex-direction: column; gap: 2px; width: 90%; padding: 0 2px; }
Â  Â  .route-time { font-weight: bold; font-size: 14px; line-height: 1.2; }
Â  Â  .route-direction { font-size: 14px; line-height: 1.2; margin: 1px 0; }
Â  Â  .route-seats { font-size: 14px; color: #666; line-height: 1.2; }
Â  Â  .route-btn.selected .route-time, .route-btn.selected .route-direction, .route-btn.selected .route-seats { color: #fff !important; }

Â  Â  .route-section { display: none; }
Â  Â  .loading-state { text-align: center; padding: 20px; color: #666; }

Â  Â  /* æ–°çš„æ¨£å¼ - ç¬¦åˆæ‚¨æä¾›çš„æ ¼å¼ */
Â  Â  .user-section {Â 
Â  Â  Â  margin-bottom: 20px;Â 
Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  .user-name {
Â  Â  Â  font-size: 18px;
Â  Â  Â  font-weight: bold;
Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  color: #333;
Â  Â  }
Â  Â  .user-info {
Â  Â  Â  font-size: 14px;
Â  Â  Â  color: #666;
Â  Â  Â  margin-bottom: 15px;
Â  Â  }
Â  Â  .date-section {
Â  Â  Â  text-align: center;
Â  Â  Â  margin: 20px 0;
Â  Â  Â  font-weight: bold;
Â  Â  Â  color: #333;
Â  Â  Â  font-size: 16px;
Â  Â  }
Â  Â  .reservation-card {
Â  Â  Â  background: #fff;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  padding: 0;
Â  Â  Â  margin: 20px 0;
Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
Â  Â  Â  border: 1px solid #e0e0e0;
Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  .reservation-header {
Â  Â  Â  background: #3c8050;
Â  Â  Â  color: white;
Â  Â  Â  padding: 12px 15px;
Â  Â  Â  font-weight: bold;
Â  Â  Â  font-size: 18px;
Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  .reservation-body {
Â  Â  Â  padding: 15px;
Â  Â  }
Â  Â  .reservation-line {
Â  Â  Â  display: flex;
Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  font-size: 14px;
Â  Â  Â  line-height: 1.4;
Â  Â  }
Â  Â  .reservation-label {
Â  Â  Â  font-weight: bold;
Â  Â  Â  color: #333;
Â  Â  Â  min-width: 80px;
Â  Â  }
Â  Â  .reservation-value {
Â  Â  Â  color: #000;
Â  Â  Â  flex: 1;
Â  Â  }
Â  Â  .divider {
Â  Â  Â  height: 1px;
Â  Â  Â  background: #e0e0e0;
Â  Â  Â  margin: 15px 0;
Â  Â  }
Â  Â  .calendar-btn {
Â  Â  Â  background: #3c8050;
Â  Â  Â  color: white;
Â  Â  Â  border: none;
Â  Â  Â  padding: 12px;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  font-size: 16px;
Â  Â  Â  font-weight: bold;
Â  Â  Â  margin: 10px 0;
Â  Â  Â  cursor: pointer;
Â  Â  Â  width: 100%;
Â  Â  }
Â  </style>
</head>
<body>
Â  <header>ç©¿å±±ç”²å°ˆè»Šé ç´„</header>

Â  <div class="card">
Â  Â  Â  Â  <div id="userInfo" class="user-section">
Â  Â  Â  <div class="loading-state">â³ ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
Â  Â  </div>

Â  Â  Â  Â  <div id="currentReservationCard" style="display:none;">
Â  Â  Â  <div class="date-section">é¸æ“‡æ­ä¹˜æ—¥æœŸ</div>
Â  Â  Â  <button class="calendar-btn" onclick="toggleCalendar()">ğŸ“… æ‰“é–‹æœˆæ›†</button>

Â  Â  Â  <div class="divider"></div>

Â  Â  Â  <div class="reservation-card">
Â  Â  Â  Â  <div class="reservation-header">ç©¿å±±ç”²å°ˆè»Šæ–°é ç´„</div>
Â  Â  Â  Â  <div class="reservation-body">
Â  Â  Â  Â  Â  <div class="reservation-line">
Â  Â  Â  Â  Â  Â  <span class="reservation-label">æ—¥æœŸï¼š</span>
Â  Â  Â  Â  Â  Â  <span class="reservation-value" id="reservationDate">å°šæœªé ç´„</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="reservation-line">
Â  Â  Â  Â  Â  Â  <span class="reservation-label">ç­æ¬¡ï¼š</span>
Â  Â  Â  Â  Â  Â  <span class="reservation-value" id="reservationRoute">å°šæœªé¸æ“‡ç­æ¬¡</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="reservation-line">
Â  Â  Â  Â  Â  Â  <span class="reservation-label">å§“åï¼š</span>
Â  Â  Â  Â  Â  Â  <span class="reservation-value" id="reservationName">è¼‰å…¥ä¸­...</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="reservation-line">
Â  Â  Â  Â  Â  Â  <span class="reservation-label">é›»è©±ï¼š</span>
Â  Â  Â  Â  Â  Â  <span class="reservation-value" id="reservationPhone">è¼‰å…¥ä¸­...</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="reservation-line">
Â  Â  Â  Â  Â  Â  <span class="reservation-label">ä¸Šè»Šï¼š</span>
Â  Â  Â  Â  Â  Â  <span class="reservation-value" id="reservationFrom">å°šæœªé¸æ“‡</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="reservation-line">
Â  Â  Â  Â  Â  Â  <span class="reservation-label">ä¸‹è»Šï¼š</span>
Â  Â  Â  Â  Â  Â  <span class="reservation-value" id="reservationTo">å°šæœªé¸æ“‡</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="reservationFormSection" style="display:none;">
Â  Â  Â  <div id="result" style="margin-top:10px;"></div>

Â  Â  Â  <div id="calendarContainer" style="display:none;margin-top:10px;">
Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
Â  Â  Â  Â  Â  <button onclick="changeMonth(-1)" style="width:auto; padding:5px 10px;">â—€ ä¸Šå€‹æœˆ</button>
Â  Â  Â  Â  Â  <h3 id="calendarTitle" style="margin:0; font-size:16px;"></h3>
Â  Â  Â  Â  Â  <button onclick="changeMonth(1)" style="width:auto; padding:5px 10px;">ä¸‹å€‹æœˆ â–¶</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="calendar" class="calendar"></div>
Â  Â  Â  </div>
Â  Â  Â  <div id="selectedDate" class="notice success" style="display:none;"></div>
Â  Â  Â  <div id="holidayNotice" class="notice error" style="display:none;"></div>

Â  Â  Â  <div id="routeSection" class="route-section">
Â  Â  Â  Â  <label>è«‹é¸æ“‡æ­ä¹˜ç­æ¬¡ *</label>
Â  Â  Â  Â  <div id="routeButtons"></div>
Â  Â  Â  Â  <label>ä¸‹è»Šç«™ *</label>
Â  Â  Â  Â  <select id="toStop"><option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option></select>
Â  Â  Â  Â  <button id="submitBtn" onclick="submitForm()">é€å‡ºé ç´„</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let selectedDate = null, selectedRoute = null;
let userData = null, noServiceDates = {};
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let existingReservations = [];

const stopsOutbound = ["è¡Œæ”¿å¤§æ¨“","ä¸­é¤å»³","ç§‘æŠ€å­¸é™¢","å­¸äººæœƒé¤¨","ä¸­åŸ","ä¸‹åŸ","åªé ‚","æ„›è˜­æ©‹","å¤§æˆåœ‹å°","ä¸­å±±å®‰ä¸ƒè¡—å£","æ¦®æ°‘è¨ºæ‰€","åŸ”é‡Œé…’å» ","åŸ”é‡Œç¸½ç«™"];
const stopsReturn = [...stopsOutbound].reverse();

const routeTimes = {
Â  'A1': { time: '22:00-22:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™' },
Â  'B1': { time: '22:30-23:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§' },
Â  'A2': { time: '23:00-23:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™' },
Â  'B2': { time: '23:30-24:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§' }
};

// === è¼‰å…¥ç¾æœ‰é ç´„ - ä¿®å¾©ç‰ˆæœ¬ ===
async function loadExistingReservations() {
Â  try {
Â  Â  console.log('é–‹å§‹è¼‰å…¥ç¾æœ‰é ç´„ï¼Œç”¨æˆ¶ID:', userData.userId);
Â  Â  const res = await fetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`);
Â  Â  const result = await res.json();
Â  Â Â 
Â  Â  console.log('APIå›æ‡‰:', result);

Â  Â  // ç¢ºä¿åªè™•ç†æœ‰æ•ˆçš„é™£åˆ—
Â  Â  if (result.success && Array.isArray(result.reservations)) {
Â  Â  Â  // ä¿®æ­£ï¼šå°‡APIçµæœå­˜å…¥ existingReservations
Â  Â  Â  existingReservations = result.reservations;
Â  Â  Â  console.log('æˆåŠŸè¼‰å…¥é ç´„:', existingReservations);
Â  Â  Â  renderCurrentReservationCard();
Â  Â  } else {
Â  Â  Â  console.log('æ²’æœ‰ç¾æœ‰é ç´„æˆ–APIå›å‚³ç©ºè³‡æ–™');
Â  Â  Â  existingReservations = []; // ç¢ºä¿ç‚ºç©ºé™£åˆ—
Â  Â  Â  showEmptyReservationCard();
Â  Â  }
Â  } catch (error) {
Â  Â  console.error('è¼‰å…¥é ç´„å¤±æ•—:', error);
Â  Â  existingReservations = []; // ç¢ºä¿ç‚ºç©ºé™£åˆ—
Â  Â  showEmptyReservationCard();
Â  }
}

// === é¡¯ç¤ºç•¶å‰é ç´„å¡ç‰‡ ===
function renderCurrentReservationCard() {
Â  const section = document.getElementById('currentReservationCard');
Â  const formSection = document.getElementById('reservationFormSection');

Â  console.log('ç¾æœ‰é ç´„æ•¸é‡:', existingReservations.length);
Â Â 
Â  if (existingReservations.length === 0) {
Â  Â  showEmptyReservationCard();
Â  Â  return;
Â  }

Â  const today = formatDateToLocal(new Date());
Â  console.log('ä»Šå¤©æ—¥æœŸ:', today);

Â  // éæ¿¾å‡ºæœ‰æ•ˆçš„é ç´„ï¼ˆä»Šå¤©åŠä»¥å¾Œçš„æ—¥æœŸï¼Œä¸”ç‹€æ…‹ä¸æ˜¯å–æ¶ˆï¼‰
Â  const activeReservations = existingReservations
Â  Â  .filter(reservation => {
Â  Â  Â  // é ç´„æ—¥æœŸæ ¼å¼æ‡‰ç‚º YYYY-MM-DD
Â  Â  Â  const reservationDate = (reservation.date || '').substring(0, 10);
Â  Â  Â  // ä½¿ç”¨ date.localeCompare(today) ç¢ºä¿æ¯”è¼ƒæœ‰æ•ˆ
Â  Â  Â  const isFutureOrToday = reservationDate.localeCompare(today) >= 0; 
Â  Â  Â  // ç‹€æ…‹åˆ¤æ–·å¯ä»¥æ›´å½ˆæ€§ï¼Œé€™è£¡å‡è¨­ 'å–æ¶ˆ' æˆ– 'cancelled' æ˜¯ç„¡æ•ˆ
Â  Â  Â  const isActive = (reservation.status || 'é ç´„æˆåŠŸ') !== 'å–æ¶ˆ' && (reservation.status || 'é ç´„æˆåŠŸ') !== 'cancelled'; 

Â  Â  Â  // ä¿®æ­£ï¼šå¦‚æœé ç´„æ—¥æœŸç„¡æ•ˆæˆ–éå»ï¼Œå‰‡å¿½ç•¥
Â  Â  Â  if (!reservationDate) return false;
Â  Â  Â  
Â  Â  Â  console.log(`é ç´„æ—¥æœŸ: ${reservationDate}, æ˜¯å¦æœªä¾†/ä»Šå¤©: ${isFutureOrToday}, æ˜¯å¦æœ‰æ•ˆ: ${isActive}`);
Â  Â  Â  return isFutureOrToday && isActive;
Â  Â  })
Â  Â  // æ’åºä»¥æ‰¾åˆ°æœ€æ¥è¿‘çš„æ—¥æœŸ
Â  Â  .sort((a, b) => a.date.localeCompare(b.date));
Â Â 
Â  console.log('æœ‰æ•ˆé ç´„:', activeReservations);

Â  if (activeReservations.length === 0) {
Â  Â  showEmptyReservationCard();
Â  Â  return;
Â  }
Â Â 
Â  // é¡¯ç¤ºæœ€è¿‘çš„é ç´„
Â  const latestReservation = activeReservations[0];
Â  console.log('é¡¯ç¤ºçš„é ç´„:', latestReservation);
Â Â 
Â  // æ›´æ–°å¡ç‰‡å…§å®¹
Â  // ä¿®æ­£ï¼šå°‡æ—¥æœŸæ ¼å¼åŒ–ï¼Œä¸¦åŠ ä¸Šé è¨­çš„æ™‚é–“ (å¦‚æ‚¨åœ–ç‰‡æ‰€ç¤º)
Â  document.getElementById('reservationDate').textContent = latestReservation.date.substring(0, 10) + ' 08:00:00'; 
Â Â 
Â  // è§£æè·¯ç·šè³‡è¨Š
Â  let routeDisplay = 'å°šæœªé¸æ“‡ç­æ¬¡';
Â  if (latestReservation.routeName) {
Â  Â  routeDisplay = latestReservation.routeName;
Â  } else if (latestReservation.route) {
Â  Â  const routeInfo = routeTimes[latestReservation.route] || { time: '', direction: '' };
Â  Â  routeDisplay = `${latestReservation.route} | ${routeInfo.time} ${routeInfo.direction}`;
Â  }
Â  document.getElementById('reservationRoute').textContent = routeDisplay;
Â Â 
Â  document.getElementById('reservationName').textContent = latestReservation.name || userData.name;
Â  document.getElementById('reservationPhone').textContent = latestReservation.phone || userData.phone || '';
Â  // ä¿®æ­£ï¼šä¸Šè»Šé»æ‡‰æ ¹æ“šç­æ¬¡æ–¹å‘è‡ªå‹•æ±ºå®šï¼Œä½†ä»¥é ç´„è³‡æ–™ç‚ºä¸»
Â  const defaultFrom = latestReservation.route.includes('A') ? 'è¡Œæ”¿å¤§æ¨“' : (latestReservation.route.includes('B') ? 'åŸ”é‡Œç¸½ç«™' : 'å°šæœªé¸æ“‡');
Â  document.getElementById('reservationFrom').textContent = latestReservation.fromStop || defaultFrom;
Â  document.getElementById('reservationTo').textContent = latestReservation.toStop || 'å°šæœªé¸æ“‡';
Â Â 
Â  section.style.display = 'block';
Â  formSection.style.display = 'none';

Â  console.log('é ç´„å¡ç‰‡é¡¯ç¤ºå®Œæˆ');
}

// === é¡¯ç¤ºç©ºé ç´„å¡ç‰‡ ===
function showEmptyReservationCard() {
Â  const section = document.getElementById('currentReservationCard');
Â  const formSection = document.getElementById('reservationFormSection');
Â Â 
Â  console.log('é¡¯ç¤ºç©ºé ç´„å¡ç‰‡');
Â Â 
Â  // é¡¯ç¤ºåŸºæœ¬è³‡è¨Šä½†æ²’æœ‰å…·é«”é ç´„å…§å®¹
Â  document.getElementById('reservationDate').textContent = 'å°šæœªé ç´„';
Â  document.getElementById('reservationRoute').textContent = 'å°šæœªé¸æ“‡ç­æ¬¡';
Â  // ç¢ºä¿ userData å·²ç¶“è¼‰å…¥
Â  document.getElementById('reservationName').textContent = userData ? userData.name : 'è¼‰å…¥ä¸­...';
Â  document.getElementById('reservationPhone').textContent = userData ? (userData.phone || '') : 'è¼‰å…¥ä¸­...';
Â  document.getElementById('reservationFrom').textContent = 'å°šæœªé¸æ“‡';
Â  document.getElementById('reservationTo').textContent = 'å°šæœªé¸æ“‡';
Â Â 
Â  section.style.display = 'block';
Â  formSection.style.display = 'block';
}

// ğŸ§­ åˆå§‹åŒ–
async function init() {
Â  try {
Â  Â  console.log('é–‹å§‹åˆå§‹åŒ–...');
Â  Â  await liff.init({ liffId: "2006590746-KJodGOda" });
Â  Â  if (!liff.isLoggedIn()) {
Â  Â  Â  console.log('æœªç™»å…¥ï¼Œé–‹å§‹ç™»å…¥...');
Â  Â  Â  return liff.login();
Â  Â  }
Â  Â Â 
Â  Â  console.log('å·²ç™»å…¥ï¼Œç²å–ç”¨æˆ¶è³‡æ–™...');
Â  Â  const profile = await liff.getProfile();
Â  Â  console.log('LINE Profile:', profile);
Â  Â Â 
Â  Â  const res = await fetch(`${WORKER_URL}?check=${profile.userId}`);
Â  Â  const result = await res.json();
Â  Â  console.log('æª¢æŸ¥ç”¨æˆ¶è¨»å†Šçµæœ:', result);
Â  Â Â 
Â  Â  if (!result.registered) {
Â  Â  Â  console.log('ç”¨æˆ¶æœªè¨»å†Šï¼Œè·³è½‰åˆ°è¨»å†Šé é¢');
Â  Â  Â  return window.location.href = 'register.html';
Â  Â  }
Â  Â Â 
Â  Â  userData = result.user;
Â  Â  console.log('ç”¨æˆ¶è³‡æ–™:', userData);
Â  Â Â 
Â  Â  // ã€ä¿®æ­£ã€‘æ›´æ–°ä½¿ç”¨è€…è³‡è¨Šç‚ºæ‚¨æä¾›çš„æ ¼å¼
Â  Â  document.getElementById('userInfo').innerHTML = `
Â  Â  Â  <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">ç©¿å±±ç”²å°ˆè»Šé ç´„</div>
Â  Â  Â  <div class="user-name"><strong>${userData.name}</strong></div>
Â  Â  Â  <div class="user-info">${userData.department} | ${userData.studentId}</div>
Â  Â  `;
Â  Â Â 
Â  Â  // è¼‰å…¥é ç´„è³‡æ–™
Â  Â  await loadExistingReservations();
Â  Â  await loadNoServiceDates();
Â  Â Â 
Â  Â  console.log('åˆå§‹åŒ–å®Œæˆ');
Â  Â Â 
Â  } catch (e) {
Â  Â  console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', e);
Â  Â  // é›¢ç·šæ¨¡å¼ä½¿ç”¨ã€æ–¹è¬éš†ã€‘ç¤ºä¾‹æ•¸æ“š
Â  Â  userData = {Â 
Â  Â  Â  userId: 'Ue7a07fe317565389fbf4479172088f87',Â 
Â  Â  Â  name: 'æ–¹è¬éš†',Â 
Â  Â  Â  department: 'è§€å…‰ä¼‘é–’èˆ‡é¤æ—…ç®¡ç†å­¸ç³»',Â 
Â  Â  Â  studentId: '114320553',Â 
Â  Â  Â  phone: '927136847'Â 
Â  Â  };
Â  Â Â 
Â  Â  // ã€ä¿®æ­£ã€‘æ›´æ–°ä½¿ç”¨è€…è³‡è¨Šç‚ºæ‚¨æä¾›çš„æ ¼å¼
Â  Â  document.getElementById('userInfo').innerHTML = `
Â  Â  Â  <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">ç©¿å±±ç”²å°ˆè»Šé ç´„</div>
Â  Â  Â  <div class="user-name"><strong>${userData.name}</strong></div>
Â  Â  Â  <div class="user-info">${userData.department} | ${userData.studentId}</div>
Â  Â  `;
Â  Â Â 
Â  Â  // ã€ä¿®æ­£ã€‘ä½¿ç”¨æ¸¬è©¦é ç´„æ•¸æ“šï¼ˆåŒ¹é…è©¦ç®—è¡¨ä¸Šæ–¹è¬éš†çš„å…©ç­†é ç´„ï¼‰
Â  Â  existingReservations = [
Â  Â  Â  { // 2025-10-25 18:00
Â  Â  Â  Â  date: '2025-10-25',
Â  Â  Â  Â  route: 'B2',
Â  Â  Â  Â  routeName: 'B2 | 23:30-24:00 åŸ”é‡Œç¸½ç«™â†’æš¨å¤§',
Â  Â  Â  Â  name: 'æ–¹è¬éš†',
Â  Â  Â  Â  phone: '927136847',
Â  Â  Â  Â  fromStop: 'åŸ”é‡Œç¸½ç«™',
Â  Â  Â  Â  toStop: 'å­¸äººæœƒé¤¨',
Â  Â  Â  Â  status: 'é ç´„æˆåŠŸ'
Â  Â  Â  },
Â  Â  Â  { // 2025-10-21 16:30 - æœ€æ—©çš„ä¸€ç­†é ç´„
Â  Â  Â  Â  date: '2025-10-21',
Â  Â  Â  Â  route: 'A1',
Â  Â  Â  Â  routeName: 'A1 | 22:00-22:30 æš¨å¤§â†’åŸ”é‡Œç¸½ç«™',
Â  Â  Â  Â  name: 'æ–¹è¬éš†',
Â  Â  Â  Â  phone: '927136847',
Â  Â  Â  Â  fromStop: 'è¡Œæ”¿å¤§æ¨“',
Â  Â  Â  Â  toStop: 'åŸ”é‡Œç¸½ç«™',
Â  Â  Â  Â  status: 'é ç´„æˆåŠŸ'
Â  Â  Â  }
Â  Â  ];
Â  Â Â 
Â  Â  renderCurrentReservationCard();
Â  Â  await loadNoServiceDates();
Â  }
}

window.addEventListener('load', init);

// ğŸ—“ è¼‰å…¥åœé§› (æ­¤å‡½å¼é‚è¼¯ä¸è®Š)
async function loadNoServiceDates() {
Â  try {
Â  Â  const start = formatDateToLocal(new Date(currentYear, currentMonth - 1, 1));
Â  Â  const end = formatDateToLocal(new Date(currentYear, currentMonth + 2, 0));
Â  Â  const res = await fetch(`${WORKER_URL}?mode=calendar&start=${start}&end=${end}&calendarId=${encodeURIComponent(CALENDAR_ID)}`);
Â  Â  const result = await res.json();
Â  Â  noServiceDates = {};
Â  Â  if (Array.isArray(result.holidays)) result.holidays.forEach(d => noServiceDates[d.substring(0,10)] = true);
Â  } catch (e) {
Â  Â  console.error('ğŸš¨ è¼‰å…¥åœé§›æ—¥æœŸå¤±æ•—:', e);
Â  Â  noServiceDates = {};
Â  }
}

// ğŸ“… æœˆæ›† (æ­¤å€å¡Šé‚è¼¯ä¸è®Š)
async function toggleCalendar() {
Â  const c = document.getElementById('calendarContainer');
Â  if (c.style.display === 'none') {Â 
Â  Â  await renderCalendar();Â 
Â  Â  c.style.display = 'block';Â 
Â  Â  document.querySelector('.calendar-btn').textContent = 'ğŸ“… é—œé–‰æœˆæ›†';
Â  } else {Â 
Â  Â  c.style.display = 'none';
Â  Â  document.querySelector('.calendar-btn').textContent = 'ğŸ“… æ‰“é–‹æœˆæ›†';
Â  }
}

async function changeMonth(d) {
Â  currentMonth += d;
Â  if (currentMonth < 0) { currentMonth = 11; currentYear--; }
Â  else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
Â  await loadNoServiceDates();Â 
Â  await renderCalendar();
}

async function renderCalendar() {
Â  const cal = document.getElementById('calendar');
Â  const title = document.getElementById('calendarTitle');
Â  const monthNames = ['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
Â  title.textContent = `${currentYear}å¹´ ${monthNames[currentMonth]}`;
Â Â 
Â  cal.innerHTML = '';

Â  ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d=>{
Â  Â  const h=document.createElement('div');h.className='calendar-header';h.textContent=d;cal.appendChild(h);
Â  });

Â  const today = new Date();
Â  const firstDay = new Date(currentYear, currentMonth, 1);
Â  const lastDay = new Date(currentYear, currentMonth + 1, 0);
Â  const startWeekday = firstDay.getDay();
Â  const totalDays = lastDay.getDate();

Â  const prevLast = new Date(currentYear, currentMonth, 0).getDate();
Â  for (let i=startWeekday-1;i>=0;i--){
Â  Â  const e=document.createElement('div');
Â  Â  e.className='calendar-day other-month';
Â  Â  e.textContent=prevLast - i;
Â  Â  cal.appendChild(e);
Â  }

Â  for (let d=1; d<=totalDays; d++){
Â  Â  const date = new Date(currentYear, currentMonth, d);
Â  Â  const f = formatDateToLocal(date);
Â  Â  const e=document.createElement('div');
Â  Â  e.className='calendar-day';
Â  Â  const todayStr=formatDateToLocal(today);
Â  Â  if(f===todayStr) e.classList.add('today');
Â  Â  const isPast=date<today && f!==todayStr;
Â  Â  const isNo=noServiceDates[f];
Â  Â  if(isNo||isPast){
Â  Â  Â  e.classList.add('no-service');
Â  Â  Â  e.innerHTML=`${d}<br><small>${isNo?'åœé§›':'å·²éæœŸ'}</small>`;
Â  Â  } else {
Â  Â  Â  e.textContent=d;
Â  Â  Â  e.onclick=()=>selectDate(f);
Â  Â  }
Â  Â  if(selectedDate===f) e.classList.add('selected');
Â  Â  cal.appendChild(e);
Â  }

Â  const remain=42-(startWeekday+totalDays);
Â  for(let d=1;d<=remain;d++){
Â  Â  const e=document.createElement('div');
Â  Â  e.className='calendar-day other-month';
Â  Â  e.textContent=d;
Â  Â  cal.appendChild(e);
Â  }
}

function formatDateToLocal(date){
Â  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

async function selectDate(date){
Â  if(noServiceDates[date]){
Â  Â  document.getElementById('holidayNotice').style.display='block';
Â  Â  document.getElementById('holidayNotice').innerText=`ğŸš« ${date} ç‚ºåœé§›æ—¥`;
Â  Â  document.getElementById('selectedDate').style.display='none';
Â  Â  selectedDate=null;
Â  Â  document.getElementById('routeSection').style.display='none';
Â  Â  return;
Â  }
Â  selectedDate=date;
Â  document.getElementById('calendarContainer').style.display='none';
Â  document.getElementById('selectedDate').innerHTML=`âœ… å·²é¸æ“‡æ—¥æœŸï¼š${date}`;
Â  document.getElementById('selectedDate').style.display='block';
Â  document.getElementById('holidayNotice').style.display='none';
Â  document.getElementById('routeSection').style.display='block';
Â  document.querySelector('.calendar-btn').textContent = 'ğŸ“… æ‰“é–‹æœˆæ›†';
Â  loadSeatStatus();
}

// ğŸš ç­æ¬¡é¸æ“‡ (æ­¤å€å¡Šé‚è¼¯ä¸è®Š)
function loadSeatStatus(){
Â  const c=document.getElementById('routeButtons'); c.innerHTML='';
Â  ['A1','B1','A2','B2'].forEach(rid=>{
Â  Â  const info=routeTimes[rid];
Â  Â  const div=document.createElement('div');
Â  Â  div.className=`route-btn ${rid}`;
Â  Â  div.innerHTML=`<div class="route-content">
Â  Â  Â  <div class="route-time">${rid} ${info.time}</div>
Â  Â  Â  <div class="route-direction">${info.direction}</div>
Â  Â  Â  <div class="route-seats">å‰©é¤˜:6ä½</div>
Â  Â  </div>`;
Â  Â  div.onclick=()=>selectRoute(div,rid,info.direction);
Â  Â  c.appendChild(div);
Â  });
}

function selectRoute(btn,id,direction){
Â  selectedRoute=id;
Â  document.querySelectorAll('.route-btn').forEach(b=>b.classList.remove('selected'));
Â  btn.classList.add('selected');
Â  updateStops(direction);
}

function updateStops(direction){
Â  const toStop=document.getElementById('toStop');
Â  toStop.innerHTML='<option value="">è«‹é¸æ“‡ä¸‹è»Šç«™</option>';
Â  const isOut=direction.includes('æš¨å¤§â†’');
Â  const stops=isOut?stopsOutbound:stopsReturn;
Â  const from=isOut?'è¡Œæ”¿å¤§æ¨“':'åŸ”é‡Œç¸½ç«™';
Â  stops.filter(s=>s!==from).forEach(s=>{
Â  Â  const o=document.createElement('option');o.value=s;o.textContent=s;toStop.appendChild(o);
Â  });
}

// ğŸ“ é€å‡ºé ç´„ (æ­¤å‡½å¼é‚è¼¯ä¸è®Š)
async function submitForm(){
Â  const toStop=document.getElementById('toStop').value;
Â  const btn=document.getElementById('submitBtn');
Â  if(!selectedDate||!selectedRoute||!toStop){alert('è«‹å®Œæ•´é¸æ“‡æ—¥æœŸã€ç­æ¬¡èˆ‡ä¸‹è»Šç«™');return;}
Â  btn.disabled=true;btn.classList.add('loading');
Â  try{
Â  Â  const info=routeTimes[selectedRoute];
Â  Â  const data={
Â  Â  Â  type:'reserve',userId:userData.userId,name:userData.name,studentId:userData.studentId,
Â  Â  Â  department:userData.department,phone:userData.phone||'',
Â  Â  Â  route:selectedRoute,routeName:`${selectedRoute}|${info.time} ${info.direction}`,
Â  Â  Â  fromStop:selectedRoute.includes('A')?'è¡Œæ”¿å¤§æ¨“':'åŸ”é‡Œç¸½ç«™',toStop:toStop,date:selectedDate
Â  Â  };
Â  Â  const res=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
Â  Â  const result=await res.json();
Â  Â  if(result.status==='success'){
Â  Â  Â  document.getElementById('result').innerHTML=`<div class="notice success">âœ… é ç´„æˆåŠŸ<br>${selectedDate}ï½œ${selectedRoute} ${info.time}<br>${info.direction}</div>`;
Â  Â  Â  selectedDate=null;selectedRoute=null;
Â  Â  Â  document.getElementById('selectedDate').style.display='none';
Â  Â  Â  document.getElementById('routeSection').style.display='none';
Â  Â  Â  document.getElementById('toStop').innerHTML='<option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option>';
Â  Â  Â  // é‡æ–°è¼‰å…¥é ç´„è³‡æ–™
Â  Â  Â  await loadExistingReservations();
Â  Â  }else{
Â  Â  Â  document.getElementById('result').innerHTML=`<div class="notice error">âŒ é ç´„å¤±æ•—ï¼š${result.message||'è«‹ç¨å¾Œå†è©¦'}</div>`;
Â  Â  }
Â  }catch(e){
Â  Â  console.error('é ç´„éŒ¯èª¤:',e);
Â  Â  document.getElementById('result').innerHTML=`<div class="notice error">âŒ é ç´„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯</div>`;
Â  }finally{
Â  Â  btn.disabled=false;btn.classList.remove('loading');
Â  }
}
</script>
</body>
</html>
