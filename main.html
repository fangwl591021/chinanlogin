<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç©¿å±±ç”²å°ˆè»Šé ç´„ Pangolin Shuttle Reservation</title>
  <style>
    /* CSS æ¨£å¼ */
    body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
    header { 
      background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold;
      line-height: 1.3;
    }
    .en-text {
      display: block;
      font-size: 14px;
      color: #ffffff;
      margin-top: 2px;
    }
    .en-text-dark {
      display: block;
      font-size: 14px;
      color: #666666;
      margin-top: 2px;
    }
    #calendarBtn { 
      width:calc(100% - 32px); background:#3c8050; color:#fff; border:none; 
      padding:12px; border-radius:6px; font-size:16px; font-weight:bold; 
      margin:10px 16px; cursor:pointer; position: relative;
    }
    .loading-dots {
      display: inline-block;
      margin-left: 5px;
    }
    .loading-dots::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px;
      text-align: center;
      font-size: 13px;
      margin-bottom: 20px;
    }
    .calendar-header {
      padding: 8px 0;
      font-weight: bold;
      background: #27ACB2;
      border-radius: 3px;
      font-size: 12px;
    }
    .calendar-day {
      padding: 8px 0;
      min-height: 35px;
      border-radius: 4px;
      background: #fff;
      border: 1px solid #e0e0e0;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: background 0.2s;
    }
    .calendar-day:hover { background:#eaf5ea; }
    .calendar-day.disabled { 
      background:#f8f9fa; 
      color:#999; 
      cursor:not-allowed; 
    }
    .calendar-day.past { 
      background:#f5f5f5; 
      color:#ccc; 
      cursor:not-allowed; 
    }
    .calendar-day.selected { background:#3c8050; color:#fff; font-weight:bold; }
    .calendar-day.other-month { color:#ccc; }
    .carousel-container { padding: 16px; margin: 20px 0; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin: 20px 16px; }
    .carousel-title { 
      font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; text-align: center;
      line-height: 1.3;
    }
    .carousel { display: flex; overflow-x: auto; gap: 15px; padding: 10px 5px; scrollbar-width: none; -ms-overflow-style: none; }
    .carousel::-webkit-scrollbar { display: none; }
    .reservation-bubble { 
      min-width: 190px;
      background: white; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
      border: 1px solid #e0e0e0; 
      overflow: hidden; 
      flex-shrink: 0; 
    }
    .bubble-body { 
      padding: 15px; 
    }
    .bubble-line { 
      margin-bottom: 8px; 
      font-size: 13px; 
      line-height: 1.4; 
      display: flex; 
      justify-content: flex-start;
      text-align: left; 
    }
    .bubble-line strong { 
      color: #666; 
      min-width: 50px;
      margin-right: 8px;
    }
    .bubble-line span { 
      color: #333; 
      text-align: left;
      flex: 1; 
    }
    .bubble-header { 
      background: #27ACB2; color: white; padding: 12px 15px; font-weight: bold; font-size: 14px; text-align: center;
      line-height: 1.3;
    }
    .bubble-line:last-child { margin-bottom: 0; }
    .route-time { font-weight: bold; color: #333; }
    .bubble-footer { padding: 12px; border-top: 1px solid #f0f0f0; text-align: center; background: #fafafa; }
    .cancel-btn-small { 
      background: #ff4444; color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; padding: 8px 16px; font-weight: bold; transition: background 0.2s;
      line-height: 1.3;
    }
    .cancel-btn-small:hover { background: #cc0000; }
    .no-reservation { text-align: center; color: #666; padding: 40px 20px; background: white; border-radius: 8px; margin: 20px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .route-section { padding: 0 16px; margin: 20px 0; }
    .route-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
    .route-btn { 
      padding: 12px; 
      border: 2px solid #3c8050;
      border-radius: 8px; 
      background: white; 
      cursor: pointer; 
      text-align: center; 
      transition: all 0.2s;
      line-height: 1.3;
    }
    .route-btn:hover { 
      background: #eaf5ea;
    }
    /* ä¿®æ”¹ç¾æœ‰çš„ .route-btn.selected æ¨£å¼ */
    .route-btn.selected { 
      background: #3c8050;
      color: white !important;
    }

    /* é¸ä¸­ç‹€æ…‹ä¸‹çš„æ‰€æœ‰æ–‡å­—éƒ½è®Šæˆç™½è‰² */
    .route-btn.selected * {
      color: white !important;
    }

    /* è‹±æ–‡æ–‡å­—ç¨å¾®é€æ˜ä¸€é» */
    .route-btn.selected .route-direction span,
    .route-btn.selected div span {
      color: rgba(255, 255, 255, 0.8) !important;
    }
    .route-btn.disabled:hover { background: #f5f5f5 !important; }
    .route-direction { font-size: 12px; margin-top: 4px; }
    .stop-selector { padding: 0 16px; margin: 20px 0; }
    select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; margin-top: 8px; }
    .user-section { background: white; margin: 16px; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .user-name { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 5px; }
    .user-info { font-size: 14px; color: #666; }
    .submit-btn { 
      background: #3c8050; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin: 20px 16px; width: calc(100% - 32px);
      line-height: 1.3;
    }
    .submit-btn:hover { background: #2d6140; }
    .submit-btn:disabled { background: #ccc; cursor: not-allowed; }
    .notice { padding: 10px 16px; margin: 10px 16px; border-radius: 6px; }
    .notice.success { background: #e8f5e9; color: #2e7d32; border: 1px solid #81c784; }
    .notice.error { background: #fdecea; color: #b71c1c; border: 1px solid #f5c2c7; }
    .stop-section-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    .profile-warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 6px;
      padding: 12px;
      margin-top: 10px;
    }
    .profile-warning p {
      margin: 0 0 5px 0;
      color: #856404;
      font-size: 14px;
    }
    .profile-warning a {
      color: #007bff;
      text-decoration: underline;
      font-weight: bold;
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 480px) {
      .reservation-bubble {
        min-width: 160px !important;
      }
      
      .bubble-line {
        font-size: 12px !important;
      }
      
      .route-btn {
        padding: 10px 8px !important;
      }
      
      header {
        font-size: 20px !important;
        padding: 12px !important;
      }
    }

    @media (max-width: 360px) {
      header {
        font-size: 18px !important;
      }
      
      .user-name {
        font-size: 18px !important;
      }
      
      .carousel-title {
        font-size: 16px !important;
      }
    }

    /* ç„¡éšœç¤™è¨ªå•æ”¹é€² */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* æ–°å¢ï¼šæœªè¨»å†Šç”¨æˆ¶æ¨£å¼ */
    .unregistered-section {
      text-align: center;
      padding: 30px 20px;
      background: white;
      border-radius: 12px;
      margin: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .unregistered-title {
      color: #e74c3c;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .retry-button {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 5px;
      font-weight: bold;
    }
    
    .register-button {
      background: #3c8050;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 5px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    ç©¿å±±ç”²å°ˆè»Šé ç´„
    <span class="en-text">Pangolin Shuttle Reservation</span>
  </header>

  <div id="userInfo" class="user-section">
    <div class="loading-state">â³ ç³»çµ±åˆå§‹åŒ–ä¸­...<span class="en-text-dark">System initializing...</span></div>
  </div>

  <!-- æœªè¨»å†Šç”¨æˆ¶é¡¯ç¤ºå€åŸŸ -->
  <div id="unregisteredSection" class="unregistered-section" style="display: none;">
    <div class="unregistered-title">âŒ æ‚¨å°šæœªå®Œæˆè¨»å†Š</div>
    <p class="en-text-dark">You are not registered</p>
    <p style="color: #666; margin: 15px 0;">è«‹å®Œæˆè¨»å†Šä»¥ä½¿ç”¨é ç´„æœå‹™</p>
    <p class="en-text-dark" style="color: #666; margin-bottom: 20px;">Please complete registration to use reservation service</p>
    
    <button class="register-button" onclick="goToRegistration()">
      å‰å¾€è¨»å†Š
      <span class="en-text">Go to Registration</span>
    </button>
    
    <button class="retry-button" onclick="retryUserCheck()">
      é‡æ–°æª¢æŸ¥
      <span class="en-text">Retry Check</span>
    </button>
  </div>

  <div style="display: flex; gap: 10px; margin: 10px 16px; align-items: center;">
    <button id="calendarBtn" onclick="toggleCalendar()" style="flex: 1; position: relative;" aria-label="æ‰“é–‹æœˆæ›† Open Calendar" aria-expanded="false">
      ğŸ“… æ‰“é–‹æœˆæ›†
      <span class="en-text">Open Calendar</span>
      <span id="calendarLoading" class="loading-dots" style="display:none"></span>
    </button>
    
    <button id="rulesBtn" onclick="openRules()" 
            style="flex: 0 0 auto; background: #3C8050; color: white; border: none; 
                   padding: 12px 16px; border-radius: 6px; font-size: 16px; 
                   cursor: pointer; white-space: nowrap; font-weight: bold;"
            aria-label="æŸ¥çœ‹é ç´„è¦å‰‡ View Reservation Rules">
      ğŸ“– é ç´„è¦å‰‡
      <span class="en-text">Reservation Rules</span>
    </button>
  </div>

  <div id="calendarContainer" style="display:none;margin-top:10px; padding:0 16px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <button onclick="changeMonth(-1)" style="width:auto; padding:5px 10px;" aria-label="ä¸Šå€‹æœˆ Previous Month">â—€ ä¸Šå€‹æœˆ<span class="en-text-dark">Prev Month</span></button>
      <h3 id="calendarTitle" style="margin:0; font-size:16px;"></h3>
      <button onclick="changeMonth(1)" style="width:auto; padding:5px 10px;" aria-label="ä¸‹å€‹æœˆ Next Month">ä¸‹å€‹æœˆ â–¶<span class="en-text-dark">Next Month</span></button>
    </div>
    <div id="calendar" class="calendar" role="grid" aria-label="æœˆæ›† Calendar"></div>
  </div>

  <div id="selectedDate" class="notice success" style="display:none;" role="status"></div>
  <div id="holidayNotice" class="notice error" style="display:none;" role="alert"></div>

  <div id="routeSection" class="route-section" style="display:none;">
    <h3>è«‹é¸æ“‡æ­ä¹˜ç­æ¬¡<span class="en-text-dark">Please Select Shuttle Time</span></h3>
    <div id="routeButtons" class="route-buttons" role="group" aria-label="ç­æ¬¡é¸æ“‡ Route Selection"></div>
  </div>

  <div id="fromStopSection" class="stop-selector" style="display:none;">
    <h3>è«‹é¸æ“‡ä¸Šè»Šç«™<span class="en-text-dark">Please Select Pick-up Stop</span></h3>
    <select id="fromStop" aria-label="ä¸Šè»Šç«™é¸æ“‡ Pick-up Stop Selection">
      <option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡<span class="en-text-dark">Please select shuttle time first</span></option>
    </select>
  </div>

  <div id="toStopSection" class="stop-selector" style="display:none;">
    <h3>è«‹é¸æ“‡ä¸‹è»Šç«™<span class="en-text-dark">Please Select Drop-off Stop</span></h3>
    <select id="toStop" aria-label="ä¸‹è»Šç«™é¸æ“‡ Drop-off Stop Selection">
      <option value="">è«‹å…ˆé¸æ“‡ä¸Šè»Šç«™<span class="en-text-dark">Please select pick-up stop first</span></option>
    </select>
  </div>

  <button id="submitBtn" class="submit-btn" onclick="submitReservation()" style="display:none;" aria-label="é€å‡ºé ç´„ Submit Reservation">
    é€å‡ºé ç´„
    <span class="en-text">Submit Reservation</span>
  </button>

  <div id="currentReservationCard" style="display:none;"></div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';

// å…¨åŸŸè®Šæ•¸
let RESERVATION_RULES = {
  seatLimit: 7,
  maxPerDay: 1,
  dailyDeadline: '19:00',
  maxDaysAhead: 7,
  availableRoutes: [
    { id: "A1", time: "22:00-22:30", direction: "æš¨å¤§â†’åŸ”é‡Œç¸½ç«™", eng: "NCNU â†’ Puli Terminal" },
    { id: "B1", time: "22:30-23:00", direction: "åŸ”é‡Œç¸½ç«™â†’æš¨å¤§", eng: "Puli Terminal â†’ NCNU" },
    { id: "A2", time: "23:00-23:30", direction: "æš¨å¤§â†’åŸ”é‡Œç¸½ç«™", eng: "NCNU â†’ Puli Terminal" },
    { id: "B2", time: "23:30-24:00", direction: "åŸ”é‡Œç¸½ç«™â†’æš¨å¤§", eng: "Puli Terminal â†’ NCNU" }
  ],
  stopList: [
    ["è¡Œæ”¿å¤§æ¨“", "NCNU Administrative Building"],
    ["ä¸­é¤å»³", "Zhong Can Ting(Chinese Restaurant)"],
    ["ç§‘æŠ€å­¸é™¢", "College of Science and Technology"],
    ["å­¸äººæœƒé¤¨", "Scholars' Residence"],
    ["ä¸­åŸ", "Zhongcheng"],
    ["ä¸‹åŸ", "Xiacheng"],
    ["åªé ‚", "Pingding"],
    ["æ„›è˜­æ©‹", "Ailan Bridge"],
    ["å¤§æˆåœ‹å°", "Dacheng Elementary School"],
    ["ä¸­å±±å®‰ä¸ƒè¡—å£", "Zhongshan Anqi St. Intersection"],
    ["æ¦®æ°‘è¨ºæ‰€", "Veterans Clinic"],
    ["åŸ”é‡Œé…’å» ", "Puli Distillery"],
    ["åŸ”é‡Œç¸½ç«™", "Puli Bus Terminal"]
  ]
};

let selectedDate = null;
let selectedRoute = null;
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let userData = null;
let existingReservations = [];
let noServiceDates = {};
let calendarDataLoaded = false;
let calendarLoading = false;
let liffInitialized = false;

// è³‡æ–™å¿«å–æ©Ÿåˆ¶
const cache = {
  calendarData: null,
  reservations: null,
  lastUpdated: null
};

// å¢å¼·å‹ fetch å‡½æ•¸ï¼ŒåŒ…å«é‡è©¦æ©Ÿåˆ¶å’Œè¶…æ™‚è™•ç†
async function robustFetch(url, options = {}, retries = 3, timeout = 10000) {
  for (let i = 0; i < retries; i++) {
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
      
      const response = await fetch(url, {
        ...options,
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      return await response.json();
    } catch (error) {
      console.warn(`ç¬¬ ${i + 1} æ¬¡è«‹æ±‚å¤±æ•—ï¼Œ${retries - i - 1} æ¬¡é‡è©¦æ©Ÿæœƒ:`, error.message);
      if (i === retries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
}

// å¿«å–è³‡æ–™ç²å–å‡½æ•¸
async function getCachedData(key, fetchFunction, cacheDuration = 5 * 60 * 1000) {
  if (cache[key] && Date.now() - cache.lastUpdated < cacheDuration) {
    console.log(`âœ… ä½¿ç”¨å¿«å–è³‡æ–™: ${key}`);
    return cache[key];
  }
  
  console.log(`ğŸ”„ è¼‰å…¥æ–°è³‡æ–™: ${key}`);
  const data = await fetchFunction();
  cache[key] = data;
  cache.lastUpdated = Date.now();
  return data;
}

// å¾ rules.json è¼‰å…¥è¨­å®š
async function loadRules() {
  try {
    const response = await fetch('rules.json');
    if (!response.ok) throw new Error('è¦å‰‡æª”æ¡ˆè¼‰å…¥å¤±æ•—');
    const loadedRules = await response.json();
    console.log('âœ… è¦å‰‡è¼‰å…¥æˆåŠŸ:', loadedRules);
    
    // åˆä½µè¼‰å…¥çš„è¦å‰‡ï¼Œç¢ºä¿æ‰€æœ‰å¿…è¦å±¬æ€§éƒ½å­˜åœ¨
    RESERVATION_RULES = {
      ...RESERVATION_RULES, // é è¨­å€¼
      ...loadedRules // è¼‰å…¥çš„å€¼
    };
  } catch (error) {
    console.error('âŒ è¦å‰‡è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼:', error);
    // ä½¿ç”¨é è¨­çš„ RESERVATION_RULES
  }
}

// æ ¹æ“šè¦å‰‡ç”Ÿæˆç«™é»å’Œè·¯ç·šè³‡æ–™
function initFromRules() {
  console.log('ğŸ”„ åˆå§‹åŒ–è¦å‰‡è³‡æ–™...', RESERVATION_RULES);
  
  // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ stopList å­˜åœ¨
  if (!RESERVATION_RULES.stopList || !Array.isArray(RESERVATION_RULES.stopList)) {
    console.warn('âš ï¸ stopList ä¸å­˜åœ¨æˆ–ä¸æ˜¯é™£åˆ—ï¼Œä½¿ç”¨é è¨­å€¼');
    RESERVATION_RULES.stopList = [
      ["è¡Œæ”¿å¤§æ¨“", "NCNU Administrative Building"],
      ["ä¸­é¤å»³", "Zhong Can Ting(Chinese Restaurant)"],
      ["ç§‘æŠ€å­¸é™¢", "College of Science and Technology"],
      ["å­¸äººæœƒé¤¨", "Scholars' Residence"],
      ["ä¸­åŸ", "Zhongcheng"],
      ["ä¸‹åŸ", "Xiacheng"],
      ["åªé ‚", "Pingding"],
      ["æ„›è˜­æ©‹", "Ailan Bridge"],
      ["å¤§æˆåœ‹å°", "Dacheng Elementary School"],
      ["ä¸­å±±å®‰ä¸ƒè¡—å£", "Zhongshan Anqi St. Intersection"],
      ["æ¦®æ°‘è¨ºæ‰€", "Veterans Clinic"],
      ["åŸ”é‡Œé…’å» ", "Puli Distillery"],
      ["åŸ”é‡Œç¸½ç«™", "Puli Bus Terminal"]
    ];
  }

  // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ availableRoutes å­˜åœ¨
  if (!RESERVATION_RULES.availableRoutes || !Array.isArray(RESERVATION_RULES.availableRoutes)) {
    console.warn('âš ï¸ availableRoutes ä¸å­˜åœ¨æˆ–ä¸æ˜¯é™£åˆ—ï¼Œä½¿ç”¨é è¨­å€¼');
    RESERVATION_RULES.availableRoutes = [
      { id: "A1", time: "22:00-22:30", direction: "æš¨å¤§â†’åŸ”é‡Œç¸½ç«™", eng: "NCNU â†’ Puli Terminal" },
      { id: "B1", time: "22:30-23:00", direction: "åŸ”é‡Œç¸½ç«™â†’æš¨å¤§", eng: "Puli Terminal â†’ NCNU" },
      { id: "A2", time: "23:00-23:30", direction: "æš¨å¤§â†’åŸ”é‡Œç¸½ç«™", eng: "NCNU â†’ Puli Terminal" },
      { id: "B2", time: "23:30-24:00", direction: "åŸ”é‡Œç¸½ç«™â†’æš¨å¤§", eng: "Puli Terminal â†’ NCNU" }
    ];
  }

  // ç”Ÿæˆç«™é»è³‡æ–™
  const stopsOutbound = RESERVATION_RULES.stopList.map(stop => 
    `${stop[0]}<br><small style='color: #666;'>${stop[1]}</small>`
  );
  const stopsReturn = [...stopsOutbound].reverse();

  // ç”Ÿæˆè·¯ç·šè³‡æ–™
  const routeTimes = {};
  RESERVATION_RULES.availableRoutes.forEach(route => {
    routeTimes[route.id] = {
      time: route.time,
      direction: route.direction,
      eng: route.eng || route.direction
    };
  });

  console.log('âœ… è¦å‰‡åˆå§‹åŒ–å®Œæˆ:', { stopsOutbound, stopsReturn, routeTimes });
  return { stopsOutbound, stopsReturn, routeTimes };
}

// é¡¯ç¤ºç”¨æˆ¶è³‡æ–™ä¸å®Œæ•´è­¦å‘Š
function showIncompleteProfileNotice() {
  const userInfoDiv = document.getElementById('userInfo');
  const warningDiv = document.createElement('div');
  warningDiv.className = 'profile-warning';
  warningDiv.innerHTML = `
    <p>âš ï¸ æ‚¨çš„è³‡æ–™ä¸å®Œæ•´ï¼Œå»ºè­° <a href="register.html" onclick="event.preventDefault(); completeProfile();">è£œå…¨è³‡æ–™</a></p>
    <p style="margin: 0; color: #666; font-size: 12px;">
      âš ï¸ Your profile is incomplete, please <a href="register.html" onclick="event.preventDefault(); completeProfile();">complete it</a>
    </p>
  `;
  userInfoDiv.appendChild(warningDiv);
}

// è£œå…¨è³‡æ–™å‡½æ•¸
function completeProfile() {
  if (confirm('æ˜¯å¦è¦å‰å¾€è£œå…¨å€‹äººè³‡æ–™ï¼Ÿ\nDo you want to complete your profile?')) {
    window.location.href = 'register.html';
  }
}

function checkProfileCompleteness(userData) {
  // å®‰å…¨åœ°è½‰æ›ä¸¦æª¢æŸ¥æ¯å€‹æ¬„ä½
  const name = userData.name ? String(userData.name).trim() : '';
  const phone = userData.phone ? String(userData.phone).trim() : '';
  const studentId = userData.studentId ? String(userData.studentId).trim() : '';
  const department = userData.department ? String(userData.department).trim() : '';

  const missingFields = [];
  if (!name) missingFields.push('å§“å Name');
  if (!phone) missingFields.push('é›»è©± Phone');
  if (!studentId) missingFields.push('å­¸è™Ÿ Student ID');
  if (!department) missingFields.push('ç§‘ç³» Department');

  return {
    isComplete: missingFields.length === 0,
    missingFields: missingFields
  };
}

// é¡¯ç¤ºæœªè¨»å†Šç”¨æˆ¶ç•Œé¢
function showUnregisteredInterface() {
  document.getElementById('userInfo').style.display = 'none';
  document.getElementById('unregisteredSection').style.display = 'block';
}

// é¡¯ç¤ºå·²è¨»å†Šç”¨æˆ¶ç•Œé¢
function showRegisteredInterface() {
  document.getElementById('unregisteredSection').style.display = 'none';
  document.getElementById('userInfo').style.display = 'block';
}

// å‰å¾€è¨»å†Šé é¢
function goToRegistration() {
  if (confirm('æ˜¯å¦è¦å‰å¾€è¨»å†Šé é¢ï¼Ÿ\nDo you want to go to registration page?')) {
    window.location.href = 'register.html';
  }
}

// é‡æ–°æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹
async function retryUserCheck() {
  try {
    showLoadingState('userInfo', 'é‡æ–°æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹...');
    await checkUserRegistration();
  } catch (error) {
    console.error('é‡æ–°æª¢æŸ¥å¤±æ•—:', error);
    showUnregisteredInterface();
  }
}

// é¡¯ç¤ºåŠ è¼‰ç‹€æ…‹
function showLoadingState(elementId, message) {
  const element = document.getElementById(elementId);
  if (element) {
    element.innerHTML = `
      <div style="text-align: center; color: #666;">
        <p>â³ ${message}</p>
        <p class="en-text-dark">Loading...</p>
      </div>
    `;
  }
}

// æª¢æŸ¥ç”¨æˆ¶è¨»å†Šç‹€æ…‹
async function checkUserRegistration() {
  try {
    console.log('ğŸ” æª¢æŸ¥ç”¨æˆ¶è¨»å†Šç‹€æ…‹...');
    const profile = await liff.getProfile();
    const userCheckResult = await robustFetch(`${WORKER_URL}?mode=check&userId=${encodeURIComponent(profile.userId)}`);
    console.log('âœ… æª¢æŸ¥çµæœ:', userCheckResult);
    
    if (userCheckResult && userCheckResult.registered === true && userCheckResult.user) {
      return userCheckResult;
    } else {
      throw new Error('ç”¨æˆ¶æœªè¨»å†Š');
    }
  } catch (error) {
    console.error('âŒ ç”¨æˆ¶æª¢æŸ¥å¤±æ•—:', error);
    throw error;
  }
}

async function init() {
  try {
    console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ–ç³»çµ±... System initializing...');
    
    // å…ˆè¼‰å…¥è¦å‰‡
    await loadRules();
    const { stopsOutbound, stopsReturn, routeTimes } = initFromRules();
    window.stopsOutbound = stopsOutbound;
    window.stopsReturn = stopsReturn;
    window.routeTimes = routeTimes;

    if (typeof liff === 'undefined') {
      console.error('âŒ LIFF SDK æœªåŠ è¼‰ LIFF SDK not loaded');
      document.getElementById('userInfo').innerHTML = `
        <div style="color: red; text-align: center;">
          <p>âŒ ç³»çµ±åŠ è¼‰å¤±æ•—</p>
          <p class="en-text-dark">System loading failed</p>
          <p>è«‹åœ¨ LINE App ä¸­æ‰“é–‹æ­¤é é¢</p>
          <p class="en-text-dark">Please open this page in LINE App</p>
        </div>
      `;
      return;
    }
    
    await liff.init({ liffId: "2006590746-KJodGOda" });
    liffInitialized = true;
    console.log('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ LIFF initialized successfully');
    
    if (!liff.isLoggedIn()) {
      console.log('ğŸ” ç”¨æˆ¶æœªç™»éŒ„ï¼ŒåŸ·è¡Œç™»éŒ„... User not logged in, executing login...');
      liff.login();
      return;
    }
    
    console.log('ğŸ‘¤ ç²å–ç”¨æˆ¶ä¿¡æ¯... Getting user information...');
    const profile = await liff.getProfile();
    console.log('ç”¨æˆ¶ä¿¡æ¯ User info:', profile);
    
    // æª¢æŸ¥ç”¨æˆ¶è¨»å†Šç‹€æ…‹
    let userCheckResult;
    try {
      userCheckResult = await checkUserRegistration();
      
      // ç¢ºä¿ userData å­˜åœ¨ä¸”æœ‰æ­£ç¢ºçµæ§‹
      if (!userCheckResult.user) {
        console.error('âŒ userData ç‚ºç©ºæˆ–æœªå®šç¾©');
        throw new Error('ç”¨æˆ¶è³‡æ–™è¼‰å…¥å¤±æ•—ï¼šuserData ç‚ºç©º');
      }
      
      userData = userCheckResult.user;
      
      // æª¢æŸ¥ç”¨æˆ¶è³‡æ–™å®Œæ•´æ€§
      const profileCheck = checkProfileCompleteness(userData);
      if (!profileCheck.isComplete) {
        console.warn('âš ï¸ ç”¨æˆ¶è³‡æ–™ä¸å®Œæ•´:', userData);
        userData.name = userData.name || 'æœªçŸ¥ç”¨æˆ¶';
        userData.studentId = userData.studentId || 'æœªçŸ¥å­¸è™Ÿ';
        userData.department = userData.department || 'æœªçŸ¥ç§‘ç³»';
      }
      
      // è¼‰å…¥é ç´„è³‡æ–™ï¼ˆä½¿ç”¨å¿«å–ï¼‰
      console.log('ğŸ” è¼‰å…¥é ç´„è³‡æ–™...');
      const reservationsResult = await getCachedData('reservations', async () => {
        const res = await robustFetch(`${WORKER_URL}?mode=reservations&userId=${profile.userId}`);
        return res;
      });
      console.log('âœ… é ç´„çµæœ:', reservationsResult);

      // é è¼‰æœˆæ›†è³‡æ–™
      console.log('ğŸ” é è¼‰æœˆæ›†è³‡æ–™...');
      await preloadCalendarData();
      console.log('âœ… æœˆæ›†è³‡æ–™å·²é è¼‰');

      existingReservations = reservationsResult.reservations || [];
      
      // æ›´æ–°ç”¨æˆ¶ä¿¡æ¯é¡¯ç¤º
      try {
        let userInfoHTML = `
          <div class="user-name">${userData.name || 'æœªçŸ¥ç”¨æˆ¶'}</div>
          <div class="user-info">${userData.department || 'æœªçŸ¥ç§‘ç³»'} | ${userData.studentId || 'æœªçŸ¥å­¸è™Ÿ'}</div>
        `;
        
        // å¦‚æœè³‡æ–™ä¸å®Œæ•´ï¼Œé¡¯ç¤ºè­¦å‘Š
        if (!profileCheck.isComplete) {
          userInfoHTML += `
            <div class="profile-warning">
              <p>âš ï¸ æ‚¨çš„è³‡æ–™ä¸å®Œæ•´ï¼ˆç¼ºå°‘ï¼š${profileCheck.missingFields.join(', ')}ï¼‰ï¼Œå»ºè­° <a href="register.html" onclick="event.preventDefault(); completeProfile();">è£œå…¨è³‡æ–™</a></p>
              <p style="margin: 0; color: #666; font-size: 12px;">
                âš ï¸ Your profile is incomplete (missing: ${profileCheck.missingFields.join(', ')}), please <a href="register.html" onclick="event.preventDefault(); completeProfile();">complete it</a>
              </p>
            </div>
          `;
        }
        
        document.getElementById('userInfo').innerHTML = userInfoHTML;
        showRegisteredInterface();
      } catch (displayError) {
        console.error('âŒ æ›´æ–°ç”¨æˆ¶ä¿¡æ¯é¡¯ç¤ºå¤±æ•—:', displayError);
        document.getElementById('userInfo').innerHTML = `
          <div style="color: orange; text-align: center;">
            <p>âš ï¸ ç”¨æˆ¶ä¿¡æ¯é¡¯ç¤ºç•°å¸¸</p>
            <p class="en-text-dark">User info display error</p>
          </div>
        `;
        showRegisteredInterface();
      }
      
      // ç›´æ¥æ¸²æŸ“é ç´„å¡ç‰‡
      renderCurrentReservationCard();
      
      console.log('ğŸ‰ ç³»çµ±åˆå§‹åŒ–å®Œæˆ System initialization completed');
      
    } catch (registrationError) {
      console.error('âŒ ç”¨æˆ¶æœªè¨»å†Šæˆ–æª¢æŸ¥å¤±æ•—:', registrationError);
      showUnregisteredInterface();
      return;
    }
    
  } catch (error) {
    console.error('ğŸ’¥ åˆå§‹åŒ–éŒ¯èª¤ Initialization error:', error);
    
    let errorMessage = 'ç³»çµ±åˆå§‹åŒ–å¤±æ•—';
    let errorMessageEn = 'System initialization failed';
    
    if (error.message.includes('userData')) {
      errorMessage = 'ç”¨æˆ¶è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°è¨»å†Š';
      errorMessageEn = 'User data loading failed, please re-register';
    }
    
    document.getElementById('userInfo').innerHTML = `
      <div style="color: red; text-align: center;">
        <p>âŒ ${errorMessage}</p>
        <p class="en-text-dark">âŒ ${errorMessageEn}</p>
        <p>éŒ¯èª¤: ${error.message}</p>
        <p class="en-text-dark">Error: ${error.message}</p>
        <button onclick="location.reload()" style="padding: 10px; margin: 10px; background: #3c8050; color: white; border: none; border-radius: 6px;">
          é‡æ–°è¼‰å…¥
          <span class="en-text-dark">Reload</span>
        </button>
        <br>
        <button onclick="location.href='register.html'" style="padding: 10px; margin: 10px; background: #ff9800; color: white; border: none; border-radius: 6px;">
          é‡æ–°è¨»å†Š
          <span class="en-text-dark">Re-register</span>
        </button>
      </div>
    `;
    showRegisteredInterface();
  }
}

// æ‰“é–‹é ç´„è¦å‰‡
function openRules() {
  window.open('https://line.me/R/home/public/post?postId=1176044641970348675', '_blank');
}

// === è¼‰å…¥åœé§›æ—¥æœŸ ===
async function loadNoServiceDates() {
  try {
    const start = formatDateToLocal(new Date(currentYear, currentMonth - 1, 1));
    const end = formatDateToLocal(new Date(currentYear, currentMonth + 2, 0));
    
    const result = await getCachedData('calendar', async () => {
      const res = await robustFetch(`${WORKER_URL}?mode=calendar&start=${start}&end=${end}&calendarId=${encodeURIComponent(CALENDAR_ID)}`);
      return res;
    }, 10 * 60 * 1000); // æ—¥æ›†è³‡æ–™å¿«å–10åˆ†é˜
    
    noServiceDates = {};
    if (Array.isArray(result.holidays)) {
      result.holidays.forEach(d => noServiceDates[d.substring(0,10)] = true);
    }
    console.log('åœé§›æ—¥æœŸ No service dates:', noServiceDates);
  } catch (e) {
    console.error('ğŸš¨ è¼‰å…¥åœé§›æ—¥æœŸå¤±æ•— Failed to load no service dates:', e);
    noServiceDates = {};
  }
}

async function preloadCalendarData() {
  if (calendarDataLoaded || calendarLoading) return;
  
  calendarLoading = true;
  console.log('ğŸ“… é–‹å§‹é è¼‰æœˆæ›†è³‡æ–™... Preloading calendar data...');
  
  try {
    await loadNoServiceDates();
    calendarDataLoaded = true;
    console.log('âœ… æœˆæ›†è³‡æ–™é è¼‰å®Œæˆ Calendar data preloaded');
  } catch (error) {
    console.error('âŒ æœˆæ›†è³‡æ–™é è¼‰å¤±æ•— Calendar data preload failed:', error);
  } finally {
    calendarLoading = false;
  }
}

function toggleCalendar() {
  // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²è¨»å†Š
  if (!userData) {
    alert('è«‹å…ˆå®Œæˆè¨»å†Šä»¥ä½¿ç”¨é ç´„åŠŸèƒ½\nPlease complete registration to use reservation feature');
    return;
  }

  const calendar = document.getElementById('calendarContainer');
  const btn = document.getElementById('calendarBtn');
  const isHidden = window.getComputedStyle(calendar).display === 'none';

  calendar.style.display = isHidden ? 'block' : 'none';
  btn.innerHTML = isHidden
    ? 'ğŸ“… é—œé–‰æœˆæ›†<span class="en-text">Close Calendar</span>'
    : 'ğŸ“… æ‰“é–‹æœˆæ›†<span class="en-text">Open Calendar</span>';
  
  btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');

  if (isHidden) {
    renderCalendar();
  }
}

// === ğŸ“… æœˆæ›†ç”¢ç”Ÿ ===
function renderCalendar() {
  const cal = document.getElementById('calendar');
  const title = document.getElementById('calendarTitle');
  
  title.innerHTML = `${currentYear}å¹´ ${currentMonth + 1}æœˆ<br><small class="en-text-dark">${currentYear} ${getMonthName(currentMonth)}</small>`;
  
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const prevLastDay = new Date(currentYear, currentMonth, 0);
  const startWeekday = firstDay.getDay();
  const daysInMonth = lastDay.getDate();
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  let html = '';
  ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(d => {
    const engDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const engDay = engDays[['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].indexOf(d)];
    html += `<div class="calendar-header">${d}<br><small style="color: #666; font-size: 10px;">${engDay}</small></div>`;
  });
  
  for (let i = startWeekday - 1; i >= 0; i--) {
    const day = prevLastDay.getDate() - i;
    html += `<div class="calendar-day other-month">${day}</div>`;
  }
  
  for (let day = 1; day <= daysInMonth; day++) {
    const dateObj = new Date(currentYear, currentMonth, day);
    const dateStr = formatDateToLocal(dateObj);
    
    // ä½¿ç”¨é ç´„è¦å‰‡é©—è­‰æ—¥æœŸç‹€æ…‹
    const isPast = ReservationValidator.isPastDate(dateStr);
    const isNoService = ReservationValidator.isNoServiceDate(dateStr);
    const isAfterDeadline = ReservationValidator.isAfterDeadline(dateStr);
    const isWithinWindow = ReservationValidator.isWithinBookingWindow(dateStr);
    const hasReservation = userData ? ReservationValidator.hasExistingReservation(userData.userId, dateStr) : false;
    
    let classes = 'calendar-day';
    let disabled = false;
    let disabledReason = '';
    let disabledReasonEn = '';

    // æª¢æŸ¥æ—¥æœŸç‹€æ…‹ - å„ªå…ˆé¡¯ç¤ºå·²å®Œæˆé ç´„
    if (hasReservation) {
      disabled = true;
      disabledReason = 'æ‚¨å·²é ç´„';
      disabledReasonEn = 'Booked';
      classes += ' disabled';
      html += `<div class="${classes}" style="background: #e0e8ff; border: 1px solid #b3c6ff; color: #333;">${day}<br><small>${disabledReason}</small><br><small style="color: #666; font-size: 9px;">${disabledReasonEn}</small></div>`;
    } else if (isPast) {
      disabled = true;
      disabledReason = 'å·²éæœŸ';
      disabledReasonEn = 'Expired';
      classes += ' past';
      html += `<div class="${classes}">${day}<br><small>${disabledReason}</small><br><small style="color: #666; font-size: 9px;">${disabledReasonEn}</small></div>`;
    } else if (isNoService) {
      disabled = true;
      disabledReason = 'åœé§›';
      disabledReasonEn = 'No Service';
      classes += ' disabled';
      html += `<div class="${classes}" style="background: #f8f9fa; color: #999;">${day}<br><small>${disabledReason}</small><br><small style="color: #666; font-size: 9px;">${disabledReasonEn}</small></div>`;
    } else if (!isWithinWindow) {
      disabled = true;
      disabledReason = 'æœªé–‹æ”¾';
      disabledReasonEn = 'Not Open';
      classes += ' disabled';
      html += `<div class="${classes}" style="background: #f8f9fa; color: #999;">${day}<br><small>${disabledReason}</small><br><small style="color: #666; font-size: 9px;">${disabledReasonEn}</small></div>`;
    } else if (isAfterDeadline && ReservationValidator.isToday(dateStr)) {
      disabled = true;
      disabledReason = 'å·²æˆªæ­¢';
      disabledReasonEn = 'Deadline Passed';
      classes += ' disabled';
      html += `<div class="${classes}" style="background: #f8f9fa; color: #999;">${day}<br><small>${disabledReason}</small><br><small style="color: #666; font-size: 9px;">${disabledReasonEn}</small></div>`;
    } else {
      if (selectedDate === dateStr) {
        classes += ' selected';
      }
      
      const isWeekend = dateObj.getDay() === 0 || dateObj.getDay() === 6;
      const dayLabel = isWeekend ? 
        `${day}<br><small style="font-size:10px;">é€±æœ«</small><br><small style="color: #666; font-size: 9px;">Weekend</small>` : 
        day;
      
      html += `<div class="${classes}" onclick="selectDate('${dateStr}')" role="button" tabindex="0" aria-label="${dateStr} ${isWeekend ? 'é€±æœ« Weekend' : ''}">${dayLabel}</div>`;
    }
  }
  
  const remainingDays = 7 - ((startWeekday + daysInMonth) % 7);
  if (remainingDays < 7) {
    for (let i = 1; i <= remainingDays; i++) {
      html += `<div class="calendar-day other-month">${i}</div>`;
    }
  }
  
  cal.innerHTML = html;
}

function getMonthName(month) {
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                 'July', 'August', 'September', 'October', 'November', 'December'];
  return months[month];
}

async function changeMonth(delta) {
  currentMonth += delta;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  
  calendarDataLoaded = false;
  const loadingSpan = document.getElementById('calendarLoading');
  loadingSpan.style.display = 'inline-block';
  
  await loadNoServiceDates();
  calendarDataLoaded = true;
  
  loadingSpan.style.display = 'none';
  renderCalendar();
}

function selectDate(dateStr) {
  // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ç”¨æˆ¶ä¿¡æ¯å·²è¼‰å…¥
  if (!userData) {
    console.error('âŒ userData æœªåˆå§‹åŒ–');
    alert('âŒ ç³»çµ±åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å€™...\nâŒ System initializing, please wait...');
    return;
  }

  // ä½¿ç”¨é ç´„è¦å‰‡é€²è¡Œå®Œæ•´é©—è­‰
  const validation = {
    past: ReservationValidator.isPastDate(dateStr),
    noService: ReservationValidator.isNoServiceDate(dateStr),
    withinWindow: ReservationValidator.isWithinBookingWindow(dateStr),
    afterDeadline: ReservationValidator.isAfterDeadline(dateStr),
    hasReservation: ReservationValidator.hasExistingReservation(userData.userId, dateStr)
  };

  // æª¢æŸ¥æ—¥æœŸæœ‰æ•ˆæ€§
  if (validation.past) {
    showError('ğŸš« ç„¡æ³•é ç´„éå»æ—¥æœŸ<br><span style="color: #666;">Cannot book past dates</span>');
    return;
  }

  if (validation.noService) {
    showError('ğŸš« è©²æ—¥æœŸç‚ºåœé§›æ—¥ï¼Œç„¡æ³•é ç´„<br><span style="color: #666;">No service on this date, cannot book</span>');
    return;
  }

  if (!validation.withinWindow) {
    showError(`ğŸš« åªèƒ½é ç´„æœªä¾† ${RESERVATION_RULES.maxDaysAhead} å¤©å…§çš„ç­æ¬¡<br><span style="color: #666;">Can only book within ${RESERVATION_RULES.maxDaysAhead} days</span>`);
    return;
  }

  if (validation.afterDeadline) {
    showError(`ğŸš« ä»Šæ—¥é ç´„å·²æˆªæ­¢ï¼ˆ${RESERVATION_RULES.dailyDeadline}ï¼‰<br><span style="color: #666;">Today\'s booking deadline passed (${RESERVATION_RULES.dailyDeadline})</span>`);
    return;
  }

  // æª¢æŸ¥æ˜¯å¦å·²æœ‰é ç´„
  if (validation.hasReservation) {
    const existingReservation = existingReservations.find(
      res => res.userId === userData.userId && 
             res.date.split('T')[0] === dateStr && 
             res.status !== 'å·²å–æ¶ˆ'
    );
    
    showError(`æ‚¨å·²åœ¨ ${dateStr} é ç´„äº† ${existingReservation?.route || ''} ç­æ¬¡ï¼Œæ¯å¤©åªèƒ½é ç´„ä¸€å€‹ç­æ¬¡<br><span style="color: #666;">You already booked ${existingReservation?.route || ''} on ${dateStr}, only one booking per day</span>`);
    return;
  }

  selectedDate = dateStr;
  
  // é‡ç½®é¸æ“‡ç‹€æ…‹
  document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
  event.target.classList.add('selected');
  
  // é¡¯ç¤ºé¸æ“‡çš„æ—¥æœŸ
  document.getElementById('selectedDate').style.display = 'block';
  document.getElementById('selectedDate').innerHTML = `âœ… å·²é¸æ“‡æ—¥æœŸï¼š${dateStr}<br><span style="color: #666;">âœ… Selected date: ${dateStr}</span>`;
  document.getElementById('holidayNotice').style.display = 'none';
  
  // é—œé–‰æœˆæ›†
  document.getElementById('calendarContainer').style.display = 'none';
  document.getElementById('calendarBtn').innerHTML = 'ğŸ“… æ‰“é–‹æœˆæ›†<span class="en-text">Open Calendar</span>';
  document.getElementById('calendarBtn').setAttribute('aria-expanded', 'false');
  
  // é¡¯ç¤ºç­æ¬¡é¸æ“‡
  showRouteSelection();
}

// === ğŸšŒ é¡¯ç¤ºç­æ¬¡é¸æ“‡ ===
async function showRouteSelection() {
  document.getElementById('routeSection').style.display = 'block';
  const container = document.getElementById('routeButtons');
  
  let html = '';
  for (const [id, info] of Object.entries(routeTimes)) {
    // æª¢æŸ¥ç­æ¬¡æ˜¯å¦å·²é¡æ»¿
    const currentCount = await getRouteReservationCount(selectedDate, id);
    const remainingSeats = RESERVATION_RULES.seatLimit - currentCount;
    const isFull = remainingSeats <= 0;
    
    const buttonClass = isFull ? 'route-btn disabled' : 'route-btn';
    const seatInfo = isFull ? 'âŒ å·²é¡æ»¿' : `âœ… å‰©é¤˜ ${remainingSeats} å¸­`;
    const seatInfoEn = isFull ? 'Full' : `Available: ${remainingSeats}`;
    
    html += `
      <div class="${buttonClass}" ${isFull ? '' : `onclick="selectRoute('${id}', '${info.direction}')"`}
            role="button" tabindex="${isFull ? '-1' : '0'}" aria-label="${info.time} ${info.direction} ${seatInfo}">
        <div class="route-time">${info.time}</div>
        <div class="route-direction">${info.direction}<br><span style="color: #666; font-size: 11px;">${info.eng}</span></div>
        <div style="font-size: 11px; margin-top: 4px; color: ${isFull ? '#f44336' : '#4caf50'}">
          ${seatInfo}<br>
          <span style="color: #666; font-size: 10px;">${seatInfoEn}</span>
        </div>
      </div>
    `;
  }
  
  container.innerHTML = html;
  document.getElementById('fromStopSection').style.display = 'none';
  document.getElementById('toStopSection').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
}

// å–å¾—ç­æ¬¡é ç´„äººæ•¸çš„å‡½æ•¸
async function getRouteReservationCount(dateStr, route) {
  try {
    const res = await robustFetch(`${WORKER_URL}?mode=routeCapacity&date=${dateStr}&route=${route}`);
    return res.count || 0;
  } catch (error) {
    console.error('å–å¾—ç­æ¬¡äººæ•¸å¤±æ•— Failed to get route count:', error);
    return 0;
  }
}

function selectRoute(routeId, direction) {
  selectedRoute = routeId;
  
  // æ›´æ–°æŒ‰éˆ•é¸æ“‡ç‹€æ…‹
  document.querySelectorAll('.route-btn').forEach(btn => btn.classList.remove('selected'));
  event.target.classList.add('selected');
  
  // é¡¯ç¤ºè»Šç«™é¸æ“‡
  showStopSelection(direction);
}

function showStopSelection(direction) {
  const fromStopSection = document.getElementById('fromStopSection');
  const toStopSection = document.getElementById('toStopSection');
  const fromStopSelect = document.getElementById('fromStop');
  const toStopSelect = document.getElementById('toStop');
  
  // é‡ç½®é¸æ“‡
  fromStopSelect.innerHTML = '<option value="">è«‹é¸æ“‡ä¸Šè»Šç«™<br><span style="color: #666;">Please select pick-up stop</span></option>';
  toStopSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡ä¸Šè»Šç«™<br><span style="color: #666;">Please select pick-up stop first</span></option>';
  
  // æ ¹æ“šæ–¹å‘æ±ºå®šè»Šç«™åˆ—è¡¨
  const isOutbound = direction.includes('æš¨å¤§â†’');
  const stops = isOutbound ? stopsOutbound : stopsReturn;
  
  // å¡«å……ä¸Šè»Šç«™é¸é …
  stops.forEach(stop => {
    const option = document.createElement('option');
    option.value = stop.split('<')[0]; // åªå–ä¸­æ–‡éƒ¨åˆ†ä½œç‚º value
    option.innerHTML = stop; // ä½¿ç”¨ innerHTML è€Œä¸æ˜¯ textContent
    fromStopSelect.appendChild(option);
  });
  
  fromStopSection.style.display = 'block';
  toStopSection.style.display = 'block';
  
  // ç•¶é¸æ“‡ä¸Šè»Šç«™æ™‚ï¼Œæ›´æ–°ä¸‹è»Šç«™é¸é …
  fromStopSelect.onchange = function() {
    if (this.value) {
      // éæ¿¾æ‰å·²é¸æ“‡çš„ä¸Šè»Šç«™
      toStopSelect.innerHTML = '<option value="">è«‹é¸æ“‡ä¸‹è»Šç«™<br><span style="color: #666;">Please select drop-off stop</span></option>';
      
      stops.filter(stop => {
        const stopName = stop.split('<')[0];
        return stopName !== this.value;
      }).forEach(stop => {
        const option = document.createElement('option');
        option.value = stop.split('<')[0];
        option.innerHTML = stop;
        toStopSelect.appendChild(option);
      });
      
      // æª¢æŸ¥æ˜¯å¦å¯ä»¥é¡¯ç¤ºé€å‡ºæŒ‰éˆ•
      checkSubmitButton();
    } else {
      toStopSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡ä¸Šè»Šç«™<br><span style="color: #666;">Please select pick-up stop first</span></option>';
      document.getElementById('submitBtn').style.display = 'none';
    }
  };
  
  // ç•¶é¸æ“‡ä¸‹è»Šç«™æ™‚ï¼Œæª¢æŸ¥æ˜¯å¦å¯ä»¥é¡¯ç¤ºé€å‡ºæŒ‰éˆ•
  toStopSelect.onchange = function() {
    checkSubmitButton();
  };
  
  fromStopSection.scrollIntoView({ behavior: 'smooth' });
}

function checkSubmitButton() {
  const fromStop = document.getElementById('fromStop').value;
  const toStop = document.getElementById('toStop').value;
  
  if (fromStop && toStop) {
    document.getElementById('submitBtn').style.display = 'block';
  } else {
    document.getElementById('submitBtn').style.display = 'none';
  }
}

// === ğŸ“ é€å‡ºé ç´„ ===
async function submitReservation() {
  console.log('ğŸŸ¢ é€å‡ºé ç´„å‡½æ•¸è¢«è§¸ç™¼');
  
  const fromStop = document.getElementById('fromStop');
  const toStop = document.getElementById('toStop');
  const submitBtn = document.getElementById('submitBtn');
  
  if (!fromStop || !toStop) {
    console.error('âŒ æ‰¾ä¸åˆ°è»Šç«™é¸æ“‡å…ƒç´ ');
    return;
  }
  
  const fromStopValue = fromStop.value;
  const toStopValue = toStop.value;
  
  console.log('ğŸ” é€å‡ºé ç´„åƒæ•¸:', {
    selectedDate, 
    selectedRoute, 
    fromStop: fromStopValue, 
    toStop: toStopValue
  });
  
  // åŸºæœ¬é©—è­‰
  if (!selectedDate) {
    alert('è«‹é¸æ“‡æ—¥æœŸ\nPlease select date');
    return;
  }
  
  if (!selectedRoute) {
    alert('è«‹é¸æ“‡ç­æ¬¡\nPlease select shuttle time');
    return;
  }
  
  if (!fromStopValue) {
    alert('è«‹é¸æ“‡ä¸Šè»Šç«™\nPlease select pick-up stop');
    return;
  }
  
  if (!toStopValue) {
    alert('è«‹é¸æ“‡ä¸‹è»Šç«™\nPlease select drop-off stop');
    return;
  }

  if (fromStopValue === toStopValue) {
    alert('ä¸Šè»Šç«™èˆ‡ä¸‹è»Šç«™ä¸èƒ½ç›¸åŒ\nPick-up and drop-off stops cannot be the same');
    return;
  }
  
  try {
    console.log('ğŸ”„ é–‹å§‹è™•ç†é ç´„...');
    submitBtn.disabled = true;
    submitBtn.innerHTML = 'é ç´„ä¸­...<span class="en-text">Booking...</span>';
    
    const info = routeTimes[selectedRoute];
    
    if (!info) {
      alert('âŒ è·¯ç·šè³‡è¨Šç¼ºå¤±ï¼Œè«‹é‡æ–°é¸æ“‡ç­æ¬¡');
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'é€å‡ºé ç´„<span class="en-text">Submit Reservation</span>';
      return;
    }
    
    // æå–ç´”ä¸­æ–‡ç«™å
    const extractChineseName = (stop) => stop.split('<')[0];
    const cleanFromStop = extractChineseName(fromStopValue);
    const cleanToStop = extractChineseName(toStopValue);
    
    // æº–å‚™é ç´„è³‡æ–™
    const data = {
      type: 'reserve',
      userId: userData.userId,
      name: userData.name,
      studentId: userData.studentId,
      department: userData.department,
      phone: userData.phone || '',
      route: selectedRoute,
      routeName: `${selectedRoute}ï½œ${info.time} ${info.direction}`,
      fromStop: cleanFromStop,
      toStop: cleanToStop,
      date: selectedDate
    };
    
    console.log('ğŸ“¤ ç™¼é€é ç´„è³‡æ–™:', data);
    
    // ç™¼é€è«‹æ±‚
    const res = await robustFetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    console.log('ğŸ“Š é ç´„å›æ‡‰:', res);
    
    if (res.status === 'success') {
      alert('âœ… é ç´„æˆåŠŸï¼\nâœ… Booking successful!');

      // ğŸš€ ç™¼é€é ç´„æˆåŠŸæ¨æ’­é€šçŸ¥
      try {
        const pushData = {
          type: 'push',
          message: `# ç©¿å±±ç”²å°ˆè»Šæ–°é ç´„\n\næ—¥æœŸï¼š${selectedDate}\nç­æ¬¡ï¼š${selectedRoute} | ${info.time} ${info.direction}\nå§“åï¼š${userData.name}\né›»è©±ï¼š${userData.phone || 'æœªæä¾›'}\nä¸Šè»Šï¼š${cleanFromStop}\nä¸‹è»Šï¼š${cleanToStop}`
        };
        
        console.log('ğŸ“¤ ç™¼é€é ç´„æˆåŠŸæ¨æ’­:', pushData);
        
        // ç™¼é€æ¨æ’­è«‹æ±‚ï¼ˆä¸ç­‰å¾…å›æ‡‰ï¼‰
        fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(pushData)
        }).catch(err => console.warn('é ç´„æ¨æ’­ç™¼é€å¤±æ•—:', err));
        
      } catch (pushErr) {
        console.warn('é ç´„æ¨æ’­é€šçŸ¥å¤±æ•—:', pushErr);
      }

      // âš¡ï¸ ç«‹å³æŠŠé€™ç­†é ç´„åŠ å…¥ç¾æœ‰é™£åˆ—ï¼ˆå‰ç«¯ç«‹å³æ›´æ–°ï¼‰
      existingReservations.push({
        id: res.id || `${userData.userId}-${selectedDate}-${selectedRoute}`,
        userId: userData.userId,
        name: userData.name,
        studentId: userData.studentId,
        department: userData.department,
        phone: userData.phone || '',
        route: selectedRoute,
        date: selectedDate,
        fromStop: cleanFromStop,
        toStop: cleanToStop,
        status: 'å·²é ç´„'
      });

      // âš¡ï¸ ç«‹å³æ›´æ–°ç•«é¢ï¼ˆä¸ç­‰ä¼ºæœå™¨å›å‚³ï¼‰
      renderCurrentReservationCard();

      // ğŸ” æ¸…é™¤é¸é …ã€å›å¾©æŒ‰éˆ•
      resetReservationForm();

      // ğŸ• å»¶é² 1 ç§’å¾Œï¼Œå†æŠ“ä¼ºæœå™¨è³‡æ–™ï¼Œç¢ºä¿æœ€æ–°ç‹€æ…‹
      setTimeout(() => {
        updateUIAfterReservationChange();
      }, 1000);

    } else {
      alert('âŒ é ç´„å¤±æ•—ï¼š' + (res.message || 'è«‹ç¨å¾Œå†è©¦'));
    }
    
  } catch (error) {
    console.error('é ç´„éŒ¯èª¤:', error);
    alert('âŒ é ç´„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = 'é€å‡ºé ç´„<span class="en-text">Submit Reservation</span>';
  }
}

function resetReservationForm() {
  selectedDate = null;
  selectedRoute = null;
  document.getElementById('selectedDate').style.display = 'none';
  document.getElementById('routeSection').style.display = 'none';
  document.getElementById('fromStopSection').style.display = 'none';
  document.getElementById('toStopSection').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
  document.getElementById('holidayNotice').style.display = 'none';
  
  // åªé‡æ–°æ¸²æŸ“æ—¥æ›†ä¾†æ¸…é™¤é¸æ“‡ç‹€æ…‹
  if (document.getElementById('calendarContainer').style.display === 'block') {
    renderCalendar();
  }
}

// === å–æ¶ˆé ç´„å‡½æ•¸ ===
async function cancelReservation(reservationId) {
  if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†é ç´„å—ï¼Ÿ\nAre you sure you want to cancel this reservation?')) return;

  try {
    console.log('é–‹å§‹å–æ¶ˆé ç´„ Starting cancellation:', reservationId);
    
    // åœ¨å–æ¶ˆå‰å…ˆä¿å­˜è¦å–æ¶ˆçš„é ç´„è³‡æ–™
    const reservationToCancel = existingReservations.find(r => r.id === reservationId);
    
    if (!reservationToCancel) {
      console.error('æ‰¾ä¸åˆ°è¦å–æ¶ˆçš„é ç´„ Reservation not found');
      alert('æ‰¾ä¸åˆ°é ç´„è³‡æ–™ï¼Œè«‹é‡æ–°æ•´ç†é é¢å¾Œå†è©¦\nReservation not found, please refresh and try again');
      return;
    }
    
    // 1. å…ˆåŸ·è¡Œå–æ¶ˆé ç´„
    const response = await robustFetch(WORKER_URL, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ 
        type: 'cancel',
        userId: userData.userId,
        date: reservationToCancel.date
      })
    });

    if (response.status === 'success') {
      alert('âœ… å·²å–æ¶ˆé ç´„\nâœ… Reservation cancelled');

      // ğŸš€ ç™¼é€å–æ¶ˆé ç´„æ¨æ’­é€šçŸ¥
      try {
        const info = routeTimes[reservationToCancel.route] || {};
        
        // æå–ç´”ä¸­æ–‡ç«™å
        const extractChineseName = (stop) => {
          if (!stop) return 'æœªçŸ¥ç«™é»';
          return stop.split('<')[0];
        };
        
        const fromStop = extractChineseName(reservationToCancel.fromStop || 'æœªçŸ¥ä¸Šè»Šç«™');
        const toStop = extractChineseName(reservationToCancel.toStop || 'æœªçŸ¥ä¸‹è»Šç«™');
        const reservationDate = reservationToCancel.date ? reservationToCancel.date.split('T')[0] : 'æœªçŸ¥æ—¥æœŸ';
        const userName = reservationToCancel.name || userData.name || 'æœªçŸ¥ç”¨æˆ¶';

        const pushData = {
          type: 'push',
          message: `# ç©¿å±±ç”²å°ˆè»Šé ç´„å–æ¶ˆ\n\næ—¥æœŸï¼š${reservationDate}\nå§“åï¼š${userName}\nç­æ¬¡ï¼š${reservationToCancel.route} | ${info.time} ${info.direction}\nç‹€æ…‹ï¼šå·²å–æ¶ˆ`
        };

        console.log('ğŸ“¤ ç™¼é€å–æ¶ˆæ¨æ’­æ•¸æ“š:', pushData);
        
        // ç™¼é€æ¨æ’­è«‹æ±‚
        fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(pushData)
        }).catch(err => console.warn('å–æ¶ˆæ¨æ’­ç™¼é€å¤±æ•—:', err));
        
      } catch (pushErr) {
        console.warn('å–æ¶ˆæ¨æ’­é€šçŸ¥å¤±æ•—:', pushErr);
      }

      // === é—œéµæ›´æ–°ï¼šç«‹å³æ›´æ–°ç•«é¢ ===
      await updateUIAfterReservationChange();
      
    } else {
      alert('âŒ å–æ¶ˆå¤±æ•—ï¼š' + (response.message || 'è«‹ç¨å¾Œå†è©¦') + '\nâŒ Cancellation failed: ' + (response.message || 'Please try again later'));
    }
  } catch (error) {
    console.error('å–æ¶ˆé ç´„éŒ¯èª¤ Cancellation error:', error);
    
    let errorMessage = 'âŒ å–æ¶ˆé ç´„æ™‚ç™¼ç”ŸéŒ¯èª¤\nâŒ Error occurred while cancelling reservation';
    
    if (error.message.includes('JSON') || error.message.includes('DOCTYPE')) {
      errorMessage = 'âŒ ä¼ºæœå™¨é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦\nâŒ Server connection failed, please check your network connection';
    } else if (error.message.includes('500')) {
      errorMessage = 'âŒ ä¼ºæœå™¨æš«æ™‚ç„¡æ³•è™•ç†è«‹æ±‚ï¼Œè«‹ç¨å¾Œå†è©¦\nâŒ Server temporarily unavailable, please try again later';
    } else {
      errorMessage += ': ' + error.message;
    }
    
    alert(errorMessage);
  }
}

// === æ ¸å¿ƒæ›´æ–°å‡½æ•¸ï¼šåœ¨é ç´„è®Šæ›´å¾Œç«‹å³æ›´æ–°æ‰€æœ‰ç›¸é—œUI ===
async function updateUIAfterReservationChange() {
  console.log('ğŸ”„ é–‹å§‹æ›´æ–°UIç‹€æ…‹ Starting UI update after reservation change');
  
  try {
    // 1. é‡æ–°è¼‰å…¥ç”¨æˆ¶çš„æœ€æ–°é ç´„è³‡æ–™
    const result = await robustFetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`);
    
    // é—œéµä¿®æ”¹ï¼šéæ¿¾æ‰å·²å–æ¶ˆçš„é ç´„
    existingReservations = (result.reservations || []).filter(reservation => 
      reservation.status !== 'å·²å–æ¶ˆ' && reservation.status !== 'cancelled'
    );
    
    console.log('âœ… é ç´„è³‡æ–™æ›´æ–°æˆåŠŸï¼ˆå·²éæ¿¾å–æ¶ˆçš„é ç´„ï¼‰Reservation data updated:', existingReservations);
    
    // 2. ç«‹å³é‡æ–°æ¸²æŸ“é ç´„å¡ç‰‡
    renderCurrentReservationCard();
    
    // 3. å¦‚æœæœˆæ›†æ˜¯æ‰“é–‹çš„ï¼Œé‡æ–°æ¸²æŸ“æœˆæ›†ä»¥æ›´æ–°ç‹€æ…‹
    if (document.getElementById('calendarContainer').style.display === 'block') {
      console.log('ğŸ”„ é‡æ–°æ¸²æŸ“æœˆæ›†ç‹€æ…‹ Re-rendering calendar state');
      renderCalendar();
    }
    
    console.log('âœ… UIæ›´æ–°å®Œæˆ UI update completed');
    
  } catch (error) {
    console.error('âŒ UIæ›´æ–°å¤±æ•— UI update failed:', error);
    // å³ä½¿æ›´æ–°å¤±æ•—ï¼Œä¹Ÿå˜—è©¦é‡æ–°æ¸²æŸ“ç¾æœ‰è³‡æ–™
    renderCurrentReservationCard();
    if (document.getElementById('calendarContainer').style.display === 'block') {
      renderCalendar();
    }
  }
}

// === è¼‰å…¥é ç´„ï¼ˆç”¨æ–¼åˆå§‹åŒ–ï¼‰===
async function loadExistingReservations() {
  try {
    console.log('è¼‰å…¥é ç´„è¨˜éŒ„... Loading reservation records...');
    const result = await getCachedData('reservations', async () => {
      const res = await robustFetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`);
      return res;
    });
    
    console.log('é ç´„è¨˜éŒ„è¼‰å…¥çµæœ Reservation records loaded:', result);
    
    // é—œéµä¿®æ”¹ï¼šéæ¿¾æ‰å·²å–æ¶ˆçš„é ç´„
    existingReservations = (result.reservations || []).filter(reservation => 
      reservation.status !== 'å·²å–æ¶ˆ' && reservation.status !== 'cancelled'
    );
    
    console.log('âœ… éæ¿¾å¾Œçš„é ç´„è³‡æ–™ Filtered reservations:', existingReservations);
    
    // ç›´æ¥å‘¼å«æ¸²æŸ“å‡½æ•¸
    renderCurrentReservationCard();
  } catch (e) {
    console.error('è¼‰å…¥é ç´„å¤±æ•— Failed to load reservations', e);
    existingReservations = [];
    renderCurrentReservationCard();
  }
}

// === ğŸ“… æ©«å‘è¼ªæ’­å¼é ç´„å¡ç‰‡ ===
function renderCurrentReservationCard() {
  const container = document.getElementById('currentReservationCard');
  
  // é—œéµä¿®æ”¹ï¼šåªé¡¯ç¤ºæœªå–æ¶ˆçš„é ç´„
  const activeReservations = existingReservations.filter(r => 
    r.status !== 'å·²å–æ¶ˆ' && r.status !== 'cancelled'
  );
  
  if (!activeReservations || activeReservations.length === 0) {
    container.innerHTML = '<div class="no-reservation">ç›®å‰æ²’æœ‰é ç´„ç´€éŒ„<br><span style="color: #666;">No Reservation Records</span></div>';
    container.style.display = 'block';
    return;
  }
  
  let html = '<div class="carousel-container">';
  html += '<div class="carousel-title">ğŸ§¾ æˆ‘çš„é ç´„<br><span style="color: #666; font-size: 14px;">My Reservations</span></div>';
  html += '<div class="carousel">';
  
  activeReservations.forEach(r => {
    const routeInfo = routeTimes[r.route] || { time: r.route, direction: 'æœªçŸ¥è·¯ç·š', eng: 'Unknown Route' };
    const dateObj = new Date(r.date);
    const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
    const weekdayEn = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const dayOfWeek = weekdays[dateObj.getDay()];
    const dayOfWeekEn = weekdayEn[dateObj.getDay()];
    
    // è·¯ç·šæ–¹å‘ä¸­è‹±å°ç…§
    let directionZh = routeInfo.direction;
    let directionEn = routeInfo.eng;
    
    // ç«™é»ä¸­è‹±å°ç…§æ˜ å°„
    const stopMap = {
      'è¡Œæ”¿å¤§æ¨“': 'NCNU Administrative Building',
      'ä¸­é¤å»³': 'Zhong Can Ting(Chinese Restaurant)',
      'ç§‘æŠ€å­¸é™¢': 'College of Science and Technology',
      'å­¸äººæœƒé¤¨': 'Scholars\' Residence',
      'ä¸­åŸ': 'Zhongcheng',
      'ä¸‹åŸ': 'Xiacheng',
      'åªé ‚': 'Pingding',
      'æ„›è˜­æ©‹': 'Ailan Bridge',
      'å¤§æˆåœ‹å°': 'Dacheng Elementary School',
      'ä¸­å±±å®‰ä¸ƒè¡—å£': 'Zhongshan Anqi St. Intersection',
      'æ¦®æ°‘è¨ºæ‰€': 'Veterans Clinic',
      'åŸ”é‡Œé…’å» ': 'Puli Distillery',
      'åŸ”é‡Œç¸½ç«™': 'Puli Bus Terminal'
    };
    
    const fromStopEn = stopMap[r.fromStop] || r.fromStop;
    const toStopEn = stopMap[r.toStop] || r.toStop;
    
    html += `
      <div class="reservation-bubble" style="min-width: 190px;">
        <div class="bubble-header">
          ${r.date.split('T')[0]} (é€±${dayOfWeek})
          <span style="color: #ffffff; font-size: 12px;">${r.date.split('T')[0]} (${dayOfWeekEn})</span>
        </div>
        <div class="bubble-body">
          <div class="bubble-line">
            <strong>ç­æ¬¡<br><span style="color: #666; font-size: 11px;">Time</span></strong>
            <span class="route-time">${routeInfo.time}</span>
          </div>
          <div class="bubble-line">
            <strong>è·¯ç·š<br><span style="color: #666; font-size: 11px;">Route</span></strong>
            <span>
              ${directionZh}<br>
              <span style="color: #666; font-size: 11px;">${directionEn}</span>
            </span>
          </div>
          <div class="bubble-line">
            <strong>ä¸Šè»Šç«™<br><span style="color: #666; font-size: 11px;">From</span></strong>
            <span>
              ${r.fromStop}<br>
              <span style="color: #666; font-size: 11px;">${fromStopEn}</span>
            </span>
          </div>
          <div class="bubble-line">
            <strong>ä¸‹è»Šç«™<br><span style="color: #666; font-size: 11px;">To</span></strong>
            <span>
              ${r.toStop}<br>
              <span style="color: #666; font-size: 11px;">${toStopEn}</span>
            </span>
          </div>
        </div>
        <div class="bubble-footer">
          <button class="cancel-btn-small" onclick="cancelReservation('${r.id}')" aria-label="å–æ¶ˆé ç´„ Cancel Reservation">
            å–æ¶ˆé ç´„<br>
            <span style="color: #ffffff; font-size: 10px; opacity: 0.8;">Cancel</span>
          </button>
        </div>
      </div>
    `;
  });
  
  html += '</div></div>';
  container.innerHTML = html;
  container.style.display = 'block';
}

function getDayOfWeek(dateStr) {
  const d = new Date(dateStr);
  const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  return 'é€±' + weekdays[d.getDay()];
}

function formatDateToLocal(date) {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
}

// === é ç´„è¦å‰‡é©—è­‰å‡½æ•¸ ===
class ReservationValidator {
  // R4: éå»æ—¥æœŸæª¢æŸ¥
  static isPastDate(dateStr) {
    const selected = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return selected < today;
  }

  // R5: åœé§›æ—¥æª¢æŸ¥
  static isNoServiceDate(dateStr) {
    return noServiceDates[dateStr] === true;
  }

  // R7: é ç´„æˆªæ­¢æ™‚é–“æª¢æŸ¥
  static isAfterDeadline(dateStr) {
    const today = new Date();
    const selected = new Date(dateStr);
    
    // å¦‚æœæ˜¯ä»Šå¤©ï¼Œæª¢æŸ¥æ˜¯å¦è¶…é19:00
    if (this.isToday(dateStr)) {
      const now = new Date();
      const [deadlineHour, deadlineMinute] = RESERVATION_RULES.dailyDeadline.split(':');
      const deadline = new Date();
      deadline.setHours(parseInt(deadlineHour), parseInt(deadlineMinute), 0, 0);
      return now > deadline;
    }
    return false;
  }

  // R13: æœªä¾†å¤©æ•¸é™åˆ¶
  static isWithinBookingWindow(dateStr) {
    const selected = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const maxDate = new Date();
    maxDate.setDate(today.getDate() + RESERVATION_RULES.maxDaysAhead);
    maxDate.setHours(23, 59, 59, 999);
    
    return selected >= today && selected <= maxDate;
  }

  // è¼”åŠ©å‡½æ•¸ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºä»Šå¤©
  static isToday(dateStr) {
    const today = formatDateToLocal(new Date());
    return dateStr === today;
  }

  // æ–¹æ¡ˆBæ ¸å¿ƒï¼šé‡è¤‡é ç´„æª¢æŸ¥ - æ¯å¤©åªèƒ½æœ‰1ç­†é ç´„
  static hasExistingReservation(userId, dateStr) {
    const userReservations = existingReservations.filter(
      res => res.userId === userId && 
             res.date.split('T')[0] === dateStr && 
             res.status !== 'å·²å–æ¶ˆ' && res.status !== 'cancelled'
    );
    return userReservations.length >= RESERVATION_RULES.maxPerDay;
  }

  // R11, R12: ç«™é»é©—è­‰ - ä¿®æ”¹ç‚ºå…è¨±ä»»é¸ä¸Šä¸‹è»Šé»
  static validateStops(route, fromStop, toStop) {
    // æå–ç´”ä¸­æ–‡ç«™åé€²è¡Œæ¯”è¼ƒ
    const extractChineseName = (stop) => stop.split('<')[0];
    
    const cleanFromStop = extractChineseName(fromStop);
    const cleanToStop = extractChineseName(toStop);
    
    // æª¢æŸ¥ä¸Šä¸‹è»Šç«™æ˜¯å¦ç›¸åŒ
    if (cleanFromStop === cleanToStop) {
      return false;
    }
    
    // æ ¹æ“šè·¯ç·šæ–¹å‘ç²å–å¯ç”¨ç«™é»åˆ—è¡¨
    const isOutbound = route.includes('A');
    const stops = isOutbound ? stopsOutbound : stopsReturn;
    const stopNames = stops.map(stop => extractChineseName(stop));
    
    // æª¢æŸ¥ä¸Šä¸‹è»Šç«™æ˜¯å¦éƒ½åœ¨å¯ç”¨ç«™é»åˆ—è¡¨ä¸­
    const isValidFromStop = stopNames.includes(cleanFromStop);
    const isValidToStop = stopNames.includes(cleanToStop);
    
    return isValidFromStop && isValidToStop;
  }

  // ç¶œåˆé©—è­‰å‡½æ•¸
  static async validateReservation(userId, dateStr, route, fromStop, toStop) {
    const errors = [];

    if (this.isPastDate(dateStr)) {
      errors.push('ç„¡æ³•é ç´„éå»æ—¥æœŸ Cannot book past dates');
    }

    if (this.isNoServiceDate(dateStr)) {
      errors.push('è©²æ—¥æœŸç‚ºåœé§›æ—¥ï¼Œç„¡æ³•é ç´„ No service on this date, cannot book');
    }

    if (!this.isWithinBookingWindow(dateStr)) {
      errors.push(`åªèƒ½é ç´„æœªä¾† ${RESERVATION_RULES.maxDaysAhead} å¤©å…§çš„ç­æ¬¡ Can only book within ${RESERVATION_RULES.maxDaysAhead} days`);
    }

    if (this.isAfterDeadline(dateStr)) {
      errors.push(`ä»Šæ—¥é ç´„å·²æˆªæ­¢ï¼ˆ${RESERVATION_RULES.dailyDeadline}ï¼‰ Today's booking deadline passed (${RESERVATION_RULES.dailyDeadline})`);
    }

    // æ–¹æ¡ˆBæ ¸å¿ƒè¦å‰‡ï¼šæ¯å¤©åªèƒ½é ç´„1å€‹ç­æ¬¡
    if (this.hasExistingReservation(userId, dateStr)) {
      errors.push('æ¯å¤©åªèƒ½é ç´„ä¸€å€‹ç­æ¬¡ï¼Œæ‚¨ç•¶å¤©å·²æœ‰é ç´„ Only one booking per day, you already have a reservation');
    }

    // æª¢æŸ¥å®¹é‡
    const isFull = await this.isRouteFull(dateStr, route);
    if (isFull) {
      errors.push('è©²ç­æ¬¡å·²é¡æ»¿ This time slot is full');
    }

    // æª¢æŸ¥ç«™é»
    if (!this.validateStops(route, fromStop, toStop)) {
      errors.push('ç«™é»é¸æ“‡ç„¡æ•ˆ Invalid stop selection');
    }

    return {
      isValid: errors.length === 0,
      errors: errors
    };
  }

  // æª¢æŸ¥è·¯ç·šæ˜¯å¦å·²æ»¿
  static async isRouteFull(dateStr, route) {
    try {
      const currentCount = await getRouteReservationCount(dateStr, route);
      return currentCount >= RESERVATION_RULES.seatLimit;
    } catch (error) {
      console.error('æª¢æŸ¥è·¯ç·šå®¹é‡å¤±æ•—:', error);
      return true; // å¦‚æœæª¢æŸ¥å¤±æ•—ï¼Œä¿å®ˆèµ·è¦‹èªç‚ºå·²æ»¿
    }
  }
}

// éŒ¯èª¤é¡¯ç¤ºè¼”åŠ©å‡½æ•¸
function showError(message) {
  document.getElementById('holidayNotice').style.display = 'block';
  document.getElementById('holidayNotice').innerHTML = message;
  document.getElementById('selectedDate').style.display = 'none';
  resetSelection();
}

function resetSelection() {
  selectedDate = null;
  selectedRoute = null;
  document.getElementById('routeSection').style.display = 'none';
  document.getElementById('fromStopSection').style.display = 'none';
  document.getElementById('toStopSection').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
}

// æ·»åŠ éµç›¤å°èˆªæ”¯æŒ
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    // ESC éµé—œé–‰æœˆæ›†
    if (document.getElementById('calendarContainer').style.display === 'block') {
      toggleCalendar();
    }
  }
});

// åˆå§‹åŒ–ç³»çµ±
window.addEventListener('load', init);
</script>
</body>
</html>
