<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šé ç´„ Pangolin Shuttle Reservation</title>
<style>
/* âœ… æ¨£å¼ç¶­æŒä½ åŸç‰ˆçµæ§‹ */
body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; line-height:1.3; }
.en-text { display:block; font-size:14px; color:#fff; margin-top:2px; }
.en-text-dark { display:block; font-size:14px; color:#666; margin-top:2px; }
/* å…¶ä»–æ¨£å¼ä¿æŒä¸€è‡´ */
</style>
</head>
<body>
<header>
  ç©¿å±±ç”²å°ˆè»Šé ç´„
  <span class="en-text">Pangolin Shuttle Reservation</span>
</header>

<div id="userInfo" class="user-section">
  <div class="loading-state">â³ ç³»çµ±åˆå§‹åŒ–ä¸­...<span class="en-text-dark">System initializing...</span></div>
</div>

<div style="display:flex;gap:10px;margin:10px 16px;align-items:center;">
  <button id="calendarBtn" onclick="toggleCalendar()" style="flex:1;">ğŸ“… æ‰“é–‹æœˆæ›†<span class="en-text">Open Calendar</span></button>
  <button id="rulesBtn" onclick="openRules()" style="background:#3C8050;color:white;border:none;padding:12px 16px;border-radius:6px;font-weight:bold;">ğŸ“– é ç´„è¦å‰‡<span class="en-text">Reservation Rules</span></button>
</div>

<div id="calendarContainer" style="display:none;margin-top:10px;padding:0 16px;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <button onclick="changeMonth(-1)">â—€ ä¸Šå€‹æœˆ<span class="en-text-dark">Prev</span></button>
    <h3 id="calendarTitle"></h3>
    <button onclick="changeMonth(1)">ä¸‹å€‹æœˆ â–¶<span class="en-text-dark">Next</span></button>
  </div>
  <div id="calendar" class="calendar"></div>
</div>

<div id="selectedDate" class="notice success" style="display:none;"></div>
<div id="holidayNotice" class="notice error" style="display:none;"></div>

<div id="routeSection" class="route-section" style="display:none;">
  <h3>è«‹é¸æ“‡æ­ä¹˜ç­æ¬¡<span class="en-text-dark">Select Shuttle Time</span></h3>
  <div id="routeButtons" class="route-buttons"></div>
</div>

<div id="fromStopSection" class="stop-selector" style="display:none;">
  <h3>è«‹é¸æ“‡ä¸Šè»Šç«™<span class="en-text-dark">Pick-up Stop</span></h3>
  <select id="fromStop"><option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option></select>
</div>

<div id="toStopSection" class="stop-selector" style="display:none;">
  <h3>è«‹é¸æ“‡ä¸‹è»Šç«™<span class="en-text-dark">Drop-off Stop</span></h3>
  <select id="toStop"><option value="">è«‹å…ˆé¸æ“‡ä¸Šè»Šç«™</option></select>
</div>

<button id="submitBtn" class="submit-btn" onclick="submitReservation()" style="display:none;">é€å‡ºé ç´„<span class="en-text">Submit</span></button>

<div id="currentReservationCard" style="display:none;"></div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
/* ================= å…¨åŸŸè®Šæ•¸ ================= */
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let userData=null, existingReservations=[], selectedDate=null, selectedRoute=null;
let stopsOutbound=[], stopsReturn=[], routeTimes={};

/* ========== åˆå§‹åŒ– ========== */
window.addEventListener('load',init);
async function init(){
  try{
    await loadRules();
    await liff.init({ liffId:"2006590746-KJodGOda" });
    if(!liff.isLoggedIn()) return liff.login();
    const profile=await liff.getProfile();
    const [userCheck,reservations]=await Promise.all([
      fetch(`${WORKER_URL}?check=${profile.userId}`).then(r=>r.json()),
      fetch(`${WORKER_URL}?mode=reservations&userId=${profile.userId}`).then(r=>r.json())
    ]);
    if(!userCheck.registered) return location.href='register.html';
    userData=userCheck.user;
    existingReservations=reservations.reservations||[];
    renderUserInfo();
    renderCurrentReservationCard();
  }catch(e){
    document.getElementById('userInfo').innerHTML=`<div style="color:red;">ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼š${e.message}</div>`;
  }
}

/* ========== è¦å‰‡èˆ‡ç«™é»è³‡æ–™ ========== */
async function loadRules(){
  stopsOutbound=["è¡Œæ”¿å¤§æ¨“","ä¸­é¤å»³","ç§‘æŠ€å­¸é™¢","å­¸äººæœƒé¤¨","ä¸­åŸ","ä¸‹åŸ","åªé ‚","æ„›è˜­æ©‹","å¤§æˆåœ‹å°","ä¸­å±±å®‰ä¸ƒè¡—å£","æ¦®æ°‘è¨ºæ‰€","åŸ”é‡Œé…’å» ","åŸ”é‡Œç¸½ç«™"];
  stopsReturn=[...stopsOutbound].reverse();
  routeTimes={
    'A1':{time:'22:00-22:30',direction:'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™',eng:'NCNU â†’ Puli Terminal'},
    'B1':{time:'22:30-23:00',direction:'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§',eng:'Puli Terminal â†’ NCNU'},
    'A2':{time:'23:00-23:30',direction:'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™',eng:'NCNU â†’ Puli Terminal'},
    'B2':{time:'23:30-24:00',direction:'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§',eng:'Puli Terminal â†’ NCNU'}
  };
}

/* ========== é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š ========== */
function renderUserInfo(){
  document.getElementById('userInfo').innerHTML=
    `<div class="user-name">${userData.name}</div>
     <div class="user-info">${userData.department} | ${userData.studentId}</div>`;
}

/* ========== æœˆæ›†åŠŸèƒ½ï¼ˆç°¡åŒ–ï¼‰ ========== */
function toggleCalendar(){
  const c=document.getElementById('calendarContainer');
  c.style.display=c.style.display==='none'?'block':'none';
  if(c.style.display==='block')renderCalendar();
}
function renderCalendar(){
  const c=document.getElementById('calendar');
  c.innerHTML='';
  const today=new Date();
  const year=today.getFullYear(),month=today.getMonth();
  document.getElementById('calendarTitle').innerText=`${year}å¹´${month+1}æœˆ`;
  const lastDay=new Date(year,month+1,0).getDate();
  for(let d=1;d<=lastDay;d++){
    const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const div=document.createElement('div');
    div.className='calendar-day';
    div.textContent=d;
    div.onclick=()=>selectDate(dateStr);
    c.appendChild(div);
  }
}
function selectDate(dateStr){
  selectedDate=dateStr;
  document.getElementById('selectedDate').style.display='block';
  document.getElementById('selectedDate').innerHTML=`âœ… å·²é¸æ“‡æ—¥æœŸï¼š${dateStr}<br><span style="color:#666">Selected: ${dateStr}</span>`;
  showRouteSelection();
}

/* ========== ç­æ¬¡é¸æ“‡ ========== */
function showRouteSelection(){
  const c=document.getElementById('routeButtons');
  c.innerHTML='';
  Object.entries(routeTimes).forEach(([id,info])=>{
    const b=document.createElement('div');
    b.className='route-btn';
    b.innerHTML=`${id}<br>${info.time}<br>${info.direction}<br><span style="color:#666">${info.eng}</span>`;
    b.onclick=()=>selectRoute(id,info.direction);
    c.appendChild(b);
  });
  document.getElementById('routeSection').style.display='block';
}
function selectRoute(routeId,direction){
  selectedRoute=routeId;
  document.querySelectorAll('.route-btn').forEach(b=>b.classList.remove('selected'));
  event.target.classList.add('selected');
  showStopSelection(direction);
}

/* ========== ä¸Šä¸‹è»Šé¸æ“‡ ========== */
function showStopSelection(direction){
  const from=document.getElementById('fromStop'),to=document.getElementById('toStop');
  const outbound=direction.includes('æš¨å¤§â†’');
  const stops=outbound?stopsOutbound:stopsReturn;
  from.innerHTML=stops.map(s=>`<option value="${s}">${s}</option>`).join('');
  to.innerHTML=stops.map(s=>`<option value="${s}">${s}</option>`).join('');
  document.getElementById('fromStopSection').style.display='block';
  document.getElementById('toStopSection').style.display='block';
  from.onchange=checkSubmitReady;to.onchange=checkSubmitReady;
}
function checkSubmitReady(){
  const f=document.getElementById('fromStop').value;
  const t=document.getElementById('toStop').value;
  document.getElementById('submitBtn').style.display=(f&&t)?'block':'none';
}

/* ========== æäº¤é ç´„ ========== */
async function submitReservation(){
  const fromStopValue=document.getElementById('fromStop').value;
  const toStopValue=document.getElementById('toStop').value;
  if(!selectedDate||!selectedRoute||!fromStopValue||!toStopValue){
    alert('âŒ è«‹å®Œæ•´é¸æ“‡æ—¥æœŸã€ç­æ¬¡èˆ‡ç«™é»');
    return;
  }
  const payload={
    type:'reserve',
    userId:userData.userId,
    name:userData.name,
    studentId:userData.studentId,
    department:userData.department,
    phone:userData.phone||'',
    route:selectedRoute,
    fromStop:fromStopValue,
    toStop:toStopValue,
    date:selectedDate
  };
  const res=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const result=await res.json();
  if(result.status==='success'){
    alert('âœ… é ç´„æˆåŠŸï¼Booking Successful!');
    existingReservations.push(payload);
    renderCurrentReservationCard();
    resetSelection();
  }else alert('âŒ é ç´„å¤±æ•—ï¼š'+(result.message||'è«‹ç¨å¾Œå†è©¦'));
}

/* ========== é ç´„ç´€éŒ„ ========== */
function renderCurrentReservationCard(){
  const c=document.getElementById('currentReservationCard');
  if(!existingReservations.length){
    c.innerHTML='<div class="no-reservation">å°šç„¡é ç´„ç´€éŒ„<br><span style="color:#666">No Reservation</span></div>';
  }else{
    let html='<div class="carousel-container"><div class="carousel-title">ğŸ§¾ æˆ‘çš„é ç´„<br><span style="color:#666">My Reservations</span></div>';
    existingReservations.forEach(r=>{
      const rt=routeTimes[r.route]||{time:r.route,direction:'æœªçŸ¥'};
      html+=`<div class="reservation-bubble">
        <div class="bubble-header">${r.date}</div>
        <div class="bubble-body">
          <div>ç­æ¬¡ Timeï¼š${r.route} ${rt.time}</div>
          <div>è·¯ç·š Routeï¼š${rt.direction}</div>
          <div>ä¸Šè»Š Fromï¼š${r.fromStop}</div>
          <div>ä¸‹è»Š Toï¼š${r.toStop}</div>
        </div>
      </div>`;
    });
    html+='</div>';
    c.innerHTML=html;
  }
  c.style.display='block';
}

/* ========== é‡ç½®é¸æ“‡ ========== */
function resetSelection(){
  selectedDate=null;selectedRoute=null;
  document.getElementById('routeSection').style.display='none';
  document.getElementById('fromStopSection').style.display='none';
  document.getElementById('toStopSection').style.display='none';
  document.getElementById('submitBtn').style.display='none';
}

/* ========== é ç´„è¦å‰‡é é¢é–‹å•Ÿ ========== */
function openRules(){window.open('https://line.me/R/home/public/post?postId=1176044641970348675','_blank');}
</script>
</body>
</html>
