<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ç©¿å±±ç”²å°ˆè»Šé ç´„ ğŸš</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
/* ====== ç•¥ï¼ˆæ¨£å¼ç¶­æŒä¸è®Šï¼‰ ====== */
body {font-family: system-ui, "Noto Sans TC", sans-serif; background:#f5f6f7; margin:0; display:flex; flex-direction:column; min-height:100vh;}
header {background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; line-height:1.4;}
main {flex:1; padding-bottom:40px;}
.notice {padding:10px 16px; margin:10px 16px; border-radius:6px;}
.notice.success {background:#e8f5e9; color:#2e7d32; border:1px solid #81c784;}
.notice.error {background:#fdecea; color:#b71c1c; border:1px solid #f5c2c7;}
.calendar {display:grid; grid-template-columns:repeat(7,1fr); gap:3px; text-align:center; font-size:13px; margin-bottom:20px;}
.calendar-day {padding:8px 0; min-height:45px; border-radius:4px; background:#fff; border:1px solid #e0e0e0; cursor:pointer;}
.calendar-day:hover {background:#eaf5ea;} .calendar-day.past{background:#f5f5f5;color:#ccc;cursor:not-allowed;}
.calendar-day.selected{background:#3c8050;color:#fff;font-weight:bold;}
.route-section,.stop-selector{padding:0 16px;margin:20px 0;}
.route-buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.route-btn{padding:12px;border:2px solid #3c8050;border-radius:8px;background:white;cursor:pointer;text-align:center;}
.route-btn:hover{background:#eaf5ea;} .route-btn.selected{background:#3c8050;color:white;}
select{width:100%;padding:12px;border:1px solid #ccc;border-radius:6px;margin-top:8px;}
.submit-btn{background:#3c8050;color:white;border:none;padding:15px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;width:calc(100% - 32px);margin:20px 16px;}
.submit-btn:hover{background:#2d6140;}
.btn-group{display:flex;justify-content:center;gap:12px;margin:15px;}
.btn-large{font-size:18px;padding:12px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;}
.btn-calendar{background:#3c8050;color:white;} .btn-calendar:hover{background:#2d6140;}
.btn-rule{background:#e0e0e0;color:#333;} .btn-rule:hover{background:#d6d6d6;}
.cancel-btn{background:#c62828;color:white;border:none;padding:10px 20px;border-radius:6px;font-weight:bold;cursor:pointer;margin-top:8px;width:100%;}
.cancel-btn:hover{background:#b71c1c;}
.resv-card{background:#f0fdf4;border:1px solid #a5d6a7;padding:10px 16px;border-radius:8px;margin:10px 16px;}
.resv-row{margin:4px 0;}
#reservationPanel{margin-top:40px;padding:10px 0 20px 0;background:#ffffff;border-top:3px solid #3c8050;box-shadow:0 -3px 5px rgba(0,0,0,0.1);}
</style>
</head>

<body>
<header>
  ç©¿å±±ç”²å°ˆè»Šé ç´„<br>
  <span style="font-size:16px;font-weight:normal">Pangolin Shuttle Reservation</span>
</header>

<main>
  <div id="userInfo" style="padding:16px"><div>â³ ç³»çµ±åˆå§‹åŒ–ä¸­...</div></div>

  <div class="btn-group">
    <button id="calendarBtn" class="btn-large btn-calendar" onclick="toggleCalendar()">ğŸ“… æ‰“é–‹æœˆæ›†</button>
    <button id="ruleBtn" class="btn-large btn-rule" onclick="showRules()">ğŸ“˜ é ç´„è¦å‰‡</button>
  </div>

  <div id="calendarContainer" style="display:none;margin-top:10px;padding:0 16px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <button onclick="changeMonth(-1)">â—€ ä¸Šå€‹æœˆ</button>
      <h3 id="calendarTitle"></h3>
      <button onclick="changeMonth(1)">ä¸‹å€‹æœˆ â–¶</button>
    </div>
    <div id="calendar" class="calendar"></div>
  </div>

  <div id="selectedDate" class="notice success" style="display:none"></div>

  <div id="routeSection" class="route-section" style="display:none">
    <h3>è«‹é¸æ“‡æ­ä¹˜ç­æ¬¡</h3>
    <div id="routeButtons" class="route-buttons"></div>
  </div>

  <div id="fromStopSection" class="stop-selector" style="display:none">
    <h3>è«‹é¸æ“‡ä¸Šè»Šç«™</h3>
    <select id="fromStop"><option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option></select>
  </div>

  <div id="toStopSection" class="stop-selector" style="display:none">
    <h3>è«‹é¸æ“‡ä¸‹è»Šç«™</h3>
    <select id="toStop"><option value="">è«‹é¸æ“‡ä¸Šè»Šç«™</option></select>
  </div>

  <button id="submitBtn" class="submit-btn" onclick="submitReservation()" style="display:none">é€å‡ºé ç´„</button>

  <div id="reservationPanel" style="display:none">
    <div style="text-align:center;font-weight:bold;color:#2d6140;margin-bottom:5px;">æˆ‘çš„é ç´„ç´€éŒ„</div>
    <div id="reservationInfo"></div>
  </div>
</main>

<script>
const WORKER_URL='https://delicate-math-7e61.fangwl591021.workers.dev/';
let userData=null, existingReservations=[], selectedDate=null, selectedRoute=null;
let currentYear=new Date().getFullYear(), currentMonth=new Date().getMonth();

/* === åˆå§‹åŒ– === */
async function init(){
  try {
    await liff.init({liffId:"2006590746-KJodGOda"});
    if(!liff.isLoggedIn()) return liff.login();
    
    const profile = await liff.getProfile();
    console.log('ğŸ‘¤ LINE ç”¨æˆ¶è³‡æ–™:', profile);
    
    const [checkRes, reservations] = await Promise.all([
      fetch(`${WORKER_URL}?mode=check&userId=${profile.userId}`).then(r=>r.json()),
      fetch(`${WORKER_URL}?mode=reservations&userId=${profile.userId}`).then(r=>r.json())
    ]);
    
    if(!checkRes.registered){
      alert("æ‚¨å°šæœªè¨»å†Šï¼Œè«‹å…ˆå®Œæˆè¨»å†Šã€‚");
      return location.href='register.html';
    }

    userData = checkRes.user || {};
    userData.lineDisplayName = profile.displayName;
    userData.linePictureUrl = profile.pictureUrl;

    // é˜²å‘†å¡«å€¼
    if (!userData.name) userData.name = profile.displayName || "æœªå¡«å§“å";
    if (!userData.phone) userData.phone = "æœªå¡«æ‰‹æ©Ÿ";

    renderUser(userData);

    existingReservations = reservations.reservations || [];
    console.log('ğŸ“¦ é ç´„åˆ—è¡¨:', existingReservations);

    renderReservationInfo();
    loadCalendar();
  } catch (err) {
    console.error('âŒ åˆå§‹åŒ–éŒ¯èª¤:', err);
    alert('ç³»çµ±éŒ¯èª¤: ' + err.message);
  }
}

/* === é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š === */
function renderUser(u){
  document.getElementById('userInfo').innerHTML=`
    <div style="display:flex;align-items:center;gap:12px">
      <img src="${u.linePictureUrl}" alt="é ­åƒ" style="width:50px;height:50px;border-radius:50%;border:2px solid #3c8050">
      <div>
        <div style="font-size:18px;font-weight:bold">${u.lineDisplayName}</div>
        <div style="font-size:14px;color:#666;margin-top:2px">${u.department||'æœªå¡«ç³»æ‰€'} | ${u.phone||'æœªå¡«æ‰‹æ©Ÿ'}</div>
      </div>
    </div>`;
}

/* === é€å‡ºé ç´„ === */
async function submitReservation(){
  const fromStop = document.getElementById('fromStop').value;
  const toStop = document.getElementById('toStop').value;
  if(!selectedDate || !selectedRoute || !fromStop || !toStop){alert('è«‹å®Œæˆæ‰€æœ‰é¸æ“‡');return;}
  if(!confirm(`ç¢ºå®šé ç´„å—ï¼Ÿ\n\næ—¥æœŸï¼š${selectedDate}\nç­æ¬¡ï¼š${selectedRoute}\nä¸Šè»Šï¼š${fromStop}\nä¸‹è»Šï¼š${toStop}`)) return;

  const payload = {
    type: 'reserve',
    userId: userData.userId,
    name: userData.name || userData.lineDisplayName || "æœªå¡«å§“å",
    phone: userData.phone || "æœªå¡«æ‰‹æ©Ÿ",
    date: selectedDate,
    route: selectedRoute,
    fromStop, toStop
  };

  console.log('ğŸ“¤ é€å‡ºé ç´„:', payload);

  try {
    const res = await fetch(WORKER_URL, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const result = await res.json();
    if(result.status === 'success'){
      alert('âœ… é ç´„æˆåŠŸï¼');
      const newData = await fetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`).then(r=>r.json());
      existingReservations = newData.reservations || [];
      renderReservationInfo();
    }else alert('âŒ é ç´„å¤±æ•—ï¼š'+(result.message||'æœªçŸ¥éŒ¯èª¤'));
  }catch(err){alert('âŒ ç¶²è·¯éŒ¯èª¤ï¼š'+err.message);}
}

/* === é ç´„ç´€éŒ„ === */
function renderReservationInfo(){
  const panel=document.getElementById('reservationPanel'), box=document.getElementById('reservationInfo');
  if(!existingReservations.length){panel.style.display='none';return;}
  panel.style.display='block';
  const filtered=existingReservations.filter(r=>r.status && r.status.includes('é ç´„'));
  box.innerHTML=filtered.map(r=>`
    <div class="resv-card">
      <div><b>æ—¥æœŸï¼š</b>${r.date}</div>
      <div><b>ç­æ¬¡ï¼š</b>${r.route}</div>
      <div><b>ä¸Šè»Šï¼š</b>${r.fromStop}</div>
      <div><b>ä¸‹è»Šï¼š</b>${r.toStop}</div>
      <button class="cancel-btn" onclick="cancelReservation('${r.reservationId}','id')">å–æ¶ˆé ç´„</button>
    </div>`).join('');
}

function showRules(){
  alert("ğŸ“˜ é ç´„è¦å‰‡ï¼š\n1ï¸âƒ£ æ¯äººæ¯æ—¥é™é ç´„ä¸€å€‹ç­æ¬¡\n2ï¸âƒ£ è«‹æ–¼æ­ä¹˜æ—¥å‰ä¸€å¤©é ç´„\n3ï¸âƒ£ å¦‚éœ€å–æ¶ˆè«‹æå‰é€šçŸ¥\n4ï¸âƒ£ ä¸Šè»Šæ™‚è«‹ä¸»å‹•å‡ºç¤ºé ç´„ç´€éŒ„");
}

window.addEventListener('load',init);
</script>
</body>
</html>
