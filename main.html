<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>穿山甲專車預約</title>
  <style>
    /* 原有樣式保持不變 */
    body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
    header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; }
    /* ... 其他樣式保持不變 ... */
  </style>
</head>
<body>
  <!-- 原有 HTML 結構保持不變 -->
  <header>穿山甲專車預約</header>

  <div id="userInfo" class="user-section" style="padding:16px;">
    <div class="loading-state">⏳ 系統初始化中...</div>
  </div>

  <button id="calendarBtn" onclick="toggleCalendar()">📅 打開月曆</button>

  <div id="calendarContainer" style="display:none;margin-top:10px; padding:0 16px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <button onclick="changeMonth(-1)" style="width:auto; padding:5px 10px;">◀ 上個月</button>
      <h3 id="calendarTitle" style="margin:0; font-size:16px;"></h3>
      <button onclick="changeMonth(1)" style="width:auto; padding:5px 10px;">下個月 ▶</button>
    </div>
    <div id="calendar" class="calendar"></div>
  </div>

  <div id="selectedDate" class="notice success" style="display:none;"></div>
  <div id="holidayNotice" class="notice error" style="display:none;"></div>

  <div id="routeSection" class="route-section" style="display:none;">
    <h3>請選擇搭乘班次</h3>
    <div id="routeButtons" class="route-buttons"></div>
  </div>

  <div id="stopSection" class="stop-selector" style="display:none;">
    <h3>請選擇下車站</h3>
    <select id="toStop">
      <option value="">請先選擇班次</option>
    </select>
  </div>

  <button id="submitBtn" class="submit-btn" onclick="submitReservation()" style="display:none;">送出預約</button>

  <div id="currentReservationCard" style="display:none;"></div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let selectedDate = null;
let selectedRoute = null;
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let userData = null;
let existingReservations = [];
let noServiceDates = {};

const stopsOutbound = ["行政大樓","中餐廳","科技學院","學人會館","中城","下城","坪頂","愛蘭橋","大成國小","中山安七街口","榮民診所","埔里酒廠","埔里總站"];
const stopsReturn = [...stopsOutbound].reverse();

const routeTimes = {
  'A1': { time: '22:00-22:30', direction: '暨大→埔里總站' },
  'B1': { time: '22:30-23:00', direction: '埔里總站→暨大' },
  'A2': { time: '23:00-23:30', direction: '暨大→埔里總站' },
  'B2': { time: '23:30-24:00', direction: '埔里總站→暨大' }
};

// === 初始化 LIFF - 加入本地儲存優化 ===
async function init() {
  try {
    await liff.init({ liffId: "2006590746-KJodGOda" });
    if (!liff.isLoggedIn()) return liff.login();
    const profile = await liff.getProfile();
    
    // ✅ 新增：先檢查本地儲存，避免不必要的 API 呼叫
    if (localStorage.getItem('pangolin_registered') === 'true') {
      console.log('✅ 本地儲存顯示已註冊，跳過 API 檢查');
      // 直接載入用戶資料（需要從其他地方獲取，這裡暫時還是呼叫 API）
      const res = await fetch(`${WORKER_URL}?check=${profile.userId}`);
      const result = await res.json();
      if (result.registered) {
        userData = result.user;
      } else {
        // 如果 API 檢查發現未註冊，清除本地標記並跳轉
        localStorage.removeItem('pangolin_registered');
        return location.href = 'register.html';
      }
    } else {
      // 原有的 API 檢查
      const res = await fetch(`${WORKER_URL}?check=${profile.userId}`);
      const result = await res.json();
      if (!result.registered) return location.href = 'register.html';
      userData = result.user;
    }

    document.getElementById('userInfo').innerHTML = `
      <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">穿山甲專車預約</div>
      <div class="user-name">${userData.name}</div>
      <div class="user-info"><strong>${userData.department} | ${userData.studentId}</strong></div>
    `;

    await loadExistingReservations();
  } catch (error) {
    console.error('初始化錯誤:', error);
    alert('系統初始化失敗，請重新開啟');
  }
}

// === 載入停駛日期 ===
async function loadNoServiceDates() {
  try {
    const start = formatDateToLocal(new Date(currentYear, currentMonth - 1, 1));
    const end = formatDateToLocal(new Date(currentYear, currentMonth + 2, 0));
    const res = await fetch(`${WORKER_URL}?mode=calendar&start=${start}&end=${end}&calendarId=${encodeURIComponent(CALENDAR_ID)}`);
    const result = await res.json();
    noServiceDates = {};
    if (Array.isArray(result.holidays)) {
      result.holidays.forEach(d => noServiceDates[d.substring(0,10)] = true);
    }
    console.log('停駛日期:', noServiceDates);
  } catch (e) {
    console.error('🚨 載入停駛日期失敗:', e);
    noServiceDates = {};
  }
}

// === 📅 月曆開關 ===
async function toggleCalendar() {
  const container = document.getElementById('calendarContainer');
  const btn = document.getElementById('calendarBtn');

  if (container.style.display === 'none') {
    await loadNoServiceDates();
    renderCalendar();
    container.style.display = 'block';
    btn.textContent = '📅 關閉月曆';
    container.scrollIntoView({ behavior: 'smooth' });
  } else {
    container.style.display = 'none';
    btn.textContent = '📅 打開月曆';
  }
}

// === 📅 月曆產生 ===
function renderCalendar() {
  const calendar = document.getElementById('calendar');
  calendar.innerHTML = '';
  
  const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
  weekdays.forEach(day => {
    const header = document.createElement('div');
    header.className = 'calendar-header';
    header.textContent = day;
    calendar.appendChild(header);
  });

  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
  document.getElementById('calendarTitle').textContent = `${currentYear}年 ${monthNames[currentMonth]}`;

  const startDay = firstDay.getDay();
  const daysInMonth = lastDay.getDate();
  const today = new Date();
  const todayStr = formatDateToLocal(today);

  // 上個月的日期
  const prevLastDay = new Date(currentYear, currentMonth, 0).getDate();
  for (let i = startDay - 1; i >= 0; i--) {
    const empty = document.createElement('div');
    empty.className = 'calendar-day other-month';
    empty.textContent = prevLastDay - i;
    calendar.appendChild(empty);
  }

  // 這個月的日期
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(currentYear, currentMonth, day);
    const dateStr = formatDateToLocal(date);
    const div = document.createElement('div');
    div.className = 'calendar-day';
    
    const isPast = date < today && dateStr !== todayStr;
    const isNoService = noServiceDates[dateStr];
    
    if (isPast) {
      div.classList.add('past');
      div.innerHTML = `${day}<br><small>已過期</small>`;
    } else if (isNoService) {
      div.classList.add('disabled');
      div.innerHTML = `${day}<br><small>停駛</small>`;
    } else {
      div.textContent = day;
      div.onclick = () => selectDate(dateStr);
    }
    
    if (dateStr === todayStr) {
      div.style.border = '2px solid #3c8050';
    }
    
    if (selectedDate === dateStr) {
      div.classList.add('selected');
    }
    
    calendar.appendChild(div);
  }

  // 下個月的日期
  const totalCells = 42;
  const remaining = totalCells - (startDay + daysInMonth);
  for (let day = 1; day <= remaining; day++) {
    const empty = document.createElement('div');
    empty.className = 'calendar-day other-month';
    empty.textContent = day;
    calendar.appendChild(empty);
  }
}

function changeMonth(delta) {
  currentMonth += delta;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  renderCalendar();
}

function selectDate(dateStr) {
  if (noServiceDates[dateStr]) {
    document.getElementById('holidayNotice').style.display = 'block';
    document.getElementById('holidayNotice').textContent = `🚫 ${dateStr} 為停駛日，無法預約`;
    document.getElementById('selectedDate').style.display = 'none';
    selectedDate = null;
    document.getElementById('routeSection').style.display = 'none';
    document.getElementById('stopSection').style.display = 'none';
    document.getElementById('submitBtn').style.display = 'none';
    return;
  }
  
  const selected = new Date(dateStr);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  if (selected < today) {
    document.getElementById('holidayNotice').style.display = 'block';
    document.getElementById('holidayNotice').textContent = `🚫 ${dateStr} 為過去日期，無法預約`;
    document.getElementById('selectedDate').style.display = 'none';
    selectedDate = null;
    document.getElementById('routeSection').style.display = 'none';
    document.getElementById('stopSection').style.display = 'none';
    document.getElementById('submitBtn').style.display = 'none';
    return;
  }
  
  selectedDate = dateStr;
  
  document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
  event.target.classList.add('selected');
  
  document.getElementById('selectedDate').style.display = 'block';
  document.getElementById('selectedDate').textContent = `✅ 已選擇日期：${dateStr}`;
  document.getElementById('holidayNotice').style.display = 'none';
  
  document.getElementById('calendarContainer').style.display = 'none';
  document.getElementById('calendarBtn').textContent = '📅 打開月曆';
  
  showRouteSelection();
}

// === 🚌 顯示班次選擇 ===
function showRouteSelection() {
  const routeSection = document.getElementById('routeSection');
  const routeButtons = document.getElementById('routeButtons');
  
  routeButtons.innerHTML = '';
  
  Object.entries(routeTimes).forEach(([routeId, info]) => {
    const button = document.createElement('div');
    button.className = 'route-btn';
    button.innerHTML = `
      <div class="route-time">${routeId} ${info.time}</div>
      <div class="route-direction">${info.direction}</div>
    `;
    button.onclick = () => selectRoute(routeId, info.direction);
    routeButtons.appendChild(button);
  });
  
  routeSection.style.display = 'block';
  routeSection.scrollIntoView({ behavior: 'smooth' });
}

// === 🚌 選擇班次 ===
function selectRoute(routeId, direction) {
  selectedRoute = routeId;
  
  document.querySelectorAll('.route-btn').forEach(btn => btn.classList.remove('selected'));
  event.target.classList.add('selected');
  
  showStopSelection(direction);
}

// === 🚏 顯示車站選擇 ===
function showStopSelection(direction) {
  const stopSection = document.getElementById('stopSection');
  const toStopSelect = document.getElementById('toStop');
  
  toStopSelect.innerHTML = '<option value="">請選擇下車站</option>';
  
  const isOutbound = direction.includes('暨大→');
  const stops = isOutbound ? stopsOutbound : stopsReturn;
  const fromStop = isOutbound ? '行政大樓' : '埔里總站';
  
  stops.filter(stop => stop !== fromStop).forEach(stop => {
    const option = document.createElement('option');
    option.value = stop;
    option.textContent = stop;
    toStopSelect.appendChild(option);
  });
  
  stopSection.style.display = 'block';
  document.getElementById('submitBtn').style.display = 'block';
  stopSection.scrollIntoView({ behavior: 'smooth' });
}

// === 📝 送出預約 ===
async function submitReservation() {
  const toStop = document.getElementById('toStop').value;
  const submitBtn = document.getElementById('submitBtn');
  
  if (!selectedDate || !selectedRoute || !toStop) {
    alert('請完整選擇日期、班次與下車站');
    return;
  }
  
  try {
    submitBtn.disabled = true;
    submitBtn.textContent = '預約中...';
    
    const info = routeTimes[selectedRoute];
    const fromStop = selectedRoute.includes('A') ? '行政大樓' : '埔里總站';
    
    const data = {
      type: 'reserve',
      userId: userData.userId,
      name: userData.name,
      studentId: userData.studentId,
      department: userData.department,
      phone: userData.phone || '',
      route: selectedRoute,
      routeName: `${selectedRoute} | ${info.time} ${info.direction}`,
      fromStop: fromStop,
      toStop: toStop,
      date: selectedDate
    };
    
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    
    if (result.status === 'success') {
      alert('✅ 預約成功！');

      // LINE 群組推播通知（新預約）
      try {
        const flexPayload = {
          type: "pushLine",
          flex: {
            type: "flex",
            altText: "穿山甲專車新預約通知",
            contents: {
              type: "bubble",
              size: "mega",
              body: {
                type: "box",
                layout: "vertical",
                contents: [
                  {
                    type: "box",
                    layout: "vertical",
                    backgroundColor: "#3c8050",
                    paddingAll: "10px",
                    contents: [
                      {
                        type: "text",
                        text: "🚌 穿山甲專車新預約",
                        color: "#ffffff",
                        weight: "bold",
                        size: "md",
                        align: "center"
                      }
                    ]
                  },
                  {
                    type: "box",
                    layout: "vertical",
                    backgroundColor: "#ffffff",
                    paddingAll: "12px",
                    spacing: "sm",
                    contents: [
                      { type: "text", text: `日期：${selectedDate}`, size: "sm", color: "#333" },
                      { type: "text", text: `班次：${selectedRoute}｜${info.time} ${info.direction}`, size: "sm", color: "#333" },
                      { type: "text", text: `姓名：${userData.name}`, size: "sm", color: "#333" },
                      { type: "text", text: `電話：${userData.phone || "未填"}`, size: "sm", color: "#333" },
                      { type: "text", text: `上車：${fromStop}`, size: "sm", color: "#333" },
                      { type: "text", text: `下車：${toStop}`, size: "sm", color: "#333" }
                    ]
                  }
                ]
              }
            }
          }
        };

        await fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(flexPayload)
        });
        console.log('✅ 群組推播：新預約通知成功');
      } catch (err) {
        console.error('❌ 推播錯誤:', err);
      }

      resetReservationForm();
      await loadExistingReservations();
      
    } else {
      alert('❌ 預約失敗：' + (result.message || '請稍後再試'));
    }
    
  } catch (error) {
    console.error('預約錯誤:', error);
    alert('❌ 預約失敗，請檢查網路連線');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = '送出預約';
  }
}

// === 🔄 重置預約表單 ===
function resetReservationForm() {
  document.getElementById('routeSection').style.display = 'none';
  document.getElementById('stopSection').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
  document.getElementById('selectedDate').style.display = 'none';
  document.getElementById('holidayNotice').style.display = 'none';
  
  selectedDate = null;
  selectedRoute = null;
  document.getElementById('toStop').innerHTML = '<option value="">請先選擇班次</option>';
  document.querySelectorAll('.route-btn').forEach(btn => btn.classList.remove('selected'));
  document.querySelectorAll('.calendar-day').forEach(day => day.classList.remove('selected'));
}

// === 📅 橫向輪播式預約卡片 - 修復版 ===
function renderCurrentReservationCard() {
  const section = document.getElementById('currentReservationCard');
  section.innerHTML = '';

  const today = formatDateToLocal(new Date());
  
  // 修復：正確過濾有效預約
  const activeReservations = existingReservations.filter(res => {
    const reservationDate = res.date.split('T')[0]; // 處理可能包含時間的日期格式
    return reservationDate >= today && res.status !== '已取消';
  }).sort((a, b) => a.date.localeCompare(b.date));

  if (activeReservations.length === 0) {
    section.innerHTML = `
      <div class="no-reservation">
        <div style="font-size: 48px; margin-bottom: 10px;">📭</div>
        <div style="font-size: 16px; color: #666;">目前沒有預約紀錄</div>
      </div>
    `;
    section.style.display = 'block';
    return;
  }

  // 建立輪播容器
  const carouselContainer = document.createElement('div');
  carouselContainer.className = 'carousel-container';
  
  const carouselTitle = document.createElement('div');
  carouselTitle.className = 'carousel-title';
  carouselTitle.textContent = `我的預約 (${activeReservations.length} 筆)`;
  carouselContainer.appendChild(carouselTitle);
  
  const carousel = document.createElement('div');
  carousel.className = 'carousel';
  
  // 為每個預約建立泡泡卡片 - 修復格式
  activeReservations.forEach(reservation => {
    const dateOnly = reservation.date.split('T')[0]; // 確保只顯示日期部分
    const routeInfo = routeTimes[reservation.route] || { time: '', direction: '' };
    
    const bubble = document.createElement('div');
    bubble.className = 'reservation-bubble';
    bubble.innerHTML = `
      <div class="bubble-header">
        ${dateOnly} | ${reservation.route}
      </div>
      <div class="bubble-body">
        <div class="bubble-line"><strong>班次：</strong>${routeInfo.time}</div>
        <div class="bubble-line"><strong>路線：</strong>${routeInfo.direction}</div>
        <div class="bubble-line"><strong>姓名：</strong>${reservation.name}</div>
        <div class="bubble-line"><strong>上車：</strong>${reservation.fromStop}</div>
        <div class="bubble-line"><strong>下車：</strong>${reservation.toStop}</div>
        <div class="bubble-line"><strong>狀態：</strong>${reservation.status || '已預約'}</div>
      </div>
      <div class="bubble-footer">
        <button class="cancel-btn-small" onclick="cancelReservation('${reservation.id || reservation.timestamp}')">
          ❌ 取消預約
        </button>
      </div>
    `;
    carousel.appendChild(bubble);
  });
  
  carouselContainer.appendChild(carousel);
  section.appendChild(carouselContainer);
  section.style.display = 'block';
}

// === 取消預約 - 修復版 ===
async function cancelReservation(reservationId) {
  if (!confirm('確定要取消這筆預約嗎？')) return;

  try {
    // 修復：使用正確的取消參數
    const cancelData = {
      type: 'cancel',
      reservationId: reservationId,
      userId: userData.userId
    };

    console.log('取消預約請求:', cancelData);

    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(cancelData)
    });

    const result = await res.json();
    console.log('取消預約回應:', result);

    if (result.status === 'success') {
      alert('✅ 已取消預約');

      // 修復：正確取得要取消的預約資料
      const canceledReservation = existingReservations.find(r => 
        (r.id === reservationId) || (r.timestamp === reservationId)
      );
      
      if (canceledReservation) {
        const info = routeTimes[canceledReservation.route] || {};
        
        // LINE 群組推播通知（取消預約）
        try {
          const flexPayload = {
            type: "pushLine",
            flex: {
              type: "flex",
              altText: "穿山甲專車取消預約通知",
              contents: {
                type: "bubble",
                size: "mega",
                body: {
                  type: "box",
                  layout: "vertical",
                  contents: [
                    {
                      type: "box",
                      layout: "vertical",
                      backgroundColor: "#b71c1c",
                      paddingAll: "10px",
                      contents: [
                        {
                          type: "text",
                          text: "❌ 穿山甲專車預約取消",
                          color: "#ffffff",
                          weight: "bold",
                          size: "md",
                          align: "center"
                        }
                      ]
                    },
                    {
                      type: "box",
                      layout: "vertical",
                      backgroundColor: "#ffffff",
                      paddingAll: "12px",
                      spacing: "sm",
                      contents: [
                        { type: "text", text: `日期：${canceledReservation.date.split('T')[0]}`, size: "sm", color: "#333" },
                        { type: "text", text: `班次：${canceledReservation.route}｜${info.time || ""} ${info.direction || ""}`, size: "sm", color: "#333" },
                        { type: "text", text: `姓名：${canceledReservation.name}`, size: "sm", color: "#333" },
                        { type: "text", text: `上車：${canceledReservation.fromStop}`, size: "sm", color: "#333" },
                        { type: "text", text: `下車：${canceledReservation.toStop}`, size: "sm", color: "#333" }
                      ]
                    }
                  ]
                }
              }
            }
          };

          await fetch(WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(flexPayload)
          });
          console.log('🚫 群組推播：取消預約通知成功');
        } catch (pushErr) {
          console.error('❌ 取消推播錯誤:', pushErr);
        }
      }

      // 重新載入預約資料
      await loadExistingReservations();
    } else {
      alert('❌ 取消失敗：' + (result.message || '請稍後再試'));
    }
  } catch (e) {
    console.error('取消預約錯誤', e);
    alert('❌ 取消預約時發生錯誤，請稍後再試');
  }
}

// === 載入預約 ===
async function loadExistingReservations() {
  try {
    const res = await fetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`);
    const result = await res.json();
    existingReservations = result.reservations || [];
    console.log('載入的預約資料:', existingReservations);
    renderCurrentReservationCard();
  } catch (e) {
    console.error('載入預約失敗', e);
    existingReservations = [];
    renderCurrentReservationCard();
  }
}

// === 頁面載入 ===
window.addEventListener('load', init);

function formatDateToLocal(date){
  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}
</script>
</body>
</html>
