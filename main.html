<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ç©¿å±±ç”²å°ˆè»Šé ç´„ ğŸš</title>
<style>
/* === æ¨£å¼ä¿ç•™å®Œæ•´ === */
body { font-family: system-ui,sans-serif;background:#f5f6f7;margin:0;padding:0;}
header{background:#3c8050;color:#fff;text-align:center;padding:15px;font-size:22px;font-weight:bold;}
#calendarBtn{width:100%;background:#3c8050;color:#fff;border:none;padding:12px;border-radius:6px;font-size:16px;font-weight:bold;margin:10px 0;cursor:pointer;}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;text-align:center;font-size:13px;margin-bottom:20px;}
.calendar-header{padding:8px 0;font-weight:bold;background:#f0f0f0;border-radius:3px;font-size:12px;}
.calendar-day{padding:8px 0;min-height:45px;border-radius:4px;background:#fff;border:1px solid #e0e0e0;cursor:pointer;display:flex;flex-direction:column;justify-content:center;transition:background .2s;}
.calendar-day:hover{background:#eaf5ea;}
.calendar-day.disabled{background:#ffe6e6;color:#999;cursor:not-allowed;}
.calendar-day.past{background:#f5f5f5;color:#ccc;cursor:not-allowed;}
.calendar-day.selected{background:#3c8050;color:#fff;font-weight:bold;}
.calendar-day.other-month{color:#ccc;}
.carousel-container{padding:16px;margin:20px 0;}
.carousel-title{text-align:center;font-size:18px;font-weight:bold;margin-bottom:15px;color:#333;}
.carousel{display:flex;overflow-x:auto;gap:15px;padding:10px 0;scrollbar-width:none;}
.carousel::-webkit-scrollbar{display:none;}
.reservation-bubble{min-width:240px;background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);border:1px solid #e0e0e0;overflow:hidden;flex-shrink:0;}
.bubble-header{background:#27ACB2;color:white;padding:12px 15px;font-weight:bold;font-size:14px;}
.bubble-body{padding:12px;}
.bubble-line{margin-bottom:6px;font-size:12px;line-height:1.3;}
.bubble-line:last-child{margin-bottom:0;}
.bubble-footer{text-align:center;padding:8px;border-top:1px solid #f0f0f0;}
.cancel-btn-small{background:none;border:none;color:#FF0000;font-size:12px;cursor:pointer;padding:5px 10px;}
.cancel-btn-small:hover{background:#ffe6e6;border-radius:4px;}
.no-reservation{text-align:center;color:#666;padding:40px 20px;background:white;border-radius:8px;margin:20px 16px;}
.route-section{padding:0 16px;margin:20px 0;}
.route-buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0;}
.route-btn{padding:12px;border:2px solid #3c8050;border-radius:8px;background:white;cursor:pointer;text-align:center;transition:all .2s;}
.route-btn:hover{background:#eaf5ea;}
.route-btn.selected{background:#3c8050;color:white;}
.stop-selector{padding:0 16px;margin:20px 0;}
select{width:100%;padding:12px;border:1px solid #ccc;border-radius:6px;font-size:14px;margin-top:8px;}
.submit-btn{background:#3c8050;color:white;border:none;padding:15px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;margin:20px 16px;width:calc(100% - 32px);}
.submit-btn:hover{background:#2d6140;}
.submit-btn:disabled{background:#ccc;cursor:not-allowed;}
.notice{padding:10px 16px;margin:10px 0;border-radius:6px;}
.notice.success{background:#e8f5e9;color:#2e7d32;border:1px solid #81c784;}
.notice.error{background:#fdecea;color:#b71c1c;border:1px solid #f5c2c7;}
</style>
</head>
<body>
<header>ç©¿å±±ç”²å°ˆè»Šé ç´„</header>
<div id="userInfo" style="padding:16px;"><div class="loading-state">â³ ç³»çµ±åˆå§‹åŒ–ä¸­...</div></div>
<button id="calendarBtn" onclick="toggleCalendar()">ğŸ“… æ‰“é–‹æœˆæ›†</button>
<div id="calendarContainer" style="display:none;margin-top:10px;padding:0 16px;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <button onclick="changeMonth(-1)">â—€ ä¸Šå€‹æœˆ</button>
    <h3 id="calendarTitle"></h3>
    <button onclick="changeMonth(1)">ä¸‹å€‹æœˆ â–¶</button>
  </div>
  <div id="calendar" class="calendar"></div>
</div>
<div id="selectedDate" class="notice success" style="display:none;"></div>
<div id="holidayNotice" class="notice error" style="display:none;"></div>
<div id="routeSection" class="route-section" style="display:none;"><h3>è«‹é¸æ“‡æ­ä¹˜ç­æ¬¡</h3><div id="routeButtons" class="route-buttons"></div></div>
<div id="stopSection" class="stop-selector" style="display:none;"><h3>è«‹é¸æ“‡ä¸‹è»Šç«™</h3><select id="toStop"><option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option></select></div>
<button id="submitBtn" class="submit-btn" onclick="submitReservation()" style="display:none;">é€å‡ºé ç´„</button>
<div id="currentReservationCard" style="display:none;"></div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL='https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID='86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let selectedDate=null,selectedRoute=null,currentMonth=new Date().getMonth(),currentYear=new Date().getFullYear();
let userData=null,existingReservations=[],noServiceDates={};
const stopsOutbound=["è¡Œæ”¿å¤§æ¨“","ä¸­é¤å»³","ç§‘æŠ€å­¸é™¢","å­¸äººæœƒé¤¨","ä¸­åŸ","ä¸‹åŸ","åªé ‚","æ„›è˜­æ©‹","å¤§æˆåœ‹å°","ä¸­å±±å®‰ä¸ƒè¡—å£","æ¦®æ°‘è¨ºæ‰€","åŸ”é‡Œé…’å» ","åŸ”é‡Œç¸½ç«™"];
const stopsReturn=[...stopsOutbound].reverse();
const routeTimes={'A1':{time:'22:00-22:30',direction:'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™'},'B1':{time:'22:30-23:00',direction:'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§'},'A2':{time:'23:00-23:30',direction:'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™'},'B2':{time:'23:30-24:00',direction:'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§'}};

/* === åˆå§‹åŒ– LIFF ç™»å…¥ + å¿«å– === */
async function init(){
 try{
   const cache=localStorage.getItem('pangolinUser');
   if(cache){
     userData=JSON.parse(cache);
     renderUser(userData);
     loadExistingReservations();
   }
   await liff.init({liffId:"2006590746-KJodGOda"});
   if(!liff.isLoggedIn()) return liff.login();
   const profile=await liff.getProfile();
   const res=await fetch(`${WORKER_URL}?check=${profile.userId}`);
   const result=await res.json();
   if(!result.registered)return location.href='register.html';
   userData=result.user;
   localStorage.setItem('pangolinUser',JSON.stringify(userData));
   renderUser(userData);
   await loadExistingReservations();
 }catch(e){
   console.error("ç™»å…¥éŒ¯èª¤",e);
   document.getElementById('userInfo').innerHTML=`<div class='notice error'>ç™»å…¥å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥</div>`;
 }
}
function renderUser(u){
 document.getElementById('userInfo').innerHTML=`
 <div style="font-size:18px;font-weight:bold;">${u.name}</div>
 <div>${u.department} | ${u.studentId}</div>`;
}

/* === è¼‰å…¥é ç´„ + å¿«å– + é‡è©¦ === */
async function loadExistingReservations(retry=0){
 const section=document.getElementById('currentReservationCard');
 section.innerHTML=`<div class='no-reservation'>ğŸ“¡ è¼‰å…¥é ç´„è³‡æ–™ä¸­...</div>`;
 section.style.display='block';
 try{
   const res=await fetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`);
   const text=await res.text();
   const result=JSON.parse(text);
   existingReservations=result.reservations||[];
   localStorage.setItem('pangolinReservations',JSON.stringify(existingReservations));
   renderCurrentReservationCard();
 }catch(e){
   console.warn("é ç´„è¼‰å…¥å¤±æ•—",e);
   if(retry<2)setTimeout(()=>loadExistingReservations(retry+1),800);
   else{
     const cached=localStorage.getItem('pangolinReservations');
     if(cached){existingReservations=JSON.parse(cached);renderCurrentReservationCard();}
     else section.innerHTML=`<div class='no-reservation'>âš ï¸ ç„¡æ³•è¼‰å…¥é ç´„è³‡æ–™</div>`;
   }
 }
}

/* === åœé§›æ—¥ === */
async function loadNoServiceDates(){
 try{
   const start=formatDateToLocal(new Date(currentYear,currentMonth-1,1));
   const end=formatDateToLocal(new Date(currentYear,currentMonth+2,0));
   const res=await fetch(`${WORKER_URL}?mode=calendar&start=${start}&end=${end}&calendarId=${encodeURIComponent(CALENDAR_ID)}`);
   const r=await res.json();noServiceDates={};
   if(Array.isArray(r.holidays))r.holidays.forEach(d=>noServiceDates[d.substring(0,10)]=true);
 }catch(e){noServiceDates={};}
}

/* === æœˆæ›† === */
async function toggleCalendar(){
 const c=document.getElementById('calendarContainer');
 const b=document.getElementById('calendarBtn');
 if(c.style.display==='none'){await loadNoServiceDates();renderCalendar();c.style.display='block';b.textContent='ğŸ“… é—œé–‰æœˆæ›†';}
 else{c.style.display='none';b.textContent='ğŸ“… æ‰“é–‹æœˆæ›†';}
}
function renderCalendar(){
 const cal=document.getElementById('calendar');cal.innerHTML='';
 const w=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
 w.forEach(d=>{const h=document.createElement('div');h.className='calendar-header';h.textContent=d;cal.appendChild(h);});
 const f=new Date(currentYear,currentMonth,1),l=new Date(currentYear,currentMonth+1,0),mN=['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
 document.getElementById('calendarTitle').textContent=`${currentYear}å¹´ ${mN[currentMonth]}`;
 const s=f.getDay(),days=l.getDate(),todayStr=formatDateToLocal(new Date());
 for(let i=s-1;i>=0;i--){const e=document.createElement('div');e.className='calendar-day other-month';e.textContent=new Date(currentYear,currentMonth,0).getDate()-i;cal.appendChild(e);}
 for(let d=1;d<=days;d++){
   const dateStr=formatDateToLocal(new Date(currentYear,currentMonth,d));
   const div=document.createElement('div');div.className='calendar-day';
   const isPast=new Date(dateStr)<new Date(todayStr)&&dateStr!==todayStr;
   const isNo=noServiceDates[dateStr];
   if(isPast){div.classList.add('past');div.innerHTML=`${d}<br><small>å·²éæœŸ</small>`;}
   else if(isNo){div.classList.add('disabled');div.innerHTML=`${d}<br><small>åœé§›</small>`;}
   else{div.textContent=d;div.onclick=()=>selectDate(dateStr);}
   if(dateStr===todayStr)div.style.border='2px solid #3c8050';
   if(selectedDate===dateStr)div.classList.add('selected');
   cal.appendChild(div);
 }
 while(cal.children.length<49){const e=document.createElement('div');e.className='calendar-day other-month';e.textContent='';cal.appendChild(e);}
}
function changeMonth(delta){currentMonth+=delta;if(currentMonth<0){currentMonth=11;currentYear--;}else if(currentMonth>11){currentMonth=0;currentYear++;}renderCalendar();}

/* === æ—¥æœŸé¸æ“‡ === */
function selectDate(dateStr){
 if(noServiceDates[dateStr])return alert(`ğŸš« ${dateStr} ç‚ºåœé§›æ—¥`);
 const sel=new Date(dateStr),t=new Date();t.setHours(0,0,0,0);
 if(sel<t)return alert(`ğŸš« ${dateStr} ç‚ºéå»æ—¥æœŸ`);
 selectedDate=dateStr;document.getElementById('selectedDate').style.display='block';
 document.getElementById('selectedDate').textContent=`âœ… å·²é¸æ“‡æ—¥æœŸï¼š${dateStr}`;
 document.getElementById('calendarContainer').style.display='none';
 document.getElementById('calendarBtn').textContent='ğŸ“… æ‰“é–‹æœˆæ›†';
 showRouteSelection();
}

/* === ç­æ¬¡é¸æ“‡ === */
function showRouteSelection(){
 const s=document.getElementById('routeSection'),b=document.getElementById('routeButtons');b.innerHTML='';
 Object.entries(routeTimes).forEach(([rid,info])=>{
   const btn=document.createElement('div');
   btn.className='route-btn';
   btn.innerHTML=`<div class="route-time">${rid} ${info.time}</div><div class="route-direction">${info.direction}</div>`;
   btn.onclick=()=>selectRoute(rid,info.direction);
   b.appendChild(btn);
 });
 s.style.display='block';
}
function selectRoute(rid,dir){
 selectedRoute=rid;document.querySelectorAll('.route-btn').forEach(b=>b.classList.remove('selected'));
 event.target.classList.add('selected');showStopSelection(dir);
}
function showStopSelection(dir){
 const stop=document.getElementById('stopSection'),sel=document.getElementById('toStop');
 sel.innerHTML='<option value="">è«‹é¸æ“‡ä¸‹è»Šç«™</option>';
 const outbound=dir.includes('æš¨å¤§â†’'),stops=outbound?stopsOutbound:stopsReturn,from=outbound?'è¡Œæ”¿å¤§æ¨“':'åŸ”é‡Œç¸½ç«™';
 stops.filter(s=>s!==from).forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;sel.appendChild(o);});
 stop.style.display='block';document.getElementById('submitBtn').style.display='block';
}

/* === é ç´„é€å‡º === */
async function submitReservation(){
 const to=document.getElementById('toStop').value,btn=document.getElementById('submitBtn');
 if(!selectedDate||!selectedRoute||!to)return alert('è«‹å®Œæ•´é¸æ“‡æ—¥æœŸã€ç­æ¬¡èˆ‡ä¸‹è»Šç«™');
 try{
   btn.disabled=true;btn.textContent='é ç´„ä¸­...';
   const info=routeTimes[selectedRoute],from=selectedRoute.includes('A')?'è¡Œæ”¿å¤§æ¨“':'åŸ”é‡Œç¸½ç«™';
   const payload={type:'reserve',userId:userData.userId,name:userData.name,studentId:userData.studentId,department:userData.department,phone:userData.phone||'',route:selectedRoute,routeName:`${selectedRoute} | ${info.time} ${info.direction}`,fromStop:from,toStop:to,date:selectedDate};
   const res=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
   const result=await res.json();
   if(result.status==='success'){alert('âœ… é ç´„æˆåŠŸï¼');await loadExistingReservations();}
   else alert('âŒ é ç´„å¤±æ•—ï¼š'+(result.message||'è«‹ç¨å¾Œå†è©¦'));
 }catch(e){alert('âŒ é ç´„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');}
 finally{btn.disabled=false;btn.textContent='é€å‡ºé ç´„';}
}

/* === å¡ç‰‡é¡¯ç¤º === */
function renderCurrentReservationCard(){
 const s=document.getElementById('currentReservationCard');s.innerHTML='';
 const today=formatDateToLocal(new Date());
 const list=existingReservations.filter(r=>r.date>=today&&r.status!=='å·²å–æ¶ˆ').sort((a,b)=>a.date.localeCompare(b.date));
 if(!list.length){s.innerHTML=`<div class='no-reservation'><div style='font-size:48px;'>ğŸ“­</div>ç›®å‰æ²’æœ‰é ç´„ç´€éŒ„</div>`;s.style.display='block';return;}
 const c=document.createElement('div');c.className='carousel-container';
 const t=document.createElement('div');t.className='carousel-title';t.textContent=`æˆ‘çš„é ç´„ (${list.length} ç­†)`;c.appendChild(t);
 const car=document.createElement('div');car.className='carousel';
 list.forEach(r=>{
   const info=routeTimes[r.route]||{time:'',direction:''};
   const b=document.createElement('div');b.className='reservation-bubble';
   b.innerHTML=`<div class='bubble-header'>æ—¥æœŸ:${r.date.split('T')[0]}</div>
   <div class='bubble-body'><div class='bubble-line route-time'>${r.route} | ${info.time}</div>
   <div class='bubble-line'>${info.direction}</div><div class='bubble-line'>å§“å:${r.name}</div>
   <div class='bubble-line'>ä¸Šè»Š:${r.fromStop}</div><div class='bubble-line'>ä¸‹è»Š:${r.toStop}</div></div>
   <div class='bubble-footer'><button class='cancel-btn-small' onclick="cancelReservation('${r.id}')">âŒ å–æ¶ˆé ç´„</button></div>`;
   car.appendChild(b);
 });
 c.appendChild(car);s.appendChild(c);s.style.display='block';
}

/* === å–æ¶ˆé ç´„ - ä¿®æ­£ç‰ˆæœ¬ === */
async function cancelReservation(id){
 if(!confirm('ç¢ºå®šè¦å–æ¶ˆå—ï¼Ÿ'))return;
 
 try{
   // å…ˆæ‰¾åˆ°è¦å–æ¶ˆçš„é ç´„è³‡æ–™
   const reservationToCancel = existingReservations.find(r => r.id === id);
   if (!reservationToCancel) {
     alert('âŒ æ‰¾ä¸åˆ°é ç´„è³‡æ–™');
     return;
   }
   
   console.log('ğŸ“¦ å–æ¶ˆçš„é ç´„è³‡æ–™:', reservationToCancel);
   
   const res = await fetch(WORKER_URL, {
     method: 'POST',
     headers: {'Content-Type': 'application/json'},
     body: JSON.stringify({
       type: 'cancel',
       id: id,
       userId: userData.userId,
       // ğŸ”§ é—œéµä¿®å¾©ï¼šå‚³éå®Œæ•´çš„é ç´„è³‡æ–™
       reservationData: reservationToCancel
     })
   });
   
   const result = await res.json();
   console.log('ğŸ“Š å–æ¶ˆå›æ‡‰:', result);
   
   if(result.status === 'success' || result.success === true){
     alert('âœ… å·²å–æ¶ˆé ç´„');
     await loadExistingReservations();
   } else {
     alert('âŒ å–æ¶ˆå¤±æ•—ï¼š' + (result.message || 'è«‹ç¨å¾Œå†è©¦'));
   }
 } catch(e){
   console.error('å–æ¶ˆé ç´„éŒ¯èª¤', e);
   alert('âŒ å–æ¶ˆé ç´„æ™‚ç™¼ç”ŸéŒ¯èª¤');
 }
}

/* === æ—¥æœŸæ ¼å¼ === */
function formatDateToLocal(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}

window.addEventListener('load',init);
</script>
</body>
</html>
