<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>穿山甲專車預約 Pangolin Shuttle Reservation</title>
<style>
body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; line-height:1.3; }
header span.en { display:block; font-size:14px; color:#fff; }

.btn-dual { display:flex; justify-content:space-between; gap:10px; margin:10px 16px; }
.dual-btn { flex:1; text-align:center; background:#3c8050; color:#fff; border:none; border-radius:8px; padding:10px 0; font-weight:bold; cursor:pointer; font-size:16px; line-height:1.3; }
.dual-btn span.en { display:block; font-size:13px; color:#fff; }

.user-section { background:white; margin:16px; padding:16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.user-name { font-size:20px; font-weight:bold; color:#333; margin-bottom:5px; }
.user-info { font-size:14px; color:#666; }

/* 📅 Calendar */
.calendar-day { background:#fff; border:1px solid #ddd; padding:8px; border-radius:6px; text-align:center; cursor:pointer; font-weight:bold; transition:all 0.2s; }
.calendar-day:hover { background:#e9f5ec; }
.calendar-day.selected { background:#3c8050; color:#fff; }
.calendar-day.disabled { background:#eee; color:#999; border:1px solid #ccc; cursor:not-allowed; opacity:0.7; }

/* ✅ Route Buttons */
.route-btn { background:#fff; border:2px solid #3c8050; border-radius:10px; padding:16px 10px; text-align:center; font-weight:bold; cursor:pointer; transition:all 0.3s; box-shadow:0 2px 5px rgba(0,0,0,0.05); color:#000; }
.route-btn:hover { background:#f0faf2; }
.route-btn.selected { background:#3c8050; color:#fff; border:2px solid #3c8050; box-shadow:0 3px 8px rgba(60,128,80,0.3); }
.route-btn.selected span { color:#fff !important; }
.route-btn span.time { display:block; font-size:15px; color:#3c8050; }
.route-btn span.cn { display:block; color:#333; font-size:15px; margin-top:3px; }
.route-btn span.en { display:block; color:#0056b3; font-size:13px; }

/* 🔹 Stop Selectors */
.select-label { font-weight:bold; color:#333; margin-top:25px; line-height:1.3; font-size:16px; }
.select-label span.en { display:block; color:#0056b3; font-size:13px; }
select { width:100%; padding:14px; margin-top:8px; border:2px solid #3c8050; border-radius:10px; font-size:16px; background:#fff; color:#333; }
select:focus { outline:none; border-color:#0056b3; box-shadow:0 0 5px rgba(0,86,179,0.3); }

/* 🔹 Submit Button */
.submit-btn { background:#3c8050; color:white; border:none; padding:15px; border-radius:8px; font-size:17px; font-weight:bold; cursor:pointer; margin:25px 16px; width:calc(100% - 32px); }
.submit-btn span.en { display:block; color:#fff; font-size:13px; }

/* 🔹 Reservation Card */
.reservation-bubble { background:#fff; border:1px solid #ccc; border-radius:10px; margin:10px 16px; box-shadow:0 2px 5px rgba(0,0,0,0.08); overflow:hidden; }
.bubble-header { background:#27ACB2; color:#fff; font-weight:bold; padding:10px; text-align:center; font-size:16px; line-height:1.3; }
.bubble-header span.en { display:block; font-size:13px; color:#fff; }
.bubble-body { padding:12px; font-size:15px; line-height:1.5; color:#333; }
.bubble-body span.en { display:block; color:#0056b3; font-size:13px; margin-bottom:4px; }
.bubble-footer { padding:10px; text-align:center; background:#f8f8f8; }
.cancel-btn-small { background:#d32f2f; color:white; border:none; border-radius:8px; padding:12px 25px; cursor:pointer; font-weight:bold; font-size:15px; width:85%; }
.cancel-btn-small span.en { display:block; color:#fff; font-size:13px; }
</style>
</head>

<body>
<header>
  穿山甲專車預約
  <span class="en">Pangolin Shuttle Bus Reservation</span>
</header>

<div id="userInfo" class="user-section">⏳ 系統初始化中...</div>

<div class="btn-dual">
  <button class="dual-btn" onclick="toggleCalendar()">📅 打開月曆<span class="en">Open Calendar</span></button>
  <button class="dual-btn" onclick="alertRules()">📘 預約規則<span class="en">Reservation Rules</span></button>
</div>

<div id="calendarContainer" style="display:none; padding:0 16px;">
  <h3 id="calendarTitle"></h3>
  <div id="calendar" style="display:grid; grid-template-columns:repeat(7,1fr); gap:4px;"></div>
</div>

<div id="selectedDate" style="margin:10px 16px; color:#2e7d32; display:none;"></div>
<div id="routeButtons" style="display:none; grid-template-columns:1fr 1fr; gap:12px; padding:0 16px;"></div>

<div id="stopSection" style="display:none; padding:0 16px;">
  <label class="select-label">上車地點<span class="en">Pick-up Stop</span></label>
  <select id="fromStop"></select>

  <label class="select-label">下車地點<span class="en">Drop-off Stop</span></label>
  <select id="toStop"></select>
</div>

<button id="submitBtn" class="submit-btn" onclick="submitReservation()" style="display:none;">
  送出預約<span class="en">Submit Reservation</span>
</button>

<div id="currentReservationCard" style="display:none;"></div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
// ==================== 全域設定 =====================
const WORKER_URL='https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID='86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
const GOOGLE_API_KEY='🔑 請填入你的 Google API 金鑰';
let RULES=null,userData=null,existingReservations=[],selectedDate=null,selectedRoute=null;
let blockedDates=new Set(); // 停駛或公休

// ==================== 規則載入 =====================
async function loadRules(){
  try{
    const res=await fetch('rule.html',{cache:'no-store'});
    const txt=await res.text();
    const clean=txt.trim().startsWith('<') ? txt.match(/\{[\s\S]*\}/)?.[0]||'{}' : txt;
    RULES=JSON.parse(clean);
    console.log('📘 規則載入成功',RULES);
  }catch(e){
    console.error('❌ 載入規則失敗',e);
    RULES={seatLimit:7,maxPerDay:1,advanceMinutes:30,stopList:[],availableRoutes:[]};
  }
}

// ==================== 日曆封鎖判斷 =====================
async function fetchCalendarBlockedDates(){
  try{
    const today=new Date();
    const nextMonth=new Date();nextMonth.setMonth(today.getMonth()+1);
    const url=`https://www.googleapis.com/calendar/v3/calendars/${CALENDAR_ID}/events?key=${GOOGLE_API_KEY}&timeMin=${today.toISOString()}&timeMax=${nextMonth.toISOString()}&singleEvents=true&orderBy=startTime`;
    const res=await fetch(url);
    const data=await res.json();
    blockedDates.clear();
    (data.items||[]).forEach(ev=>{
      const title=ev.summary||'';
      if(title.includes('公休')||title.includes('停駛')){
        const date=ev.start.date||ev.start.dateTime.split('T')[0];
        blockedDates.add(date);
      }
    });
    console.log('📅 已封鎖日期：',Array.from(blockedDates));
  }catch(e){console.error('❌ 無法載入日曆封鎖',e);}
}

// ==================== 初始化 =====================
async function init(){
  await loadRules();
  await fetchCalendarBlockedDates();
  try{
    await liff.init({liffId:'2006590746-KJodGOda'});
    if(!liff.isLoggedIn())return liff.login();
    const profile=await liff.getProfile();
    const [check,resv]=await Promise.all([
      fetch(`${WORKER_URL}?check=${profile.userId}`).then(r=>r.json()),
      fetch(`${WORKER_URL}?mode=reservations&userId=${profile.userId}`).then(r=>r.json())
    ]);
    if(!check.registered)return location.href='register.html';
    userData=check.user; existingReservations=resv.reservations||[];
    document.getElementById('userInfo').innerHTML=`
      <div class="user-name">${userData.name}</div>
      <div class="user-info">${userData.department} | ${userData.studentId}</div>`;
    renderReservations();
  }catch(e){console.error(e);document.getElementById('userInfo').innerText='❌ 初始化失敗';}
}

// ==================== 日曆 =====================
function toggleCalendar(){
  const c=document.getElementById('calendarContainer');
  c.style.display=c.style.display==='none'?'block':'none';
  renderCalendar();
}

function renderCalendar(){
  const cal=document.getElementById('calendar');
  const now=new Date(),y=now.getFullYear(),m=now.getMonth();
  document.getElementById('calendarTitle').innerText=`${y}年${m+1}月`;
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  let html='';const wd=first.getDay();
  for(let i=0;i<wd;i++)html+='<div></div>';
  for(let d=1;d<=last.getDate();d++){
    const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isPast=new Date(ds)<new Date(now.toDateString());
    const hasReserved=existingReservations.some(r=>r.date===ds);
    const isBlocked=blockedDates.has(ds);
    let cls='calendar-day',disabled=false;
    if(isPast||hasReserved||isBlocked){cls+=' disabled';disabled=true;}
    html+=`<div class="${cls}" ${disabled?'':`onclick="selectDate('${ds}')"`}>${d}${isBlocked?'<br><small style="color:#d32f2f;">停駛</small>':''}</div>`;
  }
  cal.innerHTML=html;
}

function selectDate(ds){
  if(existingReservations.some(r=>r.date===ds)){alert('⚠️ 您當日已有預約，請勿重複。');return;}
  if(blockedDates.has(ds)){alert('❌ 該日停駛，無法預約。');return;}
  selectedDate=ds;
  document.getElementById('selectedDate').textContent=`✅ 已選擇日期：${ds}`;
  document.getElementById('selectedDate').style.display='block';
  renderRoutes();
}

// ==================== 班次與停靠 =====================
function renderRoutes(){
  const c=document.getElementById('routeButtons');
  let html='';
  RULES.availableRoutes.forEach(r=>{
    html+=`
      <div class="route-btn" onclick="selectRoute('${r.id}', this)">
        ${r.id}
        <span class="time">${r.time}</span>
        <span class="cn">${r.direction}</span>
        <span class="en">${r.eng}</span>
      </div>`;
  });
  c.innerHTML=html;c.style.display='grid';
}

function selectRoute(id,btn){
  selectedRoute=id;
  document.querySelectorAll('.route-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  renderStops();
}

function renderStops(){
  const fs=document.getElementById('fromStop');
  const ts=document.getElementById('toStop');
  fs.innerHTML='<option value="">請選擇上車地點 / Select Pick-up Stop</option>';
  ts.innerHTML='<option value="">請選擇下車地點 / Select Drop-off Stop</option>';
  RULES.stopList.forEach(([cn,en])=>{
    const f=document.createElement('option');f.value=cn;f.textContent=`${cn} / ${en}`;fs.appendChild(f);
    const t=f.cloneNode(true);ts.appendChild(t);
  });
  document.getElementById('stopSection').style.display='block';
  fs.onchange=ts.onchange=()=>checkStopsReady();
}

function checkStopsReady(){
  const from=document.getElementById('fromStop').value;
  const to=document.getElementById('toStop').value;
  document.getElementById('submitBtn').style.display=(from&&to)?'block':'none';
}

// ==================== 預約與取消 =====================
async function submitReservation(){
  const from=document.getElementById('fromStop').value;
  const to=document.getElementById('toStop').value;
  if(!selectedDate||!selectedRoute||!from||!to){alert('⚠️ 請完整選擇上下車地點');return;}
  if(from===to){alert('⚠️ 上下車地點不可相同');return;}
  const r=RULES.availableRoutes.find(r=>r.id===selectedRoute);
  const data={type:'reserve',userId:userData.userId,name:userData.name,studentId:userData.studentId,department:userData.department,phone:userData.phone||'',route:selectedRoute,routeName:`${selectedRoute} | ${r.time} ${r.direction}`,fromStop:from,toStop:to,date:selectedDate};
  const res=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  const j=await res.json();
  if(j.status==='success'){
    alert('✅ 預約成功！');
    existingReservations.push({id:j.id||`temp-${Date.now()}`,date:data.date,route:data.routeName,name:data.name,fromStop:data.fromStop,toStop:data.toStop});
    renderReservations();
  }else alert('❌ 預約失敗，請稍後再試');
}

async function cancelReservation(id){
  if(!confirm('確定取消這筆預約？'))return;
  const r=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'cancel',id,userId:userData.userId})});
  const j=await r.json();
  if(j.status==='success'){alert('✅ 已取消');existingReservations=existingReservations.filter(e=>e.id!==id);renderReservations();}
  else alert('❌ 取消失敗');
}

// ==================== 渲染預約紀錄 =====================
function renderReservations(){
  const c=document.getElementById('currentReservationCard');
  if(!RULES||!RULES.stopList)RULES={stopList:[]};
  if(!existingReservations.length){
    c.innerHTML='<div style="text-align:center;padding:20px;">目前沒有預約紀錄<br><span class="en" style="color:#0056b3;">No reservation records</span></div>';
    c.style.display='block';return;
  }
  let h='<h3 style="text-align:center;">🧾 我的預約<span class="en" style="display:block;color:#0056b3;font-size:14px;">My Reservations</span></h3>';
  existingReservations.forEach(r=>{
    const fromEn=(RULES.stopList.find(s=>s[0]===r.fromStop)||[])[1]||r.fromStop;
    const toEn=(RULES.stopList.find(s=>s[0]===r.toStop)||[])[1]||r.toStop;
    h+=`<div class="reservation-bubble"><div class="bubble-header">🚌 穿山甲專車新預約<span class="en">Pangolin Shuttle New Reservation</span></div><div class="bubble-body">日期：${r.date}<br><span class="en">Date: ${r.date}</span>班次：${r.route}<br><span class="en">Route: ${r.route}</span>上車：${r.fromStop}<br><span class="en">Pick-up: ${
