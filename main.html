<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç©¿å±±ç”²å°ˆè»Šé ç´„</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
    header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; }
    .card { background:#fff; margin:16px; border-radius:8px; padding:16px; box-shadow:0 0 5px rgba(0,0,0,0.1); }

    /* æŒ‰éˆ• */
    input, select { width:100%; padding:10px; margin-top:8px; border-radius:6px; border:1px solid #ccc; font-size:16px; }
    button { width:100%; background:#3c8050; color:#fff; border:none; padding:12px; border-radius:6px; font-size:18px; font-weight:bold; margin-top:12px; cursor:pointer; position: relative; }
    button:disabled { background:#aaa; cursor:not-allowed; }
    button.loading { background:#2d6140; color: transparent; }
    button.loading::after {
      content: ''; position: absolute; width: 20px; height: 20px; top: 50%; left: 50%;
      margin: -10px 0 0 -10px; border: 2px solid #ffffff; border-radius: 50%;
      border-top-color: transparent; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* æç¤º */
    .notice { padding:10px; margin-top:10px; border-radius:6px; }
    .notice.error { background:#fdecea; color:#b71c1c; border:1px solid #f5c2c7; }
    .notice.success { background:#e8f5e9; color:#2e7d32; border:1px solid #81c784; }

    /* æœˆæ›† */
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap:3px; text-align:center; font-size:13px; }
    .calendar-header { padding:6px 0; font-weight:bold; background:#f0f0f0; border-radius:3px; font-size:12px; }
    .calendar-day { padding:4px 0; border-radius:4px; background:#fff; border:1px solid #e0e0e0; cursor:pointer; min-height:30px; display:flex; flex-direction:column; justify-content:center; }
    .calendar-day:hover { background:#e8f5e9; }
    .calendar-day.no-service { background:#ffe6e6; color:#999; cursor:not-allowed; }
    .calendar-day.selected { background:#3c8050; color:#fff; font-weight:bold; }
    .calendar-day.other-month { color:#ccc; }
    .calendar-day.today { border:2px solid #3c8050; }
    .calendar-day small { font-size:9px; }

    /* ç­æ¬¡æŒ‰éˆ• */
    #routeButtons { 
      display:flex; 
      flex-wrap:wrap; 
      gap:4px;
      justify-content:space-between;
      margin: 0 -2px;
    }
    .route-btn {
      flex: 0 0 calc(45% - 4px);
      margin: 0 1px;
      padding: 4px 2px;
      border-radius:6px;
      text-align:left;
      border:1px solid #ddd;
      font-size:12px;
      cursor:pointer;
      transition:0.2s;
      min-height:80px;
      display:flex;
      align-items:center;
      background:#fff;
      color:#000;
      box-sizing: border-box;
    }
    
    .route-btn.A1, .route-btn.B1 { border-color:#4caf50; }
    .route-btn.A2, .route-btn.B2 { border-color:#4285f4; }
    
    .route-btn.full { 
      background:#f5f5f5; 
      color:#999; 
      border-color:#ccc; 
      cursor:not-allowed; 
    }
    
    .route-btn.selected { 
      color:#fff !important;
    }
    .route-btn.selected.A1, .route-btn.selected.B1 { 
      background:#2e7d32; 
      border-color:#2e7d32;
    }
    .route-btn.selected.A2, .route-btn.selected.B2 { 
      background:#1a73e8; 
      border-color:#1a73e8;
    }

    .route-content { 
      display: flex; 
      flex-direction: column; 
      gap: 2px; 
      width: 90%;
      padding: 0 2px;
    }
    .route-time { 
      font-weight: bold; 
      font-size: 14px; 
      line-height: 1.2;
    }
    .route-direction { 
      font-size: 14px; 
      line-height: 1.2;
      margin: 1px 0;
    }
    .route-seats { 
      font-size: 14px; 
      color: #666;
      line-height: 1.2;
    }

    .route-btn.selected .route-time,
    .route-btn.selected .route-direction,
    .route-btn.selected .route-seats {
      color: #fff !important;
    }

    .route-section {
      display: none;
    }

    .loading-state {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    /* é ç´„è¨˜éŒ„å¡ç‰‡ */
    .reservation-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .reservation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .reservation-date {
      font-weight: bold;
      color: #2e7d32;
      font-size: 16px;
    }
    .reservation-route {
      font-weight: bold;
      color: #1a73e8;
    }
    .reservation-details {
      color: #666;
      font-size: 14px;
      line-height: 1.4;
    }
    .cancel-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      margin-top: 8px;
      width: auto;
    }
    .cancel-btn:hover {
      background: #d32f2f;
    }
    .cancel-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    @media (max-width:450px){
      .route-btn {
        flex: 0 0 calc(45% - 4px);
        min-height:80px;
        padding:3px 2px;
      }
      .route-content {
        padding: 0 1px;
      }
      .route-time { font-size: 13px; }
      .route-direction { font-size: 13px; }
      .route-seats { font-size: 13px; }
    }

    @media (max-width:360px){
      .route-btn {
        min-height:55px;
      }
      .route-time { font-size: 13px; }
      .route-direction { font-size: 13px; }
      .route-seats { font-size: 13px; }
    }
  </style>
</head>
<body>
  <header>ğŸšŒ ç©¿å±±ç”²å°ˆè»Šé ç´„</header>

  <div class="card">
    <div id="userInfo" style="margin-bottom:15px;line-height:1.5;color:#2e7d32;font-weight:bold;">
      <div class="loading-state">â³ ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
    </div>

    <!-- ç¾æœ‰é ç´„è¨˜éŒ„ -->
    <div id="existingReservations" style="margin-bottom:20px; display:none;">
      <h3 style="margin:0 0 10px 0; color:#2e7d32;">ğŸ“‹ æˆ‘çš„é ç´„è¨˜éŒ„</h3>
      <div id="reservationsList"></div>
    </div>

    <label><center>é¸æ“‡æ­ä¹˜æ—¥æœŸ</center></label>
    <button id="calendarBtn" onclick="toggleCalendar()" disabled>ğŸ“… è¼‰å…¥ä¸­...</button>

    <!-- é ç´„æˆåŠŸè¨Šæ¯ -->
    <div id="result" style="margin-top:10px;"></div>

    <div id="calendarContainer" style="display:none;margin-top:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <button onclick="changeMonth(-1)" style="width:auto; padding:5px 10px;">â—€ ä¸Šå€‹æœˆ</button>
        <h3 id="calendarTitle" style="margin:0; font-size:16px;"></h3>
        <button onclick="changeMonth(1)" style="width:auto; padding:5px 10px;">ä¸‹å€‹æœˆ â–¶</button>
      </div>
      <div id="calendar" class="calendar"></div>
    </div>
    <div id="selectedDate" class="notice success" style="display:none;"></div>
    <div id="holidayNotice" class="notice error" style="display:none;"></div>

    <!-- ç­æ¬¡é¸æ“‡å€åŸŸ -->
    <div id="routeSection" class="route-section">
      <label>è«‹é¸æ“‡æ­ä¹˜ç­æ¬¡ *</label>
      <div id="routeButtons"></div>

      <label>ä¸‹è»Šç«™ *</label>
      <select id="toStop"><option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option></select>

      <button id="submitBtn" onclick="submitForm()">é€å‡ºé ç´„</button>
    </div>
  </div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let selectedDate = null;
let selectedRoute = null;
let userData = null;
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let noServiceDates = {};
let existingReservations = [];

const stopsOutbound = ["è¡Œæ”¿å¤§æ¨“","ä¸­é¤å»³","ç§‘æŠ€å­¸é™¢","å­¸äººæœƒé¤¨","ä¸­åŸ","ä¸‹åŸ","åªé ‚","æ„›è˜­æ©‹","å¤§æˆåœ‹å°","ä¸­å±±å®‰ä¸ƒè¡—å£","æ¦®æ°‘è¨ºæ‰€","åŸ”é‡Œé…’å» ","åŸ”é‡Œç¸½ç«™"];
const stopsReturn = ["åŸ”é‡Œç¸½ç«™","åŸ”é‡Œé…’å» ","æ¦®æ°‘è¨ºæ‰€","ä¸­å±±å®‰ä¸ƒè¡—å£","å¤§æˆåœ‹å°","æ„›è˜­æ©‹","åªé ‚","ä¸‹åŸ","ä¸­åŸ","å­¸äººæœƒé¤¨","ç§‘æŠ€å­¸é™¢","ä¸­é¤å»³","è¡Œæ”¿å¤§æ¨“"];

const routeTimes = {
  'A1': { time: '22:00-22:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™' },
  'B1': { time: '22:30-23:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§' },
  'A2': { time: '23:00-23:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™' },
  'B2': { time: '23:30-24:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§' }
};

// === æ—¥æœŸå·¥å…·å‡½æ•¸ ===
function formatDateToLocal(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function createLocalDate(year, month, day) {
  return new Date(year, month, day);
}

// === åˆå§‹åŒ– ===
async function init() {
  try {
    console.log('é–‹å§‹åˆå§‹åŒ– LIFF...');

    await liff.init({ 
      liffId: "2006590746-KJodGOda" 
    });
    console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');

    if (!liff.isLoggedIn()) {
      console.log('ä½¿ç”¨è€…æœªç™»å…¥ï¼Œé–‹å§‹ç™»å…¥...');
      liff.login();
      return;
    }

    console.log('ä½¿ç”¨è€…å·²ç™»å…¥ï¼Œå–å¾—ä½¿ç”¨è€…è³‡æ–™...');
    const profile = await liff.getProfile();
    console.log('å–å¾—ä½¿ç”¨è€… Profile:', profile);

    const res = await fetch(`${WORKER_URL}?check=${profile.userId}`);
    const result = await res.json();
    console.log('è¨»å†Šæª¢æŸ¥çµæœ:', result);

    if (!result.registered) {
      console.log('ä½¿ç”¨è€…æœªè¨»å†Šï¼Œå°å‘è¨»å†Šé é¢');
      window.location.href = 'register.html';
      return;
    }

    userData = result.user;
    console.log('ä½¿ç”¨è€…è³‡æ–™:', userData);

    document.getElementById('userInfo').innerHTML = `ğŸ‘¤ ${userData.name}<br>ğŸ« ${userData.department}ï½œ${userData.studentId}`;

    document.getElementById('calendarBtn').disabled = false;
    document.getElementById('calendarBtn').textContent = 'ğŸ“… æ‰“é–‹æœˆæ›†';

    await loadNoServiceDates();
    await loadExistingReservations();

    console.log('ç³»çµ±åˆå§‹åŒ–å®Œæˆ');

  } catch (error) {
    console.error('åˆå§‹åŒ–å¤±æ•—:', error);

    document.getElementById('userInfo').innerHTML = 
      '<div class="notice error">âŒ ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–ç¨å¾Œå†è©¦<br><small>éŒ¯èª¤: ' + error.message + '</small></div>';

    document.getElementById('calendarBtn').disabled = false;
    document.getElementById('calendarBtn').textContent = 'ğŸ“… æ‰“é–‹æœˆæ›†ï¼ˆé›¢ç·šæ¨¡å¼ï¼‰';

    userData = {
      userId: 'offline-user',
      name: 'æ¸¬è©¦ä½¿ç”¨è€…',
      department: 'æ¸¬è©¦å­¸ç³»',
      studentId: '00000000',
      phone: '0900000000'
    };

    document.getElementById('userInfo').innerHTML = `ğŸ‘¤ ${userData.name}<br>ğŸ« ${userData.department}ï½œ${userData.studentId}<br><small style="color: #666;">é›¢ç·šæ¨¡å¼</small>`;
  }
}

init();

// === è¼‰å…¥ç¾æœ‰é ç´„ ===
async function loadExistingReservations() {
  try {
    console.log('è¼‰å…¥ç¾æœ‰é ç´„...');
    const res = await fetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`);
    const result = await res.json();

    if (result.success && result.reservations) {
      existingReservations = result.reservations;
      console.log('ç¾æœ‰é ç´„:', existingReservations);
      renderExistingReservations();
    } else {
      console.log('æ²’æœ‰ç¾æœ‰é ç´„');
    }
  } catch (error) {
    console.error('è¼‰å…¥é ç´„å¤±æ•—:', error);
  }
}

// === é¡¯ç¤ºç¾æœ‰é ç´„ ===
function renderExistingReservations() {
  const container = document.getElementById('reservationsList');
  const section = document.getElementById('existingReservations');

  if (existingReservations.length === 0) {
    section.style.display = 'none';
    return;
  }

  const today = formatDateToLocal(new Date());
  const futureReservations = existingReservations
    .filter(reservation => reservation.date >= today)
    .sort((a, b) => a.date.localeCompare(b.date));
  
  if (futureReservations.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  container.innerHTML = '';
  
  futureReservations.forEach(reservation => {
    const card = document.createElement('div');
    card.className = 'reservation-card';
    
    const routeInfo = routeTimes[reservation.route] || { 
      time: '', 
      direction: reservation.routeName || '' 
    };
    
    const reservationId = reservation.id || reservation.reservationId || `${reservation.userId}_${reservation.date}_${reservation.route}`;
    
    card.innerHTML = `
      <div class="reservation-header">
        <div class="reservation-date">${reservation.date}</div>
        <div class="reservation-route">${reservation.route}ï½œ${routeInfo.direction}</div>
      </div>
      <div class="reservation-details">
        <div>â° ${routeInfo.time}</div>
        <div>ğŸ“ ${reservation.fromStop} â†’ ${reservation.toStop}</div>
        <div>ğŸ‘¤ ${reservation.name}ï½œ${reservation.studentId}</div>
      </div>
      <button class="cancel-btn" onclick="cancelReservation('${reservationId}', '${reservation.date}', '${reservation.route}')">å–æ¶ˆé ç´„</button>
    `;
    
    container.appendChild(card);
  });
}

// === å–æ¶ˆé ç´„ ===
async function cancelReservation(reservationId, date, route) {
  if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™å€‹é ç´„å—ï¼Ÿ')) {
    return;
  }

  try {
    const data = {
      type: 'cancel',
      reservationId: reservationId,
      userId: userData.userId,
      date: date,
      route: route
    };

    console.log('å–æ¶ˆé ç´„è³‡æ–™:', data);

    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });

    const result = await res.json();

    if(result.status === 'success'){
      await loadExistingReservations();
      document.getElementById('result').innerHTML = 
        `<div class="notice success">âœ… å·²æˆåŠŸå–æ¶ˆé ç´„</div>`;
      setTimeout(() => {
        document.getElementById('result').innerHTML = '';
      }, 3000);
    } else {
      document.getElementById('result').innerHTML =
        `<div class="notice error">âŒ å–æ¶ˆé ç´„å¤±æ•—ï¼š${result.message || 'è«‹ç¨å¾Œå†è©¦'}</div>`;
    }
  } catch (error) {
    console.error('å–æ¶ˆé ç´„éŒ¯èª¤:', error);
    document.getElementById('result').innerHTML =
      `<div class="notice error">âŒ å–æ¶ˆé ç´„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</div>`;
  }
}

// === è¼‰å…¥åœé§›æ—¥æœŸ ===
async function loadNoServiceDates() {
  try {
    console.log('æ­£åœ¨è¼‰å…¥åœé§›æ—¥æœŸ...');

    const startDate = formatDateToLocal(new Date(currentYear, currentMonth - 1, 1));
    const endDate = formatDateToLocal(new Date(currentYear, currentMonth + 2, 0));

    const res = await fetch(`${WORKER_URL}?mode=calendar&start=${startDate}&end=${endDate}&calendarId=${encodeURIComponent(CALENDAR_ID)}`);
    const result = await res.json();

    console.log('æ—¥æ›†APIå›å‚³:', result);

    noServiceDates = {};

    if (result.holidays && Array.isArray(result.holidays)) {
      result.holidays.forEach(date => {
        if (typeof date === 'string' && date.length >= 10) {
          noServiceDates[date.substring(0, 10)] = true;
        }
      });
      console.log('å·²è¼‰å…¥åœé§›æ—¥æœŸ:', Object.keys(noServiceDates));
    }
  } catch (error) {
    console.error('è¼‰å…¥åœé§›æ—¥æœŸå¤±æ•—:', error);
    noServiceDates = {};
  }
}

// === æœˆæ›†åŠŸèƒ½ ===
async function toggleCalendar() {
  const c = document.getElementById('calendarContainer');
  if (c.style.display === 'none') {
    await renderCalendar();
    c.style.display = 'block';
  } else {
    c.style.display = 'none';
  }
}

async function changeMonth(direction) {
  currentMonth += direction;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }

  await loadNoServiceDates();
  await renderCalendar();
}

async function renderCalendar() {
  const cal = document.getElementById('calendar');
  const title = document.getElementById('calendarTitle');

  const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
  title.textContent = `${currentYear}å¹´ ${monthNames[currentMonth]}`;

  cal.innerHTML = '';

  const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  weekdays.forEach(day => {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-header';
    dayElement.textContent = day;
    cal.appendChild(dayElement);
  });

  const today = new Date();
  const firstDay = createLocalDate(currentYear, currentMonth, 1);
  const lastDay = createLocalDate(currentYear, currentMonth + 1, 0);
  const startWeekday = firstDay.getDay();
  const totalDays = lastDay.getDate();

  const prevMonthLastDay = createLocalDate(currentYear, currentMonth, 0).getDate();
  for (let i = startWeekday - 1; i >= 0; i--) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day other-month';
    dayElement.textContent = prevMonthLastDay - i;
    cal.appendChild(dayElement);
  }

  for (let d = 1; d <= totalDays; d++) {
    const date = createLocalDate(currentYear, currentMonth, d);
    const formatted = formatDateToLocal(date);
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';

    const todayFormatted = formatDateToLocal(today);
    if (formatted === todayFormatted) {
      dayElement.classList.add('today');
    }

    const isPast = date < today && formatted !== todayFormatted;
    const isNoService = noServiceDates[formatted];

    if (isNoService || isPast) {
      dayElement.classList.add('no-service');
      if (isNoService) {
        dayElement.innerHTML = `${d}<br><small>åœé§›</small>`;
      } else if (isPast) {
        dayElement.innerHTML = `${d}<br><small>å·²éæœŸ</small>`;
      }
    } else {
      dayElement.textContent = d;
      dayElement.onclick = () => selectDate(formatted);
    }

    if (selectedDate === formatted) {
      dayElement.classList.add('selected');
    }

    cal.appendChild(dayElement);
  }

  const remainingCells = 42 - (startWeekday + totalDays);
  for (let d = 1; d <= remainingCells; d++) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day other-month';
    dayElement.textContent = d;
    cal.appendChild(dayElement);
  }
}

async function selectDate(date) {
  const isNoService = noServiceDates[date];

  if (isNoService) {
    document.getElementById('holidayNotice').style.display = 'block';
    document.getElementById('holidayNotice').innerText = `ğŸš« ${date} ç‚ºåœé§›æ—¥ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ`;
    document.getElementById('selectedDate').style.display = 'none';
    selectedDate = null;
    document.getElementById('routeSection').style.display = 'none';
    return;
  }

  selectedDate = date;
  document.getElementById('calendarContainer').style.display = 'none';
  document.getElementById('selectedDate').innerHTML = `âœ… å·²é¸æ“‡æ—¥æœŸï¼š${date}`;
  document.getElementById('selectedDate').style.display = 'block';
  document.getElementById('holidayNotice').style.display = 'none';
  document.getElementById('routeSection').style.display = 'block';
  
  loadSeatStatus();
}

// === è¼‰å…¥ç­æ¬¡ç‹€æ³ ===
function loadSeatStatus() {
  const container = document.getElementById('routeButtons');
  container.innerHTML = '';

  const routeData = {
    A1: { remain: 6, full: false },
    B1: { remain: 6, full: false },
    A2: { remain: 6, full: false },
    B2: { remain: 6, full: false }
  };

  ['A1', 'B1', 'A2', 'B2'].forEach(rid => {
    const r = routeData[rid];
    const routeInfo = routeTimes[rid];

    const div = document.createElement('div');
    div.className = `route-btn ${rid}`;
    if (r.full) div.classList.add('full');

    div.innerHTML = `
      <div class="route-content">
        <div class="route-time">${rid} ${routeInfo.time}</div>
        <div class="route-direction">${routeInfo.direction}</div>
        <div class="route-seats">å‰©é¤˜:${r.remain}ä½</div>
      </div>
    `;

    if (!r.full) {
      div.onclick = () => selectRoute(div, rid, routeInfo.direction);
    }

    container.appendChild(div);
  });
}

function selectRoute(btn, id, direction) {
  selectedRoute = id;
  document.querySelectorAll('.route-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  updateStops(direction);
}
// ç”¢ç”Ÿé ç´„è¨˜éŒ„çš„ Flex Message
function generateReservationFlexMessage(reservation) {
  // è§£æè·¯ç·šè³‡è¨Š
  const routeParts = reservation.route.split('|');
  const routeCode = routeParts[0].trim(); // A1
  const timeAndDirection = routeParts[1] ? routeParts[1].trim() : '';
  const [time, direction] = timeAndDirection.split(' ');
  
  return {
    type: "bubble",
    header: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: "ğŸšŒ ç©¿å±±ç”²å°ˆè»Šæ–°é ç´„",
          weight: "bold",
          color: "#ffffff",
          size: "lg"
        }
      ],
      backgroundColor: "#3c8050",
      paddingAll: "15px"
    },
    body: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: `æ—¥æœŸï¼š${reservation.date}`,
          size: "sm",
          color: "#555555",
          margin: "md"
        },
        {
          type: "text",
          text: `ç­æ¬¡ï¼š${routeCode} | ${time}`,
          size: "sm",
          color: "#555555",
          margin: "md"
        },
        {
          type: "text",
          text: `å§“åï¼š${reservation.name}`,
          size: "sm",
          color: "#555555",
          margin: "md"
        },
        {
          type: "text",
          text: `é›»è©±ï¼š${reservation.phone}`,
          size: "sm",
          color: "#555555",
          margin: "md"
        },
        {
          type: "text",
          text: `ä¸Šè»Šï¼š${reservation.fromStop}`,
          size: "sm",
          color: "#555555",
          margin: "md"
        },
        {
          type: "text",
          text: `ä¸‹è»Šï¼š${reservation.toStop}`,
          size: "sm",
          color: "#555555",
          margin: "md"
        }
      ],
      spacing: "md",
      paddingAll: "15px"
    },
    footer: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "button",
          action: {
            type: "uri",
            label: "å–æ¶ˆé ç´„",
            uri: `https://liff.line.me/2006590746-KJodGOda?cancel=${reservation.id}`
          },
          style: "primary",
          color: "#f44336",
          height: "sm"
        }
      ],
      spacing: "sm",
      paddingAll: "15px"
    }
  };
}

// ç™¼é€æ‰€æœ‰é ç´„è¨˜éŒ„çš„ Flex Messages
async function sendReservationFlexMessages(reservations) {
  if (!reservations || reservations.length === 0) {
    return;
  }

  const flexMessages = reservations.map(reservation => 
    generateReservationFlexMessage(reservation)
  );

  try {
    await liff.sendMessages([
      {
        type: 'flex',
        altText: 'æ‚¨çš„é ç´„è¨˜éŒ„',
        contents: {
          type: 'carousel',
          contents: flexMessages
        }
      }
    ]);
    console.log('Flex Messages ç™¼é€æˆåŠŸ');
  } catch (error) {
    console.error('ç™¼é€ Flex Messages å¤±æ•—:', error);
  }
}

// ä½¿ç”¨ç¯„ä¾‹ï¼šåœ¨è¼‰å…¥é ç´„å¾Œç™¼é€ Flex Message
async function loadAndSendReservations() {
  try {
    const res = await fetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`);
    const result = await res.json();

    if (result.success && result.reservations && result.reservations.length > 0) {
      existingReservations = result.reservations;
      
      // ç™¼é€ Flex Message
      await sendReservationFlexMessages(result.reservations);
      
      // ä¹Ÿåœ¨ç¶²é ä¸Šé¡¯ç¤º
      renderExistingReservations();
    }
  } catch (error) {
    console.error('è¼‰å…¥é ç´„å¤±æ•—:', error);
  }
}
function updateStops(routeDirection) {
  const toStop = document.getElementById('toStop');
  toStop.innerHTML = '<option value="">è«‹é¸æ“‡ä¸‹è»Šç«™</option>';

  const isOutbound = routeDirection.includes('æš¨å¤§â†’');
  const stops = isOutbound ? stopsOutbound : stopsReturn;
  const fromStop = isOutbound ? 'è¡Œæ”¿å¤§æ¨“' : 'åŸ”é‡Œç¸½ç«™';

  stops.filter(s => s !== fromStop).forEach(s => {
    const o = document.createElement('option');
    o.value = s;
    o.textContent = s;
    toStop.appendChild(o);
  });
}

// === é ç´„åŠŸèƒ½ ===
async function submitForm() {
  const toStop = document.getElementById('toStop').value;
  const btn = document.getElementById('submitBtn');

  if (!selectedDate || !selectedRoute || !toStop) {
    alert('è«‹å®Œæ•´é¸æ“‡æ—¥æœŸã€ç­æ¬¡èˆ‡ä¸‹è»Šç«™');
    return;
  }

  btn.disabled = true;
  btn.classList.add('loading');

  try {
    const routeInfo = routeTimes[selectedRoute];
    const routeName = `${selectedRoute}|${routeInfo.time} ${routeInfo.direction}`;

    const data = {
      type: 'reserve',
      userId: userData.userId,
      name: userData.name,
      studentId: userData.studentId,
      department: userData.department,
      phone: userData.phone || '',
      route: selectedRoute,
      routeName: routeName,
      fromStop: selectedRoute.includes('A') ? 'è¡Œæ”¿å¤§æ¨“' : 'åŸ”é‡Œç¸½ç«™',
      toStop: toStop,
      date: selectedDate
    };

    console.log('ç™¼é€é ç´„è³‡æ–™:', data);

    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });

    const result = await res.json();

    if(result.status === 'success'){
      document.getElementById('result').innerHTML = 
        `<div class="notice success">
          âœ… é ç´„æˆåŠŸ<br>
          ${selectedDate}ï½œ${selectedRoute} ${routeInfo.time}<br>
          ${routeInfo.direction.split('â†’')[0]} â†’ ${toStop}
        </div>`;

      selectedDate = null;
      selectedRoute = null;
      document.getElementById('selectedDate').style.display = 'none';
      document.getElementById('routeSection').style.display = 'none';
      document.getElementById('toStop').innerHTML = '<option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option>';

      await loadExistingReservations();

    } else {
      document.getElementById('result').innerHTML =
        `<div class="notice error">âŒ é ç´„å¤±æ•—ï¼š${result.message || 'è«‹ç¨å¾Œå†è©¦'}</div>`;
    }
  } catch (error) {
    console.error('é ç´„éŒ¯èª¤:', error);
    document.getElementById('result').innerHTML =
      `<div class="notice error">âŒ é ç´„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</div>`;
  } finally {
    btn.disabled = false;
    btn.classList.remove('loading');
  }
}
</script>
</body>
</html>
