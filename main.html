/*****************************************************
 * ğŸšŒ ç©¿å±±ç”²å°ˆè»Š å¾Œç«¯ API v4.0
 * æ”¯æ´åŠŸèƒ½ï¼š
 * - è¨»å†Šæª¢æŸ¥ï¼ˆcheckï¼‰
 * - æŸ¥è©¢é ç´„ç´€éŒ„ï¼ˆreservationsï¼‰
 * - æŸ¥è©¢åœé§›ï¼å…¬ä¼‘æ—¥ï¼ˆcalendarï¼‰
 * - é ç´„å¯«å…¥ï¼ˆreserveï¼‰
 * - å–æ¶ˆé ç´„ï¼ˆcancelï¼‰
 * --------------------------------------------------
 * ğŸ”§ æ¬„ä½é †åºå°æ‡‰ A~Kï¼š
 * A:é ç´„æ­è»Šæ—¥æœŸ | B:å§“å | C:æ‰‹æ©Ÿ | D:è·¯ç·šæ–¹å‘
 * E:ä¸Šè»Šç«™ | F:ä¸‹è»Šç«™ | G:æ™‚é–“æˆ³è¨˜
 * H:ç‹€æ…‹ | I:å–æ¶ˆæ™‚é–“ | J:ç°½åˆ°(Y/N) | K:LINEç”¨æˆ¶ID
 *****************************************************/

const SHEET_ID = '19zDueZCpq-qJsZsMVq4hSZh2BZrZv7pfQxMk5PTy4s4';
const USER_SHEET = 'è¨»å†Šäººè³‡æ–™';
const RESERVE_SHEET = 'é ç´„è³‡æ–™';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';

const MASTER_ADMINS = [
  'U84b2e88d818b98575f45fcf14a380517',
  'Ue7a07fe317565389fbf4479172088f87'
];

/* =======================================================
   ä¸»å…¥å£
======================================================= */
function doGet(e) {
  try {
    const mode = e.parameter.mode || 'ping';
    switch (mode) {
      case 'check': return checkUser(e);
      case 'reservations': return getReservations(e);
      case 'calendar': return getCalendarEvents(e);
      case 'ping': default:
        return output({ status: 'ok', message: 'ç©¿å±±ç”²å°ˆè»Š API é‹ä½œä¸­', time: new Date().toISOString() });
    }
  } catch (err) {
    return output({ status: 'error', message: err.message });
  }
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    switch (data.type) {
      case 'register': return registerUser(data);
      case 'reserve': return reserveTrip(data);
      case 'cancel': return cancelReservation(data);
      default:
        return output({ status: 'error', message: 'æœªçŸ¥çš„ POST è«‹æ±‚é¡å‹: ' + data.type });
    }
  } catch (err) {
    return output({ status: 'error', message: 'POST éŒ¯èª¤: ' + err.message });
  }
}

/* =======================================================
   æª¢æŸ¥è¨»å†Šç‹€æ…‹
======================================================= */
function checkUser(e) {
  const userId = e.parameter.userId;
  if (!userId) return output({ status: 'error', message: 'ç¼ºå°‘ userId' });

  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(USER_SHEET);
  const rows = sheet.getDataRange().getValues();
  const row = rows.find(r => r[0] === userId);

  if (row) {
    const user = {
      userId: row[0],
      name: row[1],
      studentId: row[2],
      department: row[3],
      phone: row[4] || '',
    };
    const isAdmin = MASTER_ADMINS.includes(userId);
    return output({ status: 'success', registered: true, isAdmin, user });
  } else {
    return output({ status: 'success', registered: false });
  }
}

/* =======================================================
   æŸ¥è©¢é ç´„ç´€éŒ„
======================================================= */
function getReservations(e) {
  const userId = e.parameter.userId;
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(RESERVE_SHEET);
  const values = sheet.getDataRange().getValues();

  const list = values
    .filter(r => r[10] === userId && r[7] !== 'å·²å–æ¶ˆ') // éæ¿¾å–æ¶ˆç´€éŒ„
    .map(r => ({
      date: r[0],
      name: r[1],
      phone: r[2],
      route: r[3],
      fromStop: r[4],
      toStop: r[5],
      timestamp: r[6],
      status: r[7],
      cancelTime: r[8],
      signed: r[9],
      userId: r[10]
    }));

  return output({ status: 'success', reservations: list });
}

/* =======================================================
   æŸ¥è©¢ Google Calendar åœé§›ï¼å…¬ä¼‘
======================================================= */
function getCalendarEvents(e) {
  try {
    const calendarId = e.parameter.calendarId || CALENDAR_ID;
    const start = new Date(e.parameter.start);
    const end = new Date(e.parameter.end);
    const cal = CalendarApp.getCalendarById(calendarId);
    const events = cal.getEvents(start, end);

    const list = events.map(ev => ({
      date: Utilities.formatDate(ev.getStartTime(), 'Asia/Taipei', 'yyyy-MM-dd'),
      title: ev.getTitle(),
      allDay: ev.isAllDayEvent(),
    })).filter(e => e.title.includes('åœé§›') || e.title.includes('å…¬ä¼‘'));

    return output({ status: 'success', events: list });
  } catch (err) {
    return output({ status: 'error', message: 'è®€å–è¡Œäº‹æ›†éŒ¯èª¤: ' + err.message });
  }
}

/* =======================================================
   å¯«å…¥é ç´„
======================================================= */
function reserveTrip(data) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheetByName(RESERVE_SHEET);

    const newRow = [
      data.date,
      data.name,
      data.phone || '',
      `${data.route} | ${getRouteTime(data.route)}`,
      data.fromStop,
      data.toStop,
      Utilities.formatDate(new Date(), 'Asia/Taipei', 'yyyy-MM-dd HH:mm:ss'),
      'å·²é ç´„',
      '',
      'N',
      data.userId
    ];

    sheet.appendRow(newRow);
    return output({ status: 'success', message: 'é ç´„æˆåŠŸ', data: newRow });
  } catch (err) {
    return output({ status: 'error', message: 'å¯«å…¥å¤±æ•—: ' + err.message });
  }
}

/* =======================================================
   å–æ¶ˆé ç´„ï¼ˆğŸ”´ æ–°å¢ï¼‰
======================================================= */
function cancelReservation(data) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheetByName(RESERVE_SHEET);
    const values = sheet.getDataRange().getValues();

    const idx = values.findIndex(r => 
      r[10] === data.userId && r[0] === data.date && r[3].startsWith(data.route)
    );

    if (idx === -1) {
      return output({ status: 'error', message: 'æ‰¾ä¸åˆ°ç¬¦åˆçš„é ç´„è³‡æ–™' });
    }

    const cancelTime = Utilities.formatDate(new Date(), 'Asia/Taipei', 'yyyy-MM-dd HH:mm:ss');
    sheet.getRange(idx + 1, 8).setValue('å·²å–æ¶ˆ'); // H æ¬„ ç‹€æ…‹
    sheet.getRange(idx + 1, 9).setValue(cancelTime); // I æ¬„ å–æ¶ˆæ™‚é–“

    return output({ status: 'success', message: 'å·²æˆåŠŸå–æ¶ˆé ç´„', date: data.date, route: data.route });

  } catch (err) {
    return output({ status: 'error', message: 'å–æ¶ˆå¤±æ•—: ' + err.message });
  }
}

/* =======================================================
   å·¥å…·å‡½å¼
======================================================= */
function getRouteTime(route) {
  const routeTimes = {
    'A1': '22:00-22:30 æš¨å¤§â†’åŸ”é‡Œç¸½ç«™',
    'B1': '22:30-23:00 åŸ”é‡Œç¸½ç«™â†’æš¨å¤§',
    'A2': '23:00-23:30 æš¨å¤§â†’åŸ”é‡Œç¸½ç«™',
    'B2': '23:30-24:00 åŸ”é‡Œç¸½ç«™â†’æš¨å¤§'
  };
  return routeTimes[route] || '';
}

function output(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
