<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>穿山甲專車預約 🚍</title>

<style>
body{font-family:system-ui,sans-serif;background:#f5f6f7;margin:0;padding:0}
header{background:#3c8050;color:#fff;text-align:center;padding:15px;font-size:22px;font-weight:bold}
.notice{padding:10px 16px;margin:10px 0;border-radius:6px}
.notice.success{background:#e8f5e9;color:#2e7d32;border:1px solid #81c784}
.notice.error{background:#fdecea;color:#b71c1c;border:1px solid #f5c2c7}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;text-align:center;font-size:13px;margin-bottom:20px}
.calendar-day{padding:8px 0;min-height:45px;border-radius:4px;background:#fff;border:1px solid #e0e0e0;cursor:pointer}
.calendar-day:hover{background:#eaf5ea}
.calendar-day.past{background:#f5f5f5;color:#ccc;cursor:not-allowed}
.calendar-day.selected{background:#3c8050;color:#fff;font-weight:bold}
.calendar-day.disabled{background:#ffe6e6;color:#999;cursor:not-allowed}
.route-section,.stop-selector{padding:0 16px;margin:20px 0}
.route-buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.route-btn{padding:12px;border:2px solid #3c8050;border-radius:8px;background:white;cursor:pointer;text-align:center}
.route-btn:hover{background:#eaf5ea}
.route-btn.selected{background:#3c8050;color:white}
select{width:100%;padding:12px;border:1px solid #ccc;border-radius:6px;margin-top:8px}
.submit-btn{background:#3c8050;color:white;border:none;padding:15px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;width:calc(100% - 32px);margin:20px 16px}
.submit-btn:hover{background:#2d6140}
.btn-group{display:flex;justify-content:center;gap:12px;margin:15px}
.btn-large{font-size:18px;padding:12px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:bold}
.btn-calendar{background:#3c8050;color:white}
.btn-calendar:hover{background:#2d6140}
.btn-rule{background:#e0e0e0;color:#333}
.btn-rule:hover{background:#d6d6d6}
.cancel-btn{background:#c62828;color:white;border:none;padding:10px 20px;border-radius:6px;font-weight:bold;cursor:pointer;margin-top:8px}
.cancel-btn:hover{background:#b71c1c}
.resv-card{background:#f0fdf4;border:1px solid #a5d6a7;padding:10px 16px;border-radius:8px;margin:16px}
.resv-row{margin:4px 0}
</style>
</head>

<body>
<header>穿山甲專車預約</header>

<div id="userInfo" style="padding:16px"><div class="loading-state">⏳ 系統初始化中...</div></div>

<!-- 📅 操作按鈕 -->
<div class="btn-group">
  <button id="calendarBtn" class="btn-large btn-calendar" onclick="toggleCalendar()">📅 打開月曆</button>
  <button id="ruleBtn" class="btn-large btn-rule" onclick="showRules()">📘 預約規則</button>
</div>

<!-- 📅 月曆 -->
<div id="calendarContainer" style="display:none;margin-top:10px;padding:0 16px">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <button onclick="changeMonth(-1)">◀ 上個月</button>
    <h3 id="calendarTitle"></h3>
    <button onclick="changeMonth(1)">下個月 ▶</button>
  </div>
  <div id="calendar" class="calendar"></div>
</div>

<!-- ✅ 已預約資訊 -->
<div id="reservationInfo" style="display:none"></div>

<!-- ✅ 預約區 -->
<div id="selectedDate" class="notice success" style="display:none"></div>
<div id="routeSection" class="route-section" style="display:none">
  <h3>請選擇搭乘班次</h3>
  <div id="routeButtons" class="route-buttons"></div>
</div>
<div id="fromStopSection" class="stop-selector" style="display:none">
  <h3>請選擇上車站</h3>
  <select id="fromStop"><option value="">請先選擇班次</option></select>
</div>
<div id="toStopSection" class="stop-selector" style="display:none">
  <h3>請選擇下車站</h3>
  <select id="toStop"><option value="">請先選擇上車站</option></select>
</div>
<button id="submitBtn" class="submit-btn" onclick="submitReservation()" style="display:none">送出預約</button>

<!-- 📘 預約規則 -->
<div id="ruleDialog" class="dialog" style="display:none">
  <div class="dialog-content">
    <h3>🚍 預約規則</h3>
    <ul>
      <li>同日不可預約 A1+B1 或 A2+B2 班次</li>
      <li>停駛、公休日不可預約</li>
      <li>取消請提前 1 小時以上</li>
    </ul>
    <button onclick="closeRules()" style="margin-top:10px;width:100%;padding:10px;border:none;background:#3c8050;color:white;border-radius:6px">我了解了</button>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL='https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID='86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let userData=null,existingReservations=[],selectedDate=null,selectedRoute=null,noServiceDates={};
let currentMonth=new Date().getMonth(),currentYear=new Date().getFullYear();
const routeTimes={'A1':{time:'22:00-22:30',direction:'暨大→埔里總站'},'B1':{time:'22:30-23:00',direction:'埔里總站→暨大'},'A2':{time:'23:00-23:30',direction:'暨大→埔里總站'},'B2':{time:'23:30-24:00',direction:'埔里總站→暨大'}};
const stopsOutbound=["行政大樓","中餐廳","科技學院","學人會館","中城","下城","坪頂","愛蘭橋","大成國小","中山安七街口","榮民診所","埔里酒廠","埔里總站"];
const stopsReturn=[...stopsOutbound].reverse();

/* 初始化登入 */
async function init(){
  try{
    await liff.init({liffId:"2006590746-KJodGOda"});
    if(!liff.isLoggedIn())return liff.login();
    const profile=await liff.getProfile();
    const [userCheck,reservations]=await Promise.allSettled([
      fetch(`${WORKER_URL}?mode=check&userId=${profile.userId}`).then(r=>r.json()),
      fetch(`${WORKER_URL}?mode=reservations&userId=${profile.userId}`).then(r=>r.json())
    ]);
    if(userCheck.status==='fulfilled'){
      const result=userCheck.value.data||userCheck.value;
      if(!result.registered)return location.href='register.html';
      userData=result.user;
      renderUser(userData);
    }
    if(reservations.status==='fulfilled'&&reservations.value){
      existingReservations=reservations.value.reservations||[];
      renderReservationInfo();
    }
    await loadNoServiceDates();
  }catch(e){console.error("登入錯誤",e);}
}

function renderUser(u){
  document.getElementById('userInfo').innerHTML=`<div style="font-size:18px;font-weight:bold">${u.name}</div><div>${u.studentId} | ${u.phone}</div>`;
}

/* ✅ 顯示已預約資訊 */
function renderReservationInfo(){
  const box=document.getElementById('reservationInfo');
  if(!existingReservations.length){box.style.display='none';return;}
  const r=existingReservations[0];
  box.style.display='block';
  box.innerHTML=`
    <div class="resv-card">
      <div class="resv-row">🕒 時間：${r.date.split('T')[0]}</div>
      <div class="resv-row">🚍 班次：${r.route}</div>
      <div class="resv-row">⬆ 上車：${r.fromStop}　⬇ 下車：${r.toStop}</div>
      <button class="cancel-btn" onclick="cancelReservation('${r.date}','${r.route}')">取消預約</button>
    </div>`;
}

/* ✅ 取消預約 */
async function cancelReservation(date,route){
  if(!confirm('確定要取消這筆預約嗎？'))return;
  const payload={type:'cancel',userId:userData.userId,date,route};
  const res=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const result=await res.json();
  if(result.status==='success'){
    alert('✅ 已取消預約！');
    existingReservations=[];
    renderReservationInfo();
  }else alert('❌ 取消失敗');
}

/* 📅 月曆 */
async function loadNoServiceDates(){
  const start=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-01`;
  const end=`${currentYear}-${String(currentMonth+2).padStart(2,'0')}-01`;
  const res=await fetch(`${WORKER_URL}?mode=calendar&start=${start}&end=${end}&calendarId=${CALENDAR_ID}`);
  const data=await res.json();
  noServiceDates={};
  if(data.events){
    data.events.forEach(e=>{
      if(e.title.includes('停駛')||e.title.includes('公休')){
        noServiceDates[e.date]=true;
      }
    });
  }
  loadCalendar();
}
function toggleCalendar(){
  const c=document.getElementById('calendarContainer');
  const b=document.getElementById('calendarBtn');
  if(c.style.display==='none'){loadNoServiceDates();c.style.display='block';b.textContent='📅 關閉月曆';}
  else{c.style.display='none';b.textContent='📅 打開月曆';}
}
function loadCalendar(){
  const cal=document.getElementById('calendar');
  cal.innerHTML='';
  const l=new Date(currentYear,currentMonth+1,0);
  document.getElementById('calendarTitle').textContent=`${currentYear}年${currentMonth+1}月`;
  const today=formatDate(new Date());
  for(let d=1;d<=l.getDate();d++){
    const dateStr=formatDate(new Date(currentYear,currentMonth,d));
    const div=document.createElement('div');
    div.className='calendar-day';
    if(new Date(dateStr)<new Date(today))div.classList.add('past');
    else if(noServiceDates[dateStr]){div.classList.add('disabled');div.textContent=`${d} 🚫`;div.title='停駛/公休';}
    else{div.textContent=d;div.onclick=()=>selectDate(dateStr);}
    cal.appendChild(div);
  }
}
function changeMonth(delta){currentMonth+=delta;if(currentMonth<0){currentMonth=11;currentYear--;}if(currentMonth>11){currentMonth=0;currentYear++;}loadNoServiceDates();}
function formatDate(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}

window.addEventListener('load',init);
</script>
</body>
</html>
