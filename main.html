<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šé ç´„ Pangolin Shuttle Reservation</title>
<style>
body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; line-height:1.3; }
header span.en { display:block; font-size:14px; color:#fff; }

.btn-dual { display:flex; justify-content:space-between; gap:10px; margin:10px 16px; }
.dual-btn { flex:1; text-align:center; background:#3c8050; color:#fff; border:none; border-radius:8px; padding:10px 0; font-weight:bold; cursor:pointer; font-size:16px; line-height:1.3; }
.dual-btn span.en { display:block; font-size:13px; color:#fff; }

.user-section { background:white; margin:16px; padding:16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.user-name { font-size:20px; font-weight:bold; color:#333; margin-bottom:5px; }
.user-info { font-size:14px; color:#666; }

/* ğŸ“… Calendar */
.calendar-day { background:#fff; border:1px solid #ddd; padding:8px; border-radius:6px; text-align:center; cursor:pointer; font-weight:bold; transition:all 0.2s; }
.calendar-day:hover { background:#e9f5ec; }
.calendar-day.selected { background:#3c8050; color:#fff; }
.calendar-day.disabled { background:#eee; color:#999; border:1px solid #ccc; cursor:not-allowed; opacity:0.7; }

/* âœ… Route Buttons */
.route-btn { background:#fff; border:2px solid #3c8050; border-radius:10px; padding:16px 10px; text-align:center; font-weight:bold; cursor:pointer; transition:all 0.3s; box-shadow:0 2px 5px rgba(0,0,0,0.05); color:#000; }
.route-btn:hover { background:#f0faf2; }
.route-btn.selected { background:#3c8050; color:#fff; border:2px solid #3c8050; box-shadow:0 3px 8px rgba(60,128,80,0.3); }
.route-btn.selected span { color:#fff !important; }
.route-btn span.time { display:block; font-size:15px; color:#3c8050; }
.route-btn span.cn { display:block; color:#333; font-size:15px; margin-top:3px; }
.route-btn span.en { display:block; color:#0056b3; font-size:13px; }

/* ğŸ”¹ Stop Selectors */
.select-label { font-weight:bold; color:#333; margin-top:25px; line-height:1.3; font-size:16px; }
.select-label span.en { display:block; color:#0056b3; font-size:13px; }
select { width:100%; padding:14px; margin-top:8px; border:2px solid #3c8050; border-radius:10px; font-size:16px; background:#fff; color:#333; }
select:focus { outline:none; border-color:#0056b3; box-shadow:0 0 5px rgba(0,86,179,0.3); }

/* ğŸ”¹ Submit Button */
.submit-btn { background:#3c8050; color:white; border:none; padding:15px; border-radius:8px; font-size:17px; font-weight:bold; cursor:pointer; margin:25px 16px; width:calc(100% - 32px); }
.submit-btn span.en { display:block; color:#fff; font-size:13px; }

/* ğŸ”¹ Reservation Card */
.reservation-bubble { background:#fff; border:1px solid #ccc; border-radius:10px; margin:10px 16px; box-shadow:0 2px 5px rgba(0,0,0,0.08); overflow:hidden; }
.bubble-header { background:#27ACB2; color:#fff; font-weight:bold; padding:10px; text-align:center; font-size:16px; line-height:1.3; }
.bubble-header span.en { display:block; font-size:13px; color:#fff; }
.bubble-body { padding:12px; font-size:15px; line-height:1.5; color:#333; }
.bubble-body span.en { display:block; color:#0056b3; font-size:13px; margin-bottom:4px; }
.bubble-footer { padding:10px; text-align:center; background:#f8f8f8; }
.cancel-btn-small { background:#d32f2f; color:white; border:none; border-radius:8px; padding:12px 25px; cursor:pointer; font-weight:bold; font-size:15px; width:85%; }
.cancel-btn-small span.en { display:block; color:#fff; font-size:13px; }
</style>
</head>

<body>
<header>
  ç©¿å±±ç”²å°ˆè»Šé ç´„
  <span class="en">Pangolin Shuttle Bus Reservation</span>
</header>

<div id="userInfo" class="user-section">â³ ç³»çµ±åˆå§‹åŒ–ä¸­...</div>

<div class="btn-dual">
  <button class="dual-btn" onclick="toggleCalendar()">ğŸ“… æ‰“é–‹æœˆæ›†<span class="en">Open Calendar</span></button>
  <button class="dual-btn" onclick="alertRules()">ğŸ“˜ é ç´„è¦å‰‡<span class="en">Reservation Rules</span></button>
</div>

<div id="calendarContainer" style="display:none; padding:0 16px;">
  <h3 id="calendarTitle"></h3>
  <div id="calendar" style="display:grid; grid-template-columns:repeat(7,1fr); gap:4px;"></div>
</div>

<div id="selectedDate" style="margin:10px 16px; color:#2e7d32; display:none;"></div>
<div id="routeButtons" style="display:none; grid-template-columns:1fr 1fr; gap:12px; padding:0 16px;"></div>

<div id="stopSection" style="display:none; padding:0 16px;">
  <label class="select-label">ä¸Šè»Šåœ°é»<span class="en">Pick-up Stop</span></label>
  <select id="fromStop"></select>

  <label class="select-label">ä¸‹è»Šåœ°é»<span class="en">Drop-off Stop</span></label>
  <select id="toStop"></select>
</div>

<button id="submitBtn" class="submit-btn" onclick="submitReservation()" style="display:none;">
  é€å‡ºé ç´„<span class="en">Submit Reservation</span>
</button>

<div id="currentReservationCard" style="display:none;"></div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL='https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID='86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
const GOOGLE_API_KEY='YOUR_GOOGLE_API_KEY_HERE';
let RULES=null,userData=null,existingReservations=[],selectedDate=null,selectedRoute=null;
let blockedDates=new Set();

async function loadRules(){
  try{
    const res=await fetch('rule.html',{cache:'no-store'});
    const txt=await res.text();
    const clean=txt.trim().startsWith('<')?txt.match(/\{[\\s\\S]*\\}/)?.[0]||'{}':txt;
    RULES=JSON.parse(clean);
  }catch(e){RULES={seatLimit:7,maxPerDay:1,advanceMinutes:30,stopList:[],availableRoutes:[]};}
}

async function fetchCalendarBlockedDates(){
  try{
    const now=new Date(),next=new Date();next.setMonth(now.getMonth()+1);
    const url=`https://www.googleapis.com/calendar/v3/calendars/${CALENDAR_ID}/events?key=${GOOGLE_API_KEY}&timeMin=${now.toISOString()}&timeMax=${next.toISOString()}&singleEvents=true&orderBy=startTime`;
    const r=await fetch(url);const d=await r.json();
    blockedDates.clear();
    (d.items||[]).forEach(e=>{
      const t=e.summary||'';
      if(t.includes('å…¬ä¼‘')||t.includes('åœé§›')){
        const day=e.start.date||e.start.dateTime.split('T')[0];
        blockedDates.add(day);
      }
    });
  }catch(e){console.error('âŒ ç„¡æ³•è¼‰å…¥æ—¥æ›†å°é–',e);}
}

async function init(){
  await loadRules();
  await fetchCalendarBlockedDates();
  try{
    await liff.init({liffId:'2006590746-KJodGOda'});
    if(!liff.isLoggedIn())return liff.login();
    const p=await liff.getProfile();
    const [chk,resv]=await Promise.all([
      fetch(`${WORKER_URL}?check=${p.userId}`).then(r=>r.json()),
      fetch(`${WORKER_URL}?mode=reservations&userId=${p.userId}`).then(r=>r.json())
    ]);
    if(!chk.registered)return location.href='register.html';
    userData=chk.user;existingReservations=resv.reservations||[];
    document.getElementById('userInfo').innerHTML=`<div class="user-name">${userData.name}</div><div class="user-info">${userData.department} | ${userData.studentId}</div>`;
    renderReservations();
  }catch(e){document.getElementById('userInfo').innerText='âŒ åˆå§‹åŒ–å¤±æ•—';}
}

function toggleCalendar(){
  const c=document.getElementById('calendarContainer');
  c.style.display=c.style.display==='none'?'block':'none';
  renderCalendar();
}

function renderCalendar(){
  const cal=document.getElementById('calendar');
  const now=new Date(),y=now.getFullYear(),m=now.getMonth();
  const f=new Date(y,m,1),l=new Date(y,m+1,0);
  let html='';for(let i=0;i<f.getDay();i++)html+='<div></div>';
  for(let d=1;d<=l.getDate();d++){
    const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isPast=new Date(ds)<new Date(now.toDateString());
    const hasReserved=existingReservations.some(r=>r.date===ds);
    const isBlocked=blockedDates.has(ds);
    let cls='calendar-day',disabled=false;
    if(isPast||hasReserved||isBlocked){cls+=' disabled';disabled=true;}
    html+=`<div class="${cls}" ${disabled?'':`onclick="selectDate('${ds}')"`}>${d}${isBlocked?'<br><small style="color:#d32f2f;">åœé§›</small>':''}</div>`;
  }
  cal.innerHTML=html;
}

// ...ï¼ˆä»¥ä¸‹ä¿ç•™åŸ routeã€submitã€cancelã€renderReservationsï¼‰...
window.addEventListener('load',init);
</script>
</body>
</html>
