<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç©¿å±±ç”²å°ˆè»Šé ç´„ Pangolin Shuttle Reservation</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
    header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; line-height:1.3; }
    .en-text { display:block; font-size:14px; color:#ffffff; margin-top:2px; }
    .en-text-dark { display:block; font-size:14px; color:#666666; margin-top:2px; }
    button { cursor:pointer; }
  </style>
</head>
<body>
  <header>
    ç©¿å±±ç”²å°ˆè»Šé ç´„
    <span class="en-text">Pangolin Shuttle Reservation</span>
  </header>

  <div id="userInfo" style="padding:20px; text-align:center;">
    â³ ç³»çµ±åˆå§‹åŒ–ä¸­...<br><span class="en-text-dark">System initializing...</span>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
  const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';

  let RESERVATION_RULES = {
    seatLimit: 7,
    maxPerDay: 1,
    dailyDeadline: '19:00',
    maxDaysAhead: 7
  };

  // âœ… å®‰å…¨å¼·åŒ–ç‰ˆ fetch
  async function robustFetch(url, options = {}, retries = 3) {
    for (let i = 0; i < retries; i++) {
      try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const contentType = res.headers.get('content-type') || '';
        if (contentType.includes('application/json')) return await res.json();
        console.warn('âš ï¸ é JSON å›æ‡‰');
        return { status: 'error', message: 'é JSON å›æ‡‰' };
      } catch (err) {
        console.warn(`ç¬¬ ${i + 1} æ¬¡è«‹æ±‚å¤±æ•—: ${err.message}`);
        if (i === retries - 1) return { status: 'error', message: err.message };
        await new Promise(r => setTimeout(r, 1000 * (i + 1)));
      }
    }
  }

  // âœ… è¦å‰‡è¼‰å…¥ï¼ˆ404 ä¸ä¸­æ–·ï¼‰
  async function loadRules() {
    try {
      const response = await fetch('rules.json');
      if (!response.ok) throw new Error('è¦å‰‡æª”æ¡ˆè¼‰å…¥å¤±æ•—');
      const json = await response.json();
      RESERVATION_RULES = { ...RESERVATION_RULES, ...json };
      console.log('âœ… è¦å‰‡è¼‰å…¥æˆåŠŸ');
    } catch (err) {
      console.warn('âš ï¸ è¦å‰‡è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼:', err.message);
    }
  }

  // âœ… åˆå§‹åŒ–ä¸»æµç¨‹ï¼ˆåŠ å¼·å®¹éŒ¯ï¼‰
  async function init() {
    const userDiv = document.getElementById('userInfo');
    try {
      console.log('ğŸš€ ç³»çµ±åˆå§‹åŒ–é–‹å§‹');

      await loadRules();

      if (typeof liff === 'undefined') throw new Error('LIFF SDK æœªåŠ è¼‰');
      await liff.init({ liffId: "2006590746-KJodGOda" });

      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      console.log('ğŸ‘¤ LIFF ç”¨æˆ¶:', profile);

      const checkRes = await robustFetch(`${WORKER_URL}?mode=check&userId=${profile.userId}`);
      console.log('ğŸ” Worker å›æ‡‰:', checkRes);

      let userData;
      if (!checkRes || checkRes.status === 'error' || !checkRes.user) {
        console.warn('âš ï¸ Worker ç„¡æ³•å›å‚³ç”¨æˆ¶è³‡æ–™ï¼Œä½¿ç”¨é è¨­');
        userData = {
          userId: profile.userId || 'local-test-user',
          name: profile.displayName || 'æ¸¬è©¦ç”¨æˆ¶',
          studentId: '000000',
          department: 'è³‡è¨Šç®¡ç†å­¸ç³»',
          phone: '0912345678'
        };
      } else {
        userData = checkRes.user;
      }

      userDiv.innerHTML = `
        <div style="font-size:18px; font-weight:bold;">${userData.name}</div>
        <div style="font-size:14px; color:#666;">
          ${userData.department || 'æœªçŸ¥ç§‘ç³»'}ï½œ${userData.studentId || 'æœªçŸ¥å­¸è™Ÿ'}
        </div>
        <div style="margin-top:8px; color:#3c8050;">âœ… ç³»çµ±åˆå§‹åŒ–å®Œæˆ</div>
      `;
      console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
      console.error('ğŸ’¥ åˆå§‹åŒ–éŒ¯èª¤:', error);
      userDiv.innerHTML = `
        <div style="color:red;">
          <p>âŒ ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼ˆå¯é‡è©¦ï¼‰</p>
          <p>${error.message}</p>
          <button onclick="init()" style="background:#3c8050;color:white;padding:10px 16px;border:none;border-radius:6px;">é‡æ–°å˜—è©¦åˆå§‹åŒ–</button>
          <br><br>
          <button onclick="location.href='register.html'" style="background:#ff9800;color:white;padding:10px 16px;border:none;border-radius:6px;">é‡æ–°è¨»å†Š</button>
        </div>
      `;
    }
  }

  window.addEventListener('load', init);
  </script>
</body>
</html>
