<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>穿山甲專車預約</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
    header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; }
    .card { background:#fff; margin:16px; border-radius:8px; padding:16px; box-shadow:0 0 5px rgba(0,0,0,0.1); }

    /* 按鈕 */
    input, select { width:100%; padding:10px; margin-top:8px; border-radius:6px; border:1px solid #ccc; font-size:16px; }
    button { width:100%; background:#3c8050; color:#fff; border:none; padding:12px; border-radius:6px; font-size:18px; font-weight:bold; margin-top:12px; cursor:pointer; position: relative; }
    button:disabled { background:#aaa; cursor:not-allowed; }
    button.loading { background:#2d6140; color: transparent; }
    button.loading::after {
      content: ''; position: absolute; width: 20px; height: 20px; top: 50%; left: 50%;
      margin: -10px 0 0 -10px; border: 2px solid #ffffff; border-radius: 50%;
      border-top-color: transparent; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* 提示 */
    .notice { padding:10px; margin-top:10px; border-radius:6px; }
    .notice.error { background:#fdecea; color:#b71c1c; border:1px solid #f5c2c7; }
    .notice.success { background:#e8f5e9; color:#2e7d32; border:1px solid #81c784; }

    /* 月曆 */
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap:3px; text-align:center; font-size:13px; }
    .calendar-header { padding:6px 0; font-weight:bold; background:#f0f0f0; border-radius:3px; font-size:12px; }
    .calendar-day { padding:4px 0; border-radius:4px; background:#fff; border:1px solid #e0e0e0; cursor:pointer; min-height:30px; display:flex; flex-direction:column; justify-content:center; }
    .calendar-day:hover { background:#e8f5e9; }
    .calendar-day.no-service { background:#ffe6e6; color:#999; cursor:not-allowed; }
    .calendar-day.selected { background:#3c8050; color:#fff; font-weight:bold; }
    .calendar-day.other-month { color:#ccc; }
    .calendar-day.today { border:2px solid #3c8050; }
    .calendar-day small { font-size:9px; }

    /* 班次按鈕 */
    #routeButtons { display:flex; flex-wrap:wrap; gap:4px; justify-content:space-between; margin: 0 -2px; }
    .route-btn { flex: 0 0 calc(45% - 4px); margin: 0 1px; padding: 4px 2px; border-radius:6px; text-align:left; border:1px solid #ddd; font-size:12px; cursor:pointer; transition:0.2s; min-height:80px; display:flex; align-items:center; background:#fff; color:#000; box-sizing: border-box; }
    .route-btn.A1, .route-btn.B1 { border-color:#4caf50; }
    .route-btn.A2, .route-btn.B2 { border-color:#4285f4; }
    .route-btn.full { background:#f5f5f5; color:#999; border-color:#ccc; cursor:not-allowed; }
    .route-btn.selected { color:#fff !important; }
    .route-btn.selected.A1, .route-btn.selected.B1 { background:#2e7d32; border-color:#2e7d32; }
    .route-btn.selected.A2, .route-btn.selected.B2 { background:#1a73e8; border-color:#1a73e8; }
    .route-content { display: flex; flex-direction: column; gap: 2px; width: 90%; padding: 0 2px; }
    .route-time { font-weight: bold; font-size: 14px; line-height: 1.2; }
    .route-direction { font-size: 14px; line-height: 1.2; margin: 1px 0; }
    .route-seats { font-size: 14px; color: #666; line-height: 1.2; }
    .route-btn.selected .route-time, .route-btn.selected .route-direction, .route-btn.selected .route-seats { color: #fff !important; }

    .route-section { display: none; }
    .loading-state { text-align: center; padding: 20px; color: #666; }

    /* 預約卡片 */
    .reservation-card { background: #fff; border-radius: 8px; padding: 0; margin: 8px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; overflow: hidden; }
    .reservation-header { background: #3c8050; color: white; padding: 12px 15px; font-weight: bold; font-size: 16px; }
    .reservation-body { padding: 15px; }
    .reservation-detail { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #555; }
    .reservation-detail-label { font-weight: bold; min-width: 60px; }
    .reservation-detail-value { flex: 1; text-align: right; }
    .reservation-footer { padding: 10px 15px 15px; text-align: center; }
    .cancel-btn { background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 14px; cursor: pointer; min-width: 100px; }
    .cancel-btn:hover { background: #d32f2f; }
    .cancel-btn:disabled { background: #ccc; cursor: not-allowed; }
    .status-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 8px; }
    .status-active { background: #e8f5e9; color: #2e7d32; }
    .status-cancelled { background: #ffebee; color: #c62828; }
  </style>
</head>
<body>
  <header>🚌 穿山甲專車預約</header>

  <div class="card">
    <div id="userInfo" style="margin-bottom:15px;line-height:1.5;color:#2e7d32;font-weight:bold;">
      <div class="loading-state">⏳ 系統初始化中...</div>
    </div>

    <div id="existingReservations" style="margin-bottom:20px; display:none;">
      <h3 style="margin:0 0 10px 0; color:#2e7d32;">📋 我的預約記錄</h3>
      <div id="reservationsList"></div>
    </div>

    <label><center>選擇搭乘日期</center></label>
    <button id="calendarBtn" onclick="toggleCalendar()" disabled>📅 載入中...</button>

    <div id="result" style="margin-top:10px;"></div>

    <div id="currentReservationCard" style="display:none;">
      <div class="reservationCardContent"></div>
    </div>

    <div id="calendarContainer" style="display:none;margin-top:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <button onclick="changeMonth(-1)" style="width:auto; padding:5px 10px;">◀ 上個月</button>
        <h3 id="calendarTitle" style="margin:0; font-size:16px;"></h3>
        <button onclick="changeMonth(1)" style="width:auto; padding:5px 10px;">下個月 ▶</button>
      </div>
      <div id="calendar" class="calendar"></div>
    </div>
    <div id="selectedDate" class="notice success" style="display:none;"></div>
    <div id="holidayNotice" class="notice error" style="display:none;"></div>

    <div id="routeSection" class="route-section">
      <label>請選擇搭乘班次 *</label>
      <div id="routeButtons"></div>
      <label>下車站 *</label>
      <select id="toStop"><option value="">請先選擇班次</option></select>
      <button id="submitBtn" onclick="submitForm()">送出預約</button>
    </div>
  </div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let selectedDate = null, selectedRoute = null;
let userData = null, noServiceDates = {};
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let existingReservations = [];

const stopsOutbound = ["行政大樓","中餐廳","科技學院","學人會館","中城","下城","坪頂","愛蘭橋","大成國小","中山安七街口","榮民診所","埔里酒廠","埔里總站"];
const stopsReturn = [...stopsOutbound].reverse();

const routeTimes = {
  'A1': { time: '22:00-22:30', direction: '暨大→埔里總站' },
  'B1': { time: '22:30-23:00', direction: '埔里總站→暨大' },
  'A2': { time: '23:00-23:30', direction: '暨大→埔里總站' },
  'B2': { time: '23:30-24:00', direction: '埔里總站→暨大' }
};

// === 載入現有預約 ===
async function loadExistingReservations() {
  try {
    console.log('載入現有預約...');
    const res = await fetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`);
    const result = await res.json();

    if (result.success && result.reservations) {
      existingReservations = result.reservations;
      console.log('現有預約:', existingReservations);
      renderCurrentReservationCard();
      renderExistingReservations();
    } else {
      console.log('沒有現有預約');
      document.getElementById('currentReservationCard').style.display = 'none';
    }
  } catch (error) {
    console.error('載入預約失敗:', error);
  }
}

// === 顯示當前預約卡片 ===
function renderCurrentReservationCard() {
  const container = document.querySelector('.reservationCardContent');
  const section = document.getElementById('currentReservationCard');

  if (existingReservations.length === 0) {
    section.style.display = 'none';
    return;
  }

  const today = formatDateToLocal(new Date());
  const activeReservations = existingReservations
    .filter(reservation => reservation.date >= today && reservation.status !== 'cancelled')
    .sort((a, b) => a.date.localeCompare(b.date));
  
  if (activeReservations.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  container.innerHTML = '';
  
  // 只顯示最近的預約
  const latestReservation = activeReservations[0];
  
  const card = document.createElement('div');
  card.className = 'reservation-card';
  
  // 解析路線資訊
  const routeParts = latestReservation.routeName ? latestReservation.routeName.split('|') : [latestReservation.route, ''];
  const routeCode = routeParts[0].trim();
  const timeAndDirection = routeParts[1] ? routeParts[1].trim() : '';
  
  const status = latestReservation.status === 'cancelled' ? '已取消' : '預約成功';
  const statusClass = latestReservation.status === 'cancelled' ? 'status-cancelled' : 'status-active';
  
  card.innerHTML = `
    <div class="reservation-header">
      🚌 穿山甲專車新預約
      <span class="status-badge ${statusClass}">${status}</span>
    </div>
    <div class="reservation-body">
      <div class="reservation-detail">
        <span class="reservation-detail-label">日期：</span>
        <span class="reservation-detail-value">${latestReservation.date}</span>
      </div>
      <div class="reservation-detail">
        <span class="reservation-detail-label">班次：</span>
        <span class="reservation-detail-value">${routeCode} | ${timeAndDirection}</span>
      </div>
      <div class="reservation-detail">
        <span class="reservation-detail-label">姓名：</span>
        <span class="reservation-detail-value">${latestReservation.name}</span>
      </div>
      <div class="reservation-detail">
        <span class="reservation-detail-label">電話：</span>
        <span class="reservation-detail-value">${latestReservation.phone || ''}</span>
      </div>
      <div class="reservation-detail">
        <span class="reservation-detail-label">上車：</span>
        <span class="reservation-detail-value">${latestReservation.fromStop}</span>
      </div>
      <div class="reservation-detail">
        <span class="reservation-detail-label">下車：</span>
        <span class="reservation-detail-value">${latestReservation.toStop}</span>
      </div>
    </div>
    <div class="reservation-footer">
      ${latestReservation.status !== 'cancelled' ? 
        `<button class="cancel-btn" onclick="cancelCurrentReservation('${latestReservation.id || latestReservation.reservationId}', '${latestReservation.date}', '${latestReservation.route}')">取消預約</button>` : 
        '<button class="cancel-btn" disabled>已取消</button>'
      }
    </div>
  `;
  
  container.appendChild(card);
}

// === 取消當前預約 ===
async function cancelCurrentReservation(reservationId, date, route) {
  if (!confirm('確定要取消這個預約嗎？')) {
    return;
  }

  try {
    const data = {
      type: 'cancel',
      reservationId: reservationId,
      userId: userData.userId,
      date: date,
      route: route
    };

    console.log('取消預約資料:', data);

    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });

    const result = await res.json();

    if(result.status === 'success'){
      // 更新本地預約狀態
      const reservation = existingReservations.find(r => 
        (r.id === reservationId || r.reservationId === reservationId)
      );
      if (reservation) {
        reservation.status = 'cancelled';
      }
      
      await loadExistingReservations();
      document.getElementById('result').innerHTML = 
        `<div class="notice success">✅ 已成功取消預約</div>`;
      setTimeout(() => {
        document.getElementById('result').innerHTML = '';
      }, 3000);
    } else {
      document.getElementById('result').innerHTML =
        `<div class="notice error">❌ 取消預約失敗：${result.message || '請稍後再試'}</div>`;
    }
  } catch (error) {
    console.error('取消預約錯誤:', error);
    document.getElementById('result').innerHTML =
      `<div class="notice error">❌ 取消預約失敗，請檢查網路連線</div>`;
  }
}

// === 顯示歷史預約記錄 ===
function renderExistingReservations() {
  const container = document.getElementById('reservationsList');
  const section = document.getElementById('existingReservations');

  if (existingReservations.length === 0) {
    section.style.display = 'none';
    return;
  }

  const today = formatDateToLocal(new Date());
  const futureReservations = existingReservations
    .filter(reservation => reservation.date >= today)
    .sort((a, b) => a.date.localeCompare(b.date));
  
  if (futureReservations.length <= 1) { // 只有當前預約或沒有預約時隱藏歷史記錄
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  container.innerHTML = '';
  
  // 跳過第一個（當前預約），顯示其他預約
  futureReservations.slice(1).forEach(reservation => {
    const card = document.createElement('div');
    card.className = 'reservation-card';
    
    const routeParts = reservation.routeName ? reservation.routeName.split('|') : [reservation.route, ''];
    const routeCode = routeParts[0].trim();
    const timeAndDirection = routeParts[1] ? routeParts[1].trim() : '';
    
    const status = reservation.status === 'cancelled' ? '已取消' : '預約成功';
    const statusClass = reservation.status === 'cancelled' ? 'status-cancelled' : 'status-active';
    
    card.innerHTML = `
      <div class="reservation-header">
        🚌 穿山甲專車預約
        <span class="status-badge ${statusClass}">${status}</span>
      </div>
      <div class="reservation-body">
        <div class="reservation-detail">
          <span class="reservation-detail-label">日期：</span>
          <span class="reservation-detail-value">${reservation.date}</span>
        </div>
        <div class="reservation-detail">
          <span class="reservation-detail-label">班次：</span>
          <span class="reservation-detail-value">${routeCode} | ${timeAndDirection}</span>
        </div>
        <div class="reservation-detail">
          <span class="reservation-detail-label">上車：</span>
          <span class="reservation-detail-value">${reservation.fromStop}</span>
        </div>
        <div class="reservation-detail">
          <span class="reservation-detail-label">下車：</span>
          <span class="reservation-detail-value">${reservation.toStop}</span>
        </div>
      </div>
      <div class="reservation-footer">
        ${reservation.status !== 'cancelled' ? 
          `<button class="cancel-btn" onclick="cancelReservation('${reservation.id || reservation.reservationId}', '${reservation.date}', '${reservation.route}')">取消預約</button>` : 
          '<button class="cancel-btn" disabled>已取消</button>'
        }
      </div>
    `;
    
    container.appendChild(card);
  });
}

// === 取消預約（歷史記錄用）===
async function cancelReservation(reservationId, date, route) {
  if (!confirm('確定要取消這個預約嗎？')) {
    return;
  }

  try {
    const data = {
      type: 'cancel',
      reservationId: reservationId,
      userId: userData.userId,
      date: date,
      route: route
    };

    console.log('取消預約資料:', data);

    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });

    const result = await res.json();

    if(result.status === 'success'){
      await loadExistingReservations();
      document.getElementById('result').innerHTML = 
        `<div class="notice success">✅ 已成功取消預約</div>`;
      setTimeout(() => {
        document.getElementById('result').innerHTML = '';
      }, 3000);
    } else {
      document.getElementById('result').innerHTML =
        `<div class="notice error">❌ 取消預約失敗：${result.message || '請稍後再試'}</div>`;
    }
  } catch (error) {
    console.error('取消預約錯誤:', error);
    document.getElementById('result').innerHTML =
      `<div class="notice error">❌ 取消預約失敗，請檢查網路連線</div>`;
  }
}

// 🧭 初始化
async function init() {
  try {
    await liff.init({ liffId: "2006590746-KJodGOda" });
    if (!liff.isLoggedIn()) return liff.login();
    const profile = await liff.getProfile();
    const res = await fetch(`${WORKER_URL}?check=${profile.userId}`);
    const result = await res.json();
    if (!result.registered) return window.location.href = 'register.html';
    userData = result.user;
    document.getElementById('userInfo').innerHTML = `👤 ${userData.name}<br>🏫 ${userData.department}｜${userData.studentId}`;
    await loadExistingReservations();
  } catch (e) {
    console.error('❌ 初始化失敗:', e);
    userData = { userId: 'offline', name: '測試使用者', department: '測試學系', studentId: '00000000', phone: '0900000000' };
    document.getElementById('userInfo').innerHTML = `👤 ${userData.name}<br>🏫 ${userData.department}｜${userData.studentId}<br><small>離線模式</small>`;
  } finally {
    await loadNoServiceDates();
    document.getElementById('calendarBtn').disabled = false;
    document.getElementById('calendarBtn').textContent = '📅 打開月曆';
  }
}
window.addEventListener('load', init);

// 🗓 載入停駛
async function loadNoServiceDates() {
  try {
    const start = formatDateToLocal(new Date(currentYear, currentMonth - 1, 1));
    const end = formatDateToLocal(new Date(currentYear, currentMonth + 2, 0));
    const res = await fetch(`${WORKER_URL}?mode=calendar&start=${start}&end=${end}&calendarId=${encodeURIComponent(CALENDAR_ID)}`);
    const result = await res.json();
    noServiceDates = {};
    if (Array.isArray(result.holidays)) result.holidays.forEach(d => noServiceDates[d.substring(0,10)] = true);
  } catch (e) {
    console.error('🚨 載入停駛日期失敗:', e);
    noServiceDates = {};
  }
}

// 📅 月曆
async function toggleCalendar() {
  const c = document.getElementById('calendarContainer');
  if (c.style.display === 'none') { 
    await renderCalendar(); 
    c.style.display = 'block'; 
    document.getElementById('calendarBtn').textContent = '📅 關閉月曆';
  } else { 
    c.style.display = 'none';
    document.getElementById('calendarBtn').textContent = '📅 打開月曆';
  }
}

async function changeMonth(d) {
  currentMonth += d;
  if (currentMonth < 0) { currentMonth = 11; currentYear--; }
  else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  await loadNoServiceDates(); 
  await renderCalendar();
}

async function renderCalendar() {
  const cal = document.getElementById('calendar');
  const title = document.getElementById('calendarTitle');
  const monthNames = ['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'];
  title.textContent = `${currentYear}年 ${monthNames[currentMonth]}`;
  
  // 先顯示載入中
  cal.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;">載入中...</div>';
  
  // 給瀏覽器一點時間顯示載入狀態
  await new Promise(resolve => setTimeout(resolve, 10));
  
  cal.innerHTML = '';

  ['日','一','二','三','四','五','六'].forEach(d=>{
    const h=document.createElement('div');h.className='calendar-header';h.textContent=d;cal.appendChild(h);
  });

  const today = new Date();
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const startWeekday = firstDay.getDay();
  const totalDays = lastDay.getDate();

  const prevLast = new Date(currentYear, currentMonth, 0).getDate();
  for (let i=startWeekday-1;i>=0;i--){
    const e=document.createElement('div');
    e.className='calendar-day other-month';
    e.textContent=prevLast - i;
    cal.appendChild(e);
  }

  for (let d=1; d<=totalDays; d++){
    const date = new Date(currentYear, currentMonth, d);
    const f = formatDateToLocal(date);
    const e=document.createElement('div');
    e.className='calendar-day';
    const todayStr=formatDateToLocal(today);
    if(f===todayStr) e.classList.add('today');
    const isPast=date<today && f!==todayStr;
    const isNo=noServiceDates[f];
    if(isNo||isPast){
      e.classList.add('no-service');
      e.innerHTML=`${d}<br><small>${isNo?'停駛':'已過期'}</small>`;
    } else {
      e.textContent=d;
      e.onclick=()=>selectDate(f);
    }
    if(selectedDate===f) e.classList.add('selected');
    cal.appendChild(e);
  }

  const remain=42-(startWeekday+totalDays);
  for(let d=1;d<=remain;d++){
    const e=document.createElement('div');
    e.className='calendar-day other-month';
    e.textContent=d;
    cal.appendChild(e);
  }
}

function formatDateToLocal(date){
  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

async function selectDate(date){
  if(noServiceDates[date]){
    document.getElementById('holidayNotice').style.display='block';
    document.getElementById('holidayNotice').innerText=`🚫 ${date} 為停駛日`;
    document.getElementById('selectedDate').style.display='none';
    selectedDate=null;
    document.getElementById('routeSection').style.display='none';
    return;
  }
  selectedDate=date;
  document.getElementById('calendarContainer').style.display='none';
  document.getElementById('selectedDate').innerHTML=`✅ 已選擇日期：${date}`;
  document.getElementById('selectedDate').style.display='block';
  document.getElementById('holidayNotice').style.display='none';
  document.getElementById('routeSection').style.display='block';
  document.getElementById('calendarBtn').textContent = '📅 打開月曆';
  loadSeatStatus();
}

// 🚏 班次選擇
function loadSeatStatus(){
  const c=document.getElementById('routeButtons'); c.innerHTML='';
  ['A1','B1','A2','B2'].forEach(rid=>{
    const info=routeTimes[rid];
    const div=document.createElement('div');
    div.className=`route-btn ${rid}`;
    div.innerHTML=`<div class="route-content">
      <div class="route-time">${rid} ${info.time}</div>
      <div class="route-direction">${info.direction}</div>
      <div class="route-seats">剩餘:6位</div>
    </div>`;
    div.onclick=()=>selectRoute(div,rid,info.direction);
    c.appendChild(div);
  });
}

function selectRoute(btn,id,direction){
  selectedRoute=id;
  document.querySelectorAll('.route-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  updateStops(direction);
}

function updateStops(direction){
  const toStop=document.getElementById('toStop');
  toStop.innerHTML='<option value="">請選擇下車站</option>';
  const isOut=direction.includes('暨大→');
  const stops=isOut?stopsOutbound:stopsReturn;
  const from=isOut?'行政大樓':'埔里總站';
  stops.filter(s=>s!==from).forEach(s=>{
    const o=document.createElement('option');o.value=s;o.textContent=s;toStop.appendChild(o);
  });
}

// 📝 送出預約
async function submitForm(){
  const toStop=document.getElementById('toStop').value;
  const btn=document.getElementById('submitBtn');
  if(!selectedDate||!selectedRoute||!toStop){alert('請完整選擇日期、班次與下車站');return;}
  btn.disabled=true;btn.classList.add('loading');
  try{
    const info=routeTimes[selectedRoute];
    const data={
      type:'reserve',userId:userData.userId,name:userData.name,studentId:userData.studentId,
      department:userData.department,phone:userData.phone||'',
      route:selectedRoute,routeName:`${selectedRoute}|${info.time} ${info.direction}`,
      fromStop:selectedRoute.includes('A')?'行政大樓':'埔里總站',toStop:toStop,date:selectedDate
    };
    const res=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    const result=await res.json();
    if(result.status==='success'){
      document.getElementById('result').innerHTML=`<div class="notice success">✅ 預約成功<br>${selectedDate}｜${selectedRoute} ${info.time}<br>${info.direction}</div>`;
      selectedDate=null;selectedRoute=null;
      document.getElementById('selectedDate').style.display='none';
      document.getElementById('routeSection').style.display='none';
      document.getElementById('toStop').innerHTML='<option value="">請先選擇班次</option>';
      await loadExistingReservations();
    }else{
      document.getElementById('result').innerHTML=`<div class="notice error">❌ 預約失敗：${result.message||'請稍後再試'}</div>`;
    }
  }catch(e){
    console.error('預約錯誤:',e);
    document.getElementById('result').innerHTML=`<div class="notice error">❌ 預約失敗，請檢查網路</div>`;
  }finally{
    btn.disabled=false;btn.classList.remove('loading');
  }
}
</script>
</body>
</html>
