<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç©¿å±±ç”²å°ˆè»Šé ç´„</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
    header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; }
    #calendarBtn { 
      width:calc(100% - 32px); background:#3c8050; color:#fff; border:none; 
      padding:12px; border-radius:6px; font-size:16px; font-weight:bold; 
      margin:10px 16px; cursor:pointer; position: relative;
    }
    .loading-dots {
      display: inline-block;
      margin-left: 5px;
    }
    .loading-dots::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px;
      text-align: center;
      font-size: 13px;
      margin-bottom: 20px;
    }
    .calendar-header {
      padding: 8px 0;
      font-weight: bold;
      background: #27ACB2;
      border-radius: 3px;
      font-size: 12px;
    }
    .calendar-day {
      padding: 8px 0;
      min-height: 35px;
      border-radius: 4px;
      background: #fff;
      border: 1px solid #e0e0e0;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: background 0.2s;
    }
    .calendar-day:hover { background:#eaf5ea; }
    .calendar-day.disabled { 
      background:#f8f9fa; 
      color:#999; 
      cursor:not-allowed; 
    }
    .calendar-day.past { 
      background:#f5f5f5; 
      color:#ccc; 
      cursor:not-allowed; 
    }
    .calendar-day.selected { background:#3c8050; color:#fff; font-weight:bold; }
    .calendar-day.other-month { color:#ccc; }
    .carousel-container { padding: 16px; margin: 20px 0; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin: 20px 16px; }
    .carousel-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; text-align: center; }
    .carousel { display: flex; overflow-x: auto; gap: 15px; padding: 10px 5px; scrollbar-width: none; -ms-overflow-style: none; }
    .carousel::-webkit-scrollbar { display: none; }
    .reservation-bubble { 
  min-width: 190px;  /* æ¸›å°‘ä¸‰åˆ†ä¹‹ä¸€ï¼ŒåŸæœ¬ 280px */
  background: white; 
  border-radius: 12px; 
  box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
  border: 1px solid #e0e0e0; 
  overflow: hidden; 
  flex-shrink: 0; 
}

.bubble-body { 
  padding: 15px; 
}

.bubble-line { 
  margin-bottom: 8px; 
  font-size: 13px; 
  line-height: 1.4; 
  display: flex; 
  justify-content: flex-start;  /* æ”¹ç‚ºé å·¦å°é½Š */
  text-align: left;  /* ç¢ºä¿æ–‡å­—é å·¦ */
}

.bubble-line strong { 
  color: #666; 
  min-width: 50px;  /* ç¨å¾®æ¸›å°‘æ¨™é¡Œå¯¬åº¦ */
  margin-right: 8px;  /* æ·»åŠ å³é‚Šè· */
}

.bubble-line span { 
  color: #333; 
  text-align: left;  /* æ”¹ç‚ºé å·¦å°é½Š */
  flex: 1; 
}
    .bubble-header { background: #27ACB2; color: white; padding: 12px 15px; font-weight: bold; font-size: 14px; text-align: center; }
    .bubble-body { padding: 15px; }
    .bubble-line { margin-bottom: 8px; font-size: 13px; line-height: 1.4; display: flex; justify-content: space-between; }
    .bubble-line:last-child { margin-bottom: 0; }
    .bubble-line strong { color: #666; min-width: 60px; }
    .bubble-line span { color: #333; text-align: right; flex: 1; }
    .route-time { font-weight: bold; color: #333; }
    .bubble-footer { padding: 12px; border-top: 1px solid #f0f0f0; text-align: center; background: #fafafa; }
    .cancel-btn-small { background: #ff4444; color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; padding: 8px 16px; font-weight: bold; transition: background 0.2s; }
    .cancel-btn-small:hover { background: #cc0000; }
    .no-reservation { text-align: center; color: #666; padding: 40px 20px; background: white; border-radius: 8px; margin: 20px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .route-section { padding: 0 16px; margin: 20px 0; }
    .route-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
    .route-btn { padding: 12px; border: 2px solid #3c8050; border-radius: 8px; background: white; cursor: pointer; text-align: center; transition: all 0.2s; }
    .route-btn:hover { background: #eaf5ea; }
    .route-btn.selected { background: #3c8050; color: white; }
    .route-btn.disabled {
      background: #f5f5f5 !important;
      border-color: #ccc !important;
      color: #999 !important;
      cursor: not-allowed !important;
    }
    .route-btn.disabled:hover { background: #f5f5f5 !important; }
    .route-direction { font-size: 12px; margin-top: 4px; }
    .stop-selector { padding: 0 16px; margin: 20px 0; }
    select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; margin-top: 8px; }
    .user-section { background: white; margin: 16px; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .user-name { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 5px; }
    .user-info { font-size: 14px; color: #666; }
    .submit-btn { background: #3c8050; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin: 20px 16px; width: calc(100% - 32px); }
    .submit-btn:hover { background: #2d6140; }
    .submit-btn:disabled { background: #ccc; cursor: not-allowed; }
    .notice { padding: 10px 16px; margin: 10px 16px; border-radius: 6px; }
    .notice.success { background: #e8f5e9; color: #2e7d32; border: 1px solid #81c784; }
    .notice.error { background: #fdecea; color: #b71c1c; border: 1px solid #f5c2c7; }
  </style>
</head>
<body>
  <header>ç©¿å±±ç”²å°ˆè»Šé ç´„</header>

  <div id="userInfo" class="user-section">
    <div class="loading-state">â³ ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
  </div>

  <button id="calendarBtn" onclick="toggleCalendar()">
    ğŸ“… æ‰“é–‹æœˆæ›†
    <span id="calendarLoading" class="loading-dots" style="display:none"></span>
  </button>

  <div id="calendarContainer" style="display:none;margin-top:10px; padding:0 16px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <button onclick="changeMonth(-1)" style="width:auto; padding:5px 10px;">â—€ ä¸Šå€‹æœˆ</button>
      <h3 id="calendarTitle" style="margin:0; font-size:16px;"></h3>
      <button onclick="changeMonth(1)" style="width:auto; padding:5px 10px;">ä¸‹å€‹æœˆ â–¶</button>
    </div>
    <div id="calendar" class="calendar"></div>
  </div>

  <div id="selectedDate" class="notice success" style="display:none;"></div>
  <div id="holidayNotice" class="notice error" style="display:none;"></div>

  <div id="routeSection" class="route-section" style="display:none;">
    <h3>è«‹é¸æ“‡æ­ä¹˜ç­æ¬¡</h3>
    <div id="routeButtons" class="route-buttons"></div>
  </div>

  <div id="stopSection" class="stop-selector" style="display:none;">
    <h3>è«‹é¸æ“‡ä¸‹è»Šç«™</h3>
    <select id="toStop">
      <option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option>
    </select>
  </div>

  <button id="submitBtn" class="submit-btn" onclick="submitReservation()" style="display:none;">é€å‡ºé ç´„</button>

  <div id="currentReservationCard" style="display:none;"></div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let selectedDate = null;
let selectedRoute = null;
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let userData = null;
let existingReservations = [];
let noServiceDates = {};
let calendarDataLoaded = false;
let calendarLoading = false;

const stopsOutbound = ["è¡Œæ”¿å¤§æ¨“","ä¸­é¤å»³","ç§‘æŠ€å­¸é™¢","å­¸äººæœƒé¤¨","ä¸­åŸ","ä¸‹åŸ","åªé ‚","æ„›è˜­æ©‹","å¤§æˆåœ‹å°","ä¸­å±±å®‰ä¸ƒè¡—å£","æ¦®æ°‘è¨ºæ‰€","åŸ”é‡Œé…’å» ","åŸ”é‡Œç¸½ç«™"];
const stopsReturn = [...stopsOutbound].reverse();

const routeTimes = {
  'A1': { time: '22:00-22:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™' },
  'B1': { time: '22:30-23:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§' },
  'A2': { time: '23:00-23:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™' },
  'B2': { time: '23:30-24:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§' }
};

// === é ç´„è¦å‰‡ ===
const RESERVATION_RULES = {
  MAX_DAYS_AHEAD: 7,
  MAX_CAPACITY_PER_ROUTE: 7,
  DAILY_DEADLINE: '19:00',
  MAX_RESERVATIONS_PER_DAY: 1
};

async function init() {
  try {
    console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ– LIFF...');
    
    if (typeof liff === 'undefined') {
      console.error('âŒ LIFF SDK æœªåŠ è¼‰');
      document.getElementById('userInfo').innerHTML = `
        <div style="color: red; text-align: center;">
          <p>âŒ ç³»çµ±åŠ è¼‰å¤±æ•—</p>
          <p>è«‹åœ¨ LINE App ä¸­æ‰“é–‹æ­¤é é¢</p>
        </div>
      `;
      return;
    }
    
    await liff.init({ liffId: "2006590746-KJodGOda" });
    console.log('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ');
    
    if (!liff.isLoggedIn()) {
      console.log('ğŸ” ç”¨æˆ¶æœªç™»éŒ„ï¼ŒåŸ·è¡Œç™»éŒ„...');
      liff.login();
      return;
    }
    
    console.log('ğŸ‘¤ ç²å–ç”¨æˆ¶ä¿¡æ¯...');
    const profile = await liff.getProfile();
    console.log('ç”¨æˆ¶ä¿¡æ¯:', profile);
    
    // ğŸ”¥ ä¸¦è¡Œè™•ç†ï¼šåŒæ™‚é€²è¡Œç”¨æˆ¶é©—è­‰å’Œè¼‰å…¥é ç´„
    console.log('âš¡ é–‹å§‹ä¸¦è¡Œè¼‰å…¥ç”¨æˆ¶è³‡æ–™å’Œé ç´„è¨˜éŒ„...');
    
    const [userCheckResult, reservationsResult] = await Promise.all([
      // ç”¨æˆ¶èº«ä»½é©—è­‰
      fetch(`${WORKER_URL}?check=${profile.userId}`).then(r => r.json()),
      // é ç´„è¨˜éŒ„æŸ¥è©¢
      fetch(`${WORKER_URL}?mode=reservations&userId=${profile.userId}`).then(r => r.json())
    ]);
    
    console.log('âœ… ä¸¦è¡Œè¼‰å…¥å®Œæˆ');
    
    if (!userCheckResult.registered) {
      console.log('ğŸ“ ç”¨æˆ¶æœªè¨»å†Šï¼Œè·³è½‰åˆ°è¨»å†Šé é¢');
      location.href = 'register.html';
      return;
    }
    
    userData = userCheckResult.user;
    existingReservations = reservationsResult.reservations || [];
    
    // æ›´æ–°ç”¨æˆ¶ä¿¡æ¯é¡¯ç¤º
    document.getElementById('userInfo').innerHTML = `
      <div class="user-name">${userData.name}</div>
      <div class="user-info">${userData.department} | ${userData.studentId}</div>
    `;
    
    // ç›´æ¥æ¸²æŸ“é ç´„å¡ç‰‡ï¼ˆè³‡æ–™å·²ç¶“è¼‰å…¥å®Œæˆï¼‰
    renderCurrentReservationCard();
    
    // èƒŒæ™¯é è¼‰æœˆæ›†è³‡æ–™ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
    preloadCalendarData().then(() => {
      console.log('ğŸ“… æœˆæ›†è³‡æ–™èƒŒæ™¯é è¼‰å®Œæˆ');
    });
    
    console.log('ğŸ‰ ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
    
  } catch (error) {
    console.error('ğŸ’¥ åˆå§‹åŒ–éŒ¯èª¤:', error);
    document.getElementById('userInfo').innerHTML = `
      <div style="color: red; text-align: center;">
        <p>âŒ ç³»çµ±åˆå§‹åŒ–å¤±æ•—</p>
        <p>éŒ¯èª¤: ${error.message}</p>
        <button onclick="location.reload()" style="padding: 10px; margin: 10px;">é‡æ–°åŠ è¼‰</button>
      </div>
    `;
  }
}

async function preloadCalendarData() {
  if (calendarDataLoaded || calendarLoading) return;
  
  calendarLoading = true;
  console.log('ğŸ“… é–‹å§‹é è¼‰æœˆæ›†è³‡æ–™...');
  
  try {
    await loadNoServiceDates();
    calendarDataLoaded = true;
    calendarLoading = false;
    console.log('âœ… æœˆæ›†è³‡æ–™é è¼‰å®Œæˆ');
  } catch (error) {
    calendarLoading = false;
    console.error('âŒ æœˆæ›†è³‡æ–™é è¼‰å¤±æ•—:', error);
  }
}

async function toggleCalendar() {
  const container = document.getElementById('calendarContainer');
  const btn = document.getElementById('calendarBtn');
  const loadingSpan = document.getElementById('calendarLoading');

  if (container.style.display === 'none') {
    loadingSpan.style.display = 'inline-block';
    btn.disabled = true;
    
    if (!calendarDataLoaded && !calendarLoading) {
      await preloadCalendarData();
    } else if (calendarLoading) {
      let waitCount = 0;
      while (calendarLoading && waitCount < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        waitCount++;
      }
    }
    
    renderCalendar();
    
    loadingSpan.style.display = 'none';
    btn.disabled = false;
    container.style.display = 'block';
    btn.textContent = 'ğŸ“… é—œé–‰æœˆæ›†';
    container.scrollIntoView({ behavior: 'smooth' });
  } else {
    container.style.display = 'none';
    btn.textContent = 'ğŸ“… æ‰“é–‹æœˆæ›†';
  }
}

async function loadNoServiceDates() {
  try {
    const start = formatDateToLocal(new Date(currentYear, currentMonth - 1, 1));
    const end = formatDateToLocal(new Date(currentYear, currentMonth + 2, 0));
    const res = await fetch(`${WORKER_URL}?mode=calendar&start=${start}&end=${end}&calendarId=${encodeURIComponent(CALENDAR_ID)}`);
    const result = await res.json();
    noServiceDates = {};
    if (Array.isArray(result.holidays)) {
      result.holidays.forEach(d => noServiceDates[d.substring(0,10)] = true);
    }
    console.log('åœé§›æ—¥æœŸ:', noServiceDates);
  } catch (e) {
    console.error('ğŸš¨ è¼‰å…¥åœé§›æ—¥æœŸå¤±æ•—:', e);
    noServiceDates = {};
  }
}

async function changeMonth(delta) {
  currentMonth += delta;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  
  calendarDataLoaded = false;
  const loadingSpan = document.getElementById('calendarLoading');
  loadingSpan.style.display = 'inline-block';
  
  await loadNoServiceDates();
  calendarDataLoaded = true;
  
  loadingSpan.style.display = 'none';
  renderCalendar();
}

function renderCalendar() {
  const cal = document.getElementById('calendar');
  const title = document.getElementById('calendarTitle');
  
  title.textContent = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;
  
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const prevLastDay = new Date(currentYear, currentMonth, 0);
  const startWeekday = firstDay.getDay();
  const daysInMonth = lastDay.getDate();
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  let html = '';
  ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(d => {
    html += `<div class="calendar-header">${d}</div>`;
  });
  
  for (let i = startWeekday - 1; i >= 0; i--) {
    const day = prevLastDay.getDate() - i;
    html += `<div class="calendar-day other-month">${day}</div>`;
  }
  
  for (let day = 1; day <= daysInMonth; day++) {
    const dateObj = new Date(currentYear, currentMonth, day);
    const dateStr = formatDateToLocal(dateObj);
    
    // ä½¿ç”¨é ç´„è¦å‰‡é©—è­‰æ—¥æœŸç‹€æ…‹
    const isPast = ReservationValidator.isPastDate(dateStr);
    const isNoService = ReservationValidator.isNoServiceDate(dateStr);
    const isAfterDeadline = ReservationValidator.isAfterDeadline(dateStr);
    const isWithinWindow = ReservationValidator.isWithinBookingWindow(dateStr);
    const hasReservation = userData ? ReservationValidator.hasExistingReservation(userData.userId, dateStr) : false;
    
    let classes = 'calendar-day';
    let disabled = false;
    let disabledReason = '';

    // æª¢æŸ¥æ—¥æœŸç‹€æ…‹ - å„ªå…ˆé¡¯ç¤ºå·²å®Œæˆé ç´„
    if (hasReservation) {
      disabled = true;
      disabledReason = 'æ‚¨å·²é ç´„';  // æ”¹ç‚º"æ‚¨å·²é ç´„"
      classes += ' disabled';
      html += `<div class="${classes}" style="background: #e0e8ff; border: 1px solid #b3c6ff; color: #333;">${day}<br><small>${disabledReason}</small></div>`;
    } else if (isPast) {
      disabled = true;
      disabledReason = 'å·²éæœŸ';
      classes += ' past';
      html += `<div class="${classes}">${day}<br><small>${disabledReason}</small></div>`;
    } else if (isNoService) {
      disabled = true;
      disabledReason = 'åœé§›';
      classes += ' disabled';
      html += `<div class="${classes}" style="background: #f8f9fa; color: #999;">${day}<br><small>${disabledReason}</small></div>`;
    } else if (!isWithinWindow) {
      disabled = true;
      disabledReason = 'æœªé–‹æ”¾';
      classes += ' disabled';
      html += `<div class="${classes}" style="background: #f8f9fa; color: #999;">${day}<br><small>${disabledReason}</small></div>`;
    } else if (isAfterDeadline && ReservationValidator.isToday(dateStr)) {
      disabled = true;
      disabledReason = 'å·²æˆªæ­¢';
      classes += ' disabled';
      html += `<div class="${classes}" style="background: #f8f9fa; color: #999;">${day}<br><small>${disabledReason}</small></div>`;
    } else {
      if (selectedDate === dateStr) {
        classes += ' selected';
      }
      
      const isWeekend = dateObj.getDay() === 0 || dateObj.getDay() === 6;
      const dayLabel = isWeekend ? `${day}<br><small style="font-size:10px;">é€±æœ«</small>` : day;
      
      html += `<div class="${classes}" onclick="selectDate('${dateStr}')">${dayLabel}</div>`;
    }
  }
  
  const remainingDays = 7 - ((startWeekday + daysInMonth) % 7);
  if (remainingDays < 7) {
    for (let i = 1; i <= remainingDays; i++) {
      html += `<div class="calendar-day other-month">${i}</div>`;
    }
  }
  
  cal.innerHTML = html;
}

function selectDate(dateStr) {
  // ä½¿ç”¨é ç´„è¦å‰‡é€²è¡Œå®Œæ•´é©—è­‰
  const validation = {
    past: ReservationValidator.isPastDate(dateStr),
    noService: ReservationValidator.isNoServiceDate(dateStr),
    withinWindow: ReservationValidator.isWithinBookingWindow(dateStr),
    afterDeadline: ReservationValidator.isAfterDeadline(dateStr),
    hasReservation: ReservationValidator.hasExistingReservation(userData.userId, dateStr)
  };

  // æª¢æŸ¥æ—¥æœŸæœ‰æ•ˆæ€§
  if (validation.past) {
    showError('ğŸš« ç„¡æ³•é ç´„éå»æ—¥æœŸ');
    return;
  }

  if (validation.noService) {
    showError('ğŸš« è©²æ—¥æœŸç‚ºåœé§›æ—¥ï¼Œç„¡æ³•é ç´„');
    return;
  }

  if (!validation.withinWindow) {
    showError(`ğŸš« åªèƒ½é ç´„æœªä¾† ${RESERVATION_RULES.MAX_DAYS_AHEAD} å¤©å…§çš„ç­æ¬¡`);
    return;
  }

  if (validation.afterDeadline) {
    showError(`ğŸš« ä»Šæ—¥é ç´„å·²æˆªæ­¢ï¼ˆ${RESERVATION_RULES.DAILY_DEADLINE}ï¼‰`);
    return;
  }

  // æª¢æŸ¥æ˜¯å¦å·²æœ‰é ç´„
  if (validation.hasReservation) {
    const existingReservation = existingReservations.find(
      res => res.userId === userData.userId && 
             res.date.split('T')[0] === dateStr && 
             res.status !== 'å·²å–æ¶ˆ'
    );
    
    showError(`æ‚¨å·²åœ¨ ${dateStr} é ç´„äº† ${existingReservation?.route || ''} ç­æ¬¡ï¼Œæ¯å¤©åªèƒ½é ç´„ä¸€å€‹ç­æ¬¡`);
    return;
  }

  selectedDate = dateStr;
  
  // é‡ç½®é¸æ“‡ç‹€æ…‹
  document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
  event.target.classList.add('selected');
  
  // é¡¯ç¤ºé¸æ“‡çš„æ—¥æœŸ
  document.getElementById('selectedDate').style.display = 'block';
  document.getElementById('selectedDate').textContent = `âœ… å·²é¸æ“‡æ—¥æœŸï¼š${dateStr}`;
  document.getElementById('holidayNotice').style.display = 'none';
  
  // é—œé–‰æœˆæ›†
  document.getElementById('calendarContainer').style.display = 'none';
  document.getElementById('calendarBtn').textContent = 'ğŸ“… æ‰“é–‹æœˆæ›†';
  
  // é¡¯ç¤ºç­æ¬¡é¸æ“‡
  showRouteSelection();
}

async function showRouteSelection() {
  document.getElementById('routeSection').style.display = 'block';
  const container = document.getElementById('routeButtons');
  
  let html = '';
  for (const [id, info] of Object.entries(routeTimes)) {
    // æª¢æŸ¥ç­æ¬¡æ˜¯å¦å·²é¡æ»¿
    const currentCount = await getRouteReservationCount(selectedDate, id);
    const remainingSeats = RESERVATION_RULES.MAX_CAPACITY_PER_ROUTE - currentCount;
    const isFull = remainingSeats <= 0;
    
    const buttonClass = isFull ? 'route-btn disabled' : 'route-btn';
    const seatInfo = isFull ? 'âŒ å·²é¡æ»¿' : `âœ… å‰©é¤˜ ${remainingSeats} å¸­`;
    
    html += `
      <div class="${buttonClass}" ${isFull ? '' : `onclick="selectRoute('${id}', '${info.direction}')"`}>
        <div class="route-time">${info.time}</div>
        <div class="route-direction">${info.direction}</div>
        <div style="font-size: 11px; margin-top: 4px; color: ${isFull ? '#f44336' : '#4caf50'}">
          ${seatInfo}
        </div>
      </div>
    `;
  }
  
  container.innerHTML = html;
  document.getElementById('stopSection').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
}

// å–å¾—ç­æ¬¡é ç´„äººæ•¸çš„å‡½æ•¸
async function getRouteReservationCount(dateStr, route) {
  try {
    const res = await fetch(`${WORKER_URL}?mode=routeCapacity&date=${dateStr}&route=${route}`);
    const result = await res.json();
    return result.count || 0;
  } catch (error) {
    console.error('å–å¾—ç­æ¬¡äººæ•¸å¤±æ•—:', error);
    return 0;
  }
}

function selectRoute(routeId, direction) {
  selectedRoute = routeId;
  
  // æ›´æ–°æŒ‰éˆ•é¸æ“‡ç‹€æ…‹
  document.querySelectorAll('.route-btn').forEach(btn => btn.classList.remove('selected'));
  event.target.classList.add('selected');
  
  // é¡¯ç¤ºè»Šç«™é¸æ“‡
  showStopSelection(direction);
}

function showStopSelection(direction) {
  const stopSection = document.getElementById('stopSection');
  const toStopSelect = document.getElementById('toStop');
  
  toStopSelect.innerHTML = '<option value="">è«‹é¸æ“‡ä¸‹è»Šç«™</option>';
  
  // æ ¹æ“šæ–¹å‘æ±ºå®šè»Šç«™åˆ—è¡¨
  const isOutbound = direction.includes('æš¨å¤§â†’');
  const stops = isOutbound ? stopsOutbound : stopsReturn;
  const fromStop = isOutbound ? 'è¡Œæ”¿å¤§æ¨“' : 'åŸ”é‡Œç¸½ç«™';
  
  // éæ¿¾æ‰ä¸Šè»Šç«™
  stops.filter(stop => stop !== fromStop).forEach(stop => {
    const option = document.createElement('option');
    option.value = stop;
    option.textContent = stop;
    toStopSelect.appendChild(option);
  });
  
  stopSection.style.display = 'block';
  
  // ç•¶é¸æ“‡ä¸‹è»Šç«™æ™‚é¡¯ç¤ºé€å‡ºæŒ‰éˆ•
  toStopSelect.onchange = function() {
    if (this.value) {
      document.getElementById('submitBtn').style.display = 'block';
    } else {
      document.getElementById('submitBtn').style.display = 'none';
    }
  };
  
  stopSection.scrollIntoView({ behavior: 'smooth' });
}

async function submitReservation() {
  const toStop = document.getElementById('toStop').value;
  const submitBtn = document.getElementById('submitBtn');
  
  if (!selectedDate || !selectedRoute || !toStop) {
    alert('è«‹å®Œæ•´é¸æ“‡æ—¥æœŸã€ç­æ¬¡èˆ‡ä¸‹è»Šç«™');
    return;
  }
  
  // æœ€çµ‚é ç´„é©—è­‰
  const validation = await ReservationValidator.validateReservation(
    userData.userId, 
    selectedDate, 
    selectedRoute, 
    selectedRoute.includes('A') ? 'è¡Œæ”¿å¤§æ¨“' : 'åŸ”é‡Œç¸½ç«™', 
    toStop
  );
  
  if (!validation.isValid) {
    alert('âŒ é ç´„å¤±æ•—ï¼š\n' + validation.errors.join('\n'));
    return;
  }
  
  try {
    submitBtn.disabled = true;
    submitBtn.textContent = 'é ç´„ä¸­...';
    
    const info = routeTimes[selectedRoute];
    const fromStop = selectedRoute.includes('A') ? 'è¡Œæ”¿å¤§æ¨“' : 'åŸ”é‡Œç¸½ç«™';
    
    const data = {
      type: 'reserve',
      userId: userData.userId,
      name: userData.name,
      studentId: userData.studentId,
      department: userData.department,
      phone: userData.phone || '',
      route: selectedRoute,
      routeName: `${selectedRoute} | ${info.time} ${info.direction}`,
      fromStop: fromStop,
      toStop: toStop,
      date: selectedDate
    };
    
    // å¯«å…¥ GAS
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    
    if (result.status === 'success') {
      alert('âœ… é ç´„æˆåŠŸï¼');

      // LINE ç¾¤çµ„æ¨æ’­é€šçŸ¥ï¼ˆæ–°é ç´„ï¼‰
      try {
        const flexPayload = {
          type: "pushLine",
          flex: {
            type: "flex",
            altText: "ç©¿å±±ç”²å°ˆè»Šæ–°é ç´„é€šçŸ¥",
            contents: {
              type: "bubble",
              size: "mega",
              body: {
                type: "box",
                layout: "vertical",
                contents: [
                  {
                    type: "box",
                    layout: "vertical",
                    backgroundColor: "#3c8050",
                    paddingAll: "10px",
                    contents: [
                      {
                        type: "text",
                        text: "ğŸšŒ ç©¿å±±ç”²å°ˆè»Šæ–°é ç´„",
                        color: "#ffffff",
                        weight: "bold",
                        size: "md",
                        align: "center"
                      }
                    ]
                  },
                  {
                    type: "box",
                    layout: "vertical",
                    backgroundColor: "#ffffff",
                    paddingAll: "12px",
                    spacing: "sm",
                    contents: [
                      { type: "text", text: `æ—¥æœŸï¼š${selectedDate}`, size: "sm", color: "#333" },
                      { type: "text", text: `ç­æ¬¡ï¼š${selectedRoute}ï½œ${info.time} ${info.direction}`, size: "sm", color: "#333" },
                      { type: "text", text: `å§“åï¼š${userData.name}`, size: "sm", color: "#333" },
                      { type: "text", text: `é›»è©±ï¼š${userData.phone || "æœªå¡«"}`, size: "sm", color: "#333" },
                      { type: "text", text: `ä¸Šè»Šï¼š${fromStop}`, size: "sm", color: "#333" },
                      { type: "text", text: `ä¸‹è»Šï¼š${toStop}`, size: "sm", color: "#333" }
                    ]
                  }
                ]
              }
            }
          }
        };

        await fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(flexPayload)
        });
        console.log('âœ… ç¾¤çµ„æ¨æ’­ï¼šæ–°é ç´„é€šçŸ¥æˆåŠŸ');
      } catch (err) {
        console.error('âŒ æ¨æ’­éŒ¯èª¤:', err);
      }

      // é‡ç½®ç•«é¢
      resetReservationForm();
      await loadExistingReservations();
      
    } else {
      alert('âŒ é ç´„å¤±æ•—ï¼š' + (result.message || 'è«‹ç¨å¾Œå†è©¦'));
    }
    
  } catch (error) {
    console.error('é ç´„éŒ¯èª¤:', error);
    alert('âŒ é ç´„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'é€å‡ºé ç´„';
  }
}

function resetReservationForm() {
  selectedDate = null;
  selectedRoute = null;
  document.getElementById('selectedDate').style.display = 'none';
  document.getElementById('routeSection').style.display = 'none';
  document.getElementById('stopSection').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
  document.getElementById('calendarContainer').style.display = 'none';
  document.getElementById('calendarBtn').textContent = 'ğŸ“… æ‰“é–‹æœˆæ›†';
  renderCalendar();
}

async function cancelReservation(reservationId) {
  if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†é ç´„å—ï¼Ÿ')) return;

  try {
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type: 'cancel', id: reservationId, userId: userData.userId })
    });

    const result = await res.json();
    if (result.status === 'success') {
      alert('âœ… å·²å–æ¶ˆé ç´„');

      // LINE ç¾¤çµ„æ¨æ’­é€šçŸ¥ï¼ˆå–æ¶ˆé ç´„ï¼‰
      try {
        const canceled = existingReservations.find(r => r.id === reservationId);
        if (canceled) {
          const info = routeTimes[canceled.route] || {};
          const flexPayload = {
            type: "pushLine",
            flex: {
              type: "flex",
              altText: "ç©¿å±±ç”²å°ˆè»Šå–æ¶ˆé ç´„é€šçŸ¥",
              contents: {
                type: "bubble",
                size: "mega",
                body: {
                  type: "box",
                  layout: "vertical",
                  contents: [
                    {
                      type: "box",
                      layout: "vertical",
                      backgroundColor: "#b71c1c",
                      paddingAll: "10px",
                      contents: [
                        {
                          type: "text",
                          text: "âŒ ç©¿å±±ç”²å°ˆè»Šé ç´„å–æ¶ˆ",
                          color: "#ffffff",
                          weight: "bold",
                          size: "md",
                          align: "center"
                        }
                      ]
                    },
                    {
                      type: "box",
                      layout: "vertical",
                      backgroundColor: "#ffffff",
                      paddingAll: "12px",
                      spacing: "sm",
                      contents: [
                        { type: "text", text: `æ—¥æœŸï¼š${canceled.date.split('T')[0]}`, size: "sm", color: "#333" },
                        { type: "text", text: `ç­æ¬¡ï¼š${canceled.route}ï½œ${info.time || ""} ${info.direction || ""}`, size: "sm", color: "#333" },
                        { type: "text", text: `å§“åï¼š${canceled.name}`, size: "sm", color: "#333" },
                        { type: "text", text: `ä¸Šè»Šï¼š${canceled.fromStop}`, size: "sm", color: "#333" },
                        { type: "text", text: `ä¸‹è»Šï¼š${canceled.toStop}`, size: "sm", color: "#333" }
                      ]
                    }
                  ]
                }
              }
            }
          };

          await fetch(WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(flexPayload)
          });
          console.log('ğŸš« ç¾¤çµ„æ¨æ’­ï¼šå–æ¶ˆé ç´„é€šçŸ¥æˆåŠŸ');
        }
      } catch (pushErr) {
        console.error('âŒ å–æ¶ˆæ¨æ’­éŒ¯èª¤:', pushErr);
      }

      await loadExistingReservations();
    } else {
      alert('âŒ å–æ¶ˆå¤±æ•—ï¼š' + (result.message || 'è«‹ç¨å¾Œå†è©¦'));
    }
  } catch (e) {
    console.error('å–æ¶ˆé ç´„éŒ¯èª¤', e);
    alert('âŒ å–æ¶ˆé ç´„æ™‚ç™¼ç”ŸéŒ¯èª¤');
  }
}

// === è¼‰å…¥é ç´„ ===
async function loadExistingReservations() {
  try {
    const res = await fetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`);
    const result = await res.json();
    existingReservations = result.reservations || [];
    renderCurrentReservationCard();
  } catch (e) {
    console.error('è¼‰å…¥é ç´„å¤±æ•—', e);
    existingReservations = [];
    renderCurrentReservationCard();
  }
}

function renderCurrentReservationCard() {
  const container = document.getElementById('currentReservationCard');
  
  if (!existingReservations || existingReservations.length === 0) {
    container.innerHTML = '<div class="no-reservation">ç›®å‰æ²’æœ‰é ç´„ç´€éŒ„</div>';
    container.style.display = 'block';
    return;
  }
  
  let html = '<div class="carousel-container">';
  html += '<div class="carousel-title">ğŸ§¾ æˆ‘çš„é ç´„</div>';
  html += '<div class="carousel">';
  
  existingReservations.forEach(r => {
    const routeInfo = routeTimes[r.route] || { time: r.route, direction: 'æœªçŸ¥è·¯ç·š' };
    html += `
      <div class="reservation-bubble">
        <div class="bubble-header">${r.date} (${getDayOfWeek(r.date)})</div>
        <div class="bubble-body">
          <div class="bubble-line">
            <strong>ç­æ¬¡</strong>
            <span class="route-time">${routeInfo.time}</span>
          </div>
          <div class="bubble-line">
            <strong>è·¯ç·š</strong>
            <span>${routeInfo.direction}</span>
          </div>
          <div class="bubble-line">
            <strong>ä¸‹è»Šç«™</strong>
            <span>${r.toStop}</span>
          </div>
        </div>
        <div class="bubble-footer">
          <button class="cancel-btn-small" onclick="cancelReservation('${r.id}')">å–æ¶ˆé ç´„</button>
        </div>
      </div>
    `;
  });
  
  html += '</div></div>';
  container.innerHTML = html;
  container.style.display = 'block';
}

function getDayOfWeek(dateStr) {
  const d = new Date(dateStr);
  const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  return 'é€±' + weekdays[d.getDay()];
}

function formatDateToLocal(date) {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
}

// === é ç´„è¦å‰‡é©—è­‰å‡½æ•¸ ===
class ReservationValidator {
  // R4: éå»æ—¥æœŸæª¢æŸ¥
  static isPastDate(dateStr) {
    const selected = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return selected < today;
  }

  // R5: åœé§›æ—¥æª¢æŸ¥
  static isNoServiceDate(dateStr) {
    return noServiceDates[dateStr] === true;
  }

  // R7: é ç´„æˆªæ­¢æ™‚é–“æª¢æŸ¥
  static isAfterDeadline(dateStr) {
    const today = new Date();
    const selected = new Date(dateStr);
    
    // å¦‚æœæ˜¯ä»Šå¤©ï¼Œæª¢æŸ¥æ˜¯å¦è¶…é19:00
    if (this.isToday(dateStr)) {
      const now = new Date();
      const [deadlineHour, deadlineMinute] = RESERVATION_RULES.DAILY_DEADLINE.split(':');
      const deadline = new Date();
      deadline.setHours(parseInt(deadlineHour), parseInt(deadlineMinute), 0, 0);
      return now > deadline;
    }
    return false;
  }

  // R13: æœªä¾†å¤©æ•¸é™åˆ¶
  static isWithinBookingWindow(dateStr) {
    const selected = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const maxDate = new Date();
    maxDate.setDate(today.getDate() + RESERVATION_RULES.MAX_DAYS_AHEAD);
    maxDate.setHours(23, 59, 59, 999);
    
    return selected >= today && selected <= maxDate;
  }

  // è¼”åŠ©å‡½æ•¸ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºä»Šå¤©
  static isToday(dateStr) {
    const today = formatDateToLocal(new Date());
    return dateStr === today;
  }

  // æ–¹æ¡ˆBæ ¸å¿ƒï¼šé‡è¤‡é ç´„æª¢æŸ¥ - æ¯å¤©åªèƒ½æœ‰1ç­†é ç´„
  static hasExistingReservation(userId, dateStr) {
    const userReservations = existingReservations.filter(
      res => res.userId === userId && 
             res.date.split('T')[0] === dateStr && 
             res.status !== 'å·²å–æ¶ˆ'
    );
    return userReservations.length >= RESERVATION_RULES.MAX_RESERVATIONS_PER_DAY;
  }

  // R8: ç­æ¬¡å®¹é‡æª¢æŸ¥
  static async isRouteFull(dateStr, route) {
    try {
      const res = await fetch(`${WORKER_URL}?mode=routeCapacity&date=${dateStr}&route=${route}`);
      const result = await res.json();
      return result.count >= RESERVATION_RULES.MAX_CAPACITY_PER_ROUTE;
    } catch (error) {
      console.error('å®¹é‡æª¢æŸ¥å¤±æ•—:', error);
      return false;
    }
  }

  // R11, R12: ç«™é»é©—è­‰
  static validateStops(route, fromStop, toStop) {
    const isValidFromStop = route.includes('A') ? 
      fromStop === 'è¡Œæ”¿å¤§æ¨“' : fromStop === 'åŸ”é‡Œç¸½ç«™';
    
    const stops = route.includes('A') ? stopsOutbound : stopsReturn;
    const isValidToStop = stops.includes(toStop) && toStop !== fromStop;
    
    return isValidFromStop && isValidToStop;
  }

  // ç¶œåˆé©—è­‰å‡½æ•¸
  static async validateReservation(userId, dateStr, route, fromStop, toStop) {
    const errors = [];

    if (this.isPastDate(dateStr)) {
      errors.push('ç„¡æ³•é ç´„éå»æ—¥æœŸ');
    }

    if (this.isNoServiceDate(dateStr)) {
      errors.push('è©²æ—¥æœŸç‚ºåœé§›æ—¥ï¼Œç„¡æ³•é ç´„');
    }

    if (!this.isWithinBookingWindow(dateStr)) {
      errors.push(`åªèƒ½é ç´„æœªä¾† ${RESERVATION_RULES.MAX_DAYS_AHEAD} å¤©å…§çš„ç­æ¬¡`);
    }

    if (this.isAfterDeadline(dateStr)) {
      errors.push(`ä»Šæ—¥é ç´„å·²æˆªæ­¢ï¼ˆ${RESERVATION_RULES.DAILY_DEADLINE}ï¼‰`);
    }

    // æ–¹æ¡ˆBæ ¸å¿ƒè¦å‰‡ï¼šæ¯å¤©åªèƒ½é ç´„1å€‹ç­æ¬¡
    if (this.hasExistingReservation(userId, dateStr)) {
      errors.push('æ¯å¤©åªèƒ½é ç´„ä¸€å€‹ç­æ¬¡ï¼Œæ‚¨ç•¶å¤©å·²æœ‰é ç´„');
    }

    // æª¢æŸ¥å®¹é‡
    const isFull = await this.isRouteFull(dateStr, route);
    if (isFull) {
      errors.push('è©²ç­æ¬¡å·²é¡æ»¿');
    }

    // æª¢æŸ¥ç«™é»
    if (!this.validateStops(route, fromStop, toStop)) {
      errors.push('ç«™é»é¸æ“‡ç„¡æ•ˆ');
    }

    return {
      isValid: errors.length === 0,
      errors: errors
    };
  }
}

// éŒ¯èª¤é¡¯ç¤ºè¼”åŠ©å‡½æ•¸
function showError(message) {
  document.getElementById('holidayNotice').style.display = 'block';
  document.getElementById('holidayNotice').textContent = message;
  document.getElementById('selectedDate').style.display = 'none';
  resetSelection();
}

function resetSelection() {
  selectedDate = null;
  selectedRoute = null;
  document.getElementById('routeSection').style.display = 'none';
  document.getElementById('stopSection').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
}

window.addEventListener('load', init);
</script>
</body>
</html>
