<script>
const WORKER_URL='https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID='86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let userData=null,existingReservations=[],selectedDate=null,selectedRoute=null,noServiceDates={};
let currentMonth=new Date().getMonth(),currentYear=new Date().getFullYear();

const routeTimes={
  'A1':{time:'22:00-22:30',direction:'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™'},
  'B1':{time:'22:30-23:00',direction:'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§'},
  'A2':{time:'23:00-23:30',direction:'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™'},
  'B2':{time:'23:30-24:00',direction:'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§'}
};
const stopsOutbound=["è¡Œæ”¿å¤§æ¨“","ä¸­é¤å»³","ç§‘æŠ€å­¸é™¢","å­¸äººæœƒé¤¨","ä¸­åŸ","ä¸‹åŸ","åªé ‚","æ„›è˜­æ©‹","å¤§æˆåœ‹å°","ä¸­å±±å®‰ä¸ƒè¡—å£","æ¦®æ°‘è¨ºæ‰€","åŸ”é‡Œé…’å» ","åŸ”é‡Œç¸½ç«™"];
const stopsReturn=[...stopsOutbound].reverse();

/* ========================
   ğŸ”‘ ç™»å…¥é©—è­‰åˆå§‹åŒ–
======================== */
async function init(){
  try{
    await liff.init({liffId:"2006590746-KJodGOda"});
    if(!liff.isLoggedIn())return liff.login();
    const profile=await liff.getProfile();
    const [userCheck,reservations]=await Promise.allSettled([
      fetch(`${WORKER_URL}?mode=check&userId=${profile.userId}`).then(r=>r.json()),
      fetch(`${WORKER_URL}?mode=reservations&userId=${profile.userId}`).then(r=>r.json())
    ]);
    if(userCheck.status==='fulfilled'){
      const result=userCheck.value.data||userCheck.value;
      if(!result.registered)return location.href='register.html';
      userData=result.user;
      renderUser(userData);
    }
    if(reservations.status==='fulfilled'&&reservations.value){
      existingReservations=reservations.value.reservations||[];
      renderReservationInfo();
    }
    await loadNoServiceDates();
  }catch(e){console.error("ç™»å…¥éŒ¯èª¤",e);}
}

function renderUser(u){
  document.getElementById('userInfo').innerHTML=`<div style="font-size:18px;font-weight:bold">${u.name}</div><div>${u.studentId} | ${u.phone}</div>`;
}

/* ========================
   âœ… å·²é ç´„å¡ç‰‡
======================== */
function renderReservationInfo(){
  const box=document.getElementById('reservationInfo');
  if(!existingReservations.length){box.style.display='none';return;}
  const r=existingReservations[0];
  box.style.display='block';
  box.innerHTML=`
    <div class="resv-card">
      <div class="resv-row">ğŸ•’ æ™‚é–“ï¼š${r.date.split('T')[0]}</div>
      <div class="resv-row">ğŸš ç­æ¬¡ï¼š${r.route}</div>
      <div class="resv-row">â¬† ä¸Šè»Šï¼š${r.fromStop}ã€€â¬‡ ä¸‹è»Šï¼š${r.toStop}</div>
      <button class="cancel-btn" onclick="cancelReservation('${r.date}','${r.route}')">å–æ¶ˆé ç´„</button>
    </div>`;
}

/* ========================
   âŒ å–æ¶ˆé ç´„
======================== */
async function cancelReservation(date,route){
  if(!confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†é ç´„å—ï¼Ÿ'))return;
  const payload={type:'cancel',userId:userData.userId,date,route};
  const res=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const result=await res.json();
  if(result.status==='success'){
    alert('âœ… å·²å–æ¶ˆé ç´„ï¼');
    existingReservations=[];
    renderReservationInfo();
  }else alert('âŒ å–æ¶ˆå¤±æ•—');
}

/* ========================
   ğŸ“… æœˆæ›†èˆ‡é¸æ—¥
======================== */
async function loadNoServiceDates(){
  const start=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-01`;
  const end=`${currentYear}-${String(currentMonth+2).padStart(2,'0')}-01`;
  const res=await fetch(`${WORKER_URL}?mode=calendar&start=${start}&end=${end}&calendarId=${CALENDAR_ID}`);
  const data=await res.json();
  noServiceDates={};
  if(data.events){
    data.events.forEach(e=>{
      if(e.title.includes('åœé§›')||e.title.includes('å…¬ä¼‘')){
        noServiceDates[e.date]=true;
      }
    });
  }
  loadCalendar();
}

function toggleCalendar(){
  const c=document.getElementById('calendarContainer');
  const b=document.getElementById('calendarBtn');
  if(c.style.display==='none'){loadNoServiceDates();c.style.display='block';b.textContent='ğŸ“… é—œé–‰æœˆæ›†';}
  else{c.style.display='none';b.textContent='ğŸ“… æ‰“é–‹æœˆæ›†';}
}

function loadCalendar(){
  const cal=document.getElementById('calendar');
  cal.innerHTML='';
  const lastDay=new Date(currentYear,currentMonth+1,0);
  document.getElementById('calendarTitle').textContent=`${currentYear}å¹´${currentMonth+1}æœˆ`;
  const today=formatDate(new Date());
  for(let d=1;d<=lastDay.getDate();d++){
    const dateStr=formatDate(new Date(currentYear,currentMonth,d));
    const div=document.createElement('div');
    div.className='calendar-day';
    if(new Date(dateStr)<new Date(today))div.classList.add('past');
    else if(noServiceDates[dateStr]){div.classList.add('disabled');div.textContent=`${d} ğŸš«`;div.title='åœé§›/å…¬ä¼‘';}
    else{div.textContent=d;div.onclick=()=>selectDate(dateStr);}
    cal.appendChild(div);
  }
}
function formatDate(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
function changeMonth(delta){currentMonth+=delta;if(currentMonth<0){currentMonth=11;currentYear--;}if(currentMonth>11){currentMonth=0;currentYear++;}loadNoServiceDates();}

/* ========================
   ğŸš é ç´„æµç¨‹
======================== */
function selectDate(dateStr){
  selectedDate=dateStr;
  document.getElementById('selectedDate').style.display='block';
  document.getElementById('selectedDate').textContent=`âœ… å·²é¸æ“‡ï¼š${dateStr}`;
  showRouteSelection();
}

function showRouteSelection(){
  const s=document.getElementById('routeSection');
  const b=document.getElementById('routeButtons');
  b.innerHTML='';
  Object.entries(routeTimes).forEach(([rid,info])=>{
    const btn=document.createElement('div');
    btn.className='route-btn';
    btn.innerHTML=`${rid}<br>${info.time}<br>${info.direction}`;
    btn.onclick=()=>selectRoute(rid,info.direction,btn);
    b.appendChild(btn);
  });
  s.style.display='block';
}

function selectRoute(rid,dir,btn){
  selectedRoute=rid;
  document.querySelectorAll('.route-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  const from=document.getElementById('fromStop');
  const to=document.getElementById('toStop');
  const stops=dir.includes('æš¨å¤§â†’')?stopsOutbound:stopsReturn;
  from.innerHTML='<option value="">è«‹é¸æ“‡ä¸Šè»Šç«™</option>'+stops.map(s=>`<option value="${s}">${s}</option>`).join('');
  to.innerHTML='<option value="">è«‹é¸æ“‡ä¸‹è»Šç«™</option>';
  document.getElementById('fromStopSection').style.display='block';
  document.getElementById('toStopSection').style.display='block';
  from.onchange=function(){
    to.innerHTML='<option value="">è«‹é¸æ“‡ä¸‹è»Šç«™</option>';
    stops.filter(stop=>stop!==from.value).forEach(stop=>{
      const opt=document.createElement('option');
      opt.value=stop;opt.textContent=stop;to.appendChild(opt);
    });
    checkSubmitReady();
  };
  to.onchange=checkSubmitReady;
}

function checkSubmitReady(){
  const from=document.getElementById('fromStop').value;
  const to=document.getElementById('toStop').value;
  document.getElementById('submitBtn').style.display=(from&&to)?'block':'none';
}

/* ========================
   âœ… é ç´„é€å‡º
======================== */
async function submitReservation(){
  const from=document.getElementById('fromStop').value;
  const to=document.getElementById('toStop').value;
  if(!selectedDate||!selectedRoute||!from||!to)return alert('è«‹å®Œæ•´é¸æ“‡æ—¥æœŸã€ç­æ¬¡èˆ‡ä¸Šä¸‹è»Šç«™');

  const payload={type:'reserve',userId:userData.userId,name:userData.name,phone:userData.phone||'',department:userData.department,
    route:selectedRoute,fromStop:from,toStop:to,date:selectedDate};

  const res=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const r=await res.json();
  if(r.status==='success'){alert('âœ… é ç´„æˆåŠŸï¼');existingReservations.push(payload);renderReservationInfo();}
  else alert('âŒ é ç´„å¤±æ•—');
}

window.addEventListener('load',init);
</script>
