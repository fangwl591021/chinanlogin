<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let selectedDate = null;
let selectedRoute = null;
let userData = null;
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let noServiceDates = {}; // å„²å­˜çœŸæ­£åœé§›çš„æ—¥æœŸ
let existingReservations = []; // å„²å­˜ç¾æœ‰é ç´„

const stopsOutbound = ["è¡Œæ”¿å¤§æ¨“","ä¸­é¤å»³","ç§‘æŠ€å­¸é™¢","å­¸äººæœƒé¤¨","ä¸­åŸ","ä¸‹åŸ","åªé ‚","æ„›è˜­æ©‹","å¤§æˆåœ‹å°","ä¸­å±±å®‰ä¸ƒè¡—å£","æ¦®æ°‘è¨ºæ‰€","åŸ”é‡Œé…’å» ","åŸ”é‡Œç¸½ç«™"];
const stopsReturn = ["åŸ”é‡Œç¸½ç«™","åŸ”é‡Œé…’å» ","æ¦®æ°‘è¨ºæ‰€","ä¸­å±±å®‰ä¸ƒè¡—å£","å¤§æˆåœ‹å°","æ„›è˜­æ©‹","åªé ‚","ä¸‹åŸ","ä¸­åŸ","å­¸äººæœƒé¤¨","ç§‘æŠ€å­¸é™¢","ä¸­é¤å»³","è¡Œæ”¿å¤§æ¨“"];

// ç­æ¬¡æ™‚é–“è¨­å®š
const routeTimes = {
  'A1': { time: '22:00-22:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™' },
  'B1': { time: '22:30-23:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§' },
  'A2': { time: '23:00-23:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™' },
  'B2': { time: '23:30-24:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§' }
};

// === æ—¥æœŸå·¥å…·å‡½æ•¸ - ä¿®æ­£æ™‚å€å•é¡Œ ===
function formatDateToLocal(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function createLocalDate(year, month, day) {
  return new Date(year, month, day);
}

// === åˆå§‹åŒ– ===
async function init() {
  try {
    console.log('é–‹å§‹åˆå§‹åŒ– LIFF...');
    
    await liff.init({ 
      liffId: "2006590746-KJodGOda" 
    });
    console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');

    if (!liff.isLoggedIn()) {
      console.log('ä½¿ç”¨è€…æœªç™»å…¥ï¼Œé–‹å§‹ç™»å…¥...');
      liff.login();
      return;
    }

    console.log('ä½¿ç”¨è€…å·²ç™»å…¥ï¼Œå–å¾—ä½¿ç”¨è€…è³‡æ–™...');
    const profile = await liff.getProfile();
    console.log('å–å¾—ä½¿ç”¨è€… Profile:', profile);

    // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²è¨»å†Š
    console.log('æª¢æŸ¥ä½¿ç”¨è€…è¨»å†Šç‹€æ…‹...');
    const res = await fetch(`${WORKER_URL}?check=${profile.userId}`);
    const result = await res.json();
    console.log('è¨»å†Šæª¢æŸ¥çµæœ:', result);
    
    if (!result.registered) {
      console.log('ä½¿ç”¨è€…æœªè¨»å†Šï¼Œå°å‘è¨»å†Šé é¢');
      window.location.href = 'register.html';
      return;
    }
    
    userData = result.user;
    console.log('ä½¿ç”¨è€…è³‡æ–™:', userData);
    
    // é¡¯ç¤ºå®Œæ•´çš„ä½¿ç”¨è€…è³‡è¨Š
    document.getElementById('userInfo').innerHTML = `ğŸ‘¤ ${userData.name}<br>ğŸ« ${userData.department}ï½œ${userData.studentId}`;
    
    // å•Ÿç”¨æœˆæ›†æŒ‰éˆ•
    document.getElementById('calendarBtn').disabled = false;
    document.getElementById('calendarBtn').textContent = 'ğŸ“… æ‰“é–‹æœˆæ›†';
    
    // å…ˆè¼‰å…¥æœˆæ›†ï¼Œä¸éœ€è¦ç­‰å¾…åœé§›æ—¥æœŸ
    await renderCalendar();
    
    // éåŒæ­¥è¼‰å…¥åœé§›æ—¥æœŸå’Œé ç´„
    loadNoServiceDates().then(() => {
      console.log('åœé§›æ—¥æœŸè¼‰å…¥å®Œæˆ');
      // é‡æ–°æ¸²æŸ“æœˆæ›†ä»¥é¡¯ç¤ºåœé§›ç‹€æ…‹
      renderCalendar();
    });
    
    loadExistingReservations();
    
    console.log('ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
    
  } catch (error) {
    console.error('åˆå§‹åŒ–å¤±æ•—:', error);
    
    document.getElementById('userInfo').innerHTML = 
      '<div class="notice error">âŒ ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–ç¨å¾Œå†è©¦<br><small>éŒ¯èª¤: ' + error.message + '</small></div>';
    
    document.getElementById('calendarBtn').disabled = false;
    document.getElementById('calendarBtn').textContent = 'ğŸ“… æ‰“é–‹æœˆæ›†ï¼ˆé›¢ç·šæ¨¡å¼ï¼‰';
    
    userData = {
      userId: 'offline-user',
      name: 'æ¸¬è©¦ä½¿ç”¨è€…',
      department: 'æ¸¬è©¦å­¸ç³»',
      studentId: '00000000',
      phone: '0900000000'
    };
    
    document.getElementById('userInfo').innerHTML = `ğŸ‘¤ ${userData.name}<br>ğŸ« ${userData.department}ï½œ${userData.studentId}<br><small style="color: #666;">é›¢ç·šæ¨¡å¼</small>`;
    
    // é›¢ç·šæ¨¡å¼ä¸‹ç›´æ¥æ¸²æŸ“æœˆæ›†
    renderCalendar();
  }
}

// å•Ÿå‹•åˆå§‹åŒ–
init();

// === è¼‰å…¥ç¾æœ‰é ç´„ ===
async function loadExistingReservations() {
  try {
    console.log('è¼‰å…¥ç¾æœ‰é ç´„...');
    const res = await fetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`);
    const result = await res.json();
    
    if (result.success && result.reservations) {
      existingReservations = result.reservations;
      console.log('ç¾æœ‰é ç´„:', existingReservations);
      renderExistingReservations();
    } else {
      console.log('æ²’æœ‰ç¾æœ‰é ç´„');
    }
  } catch (error) {
    console.error('è¼‰å…¥é ç´„å¤±æ•—:', error);
  }
}

// === é¡¯ç¤ºç¾æœ‰é ç´„ ===
function renderExistingReservations() {
  const container = document.getElementById('reservationsList');
  const section = document.getElementById('existingReservations');
  
  if (existingReservations.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  container.innerHTML = '';
  
  // éæ¿¾ä¸¦æ’åºé ç´„ï¼Œåªé¡¯ç¤ºä»Šå¤©åŠæœªä¾†çš„é ç´„
  const today = formatDateToLocal(new Date());
  const futureReservations = existingReservations
    .filter(reservation => reservation.date >= today)
    .sort((a, b) => a.date.localeCompare(b.date));
  
  if (futureReservations.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  futureReservations.forEach(reservation => {
    const card = document.createElement('div');
    card.className = 'reservation-card';
    
    const routeInfo = routeTimes[reservation.route] || { 
      time: reservation.routeName || '', 
      direction: reservation.routeName ? reservation.routeName.split(' ')[1] || '' : '' 
    };
    
    // ä¿®æ­£ï¼šç¢ºä¿å–æ¶ˆæŒ‰éˆ•æ­£ç¢ºç¶å®š
    const reservationId = reservation.id || reservation.reservationId;
    
    card.innerHTML = `
      <div class="reservation-header">
        <div class="reservation-date">${reservation.date}</div>
        <div class="reservation-route">${reservation.route}ï½œ${routeInfo.direction}</div>
      </div>
      <div class="reservation-details">
        <div>â° ${routeInfo.time}</div>
        <div>ğŸ“ ${reservation.fromStop} â†’ ${reservation.toStop}</div>
        <div>ğŸ‘¤ ${reservation.name}ï½œ${reservation.studentId}</div>
      </div>
      <button class="cancel-btn" onclick="cancelReservation('${reservationId}')">å–æ¶ˆé ç´„</button>
    `;
    
    container.appendChild(card);
  });
}

// === å–æ¶ˆé ç´„ ===
async function cancelReservation(reservationId) {
  if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™å€‹é ç´„å—ï¼Ÿ')) {
    return;
  }
  
  // æ‰¾åˆ°å°æ‡‰çš„å–æ¶ˆæŒ‰éˆ•
  const buttons = document.querySelectorAll('.cancel-btn');
  let btn = null;
  buttons.forEach(button => {
    if (button.getAttribute('onclick')?.includes(reservationId)) {
      btn = button;
    }
  });
  
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'å–æ¶ˆä¸­...';
  }
  
  try {
    const data = {
      type: 'cancel',
      reservationId: reservationId,
      userId: userData.userId
    };

    console.log('ç™¼é€å–æ¶ˆé ç´„è³‡æ–™:', data);

    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    console.log('å–æ¶ˆé ç´„çµæœ:', result);
    
    if(result.status === 'success'){
      // é‡æ–°è¼‰å…¥é ç´„åˆ—è¡¨
      await loadExistingReservations();
      document.getElementById('result').innerHTML = 
        `<div class="notice success">âœ… å·²æˆåŠŸå–æ¶ˆé ç´„</div>`;
        
      // 3ç§’å¾Œæ¸…é™¤æˆåŠŸè¨Šæ¯
      setTimeout(() => {
        document.getElementById('result').innerHTML = '';
      }, 3000);
    } else {
      document.getElementById('result').innerHTML =
        `<div class="notice error">âŒ å–æ¶ˆé ç´„å¤±æ•—ï¼š${result.message || 'è«‹ç¨å¾Œå†è©¦'}</div>`;
        
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'å–æ¶ˆé ç´„';
      }
    }
  } catch (error) {
    console.error('å–æ¶ˆé ç´„éŒ¯èª¤:', error);
    document.getElementById('result').innerHTML =
      `<div class="notice error">âŒ å–æ¶ˆé ç´„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</div>`;
      
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'å–æ¶ˆé ç´„';
    }
  }
}

// === è¼‰å…¥çœŸæ­£åœé§›çš„æ—¥æœŸ ===
async function loadNoServiceDates() {
  try {
    console.log('æ­£åœ¨è¼‰å…¥åœé§›æ—¥æœŸï¼Œæ—¥æ›†ID:', CALENDAR_ID);
    
    const startDate = formatDateToLocal(new Date(currentYear, currentMonth - 1, 1));
    const endDate = formatDateToLocal(new Date(currentYear, currentMonth + 2, 0));
    
    console.log('æŸ¥è©¢æ—¥æœŸç¯„åœ:', startDate, 'åˆ°', endDate);
    
    const requestData = {
      mode: 'calendar',
      start: startDate,
      end: endDate,
      calendarId: CALENDAR_ID
    };
    
    console.log('ç™¼é€è«‹æ±‚è³‡æ–™:', requestData);
    
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestData)
    });
    
    const result = await res.json();
    
    console.log('æ—¥æ›†APIå›å‚³å®Œæ•´çµæœ:', JSON.stringify(result, null, 2));
    
    noServiceDates = {};
    
    if (result.success && result.holidays && Array.isArray(result.holidays)) {
      console.log('æ‰¾åˆ°åœé§›æ—¥æœŸæ•¸é‡:', result.holidays.length);
      result.holidays.forEach((dateObj, index) => {
        let dateStr = null;
        
        if (typeof dateObj === 'string') {
          dateStr = dateObj;
        } else if (dateObj && dateObj.date) {
          dateStr = dateObj.date;
        } else if (dateObj && dateObj.start) {
          dateStr = dateObj.start.split('T')[0];
        }
        
        if (dateStr && dateStr.length >= 10) {
          const formattedDate = dateStr.substring(0, 10);
          noServiceDates[formattedDate] = true;
          console.log(`åœé§›æ—¥æœŸ ${index + 1}:`, formattedDate);
        }
      });
      console.log('å·²è¼‰å…¥åœé§›æ—¥æœŸ:', Object.keys(noServiceDates));
    } else {
      console.warn('âš ï¸ æ²’æœ‰æ‰¾åˆ°åœé§›æ—¥æœŸè³‡æ–™æˆ–APIå›å‚³å¤±æ•—');
      noServiceDates = {};
    }
  } catch (error) {
    console.error('âŒ è¼‰å…¥åœé§›æ—¥æœŸå¤±æ•—:', error);
    noServiceDates = {};
  }
}

// === æœˆæ›†åŠŸèƒ½ ===
async function toggleCalendar() {
  const c = document.getElementById('calendarContainer');
  if (c.style.display === 'none') {
    // ç¢ºä¿æœˆæ›†å·²ç¶“æ¸²æŸ“
    if (document.getElementById('calendar').innerHTML === '') {
      await renderCalendar();
    }
    c.style.display = 'block';
    document.getElementById('calendarBtn').textContent = 'ğŸ“… é—œé–‰æœˆæ›†';
  } else {
    c.style.display = 'none';
    document.getElementById('calendarBtn').textContent = 'ğŸ“… æ‰“é–‹æœˆæ›†';
  }
}

async function changeMonth(direction) {
  currentMonth += direction;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  
  // è¼‰å…¥æ–°æœˆä»½çš„åœé§›æ—¥æœŸ
  await loadNoServiceDates();
  await renderCalendar();
}

async function renderCalendar() {
  console.log('é–‹å§‹æ¸²æŸ“æœˆæ›†:', currentYear, 'å¹´', currentMonth + 1, 'æœˆ');
  
  const cal = document.getElementById('calendar');
  const title = document.getElementById('calendarTitle');
  
  const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
  title.textContent = `${currentYear}å¹´ ${monthNames[currentMonth]}`;
  
  // é¡¯ç¤ºè¼‰ä¸­ç‹€æ…‹
  cal.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;">è¼‰å…¥ä¸­...</div>';
  
  // çµ¦ä¸€é»æ™‚é–“é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  await new Promise(resolve => setTimeout(resolve, 10));
  
  cal.innerHTML = '';
  
  const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  weekdays.forEach(day => {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-header';
    dayElement.textContent = day;
    cal.appendChild(dayElement);
  });

  const today = new Date();
  const firstDay = createLocalDate(currentYear, currentMonth, 1);
  const lastDay = createLocalDate(currentYear, currentMonth + 1, 0);
  const startWeekday = firstDay.getDay();
  const totalDays = lastDay.getDate();

  console.log('æœˆæ›†è³‡è¨Š:', {
    firstDay,
    lastDay,
    startWeekday,
    totalDays,
    noServiceDates
  });

  // ä¸Šå€‹æœˆçš„æ—¥æœŸ
  const prevMonthLastDay = createLocalDate(currentYear, currentMonth, 0).getDate();
  for (let i = startWeekday - 1; i >= 0; i--) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day other-month';
    dayElement.textContent = prevMonthLastDay - i;
    cal.appendChild(dayElement);
  }

  // é€™å€‹æœˆçš„æ—¥æœŸ
  for (let d = 1; d <= totalDays; d++) {
    const date = createLocalDate(currentYear, currentMonth, d);
    const formatted = formatDateToLocal(date);
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    
    const todayFormatted = formatDateToLocal(today);
    if (formatted === todayFormatted) {
      dayElement.classList.add('today');
    }
    
    const isPast = date < today && formatted !== todayFormatted;
    const isNoService = noServiceDates[formatted];
    
    console.log(`æ—¥æœŸ ${formatted}:`, { isPast, isNoService });
    
    if (isNoService || isPast) {
      dayElement.classList.add('no-service');
      if (isNoService) {
        dayElement.innerHTML = `${d}<br><small>åœé§›</small>`;
      } else if (isPast) {
        dayElement.innerHTML = `${d}<br><small>å·²éæœŸ</small>`;
      }
    } else {
      dayElement.textContent = d;
      dayElement.onclick = () => selectDate(formatted, d);
    }
    
    if (selectedDate === formatted) {
      dayElement.classList.add('selected');
    }
    
    cal.appendChild(dayElement);
  }

  // ä¸‹å€‹æœˆçš„æ—¥æœŸ
  const remainingCells = 42 - (startWeekday + totalDays);
  for (let d = 1; d <= remainingCells; d++) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day other-month';
    dayElement.textContent = d;
    cal.appendChild(dayElement);
  }
  
  console.log('æœˆæ›†æ¸²æŸ“å®Œæˆ');
}

async function selectDate(date, dayNumber) {
  console.log('é¸æ“‡æ—¥æœŸ:', date, 'å°æ‡‰çš„æ—¥æ›†æ•¸å­—:', dayNumber);
  
  const isNoService = noServiceDates[date];
  
  if (isNoService) {
    document.getElementById('holidayNotice').style.display = 'block';
    document.getElementById('holidayNotice').innerText = `ğŸš« ${date} ç‚ºåœé§›æ—¥ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ`;
    document.getElementById('selectedDate').style.display = 'none';
    selectedDate = null;
    
    document.getElementById('routeSection').style.display = 'none';
    return;
  }
  
  selectedDate = date;
  document.getElementById('calendarContainer').style.display = 'none';
  document.getElementById('selectedDate').innerHTML = `âœ… å·²é¸æ“‡æ—¥æœŸï¼š${date} (${currentYear}å¹´${currentMonth + 1}æœˆ${dayNumber}æ—¥)`;
  document.getElementById('selectedDate').style.display = 'block';
  document.getElementById('holidayNotice').style.display = 'none';
  document.getElementById('calendarBtn').textContent = 'ğŸ“… æ‰“é–‹æœˆæ›†';
  
  document.getElementById('routeSection').style.display = 'block';
  loadSeatStatus();
}

// === è¼‰å…¥ç­æ¬¡ç‹€æ³ ===
function loadSeatStatus() {
  const container = document.getElementById('routeButtons');
  container.innerHTML = '';
  
  const routeData = {
    A1: { remain: 6, full: false },
    B1: { remain: 6, full: false },
    A2: { remain: 6, full: false },
    B2: { remain: 6, full: false }
  };
  
  ['A1', 'B1', 'A2', 'B2'].forEach(rid => {
    const r = routeData[rid];
    const routeInfo = routeTimes[rid];
    
    const div = document.createElement('div');
    div.className = `route-btn ${rid}`;
    if (r.full) div.classList.add('full');
    
    div.innerHTML = `
      <div class="route-content">
        <div class="route-time">${rid} ${routeInfo.time}</div>
        <div class="route-direction">${routeInfo.direction}</div>
        <div class="route-seats">å‰©é¤˜:${r.remain}ä½</div>
      </div>
    `;
    
    if (!r.full) {
      div.onclick = () => selectRoute(div, rid, routeInfo.direction);
    }
    
    container.appendChild(div);
  });
}

function selectRoute(btn, id, direction) {
  selectedRoute = id;
  document.querySelectorAll('.route-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  updateStops(direction);
}

function updateStops(routeDirection) {
  const toStop = document.getElementById('toStop');
  toStop.innerHTML = '<option value="">è«‹é¸æ“‡ä¸‹è»Šç«™</option>';
  
  const isOutbound = routeDirection.includes('æš¨å¤§â†’');
  const stops = isOutbound ? stopsOutbound : stopsReturn;
  const fromStop = isOutbound ? 'è¡Œæ”¿å¤§æ¨“' : 'åŸ”é‡Œç¸½ç«™';
  
  stops.filter(s => s !== fromStop).forEach(s => {
    const o = document.createElement('option');
    o.value = s;
    o.textContent = s;
    toStop.appendChild(o);
  });
}

// === é ç´„åŠŸèƒ½ ===
async function submitForm() {
  const toStop = document.getElementById('toStop').value;
  const btn = document.getElementById('submitBtn');
  
  if (!selectedDate || !selectedRoute || !toStop) {
    alert('è«‹å®Œæ•´é¸æ“‡æ—¥æœŸã€ç­æ¬¡èˆ‡ä¸‹è»Šç«™');
    return;
  }
  
  btn.disabled = true;
  btn.classList.add('loading');

  try {
    const routeInfo = routeTimes[selectedRoute];
    // ä¿®æ­£ï¼šç¢ºä¿æ ¼å¼ç‚º (A1|22:00-22:30 æš¨å¤§->åŸ”é‡Œç¸½ç«™)
    const routeName = `(${selectedRoute}|${routeInfo.time} ${routeInfo.direction.replace('â†’', '->')})`;
    
    const data = {
      type: 'reserve',
      userId: userData.userId,
      name: userData.name,
      studentId: userData.studentId,
      department: userData.department,
      phone: userData.phone,
      route: selectedRoute,
      routeName: routeName, // ä½¿ç”¨ä¿®æ­£å¾Œçš„æ ¼å¼
      fromStop: selectedRoute.includes('A') ? 'è¡Œæ”¿å¤§æ¨“' : 'åŸ”é‡Œç¸½ç«™',
      toStop: toStop,
      date: selectedDate
    };

    console.log('ç™¼é€é ç´„è³‡æ–™:', data);

    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    
    if(result.status === 'success'){
      document.getElementById('result').innerHTML = 
        `<div class="notice success">
          âœ… é ç´„æˆåŠŸ<br>
          ${selectedDate}ï½œ${selectedRoute} ${routeInfo.time}<br>
          ${routeInfo.direction.split('â†’')[0]} â†’ ${toStop}
        </div>`;
      
      // æ¸…ç©ºé¸æ“‡
      selectedDate = null;
      selectedRoute = null;
      document.getElementById('selectedDate').style.display = 'none';
      document.getElementById('routeSection').style.display = 'none';
      document.getElementById('toStop').innerHTML = '<option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option>';
      
      // é‡æ–°è¼‰å…¥é ç´„åˆ—è¡¨
      await loadExistingReservations();
      
    } else {
      document.getElementById('result').innerHTML =
        `<div class="notice error">âŒ é ç´„å¤±æ•—ï¼š${result.message || 'è«‹ç¨å¾Œå†è©¦'}</div>`;
    }
  } catch (error) {
    document.getElementById('result').innerHTML =
      `<div class="notice error">âŒ é ç´„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</div>`;
  } finally {
    btn.disabled = false;
    btn.classList.remove('loading');
  }
}
</script>
