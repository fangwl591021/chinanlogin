<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç©¿å±±ç”²å°ˆè»Šé ç´„ Pangolin Shuttle Reservation</title>
<style>
body{font-family:system-ui,sans-serif;background:#f5f6f7;margin:0;padding:0;}
header{background:#3c8050;color:#fff;text-align:center;padding:15px;font-size:22px;font-weight:bold;line-height:1.3;}
.en-text{display:block;font-size:14px;color:#fff;margin-top:2px;}
section{max-width:480px;margin:20px auto;padding:16px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
label{display:block;margin-top:10px;font-weight:bold;}
select,input,button{width:100%;margin-top:6px;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:16px;}
button{background:#3c8050;color:#fff;border:none;margin-top:16px;cursor:pointer;}
button:hover{background:#2f6540;}
.msg{margin-top:8px;color:#666;text-align:center;font-size:14px;}
.error{color:red;}
.success{color:#2e7d32;}
</style>
</head>
<body>

<header>
  ç©¿å±±ç”²å°ˆè»Šé ç´„
  <span class="en-text">Pangolin Shuttle Reservation</span>
</header>

<section>
  <div id="userInfo" class="msg">â³ ç³»çµ±åˆå§‹åŒ–ä¸­...</div>

  <div id="bookingArea" style="display:none;">
    <label>é¸æ“‡æ—¥æœŸï¼š</label>
    <input type="date" id="reserveDate" />

    <label>é¸æ“‡ç­æ¬¡ï¼š</label>
    <select id="routeSelect"></select>

    <button id="submitBtn">é€å‡ºé ç´„</button>
    <div id="resultMsg" class="msg"></div>
  </div>
</section>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const RULES_URL  = 'https://fangwl591021.github.io/chinanlogin/rules.json';
let RESERVATION_RULES = {}; 
let userProfile = {};
let today = new Date();

// âœ… å®‰å…¨ fetch
async function robustFetch(url, options = {}, retries = 3) {
  for (let i=0;i<retries;i++) {
    try {
      const res = await fetch(url, options);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const type = res.headers.get('content-type') || '';
      return type.includes('application/json') ? await res.json() : {status:'error',message:'éJSON'};
    } catch (err) {
      console.warn(`ç¬¬${i+1}æ¬¡è«‹æ±‚å¤±æ•—: ${err.message}`);
      if (i === retries-1) return {status:'error',message:err.message};
      await new Promise(r=>setTimeout(r,1000*(i+1)));
    }
  }
}

// âœ… è¼‰å…¥è¦å‰‡ï¼ˆå¤–éƒ¨ + fallbackï¼‰
async function loadRules() {
  try {
    const res = await fetch(RULES_URL);
    if (!res.ok) throw new Error('rules.json è¼‰å…¥å¤±æ•—');
    RESERVATION_RULES = await res.json();
    console.log('âœ… æˆåŠŸè¼‰å…¥ rules.json:', RESERVATION_RULES);
  } catch (err) {
    console.warn('âš ï¸ è¦å‰‡è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨ fallback:', err.message);
    RESERVATION_RULES = {
      seatLimit:6,
      maxNoShow:3,
      banWeeks:2,
      tripMode:"single",
      maxPerDay:1,
      dailyDeadline:"19:00",
      maxDaysAhead:7,
      allowWeekend:true,
      routePolicy:"A1+B2 å¯é ç´„ï¼Œç¦æ­¢ A1+B1 æˆ– A2+B2",
      lastUpdate:"2025-10-21T03:00:00.000Z",
      updatedBy:"Tony"
    };
  }
}

// âœ… åˆå§‹åŒ–
async function init() {
  const ui = document.getElementById('userInfo');
  const area = document.getElementById('bookingArea');
  try {
    await loadRules();

    await liff.init({ liffId: "2006590746-KJodGOda" });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    const profile = await liff.getProfile();
    userProfile = profile;
    console.log('ğŸ‘¤ LIFF ç”¨æˆ¶:', profile);

    const chk = await robustFetch(`${WORKER_URL}?mode=check&userId=${profile.userId}`);
    const user = (chk && chk.user) ? chk.user : {name: profile.displayName, department:"è³‡è¨Šç®¡ç†ç³»", studentId:"000000"};
    ui.innerHTML = `<b>${user.name}</b><br>${user.department}ï½œ${user.studentId}`;
    area.style.display = "block";

    fillRoutes();
  } catch (err) {
    console.error('ğŸ’¥ åˆå§‹åŒ–éŒ¯èª¤:', err);
    ui.innerHTML = `<span class="error">åˆå§‹åŒ–å¤±æ•—ï¼š${err.message}</span><br><button onclick="init()">é‡è©¦</button>`;
  }
}

// âœ… å¡«å…¥ç­æ¬¡æ¸…å–®
function fillRoutes() {
  const routes = [
    {id:"A1", label:"A1ï½œ22:00 æš¨å¤§ â†’ åŸ”é‡Œç¸½ç«™"},
    {id:"B1", label:"B1ï½œ22:30 åŸ”é‡Œç¸½ç«™ â†’ æš¨å¤§"},
    {id:"A2", label:"A2ï½œ23:00 æš¨å¤§ â†’ åŸ”é‡Œç¸½ç«™"},
    {id:"B2", label:"B2ï½œ23:30 åŸ”é‡Œç¸½ç«™ â†’ æš¨å¤§"}
  ];
  const select = document.getElementById('routeSelect');
  routes.forEach(r=>{
    const opt = document.createElement('option');
    opt.value = r.id; opt.textContent = r.label;
    select.appendChild(opt);
  });
}

// âœ… æ ¸å¿ƒé‚è¼¯ï¼šæª¢æŸ¥ routePolicy
function checkRoutePolicy(selectedRoute, existingRoute) {
  if (!existingRoute) return true;
  const policy = RESERVATION_RULES.routePolicy || "";
  if (policy.includes("ç¦æ­¢")) {
    if ((existingRoute.startsWith('A1') && selectedRoute.startsWith('B1')) ||
        (existingRoute.startsWith('A2') && selectedRoute.startsWith('B2')) ||
        (existingRoute.startsWith('B1') && selectedRoute.startsWith('A1')) ||
        (existingRoute.startsWith('B2') && selectedRoute.startsWith('A2'))) {
      return false; // é•åç¦æ­¢æ¢ä»¶
    }
  }
  return true;
}

// âœ… é ç´„é€å‡º
document.getElementById('submitBtn').addEventListener('click', async ()=>{
  const date = document.getElementById('reserveDate').value;
  const route = document.getElementById('routeSelect').value;
  const msg = document.getElementById('resultMsg');

  if(!date){msg.innerHTML="âŒ è«‹é¸æ“‡æ—¥æœŸ";return;}
  const todayStr = new Date().toISOString().split('T')[0];
  const diffDays = (new Date(date)-new Date(todayStr))/86400000;
  if(diffDays>RESERVATION_RULES.maxDaysAhead){
    msg.innerHTML=`âŒ åªèƒ½é ç´„ ${RESERVATION_RULES.maxDaysAhead} å¤©å…§çš„ç­æ¬¡`;return;
  }

  // æ¨¡æ“¬æª¢æŸ¥ï¼šå‡è¨­å·²é ç´„ B1 â†’ ç¦æ­¢é¸ A1
  const existingRoute = window.localStorage.getItem('todayRoute') || null;
  if(!checkRoutePolicy(route, existingRoute)){
    msg.innerHTML="âš ï¸ é•åè·¯ç·šé™åˆ¶è¦å‰‡ï¼šç¦æ­¢é€£çºŒä¾†å›ï¼ˆA1+B1 / A2+B2ï¼‰";
    return;
  }

  // æ¨¡æ“¬å‘¼å« Worker
  const res = await robustFetch(`${WORKER_URL}?mode=reserve&userId=${userProfile.userId}&date=${date}&route=${route}`);
  if(res.status==='success'){
    msg.className='msg success';
    msg.innerHTML='âœ… é ç´„æˆåŠŸï¼';
    window.localStorage.setItem('todayRoute', route);
  }else{
    msg.className='msg error';
    msg.innerHTML='âŒ é ç´„å¤±æ•—ï¼š'+(res.message||'æœªçŸ¥éŒ¯èª¤');
  }
});

window.addEventListener('load', init);
</script>
</body>
</html>
