<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç©¿å±±ç”²å°ˆè»Šé ç´„</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
    header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; }
    .card { background:#fff; margin:16px; border-radius:8px; padding:16px; box-shadow:0 0 5px rgba(0,0,0,0.1); }

    /* æŒ‰éˆ• */
    input, select { width:100%; padding:10px; margin-top:8px; border-radius:6px; border:1px solid #ccc; font-size:16px; }
    button { width:100%; background:#3c8050; color:#fff; border:none; padding:12px; border-radius:6px; font-size:18px; font-weight:bold; margin-top:12px; cursor:pointer; position: relative; }
    button:disabled { background:#aaa; cursor:not-allowed; }
    button.loading { background:#2d6140; color: transparent; }
    button.loading::after {
      content: ''; position: absolute; width: 20px; height: 20px; top: 50%; left: 50%;
      margin: -10px 0 0 -10px; border: 2px solid #ffffff; border-radius: 50%;
      border-top-color: transparent; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* æç¤º */
    .notice { padding:10px; margin-top:10px; border-radius:6px; }
    .notice.error { background:#fdecea; color:#b71c1c; border:1px solid #f5c2c7; }
    .notice.success { background:#e8f5e9; color:#2e7d32; border:1px solid #81c784; }

    /* æœˆæ›† - é™ä½é«˜åº¦ */
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap:3px; text-align:center; font-size:13px; }
    .calendar-header { padding:6px 0; font-weight:bold; background:#f0f0f0; border-radius:3px; font-size:12px; }
    .calendar-day { padding:4px 0; border-radius:4px; background:#fff; border:1px solid #e0e0e0; cursor:pointer; min-height:30px; display:flex; flex-direction:column; justify-content:center; }
    .calendar-day:hover { background:#e8f5e9; }
    .calendar-day.holiday { background:#ffe6e6; color:#999; cursor:not-allowed; }
    .calendar-day.selected { background:#3c8050; color:#fff; font-weight:bold; }
    .calendar-day.other-month { color:#ccc; }
    .calendar-day.today { border:2px solid #3c8050; }
    .calendar-day small { font-size:9px; }

    /* ç­æ¬¡æŒ‰éˆ• - ä¿®æ­£å¯¬åº¦ */
    #routeButtons { 
      display:flex; 
      flex-wrap:wrap; 
      gap:4px;
      justify-content:space-between;
      margin: 0 -2px;
    }
    .route-btn {
      flex: 0 0 calc(50% - 4px);
      margin: 0 2px;
      padding: 4px 2px;
      border-radius:6px;
      text-align:left;
      border:1px solid #ddd;
      font-size:12px;
      cursor:pointer;
      transition:0.2s;
      min-height:65px;
      display:flex;
      align-items:center;
      background:#fff;
      color:#000;
      box-sizing: border-box;
    }
    
    /* æœªé¸ä¸­æ™‚çš„é‚Šæ¡†é¡è‰² */
    .route-btn.A1, .route-btn.B1 { border-color:#4caf50; }
    .route-btn.A2, .route-btn.B2 { border-color:#4285f4; }
    
    /* å·²æ»¿çš„æ¨£å¼ */
    .route-btn.full { 
      background:#f5f5f5; 
      color:#999; 
      border-color:#ccc; 
      cursor:not-allowed; 
    }
    
    /* é¸ä¸­æ™‚çš„æ¨£å¼ - å…¨éƒ¨è®Šç™½è‰²æ–‡å­— */
    .route-btn.selected { 
      color:#fff !important;
    }
    .route-btn.selected.A1, .route-btn.selected.B1 { 
      background:#2e7d32; 
      border-color:#2e7d32;
    }
    .route-btn.selected.A2, .route-btn.selected.B2 { 
      background:#1a73e8; 
      border-color:#1a73e8;
    }

    /* ç­æ¬¡å…§å®¹æ’ç‰ˆ */
    .route-content { 
      display: flex; 
      flex-direction: column; 
      gap: 2px; 
      width: 100%;
      padding: 0 2px;
    }
    .route-time { 
      font-weight: bold; 
      font-size: 12px; 
      line-height: 1.2;
    }
    .route-direction { 
      font-size: 11px; 
      line-height: 1.2;
      margin: 1px 0;
    }
    .route-seats { 
      font-size: 11px; 
      color: #666;
      line-height: 1.2;
    }

    /* é¸ä¸­æ™‚æ‰€æœ‰æ–‡å­—è®Šç™½è‰² */
    .route-btn.selected .route-time,
    .route-btn.selected .route-direction,
    .route-btn.selected .route-seats {
      color: #fff !important;
    }

    @media (max-width:480px){
      .route-btn {
        flex: 0 0 calc(50% - 4px);
        min-height:60px;
        padding:3px 2px;
      }
      .route-content {
        padding: 0 1px;
      }
      .route-time { font-size: 11px; }
      .route-direction { font-size: 10px; }
      .route-seats { font-size: 10px; }
    }

    @media (max-width:360px){
      .route-btn {
        min-height:55px;
      }
      .route-time { font-size: 10px; }
      .route-direction { font-size: 9px; }
      .route-seats { font-size: 9px; }
    }
  </style>
</head>
<body>
  <header>ğŸšŒ ç©¿å±±ç”²å°ˆè»Šé ç´„</header>

  <div class="card">
    <div id="userInfo" style="margin-bottom:15px;line-height:1.5;color:#2e7d32;font-weight:bold;">
      ğŸ‘¤ è§€å…‰ä¼‘é–’èˆ‡é¤æ—…ç®¡ç†å­¸ç³» | 114320553
    </div>

    <label><center>é¸æ“‡æ­ä¹˜æ—¥æœŸ</center></label>
    <button onclick="toggleCalendar()">ğŸ“… æ‰“é–‹æœˆæ›†</button>
    <div id="calendarContainer" style="display:none;margin-top:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <button onclick="changeMonth(-1)" style="width:auto; padding:5px 10px;">â—€ ä¸Šå€‹æœˆ</button>
        <h3 id="calendarTitle" style="margin:0; font-size:16px;"></h3>
        <button onclick="changeMonth(1)" style="width:auto; padding:5px 10px;">ä¸‹å€‹æœˆ â–¶</button>
      </div>
      <div id="calendar" class="calendar"></div>
    </div>
    <div id="selectedDate" class="notice success" style="display:none;"></div>
    <div id="holidayNotice" class="notice error" style="display:none;"></div>

    <label>è«‹é¸æ“‡æ­ä¹˜ç­æ¬¡ *</label>
    <div id="routeButtons"></div>

    <label>ä¸‹è»Šç«™ *</label>
    <select id="toStop"><option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option></select>

    <button id="submitBtn" onclick="submitForm()">é€å‡ºé ç´„</button>
    <div id="result"></div>
  </div>

<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let selectedDate = null;
let selectedRoute = null;
let userData = null;
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let holidays = {}; // å„²å­˜åœé§›æ—¥æœŸ

const stopsOutbound = ["è¡Œæ”¿å¤§æ¨“","ä¸­é¤å»³","ç§‘æŠ€å­¸é™¢","å­¸äººæœƒé¤¨","ä¸­åŸ","ä¸‹åŸ","åªé ‚","æ„›è˜­æ©‹","å¤§æˆåœ‹å°","ä¸­å±±å®‰ä¸ƒè¡—å£","æ¦®æ°‘è¨ºæ‰€","åŸ”é‡Œé…’å» ","åŸ”é‡Œç¸½ç«™"];
const stopsReturn = ["åŸ”é‡Œç¸½ç«™","åŸ”é‡Œé…’å» ","æ¦®æ°‘è¨ºæ‰€","ä¸­å±±å®‰ä¸ƒè¡—å£","å¤§æˆåœ‹å°","æ„›è˜­æ©‹","åªé ‚","ä¸‹åŸ","ä¸­åŸ","å­¸äººæœƒé¤¨","ç§‘æŠ€å­¸é™¢","ä¸­é¤å»³","è¡Œæ”¿å¤§æ¨“"];

// ç­æ¬¡æ™‚é–“è¨­å®š
const routeTimes = {
  'A1': { time: '22:00-22:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™' },
  'B1': { time: '22:30-23:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§' },
  'A2': { time: '23:00-23:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™' },
  'B2': { time: '23:30-24:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§' }
};

// === åˆå§‹åŒ– ===
(async function init(){
  // æ¨¡æ“¬ä½¿ç”¨è€…è³‡æ–™
  userData = {
    name: 'è§€å…‰ä¼‘é–’èˆ‡é¤æ—…ç®¡ç†å­¸ç³»',
    studentId: '114320553',
    userId: 'test123'
  };
  
  // è¼‰å…¥åœé§›æ—¥æœŸ
  await loadHolidays();
  
  // åˆå§‹åŒ–ç­æ¬¡é¡¯ç¤º
  loadSeatStatus();
})();

// === è¼‰å…¥åœé§›æ—¥æœŸ ===
async function loadHolidays() {
  try {
    // è¼‰å…¥ç•¶æœˆåœé§›æ—¥æœŸ
    const startDate = new Date(currentYear, currentMonth, 1).toISOString().split('T')[0];
    const endDate = new Date(currentYear, currentMonth + 1, 0).toISOString().split('T')[0];
    
    const res = await fetch(`${WORKER_URL}?mode=calendar&start=${startDate}&end=${endDate}&calendarId=${CALENDAR_ID}`);
    const result = await res.json();
    
    if (result.holidays) {
      holidays = result.holidays;
    }
  } catch (error) {
    console.error('è¼‰å…¥åœé§›æ—¥æœŸå¤±æ•—:', error);
  }
}

// === æœˆæ›†åŠŸèƒ½ ===
async function toggleCalendar() {
  const c = document.getElementById('calendarContainer');
  if (c.style.display === 'none') {
    await renderCalendar();
    c.style.display = 'block';
  } else {
    c.style.display = 'none';
  }
}

async function changeMonth(direction) {
  currentMonth += direction;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  
  // è¼‰å…¥æ–°æœˆä»½çš„åœé§›æ—¥æœŸ
  await loadHolidays();
  await renderCalendar();
}

async function renderCalendar() {
  const cal = document.getElementById('calendar');
  const title = document.getElementById('calendarTitle');
  
  // è¨­å®šæ¨™é¡Œ
  const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
  title.textContent = `${currentYear}å¹´ ${monthNames[currentMonth]}`;
  
  cal.innerHTML = '';
  
  // åŠ å…¥æ˜ŸæœŸæ¨™é¡Œ
  const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  weekdays.forEach(day => {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-header';
    dayElement.textContent = day;
    cal.appendChild(dayElement);
  });

  const today = new Date();
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const startWeekday = firstDay.getDay();
  const totalDays = lastDay.getDate();

  // ä¸Šå€‹æœˆçš„æ—¥æœŸ
  const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
  for (let i = startWeekday - 1; i >= 0; i--) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day other-month';
    dayElement.textContent = prevMonthLastDay - i;
    cal.appendChild(dayElement);
  }

  // é€™å€‹æœˆçš„æ—¥æœŸ
  for (let d = 1; d <= totalDays; d++) {
    const date = new Date(currentYear, currentMonth, d);
    const formatted = date.toISOString().split('T')[0];
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºä»Šå¤©
    if (date.toDateString() === today.toDateString()) {
      dayElement.classList.add('today');
    }
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºåœé§›æ—¥ (å¾æ—¥æ›†APIå–å¾—æˆ–é€±æœ«)
    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
    const isHoliday = holidays[formatted] || isWeekend;
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºéå»æ—¥æœŸ
    const isPast = date < today && date.toDateString() !== today.toDateString();
    
    if (isHoliday || isPast) {
      dayElement.classList.add('holiday');
      if (isHoliday) {
        dayElement.innerHTML = `${d}<br><small>åœé§›</small>`;
      } else if (isPast) {
        dayElement.innerHTML = `${d}<br><small>å·²éæœŸ</small>`;
      }
    } else {
      dayElement.textContent = d;
      dayElement.onclick = () => selectDate(formatted);
    }
    
    // æ¨™è¨˜å·²é¸æ“‡çš„æ—¥æœŸ
    if (selectedDate === formatted) {
      dayElement.classList.add('selected');
    }
    
    cal.appendChild(dayElement);
  }

  // ä¸‹å€‹æœˆçš„æ—¥æœŸ
  const remainingCells = 42 - (startWeekday + totalDays); // 6è¡Œx7åˆ—
  for (let d = 1; d <= remainingCells; d++) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day other-month';
    dayElement.textContent = d;
    cal.appendChild(dayElement);
  }
}

async function selectDate(date) {
  // æª¢æŸ¥é¸æ“‡çš„æ—¥æœŸæ˜¯å¦ç‚ºåœé§›æ—¥
  const isWeekend = new Date(date).getDay() === 0 || new Date(date).getDay() === 6;
  const isHoliday = holidays[date] || isWeekend;
  
  if (isHoliday) {
    document.getElementById('holidayNotice').style.display = 'block';
    document.getElementById('holidayNotice').innerText = `ğŸš« ${date} ç‚ºåœé§›æ—¥ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ`;
    document.getElementById('selectedDate').style.display = 'none';
    selectedDate = null;
    return;
  }
  
  selectedDate = date;
  document.getElementById('calendarContainer').style.display = 'none';
  document.getElementById('selectedDate').innerHTML = 'âœ… å·²é¸æ“‡æ—¥æœŸï¼š' + date;
  document.getElementById('selectedDate').style.display = 'block';
  document.getElementById('holidayNotice').style.display = 'none';
  
  // é‡æ–°è¼‰å…¥ç­æ¬¡ç‹€æ…‹
  loadSeatStatus();
}

// === è¼‰å…¥ç­æ¬¡ç‹€æ³ ===
function loadSeatStatus() {
  const container = document.getElementById('routeButtons');
  container.innerHTML = '';
  
  const routeData = {
    A1: { remain: 6, full: false },
    B1: { remain: 6, full: false },
    A2: { remain: 6, full: false },
    B2: { remain: 6, full: false }
  };
  
  ['A1', 'B1', 'A2', 'B2'].forEach(rid => {
    const r = routeData[rid];
    const routeInfo = routeTimes[rid];
    
    const div = document.createElement('div');
    div.className = `route-btn ${rid}`;
    if (r.full) div.classList.add('full');
    
    div.innerHTML = `
      <div class="route-content">
        <div class="route-time">${rid} ${routeInfo.time}</div>
        <div class="route-direction">${routeInfo.direction}</div>
        <div class="route-seats">å‰©é¤˜:${r.remain}ä½</div>
      </div>
    `;
    
    if (!r.full) {
      div.onclick = () => selectRoute(div, rid, routeInfo.direction);
    }
    
    container.appendChild(div);
  });
}

function selectRoute(btn, id, direction) {
  selectedRoute = id;
  document.querySelectorAll('.route-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  updateStops(direction);
}

function updateStops(routeDirection) {
  const toStop = document.getElementById('toStop');
  toStop.innerHTML = '<option value="">è«‹é¸æ“‡ä¸‹è»Šç«™</option>';
  
  const isOutbound = routeDirection.includes('æš¨å¤§â†’');
  const stops = isOutbound ? stopsOutbound : stopsReturn;
  const fromStop = isOutbound ? 'è¡Œæ”¿å¤§æ¨“' : 'åŸ”é‡Œç¸½ç«™';
  
  stops.filter(s => s !== fromStop).forEach(s => {
    const o = document.createElement('option');
    o.value = s;
    o.textContent = s;
    toStop.appendChild(o);
  });
}

// === é ç´„åŠŸèƒ½ ===
async function submitForm() {
  const toStop = document.getElementById('toStop').value;
  const btn = document.getElementById('submitBtn');
  
  if (!selectedDate || !selectedRoute || !toStop) {
    alert('è«‹å®Œæ•´é¸æ“‡æ—¥æœŸã€ç­æ¬¡èˆ‡ä¸‹è»Šç«™');
    return;
  }
  
  btn.disabled = true;
  btn.classList.add('loading');

  try {
    const routeInfo = routeTimes[selectedRoute];
    const data = {
      type: 'reserve',
      userId: userData.userId,
      name: userData.name,
      studentId: userData.studentId,
      route: selectedRoute,
      routeName: routeInfo.direction,
      fromStop: selectedRoute.includes('A') ? 'è¡Œæ”¿å¤§æ¨“' : 'åŸ”é‡Œç¸½ç«™',
      toStop: toStop,
      date: selectedDate
    };

    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    
    if(result.status === 'success'){
      document.getElementById('result').innerHTML = 
        `<div class="notice success">
          âœ… é ç´„æˆåŠŸ<br>
          ${selectedDate}ï½œ${selectedRoute} ${routeInfo.time}<br>
          ${routeInfo.direction.split('â†’')[0]} â†’ ${toStop}
        </div>`;
    } else {
      document.getElementById('result').innerHTML =
        `<div class="notice error">âŒ é ç´„å¤±æ•—ï¼š${result.message || 'è«‹ç¨å¾Œå†è©¦'}</div>`;
    }
  } catch (error) {
    document.getElementById('result').innerHTML =
      `<div class="notice error">âŒ é ç´„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</div>`;
  } finally {
    btn.disabled = false;
    btn.classList.remove('loading');
  }
}
</script>
</body>
</html>
