<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ç©¿å±±ç”²å°ˆè»Šé ç´„ ğŸš</title>

<style>
body{font-family:system-ui,sans-serif;background:#f5f6f7;margin:0;padding:0}
header{background:#3c8050;color:#fff;text-align:center;padding:15px;font-size:22px;font-weight:bold}
.notice{padding:10px 16px;margin:10px 0;border-radius:6px}
.notice.success{background:#e8f5e9;color:#2e7d32;border:1px solid #81c784}
.notice.error{background:#fdecea;color:#b71c1c;border:1px solid #f5c2c7}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;text-align:center;font-size:13px;margin-bottom:20px}
.calendar-day{padding:8px 0;min-height:45px;border-radius:4px;background:#fff;border:1px solid #e0e0e0;cursor:pointer}
.calendar-day:hover{background:#eaf5ea}
.calendar-day.past{background:#f5f5f5;color:#ccc;cursor:not-allowed}
.calendar-day.selected{background:#3c8050;color:#fff;font-weight:bold}
.calendar-day.disabled{background:#ffe6e6;color:#999;cursor:not-allowed}
.route-section,.stop-selector{padding:0 16px;margin:20px 0}
.route-buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.route-btn{padding:12px;border:2px solid #3c8050;border-radius:8px;background:white;cursor:pointer;text-align:center}
.route-btn:hover{background:#eaf5ea}
.route-btn.selected{background:#3c8050;color:white}
select{width:100%;padding:12px;border:1px solid #ccc;border-radius:6px;margin-top:8px}
.submit-btn{background:#3c8050;color:white;border:none;padding:15px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;width:calc(100% - 32px);margin:20px 16px}
.submit-btn:hover{background:#2d6140}
</style>
</head>

<body>
<header>ç©¿å±±ç”²å°ˆè»Šé ç´„</header>

<div id="userInfo" style="padding:16px"><div class="loading-state">â³ ç³»çµ±åˆå§‹åŒ–ä¸­...</div></div>
<div id="currentReservationCard" style="display:none"></div>

<button id="calendarBtn" onclick="toggleCalendar()">ğŸ“… æ‰“é–‹æœˆæ›†</button>

<div id="calendarContainer" style="display:none;margin-top:10px;padding:0 16px">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <button onclick="changeMonth(-1)">â—€ ä¸Šå€‹æœˆ</button>
    <h3 id="calendarTitle"></h3>
    <button onclick="changeMonth(1)">ä¸‹å€‹æœˆ â–¶</button>
  </div>
  <div id="calendar" class="calendar"></div>
</div>

<div id="selectedDate" class="notice success" style="display:none"></div>

<div id="routeSection" class="route-section" style="display:none">
  <h3>è«‹é¸æ“‡æ­ä¹˜ç­æ¬¡</h3>
  <div id="routeButtons" class="route-buttons"></div>
</div>

<div id="fromStopSection" class="stop-selector" style="display:none">
  <h3>è«‹é¸æ“‡ä¸Šè»Šç«™</h3>
  <select id="fromStop"><option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option></select>
</div>

<div id="toStopSection" class="stop-selector" style="display:none">
  <h3>è«‹é¸æ“‡ä¸‹è»Šç«™</h3>
  <select id="toStop"><option value="">è«‹å…ˆé¸æ“‡ä¸Šè»Šç«™</option></select>
</div>

<button id="submitBtn" class="submit-btn" onclick="submitReservation()" style="display:none">é€å‡ºé ç´„</button>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL='https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID='86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let userData=null,existingReservations=[],selectedDate=null,selectedRoute=null,noServiceDates={};
let currentMonth=new Date().getMonth(),currentYear=new Date().getFullYear();
const routeTimes={'A1':{time:'22:00-22:30',direction:'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™'},'B1':{time:'22:30-23:00',direction:'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§'},'A2':{time:'23:00-23:30',direction:'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™'},'B2':{time:'23:30-24:00',direction:'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§'}};
const stopsOutbound=["è¡Œæ”¿å¤§æ¨“","ä¸­é¤å»³","ç§‘æŠ€å­¸é™¢","å­¸äººæœƒé¤¨","ä¸­åŸ","ä¸‹åŸ","åªé ‚","æ„›è˜­æ©‹","å¤§æˆåœ‹å°","ä¸­å±±å®‰ä¸ƒè¡—å£","æ¦®æ°‘è¨ºæ‰€","åŸ”é‡Œé…’å» ","åŸ”é‡Œç¸½ç«™"];
const stopsReturn=[...stopsOutbound].reverse();

/* ======================
   ç™»å…¥é©—è­‰èˆ‡è³‡æ–™è¼‰å…¥
====================== */
async function init(){
  try{
    await liff.init({liffId:"2006590746-KJodGOda"});
    if(!liff.isLoggedIn())return liff.login();

    const profile=await liff.getProfile();
    const [userCheck,reservations]=await Promise.allSettled([
      fetch(`${WORKER_URL}?mode=check&userId=${profile.userId}`).then(r=>r.json()),
      fetch(`${WORKER_URL}?mode=reservations&userId=${profile.userId}`).then(r=>r.json())
    ]);

    if(userCheck.status==='fulfilled'){
      const result=userCheck.value.data||userCheck.value;
      if(!result.registered)return location.href='register.html';
      userData=result.user;
      renderUser(userData);
    }else{
      throw new Error('ç”¨æˆ¶é©—è­‰å¤±æ•—');
    }

    if(reservations.status==='fulfilled'&&reservations.value){
      existingReservations=reservations.value.reservations||[];
      renderCurrentReservationCard();
    }
    await loadNoServiceDates();
  }catch(e){
    console.error("ç™»å…¥éŒ¯èª¤",e);
    document.getElementById('userInfo').innerHTML=`<div class='notice error'>ç™»å…¥å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥</div>`;
  }
}

/* ======================
   é¡¯ç¤ºç”¨æˆ¶èˆ‡é ç´„ç´€éŒ„
====================== */
function renderUser(u){
  document.getElementById('userInfo').innerHTML=`<div style="font-size:18px;font-weight:bold">${u.name}</div><div>${u.department} | ${u.studentId}</div>`;
}
function renderCurrentReservationCard(){
  const box=document.getElementById('currentReservationCard');
  box.style.display='block';
  if(!existingReservations.length){
    box.innerHTML=`<div class='notice'>å°šç„¡é ç´„ç´€éŒ„</div>`;
  }else{
    const r=existingReservations[0];
    box.innerHTML=`<div class='notice success'>âœ… ${r.date} å·²é ç´„ ${r.route}</div>`;
  }
}

/* ======================
   ğŸ“… æœˆæ›†æ§åˆ¶èˆ‡åœé§›æ—¥è®€å–
====================== */
async function loadNoServiceDates(){
  try{
    const start=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-01`;
    const end=`${currentYear}-${String(currentMonth+2).padStart(2,'0')}-01`;
    const res=await fetch(`${WORKER_URL}?mode=calendar&start=${start}&end=${end}&calendarId=${CALENDAR_ID}`);
    const data=await res.json();
    noServiceDates={};

    const events = data.events || data.holidays || [];
    events.forEach(e=>{
      const title = e.title || e.summary || '';
      if(title && (title.includes('åœé§›') || title.includes('å…¬ä¼‘'))){
        noServiceDates[e.date]=true;
      }
    });

    console.log('âœ… åœé§›/å…¬ä¼‘æ—¥è¼‰å…¥å®Œæˆ:', noServiceDates);
    loadCalendar();
  }catch(err){
    console.error('ğŸš¨ è¼‰å…¥åœé§›æ—¥æœŸå¤±æ•—:', err);
    noServiceDates={};
    loadCalendar();
  }
}

function toggleCalendar(){
  const c=document.getElementById('calendarContainer');
  const b=document.getElementById('calendarBtn');
  if(c.style.display==='none'){loadNoServiceDates();c.style.display='block';b.textContent='ğŸ“… é—œé–‰æœˆæ›†';}
  else{c.style.display='none';b.textContent='ğŸ“… æ‰“é–‹æœˆæ›†';}
}

function loadCalendar(){
  const cal=document.getElementById('calendar');
  cal.innerHTML='';
  const l=new Date(currentYear,currentMonth+1,0);
  document.getElementById('calendarTitle').textContent=`${currentYear}å¹´${currentMonth+1}æœˆ`;
  const today=formatDate(new Date());
  for(let d=1;d<=l.getDate();d++){
    const dateStr=formatDate(new Date(currentYear,currentMonth,d));
    const div=document.createElement('div');
    div.className='calendar-day';
    if(new Date(dateStr)<new Date(today))div.classList.add('past');
    else if(noServiceDates[dateStr]){
      div.classList.add('disabled');
      div.textContent=`${d} ğŸš«`;
      div.title='åœé§›/å…¬ä¼‘';
    }else{
      div.textContent=d;
      div.onclick=()=>selectDate(dateStr);
    }
    cal.appendChild(div);
  }
}
function changeMonth(delta){
  currentMonth+=delta;
  if(currentMonth<0){currentMonth=11;currentYear--;}
  if(currentMonth>11){currentMonth=0;currentYear++;}
  loadNoServiceDates();
}
function formatDate(d){
  return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

/* ======================
   ğŸš é ç´„æµç¨‹
====================== */
function selectDate(dateStr){
  selectedDate=dateStr;
  document.getElementById('selectedDate').style.display='block';
  document.getElementById('selectedDate').textContent=`âœ… å·²é¸æ“‡ï¼š${dateStr}`;
  showRouteSelection();
}
function showRouteSelection(){
  const s=document.getElementById('routeSection');
  const b=document.getElementById('routeButtons');
  b.innerHTML='';
  Object.entries(routeTimes).forEach(([rid,info])=>{
    const btn=document.createElement('div');
    btn.className='route-btn';
    btn.innerHTML=`${rid}<br>${info.time}<br>${info.direction}`;
    btn.onclick=()=>selectRoute(rid,info.direction,btn);
    b.appendChild(btn);
  });
  s.style.display='block';
}
function selectRoute(rid,dir,btn){
  selectedRoute=rid;
  document.querySelectorAll('.route-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');

  const from=document.getElementById('fromStop');
  const to=document.getElementById('toStop');
  const isOutbound=dir.includes('æš¨å¤§â†’');
  const stops=isOutbound?stopsOutbound:stopsReturn;

  from.innerHTML='<option value="">è«‹é¸æ“‡ä¸Šè»Šç«™</option>'+stops.map(s=>`<option value="${s}">${s}</option>`).join('');
  to.innerHTML='<option value="">è«‹é¸æ“‡ä¸‹è»Šç«™</option>';

  document.getElementById('fromStopSection').style.display='block';
  document.getElementById('toStopSection').style.display='block';

  from.onchange=function(){
    to.innerHTML='<option value="">è«‹é¸æ“‡ä¸‹è»Šç«™</option>';
    stops.filter(stop=>stop!==from.value).forEach(stop=>{
      const opt=document.createElement('option');
      opt.value=stop;opt.textContent=stop;to.appendChild(opt);
    });
    checkSubmitReady();
  };
  to.onchange=checkSubmitReady;
}

function checkSubmitReady(){
  const from=document.getElementById('fromStop').value;
  const to=document.getElementById('toStop').value;
  document.getElementById('submitBtn').style.display=(from&&to)?'block':'none';
}

/* ======================
   ğŸ“ é ç´„é€å‡º
====================== */
async function submitReservation(){
  const from=document.getElementById('fromStop').value;
  const to=document.getElementById('toStop').value;
  if(!selectedDate||!selectedRoute||!from||!to)return alert('è«‹å®Œæ•´é¸æ“‡æ—¥æœŸã€ç­æ¬¡èˆ‡ä¸Šä¸‹è»Šç«™');

  // é ç´„è¦å‰‡ï¼šç¦æ­¢åŒæ—¥ A1+B1 æˆ– A2+B2
  const conflict=existingReservations.some(r=>{
    return r.date===selectedDate &&
      ((r.route.startsWith('A')&&selectedRoute.startsWith('B'))||
       (r.route.startsWith('B')&&selectedRoute.startsWith('A'))) &&
      Math.abs(parseInt(r.route[1])-parseInt(selectedRoute[1]))===0;
  });
  if(conflict)return alert('âš ï¸ ä¸å¯åŒæ—¥é ç´„ A1+B1 æˆ– A2+B2 ç­æ¬¡');

  const payload={type:'reserve',userId:userData.userId,name:userData.name,studentId:userData.studentId,
    department:userData.department,phone:userData.phone||'',route:selectedRoute,fromStop:from,toStop:to,date:selectedDate};

  const res=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const r=await res.json();
  if(r.status==='success'){alert('âœ… é ç´„æˆåŠŸï¼');existingReservations.push(payload);renderCurrentReservationCard();}
  else alert('âŒ é ç´„å¤±æ•—');
}

window.addEventListener('load',init);
</script>
</body>
</html>
