<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç©¿å±±ç”²å°ˆè»Šé ç´„ Pangolin Shuttle Reservation</title>
  <style>
    body {
      font-family: system-ui, "Noto Sans TC", sans-serif;
      background: #f5f6f7;
      margin: 0;
      padding: 0;
    }
    header {
      background: #3c8050;
      color: #fff;
      text-align: center;
      padding: 15px;
      font-size: 22px;
      font-weight: bold;
    }
    .user-section {
      background: white;
      margin: 16px;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .user-name {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    .user-info {
      font-size: 14px;
      color: #666;
    }
    .calendar-day {
      background: #fff;
      border: 1px solid #ddd;
      padding: 8px;
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
      font-size: 14px;
      line-height: 1.4;
    }
    .calendar-day.selected {
      background: #3c8050;
      color: #fff;
      font-weight: bold;
    }
    .submit-btn {
      background: #3c8050;
      color: white;
      border: none;
      padding: 15px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 20px 16px;
      width: calc(100% - 32px);
    }
    .reservation-bubble {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      margin: 6px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }
    .bubble-header {
      background: #27acb2;
      color: #fff;
      font-weight: bold;
      padding: 8px;
      text-align: center;
      font-size: 16px;
    }
    .bubble-body {
      padding: 8px 10px;
      font-size: 14px;
      line-height: 1.4;
    }
    .bubble-footer {
      padding: 8px;
      text-align: center;
      background: #f8f8f8;
    }
    .cancel-btn-small {
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
    }
    .route-btn {
      background: #fff;
      border: 2px solid #3c8050;
      border-radius: 10px;
      padding: 18px 12px;
      text-align: center;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      line-height: 1.6;
      white-space: normal;
    }
    .route-btn:hover {
      background: #e9f5ea;
    }
    .route-btn.selected {
      background: #3c8050;
      color: white;
    }
    select {
      width: 100%;
      padding: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
  </style>
</head>
<body>
  <header>ç©¿å±±ç”²å°ˆè»Šé ç´„<br><small>Pangolin Shuttle Reservation</small></header>
  <div id="userInfo" class="user-section">â³ ç³»çµ±åˆå§‹åŒ–ä¸­ / Loading...</div>

  <!-- æŒ‰éˆ•å€ -->
  <div style="display: flex; gap: 10px; margin: 10px 16px;">
    <button onclick="toggleCalendar()" style="flex: 1; background:#3c8050; color:white; border:none; padding:10px; border-radius:8px; font-weight:bold;">
      <div>ğŸ“… æ‰“é–‹æœˆæ›†</div>
      <div style="font-size:13px;">Open Calendar</div>
    </button>
    <button onclick="openRules()" style="flex: 1; background:#27acb2; color:white; border:none; padding:10px; border-radius:8px; font-weight:bold;">
      <div>ğŸ“– é ç´„è¦å‰‡</div>
      <div style="font-size:13px;">Reservation Rules</div>
    </button>
  </div>

  <div id="calendarContainer" style="display:none; padding:0 16px;">
    <h3 id="calendarTitle"></h3>
    <div id="calendar" style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px;"></div>
  </div>

  <div id="selectedDate" style="margin:10px 16px; color:#2e7d32; display:none; font-weight:bold;"></div>

  <div id="routeButtons" style="display:none; grid-template-columns:1fr 1fr; gap:10px; padding:0 16px;"></div>

  <div id="stopSection" style="display:none; padding:0 16px;">
    <h3>è«‹é¸æ“‡ä¸Šè»Šåœ°é» / Select Pick-up Stop</h3>
    <select id="fromStop"><option>è«‹é¸æ“‡ / Select</option></select>
    <h3 style="margin-top:15px;">è«‹é¸æ“‡ä¸‹è»Šåœ°é» / Select Drop-off Stop</h3>
    <select id="toStop"><option>è«‹é¸æ“‡ / Select</option></select>
  </div>

  <button id="submitBtn" class="submit-btn" onclick="submitReservation()" style="display:none;">é€å‡ºé ç´„ / Submit Reservation</button>

  <div id="currentReservationCard" style="display:none;"></div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
    let userData = null, existingReservations = [], selectedDate = null, selectedRoute = null;

    const stops = [
      ["è¡Œæ”¿å¤§æ¨“", "NCNU Administrative Building"],
      ["ä¸­é¤å»³", "Zhong Can Ting (Chinese Restaurant)"],
      ["ç§‘æŠ€å­¸é™¢", "College of Science and Technology"],
      ["å­¸äººæœƒé¤¨", "Scholars' Residence"],
      ["ä¸­åŸ", "Zhongcheng"],
      ["ä¸‹åŸ", "Xiacheng"],
      ["åªé ‚", "Pingding"],
      ["æ„›è˜­æ©‹", "Ailan Bridge"],
      ["å¤§æˆåœ‹å°", "Dacheng Elementary School"],
      ["ä¸­å±±å®‰ä¸ƒè¡—å£", "Zhongshan Anqi St. Intersection"],
      ["æ¦®æ°‘è¨ºæ‰€", "Veterans Clinic"],
      ["åŸ”é‡Œé…’å» ", "Puli Distillery"],
      ["åŸ”é‡Œç¸½ç«™", "Puli Bus Terminal"]
    ];

    const routes = {
      'A1': { time: '22:00-22:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™ / NCNU â†’ Puli Terminal' },
      'B1': { time: '22:30-23:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§ / Puli Terminal â†’ NCNU' },
      'A2': { time: '23:00-23:30', direction: 'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™ / NCNU â†’ Puli Terminal' },
      'B2': { time: '23:30-24:00', direction: 'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§ / Puli Terminal â†’ NCNU' }
    };

    async function init() {
      await liff.init({ liffId: '2006590746-KJodGOda' });
      if (!liff.isLoggedIn()) return liff.login();
      const profile = await liff.getProfile();
      const [check, resv] = await Promise.all([
        fetch(`${WORKER_URL}?check=${profile.userId}`).then(r => r.json()),
        fetch(`${WORKER_URL}?mode=reservations&userId=${profile.userId}`).then(r => r.json())
      ]);
      if (!check.registered) return location.href = 'register.html';
      userData = check.user;
      existingReservations = resv.reservations || [];
      document.getElementById('userInfo').innerHTML = `
        <div class="user-name">${userData.name}</div>
        <div class="user-info">${userData.department} | ${userData.studentId}</div>
      `;
      renderReservations();
    }

    function toggleCalendar() {
      const c = document.getElementById('calendarContainer');
      c.style.display = c.style.display === 'none' ? 'block' : 'none';
      renderCalendar();
    }

    function renderCalendar() {
      const cal = document.getElementById('calendar');
      const now = new Date(), y = now.getFullYear(), m = now.getMonth();
      document.getElementById('calendarTitle').innerText = `${y}å¹´ ${m + 1}æœˆ / ${y}-${m + 1}`;
      const first = new Date(y, m, 1), last = new Date(y, m + 1, 0);
      let html = ''; const wd = first.getDay();
      for (let i = 0; i < wd; i++) html += '<div></div>';
      for (let d = 1; d <= last.getDate(); d++) {
        const ds = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        html += `<div class="calendar-day" onclick="selectDate('${ds}')">${d}<br><small>Day</small></div>`;
      }
      cal.innerHTML = html;
    }

    function selectDate(ds) {
      selectedDate = ds;
      document.getElementById('selectedDate').textContent = `âœ… å·²é¸æ“‡æ—¥æœŸï¼š${ds} / Selected Date: ${ds}`;
      document.getElementById('selectedDate').style.display = 'block';
      renderRoutes();
    }

    function renderRoutes() {
      const c = document.getElementById('routeButtons');
      let html = '';
      for (const [id, info] of Object.entries(routes)) {
        html += `<div class="route-btn" onclick="selectRoute('${id}','${info.direction}')">
                  <div style="font-size:18px;font-weight:bold;">${id}</div>
                  <div style="font-size:13px;">${info.direction}<br>${info.time}</div>
                 </div>`;
      }
      c.innerHTML = html;
      c.style.display = 'grid';
    }

    function selectRoute(id, direction) {
      selectedRoute = id;
      const fromSel = document.getElementById('fromStop');
      const toSel = document.getElementById('toStop');
      fromSel.innerHTML = '<option>è«‹é¸æ“‡ / Select</option>';
      toSel.innerHTML = '<option>è«‹é¸æ“‡ / Select</option>';
      stops.forEach(([zh, en]) => {
        fromSel.innerHTML += `<option value="${zh}">${zh} / ${en}</option>`;
        toSel.innerHTML += `<option value="${zh}">${zh} / ${en}</option>`;
      });
      document.getElementById('stopSection').style.display = 'block';
      fromSel.onchange = checkStops;
      toSel.onchange = checkStops;
    }

    function checkStops() {
      const from = document.getElementById('fromStop').value;
      const to = document.getElementById('toStop').value;
      const btn = document.getElementById('submitBtn');
      if (from && to) {
        if (from === to) {
          alert('ğŸš« ä¸Šä¸‹è»Šåœ°é»ä¸å¯ç›¸åŒ / Pick-up and Drop-off cannot be the same');
          btn.style.display = 'none';
        } else {
          btn.style.display = 'block';
        }
      } else btn.style.display = 'none';
    }

    async function submitReservation() {
      const from = document.getElementById('fromStop').value;
      const to = document.getElementById('toStop').value;
      if (!selectedDate || !selectedRoute || !from || !to) {
        alert('è«‹å®Œæ•´é¸æ“‡æ‰€æœ‰é …ç›® / Please complete all selections');
        return;
      }
      const info = routes[selectedRoute];
      const data = {
        type: 'reserve',
        userId: userData.userId,
        name: userData.name,
        studentId: userData.studentId,
        department: userData.department,
        phone: userData.phone || '',
        route: selectedRoute,
        routeName: `${selectedRoute} | ${info.time} ${info.direction}`,
        fromStop: from,
        toStop: to,
        date: selectedDate
      };
      const r = await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const j = await r.json();
      if (j.status === 'success') {
        alert('âœ… é ç´„æˆåŠŸ / Reservation Successful!');
        location.reload();
      } else alert('âŒ é ç´„å¤±æ•— / Reservation Failed');
    }

    function renderReservations() {
      const c = document.getElementById('currentReservationCard');
      if (!existingReservations.length) {
        c.innerHTML = '<div style="text-align:center;padding:20px;">ç›®å‰æ²’æœ‰é ç´„ç´€éŒ„ / No Reservations</div>';
        c.style.display = 'block';
        return;
      }
      let h = '<h3 style="text-align:center;">ğŸ§¾ æˆ‘çš„é ç´„ / My Reservations</h3>';
      existingReservations.forEach(r => {
        const fromEN = stops.find(s => s[0] === r.fromStop)?.[1] || '';
        const toEN = stops.find(s => s[0] === r.toStop)?.[1] || '';
        h += `<div class="reservation-bubble">
          <div class="bubble-header">ç©¿å±±ç”²å°ˆè»Šæ–°é ç´„<br><small>Pangolin Shuttle New Reservation</small></div>
          <div class="bubble-body">
            <b>æ—¥æœŸï¼š</b>${r.date}<br><small>Date: ${r.date}</small><br>
            <b>ç­æ¬¡ï¼š</b>${r.routeName}<br><small>Route: ${r.routeName}</small><br>
            <b>ä¸Šè»Šï¼š</b>${r.fromStop}<br><small>Pick-up: ${fromEN}</small><br>
            <b>ä¸‹è»Šï¼š</b>${r.toStop}<br><small>Drop-off: ${toEN}</small>
          </div>
          <div class="bubble-footer">
            <button class="cancel-btn-small" onclick="cancelReservation('${r.id}')">å–æ¶ˆé ç´„ / Cancel</button>
          </div>
        </div>`;
      });
      c.innerHTML = h;
      c.style.display = 'block';
    }

    async function cancelReservation(id) {
      if (!confirm('ç¢ºå®šå–æ¶ˆé€™ç­†é ç´„ï¼Ÿ / Cancel this reservation?')) return;
      const r = await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'cancel', id, userId: userData.userId })
      });
      const j = await r.json();
      if (j.status === 'success') {
        alert('âœ… å·²å–æ¶ˆé ç´„ / Reservation Cancelled');
        location.reload();
      } else alert('âŒ å–æ¶ˆå¤±æ•— / Cancel Failed');
    }

    function openRules() {
      window.open('https://line.me/R/home/public/post?postId=1176044641970348675', '_blank');
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
