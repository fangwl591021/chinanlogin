<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç©¿å±±ç”²å°ˆè»Šé ç´„ Pangolin Shuttle Reservation</title>
<style>
body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; line-height:1.3; }
header span.en { display:block; font-size:14px; color:#fff; }

.btn-dual { display:flex; justify-content:space-between; gap:10px; margin:10px 16px; }
.dual-btn { flex:1; text-align:center; background:#3c8050; color:#fff; border:none; border-radius:8px; padding:10px 0; font-weight:bold; cursor:pointer; font-size:16px; line-height:1.3; }
.dual-btn span.en { display:block; font-size:13px; color:#fff; }

.user-section { background:white; margin:16px; padding:16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.user-name { font-size:20px; font-weight:bold; color:#333; margin-bottom:5px; }
.user-info { font-size:14px; color:#666; }

/* ğŸ“… Calendar */
.calendar-day { background:#fff; border:1px solid #ddd; padding:8px; border-radius:6px; text-align:center; cursor:pointer; font-weight:bold; transition:all 0.2s; }
.calendar-day:hover { background:#e9f5ec; }
.calendar-day.selected { background:#3c8050; color:#fff; }
.calendar-day.disabled { background:#eee; color:#999; border:1px solid #ccc; cursor:not-allowed; opacity:0.7; }

/* âœ… Route Buttons */
.route-btn { background:#fff; border:2px solid #3c8050; border-radius:10px; padding:16px 10px; text-align:center; font-weight:bold; cursor:pointer; transition:all 0.3s; box-shadow:0 2px 5px rgba(0,0,0,0.05); color:#000; }
.route-btn:hover { background:#f0faf2; }
.route-btn.selected { background:#3c8050; color:#fff; border:2px solid #3c8050; box-shadow:0 3px 8px rgba(60,128,80,0.3); }
.route-btn.selected span { color:#fff !important; }
.route-btn span.time { display:block; font-size:15px; color:#3c8050; }
.route-btn span.cn { display:block; color:#333; font-size:15px; margin-top:3px; }
.route-btn span.en { display:block; color:#0056b3; font-size:13px; }

/* ğŸ”¹ Stop Selectors */
.select-label { font-weight:bold; color:#333; margin-top:25px; line-height:1.3; font-size:16px; }
.select-label span.en { display:block; color:#0056b3; font-size:13px; }
select { width:100%; padding:14px; margin-top:8px; border:2px solid #3c8050; border-radius:10px; font-size:16px; background:#fff; color:#333; }
select:focus { outline:none; border-color:#0056b3; box-shadow:0 0 5px rgba(0,86,179,0.3); }

/* ğŸ”¹ Submit Button */
.submit-btn { background:#3c8050; color:white; border:none; padding:15px; border-radius:8px; font-size:17px; font-weight:bold; cursor:pointer; margin:25px 16px; width:calc(100% - 32px); }
.submit-btn span.en { display:block; color:#fff; font-size:13px; }

/* ğŸ”¹ Reservation Card */
.reservation-bubble { background:#fff; border:1px solid #ccc; border-radius:10px; margin:10px 16px; box-shadow:0 2px 5px rgba(0,0,0,0.08); overflow:hidden; }
.bubble-header { background:#27ACB2; color:#fff; font-weight:bold; padding:10px; text-align:center; font-size:16px; line-height:1.3; }
.bubble-header span.en { display:block; font-size:13px; color:#fff; }
.bubble-body { padding:12px; font-size:15px; line-height:1.5; color:#333; }
.bubble-body span.en { display:block; color:#0056b3; font-size:13px; margin-bottom:4px; }
.bubble-footer { padding:10px; text-align:center; background:#f8f8f8; }
.cancel-btn-small { background:#d32f2f; color:white; border:none; border-radius:8px; padding:12px 25px; cursor:pointer; font-weight:bold; font-size:15px; width:85%; }
.cancel-btn-small span.en { display:block; color:#fff; font-size:13px; }
</style>
</head>

<body>
<header>
  ç©¿å±±ç”²å°ˆè»Šé ç´„
  <span class="en">Pangolin Shuttle Bus Reservation</span>
</header>

<div id="userInfo" class="user-section">â³ ç³»çµ±åˆå§‹åŒ–ä¸­...</div>

<div class="btn-dual">
  <button class="dual-btn" onclick="toggleCalendar()">ğŸ“… æ‰“é–‹æœˆæ›†<span class="en">Open Calendar</span></button>
  <button class="dual-btn" onclick="alertRules()">ğŸ“˜ é ç´„è¦å‰‡<span class="en">Reservation Rules</span></button>
</div>

<div id="calendarContainer" style="display:none; padding:0 16px;">
  <h3 id="calendarTitle"></h3>
  <div id="calendar" style="display:grid; grid-template-columns:repeat(7,1fr); gap:4px;"></div>
</div>

<div id="selectedDate" style="margin:10px 16px; color:#2e7d32; display:none;"></div>
<div id="routeButtons" style="display:none; grid-template-columns:1fr 1fr; gap:12px; padding:0 16px;"></div>

<div id="stopSection" style="display:none; padding:0 16px;">
  <label class="select-label">ä¸Šè»Šåœ°é»<span class="en">Pick-up Stop</span></label>
  <select id="fromStop"></select>

  <label class="select-label">ä¸‹è»Šåœ°é»<span class="en">Drop-off Stop</span></label>
  <select id="toStop"></select>
</div>

<button id="submitBtn" class="submit-btn" onclick="submitReservation()" style="display:none;">
  é€å‡ºé ç´„<span class="en">Submit Reservation</span>
</button>

<div id="currentReservationCard" style="display:none;"></div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL='https://delicate-math-7e61.fangwl591021.workers.dev/';
let RULES=null,userData=null,existingReservations=[],selectedDate=null,selectedRoute=null;

async function loadRules(){
  try {
    const res = await fetch('rule.html', { cache: "no-store" });
    const text = await res.text();

    // å˜—è©¦è‡ªå‹•æŠ½å‡º <pre> æˆ– <script> å…§ JSON
    const cleanText = text.trim().startsWith('<')
      ? text.match(/\{[\s\S]*\}/)?.[0] || '{}'
      : text;

    RULES = JSON.parse(cleanText);
    console.log('ğŸ“˜ è¦å‰‡è¼‰å…¥æˆåŠŸ', RULES);
  } catch(e) {
    console.error('âŒ è¼‰å…¥è¦å‰‡å¤±æ•—', e);
    RULES = { seatLimit: 7, maxPerDay: 1, advanceMinutes: 30, stopList: [], availableRoutes: [] };
  }
}


function alertRules(){
  if(!RULES)return alert('è¦å‰‡å°šæœªè¼‰å…¥');
  alert(`ğŸ“˜ é ç´„è¦å‰‡ï¼š
1. æ¯ç­æœ€å¤š ${RULES.seatLimit} äºº
2. æ¯æ—¥é™é ç´„ ${RULES.maxPerDay} ç­
3. å‡ºç™¼å‰ ${RULES.advanceMinutes} åˆ†é˜æˆªæ­¢é ç´„`);
}

async function init(){
  await loadRules();
  try{
    await liff.init({liffId:'2006590746-KJodGOda'});
    if(!liff.isLoggedIn())return liff.login();
    const profile=await liff.getProfile();
    const [check,resv]=await Promise.all([
      fetch(`${WORKER_URL}?check=${profile.userId}`).then(r=>r.json()),
      fetch(`${WORKER_URL}?mode=reservations&userId=${profile.userId}`).then(r=>r.json())
    ]);
    if(!check.registered)return location.href='register.html';
    userData=check.user; existingReservations=resv.reservations||[];
    document.getElementById('userInfo').innerHTML=`
      <div class="user-name">${userData.name}</div>
      <div class="user-info">${userData.department} | ${userData.studentId}</div>`;
    renderReservations();
  }catch(e){console.error(e);document.getElementById('userInfo').innerText='âŒ åˆå§‹åŒ–å¤±æ•—';}
}

function toggleCalendar(){
  const c=document.getElementById('calendarContainer');
  c.style.display=c.style.display==='none'?'block':'none';
  renderCalendar();
}

async function renderCalendar(){
  const cal=document.getElementById('calendar');
  const now=new Date(),y=now.getFullYear(),m=now.getMonth();
  document.getElementById('calendarTitle').innerText=`${y}å¹´${m+1}æœˆ`;
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  let html='';const wd=first.getDay();
  for(let i=0;i<wd;i++)html+='<div></div>';
  for(let d=1;d<=last.getDate();d++){
    const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isPast=new Date(ds)<new Date(now.toDateString());
    const hasReserved=existingReservations.some(r=>r.date===ds);
    let cls='calendar-day',disabled=false;
    if(isPast||hasReserved){cls+=' disabled';disabled=true;}
    html+=`<div class="${cls}" ${disabled?'':`onclick="selectDate('${ds}')"`}>${d}</div>`;
  }
  cal.innerHTML=html;
}

function selectDate(ds){
  if(existingReservations.some(r=>r.date===ds)){
    alert('âš ï¸ æ‚¨ç•¶æ—¥å·²æœ‰é ç´„ï¼Œè«‹å‹¿é‡è¤‡ã€‚');
    return;
  }
  selectedDate=ds;
  document.getElementById('selectedDate').textContent=`âœ… å·²é¸æ“‡æ—¥æœŸï¼š${ds}`;
  document.getElementById('selectedDate').style.display='block';
  renderRoutes();
}

function renderRoutes(){
  const c=document.getElementById('routeButtons');
  let html='';
  RULES.availableRoutes.forEach(r=>{
    html+=`
      <div class="route-btn" onclick="selectRoute('${r.id}', this)">
        ${r.id}
        <span class="time">${r.time}</span>
        <span class="cn">${r.direction}</span>
        <span class="en">${r.eng}</span>
      </div>`;
  });
  c.innerHTML=html;c.style.display='grid';
}

function selectRoute(id,btn){
  selectedRoute=id;
  document.querySelectorAll('.route-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  renderStops();
}

function renderStops(){
  const fs=document.getElementById('fromStop');
  const ts=document.getElementById('toStop');
  fs.innerHTML='<option value="">è«‹é¸æ“‡ä¸Šè»Šåœ°é» / Select Pick-up Stop</option>';
  ts.innerHTML='<option value="">è«‹é¸æ“‡ä¸‹è»Šåœ°é» / Select Drop-off Stop</option>';
  RULES.stopList.forEach(([cn,en])=>{
    const f=document.createElement('option');f.value=cn;f.textContent=`${cn} / ${en}`;fs.appendChild(f);
    const t=f.cloneNode(true);ts.appendChild(t);
  });
  document.getElementById('stopSection').style.display='block';
  fs.onchange=ts.onchange=()=>checkStopsReady();
}

function checkStopsReady(){
  const from=document.getElementById('fromStop').value;
  const to=document.getElementById('toStop').value;
  document.getElementById('submitBtn').style.display=(from&&to)?'block':'none';
}

async function submitReservation(){
  const from=document.getElementById('fromStop').value;
  const to=document.getElementById('toStop').value;
  if(!selectedDate||!selectedRoute||!from||!to){alert('âš ï¸ è«‹å®Œæ•´é¸æ“‡ä¸Šä¸‹è»Šåœ°é»');return;}
  if(from===to){alert('âš ï¸ ä¸Šä¸‹è»Šåœ°é»ä¸å¯ç›¸åŒ');return;}
  const r=RULES.availableRoutes.find(r=>r.id===selectedRoute);
  const data={type:'reserve',userId:userData.userId,name:userData.name,studentId:userData.studentId,department:userData.department,phone:userData.phone||'',route:selectedRoute,routeName:`${selectedRoute} | ${r.time} ${r.direction}`,fromStop:from,toStop:to,date:selectedDate};
  const res=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  const j=await res.json();
  if(j.status==='success'){
    alert('âœ… é ç´„æˆåŠŸï¼');
    existingReservations.push({id:j.id||`temp-${Date.now()}`,date:data.date,route:data.routeName,name:data.name,fromStop:data.fromStop,toStop:data.toStop});
    renderReservations();
  }else alert('âŒ é ç´„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
}

async function cancelReservation(id){
  if(!confirm('ç¢ºå®šå–æ¶ˆé€™ç­†é ç´„ï¼Ÿ'))return;
  const r=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'cancel',id,userId:userData.userId})});
  const j=await r.json();
  if(j.status==='success'){alert('âœ… å·²å–æ¶ˆ');existingReservations=existingReservations.filter(e=>e.id!==id);renderReservations();}
  else alert('âŒ å–æ¶ˆå¤±æ•—');
}

function renderReservations(){
  const c=document.getElementById('currentReservationCard');
  if(!existingReservations.length){c.innerHTML='<div style="text-align:center;padding:20px;">ç›®å‰æ²’æœ‰é ç´„ç´€éŒ„<br><span class="en" style="color:#0056b3;">No reservation records</span></div>';c.style.display='block';return;}
  let h='<h3 style="text-align:center;">ğŸ§¾ æˆ‘çš„é ç´„<span class="en" style="display:block;color:#0056b3;font-size:14px;">My Reservations</span></h3>';
  existingReservations.forEach(r=>{
    const fromEn=(RULES.stopList.find(s=>s[0]===r.fromStop)||[])[1]||r.fromStop;
    const toEn=(RULES.stopList.find(s=>s[0]===r.toStop)||[])[1]||r.toStop;
    h+=`<div class="reservation-bubble"><div class="bubble-header">ğŸšŒ ç©¿å±±ç”²å°ˆè»Šæ–°é ç´„<span class="en">Pangolin Shuttle New Reservation</span></div><div class="bubble-body">æ—¥æœŸï¼š${r.date}<br><span class="en">Date: ${r.date}</span>ç­æ¬¡ï¼š${r.route}<br><span class="en">Route: ${r.route}</span>ä¸Šè»Šï¼š${r.fromStop}<br><span class="en">Pick-up: ${fromEn}</span>ä¸‹è»Šï¼š${r.toStop}<br><span class="en">Drop-off: ${toEn}</span></div><div class="bubble-footer"><button class="cancel-btn-small" onclick="cancelReservation('${r.id}')">å–æ¶ˆé ç´„<span class="en">Cancel</span></button></div></div>`;
  });
  c.innerHTML=h;c.style.display='block';
}

window.addEventListener('load',init);
</script>
</body>
</html>
