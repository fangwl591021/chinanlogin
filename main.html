<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>暨大接駁車 - 預約系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .time-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 12px;
        }
        .time-slot {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .time-slot:hover {
            border-color: #8b5cf6;
        }
        .time-slot.selected {
            border-color: #8b5cf6;
            background-color: #f3f4f6;
        }
        .time-slot.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-md mx-auto bg-white min-h-screen">
        <!-- 頁首 -->
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6">
            <div class="flex items-center gap-3">
                <i class="fas fa-bus text-2xl"></i>
                <div>
                    <h1 class="text-xl font-bold">穿山甲專車預約</h1>
                    <p class="text-purple-200 text-sm">暨大接駁車服務</p>
                </div>
            </div>
        </div>

        <!-- 主要內容 -->
        <div class="p-6 space-y-6">
            <!-- 選擇日期按鈕 -->
            <div class="bg-white rounded-xl border-2 border-dashed border-gray-300 p-6 text-center">
                <button 
                    id="selectDateBtn"
                    onclick="openCalendar()"
                    class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white font-bold py-4 px-6 rounded-xl transition duration-200 flex items-center justify-center gap-3"
                >
                    <i class="fas fa-calendar-alt"></i>
                    點我選擇搭車日期
                </button>
                <p id="selectedDateDisplay" class="text-sm text-gray-500 mt-2 hidden">
                    已選擇: <span id="selectedDateText"></span>
                </p>
            </div>

            <!-- 日期選擇器 (初始隱藏) -->
            <div id="calendarSection" class="hidden">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">選擇搭乘日期</h2>
                    
                    <!-- 月份導航 -->
                    <div class="flex items-center justify-between mb-4">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h3 id="currentMonth" class="font-semibold">2025年10月</h3>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <!-- 日曆 -->
                    <div class="calendar-grid text-center text-sm mb-2">
                        <div class="text-red-500 font-medium">日</div>
                        <div class="font-medium">一</div>
                        <div class="font-medium">二</div>
                        <div class="font-medium">三</div>
                        <div class="font-medium">四</div>
                        <div class="font-medium">五</div>
                        <div class="text-blue-500 font-medium">六</div>
                    </div>
                    
                    <div id="calendarDays" class="calendar-grid text-sm">
                        <!-- 日曆天數由 JavaScript 生成 -->
                    </div>

                    <div class="mt-4 text-xs text-gray-500">
                        <p>請選擇乘車日期，停駛日期無法選擇</p>
                    </div>
                </div>
            </div>

            <!-- 時段選擇 (初始隱藏) -->
            <div id="timeSection" class="hidden">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">請點選搭乘時段</h2>
                    
                    <div class="time-grid">
                        <!-- A1 班次 -->
                        <div class="time-slot" data-route="A1" onclick="selectTimeSlot('A1')">
                            <div class="font-bold text-purple-600">A1</div>
                            <div class="text-sm">22:00-22:30</div>
                            <div class="text-xs text-gray-500">暨大→埔里總站</div>
                            <div class="text-xs text-green-600 mt-1">剩餘6名</div>
                        </div>

                        <!-- B1 班次 -->
                        <div class="time-slot" data-route="B1" onclick="selectTimeSlot('B1')">
                            <div class="font-bold text-green-600">B1</div>
                            <div class="text-sm">22:30-23:00</div>
                            <div class="text-xs text-gray-500">埔里總站→暨大</div>
                            <div class="text-xs text-green-600 mt-1">剩餘6名</div>
                        </div>

                        <!-- A2 班次 -->
                        <div class="time-slot" data-route="A2" onclick="selectTimeSlot('A2')">
                            <div class="font-bold text-blue-600">A2</div>
                            <div class="text-sm">23:00-23:30</div>
                            <div class="text-xs text-gray-500">暨大→埔里總站</div>
                            <div class="text-xs text-green-600 mt-1">剩餘6名</div>
                        </div>

                        <!-- B2 班次 -->
                        <div class="time-slot" data-route="B2" onclick="selectTimeSlot('B2')">
                            <div class="font-bold text-orange-600">B2</div>
                            <div class="text-sm">23:30-24:00</div>
                            <div class="text-xs text-gray-500">埔里總站→暨大</div>
                            <div class="text-xs text-green-600 mt-1">剩餘6名</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 下車站選擇 (初始隱藏) -->
            <div id="stopSection" class="hidden">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">選擇下車站</h2>
                    
                    <select 
                        id="stopSelect"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                        required
                    >
                        <option value="">請選擇下車站</option>
                        <!-- 動態生成停靠站 -->
                    </select>
                </div>
            </div>

            <!-- 用戶資訊 (初始隱藏) -->
            <div id="userInfoSection" class="hidden">
                <div class="bg-white rounded-xl shadow-md p-6 space-y-4">
                    <!-- 姓名 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user text-blue-500 mr-2"></i>姓名 *
                        </label>
                        <input 
                            type="text" 
                            id="userName"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                            placeholder="請輸入姓名"
                            required
                        >
                    </div>

                    <!-- 手機 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-phone text-green-500 mr-2"></i>手機 *
                        </label>
                        <input 
                            type="tel" 
                            id="userPhone"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition"
                            placeholder="請輸入手機號碼"
                            pattern="[0-9]{10}"
                            maxlength="10"
                            required
                        >
                    </div>
                </div>
            </div>

            <!-- 提交按鈕 (初始隱藏) -->
            <div id="submitSection" class="hidden">
                <button 
                    id="submitBtn"
                    onclick="submitBooking()"
                    class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition duration-200 shadow-lg"
                >
                    <i class="fas fa-check-circle mr-2"></i>
                    送出預約
                </button>
            </div>
        </div>
    </div>

    <script>
        // 系統配置
        const CONFIG = {
            GITHUB_TOKEN: "hhFVS+V7Fp4zIFZ0sv6vq1WuvKmIKzsK6RlZkAOftxr2Lob218VgP+/PK+wIhwhw8HTlOobneGQhxTllrjt8uAzwaCGgWZ5yokIKZSVID+ccNDJmKxElxNQatB6NUObNTtofnMdDZTOLx12X4QRRdwdB04t89/1O/w1cDnyilFU=",
            GIST_ID: "C596050d1193b9b930ac25469c61ba12a",
            STOPS: {
                outbound: ["行政大樓", "中餐廳", "科技學院", "學人會館", "中城", "下城", "坪頂", "愛蘭橋", "大成國小", "中山安七街口", "榮民診所", "埔里酒廠", "埔里總站"],
                return: ["埔里總站", "埔里酒廠", "榮民診所", "中山安七街口", "大成國小", "愛蘭橋", "坪頂", "下城", "中城", "學人會館", "科技學院", "中餐廳", "行政大樓"]
            },
            HOLIDAYS: ["2025-10-01", "2025-10-10", "2025-10-25"] // 停駛日期範例
        };

        let currentDate = new Date();
        let selectedDate = null;
        let selectedRoute = null;

        // 開啟日曆
        function openCalendar() {
            document.getElementById('calendarSection').classList.remove('hidden');
            document.getElementById('selectDateBtn').classList.add('hidden');
            generateCalendar(currentDate);
        }

        // 生成日曆
        function generateCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // 更新月份顯示
            document.getElementById('currentMonth').textContent = 
                `${year}年${month + 1}月`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            // 填充空白
            for (let i = 0; i < startingDay; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'p-2';
                calendarDays.appendChild(emptyDiv);
            }
            
            // 填充日期
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'p-2 cursor-pointer rounded-lg hover:bg-gray-100';
                
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isHoliday = CONFIG.HOLIDAYS.includes(dateStr);
                const isPast = new Date(dateStr) < new Date(new Date().toDateString());
                
                if (isHoliday) {
                    dayDiv.classList.add('text-gray-400', 'line-through', 'cursor-not-allowed');
                    dayDiv.title = '停駛日期';
                } else if (isPast) {
                    dayDiv.classList.add('text-gray-400', 'cursor-not-allowed');
                } else {
                    dayDiv.classList.add('text-gray-800');
                    dayDiv.onclick = () => selectDate(dateStr, day);
                }
                
                dayDiv.textContent = day;
                calendarDays.appendChild(dayDiv);
            }
        }

        // 切換月份
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            generateCalendar(currentDate);
        }

        // 選擇日期
        function selectDate(dateStr, day) {
            selectedDate = dateStr;
            
            // 更新顯示
            document.getElementById('selectedDateText').textContent = 
                `${dateStr.split('-')[0]}年${dateStr.split('-')[1]}月${day}日`;
            document.getElementById('selectedDateDisplay').classList.remove('hidden');
            
            // 顯示時段選擇
            document.getElementById('timeSection').classList.remove('hidden');
            
            // 隱藏日曆
            document.getElementById('calendarSection').classList.add('hidden');
        }

        // 選擇時段
        function selectTimeSlot(route) {
            selectedRoute = route;
            
            // 移除所有選擇狀態
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            // 添加選擇狀態
            event.currentTarget.classList.add('selected');
            
            // 更新停靠站選項
            updateStopOptions(route);
            
            // 顯示下車站選擇
            document.getElementById('stopSection').classList.remove('hidden');
            document.getElementById('userInfoSection').classList.remove('hidden');
            document.getElementById('submitSection').classList.remove('hidden');
        }

        // 更新停靠站選項
        function updateStopOptions(route) {
            const stopSelect = document.getElementById('stopSelect');
            stopSelect.innerHTML = '<option value="">請選擇下車站</option>';
            
            const stops = route.startsWith('A') ? CONFIG.STOPS.outbound : CONFIG.STOPS.return;
            
            stops.forEach((stop, index) => {
                const option = document.createElement('option');
                option.value = stop;
                option.textContent = `${index + 1}. ${stop}`;
                stopSelect.appendChild(option);
            });
        }

        // 提交預約
        async function submitBooking() {
            const userName = document.getElementById('userName').value;
            const userPhone = document.getElementById('userPhone').value;
            const selectedStop = document.getElementById('stopSelect').value;
            
            // 基本驗證
            if (!userName || !userPhone || !selectedStop || !selectedDate || !selectedRoute) {
                alert('請填寫所有必填欄位');
                return;
            }
            
            if (!userPhone.match(/^[0-9]{10}$/)) {
                alert('請輸入正確的手機號碼（10位數字）');
                return;
            }
            
            try {
                // 顯示載入中
                const submitBtn = document.getElementById('submitBtn');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>預約中...';
                submitBtn.disabled = true;
                
                // 獲取當前用戶資料
                const userData = JSON.parse(sessionStorage.getItem('userData') || '{}');
                
                // 準備預約資料
                const bookingData = {
                    userId: userData.userId || 'unknown',
                    userName: userName,
                    userPhone: userPhone,
                    studentId: userData.studentId || 'unknown',
                    department: userData.department || 'unknown',
                    routeName: selectedRoute,
                    date: selectedDate,
                    stop: selectedStop,
                    bookingTime: new Date().toISOString(),
                    status: 'confirmed'
                };
                
                // 儲存到 GitHub
                await saveBooking(bookingData);
                
                // 發送推播通知
                await sendNotification(bookingData);
                
                alert('預約成功！我們已發送確認通知');
                
                // 導向預約記錄頁面
                window.location.href = 'booking-history.html';
                
            } catch (error) {
                console.error('預約失敗:', error);
                alert('預約失敗，請稍後再試');
                
                // 恢復按鈕狀態
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>送出預約';
                submitBtn.disabled = false;
            }
        }

        // 儲存預約到 GitHub
        async function saveBooking(bookingData) {
            const currentData = await getGistData();
            
            if (!currentData.bookings) {
                currentData.bookings = [];
            }
            
            currentData.bookings.push(bookingData);
            
            await updateGist(currentData);
        }

        // 發送推播通知
        async function sendNotification(bookingData) {
            // 這裡可以整合 LINE Notify 或其他推播服務
            console.log('發送推播通知:', bookingData);
            
            // 範例：使用 LINE Notify
            // await fetch('https://notify-api.line.me/api/notify', {
            //     method: 'POST',
            //     headers: {
            //         'Authorization': 'Bearer ' + CONFIG.LINE_NOTIFY_TOKEN,
            //         'Content-Type': 'application/x-www-form-urlencoded',
            //     },
            //     body: `message=預約成功！${bookingData.userName} 已預約 ${bookingData.date} ${bookingData.routeName}`
            // });
        }

        // GitHub Gist 相關函數
        async function getGistData() {
            const response = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, {
                headers: {
                    'Authorization': `token ${CONFIG.GITHUB_TOKEN}`
                }
            });
            
            const gist = await response.json();
            return JSON.parse(gist.files['data.json'].content);
        }

        async function updateGist(data) {
            const response = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${CONFIG.GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: {
                        'data.json': {
                            content: JSON.stringify(data, null, 2)
                        }
                    }
                })
            });
            
            return await response.json();
        }

        // 初始化
        window.addEventListener('load', function() {
            // 檢查用戶是否已登入
            const userData = JSON.parse(sessionStorage.getItem('userData') || '{}');
            
            if (userData.displayName) {
                document.getElementById('userName').value = userData.displayName;
            }
            if (userData.phone) {
                document.getElementById('userPhone').value = userData.phone;
            }
            
            // 初始化當前日期
            currentDate = new Date();
        });
    </script>
</body>
</html>
