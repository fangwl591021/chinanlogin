<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>穿山甲專車預約 🚍 | Pangolin Shuttle Reservation</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body {
  font-family: system-ui, "Noto Sans TC", sans-serif;
  background: #f5f6f7;
  margin: 0;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}
header {
  background: #3c8050;
  color: #fff;
  text-align: center;
  padding: 15px;
  font-size: 22px;
  font-weight: bold;
}
main {
  flex: 1;
  padding-bottom: 40px;
}
.notice {
  padding: 10px 16px;
  margin: 10px 16px;
  border-radius: 6px;
}
.notice.success { background: #e8f5e9; color: #2e7d32; border: 1px solid #81c784; }
.notice.error { background: #fdecea; color: #b71c1c; border: 1px solid #f5c2c7; }

.calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 3px;
  text-align: center;
  font-size: 13px;
  margin-bottom: 20px;
}
.calendar-day {
  padding: 8px 0;
  min-height: 45px;
  border-radius: 4px;
  background: #fff;
  border: 1px solid #e0e0e0;
  cursor: pointer;
}
.calendar-day:hover { background: #eaf5ea; }
.calendar-day.past { background: #f5f5f5; color: #ccc; cursor:not-allowed; }
.calendar-day.disabled { background: #ffe6e6; color: #999; cursor:not-allowed; }
.calendar-day.selected { background: #3c8050; color: #fff; font-weight:bold; }

.route-section, .stop-selector { padding: 0 16px; margin: 20px 0; }
.route-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
.route-btn {
  padding: 12px;
  border: 2px solid #3c8050;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  text-align: center;
}
.route-btn:hover { background: #eaf5ea; }
.route-btn.selected { background: #3c8050; color:white; }

select {
  width:100%;
  padding:12px;
  border:1px solid #ccc;
  border-radius:6px;
  margin-top:8px;
  font-family: system-ui, "Noto Sans TC", sans-serif;
}
.submit-btn {
  background:#3c8050;
  color:white;
  border:none;
  padding:15px;
  border-radius:8px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
  width:calc(100% - 32px);
  margin:20px 16px;
}
.submit-btn:hover { background:#2d6140; }

.btn-group {
  display:flex;
  justify-content:center;
  gap:12px;
  margin:15px;
}
.btn-large {
  font-size:18px;
  padding:12px 20px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
  color: white !important; /* 確保文字是白色 */
}
.btn-calendar { background:#3c8050; }
.btn-calendar:hover { background:#2d6140; }
.btn-rule { background:#6c757d; } /* 改為灰色 */
.btn-rule:hover { background:#5a6268; }

.cancel-btn {
  background:#c62828;
  color:white;
  border:none;
  padding:10px 20px;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
  margin-top:8px;
  width:100%;
}
.cancel-btn:hover { background:#b71c1c; }

.resv-card {
  background:#f0fdf4;
  border:1px solid #a5d6a7;
  padding:10px 16px;
  border-radius:8px;
  margin:10px 16px;
}
.resv-row { margin:4px 0; }

#reservationPanel {
  margin-top: 40px;
  padding: 10px 0 20px 0;
  background: #ffffff;
  border-top: 3px solid #3c8050;
  box-shadow: 0 -3px 5px rgba(0,0,0,0.1);
}

/* 雙語樣式 */
.bilingual {
  line-height: 1.4;
}
.chinese {
  font-weight: 500;
  display: block;
  color: inherit; /* 繼承父元素顏色 */
}
.english {
  font-size: 12px;
  color: inherit; /* 繼承父元素顏色 */
  display: block;
  font-style: italic;
  opacity: 0.9; /* 稍微降低不透明度 */
}

.stop-option {
  padding: 8px 12px;
}

/* 確保按鈕內文字都是白色 */
.btn-large .chinese,
.btn-large .english,
.submit-btn .chinese, 
.submit-btn .english,
.cancel-btn .chinese,
.cancel-btn .english {
  color: white !important;
}
</style>
</head>

<body>
<header>
  <div class="chinese">穿山甲專車預約</div>
  <div class="english">Pangolin Shuttle Reservation</div>
</header>

<main>
  <div id="userInfo" style="padding:16px"><div>⏳ 系統初始化中... | System initializing...</div></div>

  <div class="btn-group">
    <button id="calendarBtn" class="btn-large btn-calendar" onclick="toggleCalendar()">
      <div class="chinese">📅 打開月曆</div>
      <div class="english">Open Calendar</div>
    </button>
    <button id="ruleBtn" class="btn-large btn-rule" onclick="showRules()">
      <div class="chinese">📘 預約規則</div>
      <div class="english">Reservation Rules</div>
    </button>
  </div>

  <div id="calendarContainer" style="display:none;margin-top:10px;padding:0 16px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <button onclick="changeMonth(-1)">◀ 上個月 | Previous</button>
      <h3 id="calendarTitle"></h3>
      <button onclick="changeMonth(1)">下個月 ▶ | Next</button>
    </div>
    <div id="calendar" class="calendar"></div>
  </div>

  <div id="selectedDate" class="notice success" style="display:none"></div>

  <div id="routeSection" class="route-section" style="display:none">
    <h3 class="bilingual">
      <span class="chinese">請選擇搭乘班次</span>
      <span class="english">Please Select Shuttle Route</span>
    </h3>
    <div id="routeButtons" class="route-buttons"></div>
  </div>

  <div id="fromStopSection" class="stop-selector" style="display:none">
    <h3 class="bilingual">
      <span class="chinese">請選擇上車站</span>
      <span class="english">Please Select Boarding Stop</span>
    </h3>
    <select id="fromStop"><option value="">請先選擇班次 | Please select route first</option></select>
  </div>

  <div id="toStopSection" class="stop-selector" style="display:none">
    <h3 class="bilingual">
      <span class="chinese">請選擇下車站</span>
      <span class="english">Please Select Alighting Stop</span>
    </h3>
    <select id="toStop"><option value="">請選擇上車站 | Please select boarding stop</option></select>
  </div>

  <button id="submitBtn" class="submit-btn" onclick="submitReservation()" style="display:none">
    <div class="chinese">送出預約</div>
    <div class="english">Submit Reservation</div>
  </button>

  <div id="reservationPanel" style="display:none">
    <div style="text-align:center;font-weight:bold;color:#2d6140;margin-bottom:5px;" class="bilingual">
      <span class="chinese">我的預約紀錄</span>
      <span class="english">My Reservations</span>
    </div>
    <div id="reservationInfo"></div>
  </div>
</main>

<script>
const WORKER_URL='https://delicate-math-7e61.fangwl591021.workers.dev/';
let userData=null, existingReservations=[], selectedDate=null, selectedRoute=null;
let currentYear=new Date().getFullYear(), currentMonth=new Date().getMonth();

/* === 初始化 === */
async function init(){
  try {
    await liff.init({liffId:"2006590746-KJodGOda"});
    if(!liff.isLoggedIn()) return liff.login();
    
    const profile = await liff.getProfile();
    console.log('👤 用戶 ID:', profile.userId);
    
    const [checkRes, reservations] = await Promise.all([
      fetch(`${WORKER_URL}?mode=check&userId=${profile.userId}`).then(r=>r.json()),
      fetch(`${WORKER_URL}?mode=reservations&userId=${profile.userId}`).then(r=>r.json())
    ]);
    
    console.log('✅ 用戶檢查:', checkRes);
    console.log('📋 預約回應:', reservations);
    
    if(!checkRes.registered) return location.href='register.html';
    
    userData = checkRes.user;
    renderUser(userData);
    
    existingReservations = reservations.reservations || [];
    console.log('📦 預約列表 (共 ' + existingReservations.length + ' 筆):', existingReservations);
    
    renderReservationInfo();
    loadCalendar();
  } catch (err) {
    console.error('❌ 初始化錯誤:', err);
    alert('系統錯誤: ' + err.message);
  }
}

/* === 顯示用戶資訊 - 修正手機顯示 === */
function renderUser(u){
  // 檢查手機號碼是否正確，如果沒有手機號碼或顯示科系，顯示提示
  const phone = u.phone || '';
  const hasValidPhone = phone && !phone.includes('_') && phone.length >= 8;
  
  document.getElementById('userInfo').innerHTML=
    `<div style="font-size:18px;font-weight:bold">${u.name}</div>
     <div>${u.department} | ${hasValidPhone ? phone : '📞 請更新手機號碼'}</div>
     ${!hasValidPhone ? '<div style="color:#d32f2f;font-size:12px;margin-top:4px">手機號碼顯示異常，請聯繫管理員</div>' : ''}`;
}

/* === 月曆 === */
function loadCalendar(){
  const cal=document.getElementById('calendar');
  cal.innerHTML='';
  const first=new Date(currentYear,currentMonth,1);
  const last=new Date(currentYear,currentMonth+1,0);
  document.getElementById('calendarTitle').textContent=
    `${currentYear}年${currentMonth+1}月`;

  const today=new Date();
  for(let d=1;d<=last.getDate();d++){
    const dateStr=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const div=document.createElement('div');
    div.className='calendar-day';
    if(new Date(dateStr)<today)div.classList.add('past');
    else{div.textContent=d;div.onclick=()=>selectDate(dateStr);}
    cal.appendChild(div);
  }
}
function changeMonth(delta){
  currentMonth+=delta;
  if(currentMonth<0){currentMonth=11;currentYear--;}
  if(currentMonth>11){currentMonth=0;currentYear++;}
  loadCalendar();
}
function toggleCalendar(){
  const c=document.getElementById('calendarContainer');
  c.style.display=(c.style.display==='none')?'block':'none';
}
function selectDate(dateStr){
  selectedDate=dateStr;
  document.getElementById('selectedDate').style.display='block';
  document.getElementById('selectedDate').innerHTML = `
    <div class="chinese">✅ 已選擇：${dateStr}</div>
    <div class="english">✅ Selected: ${dateStr}</div>
  `;
}

/* === 預約紀錄 === */
function renderReservationInfo(){
  const panel = document.getElementById('reservationPanel');
  const box = document.getElementById('reservationInfo');
  
  if(!existingReservations.length){
    panel.style.display='none';
    return;
  }
  
  panel.style.display='block';
  
  box.innerHTML = existingReservations.map(r => {
    return `
    <div class="resv-card">
      <div class="resv-row bilingual">
        <span class="chinese">🕒 時間：${r.date}</span>
        <span class="english">🕒 Time: ${r.date}</span>
      </div>
      <div class="resv-row bilingual">
        <span class="chinese">🚌 班次：${r.route}</span>
        <span class="english">🚌 Route: ${r.route}</span>
      </div>
      <div class="resv-row bilingual">
        <span class="chinese">⬆ 上車：${r.fromStop}　⬇ 下車：${r.toStop}</span>
        <span class="english">⬆ Board: ${r.fromStop}　⬇ Alight: ${r.toStop}</span>
      </div>
      <button class="cancel-btn" onclick="cancelReservation('${r.date}','${r.route}')">
        <div class="chinese">取消預約</div>
        <div class="english">Cancel Reservation</div>
      </button>
    </div>`;
  }).join('');
}

/* === 取消預約 === */
async function cancelReservation(date, route) {
  if (!confirm(`確定取消 ${date} ${route} 嗎？\nConfirm cancellation of ${date} ${route}?`)) return;
  
  const payload = {
    type: 'cancel', 
    userId: userData.userId, 
    date: date, 
    route: route
  };
  
  try {
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const result = await res.json();
    
    if (result.status === 'success') {
      alert('✅ 已取消預約\n✅ Reservation cancelled');
      existingReservations = existingReservations.filter(x => !(x.date === date && x.route === route));
      renderReservationInfo();
    } else {
      console.error('❌ 取消失敗:', result);
      alert('❌ 取消失敗：' + (result.message || '未知錯誤\nCancellation failed'));
    }
  } catch (error) {
    console.error('❌ 網路錯誤:', error);
    alert('❌ 網路錯誤，請稍後再試\nNetwork error, please try again');
  }
}

/* === 路線與站點資料 - 修正版 === */
const ROUTES = {
  'A1': { 
    name: 'A1 晚間22:00', 
    time: '22:00-22:30', 
    direction: '暨大→埔里總站',
    directionEn: 'NCNU → Puli Terminal'
  },
  'B1': { 
    name: 'B1 晚間22:30', 
    time: '22:30-23:00', 
    direction: '埔里總站→暨大',
    directionEn: 'Puli Terminal → NCNU'
  },
  'A2': { 
    name: 'A2 晚間23:00', 
    time: '23:00-23:30', 
    direction: '暨大→埔里總站',
    directionEn: 'NCNU → Puli Terminal'
  },
  'B2': { 
    name: 'B2 晚間23:30', 
    time: '23:30-24:00', 
    direction: '埔里總站→暨大',
    directionEn: 'Puli Terminal → NCNU'
  }
};

// 雙語站點資料
const STOPS = {
  // 去程：暨大→埔里總站
  'A1': [
    { zh: '行政大樓', en: 'Administrative Building' },
    { zh: '中餐廳', en: 'Chinese Restaurant' },
    { zh: '科技學院', en: 'College of Science and Technology' },
    { zh: '學人會館', en: 'Scholars Residence' },
    { zh: '中城', en: 'Zhongcheng' },
    { zh: '下城', en: 'Xiacheng' },
    { zh: '坪頂', en: 'Pingding' },
    { zh: '愛蘭橋', en: 'Allan Bridge' },
    { zh: '大成國小', en: 'Dacheng Elementary School' },
    { zh: '中山安七街口', en: 'Zhongshan Anqi St. Intersection' },
    { zh: '榮民診所', en: 'Veterans Clinic' },
    { zh: '埔里酒廠', en: 'Puli Distillery' },
    { zh: '埔里總站', en: 'Puli Bus Terminal' }
  ],
  'A2': [
    { zh: '行政大樓', en: 'Administrative Building' },
    { zh: '中餐廳', en: 'Chinese Restaurant' },
    { zh: '科技學院', en: 'College of Science and Technology' },
    { zh: '學人會館', en: 'Scholars Residence' },
    { zh: '中城', en: 'Zhongcheng' },
    { zh: '下城', en: 'Xiacheng' },
    { zh: '坪頂', en: 'Pingding' },
    { zh: '愛蘭橋', en: 'Allan Bridge' },
    { zh: '大成國小', en: 'Dacheng Elementary School' },
    { zh: '中山安七街口', en: 'Zhongshan Anqi St. Intersection' },
    { zh: '榮民診所', en: 'Veterans Clinic' },
    { zh: '埔里酒廠', en: 'Puli Distillery' },
    { zh: '埔里總站', en: 'Puli Bus Terminal' }
  ],
  // 回程：埔里總站→暨大
  'B1': [
    { zh: '埔里總站', en: 'Puli Bus Terminal' },
    { zh: '埔里酒廠', en: 'Puli Distillery' },
    { zh: '榮民診所', en: 'Veterans Clinic' },
    { zh: '中山安七街口', en: 'Zhongshan Anqi St. Intersection' },
    { zh: '大成國小', en: 'Dacheng Elementary School' },
    { zh: '愛蘭橋', en: 'Allan Bridge' },
    { zh: '坪頂', en: 'Pingding' },
    { zh: '下城', en: 'Xiacheng' },
    { zh: '中城', en: 'Zhongcheng' },
    { zh: '學人會館', en: 'Scholars Residence' },
    { zh: '科技學院', en: 'College of Science and Technology' },
    { zh: '中餐廳', en: 'Chinese Restaurant' },
    { zh: '行政大樓', en: 'Administrative Building' }
  ],
  'B2': [
    { zh: '埔里總站', en: 'Puli Bus Terminal' },
    { zh: '埔里酒廠', en: 'Puli Distillery' },
    { zh: '榮民診所', en: 'Veterans Clinic' },
    { zh: '中山安七街口', en: 'Zhongshan Anqi St. Intersection' },
    { zh: '大成國小', en: 'Dacheng Elementary School' },
    { zh: '愛蘭橋', en: 'Allan Bridge' },
    { zh: '坪頂', en: 'Pingding' },
    { zh: '下城', en: 'Xiacheng' },
    { zh: '中城', en: 'Zhongcheng' },
    { zh: '學人會館', en: 'Scholars Residence' },
    { zh: '科技學院', en: 'College of Science and Technology' },
    { zh: '中餐廳', en: 'Chinese Restaurant' },
    { zh: '行政大樓', en: 'Administrative Building' }
  ]
};

/* === 選擇日期後顯示路線 === */
function selectDate(dateStr){
  selectedDate = dateStr;
  selectedRoute = null;
  
  document.getElementById('selectedDate').style.display = 'block';
  document.getElementById('selectedDate').innerHTML = `
    <div class="chinese">✅ 已選擇：${dateStr}</div>
    <div class="english">✅ Selected: ${dateStr}</div>
  `;
  
  showRoutes();
  
  document.getElementById('fromStopSection').style.display = 'none';
  document.getElementById('toStopSection').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
}

/* === 顯示路線選擇 === */
function showRoutes(){
  const section = document.getElementById('routeSection');
  const container = document.getElementById('routeButtons');
  
  section.style.display = 'block';
  
  container.innerHTML = Object.keys(ROUTES).map(code => `
    <div class="route-btn" onclick="selectRoute('${code}')">
      <div style="font-weight:bold;font-size:16px">${ROUTES[code].name}</div>
      <div class="bilingual" style="margin-top:4px">
        <div class="chinese">${ROUTES[code].direction}</div>
        <div class="english">${ROUTES[code].directionEn}</div>
      </div>
    </div>
  `).join('');
}

/* === 選擇路線 === */
function selectRoute(routeCode){
  selectedRoute = routeCode;
  
  document.querySelectorAll('.route-btn').forEach(btn => btn.classList.remove('selected'));
  event.target.closest('.route-btn').classList.add('selected');
  
  loadStops(routeCode);
  
  document.getElementById('fromStopSection').style.display = 'block';
  document.getElementById('toStopSection').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
}

/* === 載入站點選項 === */
function loadStops(routeCode){
  const fromSelect = document.getElementById('fromStop');
  const stops = STOPS[routeCode] || [];
  
  fromSelect.innerHTML = '<option value="">請選擇上車站 | Please select boarding stop</option>' +
    stops.map(stop => `
      <option value="${stop.zh}" class="stop-option">
        ${stop.zh} | ${stop.en}
      </option>
    `).join('');
  
  fromSelect.onchange = function(){
    if(this.value){
      loadToStops(routeCode, this.value);
    } else {
      document.getElementById('toStopSection').style.display = 'none';
      document.getElementById('submitBtn').style.display = 'none';
    }
  };
  
  document.getElementById('toStop').innerHTML = '<option value="">請先選擇上車站 | Please select boarding stop first</option>';
  document.getElementById('toStopSection').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
}

/* === 載入下車站選項 === */
function loadToStops(routeCode, fromStop){
  const toSelect = document.getElementById('toStop');
  const stops = STOPS[routeCode] || [];
  const fromIndex = stops.findIndex(stop => stop.zh === fromStop);
  
  const availableStops = stops.slice(fromIndex + 1);
  
  if(availableStops.length === 0){
    toSelect.innerHTML = '<option value="">此站為終點站 | This is the final stop</option>';
    document.getElementById('toStopSection').style.display = 'block';
    document.getElementById('submitBtn').style.display = 'none';
    return;
  }
  
  toSelect.innerHTML = '<option value="">請選擇下車站 | Please select alighting stop</option>' +
    availableStops.map(stop => `
      <option value="${stop.zh}" class="stop-option">
        ${stop.zh} | ${stop.en}
      </option>
    `).join('');
  
  document.getElementById('toStopSection').style.display = 'block';
  document.getElementById('submitBtn').style.display = 'none';
  
  toSelect.onchange = function(){
    if(this.value){
      document.getElementById('submitBtn').style.display = 'block';
    } else {
      document.getElementById('submitBtn').style.display = 'none';
    }
  };
}

/* === 送出預約 === */
async function submitReservation(){
  const fromStop = document.getElementById('fromStop').value;
  const toStop = document.getElementById('toStop').value;
  
  if(!selectedDate || !selectedRoute || !fromStop || !toStop){
    alert('請完成所有選擇\nPlease complete all selections');
    return;
  }
  
  const fromStopEn = STOPS[selectedRoute].find(stop => stop.zh === fromStop)?.en || fromStop;
  const toStopEn = STOPS[selectedRoute].find(stop => stop.zh === toStop)?.en || toStop;
  
  if(!confirm(`確定預約嗎？\n\n日期：${selectedDate}\n班次：${ROUTES[selectedRoute].name}\n上車：${fromStop}\n下車：${toStop}\n\nConfirm reservation?\n\nDate: ${selectedDate}\nRoute: ${ROUTES[selectedRoute].name}\nBoard: ${fromStopEn}\nAlight: ${toStopEn}`)){
    return;
  }
  
  const payload = {
    type: 'reserve',
    userId: userData.userId,
    name: userData.name,
    phone: userData.phone,
    date: selectedDate,
    route: selectedRoute,
    fromStop: fromStop,
    toStop: toStop
  };
  
  try {
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const result = await res.json();
    
    if(result.status === 'success'){
      alert('✅ 預約成功！\n✅ Reservation successful!');
      
      const reservations = await fetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`).then(r=>r.json());
      existingReservations = reservations.reservations || [];
      renderReservationInfo();
      
      document.getElementById('routeSection').style.display = 'none';
      document.getElementById('fromStopSection').style.display = 'none';
      document.getElementById('toStopSection').style.display = 'none';
      document.getElementById('submitBtn').style.display = 'none';
      document.getElementById('selectedDate').style.display = 'none';
      selectedDate = null;
      selectedRoute = null;
    } else {
      alert('❌ 預約失敗：' + (result.message || '未知錯誤\nReservation failed'));
    }
  } catch(error){
    console.error('❌ 預約錯誤:', error);
    alert('❌ 網路錯誤，請稍後再試\nNetwork error, please try again');
  }
}

/* === 顯示規則 === */
function showRules(){
  alert(`📘 預約規則 | Reservation Rules\n\n1. 每人每日限預約一個班次\n   Only one reservation per person per day\n\n2. 請於搭乘日前一天預約\n   Please reserve one day before the ride\n\n3. 如需取消請提前通知\n   Please notify in advance for cancellation\n\n4. 上車時請主動出示預約紀錄\n   Please show your reservation when boarding`);
}

window.addEventListener('load', init);
</script>
</body>
</html>
