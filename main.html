<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç©¿å±±ç”²å°ˆè»Šé ç´„ï¼ˆå„ªåŒ–ç‰ˆï¼‰</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
    header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; }

    /* ç™»å…¥æç¤º */
    #loading {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background:#f5f5f5; display:flex; align-items:center; justify-content:center;
      font-size:18px; color:#3c8050; font-weight:bold; z-index:9999;
    }

    /* ä¸»è¦æ¨£å¼ï¼ˆèˆ‡åŸç‰ˆä¸€è‡´ï¼‰ */
    #calendarBtn { width:100%; background:#3c8050; color:#fff; border:none; padding:12px; border-radius:6px; font-size:16px; font-weight:bold; margin:10px 0; cursor:pointer; }
    .calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:3px; text-align:center; font-size:13px; margin-bottom:20px; }
    .calendar-header { padding:8px 0; font-weight:bold; background:#f0f0f0; border-radius:3px; font-size:12px; }
    .calendar-day { padding:8px 0; min-height:45px; border-radius:4px; background:#fff; border:1px solid #e0e0e0; cursor:pointer; display:flex; flex-direction:column; justify-content:center; transition:background 0.2s; }
    .calendar-day:hover { background:#eaf5ea; }
    .calendar-day.disabled { background:#ffe6e6; color:#999; cursor:not-allowed; }
    .calendar-day.past { background:#f5f5f5; color:#ccc; cursor:not-allowed; }
    .calendar-day.selected { background:#3c8050; color:#fff; font-weight:bold; }
    .calendar-day.other-month { color:#ccc; }
    .carousel-container{padding:16px;margin:20px 0;}
    .carousel-title{font-size:18px;font-weight:bold;margin-bottom:15px;color:#333;text-align:center;}
    .carousel{display:flex;overflow-x:auto;gap:15px;padding:10px 0;scrollbar-width:none;-ms-overflow-style:none;}
    .carousel::-webkit-scrollbar{display:none;}
    .reservation-bubble{min-width:240px;background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);border:1px solid #e0e0e0;overflow:hidden;flex-shrink:0;}
    .bubble-header{background:#27ACB2;color:white;padding:12px 15px;font-weight:bold;font-size:14px;}
    .bubble-body{padding:12px;}
    .bubble-line{margin-bottom:6px;font-size:12px;line-height:1.3;}
    .bubble-footer{text-align:center;padding:8px;border-top:1px solid #f0f0f0;}
    .cancel-btn-small{background:none;border:none;color:#FF0000;font-size:12px;cursor:pointer;padding:5px 10px;}
    .cancel-btn-small:hover{background:#ffe6e6;border-radius:4px;}
    .no-reservation{text-align:center;color:#666;padding:40px 20px;background:white;border-radius:8px;margin:20px 16px;}
    .route-section{padding:0 16px;margin:20px 0;}
    .route-buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0;}
    .route-btn{padding:12px;border:2px solid #3c8050;border-radius:8px;background:white;cursor:pointer;text-align:center;transition:all 0.2s;}
    .route-btn:hover{background:#eaf5ea;}
    .route-btn.selected{background:#3c8050;color:white;}
    select{width:100%;padding:12px;border:1px solid #ccc;border-radius:6px;font-size:14px;margin-top:8px;}
    .submit-btn{background:#3c8050;color:white;border:none;padding:15px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;margin:20px 16px;width:calc(100% - 32px);}
    .submit-btn:hover{background:#2d6140;}
    .notice{padding:10px 16px;margin:10px 0;border-radius:6px;}
    .notice.success{background:#e8f5e9;color:#2e7d32;border:1px solid #81c784;}
    .notice.error{background:#fdecea;color:#b71c1c;border:1px solid #f5c2c7;}
  </style>
</head>
<body>
  <header>ç©¿å±±ç”²å°ˆè»Šé ç´„</header>
  <div id="loading">â³ ç™»å…¥ä¸­...</div>

  <!-- ä½¿ç”¨è€…è³‡è¨Š -->
  <div id="userInfo" style="padding:16px;">
    <div class="loading-state">â³ ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
  </div>

  <button id="calendarBtn" onclick="toggleCalendar()">ğŸ“… æ‰“é–‹æœˆæ›†</button>

  <div id="calendarContainer" style="display:none;margin-top:10px; padding:0 16px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <button onclick="changeMonth(-1)" style="width:auto; padding:5px 10px;">â—€ ä¸Šå€‹æœˆ</button>
      <h3 id="calendarTitle" style="margin:0; font-size:16px;"></h3>
      <button onclick="changeMonth(1)" style="width:auto; padding:5px 10px;">ä¸‹å€‹æœˆ â–¶</button>
    </div>
    <div id="calendar" class="calendar"></div>
  </div>

  <div id="selectedDate" class="notice success" style="display:none;"></div>
  <div id="holidayNotice" class="notice error" style="display:none;"></div>

  <div id="routeSection" class="route-section" style="display:none;">
    <h3>è«‹é¸æ“‡æ­ä¹˜ç­æ¬¡</h3>
    <div id="routeButtons" class="route-buttons"></div>
  </div>

  <div id="stopSection" class="stop-selector" style="display:none;">
    <h3>è«‹é¸æ“‡ä¸‹è»Šç«™</h3>
    <select id="toStop">
      <option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option>
    </select>
  </div>

  <button id="submitBtn" class="submit-btn" onclick="submitReservation()" style="display:none;">é€å‡ºé ç´„</button>
  <div id="currentReservationCard" style="display:none;"></div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';

let selectedDate=null, selectedRoute=null;
let currentMonth=new Date().getMonth(), currentYear=new Date().getFullYear();
let userData=null, existingReservations=[], noServiceDates={};

const stopsOutbound=["è¡Œæ”¿å¤§æ¨“","ä¸­é¤å»³","ç§‘æŠ€å­¸é™¢","å­¸äººæœƒé¤¨","ä¸­åŸ","ä¸‹åŸ","åªé ‚","æ„›è˜­æ©‹","å¤§æˆåœ‹å°","ä¸­å±±å®‰ä¸ƒè¡—å£","æ¦®æ°‘è¨ºæ‰€","åŸ”é‡Œé…’å» ","åŸ”é‡Œç¸½ç«™"];
const stopsReturn=[...stopsOutbound].reverse();
const routeTimes={ 'A1':{time:'22:00-22:30',direction:'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™'},'B1':{time:'22:30-23:00',direction:'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§'},'A2':{time:'23:00-23:30',direction:'æš¨å¤§â†’åŸ”é‡Œç¸½ç«™'},'B2':{time:'23:30-24:00',direction:'åŸ”é‡Œç¸½ç«™â†’æš¨å¤§'} };

/* ğŸŸ¢ å„ªåŒ–å€ 1ï¼šç™»å…¥åŠ é€Ÿ + å¿«å–æ©Ÿåˆ¶ */
async function init(){
  showLoading("ç™»å…¥ä¸­...");
  await liff.init({ liffId: "2006590746-KJodGOda" });
  if(!liff.isLoggedIn()) return liff.login();

  const cached=sessionStorage.getItem("pangolin_user");
  if(cached){
    userData=JSON.parse(cached);
    renderUserInfo(); hideLoading(); postInitTasks(); return;
  }

  const [profile]=await Promise.all([liff.getProfile()]);
  const res=await fetch(`${WORKER_URL}?check=${profile.userId}`);
  const result=await res.json();
  if(!result.registered) return location.href='register.html';
  userData=result.user;
  sessionStorage.setItem("pangolin_user",JSON.stringify(userData));
  renderUserInfo(); hideLoading(); postInitTasks();
}

/* ğŸŸ¢ å„ªåŒ–å€ 2ï¼šèƒŒæ™¯ä¸¦è¡Œè¼‰å…¥ */
async function postInitTasks(){
  await Promise.all([loadExistingReservations(), preloadNoServiceDates()]);
}

/* é¡¯ç¤ºä½¿ç”¨è€… */
function renderUserInfo(){
  document.getElementById('userInfo').innerHTML=`
    <div style="font-size:18px;font-weight:bold;margin-bottom:10px;">${userData.name}</div>
    <div style="color:#666;">${userData.department}ï½œ${userData.studentId}</div>
  `;
}

/* ğŸŸ¢ å„ªåŒ–å€ 3ï¼šé è¼‰åœé§›è³‡æ–™ + localStorage å¿«å– */
async function preloadNoServiceDates(){
  const cache=localStorage.getItem("pangolin_holidays");
  if(cache){ noServiceDates=JSON.parse(cache); console.log("ğŸ“¦ å·²ä½¿ç”¨å¿«å–åœé§›è³‡æ–™"); return; }
  const start=formatDateToLocal(new Date());
  const end=formatDateToLocal(new Date(currentYear,currentMonth+2,0));
  const res=await fetch(`${WORKER_URL}?mode=calendar&start=${start}&end=${end}&calendarId=${encodeURIComponent(CALENDAR_ID)}`);
  const result=await res.json(); noServiceDates={};
  if(Array.isArray(result.holidays)){ result.holidays.forEach(d=>noServiceDates[d.substring(0,10)]=true); }
  localStorage.setItem("pangolin_holidays",JSON.stringify(noServiceDates));
}

/* ğŸŸ¢ å„ªåŒ–å€ 4ï¼šé ç´„èƒŒæ™¯è¼‰å…¥ */
async function loadExistingReservations(){
  const section=document.getElementById('currentReservationCard');
  section.innerHTML=`<div class="no-reservation">ğŸ“¡ è¼‰å…¥ä¸­...</div>`;
  section.style.display='block';
  try{
    const res=await fetch(`${WORKER_URL}?mode=reservations&userId=${userData.userId}`);
    const result=await res.json(); existingReservations=result.reservations||[];
    renderCurrentReservationCard();
  }catch(e){
    console.warn("è¼‰å…¥é ç´„å¤±æ•—",e);
    section.innerHTML=`<div class="no-reservation">âš ï¸ ç„¡æ³•è¼‰å…¥é ç´„è³‡æ–™</div>`;
  }
}

/* ğŸŸ¢ å„ªåŒ–å€ 5ï¼šè¼‰å…¥æç¤º */
function showLoading(msg="è¼‰å…¥ä¸­..."){ const el=document.getElementById("loading"); if(el){el.textContent=msg;el.style.display="flex";}}
function hideLoading(){ const el=document.getElementById("loading"); if(el) el.style.display="none";}

/* å…¶ä»–é‚è¼¯ï¼šrenderCalendarã€selectDateã€showRouteSelectionã€submitReservationã€cancelReservationç­‰ä¿ç•™åŸåŠŸèƒ½ */
function formatDateToLocal(date){ return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`; }
window.addEventListener('load',init);
</script>
</body>
</html>
