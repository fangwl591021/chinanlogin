<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç©¿å±±ç”²å°ˆè»Šé ç´„</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f5f6f7; margin:0; padding:0; }
    header { background:#3c8050; color:#fff; text-align:center; padding:15px; font-size:22px; font-weight:bold; }
    .card { background:#fff; margin:16px; border-radius:8px; padding:16px; box-shadow:0 0 5px rgba(0,0,0,0.1); }

    /* æŒ‰éˆ• */
    input, select { width:100%; padding:10px; margin-top:8px; border-radius:6px; border:1px solid #ccc; font-size:16px; }
    button { width:100%; background:#3c8050; color:#fff; border:none; padding:12px; border-radius:6px; font-size:18px; font-weight:bold; margin-top:12px; cursor:pointer; position: relative; }
    button:disabled { background:#aaa; cursor:not-allowed; }
    button.loading { background:#2d6140; color: transparent; }
    button.loading::after {
      content: ''; position: absolute; width: 20px; height: 20px; top: 50%; left: 50%;
      margin: -10px 0 0 -10px; border: 2px solid #ffffff; border-radius: 50%;
      border-top-color: transparent; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* æç¤º */
    .notice { padding:10px; margin-top:10px; border-radius:6px; }
    .notice.error { background:#fdecea; color:#b71c1c; border:1px solid #f5c2c7; }
    .notice.success { background:#e8f5e9; color:#2e7d32; border:1px solid #81c784; }

    /* æœˆæ›† */
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap:6px; text-align:center; }
    .calendar div { padding:8px 0; border-radius:6px; background:#fff; border:1px solid #ccc; cursor:pointer; }
    .calendar div:hover { background:#e8f5e9; }
    .calendar .holiday { background:#fdecea; color:#b71c1c; cursor:not-allowed; }
    .calendar .selected { background:#3c8050; color:#fff; font-weight:bold; }

    /* ç­æ¬¡æŒ‰éˆ• */
    #routeButtons { display:flex; flex-wrap:wrap; gap:8px; justify-content:space-between; }
    .route-btn {
      flex:0 0 calc(50% - 8px); padding:10px; border-radius:8px; text-align:center;
      border:1px solid; font-size:15px; cursor:pointer; transition:0.2s;
    }
    .route-btn.A1, .route-btn.B1 { background:#e8f5e9; color:#2e7d32; border-color:#4caf50; }
    .route-btn.A2, .route-btn.B2 { background:#e8f0fe; color:#1a73e8; border-color:#4285f4; }
    .route-btn.full { background:#eee; color:#999; border-color:#ccc; cursor:not-allowed; }
    .route-btn.selected.A1, .route-btn.selected.B1 { background:#2e7d32; color:#fff; }
    .route-btn.selected.A2, .route-btn.selected.B2 { background:#1a73e8; color:#fff; }

    @media (max-width:480px){
      .route-btn{flex:0 0 calc(50% - 6px);min-height:65px;padding:8px 4px;}
    }
  </style>
</head>
<body>
  <header>ğŸšŒ ç©¿å±±ç”²å°ˆè»Šé ç´„</header>

  <div class="card">
    <div id="userInfo" style="margin-bottom:15px;line-height:1.5;color:#2e7d32;font-weight:bold;">
      ğŸ‘¤ ä½¿ç”¨è€…è³‡è¨Šè¼‰å…¥ä¸­...
    </div>

    <label><center>é¸æ“‡æ­ä¹˜æ—¥æœŸ</center></label>
    <button onclick="toggleCalendar()">ğŸ“… æ‰“é–‹æœˆæ›†</button>
    <div id="calendarContainer" style="display:none;margin-top:10px;">
      <div id="calendar" class="calendar"></div>
    </div>
    <div id="selectedDate" class="notice success" style="display:none;"></div>
    <div id="holidayNotice" class="notice error" style="display:none;"></div>

    <label>è«‹é¸æ“‡æ­ä¹˜ç­æ¬¡ *</label>
    <div id="routeButtons"></div>

    <label>ä¸‹è»Šç«™ *</label>
    <select id="toStop"><option value="">è«‹å…ˆé¸æ“‡ç­æ¬¡</option></select>

    <button id="submitBtn" onclick="submitForm()">é€å‡ºé ç´„</button>
    <div id="result"></div>
  </div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const WORKER_URL = 'https://delicate-math-7e61.fangwl591021.workers.dev/';
const CALENDAR_ID = '86eee89e759f27d2a2c7a44853868f7be880aa8e745ba3839933ec84b562631e@group.calendar.google.com';
let selectedDate = null;
let selectedRoute = null;
let userData = null;

const stopsOutbound = ["è¡Œæ”¿å¤§æ¨“","ä¸­é¤å»³","ç§‘æŠ€å­¸é™¢","å­¸äººæœƒé¤¨","ä¸­åŸ","ä¸‹åŸ","åªé ‚","æ„›è˜­æ©‹","å¤§æˆåœ‹å°","ä¸­å±±å®‰ä¸ƒè¡—å£","æ¦®æ°‘è¨ºæ‰€","åŸ”é‡Œé…’å» ","åŸ”é‡Œç¸½ç«™"];
const stopsReturn = ["åŸ”é‡Œç¸½ç«™","åŸ”é‡Œé…’å» ","æ¦®æ°‘è¨ºæ‰€","ä¸­å±±å®‰ä¸ƒè¡—å£","å¤§æˆåœ‹å°","æ„›è˜­æ©‹","åªé ‚","ä¸‹åŸ","ä¸­åŸ","å­¸äººæœƒé¤¨","ç§‘æŠ€å­¸é™¢","ä¸­é¤å»³","è¡Œæ”¿å¤§æ¨“"];

// === åˆå§‹åŒ– ===
(async function init(){
  await liff.init({ liffId: "2006590746-KJodGOda" });
  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  const profile = await liff.getProfile();
  const res = await fetch(`${WORKER_URL}?check=${profile.userId}`);
  const result = await res.json();
  if (!result.registered) {
    window.location.href = 'register.html';
    return;
  }
  userData = result.user;
  document.getElementById('userInfo').innerText = `ğŸ‘¤ ${userData.name}\nğŸ« ${userData.department}ï½œ${userData.studentId}`;
})();

// === æœˆæ›† ===
async function toggleCalendar() {
  const c = document.getElementById('calendarContainer');
  if (c.style.display === 'none') {
    // ç›´æ¥é¡¯ç¤ºæœˆæ›†ï¼Œä¸æª¢æŸ¥ä»Šå¤©æ˜¯å¦åœé§›
    renderCalendar();
    c.style.display = 'block';
    document.getElementById('holidayNotice').style.display = 'none';
  } else {
    c.style.display = 'none';
  }
}

// ä¿®æ”¹ selectDate å‡½æ•¸ï¼Œåœ¨é¸æ“‡æ—¥æœŸæ™‚æª¢æŸ¥æ˜¯å¦ç‚ºåœé§›æ—¥
async function selectDate(date){
  // æª¢æŸ¥é¸æ“‡çš„æ—¥æœŸæ˜¯å¦ç‚ºåœé§›æ—¥
  const res = await fetch(`${WORKER_URL}?mode=calendar&date=${date}`);
  const result = await res.json();
  
  if (result.holiday) {
    document.getElementById('holidayNotice').style.display = 'block';
    document.getElementById('holidayNotice').innerText = `ğŸš« ${date} ç‚ºåœé§›ï¼å…¬ä¼‘æ—¥ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ`;
    document.getElementById('selectedDate').style.display = 'none';
    selectedDate = null;
    return;
  }
  
  selectedDate = date;
  document.getElementById('calendarContainer').style.display = 'none';
  document.getElementById('selectedDate').innerHTML = 'âœ… å·²é¸æ“‡æ—¥æœŸï¼š' + date;
  document.getElementById('selectedDate').style.display = 'block';
  document.getElementById('holidayNotice').style.display = 'none';
  loadSeatStatus(date);
}

function renderCalendar() {
  const cal = document.getElementById('calendar');
  cal.innerHTML = "";
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const firstDay = new Date(year, month, 1);
  const totalDays = new Date(year, month+1, 0).getDate();
  const startWeekday = firstDay.getDay();

  for (let i=0;i<startWeekday;i++){ cal.appendChild(document.createElement('div')); }
  for (let d=1;d<=totalDays;d++){
    const date = new Date(year, month, d);
    const formatted = date.toISOString().split('T')[0];
    const cell = document.createElement('div');
    cell.textContent = d;
    cell.onclick = ()=>selectDate(formatted);
    cal.appendChild(cell);
  }
}

function selectDate(date){
  selectedDate = date;
  document.getElementById('calendarContainer').style.display='none';
  document.getElementById('selectedDate').innerHTML = 'âœ… å·²é¸æ“‡æ—¥æœŸï¼š' + date;
  document.getElementById('selectedDate').style.display='block';
  loadSeatStatus(date);
}

// === è¼‰å…¥ç­æ¬¡ç‹€æ³ ===
function loadSeatStatus(date){
  const container=document.getElementById('routeButtons');
  container.innerHTML='';
  const routeData={
    A1:{name:'A1 æš¨å¤§ â†’ åŸ”é‡Œç¸½ç«™',remain:5,full:false},
    B1:{name:'B1 åŸ”é‡Œç¸½ç«™ â†’ æš¨å¤§',remain:5,full:false},
    A2:{name:'A2 æš¨å¤§ â†’ åŸ”é‡Œç¸½ç«™',remain:5,full:false},
    B2:{name:'B2 åŸ”é‡Œç¸½ç«™ â†’ æš¨å¤§',remain:5,full:false}
  };
  ['A1','B1','A2','B2'].forEach(rid=>{
    const r=routeData[rid];
    const div=document.createElement('div');
    div.className=`route-btn ${rid}`;
    if(r.full) div.classList.add('full');
    div.innerHTML=`<div><b>${r.name}</b><br>${r.full?'å·²æ»¿':r.remain+' ä½'}</div>`;
    if(!r.full) div.onclick=()=>selectRoute(div,rid,r.name);
    container.appendChild(div);
  });
}

function selectRoute(btn,id,name){
  selectedRoute=id;
  document.querySelectorAll('.route-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  updateStops(name);
}

function updateStops(routeName){
  const toStop=document.getElementById('toStop');
  toStop.innerHTML='<option value="">è«‹é¸æ“‡ä¸‹è»Šç«™</option>';
  const isOutbound=routeName.includes('æš¨å¤§');
  const stops=isOutbound?stopsOutbound:stopsReturn;
  const fromStop=isOutbound?'è¡Œæ”¿å¤§æ¨“':'åŸ”é‡Œç¸½ç«™';
  stops.filter(s=>s!==fromStop).forEach(s=>{
    const o=document.createElement('option');
    o.value=s; o.textContent=s;
    toStop.appendChild(o);
  });
}

// === é ç´„ ===
async function submitForm(){
  const toStop=document.getElementById('toStop').value;
  const btn=document.getElementById('submitBtn');
  if(!selectedDate||!selectedRoute||!toStop){
    alert('è«‹å®Œæ•´é¸æ“‡æ—¥æœŸã€ç­æ¬¡èˆ‡ä¸‹è»Šç«™');
    return;
  }
  btn.disabled=true; btn.classList.add('loading');

  const data = {
    type: 'reserve',
    userId: userData.userId,
    name: userData.name,
    phone: userData.phone,
    route: selectedRoute,
    routeName: selectedRoute === 'A1' ? 'A1 æš¨å¤§ â†’ åŸ”é‡Œç¸½ç«™'
              : selectedRoute === 'B1' ? 'B1 åŸ”é‡Œç¸½ç«™ â†’ æš¨å¤§'
              : selectedRoute === 'A2' ? 'A2 æš¨å¤§ â†’ åŸ”é‡Œç¸½ç«™'
              : 'B2 åŸ”é‡Œç¸½ç«™ â†’ æš¨å¤§',
    fromStop: selectedRoute.includes('A') ? 'è¡Œæ”¿å¤§æ¨“' : 'åŸ”é‡Œç¸½ç«™',
    toStop: toStop,
    date: selectedDate
  };

  const res = await fetch(WORKER_URL, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(data)
  });
  const result = await res.json();
  btn.disabled=false; btn.classList.remove('loading');

  if(result.status==='success'){
    document.getElementById('result').innerHTML=
      `<div class="notice success">âœ… é ç´„æˆåŠŸ<br>${data.date}ï½œ${data.routeName}<br>${data.fromStop} â†’ ${data.toStop}</div>`;
  }else{
    document.getElementById('result').innerHTML=
      `<div class="notice error">âŒ é ç´„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>`;
  }
}
</script>
</body>
</html>
