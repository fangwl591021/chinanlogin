<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>暨大接駁車 - 會員註冊明細</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .user-card:hover {
            transform: translateY(-5px);
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
    <!-- 導航列 -->
    <nav class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="fas fa-bus text-2xl"></i>
                    <div>
                        <h1 class="text-xl font-bold">暨大接駁車管理系統</h1>
                        <p class="text-sm text-purple-200">會員註冊明細</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span id="currentTime" class="text-sm"></span>
                    <button onclick="goToAdmin()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition">
                        <i class="fas fa-cog mr-2"></i>管理後台
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6">
        <!-- 統計卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">註冊會員</p>
                        <p id="totalUsers" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-users text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">今日註冊</p>
                        <p id="todayRegistrations" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-user-plus text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">最多科系</p>
                        <p id="topDepartment" class="text-3xl font-bold text-gray-800">-</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-graduation-cap text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">資料狀態</p>
                        <p id="dataStatus" class="text-3xl font-bold text-green-600">正常</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 搜尋與篩選 -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">搜尋會員</label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="搜尋姓名、學號、科系或電話..." 
                            class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                        >
                        <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">科系篩選</label>
                    <select 
                        id="departmentFilter" 
                        class="w-full md:w-48 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                    >
                        <option value="">所有科系</option>
                        <option value="資訊工程學系">資訊工程學系</option>
                        <option value="電機工程學系">電機工程學系</option>
                        <option value="土木工程學系">土木工程學系</option>
                        <option value="應用化學系">應用化學系</option>
                        <option value="中國語文學系">中國語文學系</option>
                        <option value="外國語文學系">外國語文學系</option>
                        <option value="經濟學系">經濟學系</option>
                        <option value="財務金融學系">財務金融學系</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button 
                        id="exportBtn"
                        class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-lg"
                    >
                        <i class="fas fa-download mr-2"></i>匯出資料
                    </button>
                </div>
            </div>
        </div>

        <!-- 會員列表 -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">註冊會員明細</h2>
                <div class="flex items-center gap-3">
                    <span id="showingCount" class="text-sm text-gray-600">顯示 0 位會員</span>
                    <div class="flex gap-2">
                        <button id="cardViewBtn" class="p-2 bg-blue-100 text-blue-600 rounded-lg">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button id="listViewBtn" class="p-2 bg-gray-100 text-gray-600 rounded-lg">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 卡片視圖 -->
            <div id="cardView" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 動態載入會員卡片 -->
            </div>

            <!-- 列表視圖 -->
            <div id="listView" class="hidden">
                <div class="border rounded-lg overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b grid grid-cols-12 gap-4 text-sm font-semibold">
                        <div class="col-span-2">姓名</div>
                        <div class="col-span-2">學號</div>
                        <div class="col-span-2">科系</div>
                        <div class="col-span-2">電話</div>
                        <div class="col-span-2">LINE ID</div>
                        <div class="col-span-2">註冊時間</div>
                    </div>
                    <div id="listViewContent" class="divide-y">
                        <!-- 動態載入列表內容 -->
                    </div>
                </div>
            </div>

            <!-- 載入提示 -->
            <div id="loading" class="text-center py-8">
                <div class="flex items-center justify-center gap-3 text-blue-600">
                    <div class="w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                    <span>載入會員資料中...</span>
                </div>
            </div>

            <!-- 無資料提示 -->
            <div id="noData" class="hidden text-center py-8 text-gray-500">
                <i class="fas fa-users text-4xl mb-3"></i>
                <p class="text-lg">尚無註冊會員資料</p>
                <p class="text-sm mt-2">請檢查資料來源或等待會員註冊</p>
            </div>
        </div>
    </div>

    <!-- 會員詳細資料模態框 -->
    <div id="userDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">會員詳細資料</h3>
                    <button onclick="closeUserDetail()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div id="userDetailContent" class="space-y-4">
                    <!-- 動態載入詳細資料 -->
                </div>
                
                <div class="flex justify-end mt-6 pt-4 border-t">
                    <button 
                        onclick="closeUserDetail()" 
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
                    >
                        關閉
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 系統配置
        const CONFIG = {
            GITHUB_TOKEN: "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",
            GIST_ID: "802416482763775c3c17680ffea14e7e"
        };

        let allUsers = [];
        let filteredUsers = [];
        let currentView = 'card'; // 'card' 或 'list'

        // 初始化
        window.addEventListener('load', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            loadUserData();
            setupEventListeners();
        });

        // 設定事件監聽器
        function setupEventListeners() {
            // 搜尋功能
            document.getElementById('searchInput').addEventListener('input', filterUsers);
            
            // 科系篩選
            document.getElementById('departmentFilter').addEventListener('change', filterUsers);
            
            // 視圖切換
            document.getElementById('cardViewBtn').addEventListener('click', () => switchView('card'));
            document.getElementById('listViewBtn').addEventListener('click', () => switchView('list'));
            
            // 匯出資料
            document.getElementById('exportBtn').addEventListener('click', exportUserData);
        }

        // 載入使用者資料
        async function loadUserData() {
            try {
                const data = await getGistData();
                allUsers = data.users || [];
                
                updateStatistics(allUsers);
                filterUsers();
                
                document.getElementById('loading').classList.add('hidden');
                
                if (allUsers.length === 0) {
                    document.getElementById('noData').classList.remove('hidden');
                }
            } catch (error) {
                console.error('載入使用者資料失敗:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                        <p>載入資料失敗</p>
                        <p class="text-sm mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        // 從 GitHub Gist 取得資料
        async function getGistData() {
            const response = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, {
                headers: {
                    'Authorization': `token ${CONFIG.GITHUB_TOKEN}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`GitHub API 錯誤: ${response.status}`);
            }
            
            const gist = await response.json();
            return JSON.parse(gist.files['data.json'].content);
        }

        // 更新統計資料
        function updateStatistics(users) {
            document.getElementById('totalUsers').textContent = users.length;
            
            // 計算今日註冊人數
            const today = new Date().toISOString().split('T')[0];
            const todayRegistrations = users.filter(user => 
                user.registerTime && user.registerTime.startsWith(today)
            ).length;
            document.getElementById('todayRegistrations').textContent = todayRegistrations;
            
            // 計算最多科系
            const departmentCounts = {};
            users.forEach(user => {
                if (user.department) {
                    departmentCounts[user.department] = (departmentCounts[user.department] || 0) + 1;
                }
            });
            
            let topDepartment = '-';
            let maxCount = 0;
            for (const [dept, count] of Object.entries(departmentCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    topDepartment = dept;
                }
            }
            
            document.getElementById('topDepartment').textContent = topDepartment;
        }

        // 篩選使用者
        function filterUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const departmentFilter = document.getElementById('departmentFilter').value;
            
            filteredUsers = allUsers.filter(user => {
                const matchesSearch = !searchTerm || 
                    (user.displayName && user.displayName.toLowerCase().includes(searchTerm)) ||
                    (user.studentId && user.studentId.includes(searchTerm)) ||
                    (user.department && user.department.toLowerCase().includes(searchTerm)) ||
                    (user.phone && user.phone.includes(searchTerm));
                
                const matchesDepartment = !departmentFilter || user.department === departmentFilter;
                
                return matchesSearch && matchesDepartment;
            });
            
            renderUsers();
            updateShowingCount();
        }

        // 更新顯示數量
        function updateShowingCount() {
            const showingCount = document.getElementById('showingCount');
            showingCount.textContent = `顯示 ${filteredUsers.length} 位會員`;
        }

        // 渲染使用者
        function renderUsers() {
            if (filteredUsers.length === 0) {
                document.getElementById('cardView').innerHTML = '';
                document.getElementById('listViewContent').innerHTML = '';
                document.getElementById('noData').classList.remove('hidden');
                return;
            }
            
            document.getElementById('noData').classList.add('hidden');
            
            if (currentView === 'card') {
                renderCardView();
            } else {
                renderListView();
            }
        }

        // 渲染卡片視圖
        function renderCardView() {
            const cardView = document.getElementById('cardView');
            
            cardView.innerHTML = filteredUsers.map(user => `
                <div class="user-card bg-white border border-gray-200 rounded-xl shadow-sm p-5 fade-in hover:shadow-md transition">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">${user.displayName || '未提供'}</h3>
                            <p class="text-sm text-gray-500">${user.studentId || '未提供學號'}</p>
                        </div>
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                            ${user.department || '未選擇科系'}
                        </span>
                    </div>
                    
                    <div class="space-y-2 text-sm text-gray-600">
                        <div class="flex items-center">
                            <i class="fas fa-phone w-5 text-green-500"></i>
                            <span>${user.phone || '未提供電話'}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fab fa-line w-5 text-green-600"></i>
                            <span class="truncate">${user.lineUserId || '未提供'}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-calendar w-5 text-purple-500"></i>
                            <span>${formatDate(user.registerTime)}</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-100 flex justify-end">
                        <button 
                            onclick="showUserDetail('${user.lineUserId}')" 
                            class="px-3 py-1 bg-blue-100 text-blue-600 text-sm rounded-lg hover:bg-blue-200 transition"
                        >
                            詳細資料
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 渲染列表視圖
        function renderListView() {
            const listViewContent = document.getElementById('listViewContent');
            
            listViewContent.innerHTML = filteredUsers.map(user => `
                <div class="px-4 py-3 grid grid-cols-12 gap-4 text-sm items-center hover:bg-gray-50 fade-in">
                    <div class="col-span-2 font-medium">${user.displayName || '未提供'}</div>
                    <div class="col-span-2 text-gray-600">${user.studentId || '未提供'}</div>
                    <div class="col-span-2 text-gray-600">${user.department || '未提供'}</div>
                    <div class="col-span-2 text-gray-600">${user.phone || '未提供'}</div>
                    <div class="col-span-2 text-gray-600 font-mono text-xs truncate">${user.lineUserId || '未提供'}</div>
                    <div class="col-span-2 text-gray-500 text-xs">${formatDate(user.registerTime)}</div>
                </div>
            `).join('');
        }

        // 切換視圖
        function switchView(view) {
            currentView = view;
            
            if (view === 'card') {
                document.getElementById('cardView').classList.remove('hidden');
                document.getElementById('listView').classList.add('hidden');
                document.getElementById('cardViewBtn').classList.replace('bg-gray-100', 'bg-blue-100');
                document.getElementById('cardViewBtn').classList.replace('text-gray-600', 'text-blue-600');
                document.getElementById('listViewBtn').classList.replace('bg-blue-100', 'bg-gray-100');
                document.getElementById('listViewBtn').classList.replace('text-blue-600', 'text-gray-600');
            } else {
                document.getElementById('cardView').classList.add('hidden');
                document.getElementById('listView').classList.remove('hidden');
                document.getElementById('cardViewBtn').classList.replace('bg-blue-100', 'bg-gray-100');
                document.getElementById('cardViewBtn').classList.replace('text-blue-600', 'text-gray-600');
                document.getElementById('listViewBtn').classList.replace('bg-gray-100', 'bg-blue-100');
                document.getElementById('listViewBtn').classList.replace('text-gray-600', 'text-blue-600');
            }
            
            renderUsers();
        }

        // 顯示使用者詳細資料
        function showUserDetail(lineUserId) {
            const user = allUsers.find(u => u.lineUserId === lineUserId);
            if (!user) return;
            
            const modal = document.getElementById('userDetailModal');
            const content = document.getElementById('userDetailContent');
            
            content.innerHTML = `
                <div class="flex items-center gap-4 mb-4 pb-4 border-b">
                    <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white text-xl font-bold">
                        ${user.displayName ? user.displayName.charAt(0) : '?'}
                    </div>
                    <div>
                        <h4 class="font-bold text-lg">${user.displayName || '未提供姓名'}</h4>
                        <p class="text-gray-600">${user.studentId || '未提供學號'}</p>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-500">科系</p>
                            <p class="font-medium">${user.department || '未選擇'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">電話</p>
                            <p class="font-medium">${user.phone || '未提供'}</p>
                        </div>
                    </div>
                    
                    <div>
                        <p class="text-sm text-gray-500">LINE 用戶 ID</p>
                        <p class="font-mono text-sm bg-gray-100 p-2 rounded break-all">${user.lineUserId || '未提供'}</p>
                    </div>
                    
                    <div>
                        <p class="text-sm text-gray-500">註冊時間</p>
                        <p class="font-medium">${formatDate(user.registerTime)}</p>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // 關閉使用者詳細資料
        function closeUserDetail() {
            document.getElementById('userDetailModal').classList.add('hidden');
        }

        // 匯出使用者資料
        function exportUserData() {
            const dataStr = JSON.stringify(allUsers, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `ncnu_shuttle_users_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            alert('會員資料匯出成功！');
        }

        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '未知';
            const date = new Date(dateString);
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 更新當前時間
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.toLocaleString('zh-TW', { 
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false 
                });
        }

        // 前往管理後台
        function goToAdmin() {
            window.location.href = 'admin.html';
        }
    </script>
</body>
</html>
