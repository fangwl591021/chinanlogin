<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>暨大接駁車 - 會員註冊</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    
    * {
      font-family: 'Noto Sans TC', sans-serif;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .input-glow:focus {
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }
    
    .animate-float {
      animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    .bubble {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      animation: rise 15s infinite ease-in;
    }
    
    @keyframes rise {
      0% { bottom: -100px; opacity: 0; }
      50% { opacity: 1; }
      100% { bottom: 100vh; opacity: 0; }
    }
  </style>
</head>

<body class="gradient-bg min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
  
  <!-- 動態背景泡泡 -->
  <div class="bubble" style="left: 10%; width: 80px; height: 80px; animation-delay: 0s;"></div>
  <div class="bubble" style="left: 30%; width: 60px; height: 60px; animation-delay: 2s;"></div>
  <div class="bubble" style="left: 50%; width: 100px; height: 100px; animation-delay: 4s;"></div>
  <div class="bubble" style="left: 70%; width: 70px; height: 70px; animation-delay: 6s;"></div>
  <div class="bubble" style="left: 85%; width: 90px; height: 90px; animation-delay: 3s;"></div>

  <div class="glass-effect rounded-3xl shadow-2xl p-8 max-w-lg w-full relative z-10">
    
    <!-- 頁首 -->
    <div class="text-center mb-8">
      <div class="flex items-center justify-center mb-6 animate-float">
        <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-3xl flex items-center justify-center shadow-lg transform rotate-3">
          <i class="fab fa-line text-white text-3xl"></i>
        </div>
      </div>
      <h1 class="text-3xl font-black text-gray-800 mb-3 tracking-tight">會員註冊</h1>
      <p class="text-gray-600">填寫資料，開始使用接駁車服務 🚌</p>
    </div>

    <!-- LINE 使用者資訊 -->
    <div id="lineUserInfo" class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-2xl p-5 mb-6 hidden transform transition hover:scale-[1.02]">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <img id="lineUserPicture" src="" class="w-14 h-14 rounded-2xl border-2 border-white shadow-md" alt="LINE頭像">
          <div>
            <p class="font-bold text-gray-800 text-lg" id="lineUserName"></p>
            <p class="text-sm text-green-600 flex items-center gap-1">
              <i class="fas fa-circle text-xs"></i>
              <span id="lineUserStatus">LINE 已連結</span>
            </p>
          </div>
        </div>
        <button onclick="logoutLINE()" class="w-10 h-10 rounded-xl bg-red-500 hover:bg-red-600 text-white transition flex items-center justify-center shadow-md">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>

    <!-- 註冊表單 -->
    <form id="registerForm" class="space-y-5 hidden">
      <input type="hidden" id="lineUserId">

      <div class="relative">
        <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
          <span class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
            <i class="fas fa-user text-blue-600"></i>
          </span>
          姓名
        </label>
        <input type="text" id="displayName" required
          class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 input-glow transition outline-none text-gray-800 font-medium">
      </div>

      <div class="relative">
        <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
          <span class="w-8 h-8 rounded-lg bg-green-100 flex items-center justify-center">
            <i class="fas fa-phone text-green-600"></i>
          </span>
          電話號碼
        </label>
        <input type="tel" id="phone" pattern="[0-9]{10}" maxlength="10" placeholder="0912345678" required
          class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-green-500 input-glow transition outline-none text-gray-800 font-medium">
      </div>

      <div class="relative">
        <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
          <span class="w-8 h-8 rounded-lg bg-orange-100 flex items-center justify-center">
            <i class="fas fa-graduation-cap text-orange-600"></i>
          </span>
          學號
        </label>
        <input type="text" id="studentId" pattern="[0-9]{9}" maxlength="9" placeholder="109210123" required
          class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-orange-500 input-glow transition outline-none text-gray-800 font-medium">
      </div>

      <div class="relative">
        <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
          <span class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center">
            <i class="fas fa-school text-purple-600"></i>
          </span>
          所屬科系
        </label>
        <select id="department" required
          class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-purple-500 input-glow transition outline-none text-gray-800 font-medium appearance-none bg-white cursor-pointer">
          <option value="">請選擇科系</option>
          
          <optgroup label="🎨 人文學院">
            <option value="中國語文學系">中國語文學系</option>
            <option value="外國語文學系">外國語文學系</option>
            <option value="歷史學系">歷史學系</option>
            <option value="東南亞學系">東南亞學系</option>
          </optgroup>
          
          <optgroup label="💼 管理學院">
            <option value="國際企業學系">國際企業學系</option>
            <option value="經濟學系">經濟學系</option>
            <option value="財務金融學系">財務金融學系</option>
            <option value="資訊管理學系">資訊管理學系</option>
            <option value="公共行政與政策學系">公共行政與政策學系</option>
            <option value="觀光休閒與餐旅管理學系">觀光休閒與餐旅管理學系</option>
            <option value="管理學院學士班">管理學院學士班</option>
          </optgroup>
          
          <optgroup label="📖 教育學院">
            <option value="教育政策與行政學系">教育政策與行政學系</option>
            <option value="諮商心理與人力資源發展學系">諮商心理與人力資源發展學系</option>
            <option value="國際文教與比較教育學系">國際文教與比較教育學系</option>
          </optgroup>
          
          <optgroup label="🔬 科技學院">
            <option value="資訊工程學系">資訊工程學系</option>
            <option value="電機工程學系">電機工程學系</option>
            <option value="應用化學系">應用化學系</option>
            <option value="應用材料及光電工程學系">應用材料及光電工程學系</option>
            <option value="土木工程學系">土木工程學系</option>
          </optgroup>
          
          <optgroup label="🤝 人文暨社會科學學院">
            <option value="社會政策與社會工作學系">社會政策與社會工作學系</option>
            <option value="原住民文化產業與社會工作學士學位學程原住民專班">原住民專班</option>
          </optgroup>
          
          <optgroup label="📝 其他">
            <option value="通識教育中心">通識教育中心</option>
            <option value="其他單位">其他單位</option>
          </optgroup>
        </select>
        <i class="fas fa-chevron-down absolute right-5 top-14 text-gray-400 pointer-events-none"></i>
      </div>

      <button type="submit"
        class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-black py-5 rounded-2xl transition shadow-lg hover:shadow-xl transform hover:scale-[1.02] text-lg">
        <i class="fas fa-check-circle mr-2"></i>完成註冊
      </button>
    </form>

    <!-- 載入中 -->
    <div id="loading" class="text-center py-12">
      <div class="flex justify-center items-center gap-3 mb-4">
        <div class="w-3 h-3 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0s;"></div>
        <div class="w-3 h-3 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
        <div class="w-3 h-3 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
      </div>
      <p class="text-gray-600 font-medium">正在載入 LINE 登入資料...</p>
    </div>
  </div>

  <script>
  const CONFIG = {
    LIFF_ID: "2008231249-yv8294Jp",
    GITHUB_TOKEN: "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",
    GIST_ID: "802416482763775c3c17680ffea14e7e"
  };

  async function getGistData() {
    const res = await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, {
      headers: { Authorization: `token ${CONFIG.GITHUB_TOKEN}` }
    });
    const gist = await res.json();
    const fileKey = Object.keys(gist.files)[0];
    return { fileKey, data: JSON.parse(gist.files[fileKey].content || '{"users": []}') };
  }

  async function updateGistData(user) {
    const { fileKey, data } = await getGistData();
    if (data.users.find(u => u.lineUserId === user.lineUserId))
      throw new Error("此帳號已註冊");
    data.users.push(user);
    await fetch(`https://api.github.com/gists/${CONFIG.GIST_ID}`, {
      method: "PATCH",
      headers: {
        Authorization: `token ${CONFIG.GITHUB_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        files: { [fileKey]: { content: JSON.stringify(data, null, 2) } }
      })
    });
  }

  async function initLINE() {
    try {
      await liff.init({ liffId: CONFIG.LIFF_ID });

      const cachedUser = JSON.parse(sessionStorage.getItem("lineUserData") || "null");
      if (cachedUser && cachedUser.lineUserId) {
        console.log("✅ 已從 sessionStorage 讀取登入資料");
        showUser(cachedUser);
        return;
      }

      if (!liff.isLoggedIn()) {
        console.log("尚未登入 → 觸發 LIFF 登入");
        liff.login({ redirectUri: window.location.href });
        return;
      }

      const profile = await liff.getProfile();
      const userData = {
        lineUserId: profile.userId,
        displayName: profile.displayName,
        pictureUrl: profile.pictureUrl
      };

      sessionStorage.setItem("lineUserData", JSON.stringify(userData));
      console.log("✅ 登入成功，已寫入 sessionStorage");
      showUser(userData);

    } catch (err) {
      console.error("❌ LIFF 初始化錯誤：", err);
      alert("LINE 登入初始化失敗，請重新開啟頁面");
    }
  }

  function showUser(profile) {
    document.getElementById("lineUserInfo").classList.remove("hidden");
    document.getElementById("registerForm").classList.remove("hidden");
    document.getElementById("loading").classList.add("hidden");

    document.getElementById("lineUserName").textContent = profile.displayName;
    document.getElementById("lineUserPicture").src = profile.pictureUrl;
    document.getElementById("lineUserId").value = profile.lineUserId;
    document.getElementById("displayName").value = profile.displayName;
  }

  function logoutLINE() {
    if (confirm("確定要登出嗎？登出後將返回登入頁面。")) {
      sessionStorage.clear();
      if (liff.isLoggedIn()) {
        liff.logout();
      }
      window.location.href = "index.html";
    }
  }

  document.getElementById("registerForm").addEventListener("submit", async e => {
    e.preventDefault();
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>註冊中...';
    submitBtn.disabled = true;
    
    const user = {
      lineUserId: document.getElementById("lineUserId").value,
      displayName: document.getElementById("displayName").value.trim(),
      phone: document.getElementById("phone").value.trim(),
      studentId: document.getElementById("studentId").value.trim(),
      department: document.getElementById("department").value,
      registerTime: new Date().toISOString(),
      isAdmin: false
    };
    try {
      await updateGistData(user);
      submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>註冊成功！';
      submitBtn.classList.remove('from-green-500', 'to-emerald-600');
      submitBtn.classList.add('from-blue-500', 'to-blue-600');
      setTimeout(() => {
        window.location.href = "main.html";
      }, 1000);
    } catch (err) {
      alert("❌ " + err.message);
      submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>完成註冊';
      submitBtn.disabled = false;
    }
  });

  window.onload = initLINE;
  </script>
</body>
</html>
