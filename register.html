<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>暨大接駁車 - 會員註冊</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        * {
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .input-glow:focus {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .bubble {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: rise 15s infinite ease-in;
        }
        
        @keyframes rise {
            0% { bottom: -100px; opacity: 0; }
            50% { opacity: 1; }
            100% { bottom: 100vh; opacity: 0; }
        }
    </style>
</head>

<body class="gradient-bg min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
    
    <div class="bubble" style="left: 10%; width: 80px; height: 80px; animation-delay: 0s;"></div>
    <div class="bubble" style="left: 30%; width: 60px; height: 60px; animation-delay: 2s;"></div>
    <div class="bubble" style="left: 50%; width: 100px; height: 100px; animation-delay: 4s;"></div>
    <div class="bubble" style="left: 70%; width: 70px; height: 70px; animation-delay: 6s;"></div>
    <div class="bubble" style="left: 85%; width: 90px; height: 90px; animation-delay: 3s;"></div>

    <div class="glass-effect rounded-3xl shadow-2xl p-8 max-w-lg w-full relative z-10">
        
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-6 animate-float">
                <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-3xl flex items-center justify-center shadow-lg transform rotate-3">
                    <i class="fab fa-line text-white text-3xl"></i>
                </div>
            </div>
            <h1 class="text-3xl font-black text-gray-800 mb-3 tracking-tight">會員註冊</h1>
            <p class="text-gray-600">填寫資料，開始使用接駁車服務 🚌</p>
        </div>

        <div id="lineUserInfo" class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-2xl p-5 mb-6 hidden transform transition hover:scale-[1.02]">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img id="lineUserPicture" src="" class="w-14 h-14 rounded-2xl border-2 border-white shadow-md" alt="LINE頭像">
                    <div>
                        <p class="font-bold text-gray-800 text-lg" id="lineUserName"></p>
                        <p class="text-sm text-green-600 flex items-center gap-1">
                            <i class="fas fa-circle text-xs"></i>
                            <span id="lineUserStatus">LINE 已連結</span>
                        </p>
                    </div>
                </div>
                <button onclick="logoutLINE()" class="w-10 h-10 rounded-xl bg-red-500 hover:bg-red-600 text-white transition flex items-center justify-center shadow-md">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <form id="registerForm" class="space-y-5 hidden">
            <input type="hidden" id="lineUserId">

            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                    <span class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                        <i class="fas fa-user text-blue-600"></i>
                    </span>
                    姓名
                </label>
                <input type="text" id="displayName" required
                    class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 input-glow transition outline-none text-gray-800 font-medium">
            </div>

            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                    <span class="w-8 h-8 rounded-lg bg-green-100 flex items-center justify-center">
                        <i class="fas fa-phone text-green-600"></i>
                    </span>
                    電話號碼
                </label>
                <input type="tel" id="phone" pattern="[0-9]{10}" maxlength="10" placeholder="0912345678" required
                    class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-green-500 input-glow transition outline-none text-gray-800 font-medium">
            </div>

            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                    <span class="w-8 h-8 rounded-lg bg-orange-100 flex items-center justify-center">
                        <i class="fas fa-graduation-cap text-orange-600"></i>
                    </span>
                    學號
                </label>
                <input type="text" id="studentId" pattern="[0-9]{9}" maxlength="9" placeholder="109210123" required
                    class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-orange-500 input-glow transition outline-none text-gray-800 font-medium">
            </div>

            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                    <span class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center">
                        <i class="fas fa-school text-purple-600"></i>
                    </span>
                    所屬科系
                </label>
                <select id="department" required
                    class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-purple-500 input-glow transition outline-none text-gray-800 font-medium appearance-none bg-white cursor-pointer">
                    <option value="">請選擇科系</option>
                    
                    <optgroup label="💼 管理學院">
                        <option value="國際企業學系">國際企業學系</option>
                        <option value="經濟學系">經濟學系</option>
                        <option value="財務金融學系">財務金融學系</option>
                        <option value="資訊管理學系">資訊管理學系</option>
                        <option value="觀光休閒與餐旅管理學系">觀光休閒與餐旅管理學系</option>
                        <option value="管理學院學士班">管理學院學士班</option>
                    </optgroup>

                    <optgroup label="🎨 人文學院">
                        <option value="中國語文學系">中國語文學系</option>
                        <option value="外國語文學系">外國語文學系</option>
                        <option value="歷史學系">歷史學系</option>
                        <option value="東南亞學系">東南亞學系</option>
                        <option value="社會政策與社會工作學系">社會政策與社會工作學系</option>
                        <option value="公共行政與政策學系">公共行政與政策學系</option>
                        <option value="原鄉發展跨領域學士學位學程原住民專班">原住民專班</option>
                    </optgroup>

                    <optgroup label="🔬 科技學院">
                        <option value="資訊工程學系">資訊工程學系</option>
                        <option value="電機工程學系">電機工程學系</option>
                        <option value="應用化學系">應用化學系</option>
                        <option value="應用材料及光電工程學系">應用材料及光電工程學系</option>
                        <option value="土木工程學系">土木工程學系</option>
                        <option value="科技學院學士班">科技學院學士班</option>
                    </optgroup>

                    <optgroup label="📖 教育學院">
                        <option value="國際文教與比較教育學系">國際文教與比較教育學系</option>
                        <option value="教育政策與行政學系">教育政策與行政學系</option>
                        <option value="諮商心理與人力資源發展學系">諮商心理與人力資源發展學系</option>
                    </optgroup>

                    <optgroup label="🏥 護理暨健康福祉學院">
                        <option value="護理學系">護理學系</option>
                    </optgroup>

                    <optgroup label="🏞️ 水沙連學院">
                        <option value="水沙連學院學士班">水沙連學院學士班</option>
                    </optgroup>
                        
                    <optgroup label="📝 其他">
                        <option value="智慧暨永續農業專班">智慧暨永續農業專班</option>
                        <option value="通識教育中心">通識教育中心</option>
                        <option value="其他單位/學程">其他單位/學程</option>
                    </optgroup>
                </select>
                <i class="fas fa-chevron-down absolute right-5 top-14 text-gray-400 pointer-events-none"></i>
            </div>

            <button type="submit"
                class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-black py-5 rounded-2xl transition shadow-lg hover:shadow-xl transform hover:scale-[1.02] text-lg">
                <i class="fas fa-check-circle mr-2"></i>完成註冊
            </button>
        </form>

        <div id="loading" class="text-center py-12">
            <div class="flex justify-center items-center gap-3 mb-4">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                <div class="w-3 h-3 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                <div class="w-3 h-3 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
            </div>
            <p class="text-gray-600 font-medium">正在載入 LINE 登入資料...</p>
        </div>
    </div>

    <script>
    // ⚠️ CONFIGURATION - 已移除 GITHUB_TOKEN/GIST_ID，改用安全的 GAS Proxy
    const CONFIG = {
        LIFF_ID: "2008231249-yv8294Jp",
        PROXY_API_URL: "https://script.google.com/macros/s/AKfycbztIkoPisJ0W5CHEWPQI8lfNp20iz2UGRliUYDPDs1u46jsmq5yL28H_REhcRQ3IeEsWw/exec", 
    };

    /**
     * @function updateGistData
     * @description 使用 POST 請求呼叫 Google Apps Script Proxy 服務來新增用戶
     * @param {object} user - 要註冊的用戶資料
     */
    async function updateGistData(user) {
        // 使用 POST 請求呼叫 GAS Proxy
        const res = await fetch(CONFIG.PROXY_API_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            // 將新用戶資料包裝在 GAS 期望的 { newUser: user } 格式中
            body: JSON.stringify({ newUser: user }) 
        });

        if (!res.ok) {
            // 處理網路或伺服器錯誤 (例如：500 Internal Server Error)
            throw new Error(`Proxy API 呼叫失敗，狀態碼: ${res.status}`);
        }

        const result = await res.json();
        
        // 檢查 GAS 回傳的 JSON 結構中的 status 屬性
        if (result.status === 'error') {
            // 處理 GAS 內部錯誤 (例如：Gist 讀寫失敗、帳號已註冊)
            throw new Error(result.message);
        }
        
        // 成功寫入
        return result;
    }

    // -------------------------------------------------------------
    // LIFF 初始化和流程控制 (保持不變)
    // -------------------------------------------------------------

    async function initLINE() {
        try {
            await liff.init({ liffId: CONFIG.LIFF_ID });

            const cachedUser = JSON.parse(sessionStorage.getItem("lineUserData") || "null");
            const cachedRegistration = JSON.parse(sessionStorage.getItem("userData") || "null");
            
            // 1. 檢查登入狀態和註冊狀態
            if (!liff.isLoggedIn() || !cachedRegistration || !cachedRegistration.lineUserId) {
                console.log("登入狀態遺失，導回登入頁面");
                // 登入狀態遺失，導回登入頁面重新獲取 LIFF 狀態
                alert('登入狀態遺失或無註冊記錄，將導回登入頁面');
                window.location.href = "index.html";
                return;
            }

            let userData = cachedUser;
            if (!userData) {
                 // 如果沒有 sessionStorage，嘗試從 LIFF 獲取 (備用)
                const profile = await liff.getProfile();
                userData = {
                    lineUserId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl
                };
                sessionStorage.setItem("lineUserData", JSON.stringify(userData));
            }

            // 2. 檢查是否已被 index.html 判定為已註冊
            if (cachedRegistration.isRegistered) {
                 console.log("用戶已在 index.html 判定為已註冊，導向主頁面");
                 alert('您已完成註冊，將導向主頁面');
                 window.location.href = "main.html";
                 return;
            }
            
            console.log("✅ 成功獲取登入資料，準備註冊");
            showUser(userData);

        } catch (err) {
            console.error("❌ LIFF 初始化錯誤：", err);
            document.getElementById("loading").innerHTML = `<p class="text-red-600 font-bold">錯誤：LINE 登入失敗 (${err.message})</p><p class="text-gray-500 mt-2">請確認是否在 LINE 環境中開啟</p>`;
            document.getElementById("lineUserInfo").classList.add("hidden");
            document.getElementById("registerForm").classList.add("hidden");
        }
    }

    function showUser(profile) {
        document.getElementById("lineUserInfo").classList.remove("hidden");
        document.getElementById("registerForm").classList.remove("hidden");
        document.getElementById("loading").classList.add("hidden");

        document.getElementById("lineUserName").textContent = profile.displayName;
        document.getElementById("lineUserPicture").src = profile.pictureUrl || 'https://via.placeholder.com/150';
        document.getElementById("lineUserId").value = profile.lineUserId;
        document.getElementById("displayName").value = profile.displayName;
    }

    function logoutLINE() {
        if (confirm("確定要登出嗎？登出後將返回登入頁面。")) {
            sessionStorage.clear();
            if (liff.isLoggedIn()) {
                liff.logout();
            }
            window.location.href = "index.html";
        }
    }

    document.getElementById("registerForm").addEventListener("submit", async e => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>註冊中...';
        submitBtn.disabled = true;
        
        const user = {
            lineUserId: document.getElementById("lineUserId").value,
            displayName: document.getElementById("displayName").value.trim(),
            phone: document.getElementById("phone").value.trim(),
            studentId: document.getElementById("studentId").value.trim(),
            department: document.getElementById("department").value,
            registerTime: new Date().toISOString(),
            isAdmin: false
        };
        try {
            // 呼叫更新後的 GAS Proxy 函數
            await updateGistData(user);
            
            // 註冊成功，更新 sessionStorage 的 isRegistered 狀態
            const userData = JSON.parse(sessionStorage.getItem('userData') || '{}');
            userData.isRegistered = true;
            userData.phone = user.phone;
            userData.studentId = user.studentId;
            userData.department = user.department;
            sessionStorage.setItem('userData', JSON.stringify(userData));
            
            submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>註冊成功！';
            submitBtn.classList.remove('from-green-500', 'to-emerald-600', 'hover:from-green-600', 'hover:to-emerald-700');
            submitBtn.classList.add('from-blue-500', 'to-blue-600');
            
            alert('🎉 會員註冊成功！您現在可以開始預約接駁車服務。');

            setTimeout(() => {
                window.location.href = "main.html";
            }, 500);
        } catch (err) {
            console.error("註冊失敗:", err);
            alert("❌ 註冊失敗: " + err.message);
            submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>完成註冊';
            submitBtn.disabled = false;
        }
    });

    window.onload = initLINE;
    </script>
</body>
</html>
