<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LINE Login Debug</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-100 min-h-screen flex items-center justify-center p-4">
  <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
    <h1 class="text-2xl font-bold mb-4 text-gray-700">LINE Login Debug 模式</h1>
    <div id="logBox" class="text-left bg-gray-100 rounded-xl p-4 text-sm overflow-auto h-60 mb-4"></div>
    <button id="loginBtn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-xl">使用 LINE 登入</button>
  </div>

  <script>
  const CONFIG = {
    CLIENT_ID: "2006590746",
    REDIRECT_URI: "https://fangwl591021.github.io/chinanlogin/register.html",
    STATE: "debugTest",
    SCOPE: "profile openid",
    WORKER_URL: "https://delicate-math-7e61.fangwl591021.workers.dev/"
  };

  const log = (msg) => {
    const box = document.getElementById("logBox");
    const time = new Date().toLocaleTimeString();
    box.innerHTML += `<div>[${time}] ${msg}</div>`;
    box.scrollTop = box.scrollHeight;
    console.log(msg);
  };

  document.getElementById("loginBtn").addEventListener("click", () => {
    const url = `https://access.line.me/oauth2/v2.1/authorize?response_type=code&client_id=${CONFIG.CLIENT_ID}&redirect_uri=${encodeURIComponent(CONFIG.REDIRECT_URI)}&state=${CONFIG.STATE}&scope=${CONFIG.SCOPE}`;
    log("🔗 導向 LINE 登入頁...");
    window.location.href = url;
  });

  async function getProfile(code) {
    const api = `${CONFIG.WORKER_URL}?action=getProfile&code=${code}`;
    log(`🚀 呼叫 Worker: ${api}`);
    try {
      const res = await fetch(api);
      const data = await res.json();
      log("✅ Worker 回傳：" + JSON.stringify(data, null, 2));
      if (data.success && data.userId) {
        log(`🎉 登入成功，使用者：${data.displayName}`);
      } else {
        log("⚠️ Worker 回傳錯誤，請檢查 GAS。");
      }
    } catch (err) {
      log("❌ 讀取錯誤：" + err.message);
    }
  }

  window.addEventListener("load", () => {
    const code = new URL(location.href).searchParams.get("code");
    if (code) {
      log("🧩 收到 LINE 授權碼：" + code);
      getProfile(code);
    } else {
      log("ℹ️ 尚未登入 LINE，請點上方按鈕。");
    }
  });
  </script>
</body>
</html>
