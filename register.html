<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>暨大接駁車 - 會員註冊</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-100 min-h-screen flex items-center justify-center p-4">
  <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
    <div class="text-center mb-6">
      <div class="w-20 h-20 bg-green-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-md">
        <i class="fab fa-line text-white text-3xl"></i>
      </div>
      <h1 class="text-2xl font-bold text-gray-800 mb-2">暨大接駁車會員註冊</h1>
      <p class="text-gray-600 text-sm">請使用 LINE 登入以完成註冊</p>
    </div>

    <!-- 登入 -->
    <div id="loginBox" class="space-y-4 text-center">
      <button id="loginBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl w-full">
        使用 LINE 登入
      </button>
    </div>

    <!-- 註冊表單 -->
    <div id="registerBox" class="hidden">
      <div class="flex items-center space-x-4 mb-4">
        <img id="pictureUrl" class="w-16 h-16 rounded-xl border shadow-md" />
        <div>
          <p id="displayName" class="font-bold text-lg text-gray-800"></p>
          <p class="text-green-600 text-sm">LINE 已登入</p>
        </div>
      </div>

      <form id="registerForm" class="space-y-4">
        <input type="hidden" id="lineUserId" />

        <input id="phone" type="tel" placeholder="手機號碼（10 碼）"
          class="w-full border-2 p-3 rounded-xl focus:border-green-500 outline-none" required maxlength="10" />

        <input id="studentId" type="text" placeholder="學號（9 碼）"
          class="w-full border-2 p-3 rounded-xl focus:border-blue-500 outline-none" required maxlength="9" />

        <select id="department" class="w-full border-2 p-3 rounded-xl focus:border-purple-500 outline-none" required>
          <option value="">請選擇科系</option>
          <option>觀光休閒與餐旅管理學系</option>
          <option>資訊工程學系</option>
          <option>電機工程學系</option>
          <option>土木工程學系</option>
          <option>應用化學系</option>
        </select>

        <button id="submitBtn" type="submit"
          class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 rounded-xl">
          送出註冊
        </button>
      </form>
    </div>
  </div>

  <script>
    const CONFIG = {
      CLIENT_ID: "2006590746",
      REDIRECT_URI: "https://fangwl591021.github.io/chinanlogin/register.html",
      STATE: "register",
      SCOPE: "profile openid",
      WORKER_URL: "https://delicate-math-7e61.fangwl591021.workers.dev/"
    };

    const log = console.log;

    // 1️⃣ 觸發 LINE 登入
    document.getElementById("loginBtn").addEventListener("click", () => {
      const url = `https://access.line.me/oauth2/v2.1/authorize?response_type=code&client_id=${CONFIG.CLIENT_ID}&redirect_uri=${encodeURIComponent(CONFIG.REDIRECT_URI)}&state=${CONFIG.STATE}&scope=${CONFIG.SCOPE}`;
      window.location.href = url;
    });

    // 2️⃣ 登入後取得 Profile
    async function fetchProfile(code) {
      const res = await fetch(`${CONFIG.WORKER_URL}?action=getProfile&code=${code}`);
      const data = await res.json();
      log("Profile Response →", data);
      if (data.success && data.userId) {
        document.getElementById("loginBox").classList.add("hidden");
        document.getElementById("registerBox").classList.remove("hidden");
        document.getElementById("pictureUrl").src = data.pictureUrl;
        document.getElementById("displayName").textContent = data.displayName;
        document.getElementById("lineUserId").value = data.userId;
      } else {
        alert("登入失敗，請重試");
      }
    }

    // 3️⃣ 監聽 LINE callback code
    window.addEventListener("load", () => {
      const code = new URL(location.href).searchParams.get("code");
      if (code) fetchProfile(code);
    });

    // 4️⃣ 提交註冊
    document.getElementById("registerForm").addEventListener("submit", async e => {
      e.preventDefault();
      const btn = document.getElementById("submitBtn");
      btn.disabled = true;
      btn.textContent = "註冊中...";

      const body = {
        lineUserId: document.getElementById("lineUserId").value,
        displayName: document.getElementById("displayName").textContent,
        phone: document.getElementById("phone").value,
        studentId: document.getElementById("studentId").value,
        department: document.getElementById("department").value,
        registerTime: new Date().toISOString()
      };

      try {
        const res = await fetch(`${CONFIG.WORKER_URL}?action=register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const result = await res.json();
        log("Register Response →", result);
        if (result.success) {
          alert("🎉 
