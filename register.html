<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æš¨å¤§æ¥é§è»Š - æœƒå“¡è¨»å†Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full">
        
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-3xl flex items-center justify-center shadow-lg">
                    <i class="fab fa-line text-white text-3xl"></i>
                </div>
            </div>
            <h1 class="text-3xl font-black text-gray-800 mb-3">æœƒå“¡è¨»å†Š</h1>
            <p class="text-gray-600">å¡«å¯«è³‡æ–™ï¼Œé–‹å§‹ä½¿ç”¨æ¥é§è»Šæœå‹™ ğŸšŒ</p>
        </div>

        <form id="registerForm" class="space-y-5">
            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">å§“å</label>
                <input type="text" id="displayName" value="ç‹å­é½Š" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 transition outline-none">
            </div>

            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">é›»è©±è™Ÿç¢¼</label>
                <input type="tel" id="phone" pattern="[0-9]{10}" maxlength="10" placeholder="0912345678" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-green-500 transition outline-none">
            </div>

            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">å­¸è™Ÿ</label>
                <input type="text" id="studentId" pattern="[0-9]{9}" maxlength="9" value="114231456" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-orange-500 transition outline-none">
            </div>

            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">æ‰€å±¬ç§‘ç³»</label>
                <select id="department" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-purple-500 transition outline-none">
                    <option value="è§€å…‰ä¼‘é–’èˆ‡é¤æ—…ç®¡ç†å­¸ç³»" selected>è§€å…‰ä¼‘é–’èˆ‡é¤æ—…ç®¡ç†å­¸ç³»</option>
                </select>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-black py-5 rounded-2xl transition shadow-lg text-lg">
                <i class="fas fa-check-circle mr-2"></i>å®Œæˆè¨»å†Š
            </button>
        </form>

        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-xl">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                <span class="text-sm text-blue-700">å·²ä¿®æ­£ GAS CORS å•é¡Œï¼Œè«‹é‡æ–°æ¸¬è©¦</span>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            LIFF_ID: "2006590746-VKy0Gk0l",
            PROXY_API_URL: "https://script.google.com/macros/s/AKfycbysl5sIc2kUBwevfsMARULZM8zI17ZQ3L4IY_NW6h-PYykmI68GeOUNBtd2fB9vzhqnTw/exec"
        };

        // æ¸¬è©¦ GAS é€£ç·š
        async function testGASConnection() {
            console.log('æ¸¬è©¦ GAS é€£ç·š...');
            
            try {
                const response = await fetch(CONFIG.PROXY_API_URL, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('GAS é€£ç·šæ¸¬è©¦æˆåŠŸ:', result);
                    return { success: true, data: result };
                } else {
                    console.log('GAS é€£ç·šæ¸¬è©¦å¤±æ•— - HTTPéŒ¯èª¤:', response.status);
                    return { success: false, error: `HTTP ${response.status}` };
                }
            } catch (error) {
                console.log('GAS é€£ç·šæ¸¬è©¦å¤±æ•— - ç¶²è·¯éŒ¯èª¤:', error.message);
                return { success: false, error: error.message };
            }
        }

        // è¨»å†Šç”¨æˆ¶åˆ° GAS
        async function registerToGAS(user) {
            console.log('è¨»å†Šåˆ° GAS:', user);
            
            try {
                const response = await fetch(CONFIG.PROXY_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ newUser: user })
                });

                console.log('GAS éŸ¿æ‡‰ç‹€æ…‹:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTPéŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
                }

                const result = await response.json();
                console.log('GAS éŸ¿æ‡‰æ•¸æ“š:', result);
                
                if (result.status === 'error') {
                    throw new Error(result.message);
                }
                
                return result;

            } catch (error) {
                console.error('GAS è¨»å†Šå¤±æ•—:', error);
                throw error;
            }
        }

        // æœ¬åœ°å„²å­˜å‚™ç”¨æ–¹æ¡ˆ
        function saveToLocalStorage(user) {
            try {
                const users = JSON.parse(localStorage.getItem('ncnu_users') || '[]');
                
                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const exists = users.find(u => u.studentId === user.studentId);
                if (exists) {
                    throw new Error('è©²å­¸è™Ÿå·²è¨»å†Š');
                }
                
                users.push(user);
                localStorage.setItem('ncnu_users', JSON.stringify(users));
                return { 
                    status: 'success', 
                    message: 'æœ¬åœ°è¨»å†ŠæˆåŠŸï¼ˆGAS é€£ç·šå¤±æ•—ï¼Œè³‡æ–™æš«å­˜æœ¬åœ°ï¼‰',
                    storage: 'local'
                };
            } catch (error) {
                throw error;
            }
        }

        // ä¸»è¦è¨»å†Šå‡½æ•¸ - æœƒè‡ªå‹•é™ç´šåˆ°æœ¬åœ°å„²å­˜
        async function registerUser(user) {
            console.log('é–‹å§‹è¨»å†Šæµç¨‹...');
            
            // å…ˆæ¸¬è©¦ GAS é€£ç·š
            const connectionTest = await testGASConnection();
            
            if (connectionTest.success) {
                // GAS é€£ç·šæ­£å¸¸ï¼Œä½¿ç”¨ GAS
                try {
                    console.log('ä½¿ç”¨ GAS é€²è¡Œè¨»å†Š...');
                    const result = await registerToGAS(user);
                    return result;
                } catch (error) {
                    console.log('GAS è¨»å†Šå¤±æ•—ï¼Œé™ç´šåˆ°æœ¬åœ°å„²å­˜:', error.message);
                    // é™ç´šåˆ°æœ¬åœ°å„²å­˜
                    return saveToLocalStorage(user);
                }
            } else {
                // GAS é€£ç·šå¤±æ•—ï¼Œç›´æ¥ä½¿ç”¨æœ¬åœ°å„²å­˜
                console.log('GAS é€£ç·šå¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜');
                return saveToLocalStorage(user);
            }
        }

        // è¡¨å–®æäº¤è™•ç†
        document.getElementById("registerForm").addEventListener("submit", async e => {
            e.preventDefault();
            
            const submitBtn = document.getElementById("submitBtn");
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>è¨»å†Šä¸­...';
            submitBtn.disabled = true;

            const user = {
                lineUserId: "U" + Date.now(), // è‡¨æ™‚ IDï¼Œå¯¦éš›ä½¿ç”¨æ™‚å¾ LINE ç²å–
                displayName: document.getElementById("displayName").value.trim(),
                phone: document.getElementById("phone").value.trim(),
                studentId: document.getElementById("studentId").value.trim(),
                department: document.getElementById("department").value,
                registerTime: new Date().toISOString(),
                isAdmin: false
            };

            // è¡¨å–®é©—è­‰
            if (!validateForm(user)) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                return;
            }

            try {
                const result = await registerUser(user);
                
                submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>è¨»å†ŠæˆåŠŸï¼';
                submitBtn.classList.remove('from-green-500', 'to-emerald-600');
                submitBtn.classList.add('from-blue-500', 'to-blue-600');
                
                // æ ¹æ“šå„²å­˜æ–¹å¼é¡¯ç¤ºä¸åŒè¨Šæ¯
                let successMessage = 'ğŸ‰ ' + result.message;
                if (result.storage === 'local') {
                    successMessage += '\n\nè«‹æ³¨æ„ï¼šè³‡æ–™æš«å­˜æ–¼æœ¬åœ°ï¼Œç®¡ç†å“¡å¾ŒçºŒæœƒåŒæ­¥åˆ°ä¼ºæœå™¨ã€‚';
                }
                
                alert(successMessage);
                
                // å„²å­˜åˆ° sessionStorage è¡¨ç¤ºå·²è¨»å†Š
                sessionStorage.setItem('userData', JSON.stringify({
                    ...user,
                    isRegistered: true
                }));
                
                setTimeout(() => {
                    window.location.href = "main.html";
                }, 2000);
                
            } catch (err) {
                console.error("è¨»å†Šå¤±æ•—:", err);
                alert("âŒ è¨»å†Šå¤±æ•—: " + err.message);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // è¡¨å–®é©—è­‰
        function validateForm(data) {
            if (!data.phone.match(/^[0-9]{10}$/)) {
                alert('è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆ10ä½æ•¸å­—ï¼‰');
                return false;
            }
            
            if (!data.studentId.match(/^[0-9]{9}$/)) {
                alert('è«‹è¼¸å…¥æ­£ç¢ºçš„å­¸è™Ÿï¼ˆ9ä½æ•¸å­—ï¼‰');
                return false;
            }
            
            return true;
        }

        // é é¢è¼‰å…¥æ™‚æ¸¬è©¦é€£ç·š
        window.addEventListener('load', async () => {
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œæ¸¬è©¦ GAS é€£ç·š...');
            const testResult = await testGASConnection();
            
            if (testResult.success) {
                console.log('GAS é€£ç·šæ­£å¸¸');
            } else {
                console.log('GAS é€£ç·šç•°å¸¸ï¼Œå°‡ä½¿ç”¨æœ¬åœ°å„²å­˜:', testResult.error);
            }
        });
    </script>
</body>
</html>
