<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æš¨å¤§æ¥é§è»Š - æœƒå“¡è¨»å†Š</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-100 min-h-screen flex items-center justify-center p-4">
  <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
    <div class="text-center mb-6">
      <div class="w-20 h-20 bg-green-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-md">
        <i class="fab fa-line text-white text-3xl"></i>
      </div>
      <h1 class="text-2xl font-bold text-gray-800 mb-2">æš¨å¤§æ¥é§è»Šæœƒå“¡è¨»å†Š</h1>
      <p class="text-gray-600 text-sm">è«‹ä½¿ç”¨ LINE ç™»å…¥ä»¥å®Œæˆè¨»å†Š</p>
    </div>

    <!-- ç™»å…¥ -->
    <div id="loginBox" class="space-y-4 text-center">
      <button id="loginBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl w-full">
        ä½¿ç”¨ LINE ç™»å…¥
      </button>
    </div>

    <!-- è¨»å†Šè¡¨å–® -->
    <div id="registerBox" class="hidden">
      <div class="flex items-center space-x-4 mb-4">
        <img id="pictureUrl" class="w-16 h-16 rounded-xl border shadow-md" />
        <div>
          <p id="displayName" class="font-bold text-lg text-gray-800"></p>
          <p class="text-green-600 text-sm">LINE å·²ç™»å…¥</p>
        </div>
      </div>

      <form id="registerForm" class="space-y-4">
        <input type="hidden" id="lineUserId" />

        <input id="phone" type="tel" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆ10 ç¢¼ï¼‰"
          class="w-full border-2 p-3 rounded-xl focus:border-green-500 outline-none" required maxlength="10" />

        <input id="studentId" type="text" placeholder="å­¸è™Ÿï¼ˆ9 ç¢¼ï¼‰"
          class="w-full border-2 p-3 rounded-xl focus:border-blue-500 outline-none" required maxlength="9" />

        <select id="department" class="w-full border-2 p-3 rounded-xl focus:border-purple-500 outline-none" required>
          <option value="">è«‹é¸æ“‡ç§‘ç³»</option>
          <option>è§€å…‰ä¼‘é–’èˆ‡é¤æ—…ç®¡ç†å­¸ç³»</option>
          <option>è³‡è¨Šå·¥ç¨‹å­¸ç³»</option>
          <option>é›»æ©Ÿå·¥ç¨‹å­¸ç³»</option>
          <option>åœŸæœ¨å·¥ç¨‹å­¸ç³»</option>
          <option>æ‡‰ç”¨åŒ–å­¸ç³»</option>
        </select>

        <button id="submitBtn" type="submit"
          class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 rounded-xl">
          é€å‡ºè¨»å†Š
        </button>
      </form>
    </div>
  </div>

  <script>
    const CONFIG = {
      CLIENT_ID: "2006590746",
      REDIRECT_URI: "https://fangwl591021.github.io/chinanlogin/register.html",
      STATE: "register",
      SCOPE: "profile openid",
      WORKER_URL: "https://delicate-math-7e61.fangwl591021.workers.dev/"
    };

    const log = console.log;

    // 1ï¸âƒ£ è§¸ç™¼ LINE ç™»å…¥
    document.getElementById("loginBtn").addEventListener("click", () => {
      const url = `https://access.line.me/oauth2/v2.1/authorize?response_type=code&client_id=${CONFIG.CLIENT_ID}&redirect_uri=${encodeURIComponent(CONFIG.REDIRECT_URI)}&state=${CONFIG.STATE}&scope=${CONFIG.SCOPE}`;
      window.location.href = url;
    });

    // 2ï¸âƒ£ ç™»å…¥å¾Œå–å¾— Profile
    async function fetchProfile(code) {
      const res = await fetch(`${CONFIG.WORKER_URL}?action=getProfile&code=${code}`);
      const data = await res.json();
      log("Profile Response â†’", data);
      if (data.success && data.userId) {
        document.getElementById("loginBox").classList.add("hidden");
        document.getElementById("registerBox").classList.remove("hidden");
        document.getElementById("pictureUrl").src = data.pictureUrl;
        document.getElementById("displayName").textContent = data.displayName;
        document.getElementById("lineUserId").value = data.userId;
      } else {
        alert("ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦");
      }
    }

    // 3ï¸âƒ£ ç›£è½ LINE callback code
    window.addEventListener("load", () => {
      const code = new URL(location.href).searchParams.get("code");
      if (code) fetchProfile(code);
    });

    // 4ï¸âƒ£ æäº¤è¨»å†Š
    document.getElementById("registerForm").addEventListener("submit", async e => {
      e.preventDefault();
      const btn = document.getElementById("submitBtn");
      btn.disabled = true;
      btn.textContent = "è¨»å†Šä¸­...";

      const body = {
        lineUserId: document.getElementById("lineUserId").value,
        displayName: document.getElementById("displayName").textContent,
        phone: document.getElementById("phone").value,
        studentId: document.getElementById("studentId").value,
        department: document.getElementById("department").value,
        registerTime: new Date().toISOString()
      };

      try {
        const res = await fetch(`${CONFIG.WORKER_URL}?action=register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const result = await res.json();
        log("Register Response â†’", result);
        if (result.success) {
          alert("ğŸ‰ 
