<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æš¨å¤§æ¥é§è»Š - æœƒå“¡è¨»å†Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full">
        
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-3xl flex items-center justify-center shadow-lg">
                    <i class="fab fa-line text-white text-3xl"></i>
                </div>
            </div>
            <h1 class="text-3xl font-black text-gray-800 mb-3">æœƒå“¡è¨»å†Š</h1>
            <p class="text-gray-600">å¡«å¯«è³‡æ–™ï¼Œé–‹å§‹ä½¿ç”¨æ¥é§è»Šæœå‹™ ğŸšŒ</p>
        </div>

        <form id="registerForm" class="space-y-5">
            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">å§“å</label>
                <input type="text" id="displayName" value="ç‹å­é½Š" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 transition outline-none">
            </div>

            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">é›»è©±è™Ÿç¢¼</label>
                <input type="tel" id="phone" pattern="[0-9]{10}" maxlength="10" placeholder="0912345678" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-green-500 transition outline-none">
            </div>

            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">å­¸è™Ÿ</label>
                <input type="text" id="studentId" pattern="[0-9]{9}" maxlength="9" value="114231456" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-orange-500 transition outline-none">
            </div>

            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">æ‰€å±¬ç§‘ç³»</label>
                <select id="department" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-purple-500 transition outline-none">
                    <option value="è§€å…‰ä¼‘é–’èˆ‡é¤æ—…ç®¡ç†å­¸ç³»" selected>è§€å…‰ä¼‘é–’èˆ‡é¤æ—…ç®¡ç†å­¸ç³»</option>
                </select>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-black py-5 rounded-2xl transition shadow-lg text-lg">
                <i class="fas fa-check-circle mr-2"></i>å®Œæˆè¨»å†Š
            </button>
        </form>

        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-xl">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-yellow-500 mr-2"></i>
                <span class="text-sm text-yellow-700">ä½¿ç”¨ JSONP æ–¹å¼ç¹é CORS é™åˆ¶</span>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            LIFF_ID: "2006590746-VKy0Gk0l",
            PROXY_API_URL: "https://script.google.com/macros/s/AKfycbyWpWt34AtbWYZ84DBuqP7mSSW3o7wPSee8fgLiEsM6wKK9eUSFZCdXRLI93-bpyQv7-A/exec"
        };

        // JSONP æ–¹å¼ç™¼é€è«‹æ±‚ï¼ˆç¹é CORSï¼‰
        function sendViaJSONP(url, data, callback) {
            // å‰µå»º callback å‡½æ•¸
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                callback(null, data);
            };

            // æ·»åŠ åƒæ•¸åˆ° URL
            const script = document.createElement('script');
            const params = Object.keys(data).map(key => 
                encodeURIComponent(key) + '=' + encodeURIComponent(JSON.stringify(data[key]))
            ).join('&');
            
            script.src = url + '?callback=' + callbackName + '&' + params;
            document.body.appendChild(script);
        }

        // ä½¿ç”¨è¡¨å–®æäº¤æ–¹å¼ï¼ˆé¿é–‹ CORSï¼‰
        function sendViaForm(user, callback) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = CONFIG.PROXY_API_URL;
            form.target = 'hiddenIframe';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'data';
            input.value = JSON.stringify({ newUser: user });
            form.appendChild(input);
            
            document.body.appendChild(form);
            form.submit();
            
            // ç°¡å–®çš„æˆåŠŸè™•ç†ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­éœ€è¦æ›´è¤‡é›œçš„è™•ç†ï¼‰
            setTimeout(() => {
                callback(null, { status: 'success', message: 'è¨»å†ŠæˆåŠŸ' });
            }, 2000);
        }

        // ä½¿ç”¨ Google Forms ä½œç‚ºä¸­ç¹¼ï¼ˆæ›¿ä»£æ–¹æ¡ˆï¼‰
        async function sendViaGoogleForms(user) {
            // å‰µå»ºä¸€å€‹ Google Form ä¾†æ¥æ”¶æ•¸æ“š
            const FORM_URL = "https://docs.google.com/forms/d/e/YOUR_FORM_ID/formResponse";
            
            const formData = new FormData();
            formData.append('entry.123456789', JSON.stringify(user)); // æ›¿æ›ç‚ºå¯¦éš›çš„ entry ID
            
            try {
                const response = await fetch(FORM_URL, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors' // ä½¿ç”¨ no-cors æ¨¡å¼
                });
                
                return { status: 'success', message: 'æ•¸æ“šå·²æäº¤' };
            } catch (error) {
                throw new Error('è¡¨å–®æäº¤å¤±æ•—');
            }
        }

        // æœ¬åœ°å„²å­˜å‚™ç”¨æ–¹æ¡ˆ
        function saveToLocalStorage(user) {
            try {
                const users = JSON.parse(localStorage.getItem('ncnu_users') || '[]');
                
                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const exists = users.find(u => u.studentId === user.studentId);
                if (exists) {
                    throw new Error('è©²å­¸è™Ÿå·²è¨»å†Š');
                }
                
                users.push(user);
                localStorage.setItem('ncnu_users', JSON.stringify(users));
                return { status: 'success', message: 'æœ¬åœ°è¨»å†ŠæˆåŠŸ' };
            } catch (error) {
                throw error;
            }
        }

        // ä¸»è¦è¨»å†Šå‡½æ•¸
        async function registerUser(user) {
            console.log('é–‹å§‹è¨»å†Š:', user);
            
            // æ–¹æ³• 1: å˜—è©¦ç›´æ¥ fetchï¼ˆå¯èƒ½å›  CORS å¤±æ•—ï¼‰
            try {
                console.log('å˜—è©¦æ–¹æ³• 1: ç›´æ¥ fetch');
                const response = await fetch(CONFIG.PROXY_API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ newUser: user })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('æ–¹æ³• 1 æˆåŠŸ:', result);
                    return result;
                }
            } catch (error) {
                console.log('æ–¹æ³• 1 å¤±æ•—:', error.message);
            }
            
            // æ–¹æ³• 2: ä½¿ç”¨ no-cors æ¨¡å¼
            try {
                console.log('å˜—è©¦æ–¹æ³• 2: no-cors æ¨¡å¼');
                await fetch(CONFIG.PROXY_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ newUser: user })
                });
                
                // no-cors æ¨¡å¼ä¸‹ç„¡æ³•è®€å–éŸ¿æ‡‰ï¼Œå‡è¨­æˆåŠŸ
                return { status: 'success', message: 'è«‹æ±‚å·²ç™¼é€ï¼ˆno-cors æ¨¡å¼ï¼‰' };
            } catch (error) {
                console.log('æ–¹æ³• 2 å¤±æ•—:', error.message);
            }
            
            // æ–¹æ³• 3: æœ¬åœ°å„²å­˜å‚™ç”¨
            console.log('ä½¿ç”¨æ–¹æ³• 3: æœ¬åœ°å„²å­˜');
            return saveToLocalStorage(user);
        }

        // è¡¨å–®æäº¤è™•ç†
        document.getElementById("registerForm").addEventListener("submit", async e => {
            e.preventDefault();
            
            const submitBtn = document.getElementById("submitBtn");
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>è¨»å†Šä¸­...';
            submitBtn.disabled = true;

            const user = {
                lineUserId: "U" + Date.now(), // è‡¨æ™‚ ID
                displayName: document.getElementById("displayName").value.trim(),
                phone: document.getElementById("phone").value.trim(),
                studentId: document.getElementById("studentId").value.trim(),
                department: document.getElementById("department").value,
                registerTime: new Date().toISOString(),
                isAdmin: false
            };

            // è¡¨å–®é©—è­‰
            if (!validateForm(user)) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                return;
            }

            try {
                const result = await registerUser(user);
                
                submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>è¨»å†ŠæˆåŠŸï¼';
                submitBtn.classList.remove('from-green-500', 'to-emerald-600');
                submitBtn.classList.add('from-blue-500', 'to-blue-600');
                
                alert('ğŸ‰ ' + result.message);
                
                // å„²å­˜åˆ° sessionStorage è¡¨ç¤ºå·²è¨»å†Š
                sessionStorage.setItem('userData', JSON.stringify({
                    ...user,
                    isRegistered: true
                }));
                
                setTimeout(() => {
                    window.location.href = "main.html";
                }, 1500);
                
            } catch (err) {
                console.error("è¨»å†Šå¤±æ•—:", err);
                alert("âŒ è¨»å†Šå¤±æ•—: " + err.message);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // è¡¨å–®é©—è­‰
        function validateForm(data) {
            if (!data.phone.match(/^[0-9]{10}$/)) {
                alert('è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆ10ä½æ•¸å­—ï¼‰');
                return false;
            }
            
            if (!data.studentId.match(/^[0-9]{9}$/)) {
                alert('è«‹è¼¸å…¥æ­£ç¢ºçš„å­¸è™Ÿï¼ˆ9ä½æ•¸å­—ï¼‰');
                return false;
            }
            
            return true;
        }

        // å‰µå»ºéš±è—çš„ iframe ç”¨æ–¼è¡¨å–®æäº¤
        const iframe = document.createElement('iframe');
        iframe.name = 'hiddenIframe';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
    </script>
</body>
</html>
