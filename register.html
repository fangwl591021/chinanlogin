<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>暨大接駁車 - 會員註冊</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full">
        
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-3xl flex items-center justify-center shadow-lg">
                    <i class="fab fa-line text-white text-3xl"></i>
                </div>
            </div>
            <h1 class="text-3xl font-black text-gray-800 mb-3">會員註冊</h1>
            <p class="text-gray-600">填寫資料，開始使用接駁車服務 🚌</p>
        </div>

        <form id="registerForm" class="space-y-5">
            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">姓名</label>
                <input type="text" id="displayName" value="王子齊" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 transition outline-none">
            </div>

            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">電話號碼</label>
                <input type="tel" id="phone" pattern="[0-9]{10}" maxlength="10" placeholder="0912345678" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-green-500 transition outline-none">
            </div>

            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">學號</label>
                <input type="text" id="studentId" pattern="[0-9]{9}" maxlength="9" value="114231456" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-orange-500 transition outline-none">
            </div>

            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">所屬科系</label>
                <select id="department" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-purple-500 transition outline-none">
                    <option value="觀光休閒與餐旅管理學系" selected>觀光休閒與餐旅管理學系</option>
                </select>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-black py-5 rounded-2xl transition shadow-lg text-lg">
                <i class="fas fa-check-circle mr-2"></i>完成註冊
            </button>
        </form>

        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-xl">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-yellow-500 mr-2"></i>
                <span class="text-sm text-yellow-700">使用 JSONP 方式繞過 CORS 限制</span>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            LIFF_ID: "2006590746-VKy0Gk0l",
            PROXY_API_URL: "https://script.google.com/macros/s/AKfycbyWpWt34AtbWYZ84DBuqP7mSSW3o7wPSee8fgLiEsM6wKK9eUSFZCdXRLI93-bpyQv7-A/exec"
        };

        // JSONP 方式發送請求（繞過 CORS）
        function sendViaJSONP(url, data, callback) {
            // 創建 callback 函數
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                callback(null, data);
            };

            // 添加參數到 URL
            const script = document.createElement('script');
            const params = Object.keys(data).map(key => 
                encodeURIComponent(key) + '=' + encodeURIComponent(JSON.stringify(data[key]))
            ).join('&');
            
            script.src = url + '?callback=' + callbackName + '&' + params;
            document.body.appendChild(script);
        }

        // 使用表單提交方式（避開 CORS）
        function sendViaForm(user, callback) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = CONFIG.PROXY_API_URL;
            form.target = 'hiddenIframe';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'data';
            input.value = JSON.stringify({ newUser: user });
            form.appendChild(input);
            
            document.body.appendChild(form);
            form.submit();
            
            // 簡單的成功處理（實際應用中需要更複雜的處理）
            setTimeout(() => {
                callback(null, { status: 'success', message: '註冊成功' });
            }, 2000);
        }

        // 使用 Google Forms 作為中繼（替代方案）
        async function sendViaGoogleForms(user) {
            // 創建一個 Google Form 來接收數據
            const FORM_URL = "https://docs.google.com/forms/d/e/YOUR_FORM_ID/formResponse";
            
            const formData = new FormData();
            formData.append('entry.123456789', JSON.stringify(user)); // 替換為實際的 entry ID
            
            try {
                const response = await fetch(FORM_URL, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors' // 使用 no-cors 模式
                });
                
                return { status: 'success', message: '數據已提交' };
            } catch (error) {
                throw new Error('表單提交失敗');
            }
        }

        // 本地儲存備用方案
        function saveToLocalStorage(user) {
            try {
                const users = JSON.parse(localStorage.getItem('ncnu_users') || '[]');
                
                // 檢查是否已存在
                const exists = users.find(u => u.studentId === user.studentId);
                if (exists) {
                    throw new Error('該學號已註冊');
                }
                
                users.push(user);
                localStorage.setItem('ncnu_users', JSON.stringify(users));
                return { status: 'success', message: '本地註冊成功' };
            } catch (error) {
                throw error;
            }
        }

        // 主要註冊函數
        async function registerUser(user) {
            console.log('開始註冊:', user);
            
            // 方法 1: 嘗試直接 fetch（可能因 CORS 失敗）
            try {
                console.log('嘗試方法 1: 直接 fetch');
                const response = await fetch(CONFIG.PROXY_API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ newUser: user })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('方法 1 成功:', result);
                    return result;
                }
            } catch (error) {
                console.log('方法 1 失敗:', error.message);
            }
            
            // 方法 2: 使用 no-cors 模式
            try {
                console.log('嘗試方法 2: no-cors 模式');
                await fetch(CONFIG.PROXY_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ newUser: user })
                });
                
                // no-cors 模式下無法讀取響應，假設成功
                return { status: 'success', message: '請求已發送（no-cors 模式）' };
            } catch (error) {
                console.log('方法 2 失敗:', error.message);
            }
            
            // 方法 3: 本地儲存備用
            console.log('使用方法 3: 本地儲存');
            return saveToLocalStorage(user);
        }

        // 表單提交處理
        document.getElementById("registerForm").addEventListener("submit", async e => {
            e.preventDefault();
            
            const submitBtn = document.getElementById("submitBtn");
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>註冊中...';
            submitBtn.disabled = true;

            const user = {
                lineUserId: "U" + Date.now(), // 臨時 ID
                displayName: document.getElementById("displayName").value.trim(),
                phone: document.getElementById("phone").value.trim(),
                studentId: document.getElementById("studentId").value.trim(),
                department: document.getElementById("department").value,
                registerTime: new Date().toISOString(),
                isAdmin: false
            };

            // 表單驗證
            if (!validateForm(user)) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                return;
            }

            try {
                const result = await registerUser(user);
                
                submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>註冊成功！';
                submitBtn.classList.remove('from-green-500', 'to-emerald-600');
                submitBtn.classList.add('from-blue-500', 'to-blue-600');
                
                alert('🎉 ' + result.message);
                
                // 儲存到 sessionStorage 表示已註冊
                sessionStorage.setItem('userData', JSON.stringify({
                    ...user,
                    isRegistered: true
                }));
                
                setTimeout(() => {
                    window.location.href = "main.html";
                }, 1500);
                
            } catch (err) {
                console.error("註冊失敗:", err);
                alert("❌ 註冊失敗: " + err.message);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // 表單驗證
        function validateForm(data) {
            if (!data.phone.match(/^[0-9]{10}$/)) {
                alert('請輸入正確的手機號碼（10位數字）');
                return false;
            }
            
            if (!data.studentId.match(/^[0-9]{9}$/)) {
                alert('請輸入正確的學號（9位數字）');
                return false;
            }
            
            return true;
        }

        // 創建隱藏的 iframe 用於表單提交
        const iframe = document.createElement('iframe');
        iframe.name = 'hiddenIframe';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
    </script>
</body>
</html>
