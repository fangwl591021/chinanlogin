<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>暨大接駁車 - LINE 註冊</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-100 min-h-screen flex items-center justify-center p-4">
  <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
    <h1 class="text-2xl font-bold mb-4">暨大接駁車會員註冊</h1>
    <div id="loginBox" class="space-y-4">
      <p class="text-gray-700">請使用 LINE 登入以開始註冊</p>
      <button id="loginBtn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-xl">使用 LINE 登入</button>
    </div>

    <div id="registerBox" class="hidden">
      <img id="pictureUrl" class="mx-auto w-20 h-20 rounded-full mb-4" />
      <p id="displayName" class="font-bold text-lg mb-2"></p>

      <form id="registerForm" class="space-y-3">
        <input type="hidden" id="lineUserId">
        <input id="phone" type="tel" placeholder="手機號碼 (10 碼)" class="w-full border p-3 rounded-lg" required>
        <input id="studentId" type="text" placeholder="學號 (9 碼)" class="w-full border p-3 rounded-lg" required>
        <select id="department" class="w-full border p-3 rounded-lg" required>
          <option value="">請選擇科系</option>
          <option>觀光休閒與餐旅管理學系</option>
          <option>資訊工程學系</option>
          <option>電機工程學系</option>
          <option>土木工程學系</option>
          <option>應用化學系</option>
        </select>
        <button class="bg-blue-600 text-white w-full py-3 rounded-lg font-bold">送出註冊</button>
      </form>
    </div>
  </div>

<script>
const CONFIG = {
  CLIENT_ID: "2006590746",
  REDIRECT_URI: "https://fangwl591021.github.io/chinanlogin/register.html",
  STATE: "register",
  SCOPE: "profile openid",
  GAS_URL: "https://script.google.com/macros/s/AKfycbxyT4ZPGouBOBrGKsoAPBjHjDUkeIH5ivzYLz7t24JSNVX8Jz4iNiXTqcyEKtf5NjeFEA/exec"
};

document.getElementById("loginBtn").addEventListener("click", () => {
  const loginUrl = `https://access.line.me/oauth2/v2.1/authorize?response_type=code&client_id=${CONFIG.CLIENT_ID}&redirect_uri=${encodeURIComponent(CONFIG.REDIRECT_URI)}&state=${CONFIG.STATE}&scope=${CONFIG.SCOPE}`;
  window.location.href = loginUrl;
});

window.addEventListener("load", async () => {
  const code = new URL(location.href).searchParams.get("code");
  if (!code) return;

  try {
    const res = await fetch(`${CONFIG.GAS_URL}?action=getProfile&code=${code}`);
    const data = await res.json();

    if (data.userId) {
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("registerBox").classList.remove("hidden");
      document.getElementById("pictureUrl").src = data.pictureUrl;
      document.getElementById("displayName").textContent = data.displayName;
      document.getElementById("lineUserId").value = data.userId;
    } else alert("無法取得 LINE 資料");
  } catch (e) {
    alert("登入失敗：" + e.message);
  }
});

document.getElementById("registerForm").addEventListener("submit", async e => {
  e.preventDefault();
  const body = {
    lineUserId: document.getElementById("lineUserId").value,
    displayName: document.getElementById("displayName").textContent,
    phone: document.getElementById("phone").value,
    studentId: document.getElementById("studentId").value,
    department: document.getElementById("department").value,
    registerTime: new Date().toISOString()
  };
  const res = await fetch(CONFIG.GAS_URL, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(body)
  });
  const result = await res.json();
  alert(result.success ? "🎉 註冊成功！" : "❌ 註冊失敗");
});
</script>
</body>
</html>
