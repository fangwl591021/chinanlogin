<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>暨大接駁車 - 會員註冊</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full">
        
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-3xl flex items-center justify-center shadow-lg">
                    <i class="fab fa-line text-white text-3xl"></i>
                </div>
            </div>
            <h1 class="text-3xl font-black text-gray-800 mb-3">會員註冊</h1>
            <p class="text-gray-600">填寫資料，開始使用接駁車服務 🚌</p>
        </div>

        <form id="registerForm" class="space-y-5">
            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">姓名</label>
                <input type="text" id="displayName" value="王子齊" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 transition outline-none">
            </div>

            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">電話號碼</label>
                <input type="tel" id="phone" pattern="[0-9]{10}" maxlength="10" placeholder="0912345678" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-green-500 transition outline-none">
            </div>

            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">學號</label>
                <input type="text" id="studentId" pattern="[0-9]{9}" maxlength="9" value="114231456" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-orange-500 transition outline-none">
            </div>

            <div class="relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">所屬科系</label>
                <select id="department" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:border-purple-500 transition outline-none">
                    <option value="觀光休閒與餐旅管理學系" selected>觀光休閒與餐旅管理學系</option>
                </select>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-black py-5 rounded-2xl transition shadow-lg text-lg">
                <i class="fas fa-check-circle mr-2"></i>完成註冊
            </button>
        </form>

        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-xl">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                <span class="text-sm text-blue-700">已修正 GAS CORS 問題，請重新測試</span>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            LIFF_ID: "2006590746-VKy0Gk0l",
            PROXY_API_URL: "https://script.google.com/macros/s/AKfycbysl5sIc2kUBwevfsMARULZM8zI17ZQ3L4IY_NW6h-PYykmI68GeOUNBtd2fB9vzhqnTw/exec"
        };

        // 測試 GAS 連線
        async function testGASConnection() {
            console.log('測試 GAS 連線...');
            
            try {
                const response = await fetch(CONFIG.PROXY_API_URL, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('GAS 連線測試成功:', result);
                    return { success: true, data: result };
                } else {
                    console.log('GAS 連線測試失敗 - HTTP錯誤:', response.status);
                    return { success: false, error: `HTTP ${response.status}` };
                }
            } catch (error) {
                console.log('GAS 連線測試失敗 - 網路錯誤:', error.message);
                return { success: false, error: error.message };
            }
        }

        // 註冊用戶到 GAS
        async function registerToGAS(user) {
            console.log('註冊到 GAS:', user);
            
            try {
                const response = await fetch(CONFIG.PROXY_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ newUser: user })
                });

                console.log('GAS 響應狀態:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP錯誤! 狀態碼: ${response.status}`);
                }

                const result = await response.json();
                console.log('GAS 響應數據:', result);
                
                if (result.status === 'error') {
                    throw new Error(result.message);
                }
                
                return result;

            } catch (error) {
                console.error('GAS 註冊失敗:', error);
                throw error;
            }
        }

        // 本地儲存備用方案
        function saveToLocalStorage(user) {
            try {
                const users = JSON.parse(localStorage.getItem('ncnu_users') || '[]');
                
                // 檢查是否已存在
                const exists = users.find(u => u.studentId === user.studentId);
                if (exists) {
                    throw new Error('該學號已註冊');
                }
                
                users.push(user);
                localStorage.setItem('ncnu_users', JSON.stringify(users));
                return { 
                    status: 'success', 
                    message: '本地註冊成功（GAS 連線失敗，資料暫存本地）',
                    storage: 'local'
                };
            } catch (error) {
                throw error;
            }
        }

        // 主要註冊函數 - 會自動降級到本地儲存
        async function registerUser(user) {
            console.log('開始註冊流程...');
            
            // 先測試 GAS 連線
            const connectionTest = await testGASConnection();
            
            if (connectionTest.success) {
                // GAS 連線正常，使用 GAS
                try {
                    console.log('使用 GAS 進行註冊...');
                    const result = await registerToGAS(user);
                    return result;
                } catch (error) {
                    console.log('GAS 註冊失敗，降級到本地儲存:', error.message);
                    // 降級到本地儲存
                    return saveToLocalStorage(user);
                }
            } else {
                // GAS 連線失敗，直接使用本地儲存
                console.log('GAS 連線失敗，使用本地儲存');
                return saveToLocalStorage(user);
            }
        }

        // 表單提交處理
        document.getElementById("registerForm").addEventListener("submit", async e => {
            e.preventDefault();
            
            const submitBtn = document.getElementById("submitBtn");
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>註冊中...';
            submitBtn.disabled = true;

            const user = {
                lineUserId: "U" + Date.now(), // 臨時 ID，實際使用時從 LINE 獲取
                displayName: document.getElementById("displayName").value.trim(),
                phone: document.getElementById("phone").value.trim(),
                studentId: document.getElementById("studentId").value.trim(),
                department: document.getElementById("department").value,
                registerTime: new Date().toISOString(),
                isAdmin: false
            };

            // 表單驗證
            if (!validateForm(user)) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                return;
            }

            try {
                const result = await registerUser(user);
                
                submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>註冊成功！';
                submitBtn.classList.remove('from-green-500', 'to-emerald-600');
                submitBtn.classList.add('from-blue-500', 'to-blue-600');
                
                // 根據儲存方式顯示不同訊息
                let successMessage = '🎉 ' + result.message;
                if (result.storage === 'local') {
                    successMessage += '\n\n請注意：資料暫存於本地，管理員後續會同步到伺服器。';
                }
                
                alert(successMessage);
                
                // 儲存到 sessionStorage 表示已註冊
                sessionStorage.setItem('userData', JSON.stringify({
                    ...user,
                    isRegistered: true
                }));
                
                setTimeout(() => {
                    window.location.href = "main.html";
                }, 2000);
                
            } catch (err) {
                console.error("註冊失敗:", err);
                alert("❌ 註冊失敗: " + err.message);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // 表單驗證
        function validateForm(data) {
            if (!data.phone.match(/^[0-9]{10}$/)) {
                alert('請輸入正確的手機號碼（10位數字）');
                return false;
            }
            
            if (!data.studentId.match(/^[0-9]{9}$/)) {
                alert('請輸入正確的學號（9位數字）');
                return false;
            }
            
            return true;
        }

        // 頁面載入時測試連線
        window.addEventListener('load', async () => {
            console.log('頁面載入完成，測試 GAS 連線...');
            const testResult = await testGASConnection();
            
            if (testResult.success) {
                console.log('GAS 連線正常');
            } else {
                console.log('GAS 連線異常，將使用本地儲存:', testResult.error);
            }
        });
    </script>
</body>
</html>
